const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/AboutView-C61PFOsG.js","assets/AboutView-DhlS7raN.css"])))=>i.map(i=>d[i]);
(function(){const _=document.createElement("link").relList;if(_&&_.supports&&_.supports("modulepreload"))return;for(const y of document.querySelectorAll('link[rel="modulepreload"]'))C(y);new MutationObserver(y=>{for(const O of y)if(O.type==="childList")for(const M of O.addedNodes)M.tagName==="LINK"&&M.rel==="modulepreload"&&C(M)}).observe(document,{childList:!0,subtree:!0});function E(y){const O={};return y.integrity&&(O.integrity=y.integrity),y.referrerPolicy&&(O.referrerPolicy=y.referrerPolicy),y.crossOrigin==="use-credentials"?O.credentials="include":y.crossOrigin==="anonymous"?O.credentials="omit":O.credentials="same-origin",O}function C(y){if(y.ep)return;y.ep=!0;const O=E(y);fetch(y.href,O)}})();function HR(u){const _=Object.create(null);for(const E of u.split(","))_[E]=1;return E=>E in _}const wn={},ll=[],So=()=>{},O1=()=>!1,Lf=u=>u.charCodeAt(0)===111&&u.charCodeAt(1)===110&&(u.charCodeAt(2)>122||u.charCodeAt(2)<97),KR=u=>u.startsWith("onUpdate:"),Gi=Object.assign,YR=(u,_)=>{const E=u.indexOf(_);E>-1&&u.splice(E,1)},mX=Object.prototype.hasOwnProperty,hn=(u,_)=>mX.call(u,_),be=Array.isArray,ul=u=>kf(u)==="[object Map]",N1=u=>kf(u)==="[object Set]",Me=u=>typeof u=="function",hi=u=>typeof u=="string",La=u=>typeof u=="symbol",jn=u=>u!==null&&typeof u=="object",D1=u=>(jn(u)||Me(u))&&Me(u.then)&&Me(u.catch),P1=Object.prototype.toString,kf=u=>P1.call(u),EX=u=>kf(u).slice(8,-1),L1=u=>kf(u)==="[object Object]",qR=u=>hi(u)&&u!=="NaN"&&u[0]!=="-"&&""+parseInt(u,10)===u,Qu=HR(",key,ref,ref_for,ref_key,onVnodeBeforeMount,onVnodeMounted,onVnodeBeforeUpdate,onVnodeUpdated,onVnodeBeforeUnmount,onVnodeUnmounted"),Mf=u=>{const _=Object.create(null);return(E=>_[E]||(_[E]=u(E)))},gX=/-\w/g,Pa=Mf(u=>u.replace(gX,_=>_.slice(1).toUpperCase())),SX=/\B([A-Z])/g,xc=Mf(u=>u.replace(SX,"-$1").toLowerCase()),k1=Mf(u=>u.charAt(0).toUpperCase()+u.slice(1)),lR=Mf(u=>u?`on${k1(u)}`:""),Da=(u,_)=>!Object.is(u,_),uR=(u,..._)=>{for(let E=0;E<u.length;E++)u[E](..._)},M1=(u,_,E,C=!1)=>{Object.defineProperty(u,_,{configurable:!0,enumerable:!1,writable:C,value:E})},TX=u=>{const _=parseFloat(u);return isNaN(_)?u:_};let UM;const Uf=()=>UM||(UM=typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof window<"u"?window:typeof global<"u"?global:{});function zR(u){if(be(u)){const _={};for(let E=0;E<u.length;E++){const C=u[E],y=hi(C)?yX(C):zR(C);if(y)for(const O in y)_[O]=y[O]}return _}else if(hi(u)||jn(u))return u}const RX=/;(?![^(]*\))/g,vX=/:([^]+)/,CX=/\/\*[^]*?\*\//g;function yX(u){const _={};return u.replace(CX,"").split(RX).forEach(E=>{if(E){const C=E.split(vX);C.length>1&&(_[C[0].trim()]=C[1].trim())}}),_}function XR(u){let _="";if(hi(u))_=u;else if(be(u))for(let E=0;E<u.length;E++){const C=XR(u[E]);C&&(_+=C+" ")}else if(jn(u))for(const E in u)u[E]&&(_+=E+" ");return _.trim()}const IX="itemscope,allowfullscreen,formnovalidate,ismap,nomodule,novalidate,readonly",bX=HR(IX);function U1(u){return!!u||u===""}const x1=u=>!!(u&&u.__v_isRef===!0),V1=u=>hi(u)?u:u==null?"":be(u)||jn(u)&&(u.toString===P1||!Me(u.toString))?x1(u)?V1(u.value):JSON.stringify(u,F1,2):String(u),F1=(u,_)=>x1(_)?F1(u,_.value):ul(_)?{[`Map(${_.size})`]:[..._.entries()].reduce((E,[C,y],O)=>(E[hR(C,O)+" =>"]=y,E),{})}:N1(_)?{[`Set(${_.size})`]:[..._.values()].map(E=>hR(E))}:La(_)?hR(_):jn(_)&&!be(_)&&!L1(_)?String(_):_,hR=(u,_="")=>{var E;return La(u)?`Symbol(${(E=u.description)!=null?E:_})`:u};let Rr;class B1{constructor(_=!1){this.detached=_,this._active=!0,this._on=0,this.effects=[],this.cleanups=[],this._isPaused=!1,this.parent=Rr,!_&&Rr&&(this.index=(Rr.scopes||(Rr.scopes=[])).push(this)-1)}get active(){return this._active}pause(){if(this._active){this._isPaused=!0;let _,E;if(this.scopes)for(_=0,E=this.scopes.length;_<E;_++)this.scopes[_].pause();for(_=0,E=this.effects.length;_<E;_++)this.effects[_].pause()}}resume(){if(this._active&&this._isPaused){this._isPaused=!1;let _,E;if(this.scopes)for(_=0,E=this.scopes.length;_<E;_++)this.scopes[_].resume();for(_=0,E=this.effects.length;_<E;_++)this.effects[_].resume()}}run(_){if(this._active){const E=Rr;try{return Rr=this,_()}finally{Rr=E}}}on(){++this._on===1&&(this.prevScope=Rr,Rr=this)}off(){this._on>0&&--this._on===0&&(Rr=this.prevScope,this.prevScope=void 0)}stop(_){if(this._active){this._active=!1;let E,C;for(E=0,C=this.effects.length;E<C;E++)this.effects[E].stop();for(this.effects.length=0,E=0,C=this.cleanups.length;E<C;E++)this.cleanups[E]();if(this.cleanups.length=0,this.scopes){for(E=0,C=this.scopes.length;E<C;E++)this.scopes[E].stop(!0);this.scopes.length=0}if(!this.detached&&this.parent&&!_){const y=this.parent.scopes.pop();y&&y!==this&&(this.parent.scopes[this.index]=y,y.index=this.index)}this.parent=void 0}}}function AX(u){return new B1(u)}function wX(){return Rr}let An;const pR=new WeakSet;class j1{constructor(_){this.fn=_,this.deps=void 0,this.depsTail=void 0,this.flags=5,this.next=void 0,this.cleanup=void 0,this.scheduler=void 0,Rr&&Rr.active&&Rr.effects.push(this)}pause(){this.flags|=64}resume(){this.flags&64&&(this.flags&=-65,pR.has(this)&&(pR.delete(this),this.trigger()))}notify(){this.flags&2&&!(this.flags&32)||this.flags&8||W1(this)}run(){if(!(this.flags&1))return this.fn();this.flags|=2,xM(this),H1(this);const _=An,E=Vs;An=this,Vs=!0;try{return this.fn()}finally{K1(this),An=_,Vs=E,this.flags&=-3}}stop(){if(this.flags&1){for(let _=this.deps;_;_=_.nextDep)ZR(_);this.deps=this.depsTail=void 0,xM(this),this.onStop&&this.onStop(),this.flags&=-2}}trigger(){this.flags&64?pR.add(this):this.scheduler?this.scheduler():this.runIfDirty()}runIfDirty(){bR(this)&&this.run()}get dirty(){return bR(this)}}let G1=0,Zu,$u;function W1(u,_=!1){if(u.flags|=8,_){u.next=$u,$u=u;return}u.next=Zu,Zu=u}function JR(){G1++}function QR(){if(--G1>0)return;if($u){let _=$u;for($u=void 0;_;){const E=_.next;_.next=void 0,_.flags&=-9,_=E}}let u;for(;Zu;){let _=Zu;for(Zu=void 0;_;){const E=_.next;if(_.next=void 0,_.flags&=-9,_.flags&1)try{_.trigger()}catch(C){u||(u=C)}_=E}}if(u)throw u}function H1(u){for(let _=u.deps;_;_=_.nextDep)_.version=-1,_.prevActiveLink=_.dep.activeLink,_.dep.activeLink=_}function K1(u){let _,E=u.depsTail,C=E;for(;C;){const y=C.prevDep;C.version===-1?(C===E&&(E=y),ZR(C),OX(C)):_=C,C.dep.activeLink=C.prevActiveLink,C.prevActiveLink=void 0,C=y}u.deps=_,u.depsTail=E}function bR(u){for(let _=u.deps;_;_=_.nextDep)if(_.dep.version!==_.version||_.dep.computed&&(Y1(_.dep.computed)||_.dep.version!==_.version))return!0;return!!u._dirty}function Y1(u){if(u.flags&4&&!(u.flags&16)||(u.flags&=-17,u.globalVersion===oh)||(u.globalVersion=oh,!u.isSSR&&u.flags&128&&(!u.deps&&!u._dirty||!bR(u))))return;u.flags|=2;const _=u.dep,E=An,C=Vs;An=u,Vs=!0;try{H1(u);const y=u.fn(u._value);(_.version===0||Da(y,u._value))&&(u.flags|=128,u._value=y,_.version++)}catch(y){throw _.version++,y}finally{An=E,Vs=C,K1(u),u.flags&=-3}}function ZR(u,_=!1){const{dep:E,prevSub:C,nextSub:y}=u;if(C&&(C.nextSub=y,u.prevSub=void 0),y&&(y.prevSub=C,u.nextSub=void 0),E.subs===u&&(E.subs=C,!C&&E.computed)){E.computed.flags&=-5;for(let O=E.computed.deps;O;O=O.nextDep)ZR(O,!0)}!_&&!--E.sc&&E.map&&E.map.delete(E.key)}function OX(u){const{prevDep:_,nextDep:E}=u;_&&(_.nextDep=E,u.prevDep=void 0),E&&(E.prevDep=_,u.nextDep=void 0)}let Vs=!0;const q1=[];function Ho(){q1.push(Vs),Vs=!1}function Ko(){const u=q1.pop();Vs=u===void 0?!0:u}function xM(u){const{cleanup:_}=u;if(u.cleanup=void 0,_){const E=An;An=void 0;try{_()}finally{An=E}}}let oh=0;class NX{constructor(_,E){this.sub=_,this.dep=E,this.version=E.version,this.nextDep=this.prevDep=this.nextSub=this.prevSub=this.prevActiveLink=void 0}}class $R{constructor(_){this.computed=_,this.version=0,this.activeLink=void 0,this.subs=void 0,this.map=void 0,this.key=void 0,this.sc=0,this.__v_skip=!0}track(_){if(!An||!Vs||An===this.computed)return;let E=this.activeLink;if(E===void 0||E.sub!==An)E=this.activeLink=new NX(An,this),An.deps?(E.prevDep=An.depsTail,An.depsTail.nextDep=E,An.depsTail=E):An.deps=An.depsTail=E,z1(E);else if(E.version===-1&&(E.version=this.version,E.nextDep)){const C=E.nextDep;C.prevDep=E.prevDep,E.prevDep&&(E.prevDep.nextDep=C),E.prevDep=An.depsTail,E.nextDep=void 0,An.depsTail.nextDep=E,An.depsTail=E,An.deps===E&&(An.deps=C)}return E}trigger(_){this.version++,oh++,this.notify(_)}notify(_){JR();try{for(let E=this.subs;E;E=E.prevSub)E.sub.notify()&&E.sub.dep.notify()}finally{QR()}}}function z1(u){if(u.dep.sc++,u.sub.flags&4){const _=u.dep.computed;if(_&&!u.dep.subs){_.flags|=20;for(let C=_.deps;C;C=C.nextDep)z1(C)}const E=u.dep.subs;E!==u&&(u.prevSub=E,E&&(E.nextSub=u)),u.dep.subs=u}}const AR=new WeakMap,Mc=Symbol(""),wR=Symbol(""),ah=Symbol("");function Bi(u,_,E){if(Vs&&An){let C=AR.get(u);C||AR.set(u,C=new Map);let y=C.get(E);y||(C.set(E,y=new $R),y.map=C,y.key=E),y.track()}}function jo(u,_,E,C,y,O){const M=AR.get(u);if(!M){oh++;return}const V=F=>{F&&F.trigger()};if(JR(),_==="clear")M.forEach(V);else{const F=be(u),z=F&&qR(E);if(F&&E==="length"){const Y=Number(C);M.forEach((W,Z)=>{(Z==="length"||Z===ah||!La(Z)&&Z>=Y)&&V(W)})}else switch((E!==void 0||M.has(void 0))&&V(M.get(E)),z&&V(M.get(ah)),_){case"add":F?z&&V(M.get("length")):(V(M.get(Mc)),ul(u)&&V(M.get(wR)));break;case"delete":F||(V(M.get(Mc)),ul(u)&&V(M.get(wR)));break;case"set":ul(u)&&V(M.get(Mc));break}}QR()}function sl(u){const _=un(u);return _===u?_:(Bi(_,"iterate",ah),Fs(u)?_:_.map(er))}function tv(u){return Bi(u=un(u),"iterate",ah),u}const DX={__proto__:null,[Symbol.iterator](){return _R(this,Symbol.iterator,er)},concat(...u){return sl(this).concat(...u.map(_=>be(_)?sl(_):_))},entries(){return _R(this,"entries",u=>(u[1]=er(u[1]),u))},every(u,_){return Vo(this,"every",u,_,void 0,arguments)},filter(u,_){return Vo(this,"filter",u,_,E=>E.map(er),arguments)},find(u,_){return Vo(this,"find",u,_,er,arguments)},findIndex(u,_){return Vo(this,"findIndex",u,_,void 0,arguments)},findLast(u,_){return Vo(this,"findLast",u,_,er,arguments)},findLastIndex(u,_){return Vo(this,"findLastIndex",u,_,void 0,arguments)},forEach(u,_){return Vo(this,"forEach",u,_,void 0,arguments)},includes(...u){return fR(this,"includes",u)},indexOf(...u){return fR(this,"indexOf",u)},join(u){return sl(this).join(u)},lastIndexOf(...u){return fR(this,"lastIndexOf",u)},map(u,_){return Vo(this,"map",u,_,void 0,arguments)},pop(){return Yu(this,"pop")},push(...u){return Yu(this,"push",u)},reduce(u,..._){return VM(this,"reduce",u,_)},reduceRight(u,..._){return VM(this,"reduceRight",u,_)},shift(){return Yu(this,"shift")},some(u,_){return Vo(this,"some",u,_,void 0,arguments)},splice(...u){return Yu(this,"splice",u)},toReversed(){return sl(this).toReversed()},toSorted(u){return sl(this).toSorted(u)},toSpliced(...u){return sl(this).toSpliced(...u)},unshift(...u){return Yu(this,"unshift",u)},values(){return _R(this,"values",er)}};function _R(u,_,E){const C=tv(u),y=C[_]();return C!==u&&!Fs(u)&&(y._next=y.next,y.next=()=>{const O=y._next();return O.done||(O.value=E(O.value)),O}),y}const PX=Array.prototype;function Vo(u,_,E,C,y,O){const M=tv(u),V=M!==u&&!Fs(u),F=M[_];if(F!==PX[_]){const W=F.apply(u,O);return V?er(W):W}let z=E;M!==u&&(V?z=function(W,Z){return E.call(this,er(W),Z,u)}:E.length>2&&(z=function(W,Z){return E.call(this,W,Z,u)}));const Y=F.call(M,z,C);return V&&y?y(Y):Y}function VM(u,_,E,C){const y=tv(u);let O=E;return y!==u&&(Fs(u)?E.length>3&&(O=function(M,V,F){return E.call(this,M,V,F,u)}):O=function(M,V,F){return E.call(this,M,er(V),F,u)}),y[_](O,...C)}function fR(u,_,E){const C=un(u);Bi(C,"iterate",ah);const y=C[_](...E);return(y===-1||y===!1)&&iv(E[0])?(E[0]=un(E[0]),C[_](...E)):y}function Yu(u,_,E=[]){Ho(),JR();const C=un(u)[_].apply(u,E);return QR(),Ko(),C}const LX=HR("__proto__,__v_isRef,__isVue"),X1=new Set(Object.getOwnPropertyNames(Symbol).filter(u=>u!=="arguments"&&u!=="caller").map(u=>Symbol[u]).filter(La));function kX(u){La(u)||(u=String(u));const _=un(this);return Bi(_,"has",u),_.hasOwnProperty(u)}class J1{constructor(_=!1,E=!1){this._isReadonly=_,this._isShallow=E}get(_,E,C){if(E==="__v_skip")return _.__v_skip;const y=this._isReadonly,O=this._isShallow;if(E==="__v_isReactive")return!y;if(E==="__v_isReadonly")return y;if(E==="__v_isShallow")return O;if(E==="__v_raw")return C===(y?O?HX:tU:O?$1:Z1).get(_)||Object.getPrototypeOf(_)===Object.getPrototypeOf(C)?_:void 0;const M=be(_);if(!y){let F;if(M&&(F=DX[E]))return F;if(E==="hasOwnProperty")return kX}const V=Reflect.get(_,E,ji(_)?_:C);if((La(E)?X1.has(E):LX(E))||(y||Bi(_,"get",E),O))return V;if(ji(V)){const F=M&&qR(E)?V:V.value;return y&&jn(F)?NR(F):F}return jn(V)?y?NR(V):xf(V):V}}class Q1 extends J1{constructor(_=!1){super(!1,_)}set(_,E,C,y){let O=_[E];if(!this._isShallow){const F=Uc(O);if(!Fs(C)&&!Uc(C)&&(O=un(O),C=un(C)),!be(_)&&ji(O)&&!ji(C))return F||(O.value=C),!0}const M=be(_)&&qR(E)?Number(E)<_.length:hn(_,E),V=Reflect.set(_,E,C,ji(_)?_:y);return _===un(y)&&(M?Da(C,O)&&jo(_,"set",E,C):jo(_,"add",E,C)),V}deleteProperty(_,E){const C=hn(_,E);_[E];const y=Reflect.deleteProperty(_,E);return y&&C&&jo(_,"delete",E,void 0),y}has(_,E){const C=Reflect.has(_,E);return(!La(E)||!X1.has(E))&&Bi(_,"has",E),C}ownKeys(_){return Bi(_,"iterate",be(_)?"length":Mc),Reflect.ownKeys(_)}}class MX extends J1{constructor(_=!1){super(!0,_)}set(_,E){return!0}deleteProperty(_,E){return!0}}const UX=new Q1,xX=new MX,VX=new Q1(!0);const OR=u=>u,mf=u=>Reflect.getPrototypeOf(u);function FX(u,_,E){return function(...C){const y=this.__v_raw,O=un(y),M=ul(O),V=u==="entries"||u===Symbol.iterator&&M,F=u==="keys"&&M,z=y[u](...C),Y=E?OR:_?DR:er;return!_&&Bi(O,"iterate",F?wR:Mc),{next(){const{value:W,done:Z}=z.next();return Z?{value:W,done:Z}:{value:V?[Y(W[0]),Y(W[1])]:Y(W),done:Z}},[Symbol.iterator](){return this}}}}function Ef(u){return function(..._){return u==="delete"?!1:u==="clear"?void 0:this}}function BX(u,_){const E={get(y){const O=this.__v_raw,M=un(O),V=un(y);u||(Da(y,V)&&Bi(M,"get",y),Bi(M,"get",V));const{has:F}=mf(M),z=_?OR:u?DR:er;if(F.call(M,y))return z(O.get(y));if(F.call(M,V))return z(O.get(V));O!==M&&O.get(y)},get size(){const y=this.__v_raw;return!u&&Bi(un(y),"iterate",Mc),y.size},has(y){const O=this.__v_raw,M=un(O),V=un(y);return u||(Da(y,V)&&Bi(M,"has",y),Bi(M,"has",V)),y===V?O.has(y):O.has(y)||O.has(V)},forEach(y,O){const M=this,V=M.__v_raw,F=un(V),z=_?OR:u?DR:er;return!u&&Bi(F,"iterate",Mc),V.forEach((Y,W)=>y.call(O,z(Y),z(W),M))}};return Gi(E,u?{add:Ef("add"),set:Ef("set"),delete:Ef("delete"),clear:Ef("clear")}:{add(y){!_&&!Fs(y)&&!Uc(y)&&(y=un(y));const O=un(this);return mf(O).has.call(O,y)||(O.add(y),jo(O,"add",y,y)),this},set(y,O){!_&&!Fs(O)&&!Uc(O)&&(O=un(O));const M=un(this),{has:V,get:F}=mf(M);let z=V.call(M,y);z||(y=un(y),z=V.call(M,y));const Y=F.call(M,y);return M.set(y,O),z?Da(O,Y)&&jo(M,"set",y,O):jo(M,"add",y,O),this},delete(y){const O=un(this),{has:M,get:V}=mf(O);let F=M.call(O,y);F||(y=un(y),F=M.call(O,y)),V&&V.call(O,y);const z=O.delete(y);return F&&jo(O,"delete",y,void 0),z},clear(){const y=un(this),O=y.size!==0,M=y.clear();return O&&jo(y,"clear",void 0,void 0),M}}),["keys","values","entries",Symbol.iterator].forEach(y=>{E[y]=FX(y,u,_)}),E}function ev(u,_){const E=BX(u,_);return(C,y,O)=>y==="__v_isReactive"?!u:y==="__v_isReadonly"?u:y==="__v_raw"?C:Reflect.get(hn(E,y)&&y in C?E:C,y,O)}const jX={get:ev(!1,!1)},GX={get:ev(!1,!0)},WX={get:ev(!0,!1)};const Z1=new WeakMap,$1=new WeakMap,tU=new WeakMap,HX=new WeakMap;function KX(u){switch(u){case"Object":case"Array":return 1;case"Map":case"Set":case"WeakMap":case"WeakSet":return 2;default:return 0}}function YX(u){return u.__v_skip||!Object.isExtensible(u)?0:KX(EX(u))}function xf(u){return Uc(u)?u:nv(u,!1,UX,jX,Z1)}function eU(u){return nv(u,!1,VX,GX,$1)}function NR(u){return nv(u,!0,xX,WX,tU)}function nv(u,_,E,C,y){if(!jn(u)||u.__v_raw&&!(_&&u.__v_isReactive))return u;const O=YX(u);if(O===0)return u;const M=y.get(u);if(M)return M;const V=new Proxy(u,O===2?C:E);return y.set(u,V),V}function th(u){return Uc(u)?th(u.__v_raw):!!(u&&u.__v_isReactive)}function Uc(u){return!!(u&&u.__v_isReadonly)}function Fs(u){return!!(u&&u.__v_isShallow)}function iv(u){return u?!!u.__v_raw:!1}function un(u){const _=u&&u.__v_raw;return _?un(_):u}function nU(u){return!hn(u,"__v_skip")&&Object.isExtensible(u)&&M1(u,"__v_skip",!0),u}const er=u=>jn(u)?xf(u):u,DR=u=>jn(u)?NR(u):u;function ji(u){return u?u.__v_isRef===!0:!1}function iU(u){return rU(u,!1)}function qX(u){return rU(u,!0)}function rU(u,_){return ji(u)?u:new zX(u,_)}class zX{constructor(_,E){this.dep=new $R,this.__v_isRef=!0,this.__v_isShallow=!1,this._rawValue=E?_:un(_),this._value=E?_:er(_),this.__v_isShallow=E}get value(){return this.dep.track(),this._value}set value(_){const E=this._rawValue,C=this.__v_isShallow||Fs(_)||Uc(_);_=C?_:un(_),Da(_,E)&&(this._rawValue=_,this._value=C?_:er(_),this.dep.trigger())}}function Go(u){return ji(u)?u.value:u}const XX={get:(u,_,E)=>_==="__v_raw"?u:Go(Reflect.get(u,_,E)),set:(u,_,E,C)=>{const y=u[_];return ji(y)&&!ji(E)?(y.value=E,!0):Reflect.set(u,_,E,C)}};function sU(u){return th(u)?u:new Proxy(u,XX)}class JX{constructor(_,E,C){this.fn=_,this.setter=E,this._value=void 0,this.dep=new $R(this),this.__v_isRef=!0,this.deps=void 0,this.depsTail=void 0,this.flags=16,this.globalVersion=oh-1,this.next=void 0,this.effect=this,this.__v_isReadonly=!E,this.isSSR=C}notify(){if(this.flags|=16,!(this.flags&8)&&An!==this)return W1(this,!0),!0}get value(){const _=this.dep.track();return Y1(this),_&&(_.version=this.dep.version),this._value}set value(_){this.setter&&this.setter(_)}}function QX(u,_,E=!1){let C,y;return Me(u)?C=u:(C=u.get,y=u.set),new JX(C,y,E)}const gf={},If=new WeakMap;let Pc;function ZX(u,_=!1,E=Pc){if(E){let C=If.get(E);C||If.set(E,C=[]),C.push(u)}}function $X(u,_,E=wn){const{immediate:C,deep:y,once:O,scheduler:M,augmentJob:V,call:F}=E,z=Xt=>y?Xt:Fs(Xt)||y===!1||y===0?Na(Xt,1):Na(Xt);let Y,W,Z,ct,vt=!1,Yt=!1;if(ji(u)?(W=()=>u.value,vt=Fs(u)):th(u)?(W=()=>z(u),vt=!0):be(u)?(Yt=!0,vt=u.some(Xt=>th(Xt)||Fs(Xt)),W=()=>u.map(Xt=>{if(ji(Xt))return Xt.value;if(th(Xt))return z(Xt);if(Me(Xt))return F?F(Xt,2):Xt()})):Me(u)?_?W=F?()=>F(u,2):u:W=()=>{if(Z){Ho();try{Z()}finally{Ko()}}const Xt=Pc;Pc=Y;try{return F?F(u,3,[ct]):u(ct)}finally{Pc=Xt}}:W=So,_&&y){const Xt=W,pn=y===!0?1/0:y;W=()=>Na(Xt(),pn)}const Ae=wX(),ne=()=>{Y.stop(),Ae&&Ae.active&&YR(Ae.effects,Y)};if(O&&_){const Xt=_;_=(...pn)=>{Xt(...pn),ne()}}let zt=Yt?new Array(u.length).fill(gf):gf;const ie=Xt=>{if(!(!(Y.flags&1)||!Y.dirty&&!Xt))if(_){const pn=Y.run();if(y||vt||(Yt?pn.some((ai,Je)=>Da(ai,zt[Je])):Da(pn,zt))){Z&&Z();const ai=Pc;Pc=Y;try{const Je=[pn,zt===gf?void 0:Yt&&zt[0]===gf?[]:zt,ct];zt=pn,F?F(_,3,Je):_(...Je)}finally{Pc=ai}}}else Y.run()};return V&&V(ie),Y=new j1(W),Y.scheduler=M?()=>M(ie,!1):ie,ct=Xt=>ZX(Xt,!1,Y),Z=Y.onStop=()=>{const Xt=If.get(Y);if(Xt){if(F)F(Xt,4);else for(const pn of Xt)pn();If.delete(Y)}},_?C?ie(!0):zt=Y.run():M?M(ie.bind(null,!0),!0):Y.run(),ne.pause=Y.pause.bind(Y),ne.resume=Y.resume.bind(Y),ne.stop=ne,ne}function Na(u,_=1/0,E){if(_<=0||!jn(u)||u.__v_skip||(E=E||new Map,(E.get(u)||0)>=_))return u;if(E.set(u,_),_--,ji(u))Na(u.value,_,E);else if(be(u))for(let C=0;C<u.length;C++)Na(u[C],_,E);else if(N1(u)||ul(u))u.forEach(C=>{Na(C,_,E)});else if(L1(u)){for(const C in u)Na(u[C],_,E);for(const C of Object.getOwnPropertySymbols(u))Object.prototype.propertyIsEnumerable.call(u,C)&&Na(u[C],_,E)}return u}function hh(u,_,E,C){try{return C?u(...C):u()}catch(y){Vf(y,_,E)}}function To(u,_,E,C){if(Me(u)){const y=hh(u,_,E,C);return y&&D1(y)&&y.catch(O=>{Vf(O,_,E)}),y}if(be(u)){const y=[];for(let O=0;O<u.length;O++)y.push(To(u[O],_,E,C));return y}}function Vf(u,_,E,C=!0){const y=_?_.vnode:null,{errorHandler:O,throwUnhandledErrorInProduction:M}=_&&_.appContext.config||wn;if(_){let V=_.parent;const F=_.proxy,z=`https://vuejs.org/error-reference/#runtime-${E}`;for(;V;){const Y=V.ec;if(Y){for(let W=0;W<Y.length;W++)if(Y[W](u,F,z)===!1)return}V=V.parent}if(O){Ho(),hh(O,null,10,[u,F,z]),Ko();return}}t9(u,E,y,C,M)}function t9(u,_,E,C=!0,y=!1){if(y)throw u;console.error(u)}const nr=[];let fo=-1;const hl=[];let Aa=null,ol=0;const oU=Promise.resolve();let bf=null;function aU(u){const _=bf||oU;return u?_.then(this?u.bind(this):u):_}function e9(u){let _=fo+1,E=nr.length;for(;_<E;){const C=_+E>>>1,y=nr[C],O=ch(y);O<u||O===u&&y.flags&2?_=C+1:E=C}return _}function rv(u){if(!(u.flags&1)){const _=ch(u),E=nr[nr.length-1];!E||!(u.flags&2)&&_>=ch(E)?nr.push(u):nr.splice(e9(_),0,u),u.flags|=1,cU()}}function cU(){bf||(bf=oU.then(lU))}function n9(u){be(u)?hl.push(...u):Aa&&u.id===-1?Aa.splice(ol+1,0,u):u.flags&1||(hl.push(u),u.flags|=1),cU()}function FM(u,_,E=fo+1){for(;E<nr.length;E++){const C=nr[E];if(C&&C.flags&2){if(u&&C.id!==u.uid)continue;nr.splice(E,1),E--,C.flags&4&&(C.flags&=-2),C(),C.flags&4||(C.flags&=-2)}}}function dU(u){if(hl.length){const _=[...new Set(hl)].sort((E,C)=>ch(E)-ch(C));if(hl.length=0,Aa){Aa.push(..._);return}for(Aa=_,ol=0;ol<Aa.length;ol++){const E=Aa[ol];E.flags&4&&(E.flags&=-2),E.flags&8||E(),E.flags&=-2}Aa=null,ol=0}}const ch=u=>u.id==null?u.flags&2?-1:1/0:u.id;function lU(u){try{for(fo=0;fo<nr.length;fo++){const _=nr[fo];_&&!(_.flags&8)&&(_.flags&4&&(_.flags&=-2),hh(_,_.i,_.i?15:14),_.flags&4||(_.flags&=-2))}}finally{for(;fo<nr.length;fo++){const _=nr[fo];_&&(_.flags&=-2)}fo=-1,nr.length=0,dU(),bf=null,(nr.length||hl.length)&&lU()}}let go=null,uU=null;function Af(u){const _=go;return go=u,uU=u&&u.type.__scopeId||null,_}function PR(u,_=go,E){if(!_||u._n)return u;const C=(...y)=>{C._d&&Nf(-1);const O=Af(_);let M;try{M=u(...y)}finally{Af(O),C._d&&Nf(1)}return M};return C._n=!0,C._c=!0,C._d=!0,C}function Nc(u,_,E,C){const y=u.dirs,O=_&&_.dirs;for(let M=0;M<y.length;M++){const V=y[M];O&&(V.oldValue=O[M].value);let F=V.dir[C];F&&(Ho(),To(F,E,8,[u.el,V,u,_]),Ko())}}const i9=Symbol("_vte"),r9=u=>u.__isTeleport,s9=Symbol("_leaveCb");function sv(u,_){u.shapeFlag&6&&u.component?(u.transition=_,sv(u.component.subTree,_)):u.shapeFlag&128?(u.ssContent.transition=_.clone(u.ssContent),u.ssFallback.transition=_.clone(u.ssFallback)):u.transition=_}function ph(u,_){return Me(u)?Gi({name:u.name},_,{setup:u}):u}function hU(u){u.ids=[u.ids[0]+u.ids[2]+++"-",0,0]}const wf=new WeakMap;function eh(u,_,E,C,y=!1){if(be(u)){u.forEach((vt,Yt)=>eh(vt,_&&(be(_)?_[Yt]:_),E,C,y));return}if(nh(C)&&!y){C.shapeFlag&512&&C.type.__asyncResolved&&C.component.subTree.component&&eh(u,_,E,C.component.subTree);return}const O=C.shapeFlag&4?uv(C.component):C.el,M=y?null:O,{i:V,r:F}=u,z=_&&_.r,Y=V.refs===wn?V.refs={}:V.refs,W=V.setupState,Z=un(W),ct=W===wn?O1:vt=>hn(Z,vt);if(z!=null&&z!==F){if(BM(_),hi(z))Y[z]=null,ct(z)&&(W[z]=null);else if(ji(z)){z.value=null;const vt=_;vt.k&&(Y[vt.k]=null)}}if(Me(F))hh(F,V,12,[M,Y]);else{const vt=hi(F),Yt=ji(F);if(vt||Yt){const Ae=()=>{if(u.f){const ne=vt?ct(F)?W[F]:Y[F]:F.value;if(y)be(ne)&&YR(ne,O);else if(be(ne))ne.includes(O)||ne.push(O);else if(vt)Y[F]=[O],ct(F)&&(W[F]=Y[F]);else{const zt=[O];F.value=zt,u.k&&(Y[u.k]=zt)}}else vt?(Y[F]=M,ct(F)&&(W[F]=M)):Yt&&(F.value=M,u.k&&(Y[u.k]=M))};if(M){const ne=()=>{Ae(),wf.delete(u)};ne.id=-1,wf.set(u,ne),xr(ne,E)}else BM(u),Ae()}}}function BM(u){const _=wf.get(u);_&&(_.flags|=8,wf.delete(u))}Uf().requestIdleCallback;Uf().cancelIdleCallback;const nh=u=>!!u.type.__asyncLoader,pU=u=>u.type.__isKeepAlive;function o9(u,_){_U(u,"a",_)}function a9(u,_){_U(u,"da",_)}function _U(u,_,E=rr){const C=u.__wdc||(u.__wdc=()=>{let y=E;for(;y;){if(y.isDeactivated)return;y=y.parent}return u()});if(Ff(_,C,E),E){let y=E.parent;for(;y&&y.parent;)pU(y.parent.vnode)&&c9(C,_,E,y),y=y.parent}}function c9(u,_,E,C){const y=Ff(_,u,C,!0);fU(()=>{YR(C[_],y)},E)}function Ff(u,_,E=rr,C=!1){if(E){const y=E[u]||(E[u]=[]),O=_.__weh||(_.__weh=(...M)=>{Ho();const V=_h(E),F=To(_,E,u,M);return V(),Ko(),F});return C?y.unshift(O):y.push(O),O}}const Yo=u=>(_,E=rr)=>{(!lh||u==="sp")&&Ff(u,(...C)=>_(...C),E)},d9=Yo("bm"),l9=Yo("m"),u9=Yo("bu"),h9=Yo("u"),p9=Yo("bum"),fU=Yo("um"),_9=Yo("sp"),f9=Yo("rtg"),m9=Yo("rtc");function E9(u,_=rr){Ff("ec",u,_)}const g9=Symbol.for("v-ndc"),LR=u=>u?kU(u)?uv(u):LR(u.parent):null,ih=Gi(Object.create(null),{$:u=>u,$el:u=>u.vnode.el,$data:u=>u.data,$props:u=>u.props,$attrs:u=>u.attrs,$slots:u=>u.slots,$refs:u=>u.refs,$parent:u=>LR(u.parent),$root:u=>LR(u.root),$host:u=>u.ce,$emit:u=>u.emit,$options:u=>EU(u),$forceUpdate:u=>u.f||(u.f=()=>{rv(u.update)}),$nextTick:u=>u.n||(u.n=aU.bind(u.proxy)),$watch:u=>F9.bind(u)}),mR=(u,_)=>u!==wn&&!u.__isScriptSetup&&hn(u,_),S9={get({_:u},_){if(_==="__v_skip")return!0;const{ctx:E,setupState:C,data:y,props:O,accessCache:M,type:V,appContext:F}=u;let z;if(_[0]!=="$"){const ct=M[_];if(ct!==void 0)switch(ct){case 1:return C[_];case 2:return y[_];case 4:return E[_];case 3:return O[_]}else{if(mR(C,_))return M[_]=1,C[_];if(y!==wn&&hn(y,_))return M[_]=2,y[_];if((z=u.propsOptions[0])&&hn(z,_))return M[_]=3,O[_];if(E!==wn&&hn(E,_))return M[_]=4,E[_];kR&&(M[_]=0)}}const Y=ih[_];let W,Z;if(Y)return _==="$attrs"&&Bi(u.attrs,"get",""),Y(u);if((W=V.__cssModules)&&(W=W[_]))return W;if(E!==wn&&hn(E,_))return M[_]=4,E[_];if(Z=F.config.globalProperties,hn(Z,_))return Z[_]},set({_:u},_,E){const{data:C,setupState:y,ctx:O}=u;return mR(y,_)?(y[_]=E,!0):C!==wn&&hn(C,_)?(C[_]=E,!0):hn(u.props,_)||_[0]==="$"&&_.slice(1)in u?!1:(O[_]=E,!0)},has({_:{data:u,setupState:_,accessCache:E,ctx:C,appContext:y,propsOptions:O,type:M}},V){let F,z;return!!(E[V]||u!==wn&&V[0]!=="$"&&hn(u,V)||mR(_,V)||(F=O[0])&&hn(F,V)||hn(C,V)||hn(ih,V)||hn(y.config.globalProperties,V)||(z=M.__cssModules)&&z[V])},defineProperty(u,_,E){return E.get!=null?u._.accessCache[_]=0:hn(E,"value")&&this.set(u,_,E.value,null),Reflect.defineProperty(u,_,E)}};function jM(u){return be(u)?u.reduce((_,E)=>(_[E]=null,_),{}):u}let kR=!0;function T9(u){const _=EU(u),E=u.proxy,C=u.ctx;kR=!1,_.beforeCreate&&GM(_.beforeCreate,u,"bc");const{data:y,computed:O,methods:M,watch:V,provide:F,inject:z,created:Y,beforeMount:W,mounted:Z,beforeUpdate:ct,updated:vt,activated:Yt,deactivated:Ae,beforeDestroy:ne,beforeUnmount:zt,destroyed:ie,unmounted:Xt,render:pn,renderTracked:ai,renderTriggered:Je,errorCaptured:Fr,serverPrefetch:js,expose:Pi,inheritAttrs:Br,components:sn,directives:Wi,filters:zn}=_;if(z&&R9(z,C,null),M)for(const ue in M){const ze=M[ue];Me(ze)&&(C[ue]=ze.bind(E))}if(y){const ue=y.call(E,E);jn(ue)&&(u.data=xf(ue))}if(kR=!0,O)for(const ue in O){const ze=O[ue],jr=Me(ze)?ze.bind(E,E):Me(ze.get)?ze.get.bind(E,E):So,hs=!Me(ze)&&Me(ze.set)?ze.set.bind(E):So,Gr=xs({get:jr,set:hs});Object.defineProperty(C,ue,{enumerable:!0,configurable:!0,get:()=>Gr.value,set:Wn=>Gr.value=Wn})}if(V)for(const ue in V)mU(V[ue],C,E,ue);if(F){const ue=Me(F)?F.call(E):F;Reflect.ownKeys(ue).forEach(ze=>{Sf(ze,ue[ze])})}Y&&GM(Y,u,"c");function Gn(ue,ze){be(ze)?ze.forEach(jr=>ue(jr.bind(E))):ze&&ue(ze.bind(E))}if(Gn(d9,W),Gn(l9,Z),Gn(u9,ct),Gn(h9,vt),Gn(o9,Yt),Gn(a9,Ae),Gn(E9,Fr),Gn(m9,ai),Gn(f9,Je),Gn(p9,zt),Gn(fU,Xt),Gn(_9,js),be(Pi))if(Pi.length){const ue=u.exposed||(u.exposed={});Pi.forEach(ze=>{Object.defineProperty(ue,ze,{get:()=>E[ze],set:jr=>E[ze]=jr,enumerable:!0})})}else u.exposed||(u.exposed={});pn&&u.render===So&&(u.render=pn),Br!=null&&(u.inheritAttrs=Br),sn&&(u.components=sn),Wi&&(u.directives=Wi),js&&hU(u)}function R9(u,_,E=So){be(u)&&(u=MR(u));for(const C in u){const y=u[C];let O;jn(y)?"default"in y?O=Wo(y.from||C,y.default,!0):O=Wo(y.from||C):O=Wo(y),ji(O)?Object.defineProperty(_,C,{enumerable:!0,configurable:!0,get:()=>O.value,set:M=>O.value=M}):_[C]=O}}function GM(u,_,E){To(be(u)?u.map(C=>C.bind(_.proxy)):u.bind(_.proxy),_,E)}function mU(u,_,E,C){let y=C.includes(".")?NU(E,C):()=>E[C];if(hi(u)){const O=_[u];Me(O)&&Tf(y,O)}else if(Me(u))Tf(y,u.bind(E));else if(jn(u))if(be(u))u.forEach(O=>mU(O,_,E,C));else{const O=Me(u.handler)?u.handler.bind(E):_[u.handler];Me(O)&&Tf(y,O,u)}}function EU(u){const _=u.type,{mixins:E,extends:C}=_,{mixins:y,optionsCache:O,config:{optionMergeStrategies:M}}=u.appContext,V=O.get(_);let F;return V?F=V:!y.length&&!E&&!C?F=_:(F={},y.length&&y.forEach(z=>Of(F,z,M,!0)),Of(F,_,M)),jn(_)&&O.set(_,F),F}function Of(u,_,E,C=!1){const{mixins:y,extends:O}=_;O&&Of(u,O,E,!0),y&&y.forEach(M=>Of(u,M,E,!0));for(const M in _)if(!(C&&M==="expose")){const V=v9[M]||E&&E[M];u[M]=V?V(u[M],_[M]):_[M]}return u}const v9={data:WM,props:HM,emits:HM,methods:Xu,computed:Xu,beforeCreate:$i,created:$i,beforeMount:$i,mounted:$i,beforeUpdate:$i,updated:$i,beforeDestroy:$i,beforeUnmount:$i,destroyed:$i,unmounted:$i,activated:$i,deactivated:$i,errorCaptured:$i,serverPrefetch:$i,components:Xu,directives:Xu,watch:y9,provide:WM,inject:C9};function WM(u,_){return _?u?function(){return Gi(Me(u)?u.call(this,this):u,Me(_)?_.call(this,this):_)}:_:u}function C9(u,_){return Xu(MR(u),MR(_))}function MR(u){if(be(u)){const _={};for(let E=0;E<u.length;E++)_[u[E]]=u[E];return _}return u}function $i(u,_){return u?[...new Set([].concat(u,_))]:_}function Xu(u,_){return u?Gi(Object.create(null),u,_):_}function HM(u,_){return u?be(u)&&be(_)?[...new Set([...u,..._])]:Gi(Object.create(null),jM(u),jM(_??{})):_}function y9(u,_){if(!u)return _;if(!_)return u;const E=Gi(Object.create(null),u);for(const C in _)E[C]=$i(u[C],_[C]);return E}function gU(){return{app:null,config:{isNativeTag:O1,performance:!1,globalProperties:{},optionMergeStrategies:{},errorHandler:void 0,warnHandler:void 0,compilerOptions:{}},mixins:[],components:{},directives:{},provides:Object.create(null),optionsCache:new WeakMap,propsCache:new WeakMap,emitsCache:new WeakMap}}let I9=0;function b9(u,_){return function(C,y=null){Me(C)||(C=Gi({},C)),y!=null&&!jn(y)&&(y=null);const O=gU(),M=new WeakSet,V=[];let F=!1;const z=O.app={_uid:I9++,_component:C,_props:y,_container:null,_context:O,_instance:null,version:cJ,get config(){return O.config},set config(Y){},use(Y,...W){return M.has(Y)||(Y&&Me(Y.install)?(M.add(Y),Y.install(z,...W)):Me(Y)&&(M.add(Y),Y(z,...W))),z},mixin(Y){return O.mixins.includes(Y)||O.mixins.push(Y),z},component(Y,W){return W?(O.components[Y]=W,z):O.components[Y]},directive(Y,W){return W?(O.directives[Y]=W,z):O.directives[Y]},mount(Y,W,Z){if(!F){const ct=z._ceVNode||sr(C,y);return ct.appContext=O,Z===!0?Z="svg":Z===!1&&(Z=void 0),u(ct,Y,Z),F=!0,z._container=Y,Y.__vue_app__=z,uv(ct.component)}},onUnmount(Y){V.push(Y)},unmount(){F&&(To(V,z._instance,16),u(null,z._container),delete z._container.__vue_app__)},provide(Y,W){return O.provides[Y]=W,z},runWithContext(Y){const W=pl;pl=z;try{return Y()}finally{pl=W}}};return z}}let pl=null;function Sf(u,_){if(rr){let E=rr.provides;const C=rr.parent&&rr.parent.provides;C===E&&(E=rr.provides=Object.create(C)),E[u]=_}}function Wo(u,_,E=!1){const C=nJ();if(C||pl){let y=pl?pl._context.provides:C?C.parent==null||C.ce?C.vnode.appContext&&C.vnode.appContext.provides:C.parent.provides:void 0;if(y&&u in y)return y[u];if(arguments.length>1)return E&&Me(_)?_.call(C&&C.proxy):_}}const SU={},TU=()=>Object.create(SU),RU=u=>Object.getPrototypeOf(u)===SU;function A9(u,_,E,C=!1){const y={},O=TU();u.propsDefaults=Object.create(null),vU(u,_,y,O);for(const M in u.propsOptions[0])M in y||(y[M]=void 0);E?u.props=C?y:eU(y):u.type.props?u.props=y:u.props=O,u.attrs=O}function w9(u,_,E,C){const{props:y,attrs:O,vnode:{patchFlag:M}}=u,V=un(y),[F]=u.propsOptions;let z=!1;if((C||M>0)&&!(M&16)){if(M&8){const Y=u.vnode.dynamicProps;for(let W=0;W<Y.length;W++){let Z=Y[W];if(Bf(u.emitsOptions,Z))continue;const ct=_[Z];if(F)if(hn(O,Z))ct!==O[Z]&&(O[Z]=ct,z=!0);else{const vt=Pa(Z);y[vt]=UR(F,V,vt,ct,u,!1)}else ct!==O[Z]&&(O[Z]=ct,z=!0)}}}else{vU(u,_,y,O)&&(z=!0);let Y;for(const W in V)(!_||!hn(_,W)&&((Y=xc(W))===W||!hn(_,Y)))&&(F?E&&(E[W]!==void 0||E[Y]!==void 0)&&(y[W]=UR(F,V,W,void 0,u,!0)):delete y[W]);if(O!==V)for(const W in O)(!_||!hn(_,W))&&(delete O[W],z=!0)}z&&jo(u.attrs,"set","")}function vU(u,_,E,C){const[y,O]=u.propsOptions;let M=!1,V;if(_)for(let F in _){if(Qu(F))continue;const z=_[F];let Y;y&&hn(y,Y=Pa(F))?!O||!O.includes(Y)?E[Y]=z:(V||(V={}))[Y]=z:Bf(u.emitsOptions,F)||(!(F in C)||z!==C[F])&&(C[F]=z,M=!0)}if(O){const F=un(E),z=V||wn;for(let Y=0;Y<O.length;Y++){const W=O[Y];E[W]=UR(y,F,W,z[W],u,!hn(z,W))}}return M}function UR(u,_,E,C,y,O){const M=u[E];if(M!=null){const V=hn(M,"default");if(V&&C===void 0){const F=M.default;if(M.type!==Function&&!M.skipFactory&&Me(F)){const{propsDefaults:z}=y;if(E in z)C=z[E];else{const Y=_h(y);C=z[E]=F.call(null,_),Y()}}else C=F;y.ce&&y.ce._setProp(E,C)}M[0]&&(O&&!V?C=!1:M[1]&&(C===""||C===xc(E))&&(C=!0))}return C}const O9=new WeakMap;function CU(u,_,E=!1){const C=E?O9:_.propsCache,y=C.get(u);if(y)return y;const O=u.props,M={},V=[];let F=!1;if(!Me(u)){const Y=W=>{F=!0;const[Z,ct]=CU(W,_,!0);Gi(M,Z),ct&&V.push(...ct)};!E&&_.mixins.length&&_.mixins.forEach(Y),u.extends&&Y(u.extends),u.mixins&&u.mixins.forEach(Y)}if(!O&&!F)return jn(u)&&C.set(u,ll),ll;if(be(O))for(let Y=0;Y<O.length;Y++){const W=Pa(O[Y]);KM(W)&&(M[W]=wn)}else if(O)for(const Y in O){const W=Pa(Y);if(KM(W)){const Z=O[Y],ct=M[W]=be(Z)||Me(Z)?{type:Z}:Gi({},Z),vt=ct.type;let Yt=!1,Ae=!0;if(be(vt))for(let ne=0;ne<vt.length;++ne){const zt=vt[ne],ie=Me(zt)&&zt.name;if(ie==="Boolean"){Yt=!0;break}else ie==="String"&&(Ae=!1)}else Yt=Me(vt)&&vt.name==="Boolean";ct[0]=Yt,ct[1]=Ae,(Yt||hn(ct,"default"))&&V.push(W)}}const z=[M,V];return jn(u)&&C.set(u,z),z}function KM(u){return u[0]!=="$"&&!Qu(u)}const ov=u=>u==="_"||u==="_ctx"||u==="$stable",av=u=>be(u)?u.map(Eo):[Eo(u)],N9=(u,_,E)=>{if(_._n)return _;const C=PR((...y)=>av(_(...y)),E);return C._c=!1,C},yU=(u,_,E)=>{const C=u._ctx;for(const y in u){if(ov(y))continue;const O=u[y];if(Me(O))_[y]=N9(y,O,C);else if(O!=null){const M=av(O);_[y]=()=>M}}},IU=(u,_)=>{const E=av(_);u.slots.default=()=>E},bU=(u,_,E)=>{for(const C in _)(E||!ov(C))&&(u[C]=_[C])},D9=(u,_,E)=>{const C=u.slots=TU();if(u.vnode.shapeFlag&32){const y=_._;y?(bU(C,_,E),E&&M1(C,"_",y,!0)):yU(_,C)}else _&&IU(u,_)},P9=(u,_,E)=>{const{vnode:C,slots:y}=u;let O=!0,M=wn;if(C.shapeFlag&32){const V=_._;V?E&&V===1?O=!1:bU(y,_,E):(O=!_.$stable,yU(_,y)),M=_}else _&&(IU(u,_),M={default:1});if(O)for(const V in y)!ov(V)&&M[V]==null&&delete y[V]},xr=q9;function L9(u){return k9(u)}function k9(u,_){const E=Uf();E.__VUE__=!0;const{insert:C,remove:y,patchProp:O,createElement:M,createText:V,createComment:F,setText:z,setElementText:Y,parentNode:W,nextSibling:Z,setScopeId:ct=So,insertStaticContent:vt}=u,Yt=(G,K,it,gt=null,St=null,Et=null,bt=void 0,It=null,Nt=!!K.dynamicChildren)=>{if(G===K)return;G&&!qu(G,K)&&(gt=mt(G),Wn(G,St,Et,!0),G=null),K.patchFlag===-2&&(Nt=!1,K.dynamicChildren=null);const{type:Ct,ref:ce,shapeFlag:Ft}=K;switch(Ct){case jf:Ae(G,K,it,gt);break;case fl:ne(G,K,it,gt);break;case gR:G==null&&zt(K,it,gt,bt);break;case mo:sn(G,K,it,gt,St,Et,bt,It,Nt);break;default:Ft&1?pn(G,K,it,gt,St,Et,bt,It,Nt):Ft&6?Wi(G,K,it,gt,St,Et,bt,It,Nt):(Ft&64||Ft&128)&&Ct.process(G,K,it,gt,St,Et,bt,It,Nt,$t)}ce!=null&&St?eh(ce,G&&G.ref,Et,K||G,!K):ce==null&&G&&G.ref!=null&&eh(G.ref,null,Et,G,!0)},Ae=(G,K,it,gt)=>{if(G==null)C(K.el=V(K.children),it,gt);else{const St=K.el=G.el;K.children!==G.children&&z(St,K.children)}},ne=(G,K,it,gt)=>{G==null?C(K.el=F(K.children||""),it,gt):K.el=G.el},zt=(G,K,it,gt)=>{[G.el,G.anchor]=vt(G.children,K,it,gt,G.el,G.anchor)},ie=({el:G,anchor:K},it,gt)=>{let St;for(;G&&G!==K;)St=Z(G),C(G,it,gt),G=St;C(K,it,gt)},Xt=({el:G,anchor:K})=>{let it;for(;G&&G!==K;)it=Z(G),y(G),G=it;y(K)},pn=(G,K,it,gt,St,Et,bt,It,Nt)=>{if(K.type==="svg"?bt="svg":K.type==="math"&&(bt="mathml"),G==null)ai(K,it,gt,St,Et,bt,It,Nt);else{const Ct=G.el&&G.el._isVueCE?G.el:null;try{Ct&&Ct._beginPatch(),js(G,K,St,Et,bt,It,Nt)}finally{Ct&&Ct._endPatch()}}},ai=(G,K,it,gt,St,Et,bt,It)=>{let Nt,Ct;const{props:ce,shapeFlag:Ft,transition:jt,dirs:_e}=G;if(Nt=G.el=M(G.type,Et,ce&&ce.is,ce),Ft&8?Y(Nt,G.children):Ft&16&&Fr(G.children,Nt,null,gt,St,ER(G,Et),bt,It),_e&&Nc(G,null,gt,"created"),Je(Nt,G,G.scopeId,bt,gt),ce){for(const Ye in ce)Ye!=="value"&&!Qu(Ye)&&O(Nt,Ye,null,ce[Ye],Et,gt);"value"in ce&&O(Nt,"value",null,ce.value,Et),(Ct=ce.onVnodeBeforeMount)&&_o(Ct,gt,G)}_e&&Nc(G,null,gt,"beforeMount");const je=M9(St,jt);je&&jt.beforeEnter(Nt),C(Nt,K,it),((Ct=ce&&ce.onVnodeMounted)||je||_e)&&xr(()=>{Ct&&_o(Ct,gt,G),je&&jt.enter(Nt),_e&&Nc(G,null,gt,"mounted")},St)},Je=(G,K,it,gt,St)=>{if(it&&ct(G,it),gt)for(let Et=0;Et<gt.length;Et++)ct(G,gt[Et]);if(St){let Et=St.subTree;if(K===Et||PU(Et.type)&&(Et.ssContent===K||Et.ssFallback===K)){const bt=St.vnode;Je(G,bt,bt.scopeId,bt.slotScopeIds,St.parent)}}},Fr=(G,K,it,gt,St,Et,bt,It,Nt=0)=>{for(let Ct=Nt;Ct<G.length;Ct++){const ce=G[Ct]=It?wa(G[Ct]):Eo(G[Ct]);Yt(null,ce,K,it,gt,St,Et,bt,It)}},js=(G,K,it,gt,St,Et,bt)=>{const It=K.el=G.el;let{patchFlag:Nt,dynamicChildren:Ct,dirs:ce}=K;Nt|=G.patchFlag&16;const Ft=G.props||wn,jt=K.props||wn;let _e;if(it&&Dc(it,!1),(_e=jt.onVnodeBeforeUpdate)&&_o(_e,it,K,G),ce&&Nc(K,G,it,"beforeUpdate"),it&&Dc(it,!0),(Ft.innerHTML&&jt.innerHTML==null||Ft.textContent&&jt.textContent==null)&&Y(It,""),Ct?Pi(G.dynamicChildren,Ct,It,it,gt,ER(K,St),Et):bt||ze(G,K,It,null,it,gt,ER(K,St),Et,!1),Nt>0){if(Nt&16)Br(It,Ft,jt,it,St);else if(Nt&2&&Ft.class!==jt.class&&O(It,"class",null,jt.class,St),Nt&4&&O(It,"style",Ft.style,jt.style,St),Nt&8){const je=K.dynamicProps;for(let Ye=0;Ye<je.length;Ye++){const en=je[Ye],pi=Ft[en],vi=jt[en];(vi!==pi||en==="value")&&O(It,en,pi,vi,St,it)}}Nt&1&&G.children!==K.children&&Y(It,K.children)}else!bt&&Ct==null&&Br(It,Ft,jt,it,St);((_e=jt.onVnodeUpdated)||ce)&&xr(()=>{_e&&_o(_e,it,K,G),ce&&Nc(K,G,it,"updated")},gt)},Pi=(G,K,it,gt,St,Et,bt)=>{for(let It=0;It<K.length;It++){const Nt=G[It],Ct=K[It],ce=Nt.el&&(Nt.type===mo||!qu(Nt,Ct)||Nt.shapeFlag&198)?W(Nt.el):it;Yt(Nt,Ct,ce,null,gt,St,Et,bt,!0)}},Br=(G,K,it,gt,St)=>{if(K!==it){if(K!==wn)for(const Et in K)!Qu(Et)&&!(Et in it)&&O(G,Et,K[Et],null,St,gt);for(const Et in it){if(Qu(Et))continue;const bt=it[Et],It=K[Et];bt!==It&&Et!=="value"&&O(G,Et,It,bt,St,gt)}"value"in it&&O(G,"value",K.value,it.value,St)}},sn=(G,K,it,gt,St,Et,bt,It,Nt)=>{const Ct=K.el=G?G.el:V(""),ce=K.anchor=G?G.anchor:V("");let{patchFlag:Ft,dynamicChildren:jt,slotScopeIds:_e}=K;_e&&(It=It?It.concat(_e):_e),G==null?(C(Ct,it,gt),C(ce,it,gt),Fr(K.children||[],it,ce,St,Et,bt,It,Nt)):Ft>0&&Ft&64&&jt&&G.dynamicChildren?(Pi(G.dynamicChildren,jt,it,St,Et,bt,It),(K.key!=null||St&&K===St.subTree)&&AU(G,K,!0)):ze(G,K,it,ce,St,Et,bt,It,Nt)},Wi=(G,K,it,gt,St,Et,bt,It,Nt)=>{K.slotScopeIds=It,G==null?K.shapeFlag&512?St.ctx.activate(K,it,gt,bt,Nt):zn(K,it,gt,St,Et,bt,Nt):qo(G,K,Nt)},zn=(G,K,it,gt,St,Et,bt)=>{const It=G.component=eJ(G,gt,St);if(pU(G)&&(It.ctx.renderer=$t),iJ(It,!1,bt),It.asyncDep){if(St&&St.registerDep(It,Gn,bt),!G.el){const Nt=It.subTree=sr(fl);ne(null,Nt,K,it),G.placeholder=Nt.el}}else Gn(It,G,K,it,St,Et,bt)},qo=(G,K,it)=>{const gt=K.component=G.component;if(K9(G,K,it))if(gt.asyncDep&&!gt.asyncResolved){ue(gt,K,it);return}else gt.next=K,gt.update();else K.el=G.el,gt.vnode=K},Gn=(G,K,it,gt,St,Et,bt)=>{const It=()=>{if(G.isMounted){let{next:Ft,bu:jt,u:_e,parent:je,vnode:Ye}=G;{const Cr=wU(G);if(Cr){Ft&&(Ft.el=Ye.el,ue(G,Ft,bt)),Cr.asyncDep.then(()=>{G.isUnmounted||It()});return}}let en=Ft,pi;Dc(G,!1),Ft?(Ft.el=Ye.el,ue(G,Ft,bt)):Ft=Ye,jt&&uR(jt),(pi=Ft.props&&Ft.props.onVnodeBeforeUpdate)&&_o(pi,je,Ft,Ye),Dc(G,!0);const vi=qM(G),vr=G.subTree;G.subTree=vi,Yt(vr,vi,W(vr.el),mt(vr),G,St,Et),Ft.el=vi.el,en===null&&Y9(G,vi.el),_e&&xr(_e,St),(pi=Ft.props&&Ft.props.onVnodeUpdated)&&xr(()=>_o(pi,je,Ft,Ye),St)}else{let Ft;const{el:jt,props:_e}=K,{bm:je,m:Ye,parent:en,root:pi,type:vi}=G,vr=nh(K);Dc(G,!1),je&&uR(je),!vr&&(Ft=_e&&_e.onVnodeBeforeMount)&&_o(Ft,en,K),Dc(G,!0);{pi.ce&&pi.ce._def.shadowRoot!==!1&&pi.ce._injectChildStyle(vi);const Cr=G.subTree=qM(G);Yt(null,Cr,it,gt,G,St,Et),K.el=Cr.el}if(Ye&&xr(Ye,St),!vr&&(Ft=_e&&_e.onVnodeMounted)){const Cr=K;xr(()=>_o(Ft,en,Cr),St)}(K.shapeFlag&256||en&&nh(en.vnode)&&en.vnode.shapeFlag&256)&&G.a&&xr(G.a,St),G.isMounted=!0,K=it=gt=null}};G.scope.on();const Nt=G.effect=new j1(It);G.scope.off();const Ct=G.update=Nt.run.bind(Nt),ce=G.job=Nt.runIfDirty.bind(Nt);ce.i=G,ce.id=G.uid,Nt.scheduler=()=>rv(ce),Dc(G,!0),Ct()},ue=(G,K,it)=>{K.component=G;const gt=G.vnode.props;G.vnode=K,G.next=null,w9(G,K.props,gt,it),P9(G,K.children,it),Ho(),FM(G),Ko()},ze=(G,K,it,gt,St,Et,bt,It,Nt=!1)=>{const Ct=G&&G.children,ce=G?G.shapeFlag:0,Ft=K.children,{patchFlag:jt,shapeFlag:_e}=K;if(jt>0){if(jt&128){hs(Ct,Ft,it,gt,St,Et,bt,It,Nt);return}else if(jt&256){jr(Ct,Ft,it,gt,St,Et,bt,It,Nt);return}}_e&8?(ce&16&&or(Ct,St,Et),Ft!==Ct&&Y(it,Ft)):ce&16?_e&16?hs(Ct,Ft,it,gt,St,Et,bt,It,Nt):or(Ct,St,Et,!0):(ce&8&&Y(it,""),_e&16&&Fr(Ft,it,gt,St,Et,bt,It,Nt))},jr=(G,K,it,gt,St,Et,bt,It,Nt)=>{G=G||ll,K=K||ll;const Ct=G.length,ce=K.length,Ft=Math.min(Ct,ce);let jt;for(jt=0;jt<Ft;jt++){const _e=K[jt]=Nt?wa(K[jt]):Eo(K[jt]);Yt(G[jt],_e,it,null,St,Et,bt,It,Nt)}Ct>ce?or(G,St,Et,!0,!1,Ft):Fr(K,it,gt,St,Et,bt,It,Nt,Ft)},hs=(G,K,it,gt,St,Et,bt,It,Nt)=>{let Ct=0;const ce=K.length;let Ft=G.length-1,jt=ce-1;for(;Ct<=Ft&&Ct<=jt;){const _e=G[Ct],je=K[Ct]=Nt?wa(K[Ct]):Eo(K[Ct]);if(qu(_e,je))Yt(_e,je,it,null,St,Et,bt,It,Nt);else break;Ct++}for(;Ct<=Ft&&Ct<=jt;){const _e=G[Ft],je=K[jt]=Nt?wa(K[jt]):Eo(K[jt]);if(qu(_e,je))Yt(_e,je,it,null,St,Et,bt,It,Nt);else break;Ft--,jt--}if(Ct>Ft){if(Ct<=jt){const _e=jt+1,je=_e<ce?K[_e].el:gt;for(;Ct<=jt;)Yt(null,K[Ct]=Nt?wa(K[Ct]):Eo(K[Ct]),it,je,St,Et,bt,It,Nt),Ct++}}else if(Ct>jt)for(;Ct<=Ft;)Wn(G[Ct],St,Et,!0),Ct++;else{const _e=Ct,je=Ct,Ye=new Map;for(Ct=je;Ct<=jt;Ct++){const Li=K[Ct]=Nt?wa(K[Ct]):Eo(K[Ct]);Li.key!=null&&Ye.set(Li.key,Ct)}let en,pi=0;const vi=jt-je+1;let vr=!1,Cr=0;const zo=new Array(vi);for(Ct=0;Ct<vi;Ct++)zo[Ct]=0;for(Ct=_e;Ct<=Ft;Ct++){const Li=G[Ct];if(pi>=vi){Wn(Li,St,Et,!0);continue}let Wr;if(Li.key!=null)Wr=Ye.get(Li.key);else for(en=je;en<=jt;en++)if(zo[en-je]===0&&qu(Li,K[en])){Wr=en;break}Wr===void 0?Wn(Li,St,Et,!0):(zo[Wr-je]=Ct+1,Wr>=Cr?Cr=Wr:vr=!0,Yt(Li,K[Wr],it,null,St,Et,bt,It,Nt),pi++)}const Gs=vr?U9(zo):ll;for(en=Gs.length-1,Ct=vi-1;Ct>=0;Ct--){const Li=je+Ct,Wr=K[Li],fh=K[Li+1],vo=Li+1<ce?fh.el||fh.placeholder:gt;zo[Ct]===0?Yt(null,Wr,it,vo,St,Et,bt,It,Nt):vr&&(en<0||Ct!==Gs[en]?Gr(Wr,it,vo,2):en--)}}},Gr=(G,K,it,gt,St=null)=>{const{el:Et,type:bt,transition:It,children:Nt,shapeFlag:Ct}=G;if(Ct&6){Gr(G.component.subTree,K,it,gt);return}if(Ct&128){G.suspense.move(K,it,gt);return}if(Ct&64){bt.move(G,K,it,$t);return}if(bt===mo){C(Et,K,it);for(let Ft=0;Ft<Nt.length;Ft++)Gr(Nt[Ft],K,it,gt);C(G.anchor,K,it);return}if(bt===gR){ie(G,K,it);return}if(gt!==2&&Ct&1&&It)if(gt===0)It.beforeEnter(Et),C(Et,K,it),xr(()=>It.enter(Et),St);else{const{leave:Ft,delayLeave:jt,afterLeave:_e}=It,je=()=>{G.ctx.isUnmounted?y(Et):C(Et,K,it)},Ye=()=>{Et._isLeaving&&Et[s9](!0),Ft(Et,()=>{je(),_e&&_e()})};jt?jt(Et,je,Ye):Ye()}else C(Et,K,it)},Wn=(G,K,it,gt=!1,St=!1)=>{const{type:Et,props:bt,ref:It,children:Nt,dynamicChildren:Ct,shapeFlag:ce,patchFlag:Ft,dirs:jt,cacheIndex:_e}=G;if(Ft===-2&&(St=!1),It!=null&&(Ho(),eh(It,null,it,G,!0),Ko()),_e!=null&&(K.renderCache[_e]=void 0),ce&256){K.ctx.deactivate(G);return}const je=ce&1&&jt,Ye=!nh(G);let en;if(Ye&&(en=bt&&bt.onVnodeBeforeUnmount)&&_o(en,K,G),ce&6)Ro(G.component,it,gt);else{if(ce&128){G.suspense.unmount(it,gt);return}je&&Nc(G,null,K,"beforeUnmount"),ce&64?G.type.remove(G,K,it,$t,gt):Ct&&!Ct.hasOnce&&(Et!==mo||Ft>0&&Ft&64)?or(Ct,K,it,!1,!0):(Et===mo&&Ft&384||!St&&ce&16)&&or(Nt,K,it),gt&&ps(G)}(Ye&&(en=bt&&bt.onVnodeUnmounted)||je)&&xr(()=>{en&&_o(en,K,G),je&&Nc(G,null,K,"unmounted")},it)},ps=G=>{const{type:K,el:it,anchor:gt,transition:St}=G;if(K===mo){Hi(it,gt);return}if(K===gR){Xt(G);return}const Et=()=>{y(it),St&&!St.persisted&&St.afterLeave&&St.afterLeave()};if(G.shapeFlag&1&&St&&!St.persisted){const{leave:bt,delayLeave:It}=St,Nt=()=>bt(it,Et);It?It(G.el,Et,Nt):Nt()}else Et()},Hi=(G,K)=>{let it;for(;G!==K;)it=Z(G),y(G),G=it;y(K)},Ro=(G,K,it)=>{const{bum:gt,scope:St,job:Et,subTree:bt,um:It,m:Nt,a:Ct}=G;YM(Nt),YM(Ct),gt&&uR(gt),St.stop(),Et&&(Et.flags|=8,Wn(bt,G,K,it)),It&&xr(It,K),xr(()=>{G.isUnmounted=!0},K)},or=(G,K,it,gt=!1,St=!1,Et=0)=>{for(let bt=Et;bt<G.length;bt++)Wn(G[bt],K,it,gt,St)},mt=G=>{if(G.shapeFlag&6)return mt(G.component.subTree);if(G.shapeFlag&128)return G.suspense.next();const K=Z(G.anchor||G.el),it=K&&K[i9];return it?Z(it):K};let Kt=!1;const kt=(G,K,it)=>{G==null?K._vnode&&Wn(K._vnode,null,null,!0):Yt(K._vnode||null,G,K,null,null,null,it),K._vnode=G,Kt||(Kt=!0,FM(),dU(),Kt=!1)},$t={p:Yt,um:Wn,m:Gr,r:ps,mt:zn,mc:Fr,pc:ze,pbc:Pi,n:mt,o:u};return{render:kt,hydrate:void 0,createApp:b9(kt)}}function ER({type:u,props:_},E){return E==="svg"&&u==="foreignObject"||E==="mathml"&&u==="annotation-xml"&&_&&_.encoding&&_.encoding.includes("html")?void 0:E}function Dc({effect:u,job:_},E){E?(u.flags|=32,_.flags|=4):(u.flags&=-33,_.flags&=-5)}function M9(u,_){return(!u||u&&!u.pendingBranch)&&_&&!_.persisted}function AU(u,_,E=!1){const C=u.children,y=_.children;if(be(C)&&be(y))for(let O=0;O<C.length;O++){const M=C[O];let V=y[O];V.shapeFlag&1&&!V.dynamicChildren&&((V.patchFlag<=0||V.patchFlag===32)&&(V=y[O]=wa(y[O]),V.el=M.el),!E&&V.patchFlag!==-2&&AU(M,V)),V.type===jf&&V.patchFlag!==-1&&(V.el=M.el),V.type===fl&&!V.el&&(V.el=M.el)}}function U9(u){const _=u.slice(),E=[0];let C,y,O,M,V;const F=u.length;for(C=0;C<F;C++){const z=u[C];if(z!==0){if(y=E[E.length-1],u[y]<z){_[C]=y,E.push(C);continue}for(O=0,M=E.length-1;O<M;)V=O+M>>1,u[E[V]]<z?O=V+1:M=V;z<u[E[O]]&&(O>0&&(_[C]=E[O-1]),E[O]=C)}}for(O=E.length,M=E[O-1];O-- >0;)E[O]=M,M=_[M];return E}function wU(u){const _=u.subTree.component;if(_)return _.asyncDep&&!_.asyncResolved?_:wU(_)}function YM(u){if(u)for(let _=0;_<u.length;_++)u[_].flags|=8}const x9=Symbol.for("v-scx"),V9=()=>Wo(x9);function Tf(u,_,E){return OU(u,_,E)}function OU(u,_,E=wn){const{immediate:C,deep:y,flush:O,once:M}=E,V=Gi({},E),F=_&&C||!_&&O!=="post";let z;if(lh){if(O==="sync"){const ct=V9();z=ct.__watcherHandles||(ct.__watcherHandles=[])}else if(!F){const ct=()=>{};return ct.stop=So,ct.resume=So,ct.pause=So,ct}}const Y=rr;V.call=(ct,vt,Yt)=>To(ct,Y,vt,Yt);let W=!1;O==="post"?V.scheduler=ct=>{xr(ct,Y&&Y.suspense)}:O!=="sync"&&(W=!0,V.scheduler=(ct,vt)=>{vt?ct():rv(ct)}),V.augmentJob=ct=>{_&&(ct.flags|=4),W&&(ct.flags|=2,Y&&(ct.id=Y.uid,ct.i=Y))};const Z=$X(u,_,V);return lh&&(z?z.push(Z):F&&Z()),Z}function F9(u,_,E){const C=this.proxy,y=hi(u)?u.includes(".")?NU(C,u):()=>C[u]:u.bind(C,C);let O;Me(_)?O=_:(O=_.handler,E=_);const M=_h(this),V=OU(y,O.bind(C),E);return M(),V}function NU(u,_){const E=_.split(".");return()=>{let C=u;for(let y=0;y<E.length&&C;y++)C=C[E[y]];return C}}const B9=(u,_)=>_==="modelValue"||_==="model-value"?u.modelModifiers:u[`${_}Modifiers`]||u[`${Pa(_)}Modifiers`]||u[`${xc(_)}Modifiers`];function j9(u,_,...E){if(u.isUnmounted)return;const C=u.vnode.props||wn;let y=E;const O=_.startsWith("update:"),M=O&&B9(C,_.slice(7));M&&(M.trim&&(y=E.map(Y=>hi(Y)?Y.trim():Y)),M.number&&(y=E.map(TX)));let V,F=C[V=lR(_)]||C[V=lR(Pa(_))];!F&&O&&(F=C[V=lR(xc(_))]),F&&To(F,u,6,y);const z=C[V+"Once"];if(z){if(!u.emitted)u.emitted={};else if(u.emitted[V])return;u.emitted[V]=!0,To(z,u,6,y)}}const G9=new WeakMap;function DU(u,_,E=!1){const C=E?G9:_.emitsCache,y=C.get(u);if(y!==void 0)return y;const O=u.emits;let M={},V=!1;if(!Me(u)){const F=z=>{const Y=DU(z,_,!0);Y&&(V=!0,Gi(M,Y))};!E&&_.mixins.length&&_.mixins.forEach(F),u.extends&&F(u.extends),u.mixins&&u.mixins.forEach(F)}return!O&&!V?(jn(u)&&C.set(u,null),null):(be(O)?O.forEach(F=>M[F]=null):Gi(M,O),jn(u)&&C.set(u,M),M)}function Bf(u,_){return!u||!Lf(_)?!1:(_=_.slice(2).replace(/Once$/,""),hn(u,_[0].toLowerCase()+_.slice(1))||hn(u,xc(_))||hn(u,_))}function qM(u){const{type:_,vnode:E,proxy:C,withProxy:y,propsOptions:[O],slots:M,attrs:V,emit:F,render:z,renderCache:Y,props:W,data:Z,setupState:ct,ctx:vt,inheritAttrs:Yt}=u,Ae=Af(u);let ne,zt;try{if(E.shapeFlag&4){const Xt=y||C,pn=Xt;ne=Eo(z.call(pn,Xt,Y,W,ct,Z,vt)),zt=V}else{const Xt=_;ne=Eo(Xt.length>1?Xt(W,{attrs:V,slots:M,emit:F}):Xt(W,null)),zt=_.props?V:W9(V)}}catch(Xt){rh.length=0,Vf(Xt,u,1),ne=sr(fl)}let ie=ne;if(zt&&Yt!==!1){const Xt=Object.keys(zt),{shapeFlag:pn}=ie;Xt.length&&pn&7&&(O&&Xt.some(KR)&&(zt=H9(zt,O)),ie=ml(ie,zt,!1,!0))}return E.dirs&&(ie=ml(ie,null,!1,!0),ie.dirs=ie.dirs?ie.dirs.concat(E.dirs):E.dirs),E.transition&&sv(ie,E.transition),ne=ie,Af(Ae),ne}const W9=u=>{let _;for(const E in u)(E==="class"||E==="style"||Lf(E))&&((_||(_={}))[E]=u[E]);return _},H9=(u,_)=>{const E={};for(const C in u)(!KR(C)||!(C.slice(9)in _))&&(E[C]=u[C]);return E};function K9(u,_,E){const{props:C,children:y,component:O}=u,{props:M,children:V,patchFlag:F}=_,z=O.emitsOptions;if(_.dirs||_.transition)return!0;if(E&&F>=0){if(F&1024)return!0;if(F&16)return C?zM(C,M,z):!!M;if(F&8){const Y=_.dynamicProps;for(let W=0;W<Y.length;W++){const Z=Y[W];if(M[Z]!==C[Z]&&!Bf(z,Z))return!0}}}else return(y||V)&&(!V||!V.$stable)?!0:C===M?!1:C?M?zM(C,M,z):!0:!!M;return!1}function zM(u,_,E){const C=Object.keys(_);if(C.length!==Object.keys(u).length)return!0;for(let y=0;y<C.length;y++){const O=C[y];if(_[O]!==u[O]&&!Bf(E,O))return!0}return!1}function Y9({vnode:u,parent:_},E){for(;_;){const C=_.subTree;if(C.suspense&&C.suspense.activeBranch===u&&(C.el=u.el),C===u)(u=_.vnode).el=E,_=_.parent;else break}}const PU=u=>u.__isSuspense;function q9(u,_){_&&_.pendingBranch?be(u)?_.effects.push(...u):_.effects.push(u):n9(u)}const mo=Symbol.for("v-fgt"),jf=Symbol.for("v-txt"),fl=Symbol.for("v-cmt"),gR=Symbol.for("v-stc"),rh=[];let Vr=null;function cv(u=!1){rh.push(Vr=u?null:[])}function z9(){rh.pop(),Vr=rh[rh.length-1]||null}let dh=1;function Nf(u,_=!1){dh+=u,u<0&&Vr&&_&&(Vr.hasOnce=!0)}function X9(u){return u.dynamicChildren=dh>0?Vr||ll:null,z9(),dh>0&&Vr&&Vr.push(u),u}function dv(u,_,E,C,y,O){return X9(ir(u,_,E,C,y,O,!0))}function Df(u){return u?u.__v_isVNode===!0:!1}function qu(u,_){return u.type===_.type&&u.key===_.key}const LU=({key:u})=>u??null,Rf=({ref:u,ref_key:_,ref_for:E})=>(typeof u=="number"&&(u=""+u),u!=null?hi(u)||ji(u)||Me(u)?{i:go,r:u,k:_,f:!!E}:u:null);function ir(u,_=null,E=null,C=0,y=null,O=u===mo?0:1,M=!1,V=!1){const F={__v_isVNode:!0,__v_skip:!0,type:u,props:_,key:_&&LU(_),ref:_&&Rf(_),scopeId:uU,slotScopeIds:null,children:E,component:null,suspense:null,ssContent:null,ssFallback:null,dirs:null,transition:null,el:null,anchor:null,target:null,targetStart:null,targetAnchor:null,staticCount:0,shapeFlag:O,patchFlag:C,dynamicProps:y,dynamicChildren:null,appContext:null,ctx:go};return V?(lv(F,E),O&128&&u.normalize(F)):E&&(F.shapeFlag|=hi(E)?8:16),dh>0&&!M&&Vr&&(F.patchFlag>0||O&6)&&F.patchFlag!==32&&Vr.push(F),F}const sr=J9;function J9(u,_=null,E=null,C=0,y=null,O=!1){if((!u||u===g9)&&(u=fl),Df(u)){const V=ml(u,_,!0);return E&&lv(V,E),dh>0&&!O&&Vr&&(V.shapeFlag&6?Vr[Vr.indexOf(u)]=V:Vr.push(V)),V.patchFlag=-2,V}if(aJ(u)&&(u=u.__vccOpts),_){_=Q9(_);let{class:V,style:F}=_;V&&!hi(V)&&(_.class=XR(V)),jn(F)&&(iv(F)&&!be(F)&&(F=Gi({},F)),_.style=zR(F))}const M=hi(u)?1:PU(u)?128:r9(u)?64:jn(u)?4:Me(u)?2:0;return ir(u,_,E,C,y,M,O,!0)}function Q9(u){return u?iv(u)||RU(u)?Gi({},u):u:null}function ml(u,_,E=!1,C=!1){const{props:y,ref:O,patchFlag:M,children:V,transition:F}=u,z=_?Z9(y||{},_):y,Y={__v_isVNode:!0,__v_skip:!0,type:u.type,props:z,key:z&&LU(z),ref:_&&_.ref?E&&O?be(O)?O.concat(Rf(_)):[O,Rf(_)]:Rf(_):O,scopeId:u.scopeId,slotScopeIds:u.slotScopeIds,children:V,target:u.target,targetStart:u.targetStart,targetAnchor:u.targetAnchor,staticCount:u.staticCount,shapeFlag:u.shapeFlag,patchFlag:_&&u.type!==mo?M===-1?16:M|16:M,dynamicProps:u.dynamicProps,dynamicChildren:u.dynamicChildren,appContext:u.appContext,dirs:u.dirs,transition:F,component:u.component,suspense:u.suspense,ssContent:u.ssContent&&ml(u.ssContent),ssFallback:u.ssFallback&&ml(u.ssFallback),placeholder:u.placeholder,el:u.el,anchor:u.anchor,ctx:u.ctx,ce:u.ce};return F&&C&&sv(Y,F.clone(Y)),Y}function _l(u=" ",_=0){return sr(jf,null,u,_)}function Eo(u){return u==null||typeof u=="boolean"?sr(fl):be(u)?sr(mo,null,u.slice()):Df(u)?wa(u):sr(jf,null,String(u))}function wa(u){return u.el===null&&u.patchFlag!==-1||u.memo?u:ml(u)}function lv(u,_){let E=0;const{shapeFlag:C}=u;if(_==null)_=null;else if(be(_))E=16;else if(typeof _=="object")if(C&65){const y=_.default;y&&(y._c&&(y._d=!1),lv(u,y()),y._c&&(y._d=!0));return}else{E=32;const y=_._;!y&&!RU(_)?_._ctx=go:y===3&&go&&(go.slots._===1?_._=1:(_._=2,u.patchFlag|=1024))}else Me(_)?(_={default:_,_ctx:go},E=32):(_=String(_),C&64?(E=16,_=[_l(_)]):E=8);u.children=_,u.shapeFlag|=E}function Z9(...u){const _={};for(let E=0;E<u.length;E++){const C=u[E];for(const y in C)if(y==="class")_.class!==C.class&&(_.class=XR([_.class,C.class]));else if(y==="style")_.style=zR([_.style,C.style]);else if(Lf(y)){const O=_[y],M=C[y];M&&O!==M&&!(be(O)&&O.includes(M))&&(_[y]=O?[].concat(O,M):M)}else y!==""&&(_[y]=C[y])}return _}function _o(u,_,E,C=null){To(u,_,7,[E,C])}const $9=gU();let tJ=0;function eJ(u,_,E){const C=u.type,y=(_?_.appContext:u.appContext)||$9,O={uid:tJ++,vnode:u,type:C,parent:_,appContext:y,root:null,next:null,subTree:null,effect:null,update:null,job:null,scope:new B1(!0),render:null,proxy:null,exposed:null,exposeProxy:null,withProxy:null,provides:_?_.provides:Object.create(y.provides),ids:_?_.ids:["",0,0],accessCache:null,renderCache:[],components:null,directives:null,propsOptions:CU(C,y),emitsOptions:DU(C,y),emit:null,emitted:null,propsDefaults:wn,inheritAttrs:C.inheritAttrs,ctx:wn,data:wn,props:wn,attrs:wn,slots:wn,refs:wn,setupState:wn,setupContext:null,suspense:E,suspenseId:E?E.pendingId:0,asyncDep:null,asyncResolved:!1,isMounted:!1,isUnmounted:!1,isDeactivated:!1,bc:null,c:null,bm:null,m:null,bu:null,u:null,um:null,bum:null,da:null,a:null,rtg:null,rtc:null,ec:null,sp:null};return O.ctx={_:O},O.root=_?_.root:O,O.emit=j9.bind(null,O),u.ce&&u.ce(O),O}let rr=null;const nJ=()=>rr||go;let Pf,xR;{const u=Uf(),_=(E,C)=>{let y;return(y=u[E])||(y=u[E]=[]),y.push(C),O=>{y.length>1?y.forEach(M=>M(O)):y[0](O)}};Pf=_("__VUE_INSTANCE_SETTERS__",E=>rr=E),xR=_("__VUE_SSR_SETTERS__",E=>lh=E)}const _h=u=>{const _=rr;return Pf(u),u.scope.on(),()=>{u.scope.off(),Pf(_)}},XM=()=>{rr&&rr.scope.off(),Pf(null)};function kU(u){return u.vnode.shapeFlag&4}let lh=!1;function iJ(u,_=!1,E=!1){_&&xR(_);const{props:C,children:y}=u.vnode,O=kU(u);A9(u,C,O,_),D9(u,y,E||_);const M=O?rJ(u,_):void 0;return _&&xR(!1),M}function rJ(u,_){const E=u.type;u.accessCache=Object.create(null),u.proxy=new Proxy(u.ctx,S9);const{setup:C}=E;if(C){Ho();const y=u.setupContext=C.length>1?oJ(u):null,O=_h(u),M=hh(C,u,0,[u.props,y]),V=D1(M);if(Ko(),O(),(V||u.sp)&&!nh(u)&&hU(u),V){if(M.then(XM,XM),_)return M.then(F=>{JM(u,F)}).catch(F=>{Vf(F,u,0)});u.asyncDep=M}else JM(u,M)}else MU(u)}function JM(u,_,E){Me(_)?u.type.__ssrInlineRender?u.ssrRender=_:u.render=_:jn(_)&&(u.setupState=sU(_)),MU(u)}function MU(u,_,E){const C=u.type;u.render||(u.render=C.render||So);{const y=_h(u);Ho();try{T9(u)}finally{Ko(),y()}}}const sJ={get(u,_){return Bi(u,"get",""),u[_]}};function oJ(u){const _=E=>{u.exposed=E||{}};return{attrs:new Proxy(u.attrs,sJ),slots:u.slots,emit:u.emit,expose:_}}function uv(u){return u.exposed?u.exposeProxy||(u.exposeProxy=new Proxy(sU(nU(u.exposed)),{get(_,E){if(E in _)return _[E];if(E in ih)return ih[E](u)},has(_,E){return E in _||E in ih}})):u.proxy}function aJ(u){return Me(u)&&"__vccOpts"in u}const xs=(u,_)=>QX(u,_,lh);function UU(u,_,E){try{Nf(-1);const C=arguments.length;return C===2?jn(_)&&!be(_)?Df(_)?sr(u,null,[_]):sr(u,_):sr(u,null,_):(C>3?E=Array.prototype.slice.call(arguments,2):C===3&&Df(E)&&(E=[E]),sr(u,_,E))}finally{Nf(1)}}const cJ="3.5.24";let VR;const QM=typeof window<"u"&&window.trustedTypes;if(QM)try{VR=QM.createPolicy("vue",{createHTML:u=>u})}catch{}const xU=VR?u=>VR.createHTML(u):u=>u,dJ="http://www.w3.org/2000/svg",lJ="http://www.w3.org/1998/Math/MathML",Bo=typeof document<"u"?document:null,ZM=Bo&&Bo.createElement("template"),uJ={insert:(u,_,E)=>{_.insertBefore(u,E||null)},remove:u=>{const _=u.parentNode;_&&_.removeChild(u)},createElement:(u,_,E,C)=>{const y=_==="svg"?Bo.createElementNS(dJ,u):_==="mathml"?Bo.createElementNS(lJ,u):E?Bo.createElement(u,{is:E}):Bo.createElement(u);return u==="select"&&C&&C.multiple!=null&&y.setAttribute("multiple",C.multiple),y},createText:u=>Bo.createTextNode(u),createComment:u=>Bo.createComment(u),setText:(u,_)=>{u.nodeValue=_},setElementText:(u,_)=>{u.textContent=_},parentNode:u=>u.parentNode,nextSibling:u=>u.nextSibling,querySelector:u=>Bo.querySelector(u),setScopeId(u,_){u.setAttribute(_,"")},insertStaticContent(u,_,E,C,y,O){const M=E?E.previousSibling:_.lastChild;if(y&&(y===O||y.nextSibling))for(;_.insertBefore(y.cloneNode(!0),E),!(y===O||!(y=y.nextSibling)););else{ZM.innerHTML=xU(C==="svg"?`<svg>${u}</svg>`:C==="mathml"?`<math>${u}</math>`:u);const V=ZM.content;if(C==="svg"||C==="mathml"){const F=V.firstChild;for(;F.firstChild;)V.appendChild(F.firstChild);V.removeChild(F)}_.insertBefore(V,E)}return[M?M.nextSibling:_.firstChild,E?E.previousSibling:_.lastChild]}},hJ=Symbol("_vtc");function pJ(u,_,E){const C=u[hJ];C&&(_=(_?[_,...C]:[...C]).join(" ")),_==null?u.removeAttribute("class"):E?u.setAttribute("class",_):u.className=_}const $M=Symbol("_vod"),_J=Symbol("_vsh"),fJ=Symbol(""),mJ=/(?:^|;)\s*display\s*:/;function EJ(u,_,E){const C=u.style,y=hi(E);let O=!1;if(E&&!y){if(_)if(hi(_))for(const M of _.split(";")){const V=M.slice(0,M.indexOf(":")).trim();E[V]==null&&vf(C,V,"")}else for(const M in _)E[M]==null&&vf(C,M,"");for(const M in E)M==="display"&&(O=!0),vf(C,M,E[M])}else if(y){if(_!==E){const M=C[fJ];M&&(E+=";"+M),C.cssText=E,O=mJ.test(E)}}else _&&u.removeAttribute("style");$M in u&&(u[$M]=O?C.display:"",u[_J]&&(C.display="none"))}const t1=/\s*!important$/;function vf(u,_,E){if(be(E))E.forEach(C=>vf(u,_,C));else if(E==null&&(E=""),_.startsWith("--"))u.setProperty(_,E);else{const C=gJ(u,_);t1.test(E)?u.setProperty(xc(C),E.replace(t1,""),"important"):u[C]=E}}const e1=["Webkit","Moz","ms"],SR={};function gJ(u,_){const E=SR[_];if(E)return E;let C=Pa(_);if(C!=="filter"&&C in u)return SR[_]=C;C=k1(C);for(let y=0;y<e1.length;y++){const O=e1[y]+C;if(O in u)return SR[_]=O}return _}const n1="http://www.w3.org/1999/xlink";function i1(u,_,E,C,y,O=bX(_)){C&&_.startsWith("xlink:")?E==null?u.removeAttributeNS(n1,_.slice(6,_.length)):u.setAttributeNS(n1,_,E):E==null||O&&!U1(E)?u.removeAttribute(_):u.setAttribute(_,O?"":La(E)?String(E):E)}function r1(u,_,E,C,y){if(_==="innerHTML"||_==="textContent"){E!=null&&(u[_]=_==="innerHTML"?xU(E):E);return}const O=u.tagName;if(_==="value"&&O!=="PROGRESS"&&!O.includes("-")){const V=O==="OPTION"?u.getAttribute("value")||"":u.value,F=E==null?u.type==="checkbox"?"on":"":String(E);(V!==F||!("_value"in u))&&(u.value=F),E==null&&u.removeAttribute(_),u._value=E;return}let M=!1;if(E===""||E==null){const V=typeof u[_];V==="boolean"?E=U1(E):E==null&&V==="string"?(E="",M=!0):V==="number"&&(E=0,M=!0)}try{u[_]=E}catch{}M&&u.removeAttribute(y||_)}function SJ(u,_,E,C){u.addEventListener(_,E,C)}function TJ(u,_,E,C){u.removeEventListener(_,E,C)}const s1=Symbol("_vei");function RJ(u,_,E,C,y=null){const O=u[s1]||(u[s1]={}),M=O[_];if(C&&M)M.value=C;else{const[V,F]=vJ(_);if(C){const z=O[_]=IJ(C,y);SJ(u,V,z,F)}else M&&(TJ(u,V,M,F),O[_]=void 0)}}const o1=/(?:Once|Passive|Capture)$/;function vJ(u){let _;if(o1.test(u)){_={};let C;for(;C=u.match(o1);)u=u.slice(0,u.length-C[0].length),_[C[0].toLowerCase()]=!0}return[u[2]===":"?u.slice(3):xc(u.slice(2)),_]}let TR=0;const CJ=Promise.resolve(),yJ=()=>TR||(CJ.then(()=>TR=0),TR=Date.now());function IJ(u,_){const E=C=>{if(!C._vts)C._vts=Date.now();else if(C._vts<=E.attached)return;To(bJ(C,E.value),_,5,[C])};return E.value=u,E.attached=yJ(),E}function bJ(u,_){if(be(_)){const E=u.stopImmediatePropagation;return u.stopImmediatePropagation=()=>{E.call(u),u._stopped=!0},_.map(C=>y=>!y._stopped&&C&&C(y))}else return _}const a1=u=>u.charCodeAt(0)===111&&u.charCodeAt(1)===110&&u.charCodeAt(2)>96&&u.charCodeAt(2)<123,AJ=(u,_,E,C,y,O)=>{const M=y==="svg";_==="class"?pJ(u,C,M):_==="style"?EJ(u,E,C):Lf(_)?KR(_)||RJ(u,_,E,C,O):(_[0]==="."?(_=_.slice(1),!0):_[0]==="^"?(_=_.slice(1),!1):wJ(u,_,C,M))?(r1(u,_,C),!u.tagName.includes("-")&&(_==="value"||_==="checked"||_==="selected")&&i1(u,_,C,M,O,_!=="value")):u._isVueCE&&(/[A-Z]/.test(_)||!hi(C))?r1(u,Pa(_),C,O,_):(_==="true-value"?u._trueValue=C:_==="false-value"&&(u._falseValue=C),i1(u,_,C,M))};function wJ(u,_,E,C){if(C)return!!(_==="innerHTML"||_==="textContent"||_ in u&&a1(_)&&Me(E));if(_==="spellcheck"||_==="draggable"||_==="translate"||_==="autocorrect"||_==="sandbox"&&u.tagName==="IFRAME"||_==="form"||_==="list"&&u.tagName==="INPUT"||_==="type"&&u.tagName==="TEXTAREA")return!1;if(_==="width"||_==="height"){const y=u.tagName;if(y==="IMG"||y==="VIDEO"||y==="CANVAS"||y==="SOURCE")return!1}return a1(_)&&hi(E)?!1:_ in u}const OJ=Gi({patchProp:AJ},uJ);let c1;function NJ(){return c1||(c1=L9(OJ))}const DJ=((...u)=>{const _=NJ().createApp(...u),{mount:E}=_;return _.mount=C=>{const y=LJ(C);if(!y)return;const O=_._component;!Me(O)&&!O.render&&!O.template&&(O.template=y.innerHTML),y.nodeType===1&&(y.textContent="");const M=E(y,!1,PJ(y));return y instanceof Element&&(y.removeAttribute("v-cloak"),y.setAttribute("data-v-app","")),M},_});function PJ(u){if(u instanceof SVGElement)return"svg";if(typeof MathMLElement=="function"&&u instanceof MathMLElement)return"mathml"}function LJ(u){return hi(u)?document.querySelector(u):u}const kJ=Symbol();var d1;(function(u){u.direct="direct",u.patchObject="patch object",u.patchFunction="patch function"})(d1||(d1={}));function MJ(){const u=AX(!0),_=u.run(()=>iU({}));let E=[],C=[];const y=nU({install(O){y._a=O,O.provide(kJ,y),O.config.globalProperties.$pinia=y,C.forEach(M=>E.push(M)),C=[]},use(O){return this._a?E.push(O):C.push(O),this},_p:E,_a:null,_e:u,_s:new Map,state:_});return y}const UJ="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20261.76%20226.69'%3e%3cpath%20d='M161.096.001l-30.225%2052.351L100.647.001H-.005l130.877%20226.688L261.749.001z'%20fill='%2341b883'/%3e%3cpath%20d='M161.096.001l-30.225%2052.351L100.647.001H52.346l78.526%20136.01L209.398.001z'%20fill='%2334495e'/%3e%3c/svg%3e";const al=typeof document<"u";function VU(u){return typeof u=="object"||"displayName"in u||"props"in u||"__vccOpts"in u}function xJ(u){return u.__esModule||u[Symbol.toStringTag]==="Module"||u.default&&VU(u.default)}const ln=Object.assign;function RR(u,_){const E={};for(const C in _){const y=_[C];E[C]=Bs(y)?y.map(u):u(y)}return E}const sh=()=>{},Bs=Array.isArray;function l1(u,_){const E={};for(const C in u)E[C]=C in _?_[C]:u[C];return E}const FU=/#/g,VJ=/&/g,FJ=/\//g,BJ=/=/g,jJ=/\?/g,BU=/\+/g,GJ=/%5B/g,WJ=/%5D/g,jU=/%5E/g,HJ=/%60/g,GU=/%7B/g,KJ=/%7C/g,WU=/%7D/g,YJ=/%20/g;function hv(u){return u==null?"":encodeURI(""+u).replace(KJ,"|").replace(GJ,"[").replace(WJ,"]")}function qJ(u){return hv(u).replace(GU,"{").replace(WU,"}").replace(jU,"^")}function FR(u){return hv(u).replace(BU,"%2B").replace(YJ,"+").replace(FU,"%23").replace(VJ,"%26").replace(HJ,"`").replace(GU,"{").replace(WU,"}").replace(jU,"^")}function zJ(u){return FR(u).replace(BJ,"%3D")}function XJ(u){return hv(u).replace(FU,"%23").replace(jJ,"%3F")}function JJ(u){return XJ(u).replace(FJ,"%2F")}function uh(u){if(u==null)return null;try{return decodeURIComponent(""+u)}catch{}return""+u}const QJ=/\/$/,ZJ=u=>u.replace(QJ,"");function vR(u,_,E="/"){let C,y={},O="",M="";const V=_.indexOf("#");let F=_.indexOf("?");return F=V>=0&&F>V?-1:F,F>=0&&(C=_.slice(0,F),O=_.slice(F,V>0?V:_.length),y=u(O.slice(1))),V>=0&&(C=C||_.slice(0,V),M=_.slice(V,_.length)),C=n7(C??_,E),{fullPath:C+O+M,path:C,query:y,hash:uh(M)}}function $J(u,_){const E=_.query?u(_.query):"";return _.path+(E&&"?")+E+(_.hash||"")}function u1(u,_){return!_||!u.toLowerCase().startsWith(_.toLowerCase())?u:u.slice(_.length)||"/"}function t7(u,_,E){const C=_.matched.length-1,y=E.matched.length-1;return C>-1&&C===y&&El(_.matched[C],E.matched[y])&&HU(_.params,E.params)&&u(_.query)===u(E.query)&&_.hash===E.hash}function El(u,_){return(u.aliasOf||u)===(_.aliasOf||_)}function HU(u,_){if(Object.keys(u).length!==Object.keys(_).length)return!1;for(const E in u)if(!e7(u[E],_[E]))return!1;return!0}function e7(u,_){return Bs(u)?h1(u,_):Bs(_)?h1(_,u):u===_}function h1(u,_){return Bs(_)?u.length===_.length&&u.every((E,C)=>E===_[C]):u.length===1&&u[0]===_}function n7(u,_){if(u.startsWith("/"))return u;if(!u)return _;const E=_.split("/"),C=u.split("/"),y=C[C.length-1];(y===".."||y===".")&&C.push("");let O=E.length-1,M,V;for(M=0;M<C.length;M++)if(V=C[M],V!==".")if(V==="..")O>1&&O--;else break;return E.slice(0,O).join("/")+"/"+C.slice(M).join("/")}const ba={path:"/",name:void 0,params:{},query:{},hash:"",fullPath:"/",matched:[],meta:{},redirectedFrom:void 0};let BR=(function(u){return u.pop="pop",u.push="push",u})({}),CR=(function(u){return u.back="back",u.forward="forward",u.unknown="",u})({});function i7(u){if(!u)if(al){const _=document.querySelector("base");u=_&&_.getAttribute("href")||"/",u=u.replace(/^\w+:\/\/[^\/]+/,"")}else u="/";return u[0]!=="/"&&u[0]!=="#"&&(u="/"+u),ZJ(u)}const r7=/^[^#]+#/;function s7(u,_){return u.replace(r7,"#")+_}function o7(u,_){const E=document.documentElement.getBoundingClientRect(),C=u.getBoundingClientRect();return{behavior:_.behavior,left:C.left-E.left-(_.left||0),top:C.top-E.top-(_.top||0)}}const Gf=()=>({left:window.scrollX,top:window.scrollY});function a7(u){let _;if("el"in u){const E=u.el,C=typeof E=="string"&&E.startsWith("#"),y=typeof E=="string"?C?document.getElementById(E.slice(1)):document.querySelector(E):E;if(!y)return;_=o7(y,u)}else _=u;"scrollBehavior"in document.documentElement.style?window.scrollTo(_):window.scrollTo(_.left!=null?_.left:window.scrollX,_.top!=null?_.top:window.scrollY)}function p1(u,_){return(history.state?history.state.position-_:-1)+u}const jR=new Map;function c7(u,_){jR.set(u,_)}function d7(u){const _=jR.get(u);return jR.delete(u),_}function l7(u){return typeof u=="string"||u&&typeof u=="object"}function KU(u){return typeof u=="string"||typeof u=="symbol"}let $n=(function(u){return u[u.MATCHER_NOT_FOUND=1]="MATCHER_NOT_FOUND",u[u.NAVIGATION_GUARD_REDIRECT=2]="NAVIGATION_GUARD_REDIRECT",u[u.NAVIGATION_ABORTED=4]="NAVIGATION_ABORTED",u[u.NAVIGATION_CANCELLED=8]="NAVIGATION_CANCELLED",u[u.NAVIGATION_DUPLICATED=16]="NAVIGATION_DUPLICATED",u})({});const YU=Symbol("");$n.MATCHER_NOT_FOUND+"",$n.NAVIGATION_GUARD_REDIRECT+"",$n.NAVIGATION_ABORTED+"",$n.NAVIGATION_CANCELLED+"",$n.NAVIGATION_DUPLICATED+"";function gl(u,_){return ln(new Error,{type:u,[YU]:!0},_)}function Fo(u,_){return u instanceof Error&&YU in u&&(_==null||!!(u.type&_))}const u7=["params","query","hash"];function h7(u){if(typeof u=="string")return u;if(u.path!=null)return u.path;const _={};for(const E of u7)E in u&&(_[E]=u[E]);return JSON.stringify(_,null,2)}function p7(u){const _={};if(u===""||u==="?")return _;const E=(u[0]==="?"?u.slice(1):u).split("&");for(let C=0;C<E.length;++C){const y=E[C].replace(BU," "),O=y.indexOf("="),M=uh(O<0?y:y.slice(0,O)),V=O<0?null:uh(y.slice(O+1));if(M in _){let F=_[M];Bs(F)||(F=_[M]=[F]),F.push(V)}else _[M]=V}return _}function _1(u){let _="";for(let E in u){const C=u[E];if(E=zJ(E),C==null){C!==void 0&&(_+=(_.length?"&":"")+E);continue}(Bs(C)?C.map(y=>y&&FR(y)):[C&&FR(C)]).forEach(y=>{y!==void 0&&(_+=(_.length?"&":"")+E,y!=null&&(_+="="+y))})}return _}function _7(u){const _={};for(const E in u){const C=u[E];C!==void 0&&(_[E]=Bs(C)?C.map(y=>y==null?null:""+y):C==null?C:""+C)}return _}const f7=Symbol(""),f1=Symbol(""),pv=Symbol(""),qU=Symbol(""),GR=Symbol("");function zu(){let u=[];function _(C){return u.push(C),()=>{const y=u.indexOf(C);y>-1&&u.splice(y,1)}}function E(){u=[]}return{add:_,list:()=>u.slice(),reset:E}}function Oa(u,_,E,C,y,O=M=>M()){const M=C&&(C.enterCallbacks[y]=C.enterCallbacks[y]||[]);return()=>new Promise((V,F)=>{const z=Z=>{Z===!1?F(gl($n.NAVIGATION_ABORTED,{from:E,to:_})):Z instanceof Error?F(Z):l7(Z)?F(gl($n.NAVIGATION_GUARD_REDIRECT,{from:_,to:Z})):(M&&C.enterCallbacks[y]===M&&typeof Z=="function"&&M.push(Z),V())},Y=O(()=>u.call(C&&C.instances[y],_,E,z));let W=Promise.resolve(Y);u.length<3&&(W=W.then(z)),W.catch(Z=>F(Z))})}function yR(u,_,E,C,y=O=>O()){const O=[];for(const M of u)for(const V in M.components){let F=M.components[V];if(!(_!=="beforeRouteEnter"&&!M.instances[V]))if(VU(F)){const z=(F.__vccOpts||F)[_];z&&O.push(Oa(z,E,C,M,V,y))}else{let z=F();O.push(()=>z.then(Y=>{if(!Y)throw new Error(`Couldn't resolve component "${V}" at "${M.path}"`);const W=xJ(Y)?Y.default:Y;M.mods[V]=Y,M.components[V]=W;const Z=(W.__vccOpts||W)[_];return Z&&Oa(Z,E,C,M,V,y)()}))}}return O}function m7(u,_){const E=[],C=[],y=[],O=Math.max(_.matched.length,u.matched.length);for(let M=0;M<O;M++){const V=_.matched[M];V&&(u.matched.find(z=>El(z,V))?C.push(V):E.push(V));const F=u.matched[M];F&&(_.matched.find(z=>El(z,F))||y.push(F))}return[E,C,y]}let E7=()=>location.protocol+"//"+location.host;function zU(u,_){const{pathname:E,search:C,hash:y}=_,O=u.indexOf("#");if(O>-1){let M=y.includes(u.slice(O))?u.slice(O).length:1,V=y.slice(M);return V[0]!=="/"&&(V="/"+V),u1(V,"")}return u1(E,u)+C+y}function g7(u,_,E,C){let y=[],O=[],M=null;const V=({state:Z})=>{const ct=zU(u,location),vt=E.value,Yt=_.value;let Ae=0;if(Z){if(E.value=ct,_.value=Z,M&&M===vt){M=null;return}Ae=Yt?Z.position-Yt.position:0}else C(ct);y.forEach(ne=>{ne(E.value,vt,{delta:Ae,type:BR.pop,direction:Ae?Ae>0?CR.forward:CR.back:CR.unknown})})};function F(){M=E.value}function z(Z){y.push(Z);const ct=()=>{const vt=y.indexOf(Z);vt>-1&&y.splice(vt,1)};return O.push(ct),ct}function Y(){if(document.visibilityState==="hidden"){const{history:Z}=window;if(!Z.state)return;Z.replaceState(ln({},Z.state,{scroll:Gf()}),"")}}function W(){for(const Z of O)Z();O=[],window.removeEventListener("popstate",V),window.removeEventListener("pagehide",Y),document.removeEventListener("visibilitychange",Y)}return window.addEventListener("popstate",V),window.addEventListener("pagehide",Y),document.addEventListener("visibilitychange",Y),{pauseListeners:F,listen:z,destroy:W}}function m1(u,_,E,C=!1,y=!1){return{back:u,current:_,forward:E,replaced:C,position:window.history.length,scroll:y?Gf():null}}function S7(u){const{history:_,location:E}=window,C={value:zU(u,E)},y={value:_.state};y.value||O(C.value,{back:null,current:C.value,forward:null,position:_.length-1,replaced:!0,scroll:null},!0);function O(F,z,Y){const W=u.indexOf("#"),Z=W>-1?(E.host&&document.querySelector("base")?u:u.slice(W))+F:E7()+u+F;try{_[Y?"replaceState":"pushState"](z,"",Z),y.value=z}catch(ct){console.error(ct),E[Y?"replace":"assign"](Z)}}function M(F,z){O(F,ln({},_.state,m1(y.value.back,F,y.value.forward,!0),z,{position:y.value.position}),!0),C.value=F}function V(F,z){const Y=ln({},y.value,_.state,{forward:F,scroll:Gf()});O(Y.current,Y,!0),O(F,ln({},m1(C.value,F,null),{position:Y.position+1},z),!1),C.value=F}return{location:C,state:y,push:V,replace:M}}function T7(u){u=i7(u);const _=S7(u),E=g7(u,_.state,_.location,_.replace);function C(O,M=!0){M||E.pauseListeners(),history.go(O)}const y=ln({location:"",base:u,go:C,createHref:s7.bind(null,u)},_,E);return Object.defineProperty(y,"location",{enumerable:!0,get:()=>_.location.value}),Object.defineProperty(y,"state",{enumerable:!0,get:()=>_.state.value}),y}let kc=(function(u){return u[u.Static=0]="Static",u[u.Param=1]="Param",u[u.Group=2]="Group",u})({});var ui=(function(u){return u[u.Static=0]="Static",u[u.Param=1]="Param",u[u.ParamRegExp=2]="ParamRegExp",u[u.ParamRegExpEnd=3]="ParamRegExpEnd",u[u.EscapeNext=4]="EscapeNext",u})(ui||{});const R7={type:kc.Static,value:""},v7=/[a-zA-Z0-9_]/;function C7(u){if(!u)return[[]];if(u==="/")return[[R7]];if(!u.startsWith("/"))throw new Error(`Invalid path "${u}"`);function _(ct){throw new Error(`ERR (${E})/"${z}": ${ct}`)}let E=ui.Static,C=E;const y=[];let O;function M(){O&&y.push(O),O=[]}let V=0,F,z="",Y="";function W(){z&&(E===ui.Static?O.push({type:kc.Static,value:z}):E===ui.Param||E===ui.ParamRegExp||E===ui.ParamRegExpEnd?(O.length>1&&(F==="*"||F==="+")&&_(`A repeatable param (${z}) must be alone in its segment. eg: '/:ids+.`),O.push({type:kc.Param,value:z,regexp:Y,repeatable:F==="*"||F==="+",optional:F==="*"||F==="?"})):_("Invalid state to consume buffer"),z="")}function Z(){z+=F}for(;V<u.length;){if(F=u[V++],F==="\\"&&E!==ui.ParamRegExp){C=E,E=ui.EscapeNext;continue}switch(E){case ui.Static:F==="/"?(z&&W(),M()):F===":"?(W(),E=ui.Param):Z();break;case ui.EscapeNext:Z(),E=C;break;case ui.Param:F==="("?E=ui.ParamRegExp:v7.test(F)?Z():(W(),E=ui.Static,F!=="*"&&F!=="?"&&F!=="+"&&V--);break;case ui.ParamRegExp:F===")"?Y[Y.length-1]=="\\"?Y=Y.slice(0,-1)+F:E=ui.ParamRegExpEnd:Y+=F;break;case ui.ParamRegExpEnd:W(),E=ui.Static,F!=="*"&&F!=="?"&&F!=="+"&&V--,Y="";break;default:_("Unknown state");break}}return E===ui.ParamRegExp&&_(`Unfinished custom RegExp for param "${z}"`),W(),M(),y}const E1="[^/]+?",y7={sensitive:!1,strict:!1,start:!0,end:!0};var tr=(function(u){return u[u._multiplier=10]="_multiplier",u[u.Root=90]="Root",u[u.Segment=40]="Segment",u[u.SubSegment=30]="SubSegment",u[u.Static=40]="Static",u[u.Dynamic=20]="Dynamic",u[u.BonusCustomRegExp=10]="BonusCustomRegExp",u[u.BonusWildcard=-50]="BonusWildcard",u[u.BonusRepeatable=-20]="BonusRepeatable",u[u.BonusOptional=-8]="BonusOptional",u[u.BonusStrict=.7000000000000001]="BonusStrict",u[u.BonusCaseSensitive=.25]="BonusCaseSensitive",u})(tr||{});const I7=/[.+*?^${}()[\]/\\]/g;function b7(u,_){const E=ln({},y7,_),C=[];let y=E.start?"^":"";const O=[];for(const z of u){const Y=z.length?[]:[tr.Root];E.strict&&!z.length&&(y+="/");for(let W=0;W<z.length;W++){const Z=z[W];let ct=tr.Segment+(E.sensitive?tr.BonusCaseSensitive:0);if(Z.type===kc.Static)W||(y+="/"),y+=Z.value.replace(I7,"\\$&"),ct+=tr.Static;else if(Z.type===kc.Param){const{value:vt,repeatable:Yt,optional:Ae,regexp:ne}=Z;O.push({name:vt,repeatable:Yt,optional:Ae});const zt=ne||E1;if(zt!==E1){ct+=tr.BonusCustomRegExp;try{`${zt}`}catch(Xt){throw new Error(`Invalid custom RegExp for param "${vt}" (${zt}): `+Xt.message)}}let ie=Yt?`((?:${zt})(?:/(?:${zt}))*)`:`(${zt})`;W||(ie=Ae&&z.length<2?`(?:/${ie})`:"/"+ie),Ae&&(ie+="?"),y+=ie,ct+=tr.Dynamic,Ae&&(ct+=tr.BonusOptional),Yt&&(ct+=tr.BonusRepeatable),zt===".*"&&(ct+=tr.BonusWildcard)}Y.push(ct)}C.push(Y)}if(E.strict&&E.end){const z=C.length-1;C[z][C[z].length-1]+=tr.BonusStrict}E.strict||(y+="/?"),E.end?y+="$":E.strict&&!y.endsWith("/")&&(y+="(?:/|$)");const M=new RegExp(y,E.sensitive?"":"i");function V(z){const Y=z.match(M),W={};if(!Y)return null;for(let Z=1;Z<Y.length;Z++){const ct=Y[Z]||"",vt=O[Z-1];W[vt.name]=ct&&vt.repeatable?ct.split("/"):ct}return W}function F(z){let Y="",W=!1;for(const Z of u){(!W||!Y.endsWith("/"))&&(Y+="/"),W=!1;for(const ct of Z)if(ct.type===kc.Static)Y+=ct.value;else if(ct.type===kc.Param){const{value:vt,repeatable:Yt,optional:Ae}=ct,ne=vt in z?z[vt]:"";if(Bs(ne)&&!Yt)throw new Error(`Provided param "${vt}" is an array but it is not repeatable (* or + modifiers)`);const zt=Bs(ne)?ne.join("/"):ne;if(!zt)if(Ae)Z.length<2&&(Y.endsWith("/")?Y=Y.slice(0,-1):W=!0);else throw new Error(`Missing required param "${vt}"`);Y+=zt}}return Y||"/"}return{re:M,score:C,keys:O,parse:V,stringify:F}}function A7(u,_){let E=0;for(;E<u.length&&E<_.length;){const C=_[E]-u[E];if(C)return C;E++}return u.length<_.length?u.length===1&&u[0]===tr.Static+tr.Segment?-1:1:u.length>_.length?_.length===1&&_[0]===tr.Static+tr.Segment?1:-1:0}function XU(u,_){let E=0;const C=u.score,y=_.score;for(;E<C.length&&E<y.length;){const O=A7(C[E],y[E]);if(O)return O;E++}if(Math.abs(y.length-C.length)===1){if(g1(C))return 1;if(g1(y))return-1}return y.length-C.length}function g1(u){const _=u[u.length-1];return u.length>0&&_[_.length-1]<0}const w7={strict:!1,end:!0,sensitive:!1};function O7(u,_,E){const C=b7(C7(u.path),E),y=ln(C,{record:u,parent:_,children:[],alias:[]});return _&&!y.record.aliasOf==!_.record.aliasOf&&_.children.push(y),y}function N7(u,_){const E=[],C=new Map;_=l1(w7,_);function y(W){return C.get(W)}function O(W,Z,ct){const vt=!ct,Yt=T1(W);Yt.aliasOf=ct&&ct.record;const Ae=l1(_,W),ne=[Yt];if("alias"in W){const Xt=typeof W.alias=="string"?[W.alias]:W.alias;for(const pn of Xt)ne.push(T1(ln({},Yt,{components:ct?ct.record.components:Yt.components,path:pn,aliasOf:ct?ct.record:Yt})))}let zt,ie;for(const Xt of ne){const{path:pn}=Xt;if(Z&&pn[0]!=="/"){const ai=Z.record.path,Je=ai[ai.length-1]==="/"?"":"/";Xt.path=Z.record.path+(pn&&Je+pn)}if(zt=O7(Xt,Z,Ae),ct?ct.alias.push(zt):(ie=ie||zt,ie!==zt&&ie.alias.push(zt),vt&&W.name&&!R1(zt)&&M(W.name)),JU(zt)&&F(zt),Yt.children){const ai=Yt.children;for(let Je=0;Je<ai.length;Je++)O(ai[Je],zt,ct&&ct.children[Je])}ct=ct||zt}return ie?()=>{M(ie)}:sh}function M(W){if(KU(W)){const Z=C.get(W);Z&&(C.delete(W),E.splice(E.indexOf(Z),1),Z.children.forEach(M),Z.alias.forEach(M))}else{const Z=E.indexOf(W);Z>-1&&(E.splice(Z,1),W.record.name&&C.delete(W.record.name),W.children.forEach(M),W.alias.forEach(M))}}function V(){return E}function F(W){const Z=L7(W,E);E.splice(Z,0,W),W.record.name&&!R1(W)&&C.set(W.record.name,W)}function z(W,Z){let ct,vt={},Yt,Ae;if("name"in W&&W.name){if(ct=C.get(W.name),!ct)throw gl($n.MATCHER_NOT_FOUND,{location:W});Ae=ct.record.name,vt=ln(S1(Z.params,ct.keys.filter(ie=>!ie.optional).concat(ct.parent?ct.parent.keys.filter(ie=>ie.optional):[]).map(ie=>ie.name)),W.params&&S1(W.params,ct.keys.map(ie=>ie.name))),Yt=ct.stringify(vt)}else if(W.path!=null)Yt=W.path,ct=E.find(ie=>ie.re.test(Yt)),ct&&(vt=ct.parse(Yt),Ae=ct.record.name);else{if(ct=Z.name?C.get(Z.name):E.find(ie=>ie.re.test(Z.path)),!ct)throw gl($n.MATCHER_NOT_FOUND,{location:W,currentLocation:Z});Ae=ct.record.name,vt=ln({},Z.params,W.params),Yt=ct.stringify(vt)}const ne=[];let zt=ct;for(;zt;)ne.unshift(zt.record),zt=zt.parent;return{name:Ae,path:Yt,params:vt,matched:ne,meta:P7(ne)}}u.forEach(W=>O(W));function Y(){E.length=0,C.clear()}return{addRoute:O,resolve:z,removeRoute:M,clearRoutes:Y,getRoutes:V,getRecordMatcher:y}}function S1(u,_){const E={};for(const C of _)C in u&&(E[C]=u[C]);return E}function T1(u){const _={path:u.path,redirect:u.redirect,name:u.name,meta:u.meta||{},aliasOf:u.aliasOf,beforeEnter:u.beforeEnter,props:D7(u),children:u.children||[],instances:{},leaveGuards:new Set,updateGuards:new Set,enterCallbacks:{},components:"components"in u?u.components||null:u.component&&{default:u.component}};return Object.defineProperty(_,"mods",{value:{}}),_}function D7(u){const _={},E=u.props||!1;if("component"in u)_.default=E;else for(const C in u.components)_[C]=typeof E=="object"?E[C]:E;return _}function R1(u){for(;u;){if(u.record.aliasOf)return!0;u=u.parent}return!1}function P7(u){return u.reduce((_,E)=>ln(_,E.meta),{})}function L7(u,_){let E=0,C=_.length;for(;E!==C;){const O=E+C>>1;XU(u,_[O])<0?C=O:E=O+1}const y=k7(u);return y&&(C=_.lastIndexOf(y,C-1)),C}function k7(u){let _=u;for(;_=_.parent;)if(JU(_)&&XU(u,_)===0)return _}function JU({record:u}){return!!(u.name||u.components&&Object.keys(u.components).length||u.redirect)}function v1(u){const _=Wo(pv),E=Wo(qU),C=xs(()=>{const F=Go(u.to);return _.resolve(F)}),y=xs(()=>{const{matched:F}=C.value,{length:z}=F,Y=F[z-1],W=E.matched;if(!Y||!W.length)return-1;const Z=W.findIndex(El.bind(null,Y));if(Z>-1)return Z;const ct=C1(F[z-2]);return z>1&&C1(Y)===ct&&W[W.length-1].path!==ct?W.findIndex(El.bind(null,F[z-2])):Z}),O=xs(()=>y.value>-1&&V7(E.params,C.value.params)),M=xs(()=>y.value>-1&&y.value===E.matched.length-1&&HU(E.params,C.value.params));function V(F={}){if(x7(F)){const z=_[Go(u.replace)?"replace":"push"](Go(u.to)).catch(sh);return u.viewTransition&&typeof document<"u"&&"startViewTransition"in document&&document.startViewTransition(()=>z),z}return Promise.resolve()}return{route:C,href:xs(()=>C.value.href),isActive:O,isExactActive:M,navigate:V}}function M7(u){return u.length===1?u[0]:u}const U7=ph({name:"RouterLink",compatConfig:{MODE:3},props:{to:{type:[String,Object],required:!0},replace:Boolean,activeClass:String,exactActiveClass:String,custom:Boolean,ariaCurrentValue:{type:String,default:"page"},viewTransition:Boolean},useLink:v1,setup(u,{slots:_}){const E=xf(v1(u)),{options:C}=Wo(pv),y=xs(()=>({[y1(u.activeClass,C.linkActiveClass,"router-link-active")]:E.isActive,[y1(u.exactActiveClass,C.linkExactActiveClass,"router-link-exact-active")]:E.isExactActive}));return()=>{const O=_.default&&M7(_.default(E));return u.custom?O:UU("a",{"aria-current":E.isExactActive?u.ariaCurrentValue:null,href:E.href,onClick:E.navigate,class:y.value},O)}}}),WR=U7;function x7(u){if(!(u.metaKey||u.altKey||u.ctrlKey||u.shiftKey)&&!u.defaultPrevented&&!(u.button!==void 0&&u.button!==0)){if(u.currentTarget&&u.currentTarget.getAttribute){const _=u.currentTarget.getAttribute("target");if(/\b_blank\b/i.test(_))return}return u.preventDefault&&u.preventDefault(),!0}}function V7(u,_){for(const E in _){const C=_[E],y=u[E];if(typeof C=="string"){if(C!==y)return!1}else if(!Bs(y)||y.length!==C.length||C.some((O,M)=>O!==y[M]))return!1}return!0}function C1(u){return u?u.aliasOf?u.aliasOf.path:u.path:""}const y1=(u,_,E)=>u??_??E,F7=ph({name:"RouterView",inheritAttrs:!1,props:{name:{type:String,default:"default"},route:Object},compatConfig:{MODE:3},setup(u,{attrs:_,slots:E}){const C=Wo(GR),y=xs(()=>u.route||C.value),O=Wo(f1,0),M=xs(()=>{let z=Go(O);const{matched:Y}=y.value;let W;for(;(W=Y[z])&&!W.components;)z++;return z}),V=xs(()=>y.value.matched[M.value]);Sf(f1,xs(()=>M.value+1)),Sf(f7,V),Sf(GR,y);const F=iU();return Tf(()=>[F.value,V.value,u.name],([z,Y,W],[Z,ct,vt])=>{Y&&(Y.instances[W]=z,ct&&ct!==Y&&z&&z===Z&&(Y.leaveGuards.size||(Y.leaveGuards=ct.leaveGuards),Y.updateGuards.size||(Y.updateGuards=ct.updateGuards))),z&&Y&&(!ct||!El(Y,ct)||!Z)&&(Y.enterCallbacks[W]||[]).forEach(Yt=>Yt(z))},{flush:"post"}),()=>{const z=y.value,Y=u.name,W=V.value,Z=W&&W.components[Y];if(!Z)return I1(E.default,{Component:Z,route:z});const ct=W.props[Y],vt=ct?ct===!0?z.params:typeof ct=="function"?ct(z):ct:null,Ae=UU(Z,ln({},vt,_,{onVnodeUnmounted:ne=>{ne.component.isUnmounted&&(W.instances[Y]=null)},ref:F}));return I1(E.default,{Component:Ae,route:z})||Ae}}});function I1(u,_){if(!u)return null;const E=u(_);return E.length===1?E[0]:E}const QU=F7;function B7(u){const _=N7(u.routes,u),E=u.parseQuery||p7,C=u.stringifyQuery||_1,y=u.history,O=zu(),M=zu(),V=zu(),F=qX(ba);let z=ba;al&&u.scrollBehavior&&"scrollRestoration"in history&&(history.scrollRestoration="manual");const Y=RR.bind(null,mt=>""+mt),W=RR.bind(null,JJ),Z=RR.bind(null,uh);function ct(mt,Kt){let kt,$t;return KU(mt)?(kt=_.getRecordMatcher(mt),$t=Kt):$t=mt,_.addRoute($t,kt)}function vt(mt){const Kt=_.getRecordMatcher(mt);Kt&&_.removeRoute(Kt)}function Yt(){return _.getRoutes().map(mt=>mt.record)}function Ae(mt){return!!_.getRecordMatcher(mt)}function ne(mt,Kt){if(Kt=ln({},Kt||F.value),typeof mt=="string"){const it=vR(E,mt,Kt.path),gt=_.resolve({path:it.path},Kt),St=y.createHref(it.fullPath);return ln(it,gt,{params:Z(gt.params),hash:uh(it.hash),redirectedFrom:void 0,href:St})}let kt;if(mt.path!=null)kt=ln({},mt,{path:vR(E,mt.path,Kt.path).path});else{const it=ln({},mt.params);for(const gt in it)it[gt]==null&&delete it[gt];kt=ln({},mt,{params:W(it)}),Kt.params=W(Kt.params)}const $t=_.resolve(kt,Kt),Ke=mt.hash||"";$t.params=Y(Z($t.params));const G=$J(C,ln({},mt,{hash:qJ(Ke),path:$t.path})),K=y.createHref(G);return ln({fullPath:G,hash:Ke,query:C===_1?_7(mt.query):mt.query||{}},$t,{redirectedFrom:void 0,href:K})}function zt(mt){return typeof mt=="string"?vR(E,mt,F.value.path):ln({},mt)}function ie(mt,Kt){if(z!==mt)return gl($n.NAVIGATION_CANCELLED,{from:Kt,to:mt})}function Xt(mt){return Je(mt)}function pn(mt){return Xt(ln(zt(mt),{replace:!0}))}function ai(mt,Kt){const kt=mt.matched[mt.matched.length-1];if(kt&&kt.redirect){const{redirect:$t}=kt;let Ke=typeof $t=="function"?$t(mt,Kt):$t;return typeof Ke=="string"&&(Ke=Ke.includes("?")||Ke.includes("#")?Ke=zt(Ke):{path:Ke},Ke.params={}),ln({query:mt.query,hash:mt.hash,params:Ke.path!=null?{}:mt.params},Ke)}}function Je(mt,Kt){const kt=z=ne(mt),$t=F.value,Ke=mt.state,G=mt.force,K=mt.replace===!0,it=ai(kt,$t);if(it)return Je(ln(zt(it),{state:typeof it=="object"?ln({},Ke,it.state):Ke,force:G,replace:K}),Kt||kt);const gt=kt;gt.redirectedFrom=Kt;let St;return!G&&t7(C,$t,kt)&&(St=gl($n.NAVIGATION_DUPLICATED,{to:gt,from:$t}),Gr($t,$t,!0,!1)),(St?Promise.resolve(St):Pi(gt,$t)).catch(Et=>Fo(Et)?Fo(Et,$n.NAVIGATION_GUARD_REDIRECT)?Et:hs(Et):ze(Et,gt,$t)).then(Et=>{if(Et){if(Fo(Et,$n.NAVIGATION_GUARD_REDIRECT))return Je(ln({replace:K},zt(Et.to),{state:typeof Et.to=="object"?ln({},Ke,Et.to.state):Ke,force:G}),Kt||gt)}else Et=sn(gt,$t,!0,K,Ke);return Br(gt,$t,Et),Et})}function Fr(mt,Kt){const kt=ie(mt,Kt);return kt?Promise.reject(kt):Promise.resolve()}function js(mt){const Kt=Hi.values().next().value;return Kt&&typeof Kt.runWithContext=="function"?Kt.runWithContext(mt):mt()}function Pi(mt,Kt){let kt;const[$t,Ke,G]=m7(mt,Kt);kt=yR($t.reverse(),"beforeRouteLeave",mt,Kt);for(const it of $t)it.leaveGuards.forEach(gt=>{kt.push(Oa(gt,mt,Kt))});const K=Fr.bind(null,mt,Kt);return kt.push(K),or(kt).then(()=>{kt=[];for(const it of O.list())kt.push(Oa(it,mt,Kt));return kt.push(K),or(kt)}).then(()=>{kt=yR(Ke,"beforeRouteUpdate",mt,Kt);for(const it of Ke)it.updateGuards.forEach(gt=>{kt.push(Oa(gt,mt,Kt))});return kt.push(K),or(kt)}).then(()=>{kt=[];for(const it of G)if(it.beforeEnter)if(Bs(it.beforeEnter))for(const gt of it.beforeEnter)kt.push(Oa(gt,mt,Kt));else kt.push(Oa(it.beforeEnter,mt,Kt));return kt.push(K),or(kt)}).then(()=>(mt.matched.forEach(it=>it.enterCallbacks={}),kt=yR(G,"beforeRouteEnter",mt,Kt,js),kt.push(K),or(kt))).then(()=>{kt=[];for(const it of M.list())kt.push(Oa(it,mt,Kt));return kt.push(K),or(kt)}).catch(it=>Fo(it,$n.NAVIGATION_CANCELLED)?it:Promise.reject(it))}function Br(mt,Kt,kt){V.list().forEach($t=>js(()=>$t(mt,Kt,kt)))}function sn(mt,Kt,kt,$t,Ke){const G=ie(mt,Kt);if(G)return G;const K=Kt===ba,it=al?history.state:{};kt&&($t||K?y.replace(mt.fullPath,ln({scroll:K&&it&&it.scroll},Ke)):y.push(mt.fullPath,Ke)),F.value=mt,Gr(mt,Kt,kt,K),hs()}let Wi;function zn(){Wi||(Wi=y.listen((mt,Kt,kt)=>{if(!Ro.listening)return;const $t=ne(mt),Ke=ai($t,Ro.currentRoute.value);if(Ke){Je(ln(Ke,{replace:!0,force:!0}),$t).catch(sh);return}z=$t;const G=F.value;al&&c7(p1(G.fullPath,kt.delta),Gf()),Pi($t,G).catch(K=>Fo(K,$n.NAVIGATION_ABORTED|$n.NAVIGATION_CANCELLED)?K:Fo(K,$n.NAVIGATION_GUARD_REDIRECT)?(Je(ln(zt(K.to),{force:!0}),$t).then(it=>{Fo(it,$n.NAVIGATION_ABORTED|$n.NAVIGATION_DUPLICATED)&&!kt.delta&&kt.type===BR.pop&&y.go(-1,!1)}).catch(sh),Promise.reject()):(kt.delta&&y.go(-kt.delta,!1),ze(K,$t,G))).then(K=>{K=K||sn($t,G,!1),K&&(kt.delta&&!Fo(K,$n.NAVIGATION_CANCELLED)?y.go(-kt.delta,!1):kt.type===BR.pop&&Fo(K,$n.NAVIGATION_ABORTED|$n.NAVIGATION_DUPLICATED)&&y.go(-1,!1)),Br($t,G,K)}).catch(sh)}))}let qo=zu(),Gn=zu(),ue;function ze(mt,Kt,kt){hs(mt);const $t=Gn.list();return $t.length?$t.forEach(Ke=>Ke(mt,Kt,kt)):console.error(mt),Promise.reject(mt)}function jr(){return ue&&F.value!==ba?Promise.resolve():new Promise((mt,Kt)=>{qo.add([mt,Kt])})}function hs(mt){return ue||(ue=!mt,zn(),qo.list().forEach(([Kt,kt])=>mt?kt(mt):Kt()),qo.reset()),mt}function Gr(mt,Kt,kt,$t){const{scrollBehavior:Ke}=u;if(!al||!Ke)return Promise.resolve();const G=!kt&&d7(p1(mt.fullPath,0))||($t||!kt)&&history.state&&history.state.scroll||null;return aU().then(()=>Ke(mt,Kt,G)).then(K=>K&&a7(K)).catch(K=>ze(K,mt,Kt))}const Wn=mt=>y.go(mt);let ps;const Hi=new Set,Ro={currentRoute:F,listening:!0,addRoute:ct,removeRoute:vt,clearRoutes:_.clearRoutes,hasRoute:Ae,getRoutes:Yt,resolve:ne,options:u,push:Xt,replace:pn,go:Wn,back:()=>Wn(-1),forward:()=>Wn(1),beforeEach:O.add,beforeResolve:M.add,afterEach:V.add,onError:Gn.add,isReady:jr,install(mt){mt.component("RouterLink",WR),mt.component("RouterView",QU),mt.config.globalProperties.$router=Ro,Object.defineProperty(mt.config.globalProperties,"$route",{enumerable:!0,get:()=>Go(F)}),al&&!ps&&F.value===ba&&(ps=!0,Xt(y.location).catch($t=>{}));const Kt={};for(const $t in ba)Object.defineProperty(Kt,$t,{get:()=>F.value[$t],enumerable:!0});mt.provide(pv,Ro),mt.provide(qU,eU(Kt)),mt.provide(GR,F);const kt=mt.unmount;Hi.add(mt),mt.unmount=function(){Hi.delete(mt),Hi.size<1&&(z=ba,Wi&&Wi(),Wi=null,F.value=ba,ps=!1,ue=!1),kt()}}};function or(mt){return mt.reduce((Kt,kt)=>Kt.then(()=>js(kt)),Promise.resolve())}return Ro}const j7={class:"greetings"},G7={class:"green"},W7=ph({__name:"HelloWorld",props:{msg:{}},setup(u){return(_,E)=>(cv(),dv("div",j7,[ir("h1",G7,V1(u.msg),1),E[0]||(E[0]=ir("h3",null,[_l(" Youve successfully created a project with "),ir("a",{href:"https://vite.dev/",target:"_blank",rel:"noopener"},"Vite"),_l(" + "),ir("a",{href:"https://vuejs.org/",target:"_blank",rel:"noopener"},"Vue 3"),_l(". What's next? ")],-1))]))}}),ZU=(u,_)=>{const E=u.__vccOpts||u;for(const[C,y]of _)E[C]=y;return E},H7=ZU(W7,[["__scopeId","data-v-d1bb330e"]]),K7={class:"wrapper"},Y7=ph({__name:"App",setup(u){return(_,E)=>(cv(),dv(mo,null,[ir("header",null,[E[2]||(E[2]=ir("img",{alt:"Vue logo",class:"logo",src:UJ,width:"125",height:"125"},null,-1)),ir("div",K7,[sr(H7,{msg:"You did it!"}),ir("nav",null,[sr(Go(WR),{to:"/"},{default:PR(()=>[...E[0]||(E[0]=[_l("Home",-1)])]),_:1}),sr(Go(WR),{to:"/about"},{default:PR(()=>[...E[1]||(E[1]=[_l("About",-1)])]),_:1})])])]),sr(Go(QU))],64))}}),q7=ZU(Y7,[["__scopeId","data-v-85852c48"]]),z7="modulepreload",X7=function(u){return"/"+u},b1={},J7=function(_,E,C){let y=Promise.resolve();if(E&&E.length>0){let F=function(z){return Promise.all(z.map(Y=>Promise.resolve(Y).then(W=>({status:"fulfilled",value:W}),W=>({status:"rejected",reason:W}))))};document.getElementsByTagName("link");const M=document.querySelector("meta[property=csp-nonce]"),V=M?.nonce||M?.getAttribute("nonce");y=F(E.map(z=>{if(z=X7(z),z in b1)return;b1[z]=!0;const Y=z.endsWith(".css"),W=Y?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${z}"]${W}`))return;const Z=document.createElement("link");if(Z.rel=Y?"stylesheet":z7,Y||(Z.as="script"),Z.crossOrigin="",Z.href=z,V&&Z.setAttribute("nonce",V),document.head.appendChild(Z),Y)return new Promise((ct,vt)=>{Z.addEventListener("load",ct),Z.addEventListener("error",()=>vt(new Error(`Unable to preload CSS for ${z}`)))})}))}function O(M){const V=new Event("vite:preloadError",{cancelable:!0});if(V.payload=M,window.dispatchEvent(V),!V.defaultPrevented)throw M}return y.then(M=>{for(const V of M||[])V.status==="rejected"&&O(V.reason);return _().catch(O)})};var IR=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function Q7(u){return u&&u.__esModule&&Object.prototype.hasOwnProperty.call(u,"default")?u.default:u}var Cf={exports:{}},Z7=Cf.exports,A1;function $7(){return A1||(A1=1,(function(u,_){(function(E,C){u.exports=C()})(Z7,(function(){function E(t,e){return e.forEach((function(n){n&&typeof n!="string"&&!Array.isArray(n)&&Object.keys(n).forEach((function(i){if(i!=="default"&&!(i in t)){var r=Object.getOwnPropertyDescriptor(n,i);Object.defineProperty(t,i,r.get?r:{enumerable:!0,get:function(){return n[i]}})}}))})),Object.freeze(t)}var C=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof IR<"u"?IR:typeof self<"u"?self:{};function y(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var O=function(t){try{return!!t()}catch{return!0}},M=!O((function(){var t=(function(){}).bind();return typeof t!="function"||t.hasOwnProperty("prototype")})),V=M,F=Function.prototype,z=F.call,Y=V&&F.bind.bind(z,z),W=V?Y:function(t){return function(){return z.apply(t,arguments)}},Z=W({}.isPrototypeOf),ct=function(t){return t&&t.Math===Math&&t},vt=ct(typeof globalThis=="object"&&globalThis)||ct(typeof window=="object"&&window)||ct(typeof self=="object"&&self)||ct(typeof C=="object"&&C)||ct(typeof C=="object"&&C)||(function(){return this})()||Function("return this")(),Yt=M,Ae=Function.prototype,ne=Ae.apply,zt=Ae.call,ie=typeof Reflect=="object"&&Reflect.apply||(Yt?zt.bind(ne):function(){return zt.apply(ne,arguments)}),Xt=W,pn=Xt({}.toString),ai=Xt("".slice),Je=function(t){return ai(pn(t),8,-1)},Fr=Je,js=W,Pi=function(t){if(Fr(t)==="Function")return js(t)},Br=typeof document=="object"&&document.all,sn=Br===void 0&&Br!==void 0?function(t){return typeof t=="function"||t===Br}:function(t){return typeof t=="function"},Wi={},zn=!O((function(){return Object.defineProperty({},1,{get:function(){return 7}})[1]!==7})),qo=M,Gn=Function.prototype.call,ue=qo?Gn.bind(Gn):function(){return Gn.apply(Gn,arguments)},ze={},jr={}.propertyIsEnumerable,hs=Object.getOwnPropertyDescriptor,Gr=hs&&!jr.call({1:2},1);ze.f=Gr?function(t){var e=hs(this,t);return!!e&&e.enumerable}:jr;var Wn,ps,Hi=function(t,e){return{enumerable:!(1&t),configurable:!(2&t),writable:!(4&t),value:e}},Ro=O,or=Je,mt=Object,Kt=W("".split),kt=Ro((function(){return!mt("z").propertyIsEnumerable(0)}))?function(t){return or(t)==="String"?Kt(t,""):mt(t)}:mt,$t=function(t){return t==null},Ke=$t,G=TypeError,K=function(t){if(Ke(t))throw new G("Can't call method on "+t);return t},it=kt,gt=K,St=function(t){return it(gt(t))},Et=sn,bt=function(t){return typeof t=="object"?t!==null:Et(t)},It={},Nt=It,Ct=vt,ce=sn,Ft=function(t){return ce(t)?t:void 0},jt=function(t,e){return arguments.length<2?Ft(Nt[t])||Ft(Ct[t]):Nt[t]&&Nt[t][e]||Ct[t]&&Ct[t][e]},_e=vt.navigator,je=_e&&_e.userAgent,Ye=je?String(je):"",en=vt,pi=Ye,vi=en.process,vr=en.Deno,Cr=vi&&vi.versions||vr&&vr.version,zo=Cr&&Cr.v8;zo&&(ps=(Wn=zo.split("."))[0]>0&&Wn[0]<4?1:+(Wn[0]+Wn[1])),!ps&&pi&&(!(Wn=pi.match(/Edge\/(\d+)/))||Wn[1]>=74)&&(Wn=pi.match(/Chrome\/(\d+)/))&&(ps=+Wn[1]);var Gs=ps,Li=Gs,Wr=O,fh=vt.String,vo=!!Object.getOwnPropertySymbols&&!Wr((function(){var t=Symbol("symbol detection");return!fh(t)||!(Object(t)instanceof Symbol)||!Symbol.sham&&Li&&Li<41})),fv=vo&&!Symbol.sham&&typeof Symbol.iterator=="symbol",e2=jt,n2=sn,i2=Z,r2=Object,Sl=fv?function(t){return typeof t=="symbol"}:function(t){var e=e2("Symbol");return n2(e)&&i2(e.prototype,r2(t))},s2=String,Vc=function(t){try{return s2(t)}catch{return"Object"}},o2=sn,a2=Vc,c2=TypeError,ar=function(t){if(o2(t))return t;throw new c2(a2(t)+" is not a function")},d2=ar,l2=$t,Tl=function(t,e){var n=t[e];return l2(n)?void 0:d2(n)},mv=ue,Ev=sn,gv=bt,u2=TypeError,Sv={exports:{}},Tv=vt,h2=Object.defineProperty,p2=vt,_2=function(t,e){try{h2(Tv,t,{value:e,configurable:!0,writable:!0})}catch{Tv[t]=e}return e},Rv="__core-js_shared__",vv=Sv.exports=p2[Rv]||_2(Rv,{});(vv.versions||(vv.versions=[])).push({version:"3.46.0",mode:"pure",copyright:" 2014-2025 Denis Pushkarev (zloirock.ru), 2025 CoreJS Company (core-js.io)",license:"https://github.com/zloirock/core-js/blob/v3.46.0/LICENSE",source:"https://github.com/zloirock/core-js"});var Wf=Sv.exports,Cv=Wf,Fc=function(t,e){return Cv[t]||(Cv[t]=e||{})},f2=K,m2=Object,Ws=function(t){return m2(f2(t))},E2=Ws,g2=W({}.hasOwnProperty),ii=Object.hasOwn||function(t,e){return g2(E2(t),e)},S2=W,T2=0,R2=Math.random(),v2=S2(1.1.toString),Hf=function(t){return"Symbol("+(t===void 0?"":t)+")_"+v2(++T2+R2,36)},C2=Fc,yv=ii,y2=Hf,I2=vo,b2=fv,Bc=vt.Symbol,Kf=C2("wks"),A2=b2?Bc.for||Bc:Bc&&Bc.withoutSetter||y2,gn=function(t){return yv(Kf,t)||(Kf[t]=I2&&yv(Bc,t)?Bc[t]:A2("Symbol."+t)),Kf[t]},w2=ue,Iv=bt,bv=Sl,O2=Tl,N2=function(t,e){var n,i;if(Ev(n=t.toString)&&!gv(i=mv(n,t))||Ev(n=t.valueOf)&&!gv(i=mv(n,t)))return i;throw new u2("Can't convert object to primitive value")},D2=TypeError,P2=gn("toPrimitive"),L2=function(t,e){if(!Iv(t)||bv(t))return t;var n,i=O2(t,P2);if(i){if(n=w2(i,t,e),!Iv(n)||bv(n))return n;throw new D2("Can't convert object to primitive value")}return N2(t)},k2=Sl,Yf=function(t){var e=L2(t,"string");return k2(e)?e:e+""},Av=bt,qf=vt.document,M2=Av(qf)&&Av(qf.createElement),zf=function(t){return M2?qf.createElement(t):{}},U2=zf,wv=!zn&&!O((function(){return Object.defineProperty(U2("div"),"a",{get:function(){return 7}}).a!==7})),x2=zn,V2=ue,F2=ze,B2=Hi,j2=St,G2=Yf,W2=ii,H2=wv,Ov=Object.getOwnPropertyDescriptor;Wi.f=x2?Ov:function(t,e){if(t=j2(t),e=G2(e),H2)try{return Ov(t,e)}catch{}if(W2(t,e))return B2(!V2(F2.f,t,e),t[e])};var K2=O,Y2=sn,q2=/#|\.prototype\./,Rl=function(t,e){var n=X2[z2(t)];return n===Q2||n!==J2&&(Y2(e)?K2(e):!!e)},z2=Rl.normalize=function(t){return String(t).replace(q2,".").toLowerCase()},X2=Rl.data={},J2=Rl.NATIVE="N",Q2=Rl.POLYFILL="P",Nv=Rl,Z2=ar,$2=M,tx=Pi(Pi.bind),Xo=function(t,e){return Z2(t),e===void 0?t:$2?tx(t,e):function(){return t.apply(e,arguments)}},Hr={},Dv=zn&&O((function(){return Object.defineProperty((function(){}),"prototype",{value:42,writable:!1}).prototype!==42})),ex=bt,nx=String,ix=TypeError,Ki=function(t){if(ex(t))return t;throw new ix(nx(t)+" is not an object")},rx=zn,sx=wv,ox=Dv,mh=Ki,Pv=Yf,ax=TypeError,Xf=Object.defineProperty,cx=Object.getOwnPropertyDescriptor,Jf="enumerable",Qf="configurable",Zf="writable";Hr.f=rx?ox?function(t,e,n){if(mh(t),e=Pv(e),mh(n),typeof t=="function"&&e==="prototype"&&"value"in n&&Zf in n&&!n[Zf]){var i=cx(t,e);i&&i[Zf]&&(t[e]=n.value,n={configurable:Qf in n?n[Qf]:i[Qf],enumerable:Jf in n?n[Jf]:i[Jf],writable:!1})}return Xf(t,e,n)}:Xf:function(t,e,n){if(mh(t),e=Pv(e),mh(n),sx)try{return Xf(t,e,n)}catch{}if("get"in n||"set"in n)throw new ax("Accessors not supported");return"value"in n&&(t[e]=n.value),t};var dx=Hr,lx=Hi,ka=zn?function(t,e,n){return dx.f(t,e,lx(1,n))}:function(t,e,n){return t[e]=n,t},vl=vt,ux=ie,hx=Pi,px=sn,_x=Wi.f,fx=Nv,jc=It,mx=Xo,Gc=ka,Lv=ii,Ex=function(t){var e=function(n,i,r){if(this instanceof e){switch(arguments.length){case 0:return new t;case 1:return new t(n);case 2:return new t(n,i)}return new t(n,i,r)}return ux(t,this,arguments)};return e.prototype=t.prototype,e},ge=function(t,e){var n,i,r,s,o,a,c,d,l,h=t.target,p=t.global,f=t.stat,v=t.proto,S=p?vl:f?vl[h]:vl[h]&&vl[h].prototype,T=p?jc:jc[h]||Gc(jc,h,{})[h],b=T.prototype;for(s in e)i=!(n=fx(p?s:h+(f?".":"#")+s,t.forced))&&S&&Lv(S,s),a=T[s],i&&(c=t.dontCallGetSet?(l=_x(S,s))&&l.value:S[s]),o=i&&c?c:e[s],(n||v||typeof a!=typeof o)&&(d=t.bind&&i?mx(o,vl):t.wrap&&i?Ex(o):v&&px(o)?hx(o):o,(t.sham||o&&o.sham||a&&a.sham)&&Gc(d,"sham",!0),Gc(T,s,d),v&&(Lv(jc,r=h+"Prototype")||Gc(jc,r,{}),Gc(jc[r],s,o),t.real&&b&&(n||!b[s])&&Gc(b,s,o)))},gx=Math.ceil,Sx=Math.floor,Tx=Math.trunc||function(t){var e=+t;return(e>0?Sx:gx)(e)},Rx=Tx,$f=function(t){var e=+t;return e!=e||e===0?0:Rx(e)},vx=$f,Cx=Math.max,yx=Math.min,tm=function(t,e){var n=vx(t);return n<0?Cx(n+e,0):yx(n,e)},Ix=$f,bx=Math.min,kv=function(t){var e=Ix(t);return e>0?bx(e,9007199254740991):0},Ax=kv,Jo=function(t){return Ax(t.length)},wx=St,Ox=tm,Nx=Jo,Mv=function(t){return function(e,n,i){var r=wx(e),s=Nx(r);if(s===0)return!t&&-1;var o,a=Ox(i,s);if(t&&n!=n){for(;s>a;)if((o=r[a++])!=o)return!0}else for(;s>a;a++)if((t||a in r)&&r[a]===n)return t||a||0;return!t&&-1}},em={includes:Mv(!0),indexOf:Mv(!1)},Dx=em.includes;ge({target:"Array",proto:!0,forced:O((function(){return!Array(1).includes()}))},{includes:function(t){return Dx(this,t,arguments.length>1?arguments[1]:void 0)}});var Px=vt,Lx=It,yr=function(t,e){var n=Lx[t+"Prototype"],i=n&&n[e];if(i)return i;var r=Px[t],s=r&&r.prototype;return s&&s[e]},kx=yr("Array","includes"),Mx=bt,Ux=Je,xx=gn("match"),nm=function(t){var e;return Mx(t)&&((e=t[xx])!==void 0?!!e:Ux(t)==="RegExp")},Vx=nm,Fx=TypeError,Uv={};Uv[gn("toStringTag")]="z";var im=String(Uv)==="[object z]",Bx=im,jx=sn,Eh=Je,Gx=gn("toStringTag"),Wx=Object,Hx=Eh((function(){return arguments})())==="Arguments",Qo=Bx?Eh:function(t){var e,n,i;return t===void 0?"Undefined":t===null?"Null":typeof(n=(function(r,s){try{return r[s]}catch{}})(e=Wx(t),Gx))=="string"?n:Hx?Eh(e):(i=Eh(e))==="Object"&&jx(e.callee)?"Arguments":i},Kx=Qo,Yx=String,Yi=function(t){if(Kx(t)==="Symbol")throw new TypeError("Cannot convert a Symbol value to a string");return Yx(t)},qx=gn("match"),zx=ge,Xx=function(t){if(Vx(t))throw new Fx("The method doesn't accept regular expressions");return t},Jx=K,xv=Yi,Qx=function(t){var e=/./;try{"/./"[t](e)}catch{try{return e[qx]=!1,"/./"[t](e)}catch{}}return!1},Zx=W("".indexOf);zx({target:"String",proto:!0,forced:!Qx("includes")},{includes:function(t){return!!~Zx(xv(Jx(this)),xv(Xx(t)),arguments.length>1?arguments[1]:void 0)}});var $x=yr("String","includes"),Vv=Z,tV=kx,eV=$x,rm=Array.prototype,sm=String.prototype,nV=function(t){var e=t.includes;return t===rm||Vv(rm,t)&&e===rm.includes?tV:typeof t=="string"||t===sm||Vv(sm,t)&&e===sm.includes?eV:e},$=y(nV),iV=ar,rV=Ws,sV=kt,oV=Jo,Fv=TypeError,Bv="Reduce of empty array with no initial value",aV=function(t){return function(e,n,i,r){var s=rV(e),o=sV(s),a=oV(s);if(iV(n),a===0&&i<2)throw new Fv(Bv);var c=t?a-1:0,d=t?-1:1;if(i<2)for(;;){if(c in o){r=o[c],c+=d;break}if(c+=d,t?c<0:a<=c)throw new Fv(Bv)}for(;t?c>=0:a>c;c+=d)c in o&&(r=n(r,o[c],c,s));return r}},cV={left:aV(!1)},dV=O,gh=function(t,e){var n=[][t];return!!n&&dV((function(){n.call(null,e||function(){return 1},1)}))},Cl=vt,lV=Ye,uV=Je,Sh=function(t){return lV.slice(0,t.length)===t},om=Sh("Bun/")?"BUN":Sh("Cloudflare-Workers")?"CLOUDFLARE":Sh("Deno/")?"DENO":Sh("Node.js/")?"NODE":Cl.Bun&&typeof Bun.version=="string"?"BUN":Cl.Deno&&typeof Deno.version=="object"?"DENO":uV(Cl.process)==="process"?"NODE":Cl.window&&Cl.document?"BROWSER":"REST",Th=om==="NODE",hV=cV.left;ge({target:"Array",proto:!0,forced:!Th&&Gs>79&&Gs<83||!gh("reduce")},{reduce:function(t){var e=arguments.length;return hV(this,t,e,e>1?arguments[1]:void 0)}});var pV=yr("Array","reduce"),_V=Z,fV=pV,am=Array.prototype,mV=function(t){var e=t.reduce;return t===am||_V(am,t)&&e===am.reduce?fV:e},jv=mV,Ir=y(jv),EV=Je,yl=Array.isArray||function(t){return EV(t)==="Array"},gV=ge,SV=yl,TV=W([].reverse),Gv=[1,2];gV({target:"Array",proto:!0,forced:String(Gv)===String(Gv.reverse())},{reverse:function(){return SV(this)&&(this.length=this.length),TV(this)}});var RV=yr("Array","reverse"),vV=Z,CV=RV,cm=Array.prototype,yV=function(t){var e=t.reverse;return t===cm||vV(cm,t)&&e===cm.reverse?CV:e},Wv=yV,Hv=y(Wv),IV=Hf,Kv=Fc("keys"),Rh=function(t){return Kv[t]||(Kv[t]=IV(t))},bV=!O((function(){function t(){}return t.prototype.constructor=null,Object.getPrototypeOf(new t)!==t.prototype})),AV=ii,wV=sn,OV=Ws,NV=bV,Yv=Rh("IE_PROTO"),dm=Object,DV=dm.prototype,lm=NV?dm.getPrototypeOf:function(t){var e=OV(t);if(AV(e,Yv))return e[Yv];var n=e.constructor;return wV(n)&&e instanceof n?n.prototype:e instanceof dm?DV:null},PV=W,LV=ar,kV=bt,MV=function(t){return kV(t)||t===null},UV=String,xV=TypeError,VV=function(t,e,n){try{return PV(LV(Object.getOwnPropertyDescriptor(t,e)[n]))}catch{}},FV=bt,BV=K,jV=function(t){if(MV(t))return t;throw new xV("Can't set "+UV(t)+" as a prototype")},GV=Object.setPrototypeOf||("__proto__"in{}?(function(){var t,e=!1,n={};try{(t=VV(Object.prototype,"__proto__","set"))(n,[]),e=n instanceof Array}catch{}return function(i,r){return BV(i),jV(r),FV(i)&&(e?t(i,r):i.__proto__=r),i}})():void 0),vh={},Ch={},um=ii,WV=St,HV=em.indexOf,KV=Ch,qv=W([].push),zv=function(t,e){var n,i=WV(t),r=0,s=[];for(n in i)!um(KV,n)&&um(i,n)&&qv(s,n);for(;e.length>r;)um(i,n=e[r++])&&(~HV(s,n)||qv(s,n));return s},hm=["constructor","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","toLocaleString","toString","valueOf"],YV=zv,qV=hm.concat("length","prototype");vh.f=Object.getOwnPropertyNames||function(t){return YV(t,qV)};var Il={};Il.f=Object.getOwnPropertySymbols;var zV=jt,XV=vh,JV=Il,QV=Ki,ZV=W([].concat),$V=zV("Reflect","ownKeys")||function(t){var e=XV.f(QV(t)),n=JV.f;return n?ZV(e,n(t)):e},Xv=ii,tF=$V,eF=Wi,nF=Hr,pm={},iF=zv,rF=hm,yh=Object.keys||function(t){return iF(t,rF)},sF=zn,oF=Dv,aF=Hr,cF=Ki,dF=St,lF=yh;pm.f=sF&&!oF?Object.defineProperties:function(t,e){cF(t);for(var n,i=dF(e),r=lF(e),s=r.length,o=0;s>o;)aF.f(t,n=r[o++],i[n]);return t};var Ih,Jv=jt("document","documentElement"),uF=Ki,hF=pm,Qv=hm,pF=Ch,_F=Jv,fF=zf,_m="prototype",fm="script",Zv=Rh("IE_PROTO"),mm=function(){},$v=function(t){return"<"+fm+">"+t+"</"+fm+">"},tC=function(t){t.write($v("")),t.close();var e=t.parentWindow.Object;return t=null,e},bh=function(){try{Ih=new ActiveXObject("htmlfile")}catch{}var t,e,n;bh=typeof document<"u"?document.domain&&Ih?tC(Ih):(e=fF("iframe"),n="java"+fm+":",e.style.display="none",_F.appendChild(e),e.src=String(n),(t=e.contentWindow.document).open(),t.write($v("document.F=Object")),t.close(),t.F):tC(Ih);for(var i=Qv.length;i--;)delete bh[_m][Qv[i]];return bh()};pF[Zv]=!0;var bl=Object.create||function(t,e){var n;return t!==null?(mm[_m]=uF(t),n=new mm,mm[_m]=null,n[Zv]=t):n=bh(),e===void 0?n:hF.f(n,e)},mF=bt,EF=ka,eC=Error,gF=W("".replace),SF=String(new eC("zxcasd").stack),nC=/\n\s*at [^:]*:[^\n]*/,TF=nC.test(SF),RF=Hi,vF=!O((function(){var t=new Error("a");return!("stack"in t)||(Object.defineProperty(t,"stack",RF(1,7)),t.stack!==7)})),CF=ka,yF=function(t,e){if(TF&&typeof t=="string"&&!eC.prepareStackTrace)for(;e--;)t=gF(t,nC,"");return t},IF=vF,iC=Error.captureStackTrace,Wc={},bF=Wc,AF=gn("iterator"),wF=Array.prototype,rC=function(t){return t!==void 0&&(bF.Array===t||wF[AF]===t)},OF=Qo,sC=Tl,NF=$t,DF=Wc,PF=gn("iterator"),Ah=function(t){if(!NF(t))return sC(t,PF)||sC(t,"@@iterator")||DF[OF(t)]},LF=ue,kF=ar,MF=Ki,UF=Vc,xF=Ah,VF=TypeError,Em=function(t,e){var n=arguments.length<2?xF(t):e;if(kF(n))return MF(LF(n,t));throw new VF(UF(t)+" is not iterable")},FF=ue,oC=Ki,BF=Tl,aC=function(t,e,n){var i,r;oC(t);try{if(!(i=BF(t,"return"))){if(e==="throw")throw n;return n}i=FF(i,t)}catch(s){r=!0,i=s}if(e==="throw")throw n;if(r)throw i;return oC(i),n},jF=Xo,GF=ue,WF=Ki,HF=Vc,KF=rC,YF=Jo,cC=Z,qF=Em,zF=Ah,dC=aC,XF=TypeError,wh=function(t,e){this.stopped=t,this.result=e},lC=wh.prototype,Al=function(t,e,n){var i,r,s,o,a,c,d,l=n&&n.that,h=!(!n||!n.AS_ENTRIES),p=!(!n||!n.IS_RECORD),f=!(!n||!n.IS_ITERATOR),v=!(!n||!n.INTERRUPTED),S=jF(e,l),T=function(w){return i&&dC(i,"normal"),new wh(!0,w)},b=function(w){return h?(WF(w),v?S(w[0],w[1],T):S(w[0],w[1])):v?S(w,T):S(w)};if(p)i=t.iterator;else if(f)i=t;else{if(!(r=zF(t)))throw new XF(HF(t)+" is not iterable");if(KF(r)){for(s=0,o=YF(t);o>s;s++)if((a=b(t[s]))&&cC(lC,a))return a;return new wh(!1)}i=qF(t,r)}for(c=p?t.next:i.next;!(d=GF(c,i)).done;){try{a=b(d.value)}catch(w){dC(i,"throw",w)}if(typeof a=="object"&&a&&cC(lC,a))return a}return new wh(!1)},JF=Yi,QF=ge,ZF=Z,$F=lm,Oh=GV,tB=function(t,e,n){for(var i=tF(e),r=nF.f,s=eF.f,o=0;o<i.length;o++){var a=i[o];Xv(t,a)||n&&Xv(n,a)||r(t,a,s(e,a))}},uC=bl,gm=ka,Sm=Hi,eB=function(t,e){mF(e)&&"cause"in e&&EF(t,"cause",e.cause)},nB=function(t,e,n,i){IF&&(iC?iC(t,e):CF(t,"stack",yF(n,i)))},iB=Al,rB=function(t,e){return t===void 0?arguments.length<2?"":e:JF(t)},sB=gn("toStringTag"),Nh=Error,oB=[].push,Hc=function(t,e){var n,i=ZF(Tm,this);Oh?n=Oh(new Nh,i?$F(this):Tm):(n=i?this:uC(Tm),gm(n,sB,"Error")),e!==void 0&&gm(n,"message",rB(e)),nB(n,Hc,n.stack,1),arguments.length>2&&eB(n,arguments[2]);var r=[];return iB(t,oB,{that:r}),gm(n,"errors",r),n};Oh?Oh(Hc,Nh):tB(Hc,Nh,{name:!0});var Tm=Hc.prototype=uC(Nh.prototype,{constructor:Sm(1,Hc),message:Sm(1,""),name:Sm(1,"AggregateError")});QF({global:!0},{AggregateError:Hc});var Dh,wl,Ph,aB=sn,hC=vt.WeakMap,cB=aB(hC)&&/native code/.test(String(hC)),pC=vt,dB=bt,lB=ka,Rm=ii,vm=Wf,uB=Rh,hB=Ch,_C="Object already initialized",Cm=pC.TypeError,pB=pC.WeakMap;if(cB||vm.state){var Hs=vm.state||(vm.state=new pB);Hs.get=Hs.get,Hs.has=Hs.has,Hs.set=Hs.set,Dh=function(t,e){if(Hs.has(t))throw new Cm(_C);return e.facade=t,Hs.set(t,e),e},wl=function(t){return Hs.get(t)||{}},Ph=function(t){return Hs.has(t)}}else{var Kc=uB("state");hB[Kc]=!0,Dh=function(t,e){if(Rm(t,Kc))throw new Cm(_C);return e.facade=t,lB(t,Kc,e),e},wl=function(t){return Rm(t,Kc)?t[Kc]:{}},Ph=function(t){return Rm(t,Kc)}}var Ma,fC,mC,Ua={set:Dh,get:wl,has:Ph,enforce:function(t){return Ph(t)?wl(t):Dh(t,{})},getterFor:function(t){return function(e){var n;if(!dB(e)||(n=wl(e)).type!==t)throw new Cm("Incompatible receiver, "+t+" required");return n}}},ym=zn,_B=ii,EC=Function.prototype,fB=ym&&Object.getOwnPropertyDescriptor,gC=_B(EC,"name"),SC={PROPER:gC&&(function(){}).name==="something",CONFIGURABLE:gC&&(!ym||ym&&fB(EC,"name").configurable)},mB=ka,Zo=function(t,e,n,i){return i&&i.enumerable?t[e]=n:mB(t,e,n),t},EB=O,gB=sn,SB=bt,TB=bl,TC=lm,RB=Zo,Im=gn("iterator"),RC=!1;[].keys&&("next"in(mC=[].keys())?(fC=TC(TC(mC)))!==Object.prototype&&(Ma=fC):RC=!0);var vB=!SB(Ma)||EB((function(){var t={};return Ma[Im].call(t)!==t}));gB((Ma=vB?{}:TB(Ma))[Im])||RB(Ma,Im,(function(){return this}));var vC={IteratorPrototype:Ma,BUGGY_SAFARI_ITERATORS:RC},CB=Qo,yB=im?{}.toString:function(){return"[object "+CB(this)+"]"},IB=im,bB=Hr.f,AB=ka,wB=ii,OB=yB,CC=gn("toStringTag"),Co=function(t,e,n,i){var r=n?t:t&&t.prototype;r&&(wB(r,CC)||bB(r,CC,{configurable:!0,value:e}),i&&!IB&&AB(r,"toString",OB))},NB=vC.IteratorPrototype,DB=bl,PB=Hi,LB=Co,kB=Wc,MB=function(){return this},bm=function(t,e,n,i){var r=e+" Iterator";return t.prototype=DB(NB,{next:PB(+!i,n)}),LB(t,r,!1,!0),kB[r]=MB,t},UB=ge,xB=ue,VB=SC,FB=bm,BB=lm,jB=Co,yC=Zo,IC=Wc,GB=vC,WB=VB.PROPER,Lh=GB.BUGGY_SAFARI_ITERATORS,Am=gn("iterator"),bC="keys",kh="values",AC="entries",HB=function(){return this},wC=function(t,e,n,i,r,s,o){FB(n,e,i);var a,c,d,l=function(b){if(b===r&&S)return S;if(!Lh&&b&&b in f)return f[b];switch(b){case bC:case kh:case AC:return function(){return new n(this,b)}}return function(){return new n(this)}},h=e+" Iterator",p=!1,f=t.prototype,v=f[Am]||f["@@iterator"]||r&&f[r],S=!Lh&&v||l(r),T=e==="Array"&&f.entries||v;if(T&&(a=BB(T.call(new t)))!==Object.prototype&&a.next&&(jB(a,h,!0,!0),IC[h]=HB),WB&&r===kh&&v&&v.name!==kh&&(p=!0,S=function(){return xB(v,this)}),r)if(c={values:l(kh),keys:s?S:l(bC),entries:l(AC)},o)for(d in c)(Lh||p||!(d in f))&&yC(f,d,c[d]);else UB({target:e,proto:!0,forced:Lh||p},c);return o&&f[Am]!==S&&yC(f,Am,S,{}),IC[e]=S,c},Mh=function(t,e){return{value:t,done:e}},KB=St,OC=Wc,NC=Ua;Hr.f;var YB=wC,Uh=Mh,DC="Array Iterator",qB=NC.set,zB=NC.getterFor(DC);YB(Array,"Array",(function(t,e){qB(this,{type:DC,target:KB(t),index:0,kind:e})}),(function(){var t=zB(this),e=t.target,n=t.index++;if(!e||n>=e.length)return t.target=null,Uh(void 0,!0);switch(t.kind){case"keys":return Uh(n,!1);case"values":return Uh(e[n],!1)}return Uh([n,e[n]],!1)}),"values"),OC.Arguments=OC.Array;var XB=Hr,xh=function(t,e,n){return XB.f(t,e,n)},JB=jt,QB=xh,ZB=zn,PC=gn("species"),$B=Z,tj=TypeError,wm=function(t,e){if($B(e,t))return t;throw new tj("Incorrect invocation")},ej=sn,Om=Wf,nj=W(Function.toString);ej(Om.inspectSource)||(Om.inspectSource=function(t){return nj(t)});var LC=Om.inspectSource,ij=W,rj=O,kC=sn,sj=Qo,oj=LC,MC=function(){},UC=jt("Reflect","construct"),Nm=/^\s*(?:class|function)\b/,aj=ij(Nm.exec),cj=!Nm.test(MC),Ol=function(t){if(!kC(t))return!1;try{return UC(MC,[],t),!0}catch{return!1}},xC=function(t){if(!kC(t))return!1;switch(sj(t)){case"AsyncFunction":case"GeneratorFunction":case"AsyncGeneratorFunction":return!1}try{return cj||!!aj(Nm,oj(t))}catch{return!0}};xC.sham=!0;var Nl,Yc,VC,Dm,Vh=!UC||rj((function(){var t;return Ol(Ol.call)||!Ol(Object)||!Ol((function(){t=!0}))||t}))?xC:Ol,dj=Vh,lj=Vc,uj=TypeError,FC=Ki,hj=function(t){if(dj(t))return t;throw new uj(lj(t)+" is not a constructor")},pj=$t,_j=gn("species"),Pm=function(t,e){var n,i=FC(t).constructor;return i===void 0||pj(n=FC(i)[_j])?e:hj(n)},$o=W([].slice),fj=TypeError,xa=function(t,e){if(t<e)throw new fj("Not enough arguments");return t},BC=/(?:ipad|iphone|ipod).*applewebkit/i.test(Ye),br=vt,mj=ie,Ej=Xo,jC=sn,gj=ii,GC=O,WC=Jv,Sj=$o,HC=zf,Tj=xa,Rj=BC,vj=Th,Lm=br.setImmediate,km=br.clearImmediate,Cj=br.process,Mm=br.Dispatch,yj=br.Function,KC=br.MessageChannel,Ij=br.String,Um=0,Dl={},YC="onreadystatechange";GC((function(){Nl=br.location}));var xm=function(t){if(gj(Dl,t)){var e=Dl[t];delete Dl[t],e()}},Vm=function(t){return function(){xm(t)}},qC=function(t){xm(t.data)},zC=function(t){br.postMessage(Ij(t),Nl.protocol+"//"+Nl.host)};Lm&&km||(Lm=function(t){Tj(arguments.length,1);var e=jC(t)?t:yj(t),n=Sj(arguments,1);return Dl[++Um]=function(){mj(e,void 0,n)},Yc(Um),Um},km=function(t){delete Dl[t]},vj?Yc=function(t){Cj.nextTick(Vm(t))}:Mm&&Mm.now?Yc=function(t){Mm.now(Vm(t))}:KC&&!Rj?(Dm=(VC=new KC).port2,VC.port1.onmessage=qC,Yc=Ej(Dm.postMessage,Dm)):br.addEventListener&&jC(br.postMessage)&&!br.importScripts&&Nl&&Nl.protocol!=="file:"&&!GC(zC)?(Yc=zC,br.addEventListener("message",qC,!1)):Yc=YC in HC("script")?function(t){WC.appendChild(HC("script"))[YC]=function(){WC.removeChild(this),xm(t)}}:function(t){setTimeout(Vm(t),0)});var Fh={set:Lm,clear:km},XC=vt,bj=zn,Aj=Object.getOwnPropertyDescriptor,JC=function(t){if(!bj)return XC[t];var e=Aj(XC,t);return e&&e.value},QC=function(){this.head=null,this.tail=null};QC.prototype={add:function(t){var e={item:t,next:null},n=this.tail;n?n.next=e:this.head=e,this.tail=e},get:function(){var t=this.head;if(t)return(this.head=t.next)===null&&(this.tail=null),t.item}};var qc,Fm,Bm,jm,ZC,$C=QC,wj=/ipad|iphone|ipod/i.test(Ye)&&typeof Pebble<"u",Oj=/web0s(?!.*chrome)/i.test(Ye),zc=vt,Nj=JC,ty=Xo,Gm=Fh.set,Dj=$C,Pj=BC,Lj=wj,kj=Oj,Wm=Th,ey=zc.MutationObserver||zc.WebKitMutationObserver,ny=zc.document,iy=zc.process,Bh=zc.Promise,Hm=Nj("queueMicrotask");if(!Hm){var jh=new Dj,Gh=function(){var t,e;for(Wm&&(t=iy.domain)&&t.exit();e=jh.get();)try{e()}catch(n){throw jh.head&&qc(),n}t&&t.enter()};Pj||Wm||kj||!ey||!ny?!Lj&&Bh&&Bh.resolve?((jm=Bh.resolve(void 0)).constructor=Bh,ZC=ty(jm.then,jm),qc=function(){ZC(Gh)}):Wm?qc=function(){iy.nextTick(Gh)}:(Gm=ty(Gm,zc),qc=function(){Gm(Gh)}):(Fm=!0,Bm=ny.createTextNode(""),new ey(Gh).observe(Bm,{characterData:!0}),qc=function(){Bm.data=Fm=!Fm}),Hm=function(t){jh.head||qc(),jh.add(t)}}var ry=Hm,Xc=function(t){try{return{error:!1,value:t()}}catch(e){return{error:!0,value:e}}},Va=vt.Promise,Mj=vt,Pl=Va,Uj=sn,xj=Nv,Vj=LC,Fj=gn,sy=om,Km=Gs,oy=Pl&&Pl.prototype,Bj=Fj("species"),ay=Uj(Mj.PromiseRejectionEvent),jj=xj("Promise",(function(){var t=Vj(Pl),e=t!==String(Pl);if(!e&&Km===66||!oy.catch||!oy.finally)return!0;if(!Km||Km<51||!/native code/.test(t)){var n=new Pl((function(r){r(1)})),i=function(r){r((function(){}),(function(){}))};if((n.constructor={})[Bj]=i,!(n.then((function(){}))instanceof i))return!0}return!(e||sy!=="BROWSER"&&sy!=="DENO"||ay)})),Ll={CONSTRUCTOR:jj,REJECTION_EVENT:ay},Ks={},cy=ar,Gj=TypeError,Wj=function(t){var e,n;this.promise=new t((function(i,r){if(e!==void 0||n!==void 0)throw new Gj("Bad Promise constructor");e=i,n=r})),this.resolve=cy(e),this.reject=cy(n)};Ks.f=function(t){return new Wj(t)};var Ym,dy,ly,Hj=ge,Wh=Th,ta=vt,Kj=It,kl=ue,Yj=Zo,qj=Co,zj=function(t){var e=JB(t);ZB&&e&&!e[PC]&&QB(e,PC,{configurable:!0,get:function(){return this}})},Xj=ar,qm=sn,Jj=bt,Qj=wm,Zj=Pm,uy=Fh.set,zm=ry,$j=function(t,e){try{arguments.length===1?console.error(t):console.error(t,e)}catch{}},tG=Xc,eG=$C,hy=Ua,Xm=Va,py=Ll,_y=Ks,Hh="Promise",fy=py.CONSTRUCTOR,nG=py.REJECTION_EVENT,Jm=hy.getterFor(Hh),iG=hy.set,rG=Xm&&Xm.prototype,Ml=Xm,Qm=rG,my=ta.TypeError,Zm=ta.document,$m=ta.process,tE=_y.f,sG=tE,oG=!!(Zm&&Zm.createEvent&&ta.dispatchEvent),Ey="unhandledrejection",gy=function(t){var e;return!(!Jj(t)||!qm(e=t.then))&&e},Sy=function(t,e){var n,i,r,s=e.value,o=e.state===1,a=o?t.ok:t.fail,c=t.resolve,d=t.reject,l=t.domain;try{a?(o||(e.rejection===2&&cG(e),e.rejection=1),a===!0?n=s:(l&&l.enter(),n=a(s),l&&(l.exit(),r=!0)),n===t.promise?d(new my("Promise-chain cycle")):(i=gy(n))?kl(i,n,c,d):c(n)):d(s)}catch(h){l&&!r&&l.exit(),d(h)}},Ty=function(t,e){t.notified||(t.notified=!0,zm((function(){for(var n,i=t.reactions;n=i.get();)Sy(n,t);t.notified=!1,e&&!t.rejection&&aG(t)})))},Ry=function(t,e,n){var i,r;oG?((i=Zm.createEvent("Event")).promise=e,i.reason=n,i.initEvent(t,!1,!0),ta.dispatchEvent(i)):i={promise:e,reason:n},!nG&&(r=ta["on"+t])?r(i):t===Ey&&$j("Unhandled promise rejection",n)},aG=function(t){kl(uy,ta,(function(){var e,n=t.facade,i=t.value;if(vy(t)&&(e=tG((function(){Wh?$m.emit("unhandledRejection",i,n):Ry(Ey,n,i)})),t.rejection=Wh||vy(t)?2:1,e.error))throw e.value}))},vy=function(t){return t.rejection!==1&&!t.parent},cG=function(t){kl(uy,ta,(function(){var e=t.facade;Wh?$m.emit("rejectionHandled",e):Ry("rejectionhandled",e,t.value)}))},Jc=function(t,e,n){return function(i){t(e,i,n)}},Qc=function(t,e,n){t.done||(t.done=!0,n&&(t=n),t.value=e,t.state=2,Ty(t,!0))},eE=function(t,e,n){if(!t.done){t.done=!0,n&&(t=n);try{if(t.facade===e)throw new my("Promise can't be resolved itself");var i=gy(e);i?zm((function(){var r={done:!1};try{kl(i,e,Jc(eE,r,t),Jc(Qc,r,t))}catch(s){Qc(r,s,t)}})):(t.value=e,t.state=1,Ty(t,!1))}catch(r){Qc({done:!1},r,t)}}};fy&&(Qm=(Ml=function(t){Qj(this,Qm),Xj(t),kl(Ym,this);var e=Jm(this);try{t(Jc(eE,e),Jc(Qc,e))}catch(n){Qc(e,n)}}).prototype,(Ym=function(t){iG(this,{type:Hh,done:!1,notified:!1,parent:!1,reactions:new eG,rejection:!1,state:0,value:null})}).prototype=Yj(Qm,"then",(function(t,e){var n=Jm(this),i=tE(Zj(this,Ml));return n.parent=!0,i.ok=!qm(t)||t,i.fail=qm(e)&&e,i.domain=Wh?$m.domain:void 0,n.state===0?n.reactions.add(i):zm((function(){Sy(i,n)})),i.promise})),dy=function(){var t=new Ym,e=Jm(t);this.promise=t,this.resolve=Jc(eE,e),this.reject=Jc(Qc,e)},_y.f=tE=function(t){return t===Ml||t===ly?new dy(t):sG(t)}),Hj({global:!0,wrap:!0,forced:fy},{Promise:Ml}),ly=Kj.Promise,qj(Ml,Hh,!1,!0),zj(Hh);var Cy=gn("iterator"),yy=!1;try{var dG=0,Iy={next:function(){return{done:!!dG++}},return:function(){yy=!0}};Iy[Cy]=function(){return this},Array.from(Iy,(function(){throw 2}))}catch{}var lG=Va,uG=function(t,e){try{if(!e&&!yy)return!1}catch{return!1}var n=!1;try{var i={};i[Cy]=function(){return{next:function(){return{done:n=!0}}}},t(i)}catch{}return n},Kh=Ll.CONSTRUCTOR||!uG((function(t){lG.all(t).then(void 0,(function(){}))})),hG=ue,pG=ar,_G=Ks,fG=Xc,mG=Al;ge({target:"Promise",stat:!0,forced:Kh},{all:function(t){var e=this,n=_G.f(e),i=n.resolve,r=n.reject,s=fG((function(){var o=pG(e.resolve),a=[],c=0,d=1;mG(t,(function(l){var h=c++,p=!1;d++,hG(o,e,l).then((function(f){p||(p=!0,a[h]=f,--d||i(a))}),r)})),--d||i(a)}));return s.error&&r(s.value),n.promise}});var EG=ge,gG=Ll.CONSTRUCTOR;Va&&Va.prototype,EG({target:"Promise",proto:!0,forced:gG,real:!0},{catch:function(t){return this.then(void 0,t)}});var SG=ue,TG=ar,RG=Ks,vG=Xc,CG=Al;ge({target:"Promise",stat:!0,forced:Kh},{race:function(t){var e=this,n=RG.f(e),i=n.reject,r=vG((function(){var s=TG(e.resolve);CG(t,(function(o){SG(s,e,o).then(n.resolve,i)}))}));return r.error&&i(r.value),n.promise}});var yG=Ks;ge({target:"Promise",stat:!0,forced:Ll.CONSTRUCTOR},{reject:function(t){var e=yG.f(this);return(0,e.reject)(t),e.promise}});var IG=Ki,bG=bt,AG=Ks,by=function(t,e){if(IG(t),bG(e)&&e.constructor===t)return e;var n=AG.f(t);return(0,n.resolve)(e),n.promise},wG=ge,OG=Va,NG=Ll.CONSTRUCTOR,DG=by,PG=jt("Promise"),LG=!NG;wG({target:"Promise",stat:!0,forced:!0},{resolve:function(t){return DG(LG&&this===PG?OG:this,t)}});var kG=ue,MG=ar,UG=Ks,xG=Xc,VG=Al;ge({target:"Promise",stat:!0,forced:Kh},{allSettled:function(t){var e=this,n=UG.f(e),i=n.resolve,r=n.reject,s=xG((function(){var o=MG(e.resolve),a=[],c=0,d=1;VG(t,(function(l){var h=c++,p=!1;d++,kG(o,e,l).then((function(f){p||(p=!0,a[h]={status:"fulfilled",value:f},--d||i(a))}),(function(f){p||(p=!0,a[h]={status:"rejected",reason:f},--d||i(a))}))})),--d||i(a)}));return s.error&&r(s.value),n.promise}});var FG=ue,BG=ar,jG=jt,GG=Ks,WG=Xc,HG=Al,Ay="No one promise resolved";ge({target:"Promise",stat:!0,forced:Kh},{any:function(t){var e=this,n=jG("AggregateError"),i=GG.f(e),r=i.resolve,s=i.reject,o=WG((function(){var a=BG(e.resolve),c=[],d=0,l=1,h=!1;HG(t,(function(p){var f=d++,v=!1;l++,FG(a,e,p).then((function(S){v||h||(h=!0,r(S))}),(function(S){v||h||(v=!0,c[f]=S,--l||s(new n(c,Ay)))}))})),--l||s(new n(c,Ay))}));return o.error&&s(o.value),i.promise}});var KG=ge,YG=ie,qG=$o,zG=Ks,XG=ar,wy=Xc,nE=vt.Promise,Oy=!1;KG({target:"Promise",stat:!0,forced:!nE||!nE.try||wy((function(){nE.try((function(t){Oy=t===8}),8)})).error||!Oy},{try:function(t){var e=arguments.length>1?qG(arguments,1):[],n=zG.f(this),i=wy((function(){return YG(XG(t),void 0,e)}));return(i.error?n.reject:n.resolve)(i.value),n.promise}});var JG=Ks;ge({target:"Promise",stat:!0},{withResolvers:function(){var t=JG.f(this);return{promise:t.promise,resolve:t.resolve,reject:t.reject}}});var QG=ge,iE=Va,ZG=O,$G=jt,t3=sn,e3=Pm,Ny=by,n3=iE&&iE.prototype;QG({target:"Promise",proto:!0,real:!0,forced:!!iE&&ZG((function(){n3.finally.call({then:function(){}},(function(){}))}))},{finally:function(t){var e=e3(this,$G("Promise")),n=t3(t);return this.then(n?function(i){return Ny(e,t()).then((function(){return i}))}:t,n?function(i){return Ny(e,t()).then((function(){throw i}))}:t)}});var rE=W,i3=$f,r3=Yi,s3=K,o3=rE("".charAt),Dy=rE("".charCodeAt),a3=rE("".slice),Py=function(t){return function(e,n){var i,r,s=r3(s3(e)),o=i3(n),a=s.length;return o<0||o>=a?t?"":void 0:(i=Dy(s,o))<55296||i>56319||o+1===a||(r=Dy(s,o+1))<56320||r>57343?t?o3(s,o):i:t?a3(s,o,o+2):r-56320+(i-55296<<10)+65536}},sE={codeAt:Py(!1),charAt:Py(!0)},c3=sE.charAt,d3=Yi,Ly=Ua,l3=wC,ky=Mh,My="String Iterator",u3=Ly.set,h3=Ly.getterFor(My);l3(String,"String",(function(t){u3(this,{type:My,string:d3(t),index:0})}),(function(){var t,e=h3(this),n=e.string,i=e.index;return i>=n.length?ky(void 0,!0):(t=c3(n,i),e.index+=t.length,ky(t,!1))}));var p3=It.Promise,_3={CSSRuleList:0,CSSStyleDeclaration:0,CSSValueList:0,ClientRectList:0,DOMRectList:0,DOMStringList:0,DOMTokenList:1,DataTransferItemList:0,FileList:0,HTMLAllCollection:0,HTMLCollection:0,HTMLFormElement:0,HTMLSelectElement:0,MediaList:0,MimeTypeArray:0,NamedNodeMap:0,NodeList:1,PaintRequestList:0,Plugin:0,PluginArray:0,SVGLengthList:0,SVGNumberList:0,SVGPathSegList:0,SVGPointList:0,SVGStringList:0,SVGTransformList:0,SourceBufferList:0,StyleSheetList:0,TextTrackCueList:0,TextTrackList:0,TouchList:0},f3=vt,m3=Co,Uy=Wc;for(var oE in _3)m3(f3[oE],oE),Uy[oE]=Uy.Array;var xy=p3,st=y(xy),E3=yr("Array","values"),g3=Qo,S3=ii,T3=Z,R3=E3,aE=Array.prototype,v3={DOMTokenList:!0,NodeList:!0},C3=function(t){var e=t.values;return t===aE||T3(aE,t)&&e===aE.values||S3(v3,g3(t))?R3:e},qi=y(C3),Vy=Vc,y3=TypeError,Fy=$o,I3=Math.floor,cE=function(t,e){var n=t.length;if(n<8)for(var i,r,s=1;s<n;){for(r=s,i=t[s];r&&e(t[r-1],i)>0;)t[r]=t[--r];r!==s++&&(t[r]=i)}else for(var o=I3(n/2),a=cE(Fy(t,0,o),e),c=cE(Fy(t,o),e),d=a.length,l=c.length,h=0,p=0;h<d||p<l;)t[h+p]=h<d&&p<l?e(a[h],c[p])<=0?a[h++]:c[p++]:h<d?a[h++]:c[p++];return t},By=cE,jy=Ye.match(/firefox\/(\d+)/i),b3=!!jy&&+jy[1],A3=/MSIE|Trident/.test(Ye),Gy=Ye.match(/AppleWebKit\/(\d+)\./),w3=!!Gy&&+Gy[1],O3=ge,Wy=W,N3=ar,D3=Ws,Hy=Jo,P3=function(t,e){if(!delete t[e])throw new y3("Cannot delete property "+Vy(e)+" of "+Vy(t))},Ky=Yi,dE=O,L3=By,k3=gh,Yy=b3,M3=A3,qy=Gs,zy=w3,ea=[],Xy=Wy(ea.sort),U3=Wy(ea.push),x3=dE((function(){ea.sort(void 0)})),V3=dE((function(){ea.sort(null)})),F3=k3("sort"),Jy=!dE((function(){if(qy)return qy<70;if(!(Yy&&Yy>3)){if(M3)return!0;if(zy)return zy<603;var t,e,n,i,r="";for(t=65;t<76;t++){switch(e=String.fromCharCode(t),t){case 66:case 69:case 70:case 72:n=3;break;case 68:case 71:n=4;break;default:n=2}for(i=0;i<47;i++)ea.push({k:e+i,v:n})}for(ea.sort((function(s,o){return o.v-s.v})),i=0;i<ea.length;i++)e=ea[i].k.charAt(0),r.charAt(r.length-1)!==e&&(r+=e);return r!=="DGBEFHACIJK"}}));O3({target:"Array",proto:!0,forced:x3||!V3||!F3||!Jy},{sort:function(t){t!==void 0&&N3(t);var e=D3(this);if(Jy)return t===void 0?Xy(e):Xy(e,t);var n,i,r=[],s=Hy(e);for(i=0;i<s;i++)i in e&&U3(r,e[i]);for(L3(r,(function(o){return function(a,c){return c===void 0?-1:a===void 0?1:o!==void 0?+o(a,c)||0:Ky(a)>Ky(c)?1:-1}})(t)),n=Hy(r),i=0;i<n;)e[i]=r[i++];for(;i<s;)P3(e,i++);return e}});var B3=yr("Array","sort"),j3=Z,G3=B3,lE=Array.prototype,W3=function(t){var e=t.sort;return t===lE||j3(lE,t)&&e===lE.sort?G3:e},Fa=y(W3),H3=ge,K3=W,Y3=tm,q3=RangeError,Qy=String.fromCharCode,Zy=String.fromCodePoint,z3=K3([].join);H3({target:"String",stat:!0,forced:!!Zy&&Zy.length!==1},{fromCodePoint:function(t){for(var e,n=[],i=arguments.length,r=0;i>r;){if(e=+arguments[r++],Y3(e,1114111)!==e)throw new q3(e+" is not a valid code point");n[r]=e<65536?Qy(e):Qy(55296+((e-=65536)>>10),e%1024+56320)}return z3(n,"")}});var X3=O,J3=gn("iterator"),Yh=!X3((function(){var t=new URL("b?a=1&b=2&c=3","https://a"),e=t.searchParams,n=new URLSearchParams("a=1&a=2&b=3"),i="";return t.pathname="c%20d",e.forEach((function(r,s){e.delete("b"),i+=s+r})),n.delete("a",2),n.delete("b",void 0),!t.toJSON||!n.has("a",1)||n.has("a",2)||!n.has("a",void 0)||n.has("b")||!e.size&&!0||!e.sort||t.href!=="https://a/c%20d?a=1&c=3"||e.get("c")!=="3"||String(new URLSearchParams("?a=1"))!=="a=1"||!e[J3]||new URL("https://a@b").username!=="a"||new URLSearchParams(new URLSearchParams("a=b")).get("a")!=="b"||new URL("https://").host!=="xn--e1aybc"||new URL("https://a#").hash!=="#%D0%B1"||i!=="a1c3"||new URL("https://x",void 0).host!=="x"})),Q3=Zo,uE=ge,$y=vt,hE=JC,Z3=jt,qh=ue,_s=W,Ul=zn,tI=Yh,eI=Zo,$3=xh,tW=function(t,e,n){for(var i in e)n&&n.unsafe&&t[i]?t[i]=e[i]:Q3(t,i,e[i],n);return t},eW=Co,nW=bm,pE=Ua,nI=wm,_E=sn,iW=ii,rW=Xo,sW=Qo,oW=Ki,iI=bt,zi=Yi,aW=bl,rI=Hi,sI=Em,cW=Ah,zh=Mh,Zc=xa,dW=By,lW=gn("iterator"),$c="URLSearchParams",oI=$c+"Iterator",aI=pE.set,Kr=pE.getterFor($c),uW=pE.getterFor(oI),cI=hE("fetch"),Xh=hE("Request"),xl=hE("Headers"),fE=Xh&&Xh.prototype,dI=xl&&xl.prototype,hW=$y.TypeError,pW=$y.encodeURIComponent,_W=String.fromCharCode,fW=Z3("String","fromCodePoint"),mW=parseInt,Jh=_s("".charAt),lI=_s([].join),na=_s([].push),uI=_s("".replace),EW=_s([].shift),hI=_s([].splice),pI=_s("".split),_I=_s("".slice),gW=_s(/./.exec),SW=/\+/g,TW=/^[0-9a-f]+$/i,fI=function(t,e){var n=_I(t,e,e+2);return gW(TW,n)?mW(n,16):NaN},RW=function(t){for(var e=0,n=128;n>0&&(t&n)!=0;n>>=1)e++;return e},vW=function(t){var e=null;switch(t.length){case 1:e=t[0];break;case 2:e=(31&t[0])<<6|63&t[1];break;case 3:e=(15&t[0])<<12|(63&t[1])<<6|63&t[2];break;case 4:e=(7&t[0])<<18|(63&t[1])<<12|(63&t[2])<<6|63&t[3]}return e>1114111?null:e},mI=function(t){for(var e=(t=uI(t,SW," ")).length,n="",i=0;i<e;){var r=Jh(t,i);if(r==="%"){if(Jh(t,i+1)==="%"||i+3>e){n+="%",i++;continue}var s=fI(t,i+1);if(s!=s){n+=r,i++;continue}i+=2;var o=RW(s);if(o===0)r=_W(s);else{if(o===1||o>4){n+="",i++;continue}for(var a=[s],c=1;c<o&&!(++i+3>e||Jh(t,i)!=="%");){var d=fI(t,i+1);if(d!=d){i+=3;break}if(d>191||d<128)break;na(a,d),i+=2,c++}if(a.length!==o){n+="";continue}var l=vW(a);l===null?n+="":r=fW(l)}}n+=r,i++}return n},CW=/[!'()~]|%20/g,yW={"!":"%21","'":"%27","(":"%28",")":"%29","~":"%7E","%20":"+"},IW=function(t){return yW[t]},EI=function(t){return uI(pW(t),CW,IW)},mE=nW((function(t,e){aI(this,{type:oI,target:Kr(t).entries,index:0,kind:e})}),$c,(function(){var t=uW(this),e=t.target,n=t.index++;if(!e||n>=e.length)return t.target=null,zh(void 0,!0);var i=e[n];switch(t.kind){case"keys":return zh(i.key,!1);case"values":return zh(i.value,!1)}return zh([i.key,i.value],!1)}),!0),gI=function(t){this.entries=[],this.url=null,t!==void 0&&(iI(t)?this.parseObject(t):this.parseQuery(typeof t=="string"?Jh(t,0)==="?"?_I(t,1):t:zi(t)))};gI.prototype={type:$c,bindURL:function(t){this.url=t,this.update()},parseObject:function(t){var e,n,i,r,s,o,a,c=this.entries,d=cW(t);if(d)for(n=(e=sI(t,d)).next;!(i=qh(n,e)).done;){if(s=(r=sI(oW(i.value))).next,(o=qh(s,r)).done||(a=qh(s,r)).done||!qh(s,r).done)throw new hW("Expected sequence with length 2");na(c,{key:zi(o.value),value:zi(a.value)})}else for(var l in t)iW(t,l)&&na(c,{key:l,value:zi(t[l])})},parseQuery:function(t){if(t)for(var e,n,i=this.entries,r=pI(t,"&"),s=0;s<r.length;)(e=r[s++]).length&&(n=pI(e,"="),na(i,{key:mI(EW(n)),value:mI(lI(n,"="))}))},serialize:function(){for(var t,e=this.entries,n=[],i=0;i<e.length;)t=e[i++],na(n,EI(t.key)+"="+EI(t.value));return lI(n,"&")},update:function(){this.entries.length=0,this.parseQuery(this.url.query)},updateURL:function(){this.url&&this.url.update()}};var Qh=function(){nI(this,td);var t=aI(this,new gI(arguments.length>0?arguments[0]:void 0));Ul||(this.size=t.entries.length)},td=Qh.prototype;if(tW(td,{append:function(t,e){var n=Kr(this);Zc(arguments.length,2),na(n.entries,{key:zi(t),value:zi(e)}),Ul||this.length++,n.updateURL()},delete:function(t){for(var e=Kr(this),n=Zc(arguments.length,1),i=e.entries,r=zi(t),s=n<2?void 0:arguments[1],o=s===void 0?s:zi(s),a=0;a<i.length;){var c=i[a];if(c.key!==r||o!==void 0&&c.value!==o)a++;else if(hI(i,a,1),o!==void 0)break}Ul||(this.size=i.length),e.updateURL()},get:function(t){var e=Kr(this).entries;Zc(arguments.length,1);for(var n=zi(t),i=0;i<e.length;i++)if(e[i].key===n)return e[i].value;return null},getAll:function(t){var e=Kr(this).entries;Zc(arguments.length,1);for(var n=zi(t),i=[],r=0;r<e.length;r++)e[r].key===n&&na(i,e[r].value);return i},has:function(t){for(var e=Kr(this).entries,n=Zc(arguments.length,1),i=zi(t),r=n<2?void 0:arguments[1],s=r===void 0?r:zi(r),o=0;o<e.length;){var a=e[o++];if(a.key===i&&(s===void 0||a.value===s))return!0}return!1},set:function(t,e){var n=Kr(this);Zc(arguments.length,1);for(var i,r=n.entries,s=!1,o=zi(t),a=zi(e),c=0;c<r.length;c++)(i=r[c]).key===o&&(s?hI(r,c--,1):(s=!0,i.value=a));s||na(r,{key:o,value:a}),Ul||(this.size=r.length),n.updateURL()},sort:function(){var t=Kr(this);dW(t.entries,(function(e,n){return e.key>n.key?1:-1})),t.updateURL()},forEach:function(t){for(var e,n=Kr(this).entries,i=rW(t,arguments.length>1?arguments[1]:void 0),r=0;r<n.length;)i((e=n[r++]).value,e.key,this)},keys:function(){return new mE(this,"keys")},values:function(){return new mE(this,"values")},entries:function(){return new mE(this,"entries")}},{enumerable:!0}),eI(td,lW,td.entries,{}),eI(td,"toString",(function(){return Kr(this).serialize()}),{enumerable:!0}),Ul&&$3(td,"size",{get:function(){return Kr(this).entries.length},configurable:!0,enumerable:!0}),eW(Qh,$c),uE({global:!0,forced:!tI},{URLSearchParams:Qh}),!tI&&_E(xl)){var bW=_s(dI.has),AW=_s(dI.set),SI=function(t){if(iI(t)){var e,n=t.body;if(sW(n)===$c)return e=t.headers?new xl(t.headers):new xl,bW(e,"content-type")||AW(e,"content-type","application/x-www-form-urlencoded;charset=UTF-8"),aW(t,{body:rI(0,zi(n)),headers:rI(0,e)})}return t};if(_E(cI)&&uE({global:!0,dontCallGetSet:!0,forced:!0},{fetch:function(t){return cI(t,arguments.length>1?SI(arguments[1]):{})}}),_E(Xh)){var EE=function(t){return nI(this,fE),new Xh(t,arguments.length>1?SI(arguments[1]):{})};fE.constructor=EE,EE.prototype=fE,uE({global:!0,dontCallGetSet:!0,forced:!0},{Request:EE})}}var Yr,wW={URLSearchParams:Qh,getState:Kr},OW=It.URLSearchParams,TI=zn,NW=W,DW=ue,PW=O,gE=yh,LW=Il,kW=ze,MW=Ws,UW=kt,ed=Object.assign,RI=Object.defineProperty,xW=NW([].concat),VW=!ed||PW((function(){if(TI&&ed({b:1},ed(RI({},"a",{enumerable:!0,get:function(){RI(this,"b",{value:3,enumerable:!1})}}),{b:2})).b!==1)return!0;var t={},e={},n=Symbol("assign detection"),i="abcdefghijklmnopqrst";return t[n]=7,i.split("").forEach((function(r){e[r]=r})),ed({},t)[n]!==7||gE(ed({},e)).join("")!==i}))?function(t,e){for(var n=MW(t),i=arguments.length,r=1,s=LW.f,o=kW.f;i>r;)for(var a,c=UW(arguments[r++]),d=s?xW(gE(c),s(c)):gE(c),l=d.length,h=0;l>h;)a=d[h++],TI&&!DW(o,c,a)||(n[a]=c[a]);return n}:ed,FW=Ki,BW=aC,jW=zn,GW=Hr,WW=Hi,SE=function(t,e,n){jW?GW.f(t,e,WW(0,n)):t[e]=n},HW=Xo,KW=ue,YW=Ws,qW=function(t,e,n,i){try{return i?e(FW(n)[0],n[1]):e(n)}catch(r){BW(t,"throw",r)}},zW=rC,XW=Vh,JW=Jo,vI=SE,QW=Em,ZW=Ah,CI=Array,Ba=W,TE=2147483647,$W=/[^\0-\u007E]/,yI=/[.\u3002\uFF0E\uFF61]/g,II="Overflow: input needs wider integers to process",bI=RangeError,t5=Ba(yI.exec),nd=Math.floor,RE=String.fromCharCode,AI=Ba("".charCodeAt),wI=Ba([].join),ia=Ba([].push),e5=Ba("".replace),n5=Ba("".split),i5=Ba("".toLowerCase),OI=function(t){return t+22+75*(t<26)},r5=function(t,e,n){var i=0;for(t=n?nd(t/700):t>>1,t+=nd(t/e);t>455;)t=nd(t/35),i+=36;return nd(i+36*t/(t+38))},s5=function(t){var e=[];t=(function(b){for(var w=[],D=0,k=b.length;D<k;){var U=AI(b,D++);if(U>=55296&&U<=56319&&D<k){var P=AI(b,D++);(64512&P)==56320?ia(w,((1023&U)<<10)+(1023&P)+65536):(ia(w,U),D--)}else ia(w,U)}return w})(t);var n,i,r=t.length,s=128,o=0,a=72;for(n=0;n<t.length;n++)(i=t[n])<128&&ia(e,RE(i));var c=e.length,d=c;for(c&&ia(e,"-");d<r;){var l=TE;for(n=0;n<t.length;n++)(i=t[n])>=s&&i<l&&(l=i);var h=d+1;if(l-s>nd((TE-o)/h))throw new bI(II);for(o+=(l-s)*h,s=l,n=0;n<t.length;n++){if((i=t[n])<s&&++o>TE)throw new bI(II);if(i===s){for(var p=o,f=36;;){var v=f<=a?1:f>=a+26?26:f-a;if(p<v)break;var S=p-v,T=36-v;ia(e,RE(OI(v+S%T))),p=nd(S/T),f+=36}ia(e,RE(OI(p))),a=r5(o,h,d===c),o=0,d++}}o++,s++}return wI(e,"")},o5=ge,vE=zn,a5=Yh,CE=vt,NI=Xo,qr=W,Zh=Zo,zr=xh,c5=wm,yE=ii,IE=VW,id=function(t){var e=YW(t),n=XW(this),i=arguments.length,r=i>1?arguments[1]:void 0,s=r!==void 0;s&&(r=HW(r,i>2?arguments[2]:void 0));var o,a,c,d,l,h,p=ZW(e),f=0;if(!p||this===CI&&zW(p))for(o=JW(e),a=n?new this(o):CI(o);o>f;f++)h=s?r(e[f],f):e[f],vI(a,f,h);else for(a=n?new this:[],l=(d=QW(e,p)).next;!(c=KW(l,d)).done;f++)h=s?qW(d,r,[c.value,f],!0):c.value,vI(a,f,h);return a.length=f,a},fs=$o,d5=sE.codeAt,l5=function(t){var e,n,i=[],r=n5(e5(i5(t),yI,"."),".");for(e=0;e<r.length;e++)n=r[e],ia(i,t5($W,n)?"xn--"+s5(n):n);return wI(i,".")},yo=Yi,u5=Co,h5=xa,DI=wW,PI=Ua,p5=PI.set,$h=PI.getterFor("URL"),_5=DI.URLSearchParams,f5=DI.getState,Vl=CE.URL,bE=CE.TypeError,tp=CE.parseInt,m5=Math.floor,LI=Math.pow,Xr=qr("".charAt),ms=qr(/./.exec),Fl=qr([].join),E5=qr(1.1.toString),g5=qr([].pop),rd=qr([].push),AE=qr("".replace),S5=qr([].shift),T5=qr("".split),Bl=qr("".slice),ep=qr("".toLowerCase),R5=qr([].unshift),wE="Invalid scheme",ja="Invalid host",kI="Invalid port",MI=/[a-z]/i,v5=/[\d+-.a-z]/i,OE=/\d/,C5=/^0x/i,y5=/^[0-7]+$/,I5=/^\d+$/,UI=/^[\da-f]+$/i,b5=/[\0\t\n\r #%/:<>?@[\\\]^|]/,A5=/[\0\t\n\r #/:<>?@[\\\]^|]/,w5=/^[\u0000-\u0020]+/,O5=/(^|[^\u0000-\u0020])[\u0000-\u0020]+$/,N5=/[\t\n\r]/g,jl=function(t){var e,n,i,r;if(typeof t=="number"){for(e=[],n=0;n<4;n++)R5(e,t%256),t=m5(t/256);return Fl(e,".")}if(typeof t=="object"){for(e="",i=(function(s){for(var o=null,a=1,c=null,d=0,l=0;l<8;l++)s[l]!==0?(d>a&&(o=c,a=d),c=null,d=0):(c===null&&(c=l),++d);return d>a?c:o})(t),n=0;n<8;n++)r&&t[n]===0||(r&&(r=!1),i===n?(e+=n?":":"::",r=!0):(e+=E5(t[n],16),n<7&&(e+=":")));return"["+e+"]"}return t},np={},xI=IE({},np,{" ":1,'"':1,"<":1,">":1,"`":1}),VI=IE({},xI,{"#":1,"?":1,"{":1,"}":1}),NE=IE({},VI,{"/":1,":":1,";":1,"=":1,"@":1,"[":1,"\\":1,"]":1,"^":1,"|":1}),ra=function(t,e){var n=d5(t,0);return n>32&&n<127&&!yE(e,t)?t:encodeURIComponent(t)},ip={ftp:21,file:null,http:80,https:443,ws:80,wss:443},Gl=function(t,e){var n;return t.length===2&&ms(MI,Xr(t,0))&&((n=Xr(t,1))===":"||!e&&n==="|")},FI=function(t){var e;return t.length>1&&Gl(Bl(t,0,2))&&(t.length===2||(e=Xr(t,2))==="/"||e==="\\"||e==="?"||e==="#")},D5=function(t){return t==="."||ep(t)==="%2e"},DE={},BI={},PE={},jI={},GI={},LE={},WI={},HI={},rp={},sp={},kE={},ME={},UE={},xE={},KI={},VE={},sd={},Ys={},YI={},Ga={},Io={},FE=function(t,e,n){var i,r,s,o=yo(t);if(e){if(r=this.parse(o))throw new bE(r);this.searchParams=null}else{if(n!==void 0&&(i=new FE(n,!0)),r=this.parse(o,null,i))throw new bE(r);(s=f5(new _5)).bindURL(this),this.searchParams=s}};FE.prototype={type:"URL",parse:function(t,e,n){var i,r,s,o,a,c=this,d=e||DE,l=0,h="",p=!1,f=!1,v=!1;for(t=yo(t),e||(c.scheme="",c.username="",c.password="",c.host=null,c.port=null,c.path=[],c.query=null,c.fragment=null,c.cannotBeABaseURL=!1,t=AE(t,w5,""),t=AE(t,O5,"$1")),t=AE(t,N5,""),i=id(t);l<=i.length;){switch(r=i[l],d){case DE:if(!r||!ms(MI,r)){if(e)return wE;d=PE;continue}h+=ep(r),d=BI;break;case BI:if(r&&(ms(v5,r)||r==="+"||r==="-"||r==="."))h+=ep(r);else{if(r!==":"){if(e)return wE;h="",d=PE,l=0;continue}if(e&&(c.isSpecial()!==yE(ip,h)||h==="file"&&(c.includesCredentials()||c.port!==null)||c.scheme==="file"&&!c.host))return;if(c.scheme=h,e)return void(c.isSpecial()&&ip[c.scheme]===c.port&&(c.port=null));h="",c.scheme==="file"?d=xE:c.isSpecial()&&n&&n.scheme===c.scheme?d=jI:c.isSpecial()?d=HI:i[l+1]==="/"?(d=GI,l++):(c.cannotBeABaseURL=!0,rd(c.path,""),d=YI)}break;case PE:if(!n||n.cannotBeABaseURL&&r!=="#")return wE;if(n.cannotBeABaseURL&&r==="#"){c.scheme=n.scheme,c.path=fs(n.path),c.query=n.query,c.fragment="",c.cannotBeABaseURL=!0,d=Io;break}d=n.scheme==="file"?xE:LE;continue;case jI:if(r!=="/"||i[l+1]!=="/"){d=LE;continue}d=rp,l++;break;case GI:if(r==="/"){d=sp;break}d=Ys;continue;case LE:if(c.scheme=n.scheme,r===Yr)c.username=n.username,c.password=n.password,c.host=n.host,c.port=n.port,c.path=fs(n.path),c.query=n.query;else if(r==="/"||r==="\\"&&c.isSpecial())d=WI;else if(r==="?")c.username=n.username,c.password=n.password,c.host=n.host,c.port=n.port,c.path=fs(n.path),c.query="",d=Ga;else{if(r!=="#"){c.username=n.username,c.password=n.password,c.host=n.host,c.port=n.port,c.path=fs(n.path),c.path.length--,d=Ys;continue}c.username=n.username,c.password=n.password,c.host=n.host,c.port=n.port,c.path=fs(n.path),c.query=n.query,c.fragment="",d=Io}break;case WI:if(!c.isSpecial()||r!=="/"&&r!=="\\"){if(r!=="/"){c.username=n.username,c.password=n.password,c.host=n.host,c.port=n.port,d=Ys;continue}d=sp}else d=rp;break;case HI:if(d=rp,r!=="/"||Xr(h,l+1)!=="/")continue;l++;break;case rp:if(r!=="/"&&r!=="\\"){d=sp;continue}break;case sp:if(r==="@"){p&&(h="%40"+h),p=!0,s=id(h);for(var S=0;S<s.length;S++){var T=s[S];if(T!==":"||v){var b=ra(T,NE);v?c.password+=b:c.username+=b}else v=!0}h=""}else if(r===Yr||r==="/"||r==="?"||r==="#"||r==="\\"&&c.isSpecial()){if(p&&h==="")return"Invalid authority";l-=id(h).length+1,h="",d=kE}else h+=r;break;case kE:case ME:if(e&&c.scheme==="file"){d=VE;continue}if(r!==":"||f){if(r===Yr||r==="/"||r==="?"||r==="#"||r==="\\"&&c.isSpecial()){if(c.isSpecial()&&h==="")return ja;if(e&&h===""&&(c.includesCredentials()||c.port!==null))return;if(o=c.parseHost(h))return o;if(h="",d=sd,e)return;continue}r==="["?f=!0:r==="]"&&(f=!1),h+=r}else{if(h==="")return ja;if(o=c.parseHost(h))return o;if(h="",d=UE,e===ME)return}break;case UE:if(!ms(OE,r)){if(r===Yr||r==="/"||r==="?"||r==="#"||r==="\\"&&c.isSpecial()||e){if(h!==""){var w=tp(h,10);if(w>65535)return kI;c.port=c.isSpecial()&&w===ip[c.scheme]?null:w,h=""}if(e)return;d=sd;continue}return kI}h+=r;break;case xE:if(c.scheme="file",r==="/"||r==="\\")d=KI;else{if(!n||n.scheme!=="file"){d=Ys;continue}switch(r){case Yr:c.host=n.host,c.path=fs(n.path),c.query=n.query;break;case"?":c.host=n.host,c.path=fs(n.path),c.query="",d=Ga;break;case"#":c.host=n.host,c.path=fs(n.path),c.query=n.query,c.fragment="",d=Io;break;default:FI(Fl(fs(i,l),""))||(c.host=n.host,c.path=fs(n.path),c.shortenPath()),d=Ys;continue}}break;case KI:if(r==="/"||r==="\\"){d=VE;break}n&&n.scheme==="file"&&!FI(Fl(fs(i,l),""))&&(Gl(n.path[0],!0)?rd(c.path,n.path[0]):c.host=n.host),d=Ys;continue;case VE:if(r===Yr||r==="/"||r==="\\"||r==="?"||r==="#"){if(!e&&Gl(h))d=Ys;else if(h===""){if(c.host="",e)return;d=sd}else{if(o=c.parseHost(h))return o;if(c.host==="localhost"&&(c.host=""),e)return;h="",d=sd}continue}h+=r;break;case sd:if(c.isSpecial()){if(d=Ys,r!=="/"&&r!=="\\")continue}else if(e||r!=="?")if(e||r!=="#"){if(r!==Yr&&(d=Ys,r!=="/"))continue}else c.fragment="",d=Io;else c.query="",d=Ga;break;case Ys:if(r===Yr||r==="/"||r==="\\"&&c.isSpecial()||!e&&(r==="?"||r==="#")){if((a=ep(a=h))===".."||a==="%2e."||a===".%2e"||a==="%2e%2e"?(c.shortenPath(),r==="/"||r==="\\"&&c.isSpecial()||rd(c.path,"")):D5(h)?r==="/"||r==="\\"&&c.isSpecial()||rd(c.path,""):(c.scheme==="file"&&!c.path.length&&Gl(h)&&(c.host&&(c.host=""),h=Xr(h,0)+":"),rd(c.path,h)),h="",c.scheme==="file"&&(r===Yr||r==="?"||r==="#"))for(;c.path.length>1&&c.path[0]==="";)S5(c.path);r==="?"?(c.query="",d=Ga):r==="#"&&(c.fragment="",d=Io)}else h+=ra(r,VI);break;case YI:r==="?"?(c.query="",d=Ga):r==="#"?(c.fragment="",d=Io):r!==Yr&&(c.path[0]+=ra(r,np));break;case Ga:e||r!=="#"?r!==Yr&&(r==="'"&&c.isSpecial()?c.query+="%27":c.query+=r==="#"?"%23":ra(r,np)):(c.fragment="",d=Io);break;case Io:r!==Yr&&(c.fragment+=ra(r,xI))}l++}},parseHost:function(t){var e,n,i;if(Xr(t,0)==="["){if(Xr(t,t.length-1)!=="]"||(e=(function(r){var s,o,a,c,d,l,h,p=[0,0,0,0,0,0,0,0],f=0,v=null,S=0,T=function(){return Xr(r,S)};if(T()===":"){if(Xr(r,1)!==":")return;S+=2,v=++f}for(;T();){if(f===8)return;if(T()!==":"){for(s=o=0;o<4&&ms(UI,T());)s=16*s+tp(T(),16),S++,o++;if(T()==="."){if(o===0||(S-=o,f>6))return;for(a=0;T();){if(c=null,a>0){if(!(T()==="."&&a<4))return;S++}if(!ms(OE,T()))return;for(;ms(OE,T());){if(d=tp(T(),10),c===null)c=d;else{if(c===0)return;c=10*c+d}if(c>255)return;S++}p[f]=256*p[f]+c,++a!=2&&a!==4||f++}if(a!==4)return;break}if(T()===":"){if(S++,!T())return}else if(T())return;p[f++]=s}else{if(v!==null)return;S++,v=++f}}if(v!==null)for(l=f-v,f=7;f!==0&&l>0;)h=p[f],p[f--]=p[v+l-1],p[v+--l]=h;else if(f!==8)return;return p})(Bl(t,1,-1)),!e))return ja;this.host=e}else if(this.isSpecial()){if(t=l5(t),ms(b5,t)||(e=(function(r){var s,o,a,c,d,l,h,p=T5(r,".");if(p.length&&p[p.length-1]===""&&p.length--,(s=p.length)>4)return r;for(o=[],a=0;a<s;a++){if((c=p[a])==="")return r;if(d=10,c.length>1&&Xr(c,0)==="0"&&(d=ms(C5,c)?16:8,c=Bl(c,d===8?1:2)),c==="")l=0;else{if(!ms(d===10?I5:d===8?y5:UI,c))return r;l=tp(c,d)}rd(o,l)}for(a=0;a<s;a++)if(l=o[a],a===s-1){if(l>=LI(256,5-s))return null}else if(l>255)return null;for(h=g5(o),a=0;a<o.length;a++)h+=o[a]*LI(256,3-a);return h})(t),e===null))return ja;this.host=e}else{if(ms(A5,t))return ja;for(e="",n=id(t),i=0;i<n.length;i++)e+=ra(n[i],np);this.host=e}},cannotHaveUsernamePasswordPort:function(){return!this.host||this.cannotBeABaseURL||this.scheme==="file"},includesCredentials:function(){return this.username!==""||this.password!==""},isSpecial:function(){return yE(ip,this.scheme)},shortenPath:function(){var t=this.path,e=t.length;!e||this.scheme==="file"&&e===1&&Gl(t[0],!0)||t.length--},serialize:function(){var t=this,e=t.scheme,n=t.username,i=t.password,r=t.host,s=t.port,o=t.path,a=t.query,c=t.fragment,d=e+":";return r!==null?(d+="//",t.includesCredentials()&&(d+=n+(i?":"+i:"")+"@"),d+=jl(r),s!==null&&(d+=":"+s)):e==="file"&&(d+="//"),d+=t.cannotBeABaseURL?o[0]:o.length?"/"+Fl(o,"/"):"",a!==null&&(d+="?"+a),c!==null&&(d+="#"+c),d},setHref:function(t){var e=this.parse(t);if(e)throw new bE(e);this.searchParams.update()},getOrigin:function(){var t=this.scheme,e=this.port;if(t==="blob")try{return new od(t.path[0]).origin}catch{return"null"}return t!=="file"&&this.isSpecial()?t+"://"+jl(this.host)+(e!==null?":"+e:""):"null"},getProtocol:function(){return this.scheme+":"},setProtocol:function(t){this.parse(yo(t)+":",DE)},getUsername:function(){return this.username},setUsername:function(t){var e=id(yo(t));if(!this.cannotHaveUsernamePasswordPort()){this.username="";for(var n=0;n<e.length;n++)this.username+=ra(e[n],NE)}},getPassword:function(){return this.password},setPassword:function(t){var e=id(yo(t));if(!this.cannotHaveUsernamePasswordPort()){this.password="";for(var n=0;n<e.length;n++)this.password+=ra(e[n],NE)}},getHost:function(){var t=this.host,e=this.port;return t===null?"":e===null?jl(t):jl(t)+":"+e},setHost:function(t){this.cannotBeABaseURL||this.parse(t,kE)},getHostname:function(){var t=this.host;return t===null?"":jl(t)},setHostname:function(t){this.cannotBeABaseURL||this.parse(t,ME)},getPort:function(){var t=this.port;return t===null?"":yo(t)},setPort:function(t){this.cannotHaveUsernamePasswordPort()||((t=yo(t))===""?this.port=null:this.parse(t,UE))},getPathname:function(){var t=this.path;return this.cannotBeABaseURL?t[0]:t.length?"/"+Fl(t,"/"):""},setPathname:function(t){this.cannotBeABaseURL||(this.path=[],this.parse(t,sd))},getSearch:function(){var t=this.query;return t?"?"+t:""},setSearch:function(t){(t=yo(t))===""?this.query=null:(Xr(t,0)==="?"&&(t=Bl(t,1)),this.query="",this.parse(t,Ga)),this.searchParams.update()},getSearchParams:function(){return this.searchParams.facade},getHash:function(){var t=this.fragment;return t?"#"+t:""},setHash:function(t){(t=yo(t))!==""?(Xr(t,0)==="#"&&(t=Bl(t,1)),this.fragment="",this.parse(t,Io)):this.fragment=null},update:function(){this.query=this.searchParams.serialize()||null}};var od=function(t){var e=c5(this,Xi),n=h5(arguments.length,1)>1?arguments[1]:void 0,i=p5(e,new FE(t,!1,n));vE||(e.href=i.serialize(),e.origin=i.getOrigin(),e.protocol=i.getProtocol(),e.username=i.getUsername(),e.password=i.getPassword(),e.host=i.getHost(),e.hostname=i.getHostname(),e.port=i.getPort(),e.pathname=i.getPathname(),e.search=i.getSearch(),e.searchParams=i.getSearchParams(),e.hash=i.getHash())},Xi=od.prototype,Jr=function(t,e){return{get:function(){return $h(this)[t]()},set:e&&function(n){return $h(this)[e](n)},configurable:!0,enumerable:!0}};if(vE&&(zr(Xi,"href",Jr("serialize","setHref")),zr(Xi,"origin",Jr("getOrigin")),zr(Xi,"protocol",Jr("getProtocol","setProtocol")),zr(Xi,"username",Jr("getUsername","setUsername")),zr(Xi,"password",Jr("getPassword","setPassword")),zr(Xi,"host",Jr("getHost","setHost")),zr(Xi,"hostname",Jr("getHostname","setHostname")),zr(Xi,"port",Jr("getPort","setPort")),zr(Xi,"pathname",Jr("getPathname","setPathname")),zr(Xi,"search",Jr("getSearch","setSearch")),zr(Xi,"searchParams",Jr("getSearchParams")),zr(Xi,"hash",Jr("getHash","setHash"))),Zh(Xi,"toJSON",(function(){return $h(this).serialize()}),{enumerable:!0}),Zh(Xi,"toString",(function(){return $h(this).serialize()}),{enumerable:!0}),Vl){var qI=Vl.createObjectURL,zI=Vl.revokeObjectURL;qI&&Zh(od,"createObjectURL",NI(qI,Vl)),zI&&Zh(od,"revokeObjectURL",NI(zI,Vl))}u5(od,"URL"),o5({global:!0,forced:!a5,sham:!vE},{URL:od});var P5=ge,XI=O,L5=xa,JI=Yi,k5=Yh,BE=jt("URL"),M5=k5&&XI((function(){BE.canParse()})),U5=XI((function(){return BE.canParse.length!==1}));P5({target:"URL",stat:!0,forced:!M5||U5},{canParse:function(t){var e=L5(arguments.length,1),n=JI(t),i=e<2||arguments[1]===void 0?void 0:JI(arguments[1]);try{return!!new BE(n,i)}catch{return!1}}});var x5=ge,V5=xa,QI=Yi,F5=Yh,B5=jt("URL");x5({target:"URL",stat:!0,forced:!F5},{parse:function(t){var e=V5(arguments.length,1),n=QI(t),i=e<2||arguments[1]===void 0?void 0:QI(arguments[1]);try{return new B5(n,i)}catch{return null}}});var op=y(It.URL);let ZI=!0,$I=!0;function ap(t,e,n){const i=t.match(e);return i&&i.length>=n&&parseInt(i[n],10)}function Wa(t,e,n){if(!t.RTCPeerConnection)return;const i=t.RTCPeerConnection.prototype,r=i.addEventListener;i.addEventListener=function(o,a){if(o!==e)return r.apply(this,arguments);const c=d=>{const l=n(d);l&&(a.handleEvent?a.handleEvent(l):a(l))};return this._eventMap=this._eventMap||{},this._eventMap[e]||(this._eventMap[e]=new Map),this._eventMap[e].set(a,c),r.apply(this,[o,c])};const s=i.removeEventListener;i.removeEventListener=function(o,a){if(o!==e||!this._eventMap||!this._eventMap[e])return s.apply(this,arguments);if(!this._eventMap[e].has(a))return s.apply(this,arguments);const c=this._eventMap[e].get(a);return this._eventMap[e].delete(a),this._eventMap[e].size===0&&delete this._eventMap[e],Object.keys(this._eventMap).length===0&&delete this._eventMap,s.apply(this,[o,c])},Object.defineProperty(i,"on"+e,{get(){return this["_on"+e]},set(o){this["_on"+e]&&(this.removeEventListener(e,this["_on"+e]),delete this["_on"+e]),o&&this.addEventListener(e,this["_on"+e]=o)},enumerable:!0,configurable:!0})}function j5(t){return typeof t!="boolean"?new Error("Argument type: "+typeof t+". Please use a boolean."):(ZI=t,t?"adapter.js logging disabled":"adapter.js logging enabled")}function G5(t){return typeof t!="boolean"?new Error("Argument type: "+typeof t+". Please use a boolean."):($I=!t,"adapter.js deprecation warnings "+(t?"disabled":"enabled"))}function tb(){if(typeof window=="object"){if(ZI)return;typeof console<"u"&&typeof console.log=="function"&&console.log.apply(console,arguments)}}function jE(t,e){$I&&console.warn(t+" is deprecated, please use "+e+" instead.")}function eb(t){return Object.prototype.toString.call(t)==="[object Object]"}function nb(t){var e;return eb(t)?Ir(e=Object.keys(t)).call(e,(function(n,i){const r=eb(t[i]),s=r?nb(t[i]):t[i],o=r&&!Object.keys(s).length;return s===void 0||o?n:Object.assign(n,{[i]:s})}),{}):t}function GE(t,e,n){e&&!n.has(e.id)&&(n.set(e.id,e),Object.keys(e).forEach((i=>{i.endsWith("Id")?GE(t,t.get(e[i]),n):i.endsWith("Ids")&&e[i].forEach((r=>{GE(t,t.get(r),n)}))})))}function ib(t,e,n){const i=n?"outbound-rtp":"inbound-rtp",r=new Map;if(e===null)return r;const s=[];return t.forEach((o=>{o.type==="track"&&o.trackIdentifier===e.id&&s.push(o)})),s.forEach((o=>{t.forEach((a=>{a.type===i&&a.trackId===o.id&&GE(t,a,r)}))})),r}const rb=tb;function sb(t,e){const n=t&&t.navigator;if(!n.mediaDevices)return;const i=function(o){if(typeof o!="object"||o.mandatory||o.optional)return o;const a={};return Object.keys(o).forEach((c=>{if(c==="require"||c==="advanced"||c==="mediaSource")return;const d=typeof o[c]=="object"?o[c]:{ideal:o[c]};d.exact!==void 0&&typeof d.exact=="number"&&(d.min=d.max=d.exact);const l=function(h,p){return h?h+p.charAt(0).toUpperCase()+p.slice(1):p==="deviceId"?"sourceId":p};if(d.ideal!==void 0){a.optional=a.optional||[];let h={};typeof d.ideal=="number"?(h[l("min",c)]=d.ideal,a.optional.push(h),h={},h[l("max",c)]=d.ideal,a.optional.push(h)):(h[l("",c)]=d.ideal,a.optional.push(h))}d.exact!==void 0&&typeof d.exact!="number"?(a.mandatory=a.mandatory||{},a.mandatory[l("",c)]=d.exact):["min","max"].forEach((h=>{d[h]!==void 0&&(a.mandatory=a.mandatory||{},a.mandatory[l(h,c)]=d[h])}))})),o.advanced&&(a.optional=(a.optional||[]).concat(o.advanced)),a},r=function(o,a){if(e.version>=61)return a(o);if((o=JSON.parse(JSON.stringify(o)))&&typeof o.audio=="object"){const c=function(d,l,h){l in d&&!(h in d)&&(d[h]=d[l],delete d[l])};c((o=JSON.parse(JSON.stringify(o))).audio,"autoGainControl","googAutoGainControl"),c(o.audio,"noiseSuppression","googNoiseSuppression"),o.audio=i(o.audio)}if(o&&typeof o.video=="object"){let c=o.video.facingMode;c=c&&(typeof c=="object"?c:{ideal:c});const d=e.version<66;if(c&&(c.exact==="user"||c.exact==="environment"||c.ideal==="user"||c.ideal==="environment")&&(!n.mediaDevices.getSupportedConstraints||!n.mediaDevices.getSupportedConstraints().facingMode||d)){let l;if(delete o.video.facingMode,c.exact==="environment"||c.ideal==="environment"?l=["back","rear"]:c.exact!=="user"&&c.ideal!=="user"||(l=["front"]),l)return n.mediaDevices.enumerateDevices().then((h=>{h=h.filter((f=>f.kind==="videoinput"));let p=h.find((f=>l.some((v=>{var S;return $(S=f.label.toLowerCase()).call(S,v)}))));return!p&&h.length&&$(l).call(l,"back")&&(p=h[h.length-1]),p&&(o.video.deviceId=c.exact?{exact:p.deviceId}:{ideal:p.deviceId}),o.video=i(o.video),rb("chrome: "+JSON.stringify(o)),a(o)}))}o.video=i(o.video)}return rb("chrome: "+JSON.stringify(o)),a(o)},s=function(o){return e.version>=64?o:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[o.name]||o.name,message:o.message,constraint:o.constraint||o.constraintName,toString(){return this.name+(this.message&&": ")+this.message}}};if(n.getUserMedia=(function(o,a,c){r(o,(d=>{n.webkitGetUserMedia(d,a,(l=>{c&&c(s(l))}))}))}).bind(n),n.mediaDevices.getUserMedia){const o=n.mediaDevices.getUserMedia.bind(n.mediaDevices);n.mediaDevices.getUserMedia=function(a){return r(a,(c=>o(c).then((d=>{if(c.audio&&!d.getAudioTracks().length||c.video&&!d.getVideoTracks().length)throw d.getTracks().forEach((l=>{l.stop()})),new DOMException("","NotFoundError");return d}),(d=>st.reject(s(d))))))}}}function ob(t){t.MediaStream=t.MediaStream||t.webkitMediaStream}function ab(t){if(typeof t=="object"&&t.RTCPeerConnection&&!("ontrack"in t.RTCPeerConnection.prototype)){Object.defineProperty(t.RTCPeerConnection.prototype,"ontrack",{get(){return this._ontrack},set(n){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=n)},enumerable:!0,configurable:!0});const e=t.RTCPeerConnection.prototype.setRemoteDescription;t.RTCPeerConnection.prototype.setRemoteDescription=function(){return this._ontrackpoly||(this._ontrackpoly=n=>{n.stream.addEventListener("addtrack",(i=>{let r;r=t.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find((o=>o.track&&o.track.id===i.track.id)):{track:i.track};const s=new Event("track");s.track=i.track,s.receiver=r,s.transceiver={receiver:r},s.streams=[n.stream],this.dispatchEvent(s)})),n.stream.getTracks().forEach((i=>{let r;r=t.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find((o=>o.track&&o.track.id===i.id)):{track:i};const s=new Event("track");s.track=i,s.receiver=r,s.transceiver={receiver:r},s.streams=[n.stream],this.dispatchEvent(s)}))},this.addEventListener("addstream",this._ontrackpoly)),e.apply(this,arguments)}}else Wa(t,"track",(e=>(e.transceiver||Object.defineProperty(e,"transceiver",{value:{receiver:e.receiver}}),e)))}function cb(t){if(typeof t=="object"&&t.RTCPeerConnection&&!("getSenders"in t.RTCPeerConnection.prototype)&&"createDTMFSender"in t.RTCPeerConnection.prototype){const e=function(r,s){return{track:s,get dtmf(){return this._dtmf===void 0&&(s.kind==="audio"?this._dtmf=r.createDTMFSender(s):this._dtmf=null),this._dtmf},_pc:r}};if(!t.RTCPeerConnection.prototype.getSenders){t.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};const r=t.RTCPeerConnection.prototype.addTrack;t.RTCPeerConnection.prototype.addTrack=function(o,a){let c=r.apply(this,arguments);return c||(c=e(this,o),this._senders.push(c)),c};const s=t.RTCPeerConnection.prototype.removeTrack;t.RTCPeerConnection.prototype.removeTrack=function(o){s.apply(this,arguments);const a=this._senders.indexOf(o);a!==-1&&this._senders.splice(a,1)}}const n=t.RTCPeerConnection.prototype.addStream;t.RTCPeerConnection.prototype.addStream=function(r){this._senders=this._senders||[],n.apply(this,[r]),r.getTracks().forEach((s=>{this._senders.push(e(this,s))}))};const i=t.RTCPeerConnection.prototype.removeStream;t.RTCPeerConnection.prototype.removeStream=function(r){this._senders=this._senders||[],i.apply(this,[r]),r.getTracks().forEach((s=>{const o=this._senders.find((a=>a.track===s));o&&this._senders.splice(this._senders.indexOf(o),1)}))}}else if(typeof t=="object"&&t.RTCPeerConnection&&"getSenders"in t.RTCPeerConnection.prototype&&"createDTMFSender"in t.RTCPeerConnection.prototype&&t.RTCRtpSender&&!("dtmf"in t.RTCRtpSender.prototype)){const e=t.RTCPeerConnection.prototype.getSenders;t.RTCPeerConnection.prototype.getSenders=function(){const n=e.apply(this,[]);return n.forEach((i=>i._pc=this)),n},Object.defineProperty(t.RTCRtpSender.prototype,"dtmf",{get(){return this._dtmf===void 0&&(this.track.kind==="audio"?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}})}}function db(t){if(!t.RTCPeerConnection)return;const e=t.RTCPeerConnection.prototype.getStats;t.RTCPeerConnection.prototype.getStats=function(){const[n,i,r]=arguments;if(arguments.length>0&&typeof n=="function")return e.apply(this,arguments);if(e.length===0&&(arguments.length===0||typeof n!="function"))return e.apply(this,[]);const s=function(a){const c={};return a.result().forEach((d=>{const l={id:d.id,timestamp:d.timestamp,type:{localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[d.type]||d.type};d.names().forEach((h=>{l[h]=d.stat(h)})),c[l.id]=l})),c},o=function(a){return new Map(Object.keys(a).map((c=>[c,a[c]])))};if(arguments.length>=2){const a=function(c){i(o(s(c)))};return e.apply(this,[a,n])}return new st(((a,c)=>{e.apply(this,[function(d){a(o(s(d)))},c])})).then(i,r)}}function lb(t){if(!(typeof t=="object"&&t.RTCPeerConnection&&t.RTCRtpSender&&t.RTCRtpReceiver))return;if(!("getStats"in t.RTCRtpSender.prototype)){const n=t.RTCPeerConnection.prototype.getSenders;n&&(t.RTCPeerConnection.prototype.getSenders=function(){const r=n.apply(this,[]);return r.forEach((s=>s._pc=this)),r});const i=t.RTCPeerConnection.prototype.addTrack;i&&(t.RTCPeerConnection.prototype.addTrack=function(){const r=i.apply(this,arguments);return r._pc=this,r}),t.RTCRtpSender.prototype.getStats=function(){const r=this;return this._pc.getStats().then((s=>ib(s,r.track,!0)))}}if(!("getStats"in t.RTCRtpReceiver.prototype)){const n=t.RTCPeerConnection.prototype.getReceivers;n&&(t.RTCPeerConnection.prototype.getReceivers=function(){const i=n.apply(this,[]);return i.forEach((r=>r._pc=this)),i}),Wa(t,"track",(i=>(i.receiver._pc=i.srcElement,i))),t.RTCRtpReceiver.prototype.getStats=function(){const i=this;return this._pc.getStats().then((r=>ib(r,i.track,!1)))}}if(!("getStats"in t.RTCRtpSender.prototype)||!("getStats"in t.RTCRtpReceiver.prototype))return;const e=t.RTCPeerConnection.prototype.getStats;t.RTCPeerConnection.prototype.getStats=function(){if(arguments.length>0&&arguments[0]instanceof t.MediaStreamTrack){const n=arguments[0];let i,r,s;return this.getSenders().forEach((o=>{o.track===n&&(i?s=!0:i=o)})),this.getReceivers().forEach((o=>(o.track===n&&(r?s=!0:r=o),o.track===n))),s||i&&r?st.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):i?i.getStats():r?r.getStats():st.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return e.apply(this,arguments)}}function ub(t){t.RTCPeerConnection.prototype.getLocalStreams=function(){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map((s=>this._shimmedLocalStreams[s][0]))};const e=t.RTCPeerConnection.prototype.addTrack;t.RTCPeerConnection.prototype.addTrack=function(s,o){if(!o)return e.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};const a=e.apply(this,arguments);return this._shimmedLocalStreams[o.id]?this._shimmedLocalStreams[o.id].indexOf(a)===-1&&this._shimmedLocalStreams[o.id].push(a):this._shimmedLocalStreams[o.id]=[o,a],a};const n=t.RTCPeerConnection.prototype.addStream;t.RTCPeerConnection.prototype.addStream=function(s){this._shimmedLocalStreams=this._shimmedLocalStreams||{},s.getTracks().forEach((c=>{if(this.getSenders().find((l=>l.track===c)))throw new DOMException("Track already exists.","InvalidAccessError")}));const o=this.getSenders();n.apply(this,arguments);const a=this.getSenders().filter((c=>o.indexOf(c)===-1));this._shimmedLocalStreams[s.id]=[s].concat(a)};const i=t.RTCPeerConnection.prototype.removeStream;t.RTCPeerConnection.prototype.removeStream=function(s){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[s.id],i.apply(this,arguments)};const r=t.RTCPeerConnection.prototype.removeTrack;t.RTCPeerConnection.prototype.removeTrack=function(s){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},s&&Object.keys(this._shimmedLocalStreams).forEach((o=>{const a=this._shimmedLocalStreams[o].indexOf(s);a!==-1&&this._shimmedLocalStreams[o].splice(a,1),this._shimmedLocalStreams[o].length===1&&delete this._shimmedLocalStreams[o]})),r.apply(this,arguments)}}function hb(t,e){if(!t.RTCPeerConnection)return;if(t.RTCPeerConnection.prototype.addTrack&&e.version>=65)return ub(t);const n=t.RTCPeerConnection.prototype.getLocalStreams;t.RTCPeerConnection.prototype.getLocalStreams=function(){const c=n.apply(this);return this._reverseStreams=this._reverseStreams||{},c.map((d=>this._reverseStreams[d.id]))};const i=t.RTCPeerConnection.prototype.addStream;t.RTCPeerConnection.prototype.addStream=function(c){if(this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},c.getTracks().forEach((d=>{if(this.getSenders().find((h=>h.track===d)))throw new DOMException("Track already exists.","InvalidAccessError")})),!this._reverseStreams[c.id]){const d=new t.MediaStream(c.getTracks());this._streams[c.id]=d,this._reverseStreams[d.id]=c,c=d}i.apply(this,[c])};const r=t.RTCPeerConnection.prototype.removeStream;function s(c,d){let l=d.sdp;return Object.keys(c._reverseStreams||[]).forEach((h=>{const p=c._reverseStreams[h],f=c._streams[p.id];l=l.replace(new RegExp(f.id,"g"),p.id)})),new RTCSessionDescription({type:d.type,sdp:l})}t.RTCPeerConnection.prototype.removeStream=function(c){this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},r.apply(this,[this._streams[c.id]||c]),delete this._reverseStreams[this._streams[c.id]?this._streams[c.id].id:c.id],delete this._streams[c.id]},t.RTCPeerConnection.prototype.addTrack=function(c,d){if(this.signalingState==="closed")throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");const l=[].slice.call(arguments,1);if(l.length!==1||!l[0].getTracks().find((f=>f===c)))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");if(this.getSenders().find((f=>f.track===c)))throw new DOMException("Track already exists.","InvalidAccessError");this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{};const p=this._streams[d.id];if(p)p.addTrack(c),st.resolve().then((()=>{this.dispatchEvent(new Event("negotiationneeded"))}));else{const f=new t.MediaStream([c]);this._streams[d.id]=f,this._reverseStreams[f.id]=d,this.addStream(f)}return this.getSenders().find((f=>f.track===c))},["createOffer","createAnswer"].forEach((function(c){const d=t.RTCPeerConnection.prototype[c],l={[c](){const h=arguments;return arguments.length&&typeof arguments[0]=="function"?d.apply(this,[p=>{const f=s(this,p);h[0].apply(null,[f])},p=>{h[1]&&h[1].apply(null,p)},arguments[2]]):d.apply(this,arguments).then((p=>s(this,p)))}};t.RTCPeerConnection.prototype[c]=l[c]}));const o=t.RTCPeerConnection.prototype.setLocalDescription;t.RTCPeerConnection.prototype.setLocalDescription=function(){return arguments.length&&arguments[0].type?(arguments[0]=(function(c,d){let l=d.sdp;return Object.keys(c._reverseStreams||[]).forEach((h=>{const p=c._reverseStreams[h],f=c._streams[p.id];l=l.replace(new RegExp(p.id,"g"),f.id)})),new RTCSessionDescription({type:d.type,sdp:l})})(this,arguments[0]),o.apply(this,arguments)):o.apply(this,arguments)};const a=Object.getOwnPropertyDescriptor(t.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(t.RTCPeerConnection.prototype,"localDescription",{get(){const c=a.get.apply(this);return c.type===""?c:s(this,c)}}),t.RTCPeerConnection.prototype.removeTrack=function(c){if(this.signalingState==="closed")throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!c._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");if(c._pc!==this)throw new DOMException("Sender was not created by this connection.","InvalidAccessError");let d;this._streams=this._streams||{},Object.keys(this._streams).forEach((l=>{this._streams[l].getTracks().find((h=>c.track===h))&&(d=this._streams[l])})),d&&(d.getTracks().length===1?this.removeStream(this._reverseStreams[d.id]):d.removeTrack(c.track),this.dispatchEvent(new Event("negotiationneeded")))}}function WE(t,e){!t.RTCPeerConnection&&t.webkitRTCPeerConnection&&(t.RTCPeerConnection=t.webkitRTCPeerConnection),t.RTCPeerConnection&&e.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach((function(n){const i=t.RTCPeerConnection.prototype[n],r={[n](){return arguments[0]=new(n==="addIceCandidate"?t.RTCIceCandidate:t.RTCSessionDescription)(arguments[0]),i.apply(this,arguments)}};t.RTCPeerConnection.prototype[n]=r[n]}))}function pb(t,e){Wa(t,"negotiationneeded",(n=>{const i=n.target;if(!(e.version<72||i.getConfiguration&&i.getConfiguration().sdpSemantics==="plan-b")||i.signalingState==="stable")return n}))}var _b=Object.freeze({__proto__:null,fixNegotiationNeeded:pb,shimAddTrackRemoveTrack:hb,shimAddTrackRemoveTrackWithNative:ub,shimGetDisplayMedia:function(t,e){t.navigator.mediaDevices&&"getDisplayMedia"in t.navigator.mediaDevices||t.navigator.mediaDevices&&(typeof e=="function"?t.navigator.mediaDevices.getDisplayMedia=function(n){return e(n).then((i=>{const r=n.video&&n.video.width,s=n.video&&n.video.height,o=n.video&&n.video.frameRate;return n.video={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:i,maxFrameRate:o||3}},r&&(n.video.mandatory.maxWidth=r),s&&(n.video.mandatory.maxHeight=s),t.navigator.mediaDevices.getUserMedia(n)}))}:console.error("shimGetDisplayMedia: getSourceId argument is not a function"))},shimGetSendersWithDtmf:cb,shimGetStats:db,shimGetUserMedia:sb,shimMediaStream:ob,shimOnTrack:ab,shimPeerConnection:WE,shimSenderReceiverGetStats:lb});function fb(t,e){const n=t&&t.navigator,i=t&&t.MediaStreamTrack;if(n.getUserMedia=function(r,s,o){jE("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),n.mediaDevices.getUserMedia(r).then(s,o)},!(e.version>55&&"autoGainControl"in n.mediaDevices.getSupportedConstraints())){const r=function(o,a,c){a in o&&!(c in o)&&(o[c]=o[a],delete o[a])},s=n.mediaDevices.getUserMedia.bind(n.mediaDevices);if(n.mediaDevices.getUserMedia=function(o){return typeof o=="object"&&typeof o.audio=="object"&&(o=JSON.parse(JSON.stringify(o)),r(o.audio,"autoGainControl","mozAutoGainControl"),r(o.audio,"noiseSuppression","mozNoiseSuppression")),s(o)},i&&i.prototype.getSettings){const o=i.prototype.getSettings;i.prototype.getSettings=function(){const a=o.apply(this,arguments);return r(a,"mozAutoGainControl","autoGainControl"),r(a,"mozNoiseSuppression","noiseSuppression"),a}}if(i&&i.prototype.applyConstraints){const o=i.prototype.applyConstraints;i.prototype.applyConstraints=function(a){return this.kind==="audio"&&typeof a=="object"&&(a=JSON.parse(JSON.stringify(a)),r(a,"autoGainControl","mozAutoGainControl"),r(a,"noiseSuppression","mozNoiseSuppression")),o.apply(this,[a])}}}}function mb(t){typeof t=="object"&&t.RTCTrackEvent&&"receiver"in t.RTCTrackEvent.prototype&&!("transceiver"in t.RTCTrackEvent.prototype)&&Object.defineProperty(t.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function HE(t,e){if(typeof t!="object"||!t.RTCPeerConnection&&!t.mozRTCPeerConnection)return;!t.RTCPeerConnection&&t.mozRTCPeerConnection&&(t.RTCPeerConnection=t.mozRTCPeerConnection),e.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach((function(r){const s=t.RTCPeerConnection.prototype[r],o={[r](){return arguments[0]=new(r==="addIceCandidate"?t.RTCIceCandidate:t.RTCSessionDescription)(arguments[0]),s.apply(this,arguments)}};t.RTCPeerConnection.prototype[r]=o[r]}));const n={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},i=t.RTCPeerConnection.prototype.getStats;t.RTCPeerConnection.prototype.getStats=function(){const[r,s,o]=arguments;return i.apply(this,[r||null]).then((a=>{if(e.version<53&&!s)try{a.forEach((c=>{c.type=n[c.type]||c.type}))}catch(c){if(c.name!=="TypeError")throw c;a.forEach(((d,l)=>{a.set(l,Object.assign({},d,{type:n[d.type]||d.type}))}))}return a})).then(s,o)}}function Eb(t){if(typeof t!="object"||!t.RTCPeerConnection||!t.RTCRtpSender||t.RTCRtpSender&&"getStats"in t.RTCRtpSender.prototype)return;const e=t.RTCPeerConnection.prototype.getSenders;e&&(t.RTCPeerConnection.prototype.getSenders=function(){const i=e.apply(this,[]);return i.forEach((r=>r._pc=this)),i});const n=t.RTCPeerConnection.prototype.addTrack;n&&(t.RTCPeerConnection.prototype.addTrack=function(){const i=n.apply(this,arguments);return i._pc=this,i}),t.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):st.resolve(new Map)}}function gb(t){if(typeof t!="object"||!t.RTCPeerConnection||!t.RTCRtpSender||t.RTCRtpSender&&"getStats"in t.RTCRtpReceiver.prototype)return;const e=t.RTCPeerConnection.prototype.getReceivers;e&&(t.RTCPeerConnection.prototype.getReceivers=function(){const n=e.apply(this,[]);return n.forEach((i=>i._pc=this)),n}),Wa(t,"track",(n=>(n.receiver._pc=n.srcElement,n))),t.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)}}function Sb(t){t.RTCPeerConnection&&!("removeStream"in t.RTCPeerConnection.prototype)&&(t.RTCPeerConnection.prototype.removeStream=function(e){jE("removeStream","removeTrack"),this.getSenders().forEach((n=>{var i;n.track&&$(i=e.getTracks()).call(i,n.track)&&this.removeTrack(n)}))})}function Tb(t){t.DataChannel&&!t.RTCDataChannel&&(t.RTCDataChannel=t.DataChannel)}function Rb(t){if(typeof t!="object"||!t.RTCPeerConnection)return;const e=t.RTCPeerConnection.prototype.addTransceiver;e&&(t.RTCPeerConnection.prototype.addTransceiver=function(){this.setParametersPromises=[];let n=arguments[1]&&arguments[1].sendEncodings;n===void 0&&(n=[]),n=[...n];const i=n.length>0;i&&n.forEach((s=>{if("rid"in s&&!/^[a-z0-9]{0,16}$/i.test(s.rid))throw new TypeError("Invalid RID value provided.");if("scaleResolutionDownBy"in s&&!(parseFloat(s.scaleResolutionDownBy)>=1))throw new RangeError("scale_resolution_down_by must be >= 1.0");if("maxFramerate"in s&&!(parseFloat(s.maxFramerate)>=0))throw new RangeError("max_framerate must be >= 0.0")}));const r=e.apply(this,arguments);if(i){const{sender:s}=r,o=s.getParameters();(!("encodings"in o)||o.encodings.length===1&&Object.keys(o.encodings[0]).length===0)&&(o.encodings=n,s.sendEncodings=n,this.setParametersPromises.push(s.setParameters(o).then((()=>{delete s.sendEncodings})).catch((()=>{delete s.sendEncodings}))))}return r})}function vb(t){if(typeof t!="object"||!t.RTCRtpSender)return;const e=t.RTCRtpSender.prototype.getParameters;e&&(t.RTCRtpSender.prototype.getParameters=function(){const n=e.apply(this,arguments);return"encodings"in n||(n.encodings=[].concat(this.sendEncodings||[{}])),n})}function Cb(t){if(typeof t!="object"||!t.RTCPeerConnection)return;const e=t.RTCPeerConnection.prototype.createOffer;t.RTCPeerConnection.prototype.createOffer=function(){return this.setParametersPromises&&this.setParametersPromises.length?st.all(this.setParametersPromises).then((()=>e.apply(this,arguments))).finally((()=>{this.setParametersPromises=[]})):e.apply(this,arguments)}}function yb(t){if(typeof t!="object"||!t.RTCPeerConnection)return;const e=t.RTCPeerConnection.prototype.createAnswer;t.RTCPeerConnection.prototype.createAnswer=function(){return this.setParametersPromises&&this.setParametersPromises.length?st.all(this.setParametersPromises).then((()=>e.apply(this,arguments))).finally((()=>{this.setParametersPromises=[]})):e.apply(this,arguments)}}var Ib=Object.freeze({__proto__:null,shimAddTransceiver:Rb,shimCreateAnswer:yb,shimCreateOffer:Cb,shimGetDisplayMedia:function(t,e){t.navigator.mediaDevices&&"getDisplayMedia"in t.navigator.mediaDevices||t.navigator.mediaDevices&&(t.navigator.mediaDevices.getDisplayMedia=function(n){if(!n||!n.video){const i=new DOMException("getDisplayMedia without video constraints is undefined");return i.name="NotFoundError",i.code=8,st.reject(i)}return n.video===!0?n.video={mediaSource:e}:n.video.mediaSource=e,t.navigator.mediaDevices.getUserMedia(n)})},shimGetParameters:vb,shimGetUserMedia:fb,shimOnTrack:mb,shimPeerConnection:HE,shimRTCDataChannel:Tb,shimReceiverGetStats:gb,shimRemoveStream:Sb,shimSenderGetStats:Eb});function bb(t){if(typeof t=="object"&&t.RTCPeerConnection){if("getLocalStreams"in t.RTCPeerConnection.prototype||(t.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),!("addStream"in t.RTCPeerConnection.prototype)){const e=t.RTCPeerConnection.prototype.addTrack;t.RTCPeerConnection.prototype.addStream=function(n){var i;this._localStreams||(this._localStreams=[]),$(i=this._localStreams).call(i,n)||this._localStreams.push(n),n.getAudioTracks().forEach((r=>e.call(this,r,n))),n.getVideoTracks().forEach((r=>e.call(this,r,n)))},t.RTCPeerConnection.prototype.addTrack=function(n){for(var i=arguments.length,r=new Array(i>1?i-1:0),s=1;s<i;s++)r[s-1]=arguments[s];return r&&r.forEach((o=>{var a;this._localStreams?$(a=this._localStreams).call(a,o)||this._localStreams.push(o):this._localStreams=[o]})),e.apply(this,arguments)}}"removeStream"in t.RTCPeerConnection.prototype||(t.RTCPeerConnection.prototype.removeStream=function(e){this._localStreams||(this._localStreams=[]);const n=this._localStreams.indexOf(e);if(n===-1)return;this._localStreams.splice(n,1);const i=e.getTracks();this.getSenders().forEach((r=>{$(i).call(i,r.track)&&this.removeTrack(r)}))})}}function Ab(t){if(typeof t=="object"&&t.RTCPeerConnection&&("getRemoteStreams"in t.RTCPeerConnection.prototype||(t.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),!("onaddstream"in t.RTCPeerConnection.prototype))){Object.defineProperty(t.RTCPeerConnection.prototype,"onaddstream",{get(){return this._onaddstream},set(n){this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly)),this.addEventListener("addstream",this._onaddstream=n),this.addEventListener("track",this._onaddstreampoly=i=>{i.streams.forEach((r=>{var s;if(this._remoteStreams||(this._remoteStreams=[]),$(s=this._remoteStreams).call(s,r))return;this._remoteStreams.push(r);const o=new Event("addstream");o.stream=r,this.dispatchEvent(o)}))})}});const e=t.RTCPeerConnection.prototype.setRemoteDescription;t.RTCPeerConnection.prototype.setRemoteDescription=function(){const n=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(i){i.streams.forEach((r=>{if(n._remoteStreams||(n._remoteStreams=[]),n._remoteStreams.indexOf(r)>=0)return;n._remoteStreams.push(r);const s=new Event("addstream");s.stream=r,n.dispatchEvent(s)}))}),e.apply(n,arguments)}}}function wb(t){if(typeof t!="object"||!t.RTCPeerConnection)return;const e=t.RTCPeerConnection.prototype,n=e.createOffer,i=e.createAnswer,r=e.setLocalDescription,s=e.setRemoteDescription,o=e.addIceCandidate;e.createOffer=function(c,d){const l=arguments.length>=2?arguments[2]:arguments[0],h=n.apply(this,[l]);return d?(h.then(c,d),st.resolve()):h},e.createAnswer=function(c,d){const l=arguments.length>=2?arguments[2]:arguments[0],h=i.apply(this,[l]);return d?(h.then(c,d),st.resolve()):h};let a=function(c,d,l){const h=r.apply(this,[c]);return l?(h.then(d,l),st.resolve()):h};e.setLocalDescription=a,a=function(c,d,l){const h=s.apply(this,[c]);return l?(h.then(d,l),st.resolve()):h},e.setRemoteDescription=a,a=function(c,d,l){const h=o.apply(this,[c]);return l?(h.then(d,l),st.resolve()):h},e.addIceCandidate=a}function Ob(t){const e=t&&t.navigator;if(e.mediaDevices&&e.mediaDevices.getUserMedia){const n=e.mediaDevices,i=n.getUserMedia.bind(n);e.mediaDevices.getUserMedia=r=>i(Nb(r))}!e.getUserMedia&&e.mediaDevices&&e.mediaDevices.getUserMedia&&(e.getUserMedia=(function(n,i,r){e.mediaDevices.getUserMedia(n).then(i,r)}).bind(e))}function Nb(t){return t&&t.video!==void 0?Object.assign({},t,{video:nb(t.video)}):t}function Db(t){if(!t.RTCPeerConnection)return;const e=t.RTCPeerConnection;t.RTCPeerConnection=function(n,i){if(n&&n.iceServers){const r=[];for(let s=0;s<n.iceServers.length;s++){let o=n.iceServers[s];!o.hasOwnProperty("urls")&&o.hasOwnProperty("url")?(jE("RTCIceServer.url","RTCIceServer.urls"),o=JSON.parse(JSON.stringify(o)),o.urls=o.url,delete o.url,r.push(o)):r.push(n.iceServers[s])}n.iceServers=r}return new e(n,i)},t.RTCPeerConnection.prototype=e.prototype,"generateCertificate"in e&&Object.defineProperty(t.RTCPeerConnection,"generateCertificate",{get:()=>e.generateCertificate})}function Pb(t){typeof t=="object"&&t.RTCTrackEvent&&"receiver"in t.RTCTrackEvent.prototype&&!("transceiver"in t.RTCTrackEvent.prototype)&&Object.defineProperty(t.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function Lb(t){const e=t.RTCPeerConnection.prototype.createOffer;t.RTCPeerConnection.prototype.createOffer=function(n){if(n){n.offerToReceiveAudio!==void 0&&(n.offerToReceiveAudio=!!n.offerToReceiveAudio);const i=this.getTransceivers().find((s=>s.receiver.track.kind==="audio"));n.offerToReceiveAudio===!1&&i?i.direction==="sendrecv"?i.setDirection?i.setDirection("sendonly"):i.direction="sendonly":i.direction==="recvonly"&&(i.setDirection?i.setDirection("inactive"):i.direction="inactive"):n.offerToReceiveAudio!==!0||i||this.addTransceiver("audio",{direction:"recvonly"}),n.offerToReceiveVideo!==void 0&&(n.offerToReceiveVideo=!!n.offerToReceiveVideo);const r=this.getTransceivers().find((s=>s.receiver.track.kind==="video"));n.offerToReceiveVideo===!1&&r?r.direction==="sendrecv"?r.setDirection?r.setDirection("sendonly"):r.direction="sendonly":r.direction==="recvonly"&&(r.setDirection?r.setDirection("inactive"):r.direction="inactive"):n.offerToReceiveVideo!==!0||r||this.addTransceiver("video",{direction:"recvonly"})}return e.apply(this,arguments)}}function kb(t){typeof t!="object"||t.AudioContext||(t.AudioContext=t.webkitAudioContext)}var Mb=Object.freeze({__proto__:null,shimAudioContext:kb,shimCallbacksAPI:wb,shimConstraints:Nb,shimCreateOfferLegacy:Lb,shimGetUserMedia:Ob,shimLocalStreamsAPI:bb,shimRTCIceServerUrls:Db,shimRemoteStreamsAPI:Ab,shimTrackEventTransceiver:Pb}),Ub=`	
\v\f\r \u2028\u2029\uFEFF`,W5=K,H5=Yi,KE=Ub,xb=W("".replace),K5=RegExp("^["+KE+"]+"),Y5=RegExp("(^|[^"+KE+"])["+KE+"]+$"),q5=function(t){return function(e){var n=H5(W5(e));return 1&t&&(n=xb(n,K5,"")),2&t&&(n=xb(n,Y5,"$1")),n}},z5={trim:q5(3)},X5=SC.PROPER,J5=O,Vb=Ub,Q5=z5.trim;ge({target:"String",proto:!0,forced:(function(t){return J5((function(){return!!Vb[t]()||""[t]()!==""||X5&&Vb[t].name!==t}))})("trim")},{trim:function(){return Q5(this)}});var Z5=yr("String","trim"),$5=Z,t4=Z5,YE=String.prototype,e4=function(t){var e=t.trim;return typeof t=="string"||t===YE||$5(YE,t)&&e===YE.trim?t4:e},_i=y(e4),Fb={exports:{}};(function(t){const e={generateIdentifier:function(){return Math.random().toString(36).substring(2,12)}};e.localCName=e.generateIdentifier(),e.splitLines=function(n){return n.trim().split(`
`).map((i=>i.trim()))},e.splitSections=function(n){return n.split(`
m=`).map(((i,r)=>(r>0?"m="+i:i).trim()+`\r
`))},e.getDescription=function(n){const i=e.splitSections(n);return i&&i[0]},e.getMediaSections=function(n){const i=e.splitSections(n);return i.shift(),i},e.matchPrefix=function(n,i){return e.splitLines(n).filter((r=>r.indexOf(i)===0))},e.parseCandidate=function(n){let i;i=n.indexOf("a=candidate:")===0?n.substring(12).split(" "):n.substring(10).split(" ");const r={foundation:i[0],component:{1:"rtp",2:"rtcp"}[i[1]]||i[1],protocol:i[2].toLowerCase(),priority:parseInt(i[3],10),ip:i[4],address:i[4],port:parseInt(i[5],10),type:i[7]};for(let s=8;s<i.length;s+=2)switch(i[s]){case"raddr":r.relatedAddress=i[s+1];break;case"rport":r.relatedPort=parseInt(i[s+1],10);break;case"tcptype":r.tcpType=i[s+1];break;case"ufrag":r.ufrag=i[s+1],r.usernameFragment=i[s+1];break;default:r[i[s]]===void 0&&(r[i[s]]=i[s+1])}return r},e.writeCandidate=function(n){const i=[];i.push(n.foundation);const r=n.component;r==="rtp"?i.push(1):r==="rtcp"?i.push(2):i.push(r),i.push(n.protocol.toUpperCase()),i.push(n.priority),i.push(n.address||n.ip),i.push(n.port);const s=n.type;return i.push("typ"),i.push(s),s!=="host"&&n.relatedAddress&&n.relatedPort&&(i.push("raddr"),i.push(n.relatedAddress),i.push("rport"),i.push(n.relatedPort)),n.tcpType&&n.protocol.toLowerCase()==="tcp"&&(i.push("tcptype"),i.push(n.tcpType)),(n.usernameFragment||n.ufrag)&&(i.push("ufrag"),i.push(n.usernameFragment||n.ufrag)),"candidate:"+i.join(" ")},e.parseIceOptions=function(n){return n.substring(14).split(" ")},e.parseRtpMap=function(n){let i=n.substring(9).split(" ");const r={payloadType:parseInt(i.shift(),10)};return i=i[0].split("/"),r.name=i[0],r.clockRate=parseInt(i[1],10),r.channels=i.length===3?parseInt(i[2],10):1,r.numChannels=r.channels,r},e.writeRtpMap=function(n){let i=n.payloadType;n.preferredPayloadType!==void 0&&(i=n.preferredPayloadType);const r=n.channels||n.numChannels||1;return"a=rtpmap:"+i+" "+n.name+"/"+n.clockRate+(r!==1?"/"+r:"")+`\r
`},e.parseExtmap=function(n){const i=n.substring(9).split(" ");return{id:parseInt(i[0],10),direction:i[0].indexOf("/")>0?i[0].split("/")[1]:"sendrecv",uri:i[1],attributes:i.slice(2).join(" ")}},e.writeExtmap=function(n){return"a=extmap:"+(n.id||n.preferredId)+(n.direction&&n.direction!=="sendrecv"?"/"+n.direction:"")+" "+n.uri+(n.attributes?" "+n.attributes:"")+`\r
`},e.parseFmtp=function(n){const i={};let r;const s=n.substring(n.indexOf(" ")+1).split(";");for(let o=0;o<s.length;o++)r=s[o].trim().split("="),i[r[0].trim()]=r[1];return i},e.writeFmtp=function(n){let i="",r=n.payloadType;if(n.preferredPayloadType!==void 0&&(r=n.preferredPayloadType),n.parameters&&Object.keys(n.parameters).length){const s=[];Object.keys(n.parameters).forEach((o=>{n.parameters[o]!==void 0?s.push(o+"="+n.parameters[o]):s.push(o)})),i+="a=fmtp:"+r+" "+s.join(";")+`\r
`}return i},e.parseRtcpFb=function(n){const i=n.substring(n.indexOf(" ")+1).split(" ");return{type:i.shift(),parameter:i.join(" ")}},e.writeRtcpFb=function(n){let i="",r=n.payloadType;return n.preferredPayloadType!==void 0&&(r=n.preferredPayloadType),n.rtcpFeedback&&n.rtcpFeedback.length&&n.rtcpFeedback.forEach((s=>{i+="a=rtcp-fb:"+r+" "+s.type+(s.parameter&&s.parameter.length?" "+s.parameter:"")+`\r
`})),i},e.parseSsrcMedia=function(n){const i=n.indexOf(" "),r={ssrc:parseInt(n.substring(7,i),10)},s=n.indexOf(":",i);return s>-1?(r.attribute=n.substring(i+1,s),r.value=n.substring(s+1)):r.attribute=n.substring(i+1),r},e.parseSsrcGroup=function(n){const i=n.substring(13).split(" ");return{semantics:i.shift(),ssrcs:i.map((r=>parseInt(r,10)))}},e.getMid=function(n){const i=e.matchPrefix(n,"a=mid:")[0];if(i)return i.substring(6)},e.parseFingerprint=function(n){const i=n.substring(14).split(" ");return{algorithm:i[0].toLowerCase(),value:i[1].toUpperCase()}},e.getDtlsParameters=function(n,i){return{role:"auto",fingerprints:e.matchPrefix(n+i,"a=fingerprint:").map(e.parseFingerprint)}},e.writeDtlsParameters=function(n,i){let r="a=setup:"+i+`\r
`;return n.fingerprints.forEach((s=>{r+="a=fingerprint:"+s.algorithm+" "+s.value+`\r
`})),r},e.parseCryptoLine=function(n){const i=n.substring(9).split(" ");return{tag:parseInt(i[0],10),cryptoSuite:i[1],keyParams:i[2],sessionParams:i.slice(3)}},e.writeCryptoLine=function(n){return"a=crypto:"+n.tag+" "+n.cryptoSuite+" "+(typeof n.keyParams=="object"?e.writeCryptoKeyParams(n.keyParams):n.keyParams)+(n.sessionParams?" "+n.sessionParams.join(" "):"")+`\r
`},e.parseCryptoKeyParams=function(n){if(n.indexOf("inline:")!==0)return null;const i=n.substring(7).split("|");return{keyMethod:"inline",keySalt:i[0],lifeTime:i[1],mkiValue:i[2]?i[2].split(":")[0]:void 0,mkiLength:i[2]?i[2].split(":")[1]:void 0}},e.writeCryptoKeyParams=function(n){return n.keyMethod+":"+n.keySalt+(n.lifeTime?"|"+n.lifeTime:"")+(n.mkiValue&&n.mkiLength?"|"+n.mkiValue+":"+n.mkiLength:"")},e.getCryptoParameters=function(n,i){return e.matchPrefix(n+i,"a=crypto:").map(e.parseCryptoLine)},e.getIceParameters=function(n,i){const r=e.matchPrefix(n+i,"a=ice-ufrag:")[0],s=e.matchPrefix(n+i,"a=ice-pwd:")[0];return r&&s?{usernameFragment:r.substring(12),password:s.substring(10)}:null},e.writeIceParameters=function(n){let i="a=ice-ufrag:"+n.usernameFragment+`\r
a=ice-pwd:`+n.password+`\r
`;return n.iceLite&&(i+=`a=ice-lite\r
`),i},e.parseRtpParameters=function(n){const i={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},r=e.splitLines(n)[0].split(" ");i.profile=r[2];for(let o=3;o<r.length;o++){const a=r[o],c=e.matchPrefix(n,"a=rtpmap:"+a+" ")[0];if(c){const d=e.parseRtpMap(c),l=e.matchPrefix(n,"a=fmtp:"+a+" ");switch(d.parameters=l.length?e.parseFmtp(l[0]):{},d.rtcpFeedback=e.matchPrefix(n,"a=rtcp-fb:"+a+" ").map(e.parseRtcpFb),i.codecs.push(d),d.name.toUpperCase()){case"RED":case"ULPFEC":i.fecMechanisms.push(d.name.toUpperCase())}}}e.matchPrefix(n,"a=extmap:").forEach((o=>{i.headerExtensions.push(e.parseExtmap(o))}));const s=e.matchPrefix(n,"a=rtcp-fb:* ").map(e.parseRtcpFb);return i.codecs.forEach((o=>{s.forEach((a=>{o.rtcpFeedback.find((c=>c.type===a.type&&c.parameter===a.parameter))||o.rtcpFeedback.push(a)}))})),i},e.writeRtpDescription=function(n,i){let r="";r+="m="+n+" ",r+=i.codecs.length>0?"9":"0",r+=" "+(i.profile||"UDP/TLS/RTP/SAVPF")+" ",r+=i.codecs.map((o=>o.preferredPayloadType!==void 0?o.preferredPayloadType:o.payloadType)).join(" ")+`\r
`,r+=`c=IN IP4 0.0.0.0\r
`,r+=`a=rtcp:9 IN IP4 0.0.0.0\r
`,i.codecs.forEach((o=>{r+=e.writeRtpMap(o),r+=e.writeFmtp(o),r+=e.writeRtcpFb(o)}));let s=0;return i.codecs.forEach((o=>{o.maxptime>s&&(s=o.maxptime)})),s>0&&(r+="a=maxptime:"+s+`\r
`),i.headerExtensions&&i.headerExtensions.forEach((o=>{r+=e.writeExtmap(o)})),r},e.parseRtpEncodingParameters=function(n){const i=[],r=e.parseRtpParameters(n),s=r.fecMechanisms.indexOf("RED")!==-1,o=r.fecMechanisms.indexOf("ULPFEC")!==-1,a=e.matchPrefix(n,"a=ssrc:").map((p=>e.parseSsrcMedia(p))).filter((p=>p.attribute==="cname")),c=a.length>0&&a[0].ssrc;let d;const l=e.matchPrefix(n,"a=ssrc-group:FID").map((p=>p.substring(17).split(" ").map((f=>parseInt(f,10)))));l.length>0&&l[0].length>1&&l[0][0]===c&&(d=l[0][1]),r.codecs.forEach((p=>{if(p.name.toUpperCase()==="RTX"&&p.parameters.apt){let f={ssrc:c,codecPayloadType:parseInt(p.parameters.apt,10)};c&&d&&(f.rtx={ssrc:d}),i.push(f),s&&(f=JSON.parse(JSON.stringify(f)),f.fec={ssrc:c,mechanism:o?"red+ulpfec":"red"},i.push(f))}})),i.length===0&&c&&i.push({ssrc:c});let h=e.matchPrefix(n,"b=");return h.length&&(h=h[0].indexOf("b=TIAS:")===0?parseInt(h[0].substring(7),10):h[0].indexOf("b=AS:")===0?1e3*parseInt(h[0].substring(5),10)*.95-16e3:void 0,i.forEach((p=>{p.maxBitrate=h}))),i},e.parseRtcpParameters=function(n){const i={},r=e.matchPrefix(n,"a=ssrc:").map((a=>e.parseSsrcMedia(a))).filter((a=>a.attribute==="cname"))[0];r&&(i.cname=r.value,i.ssrc=r.ssrc);const s=e.matchPrefix(n,"a=rtcp-rsize");i.reducedSize=s.length>0,i.compound=s.length===0;const o=e.matchPrefix(n,"a=rtcp-mux");return i.mux=o.length>0,i},e.writeRtcpParameters=function(n){let i="";return n.reducedSize&&(i+=`a=rtcp-rsize\r
`),n.mux&&(i+=`a=rtcp-mux\r
`),n.ssrc!==void 0&&n.cname&&(i+="a=ssrc:"+n.ssrc+" cname:"+n.cname+`\r
`),i},e.parseMsid=function(n){let i;const r=e.matchPrefix(n,"a=msid:");if(r.length===1)return i=r[0].substring(7).split(" "),{stream:i[0],track:i[1]};const s=e.matchPrefix(n,"a=ssrc:").map((o=>e.parseSsrcMedia(o))).filter((o=>o.attribute==="msid"));return s.length>0?(i=s[0].value.split(" "),{stream:i[0],track:i[1]}):void 0},e.parseSctpDescription=function(n){const i=e.parseMLine(n),r=e.matchPrefix(n,"a=max-message-size:");let s;r.length>0&&(s=parseInt(r[0].substring(19),10)),isNaN(s)&&(s=65536);const o=e.matchPrefix(n,"a=sctp-port:");if(o.length>0)return{port:parseInt(o[0].substring(12),10),protocol:i.fmt,maxMessageSize:s};const a=e.matchPrefix(n,"a=sctpmap:");if(a.length>0){const c=a[0].substring(10).split(" ");return{port:parseInt(c[0],10),protocol:c[1],maxMessageSize:s}}},e.writeSctpDescription=function(n,i){let r=[];return r=n.protocol!=="DTLS/SCTP"?["m="+n.kind+" 9 "+n.protocol+" "+i.protocol+`\r
`,`c=IN IP4 0.0.0.0\r
`,"a=sctp-port:"+i.port+`\r
`]:["m="+n.kind+" 9 "+n.protocol+" "+i.port+`\r
`,`c=IN IP4 0.0.0.0\r
`,"a=sctpmap:"+i.port+" "+i.protocol+` 65535\r
`],i.maxMessageSize!==void 0&&r.push("a=max-message-size:"+i.maxMessageSize+`\r
`),r.join("")},e.generateSessionId=function(){return Math.random().toString().substr(2,22)},e.writeSessionBoilerplate=function(n,i,r){let s;const o=i!==void 0?i:2;return s=n||e.generateSessionId(),`v=0\r
o=`+(r||"thisisadapterortc")+" "+s+" "+o+` IN IP4 127.0.0.1\r
s=-\r
t=0 0\r
`},e.getDirection=function(n,i){const r=e.splitLines(n);for(let s=0;s<r.length;s++)switch(r[s]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return r[s].substring(2)}return i?e.getDirection(i):"sendrecv"},e.getKind=function(n){return e.splitLines(n)[0].split(" ")[0].substring(2)},e.isRejected=function(n){return n.split(" ",2)[1]==="0"},e.parseMLine=function(n){const i=e.splitLines(n)[0].substring(2).split(" ");return{kind:i[0],port:parseInt(i[1],10),protocol:i[2],fmt:i.slice(3).join(" ")}},e.parseOLine=function(n){const i=e.matchPrefix(n,"o=")[0].substring(2).split(" ");return{username:i[0],sessionId:i[1],sessionVersion:parseInt(i[2],10),netType:i[3],addressType:i[4],address:i[5]}},e.isValidSDP=function(n){if(typeof n!="string"||n.length===0)return!1;const i=e.splitLines(n);for(let r=0;r<i.length;r++)if(i[r].length<2||i[r].charAt(1)!=="=")return!1;return!0},t.exports=e})(Fb);var Bb=Fb.exports,ad=y(Bb),n4=E({__proto__:null,default:ad},[Bb]);function cp(t){if(!t.RTCIceCandidate||t.RTCIceCandidate&&"foundation"in t.RTCIceCandidate.prototype)return;const e=t.RTCIceCandidate;t.RTCIceCandidate=function(n){if(typeof n=="object"&&n.candidate&&n.candidate.indexOf("a=")===0&&((n=JSON.parse(JSON.stringify(n))).candidate=n.candidate.substr(2)),n.candidate&&n.candidate.length){const i=new e(n),r=ad.parseCandidate(n.candidate),s=Object.assign(i,r);return s.toJSON=function(){return{candidate:s.candidate,sdpMid:s.sdpMid,sdpMLineIndex:s.sdpMLineIndex,usernameFragment:s.usernameFragment}},s}return new e(n)},t.RTCIceCandidate.prototype=e.prototype,Wa(t,"icecandidate",(n=>(n.candidate&&Object.defineProperty(n,"candidate",{value:new t.RTCIceCandidate(n.candidate),writable:"false"}),n)))}function qE(t){!t.RTCIceCandidate||t.RTCIceCandidate&&"relayProtocol"in t.RTCIceCandidate.prototype||Wa(t,"icecandidate",(e=>{if(e.candidate){const n=ad.parseCandidate(e.candidate.candidate);n.type==="relay"&&(e.candidate.relayProtocol={0:"tls",1:"tcp",2:"udp"}[n.priority>>24])}return e}))}function dp(t,e){if(!t.RTCPeerConnection)return;"sctp"in t.RTCPeerConnection.prototype||Object.defineProperty(t.RTCPeerConnection.prototype,"sctp",{get(){return this._sctp===void 0?null:this._sctp}});const n=function(a){if(!a||!a.sdp)return!1;const c=ad.splitSections(a.sdp);return c.shift(),c.some((d=>{const l=ad.parseMLine(d);return l&&l.kind==="application"&&l.protocol.indexOf("SCTP")!==-1}))},i=function(a){const c=a.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(c===null||c.length<2)return-1;const d=parseInt(c[1],10);return d!=d?-1:d},r=function(a){let c=65536;return e.browser==="firefox"&&(c=e.version<57?a===-1?16384:2147483637:e.version<60?e.version===57?65535:65536:2147483637),c},s=function(a,c){let d=65536;e.browser==="firefox"&&e.version===57&&(d=65535);const l=ad.matchPrefix(a.sdp,"a=max-message-size:");return l.length>0?d=parseInt(l[0].substr(19),10):e.browser==="firefox"&&c!==-1&&(d=2147483637),d},o=t.RTCPeerConnection.prototype.setRemoteDescription;t.RTCPeerConnection.prototype.setRemoteDescription=function(){if(this._sctp=null,e.browser==="chrome"&&e.version>=76){const{sdpSemantics:a}=this.getConfiguration();a==="plan-b"&&Object.defineProperty(this,"sctp",{get(){return this._sctp===void 0?null:this._sctp},enumerable:!0,configurable:!0})}if(n(arguments[0])){const a=i(arguments[0]),c=r(a),d=s(arguments[0],a);let l;l=c===0&&d===0?Number.POSITIVE_INFINITY:c===0||d===0?Math.max(c,d):Math.min(c,d);const h={};Object.defineProperty(h,"maxMessageSize",{get:()=>l}),this._sctp=h}return o.apply(this,arguments)}}function lp(t){if(!t.RTCPeerConnection||!("createDataChannel"in t.RTCPeerConnection.prototype))return;function e(i,r){const s=i.send;i.send=function(){const o=arguments[0],a=o.length||o.size||o.byteLength;if(i.readyState==="open"&&r.sctp&&a>r.sctp.maxMessageSize)throw new TypeError("Message too large (can send a maximum of "+r.sctp.maxMessageSize+" bytes)");return s.apply(i,arguments)}}const n=t.RTCPeerConnection.prototype.createDataChannel;t.RTCPeerConnection.prototype.createDataChannel=function(){const i=n.apply(this,arguments);return e(i,this),i},Wa(t,"datachannel",(i=>(e(i.channel,i.target),i)))}function zE(t){if(!t.RTCPeerConnection||"connectionState"in t.RTCPeerConnection.prototype)return;const e=t.RTCPeerConnection.prototype;Object.defineProperty(e,"connectionState",{get(){return{completed:"connected",checking:"connecting"}[this.iceConnectionState]||this.iceConnectionState},enumerable:!0,configurable:!0}),Object.defineProperty(e,"onconnectionstatechange",{get(){return this._onconnectionstatechange||null},set(n){this._onconnectionstatechange&&(this.removeEventListener("connectionstatechange",this._onconnectionstatechange),delete this._onconnectionstatechange),n&&this.addEventListener("connectionstatechange",this._onconnectionstatechange=n)},enumerable:!0,configurable:!0}),["setLocalDescription","setRemoteDescription"].forEach((n=>{const i=e[n];e[n]=function(){return this._connectionstatechangepoly||(this._connectionstatechangepoly=r=>{const s=r.target;if(s._lastConnectionState!==s.connectionState){s._lastConnectionState=s.connectionState;const o=new Event("connectionstatechange",r);s.dispatchEvent(o)}return r},this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)),i.apply(this,arguments)}}))}function XE(t,e){if(!t.RTCPeerConnection||e.browser==="chrome"&&e.version>=71||e.browser==="safari"&&e.version>=605)return;const n=t.RTCPeerConnection.prototype.setRemoteDescription;t.RTCPeerConnection.prototype.setRemoteDescription=function(i){if(i&&i.sdp&&i.sdp.indexOf(`
a=extmap-allow-mixed`)!==-1){const r=i.sdp.split(`
`).filter((s=>_i(s).call(s)!=="a=extmap-allow-mixed")).join(`
`);t.RTCSessionDescription&&i instanceof t.RTCSessionDescription?arguments[0]=new t.RTCSessionDescription({type:i.type,sdp:r}):i.sdp=r}return n.apply(this,arguments)}}function up(t,e){if(!t.RTCPeerConnection||!t.RTCPeerConnection.prototype)return;const n=t.RTCPeerConnection.prototype.addIceCandidate;n&&n.length!==0&&(t.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?(e.browser==="chrome"&&e.version<78||e.browser==="firefox"&&e.version<68||e.browser==="safari")&&arguments[0]&&arguments[0].candidate===""?st.resolve():n.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),st.resolve())})}function hp(t,e){if(!t.RTCPeerConnection||!t.RTCPeerConnection.prototype)return;const n=t.RTCPeerConnection.prototype.setLocalDescription;n&&n.length!==0&&(t.RTCPeerConnection.prototype.setLocalDescription=function(){let i=arguments[0]||{};if(typeof i!="object"||i.type&&i.sdp)return n.apply(this,arguments);if(i={type:i.type,sdp:i.sdp},!i.type)switch(this.signalingState){case"stable":case"have-local-offer":case"have-remote-pranswer":i.type="offer";break;default:i.type="answer"}return i.sdp||i.type!=="offer"&&i.type!=="answer"?n.apply(this,[i]):(i.type==="offer"?this.createOffer:this.createAnswer).apply(this).then((r=>n.apply(this,[r])))})}var i4=Object.freeze({__proto__:null,removeExtmapAllowMixed:XE,shimAddIceCandidateNullOrEmpty:up,shimConnectionState:zE,shimMaxMessageSize:dp,shimParameterlessSetLocalDescription:hp,shimRTCIceCandidate:cp,shimRTCIceCandidateRelayProtocol:qE,shimSendThrowTypeError:lp});(function(){let{window:t}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{shimChrome:!0,shimFirefox:!0,shimSafari:!0};const n=tb,i=(function(s){const o={browser:null,version:null};if(s===void 0||!s.navigator)return o.browser="Not a browser.",o;const{navigator:a}=s;if(a.mozGetUserMedia)o.browser="firefox",o.version=ap(a.userAgent,/Firefox\/(\d+)\./,1);else if(a.webkitGetUserMedia||s.isSecureContext===!1&&s.webkitRTCPeerConnection)o.browser="chrome",o.version=ap(a.userAgent,/Chrom(e|ium)\/(\d+)\./,2);else{if(!s.RTCPeerConnection||!a.userAgent.match(/AppleWebKit\/(\d+)\./))return o.browser="Not a supported browser.",o;o.browser="safari",o.version=ap(a.userAgent,/AppleWebKit\/(\d+)\./,1),o.supportsUnifiedPlan=s.RTCRtpTransceiver&&"currentDirection"in s.RTCRtpTransceiver.prototype}return o})(t),r={browserDetails:i,commonShim:i4,extractVersion:ap,disableLog:j5,disableWarnings:G5,sdp:n4};switch(i.browser){case"chrome":if(!_b||!WE||!e.shimChrome)return n("Chrome shim is not included in this adapter release."),r;if(i.version===null)return n("Chrome shim can not determine version, not shimming."),r;n("adapter.js shimming chrome."),r.browserShim=_b,up(t,i),hp(t),sb(t,i),ob(t),WE(t,i),ab(t),hb(t,i),cb(t),db(t),lb(t),pb(t,i),cp(t),qE(t),zE(t),dp(t,i),lp(t),XE(t,i);break;case"firefox":if(!Ib||!HE||!e.shimFirefox)return n("Firefox shim is not included in this adapter release."),r;n("adapter.js shimming firefox."),r.browserShim=Ib,up(t,i),hp(t),fb(t,i),HE(t,i),mb(t),Sb(t),Eb(t),gb(t),Tb(t),Rb(t),vb(t),Cb(t),yb(t),cp(t),zE(t),dp(t,i),lp(t);break;case"safari":if(!Mb||!e.shimSafari)return n("Safari shim is not included in this adapter release."),r;n("adapter.js shimming safari."),r.browserShim=Mb,up(t,i),hp(t),Db(t),Lb(t),wb(t),bb(t),Ab(t),Pb(t),Ob(t),kb(t),cp(t),qE(t),dp(t,i),lp(t),XE(t,i);break;default:n("Unsupported browser!")}})({window:typeof window>"u"?void 0:window});var r4=O,jb=vt.RegExp,s4=!r4((function(){var t=!0;try{jb(".","d")}catch{t=!1}var e={},n="",i=t?"dgimsy":"gimsy",r=function(a,c){Object.defineProperty(e,a,{get:function(){return n+=c,!0}})},s={dotAll:"s",global:"g",ignoreCase:"i",multiline:"m",sticky:"y"};for(var o in t&&(s.hasIndices="d"),s)r(o,s[o]);return Object.getOwnPropertyDescriptor(jb.prototype,"flags").get.call(e)!==i||n!==i})),o4=Ki,a4=ue,c4=ii,d4=Z,Gb={correct:s4},l4=function(){var t=o4(this),e="";return t.hasIndices&&(e+="d"),t.global&&(e+="g"),t.ignoreCase&&(e+="i"),t.multiline&&(e+="m"),t.dotAll&&(e+="s"),t.unicode&&(e+="u"),t.unicodeSets&&(e+="v"),t.sticky&&(e+="y"),e},u4=RegExp.prototype,JE=Gb.correct?function(t){return t.flags}:function(t){return Gb.correct||!d4(u4,t)||c4(t,"flags")?t.flags:a4(l4,t)},QE=W,h4=Math.floor,ZE=QE("".charAt),p4=QE("".replace),$E=QE("".slice),_4=/\$([$&'`]|\d{1,2})/g,f4=ge,m4=ue,tg=W,Wb=K,E4=sn,g4=bt,S4=nm,cd=Yi,T4=Tl,R4=JE,v4=function(t,e,n,i,r,s){var o=n+t.length,a=i.length,c=_4;return p4(s,c,(function(d,l){var h;switch(ZE(l,0)){case"$":return"$";case"&":return t;case"`":return $E(e,0,n);case"'":return $E(e,o);case"<":h=r[$E(l,1,-1)];break;default:var p=+l;if(p===0)return d;if(p>a){var f=h4(p/10);return f===0?d:f<=a?i[f-1]===void 0?ZE(l,1):i[f-1]+ZE(l,1):d}h=i[p-1]}return h===void 0?"":h}))},C4=gn("replace"),y4=TypeError,eg=tg("".indexOf),I4=tg("".replace),Hb=tg("".slice),b4=Math.max;f4({target:"String",proto:!0},{replaceAll:function(t,e){var n,i,r,s,o,a,c,d,l,h,p=Wb(this),f=0,v="";if(g4(t)){if((n=S4(t))&&(i=cd(Wb(R4(t))),!~eg(i,"g")))throw new y4("`.replaceAll` does not allow non-global regexes");if(r=T4(t,C4))return m4(r,t,p,e);if(n)return I4(cd(p),t,e)}for(s=cd(p),o=cd(t),(a=E4(e))||(e=cd(e)),c=o.length,d=b4(1,c),l=eg(s,o);l!==-1;)h=a?cd(e(o,l,s)):v4(o,s,l,[],void 0,e),v+=Hb(s,f,l)+h,f=l+c,l=l+d>s.length?-1:eg(s,o,l+d);return f<s.length&&(v+=Hb(s,f)),v}});var A4=yr("String","replaceAll"),w4=Z,O4=A4,ng=String.prototype,N4=function(t){var e=t.replaceAll;return typeof t=="string"||t===ng||w4(ng,t)&&e===ng.replaceAll?O4:e},D4=y(N4),ig=vt;ge({global:!0,forced:ig.globalThis!==ig},{globalThis:ig});var Kb=y(vt),rg={exports:{}};(function(t,e){(function(n,i){var r="function",s="undefined",o="object",a="string",c="major",d="model",l="name",h="type",p="vendor",f="version",v="architecture",S="console",T="mobile",b="tablet",w="smarttv",D="wearable",k="embedded",U="Amazon",P="Apple",x="ASUS",q="BlackBerry",Q="Browser",dt="Chrome",Dt="Firefox",Ot="Google",Wt="Honor",Vt="Huawei",pe="LG",He="Microsoft",X="Motorola",rt="Nvidia",ht="OnePlus",J="Opera",g="OPPO",N="Samsung",L="Sharp",et="Sony",Mt="Xiaomi",ke="Zebra",kn="Facebook",Ur="Chromium OS",ya="Mac OS",pf=" Browser",il=function(Rn){for(var bn={},Be=0;Be<Rn.length;Be++)bn[Rn[Be].toUpperCase()]=Rn[Be];return bn},_f=function(Rn,bn){return typeof Rn===a&&Ac(bn).indexOf(Ac(Rn))!==-1},Ac=function(Rn){return Rn.toLowerCase()},Ku=function(Rn,bn){if(typeof Rn===a)return Rn=Rn.replace(/^\s\s*/,""),typeof bn===s?Rn:Rn.substring(0,500)},wc=function(Rn,bn){for(var Be,Fi,Ms,dn,xo,ae,Us=0;Us<bn.length&&!xo;){var Oc=bn[Us],po=bn[Us+1];for(Be=Fi=0;Be<Oc.length&&!xo&&Oc[Be];)if(xo=Oc[Be++].exec(Rn))for(Ms=0;Ms<po.length;Ms++)ae=xo[++Fi],typeof(dn=po[Ms])===o&&dn.length>0?dn.length===2?typeof dn[1]==r?this[dn[0]]=dn[1].call(this,ae):this[dn[0]]=dn[1]:dn.length===3?typeof dn[1]!==r||dn[1].exec&&dn[1].test?this[dn[0]]=ae?ae.replace(dn[1],dn[2]):i:this[dn[0]]=ae?dn[1].call(this,ae,dn[2]):i:dn.length===4&&(this[dn[0]]=ae?dn[3].call(this,ae.replace(dn[1],dn[2])):i):this[dn]=ae||i;Us+=2}},Ia=function(Rn,bn){for(var Be in bn)if(typeof bn[Be]===o&&bn[Be].length>0){for(var Fi=0;Fi<bn[Be].length;Fi++)if(_f(bn[Be][Fi],Rn))return Be==="?"?i:Be}else if(_f(bn[Be],Rn))return Be==="?"?i:Be;return bn.hasOwnProperty("*")?bn["*"]:Rn},kM={ME:"4.90","NT 3.11":"NT3.51","NT 4.0":"NT4.0",2e3:"NT 5.0",XP:["NT 5.1","NT 5.2"],Vista:"NT 6.0",7:"NT 6.1",8:"NT 6.2",8.1:"NT 6.3",10:["NT 6.4","NT 10.0"],RT:"ARM"},MM={browser:[[/\b(?:crmo|crios)\/([\w\.]+)/i],[f,[l,"Chrome"]],[/edg(?:e|ios|a)?\/([\w\.]+)/i],[f,[l,"Edge"]],[/(opera mini)\/([-\w\.]+)/i,/(opera [mobiletab]{3,6})\b.+version\/([-\w\.]+)/i,/(opera)(?:.+version\/|[\/ ]+)([\w\.]+)/i],[l,f],[/opios[\/ ]+([\w\.]+)/i],[f,[l,J+" Mini"]],[/\bop(?:rg)?x\/([\w\.]+)/i],[f,[l,J+" GX"]],[/\bopr\/([\w\.]+)/i],[f,[l,J]],[/\bb[ai]*d(?:uhd|[ub]*[aekoprswx]{5,6})[\/ ]?([\w\.]+)/i],[f,[l,"Baidu"]],[/\b(?:mxbrowser|mxios|myie2)\/?([-\w\.]*)\b/i],[f,[l,"Maxthon"]],[/(kindle)\/([\w\.]+)/i,/(lunascape|maxthon|netfront|jasmine|blazer|sleipnir)[\/ ]?([\w\.]*)/i,/(avant|iemobile|slim(?:browser|boat|jet))[\/ ]?([\d\.]*)/i,/(?:ms|\()(ie) ([\w\.]+)/i,/(flock|rockmelt|midori|epiphany|silk|skyfire|ovibrowser|bolt|iron|vivaldi|iridium|phantomjs|bowser|qupzilla|falkon|rekonq|puffin|brave|whale(?!.+naver)|qqbrowserlite|duckduckgo|klar|helio|(?=comodo_)?dragon)\/([-\w\.]+)/i,/(heytap|ovi|115)browser\/([\d\.]+)/i,/(weibo)__([\d\.]+)/i],[l,f],[/quark(?:pc)?\/([-\w\.]+)/i],[f,[l,"Quark"]],[/\bddg\/([\w\.]+)/i],[f,[l,"DuckDuckGo"]],[/(?:\buc? ?browser|(?:juc.+)ucweb)[\/ ]?([\w\.]+)/i],[f,[l,"UC"+Q]],[/microm.+\bqbcore\/([\w\.]+)/i,/\bqbcore\/([\w\.]+).+microm/i,/micromessenger\/([\w\.]+)/i],[f,[l,"WeChat"]],[/konqueror\/([\w\.]+)/i],[f,[l,"Konqueror"]],[/trident.+rv[: ]([\w\.]{1,9})\b.+like gecko/i],[f,[l,"IE"]],[/ya(?:search)?browser\/([\w\.]+)/i],[f,[l,"Yandex"]],[/slbrowser\/([\w\.]+)/i],[f,[l,"Smart Lenovo "+Q]],[/(avast|avg)\/([\w\.]+)/i],[[l,/(.+)/,"$1 Secure "+Q],f],[/\bfocus\/([\w\.]+)/i],[f,[l,Dt+" Focus"]],[/\bopt\/([\w\.]+)/i],[f,[l,J+" Touch"]],[/coc_coc\w+\/([\w\.]+)/i],[f,[l,"Coc Coc"]],[/dolfin\/([\w\.]+)/i],[f,[l,"Dolphin"]],[/coast\/([\w\.]+)/i],[f,[l,J+" Coast"]],[/miuibrowser\/([\w\.]+)/i],[f,[l,"MIUI"+pf]],[/fxios\/([\w\.-]+)/i],[f,[l,Dt]],[/\bqihoobrowser\/?([\w\.]*)/i],[f,[l,"360"]],[/\b(qq)\/([\w\.]+)/i],[[l,/(.+)/,"$1Browser"],f],[/(oculus|sailfish|huawei|vivo|pico)browser\/([\w\.]+)/i],[[l,/(.+)/,"$1"+pf],f],[/samsungbrowser\/([\w\.]+)/i],[f,[l,N+" Internet"]],[/metasr[\/ ]?([\d\.]+)/i],[f,[l,"Sogou Explorer"]],[/(sogou)mo\w+\/([\d\.]+)/i],[[l,"Sogou Mobile"],f],[/(electron)\/([\w\.]+) safari/i,/(tesla)(?: qtcarbrowser|\/(20\d\d\.[-\w\.]+))/i,/m?(qqbrowser|2345(?=browser|chrome|explorer))\w*[\/ ]?v?([\w\.]+)/i],[l,f],[/(lbbrowser|rekonq)/i,/\[(linkedin)app\]/i],[l],[/ome\/([\w\.]+) \w* ?(iron) saf/i,/ome\/([\w\.]+).+qihu (360)[es]e/i],[f,l],[/((?:fban\/fbios|fb_iab\/fb4a)(?!.+fbav)|;fbav\/([\w\.]+);)/i],[[l,kn],f],[/(Klarna)\/([\w\.]+)/i,/(kakao(?:talk|story))[\/ ]([\w\.]+)/i,/(naver)\(.*?(\d+\.[\w\.]+).*\)/i,/(daum)apps[\/ ]([\w\.]+)/i,/safari (line)\/([\w\.]+)/i,/\b(line)\/([\w\.]+)\/iab/i,/(alipay)client\/([\w\.]+)/i,/(twitter)(?:and| f.+e\/([\w\.]+))/i,/(chromium|instagram|snapchat)[\/ ]([-\w\.]+)/i],[l,f],[/\bgsa\/([\w\.]+) .*safari\//i],[f,[l,"GSA"]],[/musical_ly(?:.+app_?version\/|_)([\w\.]+)/i],[f,[l,"TikTok"]],[/headlesschrome(?:\/([\w\.]+)| )/i],[f,[l,dt+" Headless"]],[/ wv\).+(chrome)\/([\w\.]+)/i],[[l,dt+" WebView"],f],[/droid.+ version\/([\w\.]+)\b.+(?:mobile safari|safari)/i],[f,[l,"Android "+Q]],[/(chrome|omniweb|arora|[tizenoka]{5} ?browser)\/v?([\w\.]+)/i],[l,f],[/version\/([\w\.\,]+) .*mobile\/\w+ (safari)/i],[f,[l,"Mobile Safari"]],[/version\/([\w(\.|\,)]+) .*(mobile ?safari|safari)/i],[f,l],[/webkit.+?(mobile ?safari|safari)(\/[\w\.]+)/i],[l,[f,Ia,{"1.0":"/8",1.2:"/1",1.3:"/3","2.0":"/412","2.0.2":"/416","2.0.3":"/417","2.0.4":"/419","?":"/"}]],[/(webkit|khtml)\/([\w\.]+)/i],[l,f],[/(navigator|netscape\d?)\/([-\w\.]+)/i],[[l,"Netscape"],f],[/(wolvic|librewolf)\/([\w\.]+)/i],[l,f],[/mobile vr; rv:([\w\.]+)\).+firefox/i],[f,[l,Dt+" Reality"]],[/ekiohf.+(flow)\/([\w\.]+)/i,/(swiftfox)/i,/(icedragon|iceweasel|camino|chimera|fennec|maemo browser|minimo|conkeror)[\/ ]?([\w\.\+]+)/i,/(seamonkey|k-meleon|icecat|iceape|firebird|phoenix|palemoon|basilisk|waterfox)\/([-\w\.]+)$/i,/(firefox)\/([\w\.]+)/i,/(mozilla)\/([\w\.]+) .+rv\:.+gecko\/\d+/i,/(amaya|dillo|doris|icab|ladybird|lynx|mosaic|netsurf|obigo|polaris|w3m|(?:go|ice|up)[\. ]?browser)[-\/ ]?v?([\w\.]+)/i,/\b(links) \(([\w\.]+)/i],[l,[f,/_/g,"."]],[/(cobalt)\/([\w\.]+)/i],[l,[f,/master.|lts./,""]]],cpu:[[/\b((amd|x|x86[-_]?|wow|win)64)\b/i],[[v,"amd64"]],[/(ia32(?=;))/i,/\b((i[346]|x)86)(pc)?\b/i],[[v,"ia32"]],[/\b(aarch64|arm(v?[89]e?l?|_?64))\b/i],[[v,"arm64"]],[/\b(arm(v[67])?ht?n?[fl]p?)\b/i],[[v,"armhf"]],[/( (ce|mobile); ppc;|\/[\w\.]+arm\b)/i],[[v,"arm"]],[/((ppc|powerpc)(64)?)( mac|;|\))/i],[[v,/ower/,"",Ac]],[/ sun4\w[;\)]/i],[[v,"sparc"]],[/\b(avr32|ia64(?=;)|68k(?=\))|\barm(?=v([1-7]|[5-7]1)l?|;|eabi)|(irix|mips|sparc)(64)?\b|pa-risc)/i],[[v,Ac]]],device:[[/\b(sch-i[89]0\d|shw-m380s|sm-[ptx]\w{2,4}|gt-[pn]\d{2,4}|sgh-t8[56]9|nexus 10)/i],[d,[p,N],[h,b]],[/\b((?:s[cgp]h|gt|sm)-(?![lr])\w+|sc[g-]?[\d]+a?|galaxy nexus)/i,/samsung[- ]((?!sm-[lr])[-\w]+)/i,/sec-(sgh\w+)/i],[d,[p,N],[h,T]],[/(?:\/|\()(ip(?:hone|od)[\w, ]*)(?:\/|;)/i],[d,[p,P],[h,T]],[/\((ipad);[-\w\),; ]+apple/i,/applecoremedia\/[\w\.]+ \((ipad)/i,/\b(ipad)\d\d?,\d\d?[;\]].+ios/i],[d,[p,P],[h,b]],[/(macintosh);/i],[d,[p,P]],[/\b(sh-?[altvz]?\d\d[a-ekm]?)/i],[d,[p,L],[h,T]],[/\b((?:brt|eln|hey2?|gdi|jdn)-a?[lnw]09|(?:ag[rm]3?|jdn2|kob2)-a?[lw]0[09]hn)(?: bui|\)|;)/i],[d,[p,Wt],[h,b]],[/honor([-\w ]+)[;\)]/i],[d,[p,Wt],[h,T]],[/\b((?:ag[rs][2356]?k?|bah[234]?|bg[2o]|bt[kv]|cmr|cpn|db[ry]2?|jdn2|got|kob2?k?|mon|pce|scm|sht?|[tw]gr|vrd)-[ad]?[lw][0125][09]b?|605hw|bg2-u03|(?:gem|fdr|m2|ple|t1)-[7a]0[1-4][lu]|t1-a2[13][lw]|mediapad[\w\. ]*(?= bui|\)))\b(?!.+d\/s)/i],[d,[p,Vt],[h,b]],[/(?:huawei)([-\w ]+)[;\)]/i,/\b(nexus 6p|\w{2,4}e?-[atu]?[ln][\dx][012359c][adn]?)\b(?!.+d\/s)/i],[d,[p,Vt],[h,T]],[/oid[^\)]+; (2[\dbc]{4}(182|283|rp\w{2})[cgl]|m2105k81a?c)(?: bui|\))/i,/\b((?:red)?mi[-_ ]?pad[\w- ]*)(?: bui|\))/i],[[d,/_/g," "],[p,Mt],[h,b]],[/\b(poco[\w ]+|m2\d{3}j\d\d[a-z]{2})(?: bui|\))/i,/\b; (\w+) build\/hm\1/i,/\b(hm[-_ ]?note?[_ ]?(?:\d\w)?) bui/i,/\b(redmi[\-_ ]?(?:note|k)?[\w_ ]+)(?: bui|\))/i,/oid[^\)]+; (m?[12][0-389][01]\w{3,6}[c-y])( bui|; wv|\))/i,/\b(mi[-_ ]?(?:a\d|one|one[_ ]plus|note lte|max|cc)?[_ ]?(?:\d?\w?)[_ ]?(?:plus|se|lite|pro)?)(?: bui|\))/i,/ ([\w ]+) miui\/v?\d/i],[[d,/_/g," "],[p,Mt],[h,T]],[/; (\w+) bui.+ oppo/i,/\b(cph[12]\d{3}|p(?:af|c[al]|d\w|e[ar])[mt]\d0|x9007|a101op)\b/i],[d,[p,g],[h,T]],[/\b(opd2(\d{3}a?))(?: bui|\))/i],[d,[p,Ia,{OnePlus:["304","403","203"],"*":g}],[h,b]],[/vivo (\w+)(?: bui|\))/i,/\b(v[12]\d{3}\w?[at])(?: bui|;)/i],[d,[p,"Vivo"],[h,T]],[/\b(rmx[1-3]\d{3})(?: bui|;|\))/i],[d,[p,"Realme"],[h,T]],[/\b(milestone|droid(?:[2-4x]| (?:bionic|x2|pro|razr))?:?( 4g)?)\b[\w ]+build\//i,/\bmot(?:orola)?[- ](\w*)/i,/((?:moto(?! 360)[\w\(\) ]+|xt\d{3,4}|nexus 6)(?= bui|\)))/i],[d,[p,X],[h,T]],[/\b(mz60\d|xoom[2 ]{0,2}) build\//i],[d,[p,X],[h,b]],[/((?=lg)?[vl]k\-?\d{3}) bui| 3\.[-\w; ]{10}lg?-([06cv9]{3,4})/i],[d,[p,pe],[h,b]],[/(lm(?:-?f100[nv]?|-[\w\.]+)(?= bui|\))|nexus [45])/i,/\blg[-e;\/ ]+((?!browser|netcast|android tv|watch)\w+)/i,/\blg-?([\d\w]+) bui/i],[d,[p,pe],[h,T]],[/(ideatab[-\w ]+|602lv|d-42a|a101lv|a2109a|a3500-hv|s[56]000|pb-6505[my]|tb-?x?\d{3,4}(?:f[cu]|xu|[av])|yt\d?-[jx]?\d+[lfmx])( bui|;|\)|\/)/i,/lenovo ?(b[68]0[08]0-?[hf]?|tab(?:[\w- ]+?)|tb[\w-]{6,7})( bui|;|\)|\/)/i],[d,[p,"Lenovo"],[h,b]],[/(nokia) (t[12][01])/i],[p,d,[h,b]],[/(?:maemo|nokia).*(n900|lumia \d+|rm-\d+)/i,/nokia[-_ ]?(([-\w\. ]*))/i],[[d,/_/g," "],[h,T],[p,"Nokia"]],[/(pixel (c|tablet))\b/i],[d,[p,Ot],[h,b]],[/droid.+; (pixel[\daxl ]{0,6})(?: bui|\))/i],[d,[p,Ot],[h,T]],[/droid.+; (a?\d[0-2]{2}so|[c-g]\d{4}|so[-gl]\w+|xq-a\w[4-7][12])(?= bui|\).+chrome\/(?![1-6]{0,1}\d\.))/i],[d,[p,et],[h,T]],[/sony tablet [ps]/i,/\b(?:sony)?sgp\w+(?: bui|\))/i],[[d,"Xperia Tablet"],[p,et],[h,b]],[/ (kb2005|in20[12]5|be20[12][59])\b/i,/(?:one)?(?:plus)? (a\d0\d\d)(?: b|\))/i],[d,[p,ht],[h,T]],[/(alexa)webm/i,/(kf[a-z]{2}wi|aeo(?!bc)\w\w)( bui|\))/i,/(kf[a-z]+)( bui|\)).+silk\//i],[d,[p,U],[h,b]],[/((?:sd|kf)[0349hijorstuw]+)( bui|\)).+silk\//i],[[d,/(.+)/g,"Fire Phone $1"],[p,U],[h,T]],[/(playbook);[-\w\),; ]+(rim)/i],[d,p,[h,b]],[/\b((?:bb[a-f]|st[hv])100-\d)/i,/\(bb10; (\w+)/i],[d,[p,q],[h,T]],[/(?:\b|asus_)(transfo[prime ]{4,10} \w+|eeepc|slider \w+|nexus 7|padfone|p00[cj])/i],[d,[p,x],[h,b]],[/ (z[bes]6[027][012][km][ls]|zenfone \d\w?)\b/i],[d,[p,x],[h,T]],[/(nexus 9)/i],[d,[p,"HTC"],[h,b]],[/(htc)[-;_ ]{1,2}([\w ]+(?=\)| bui)|\w+)/i,/(zte)[- ]([\w ]+?)(?: bui|\/|\))/i,/(alcatel|geeksphone|nexian|panasonic(?!(?:;|\.))|sony(?!-bra))[-_ ]?([-\w]*)/i],[p,[d,/_/g," "],[h,T]],[/droid [\w\.]+; ((?:8[14]9[16]|9(?:0(?:48|60|8[01])|1(?:3[27]|66)|2(?:6[69]|9[56])|466))[gqswx])\w*(\)| bui)/i],[d,[p,"TCL"],[h,b]],[/(itel) ((\w+))/i],[[p,Ac],d,[h,Ia,{tablet:["p10001l","w7001"],"*":"mobile"}]],[/droid.+; ([ab][1-7]-?[0178a]\d\d?)/i],[d,[p,"Acer"],[h,b]],[/droid.+; (m[1-5] note) bui/i,/\bmz-([-\w]{2,})/i],[d,[p,"Meizu"],[h,T]],[/; ((?:power )?armor(?:[\w ]{0,8}))(?: bui|\))/i],[d,[p,"Ulefone"],[h,T]],[/; (energy ?\w+)(?: bui|\))/i,/; energizer ([\w ]+)(?: bui|\))/i],[d,[p,"Energizer"],[h,T]],[/; cat (b35);/i,/; (b15q?|s22 flip|s48c|s62 pro)(?: bui|\))/i],[d,[p,"Cat"],[h,T]],[/((?:new )?andromax[\w- ]+)(?: bui|\))/i],[d,[p,"Smartfren"],[h,T]],[/droid.+; (a(?:015|06[35]|142p?))/i],[d,[p,"Nothing"],[h,T]],[/; (x67 5g|tikeasy \w+|ac[1789]\d\w+)( b|\))/i,/archos ?(5|gamepad2?|([\w ]*[t1789]|hello) ?\d+[\w ]*)( b|\))/i],[d,[p,"Archos"],[h,b]],[/archos ([\w ]+)( b|\))/i,/; (ac[3-6]\d\w{2,8})( b|\))/i],[d,[p,"Archos"],[h,T]],[/(imo) (tab \w+)/i,/(infinix) (x1101b?)/i],[p,d,[h,b]],[/(blackberry|benq|palm(?=\-)|sonyericsson|acer|asus(?! zenw)|dell|jolla|meizu|motorola|polytron|infinix|tecno|micromax|advan)[-_ ]?([-\w]*)/i,/; (hmd|imo) ([\w ]+?)(?: bui|\))/i,/(hp) ([\w ]+\w)/i,/(microsoft); (lumia[\w ]+)/i,/(lenovo)[-_ ]?([-\w ]+?)(?: bui|\)|\/)/i,/(oppo) ?([\w ]+) bui/i],[p,d,[h,T]],[/(kobo)\s(ereader|touch)/i,/(hp).+(touchpad(?!.+tablet)|tablet)/i,/(kindle)\/([\w\.]+)/i,/(nook)[\w ]+build\/(\w+)/i,/(dell) (strea[kpr\d ]*[\dko])/i,/(le[- ]+pan)[- ]+(\w{1,9}) bui/i,/(trinity)[- ]*(t\d{3}) bui/i,/(gigaset)[- ]+(q\w{1,9}) bui/i,/(vodafone) ([\w ]+)(?:\)| bui)/i],[p,d,[h,b]],[/(surface duo)/i],[d,[p,He],[h,b]],[/droid [\d\.]+; (fp\du?)(?: b|\))/i],[d,[p,"Fairphone"],[h,T]],[/(u304aa)/i],[d,[p,"AT&T"],[h,T]],[/\bsie-(\w*)/i],[d,[p,"Siemens"],[h,T]],[/\b(rct\w+) b/i],[d,[p,"RCA"],[h,b]],[/\b(venue[\d ]{2,7}) b/i],[d,[p,"Dell"],[h,b]],[/\b(q(?:mv|ta)\w+) b/i],[d,[p,"Verizon"],[h,b]],[/\b(?:barnes[& ]+noble |bn[rt])([\w\+ ]*) b/i],[d,[p,"Barnes & Noble"],[h,b]],[/\b(tm\d{3}\w+) b/i],[d,[p,"NuVision"],[h,b]],[/\b(k88) b/i],[d,[p,"ZTE"],[h,b]],[/\b(nx\d{3}j) b/i],[d,[p,"ZTE"],[h,T]],[/\b(gen\d{3}) b.+49h/i],[d,[p,"Swiss"],[h,T]],[/\b(zur\d{3}) b/i],[d,[p,"Swiss"],[h,b]],[/\b((zeki)?tb.*\b) b/i],[d,[p,"Zeki"],[h,b]],[/\b([yr]\d{2}) b/i,/\b(dragon[- ]+touch |dt)(\w{5}) b/i],[[p,"Dragon Touch"],d,[h,b]],[/\b(ns-?\w{0,9}) b/i],[d,[p,"Insignia"],[h,b]],[/\b((nxa|next)-?\w{0,9}) b/i],[d,[p,"NextBook"],[h,b]],[/\b(xtreme\_)?(v(1[045]|2[015]|[3469]0|7[05])) b/i],[[p,"Voice"],d,[h,T]],[/\b(lvtel\-)?(v1[12]) b/i],[[p,"LvTel"],d,[h,T]],[/\b(ph-1) /i],[d,[p,"Essential"],[h,T]],[/\b(v(100md|700na|7011|917g).*\b) b/i],[d,[p,"Envizen"],[h,b]],[/\b(trio[-\w\. ]+) b/i],[d,[p,"MachSpeed"],[h,b]],[/\btu_(1491) b/i],[d,[p,"Rotor"],[h,b]],[/((?:tegranote|shield t(?!.+d tv))[\w- ]*?)(?: b|\))/i],[d,[p,rt],[h,b]],[/(sprint) (\w+)/i],[p,d,[h,T]],[/(kin\.[onetw]{3})/i],[[d,/\./g," "],[p,He],[h,T]],[/droid.+; (cc6666?|et5[16]|mc[239][23]x?|vc8[03]x?)\)/i],[d,[p,ke],[h,b]],[/droid.+; (ec30|ps20|tc[2-8]\d[kx])\)/i],[d,[p,ke],[h,T]],[/smart-tv.+(samsung)/i],[p,[h,w]],[/hbbtv.+maple;(\d+)/i],[[d,/^/,"SmartTV"],[p,N],[h,w]],[/(nux; netcast.+smarttv|lg (netcast\.tv-201\d|android tv))/i],[[p,pe],[h,w]],[/(apple) ?tv/i],[p,[d,P+" TV"],[h,w]],[/crkey/i],[[d,dt+"cast"],[p,Ot],[h,w]],[/droid.+aft(\w+)( bui|\))/i],[d,[p,U],[h,w]],[/(shield \w+ tv)/i],[d,[p,rt],[h,w]],[/\(dtv[\);].+(aquos)/i,/(aquos-tv[\w ]+)\)/i],[d,[p,L],[h,w]],[/(bravia[\w ]+)( bui|\))/i],[d,[p,et],[h,w]],[/(mi(tv|box)-?\w+) bui/i],[d,[p,Mt],[h,w]],[/Hbbtv.*(technisat) (.*);/i],[p,d,[h,w]],[/\b(roku)[\dx]*[\)\/]((?:dvp-)?[\d\.]*)/i,/hbbtv\/\d+\.\d+\.\d+ +\([\w\+ ]*; *([\w\d][^;]*);([^;]*)/i],[[p,Ku],[d,Ku],[h,w]],[/droid.+; ([\w- ]+) (?:android tv|smart[- ]?tv)/i],[d,[h,w]],[/\b(android tv|smart[- ]?tv|opera tv|tv; rv:)\b/i],[[h,w]],[/(ouya)/i,/(nintendo) ([wids3utch]+)/i],[p,d,[h,S]],[/droid.+; (shield)( bui|\))/i],[d,[p,rt],[h,S]],[/(playstation \w+)/i],[d,[p,et],[h,S]],[/\b(xbox(?: one)?(?!; xbox))[\); ]/i],[d,[p,He],[h,S]],[/\b(sm-[lr]\d\d[0156][fnuw]?s?|gear live)\b/i],[d,[p,N],[h,D]],[/((pebble))app/i,/(asus|google|lg|oppo) ((pixel |zen)?watch[\w ]*)( bui|\))/i],[p,d,[h,D]],[/(ow(?:19|20)?we?[1-3]{1,3})/i],[d,[p,g],[h,D]],[/(watch)(?: ?os[,\/]|\d,\d\/)[\d\.]+/i],[d,[p,P],[h,D]],[/(opwwe\d{3})/i],[d,[p,ht],[h,D]],[/(moto 360)/i],[d,[p,X],[h,D]],[/(smartwatch 3)/i],[d,[p,et],[h,D]],[/(g watch r)/i],[d,[p,pe],[h,D]],[/droid.+; (wt63?0{2,3})\)/i],[d,[p,ke],[h,D]],[/droid.+; (glass) \d/i],[d,[p,Ot],[h,D]],[/(pico) (4|neo3(?: link|pro)?)/i],[p,d,[h,D]],[/; (quest( \d| pro)?)/i],[d,[p,kn],[h,D]],[/(tesla)(?: qtcarbrowser|\/[-\w\.]+)/i],[p,[h,k]],[/(aeobc)\b/i],[d,[p,U],[h,k]],[/(homepod).+mac os/i],[d,[p,P],[h,k]],[/windows iot/i],[[h,k]],[/droid .+?; ([^;]+?)(?: bui|; wv\)|\) applew).+? mobile safari/i],[d,[h,T]],[/droid .+?; ([^;]+?)(?: bui|\) applew).+?(?! mobile) safari/i],[d,[h,b]],[/\b((tablet|tab)[;\/]|focus\/\d(?!.+mobile))/i],[[h,b]],[/(phone|mobile(?:[;\/]| [ \w\/\.]*safari)|pda(?=.+windows ce))/i],[[h,T]],[/droid .+?; ([\w\. -]+)( bui|\))/i],[d,[p,"Generic"]]],engine:[[/windows.+ edge\/([\w\.]+)/i],[f,[l,"EdgeHTML"]],[/(arkweb)\/([\w\.]+)/i],[l,f],[/webkit\/537\.36.+chrome\/(?!27)([\w\.]+)/i],[f,[l,"Blink"]],[/(presto)\/([\w\.]+)/i,/(webkit|trident|netfront|netsurf|amaya|lynx|w3m|goanna|servo)\/([\w\.]+)/i,/ekioh(flow)\/([\w\.]+)/i,/(khtml|tasman|links)[\/ ]\(?([\w\.]+)/i,/(icab)[\/ ]([23]\.[\d\.]+)/i,/\b(libweb)/i],[l,f],[/ladybird\//i],[[l,"LibWeb"]],[/rv\:([\w\.]{1,9})\b.+(gecko)/i],[f,l]],os:[[/microsoft (windows) (vista|xp)/i],[l,f],[/(windows (?:phone(?: os)?|mobile|iot))[\/ ]?([\d\.\w ]*)/i],[l,[f,Ia,kM]],[/windows nt 6\.2; (arm)/i,/windows[\/ ]([ntce\d\. ]+\w)(?!.+xbox)/i,/(?:win(?=3|9|n)|win 9x )([nt\d\.]+)/i],[[f,Ia,kM],[l,"Windows"]],[/[adehimnop]{4,7}\b(?:.*os ([\w]+) like mac|; opera)/i,/(?:ios;fbsv\/|iphone.+ios[\/ ])([\d\.]+)/i,/cfnetwork\/.+darwin/i],[[f,/_/g,"."],[l,"iOS"]],[/(mac os x) ?([\w\. ]*)/i,/(macintosh|mac_powerpc\b)(?!.+haiku)/i],[[l,ya],[f,/_/g,"."]],[/droid ([\w\.]+)\b.+(android[- ]x86|harmonyos)/i],[f,l],[/(ubuntu) ([\w\.]+) like android/i],[[l,/(.+)/,"$1 Touch"],f],[/(android|bada|blackberry|kaios|maemo|meego|openharmony|qnx|rim tablet os|sailfish|series40|symbian|tizen|webos)\w*[-\/; ]?([\d\.]*)/i],[l,f],[/\(bb(10);/i],[f,[l,q]],[/(?:symbian ?os|symbos|s60(?=;)|series ?60)[-\/ ]?([\w\.]*)/i],[f,[l,"Symbian"]],[/mozilla\/[\d\.]+ \((?:mobile|tablet|tv|mobile; [\w ]+); rv:.+ gecko\/([\w\.]+)/i],[f,[l,Dt+" OS"]],[/web0s;.+rt(tv)/i,/\b(?:hp)?wos(?:browser)?\/([\w\.]+)/i],[f,[l,"webOS"]],[/watch(?: ?os[,\/]|\d,\d\/)([\d\.]+)/i],[f,[l,"watchOS"]],[/crkey\/([\d\.]+)/i],[f,[l,dt+"cast"]],[/(cros) [\w]+(?:\)| ([\w\.]+)\b)/i],[[l,Ur],f],[/panasonic;(viera)/i,/(netrange)mmh/i,/(nettv)\/(\d+\.[\w\.]+)/i,/(nintendo|playstation) ([wids345portablevuch]+)/i,/(xbox); +xbox ([^\);]+)/i,/\b(joli|palm)\b ?(?:os)?\/?([\w\.]*)/i,/(mint)[\/\(\) ]?(\w*)/i,/(mageia|vectorlinux)[; ]/i,/([kxln]?ubuntu|debian|suse|opensuse|gentoo|arch(?= linux)|slackware|fedora|mandriva|centos|pclinuxos|red ?hat|zenwalk|linpus|raspbian|plan 9|minix|risc os|contiki|deepin|manjaro|elementary os|sabayon|linspire)(?: gnu\/linux)?(?: enterprise)?(?:[- ]linux)?(?:-gnu)?[-\/ ]?(?!chrom|package)([-\w\.]*)/i,/(hurd|linux)(?: arm\w*| x86\w*| ?)([\w\.]*)/i,/(gnu) ?([\w\.]*)/i,/\b([-frentopcghs]{0,5}bsd|dragonfly)[\/ ]?(?!amd|[ix346]{1,2}86)([\w\.]*)/i,/(haiku) (\w+)/i],[l,f],[/(sunos) ?([\w\.\d]*)/i],[[l,"Solaris"],f],[/((?:open)?solaris)[-\/ ]?([\w\.]*)/i,/(aix) ((\d)(?=\.|\)| )[\w\.])*/i,/\b(beos|os\/2|amigaos|morphos|openvms|fuchsia|hp-ux|serenityos)/i,/(unix) ?([\w\.]*)/i],[l,f]]},ks=function(Rn,bn){if(typeof Rn===o&&(bn=Rn,Rn=i),!(this instanceof ks))return new ks(Rn,bn).getResult();var Be=typeof n!==s&&n.navigator?n.navigator:i,Fi=Rn||(Be&&Be.userAgent?Be.userAgent:""),Ms=Be&&Be.userAgentData?Be.userAgentData:i,dn=bn?(function(ae,Us){var Oc={};for(var po in ae)Us[po]&&Us[po].length%2==0?Oc[po]=Us[po].concat(ae[po]):Oc[po]=ae[po];return Oc})(MM,bn):MM,xo=Be&&Be.userAgent==Fi;return this.getBrowser=function(){var ae={};return ae[l]=i,ae[f]=i,wc.call(ae,Fi,dn.browser),ae[c]=(function(Us){return typeof Us===a?Us.replace(/[^\d\.]/g,"").split(".")[0]:i})(ae[f]),xo&&Be&&Be.brave&&typeof Be.brave.isBrave==r&&(ae[l]="Brave"),ae},this.getCPU=function(){var ae={};return ae[v]=i,wc.call(ae,Fi,dn.cpu),ae},this.getDevice=function(){var ae={};return ae[p]=i,ae[d]=i,ae[h]=i,wc.call(ae,Fi,dn.device),xo&&!ae[h]&&Ms&&Ms.mobile&&(ae[h]=T),xo&&ae[d]=="Macintosh"&&Be&&typeof Be.standalone!==s&&Be.maxTouchPoints&&Be.maxTouchPoints>2&&(ae[d]="iPad",ae[h]=b),ae},this.getEngine=function(){var ae={};return ae[l]=i,ae[f]=i,wc.call(ae,Fi,dn.engine),ae},this.getOS=function(){var ae={};return ae[l]=i,ae[f]=i,wc.call(ae,Fi,dn.os),xo&&!ae[l]&&Ms&&Ms.platform&&Ms.platform!="Unknown"&&(ae[l]=Ms.platform.replace(/chrome os/i,Ur).replace(/macos/i,ya)),ae},this.getResult=function(){return{ua:this.getUA(),browser:this.getBrowser(),engine:this.getEngine(),os:this.getOS(),device:this.getDevice(),cpu:this.getCPU()}},this.getUA=function(){return Fi},this.setUA=function(ae){return Fi=typeof ae===a&&ae.length>500?Ku(ae,500):ae,this},this.setUA(Fi),this};ks.VERSION="0.7.41",ks.BROWSER=il([l,f,c]),ks.CPU=il([v]),ks.DEVICE=il([d,p,h,S,T,w,b,D,k]),ks.ENGINE=ks.OS=il([l,f]),t.exports&&(e=t.exports=ks),e.UAParser=ks;var rl=typeof n!==s&&(n.jQuery||n.Zepto);if(rl&&!rl.ua){var ff=new ks;rl.ua=ff.getResult(),rl.ua.get=function(){return ff.getUA()},rl.ua.set=function(Rn){ff.setUA(Rn);var bn=ff.getResult();for(var Be in bn)rl.ua[Be]=bn[Be]}}})(typeof window=="object"?window:C)})(rg,rg.exports);var P4=y(rg.exports),Yb=Fh.clear;ge({global:!0,bind:!0,forced:vt.clearImmediate!==Yb},{clearImmediate:Yb});var qb=vt,L4=ie,k4=sn,M4=om,U4=Ye,x4=$o,V4=xa,F4=qb.Function,B4=/MSIE .\./.test(U4)||M4==="BUN"&&(function(){var t=qb.Bun.version.split(".");return t.length<3||t[0]==="0"&&(t[1]<3||t[1]==="3"&&t[2]==="0")})(),j4=ge,zb=vt,Xb=Fh.set,G4=function(t,e){var n=1;return B4?function(i,r){var s=V4(arguments.length,1)>n,o=k4(i)?i:F4(i),a=s?x4(arguments,n):[],c=s?function(){L4(o,this,a)}:o;return t(c)}:t},Jb=zb.setImmediate?G4(Xb):Xb;j4({global:!0,bind:!0,forced:zb.setImmediate!==Jb},{setImmediate:Jb});var Qb=y(It.setImmediate),W4=vt,H4=ry,K4=ar,Y4=xa,q4=zn;ge({global:!0,dontCallGetSet:!0,forced:O((function(){return q4&&Object.getOwnPropertyDescriptor(W4,"queueMicrotask").value.length!==1}))},{queueMicrotask:function(t){Y4(arguments.length,1),H4(K4(t))}});var Zb=y(It.queueMicrotask);function $b(t,e){return function(){return t.apply(e,arguments)}}const{toString:z4}=Object.prototype,{getPrototypeOf:sg}=Object,{iterator:pp,toStringTag:tA}=Symbol,_p=(og=Object.create(null),t=>{const e=z4.call(t);return og[e]||(og[e]=e.slice(8,-1).toLowerCase())});var og;const Es=t=>(t=t.toLowerCase(),e=>_p(e)===t),fp=t=>e=>typeof e===t,{isArray:dd}=Array,ld=fp("undefined");function Wl(t){return t!==null&&!ld(t)&&t.constructor!==null&&!ld(t.constructor)&&cr(t.constructor.isBuffer)&&t.constructor.isBuffer(t)}const eA=Es("ArrayBuffer"),X4=fp("string"),cr=fp("function"),nA=fp("number"),Hl=t=>t!==null&&typeof t=="object",mp=t=>{if(_p(t)!=="object")return!1;const e=sg(t);return!(e!==null&&e!==Object.prototype&&Object.getPrototypeOf(e)!==null||tA in t||pp in t)},J4=Es("Date"),Q4=Es("File"),Z4=Es("Blob"),$4=Es("FileList"),tH=Es("URLSearchParams"),[eH,nH,iH,rH]=["ReadableStream","Request","Response","Headers"].map(Es);function Kl(t,e){let n,i,{allOwnKeys:r=!1}=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};if(t!=null)if(typeof t!="object"&&(t=[t]),dd(t))for(n=0,i=t.length;n<i;n++)e.call(null,t[n],n,t);else{if(Wl(t))return;const s=r?Object.getOwnPropertyNames(t):Object.keys(t),o=s.length;let a;for(n=0;n<o;n++)a=s[n],e.call(null,t[a],a,t)}}function iA(t,e){if(Wl(t))return null;e=e.toLowerCase();const n=Object.keys(t);let i,r=n.length;for(;r-- >0;)if(i=n[r],e===i.toLowerCase())return i;return null}const Ha=Kb!==void 0?Kb:typeof self<"u"?self:typeof window<"u"?window:IR,rA=t=>!ld(t)&&t!==Ha,sH=(ag=typeof Uint8Array<"u"&&sg(Uint8Array),t=>ag&&t instanceof ag);var ag;const oH=Es("HTMLFormElement"),sA=(t=>{let{hasOwnProperty:e}=t;return(n,i)=>e.call(n,i)})(Object.prototype),aH=Es("RegExp"),oA=(t,e)=>{const n=Object.getOwnPropertyDescriptors(t),i={};Kl(n,((r,s)=>{let o;(o=e(r,s,t))!==!1&&(i[s]=o||r)})),Object.defineProperties(t,i)},cH=Es("AsyncFunction"),aA=(cA=typeof Qb=="function",dA=cr(Ha.postMessage),cA?Qb:dA?(cg="axios@".concat(Math.random()),Ep=[],Ha.addEventListener("message",(t=>{let{source:e,data:n}=t;e===Ha&&n===cg&&Ep.length&&Ep.shift()()}),!1),t=>{Ep.push(t),Ha.postMessage(cg,"*")}):t=>setTimeout(t));var cA,dA,cg,Ep;const dH=Zb!==void 0?Zb.bind(Ha):typeof process<"u"&&process.nextTick||aA;var at={isArray:dd,isArrayBuffer:eA,isBuffer:Wl,isFormData:t=>{let e;return t&&(typeof FormData=="function"&&t instanceof FormData||cr(t.append)&&((e=_p(t))==="formdata"||e==="object"&&cr(t.toString)&&t.toString()==="[object FormData]"))},isArrayBufferView:function(t){let e;return e=typeof ArrayBuffer<"u"&&ArrayBuffer.isView?ArrayBuffer.isView(t):t&&t.buffer&&eA(t.buffer),e},isString:X4,isNumber:nA,isBoolean:t=>t===!0||t===!1,isObject:Hl,isPlainObject:mp,isEmptyObject:t=>{if(!Hl(t)||Wl(t))return!1;try{return Object.keys(t).length===0&&Object.getPrototypeOf(t)===Object.prototype}catch{return!1}},isReadableStream:eH,isRequest:nH,isResponse:iH,isHeaders:rH,isUndefined:ld,isDate:J4,isFile:Q4,isBlob:Z4,isRegExp:aH,isFunction:cr,isStream:t=>Hl(t)&&cr(t.pipe),isURLSearchParams:tH,isTypedArray:sH,isFileList:$4,forEach:Kl,merge:function t(){const{caseless:e,skipUndefined:n}=rA(this)&&this||{},i={},r=(s,o)=>{const a=e&&iA(i,o)||o;mp(i[a])&&mp(s)?i[a]=t(i[a],s):mp(s)?i[a]=t({},s):dd(s)?i[a]=s.slice():n&&ld(s)||(i[a]=s)};for(let s=0,o=arguments.length;s<o;s++)arguments[s]&&Kl(arguments[s],r);return i},extend:function(t,e,n){let{allOwnKeys:i}=arguments.length>3&&arguments[3]!==void 0?arguments[3]:{};return Kl(e,((r,s)=>{n&&cr(r)?t[s]=$b(r,n):t[s]=r}),{allOwnKeys:i}),t},trim:t=>_i(t)?_i(t).call(t):t.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,""),stripBOM:t=>(t.charCodeAt(0)===65279&&(t=t.slice(1)),t),inherits:(t,e,n,i)=>{t.prototype=Object.create(e.prototype,i),t.prototype.constructor=t,Object.defineProperty(t,"super",{value:e.prototype}),n&&Object.assign(t.prototype,n)},toFlatObject:(t,e,n,i)=>{let r,s,o;const a={};if(e=e||{},t==null)return e;do{for(r=Object.getOwnPropertyNames(t),s=r.length;s-- >0;)o=r[s],i&&!i(o,t,e)||a[o]||(e[o]=t[o],a[o]=!0);t=n!==!1&&sg(t)}while(t&&(!n||n(t,e))&&t!==Object.prototype);return e},kindOf:_p,kindOfTest:Es,endsWith:(t,e,n)=>{t=String(t),(n===void 0||n>t.length)&&(n=t.length),n-=e.length;const i=t.indexOf(e,n);return i!==-1&&i===n},toArray:t=>{if(!t)return null;if(dd(t))return t;let e=t.length;if(!nA(e))return null;const n=new Array(e);for(;e-- >0;)n[e]=t[e];return n},forEachEntry:(t,e)=>{const n=(t&&t[pp]).call(t);let i;for(;(i=n.next())&&!i.done;){const r=i.value;e.call(t,r[0],r[1])}},matchAll:(t,e)=>{let n;const i=[];for(;(n=t.exec(e))!==null;)i.push(n);return i},isHTMLForm:oH,hasOwnProperty:sA,hasOwnProp:sA,reduceDescriptors:oA,freezeMethods:t=>{oA(t,((e,n)=>{if(cr(t)&&["arguments","caller","callee"].indexOf(n)!==-1)return!1;const i=t[n];cr(i)&&(e.enumerable=!1,"writable"in e?e.writable=!1:e.set||(e.set=()=>{throw Error("Can not rewrite read-only method '"+n+"'")}))}))},toObjectSet:(t,e)=>{const n={},i=r=>{r.forEach((s=>{n[s]=!0}))};return dd(t)?i(t):i(String(t).split(e)),n},toCamelCase:t=>t.toLowerCase().replace(/[-_\s]([a-z\d])(\w*)/g,(function(e,n,i){return n.toUpperCase()+i})),noop:()=>{},toFiniteNumber:(t,e)=>t!=null&&Number.isFinite(t=+t)?t:e,findKey:iA,global:Ha,isContextDefined:rA,isSpecCompliantForm:function(t){return!!(t&&cr(t.append)&&t[tA]==="FormData"&&t[pp])},toJSONObject:t=>{const e=new Array(10),n=(i,r)=>{if(Hl(i)){if(e.indexOf(i)>=0)return;if(Wl(i))return i;if(!("toJSON"in i)){e[r]=i;const s=dd(i)?[]:{};return Kl(i,((o,a)=>{const c=n(o,r+1);!ld(c)&&(s[a]=c)})),e[r]=void 0,s}}return i};return n(t,0)},isAsyncFn:cH,isThenable:t=>t&&(Hl(t)||cr(t))&&cr(t.then)&&cr(t.catch),setImmediate:aA,asap:dH,isIterable:t=>t!=null&&cr(t[pp])};function we(t,e,n,i,r){Error.call(this),Error.captureStackTrace?Error.captureStackTrace(this,this.constructor):this.stack=new Error().stack,this.message=t,this.name="AxiosError",e&&(this.code=e),n&&(this.config=n),i&&(this.request=i),r&&(this.response=r,this.status=r.status?r.status:null)}at.inherits(we,Error,{toJSON:function(){return{message:this.message,name:this.name,description:this.description,number:this.number,fileName:this.fileName,lineNumber:this.lineNumber,columnNumber:this.columnNumber,stack:this.stack,config:at.toJSONObject(this.config),code:this.code,status:this.status}}});const lA=we.prototype,uA={};["ERR_BAD_OPTION_VALUE","ERR_BAD_OPTION","ECONNABORTED","ETIMEDOUT","ERR_NETWORK","ERR_FR_TOO_MANY_REDIRECTS","ERR_DEPRECATED","ERR_BAD_RESPONSE","ERR_BAD_REQUEST","ERR_CANCELED","ERR_NOT_SUPPORT","ERR_INVALID_URL"].forEach((t=>{uA[t]={value:t}})),Object.defineProperties(we,uA),Object.defineProperty(lA,"isAxiosError",{value:!0}),we.from=(t,e,n,i,r,s)=>{const o=Object.create(lA);at.toFlatObject(t,o,(function(d){return d!==Error.prototype}),(d=>d!=="isAxiosError"));const a=t&&t.message?t.message:"Error",c=e==null&&t?t.code:e;return we.call(o,a,c,n,i,r),t&&o.cause==null&&Object.defineProperty(o,"cause",{value:t,configurable:!0}),o.name=t&&t.name||"Error",s&&Object.assign(o,s),o};function dg(t){return at.isPlainObject(t)||at.isArray(t)}function hA(t){return at.endsWith(t,"[]")?t.slice(0,-2):t}function pA(t,e,n){return t?t.concat(e).map((function(i,r){return i=hA(i),!n&&r?"["+i+"]":i})).join(n?".":""):e}const lH=at.toFlatObject(at,{},null,(function(t){return/^is[A-Z]/.test(t)}));function gp(t,e,n){if(!at.isObject(t))throw new TypeError("target must be an object");e=e||new FormData;const i=(n=at.toFlatObject(n,{metaTokens:!0,dots:!1,indexes:!1},!1,(function(p,f){return!at.isUndefined(f[p])}))).metaTokens,r=n.visitor||d,s=n.dots,o=n.indexes,a=(n.Blob||typeof Blob<"u"&&Blob)&&at.isSpecCompliantForm(e);if(!at.isFunction(r))throw new TypeError("visitor must be a function");function c(p){if(p===null)return"";if(at.isDate(p))return p.toISOString();if(at.isBoolean(p))return p.toString();if(!a&&at.isBlob(p))throw new we("Blob is not supported. Use a Buffer instead.");return at.isArrayBuffer(p)||at.isTypedArray(p)?a&&typeof Blob=="function"?new Blob([p]):Buffer.from(p):p}function d(p,f,v){let S=p;if(p&&!v&&typeof p=="object"){if(at.endsWith(f,"{}"))f=i?f:f.slice(0,-2),p=JSON.stringify(p);else if(at.isArray(p)&&(function(T){return at.isArray(T)&&!T.some(dg)})(p)||(at.isFileList(p)||at.endsWith(f,"[]"))&&(S=at.toArray(p)))return f=hA(f),S.forEach((function(T,b){!at.isUndefined(T)&&T!==null&&e.append(o===!0?pA([f],b,s):o===null?f:f+"[]",c(T))})),!1}return!!dg(p)||(e.append(pA(v,f,s),c(p)),!1)}const l=[],h=Object.assign(lH,{defaultVisitor:d,convertValue:c,isVisitable:dg});if(!at.isObject(t))throw new TypeError("data must be an object");return(function p(f,v){if(!at.isUndefined(f)){if(l.indexOf(f)!==-1)throw Error("Circular reference detected in "+v.join("."));l.push(f),at.forEach(f,(function(S,T){(!(at.isUndefined(S)||S===null)&&r.call(e,S,at.isString(T)?_i(T).call(T):T,v,h))===!0&&p(S,v?v.concat(T):[T])})),l.pop()}})(t),e}function _A(t){const e={"!":"%21","'":"%27","(":"%28",")":"%29","~":"%7E","%20":"+","%00":"\0"};return encodeURIComponent(t).replace(/[!'()~]|%20|%00/g,(function(n){return e[n]}))}function lg(t,e){this._pairs=[],t&&gp(t,this,e)}const fA=lg.prototype;function uH(t){return encodeURIComponent(t).replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,"+")}function mA(t,e,n){if(!e)return t;const i=n&&n.encode||uH;at.isFunction(n)&&(n={serialize:n});const r=n&&n.serialize;let s;if(s=r?r(e,n):at.isURLSearchParams(e)?e.toString():new lg(e,n).toString(i),s){const o=t.indexOf("#");o!==-1&&(t=t.slice(0,o)),t+=(t.indexOf("?")===-1?"?":"&")+s}return t}fA.append=function(t,e){this._pairs.push([t,e])},fA.toString=function(t){const e=t?function(n){return t.call(this,n,_A)}:_A;return this._pairs.map((function(n){return e(n[0])+"="+e(n[1])}),"").join("&")};var EA=class{constructor(){this.handlers=[]}use(t,e,n){return this.handlers.push({fulfilled:t,rejected:e,synchronous:!!n&&n.synchronous,runWhen:n?n.runWhen:null}),this.handlers.length-1}eject(t){this.handlers[t]&&(this.handlers[t]=null)}clear(){this.handlers&&(this.handlers=[])}forEach(t){at.forEach(this.handlers,(function(e){e!==null&&t(e)}))}},gA={silentJSONParsing:!0,forcedJSONParsing:!0,clarifyTimeoutError:!1},SA={exports:{}},hH=ge,pH=zn,TA=Hr.f;hH({target:"Object",stat:!0,forced:Object.defineProperty!==TA,sham:!pH},{defineProperty:TA});var RA=It.Object,_H=SA.exports=function(t,e,n){return RA.defineProperty(t,e,n)};RA.defineProperty.sham&&(_H.sham=!0);var vA=y(SA.exports),fH=TypeError,CA=yl,mH=Vh,EH=bt,gH=gn("species"),yA=Array,SH=function(t){var e;return CA(t)&&(e=t.constructor,(mH(e)&&(e===yA||CA(e.prototype))||EH(e)&&(e=e[gH])===null)&&(e=void 0)),e===void 0?yA:e},IA=function(t,e){return new(SH(t))(e===0?0:e)},TH=O,RH=Gs,vH=gn("species"),bA=function(t){return RH>=51||!TH((function(){var e=[];return(e.constructor={})[vH]=function(){return{foo:1}},e[t](Boolean).foo!==1}))},CH=ge,yH=O,IH=yl,bH=bt,AH=Ws,wH=Jo,AA=function(t){if(t>9007199254740991)throw fH("Maximum allowed index exceeded");return t},wA=SE,OH=IA,NH=bA,DH=Gs,OA=gn("isConcatSpreadable"),PH=DH>=51||!yH((function(){var t=[];return t[OA]=!1,t.concat()[0]!==t})),LH=function(t){if(!bH(t))return!1;var e=t[OA];return e!==void 0?!!e:IH(t)};CH({target:"Array",proto:!0,forced:!PH||!NH("concat")},{concat:function(t){var e,n,i,r,s,o=AH(this),a=OH(o,0),c=0;for(e=-1,i=arguments.length;e<i;e++)if(LH(s=e===-1?o:arguments[e]))for(r=wH(s),AA(c+r),n=0;n<r;n++,c++)n in s&&wA(a,c,s[n]);else AA(c+1),wA(a,c++,s);return a.length=c,a}});var NA={},kH=Je,MH=St,DA=vh.f,UH=$o,PA=typeof window=="object"&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[];NA.f=function(t){return PA&&kH(t)==="Window"?(function(e){try{return DA(e)}catch{return UH(PA)}})(t):DA(MH(t))};var ud={},xH=gn;ud.f=xH;var LA=It,VH=ii,FH=ud,BH=Hr.f,Hn=function(t){var e=LA.Symbol||(LA.Symbol={});VH(e,t)||BH(e,t,{value:FH.f(t)})},jH=ue,GH=jt,WH=gn,HH=Zo,kA=function(){var t=GH("Symbol"),e=t&&t.prototype,n=e&&e.valueOf,i=WH("toPrimitive");e&&!e[i]&&HH(e,i,(function(r){return jH(n,this)}),{})},KH=Xo,YH=kt,qH=Ws,zH=Jo,XH=IA,MA=W([].push),JH=function(t){var e=t===1,n=t===2,i=t===3,r=t===4,s=t===6,o=t===7,a=t===5||s;return function(c,d,l,h){for(var p,f,v=qH(c),S=YH(v),T=zH(S),b=KH(d,l),w=0,D=h||XH,k=e?D(c,T):n||o?D(c,0):void 0;T>w;w++)if((a||w in S)&&(f=b(p=S[w],w,v),t))if(e)k[w]=f;else if(f)switch(t){case 3:return!0;case 5:return p;case 6:return w;case 2:MA(k,p)}else switch(t){case 4:return!1;case 7:MA(k,p)}return s?-1:i||r?r:k}},UA={forEach:JH(0)},Sp=ge,Yl=vt,ug=ue,QH=W,hd=zn,pd=vo,ZH=O,fi=ii,$H=Z,hg=Ki,Tp=St,pg=Yf,tK=Yi,_g=Hi,_d=bl,xA=yh,eK=vh,VA=NA,nK=Il,FA=Wi,BA=Hr,iK=pm,jA=ze,GA=Zo,rK=xh,fg=Fc,WA=Ch,HA=Hf,sK=gn,oK=ud,aK=Hn,cK=kA,dK=Co,KA=Ua,Rp=UA.forEach,dr=Rh("hidden"),vp="Symbol",ql="prototype",lK=KA.set,YA=KA.getterFor(vp),gs=Object[ql],Ka=Yl.Symbol,Cp=Ka&&Ka[ql],uK=Yl.RangeError,hK=Yl.TypeError,mg=Yl.QObject,qA=FA.f,Ya=BA.f,zA=VA.f,pK=jA.f,XA=QH([].push),bo=fg("symbols"),zl=fg("op-symbols"),_K=fg("wks"),Eg=!mg||!mg[ql]||!mg[ql].findChild,JA=function(t,e,n){var i=qA(gs,e);i&&delete gs[e],Ya(t,e,n),i&&t!==gs&&Ya(gs,e,i)},gg=hd&&ZH((function(){return _d(Ya({},"a",{get:function(){return Ya(this,"a",{value:7}).a}})).a!==7}))?JA:Ya,Sg=function(t,e){var n=bo[t]=_d(Cp);return lK(n,{type:vp,tag:t,description:e}),hd||(n.description=e),n},yp=function(t,e,n){t===gs&&yp(zl,e,n),hg(t);var i=pg(e);return hg(n),fi(bo,i)?(n.enumerable?(fi(t,dr)&&t[dr][i]&&(t[dr][i]=!1),n=_d(n,{enumerable:_g(0,!1)})):(fi(t,dr)||Ya(t,dr,_g(1,_d(null))),t[dr][i]=!0),gg(t,i,n)):Ya(t,i,n)},Tg=function(t,e){hg(t);var n=Tp(e),i=xA(n).concat(tw(n));return Rp(i,(function(r){hd&&!ug(QA,n,r)||yp(t,r,n[r])})),t},QA=function(t){var e=pg(t),n=ug(pK,this,e);return!(this===gs&&fi(bo,e)&&!fi(zl,e))&&(!(n||!fi(this,e)||!fi(bo,e)||fi(this,dr)&&this[dr][e])||n)},ZA=function(t,e){var n=Tp(t),i=pg(e);if(n!==gs||!fi(bo,i)||fi(zl,i)){var r=qA(n,i);return!r||!fi(bo,i)||fi(n,dr)&&n[dr][i]||(r.enumerable=!0),r}},$A=function(t){var e=zA(Tp(t)),n=[];return Rp(e,(function(i){fi(bo,i)||fi(WA,i)||XA(n,i)})),n},tw=function(t){var e=t===gs,n=zA(e?zl:Tp(t)),i=[];return Rp(n,(function(r){!fi(bo,r)||e&&!fi(gs,r)||XA(i,bo[r])})),i};pd||(Ka=function(){if($H(Cp,this))throw new hK("Symbol is not a constructor");var t=arguments.length&&arguments[0]!==void 0?tK(arguments[0]):void 0,e=HA(t),n=function(i){var r=this===void 0?Yl:this;r===gs&&ug(n,zl,i),fi(r,dr)&&fi(r[dr],e)&&(r[dr][e]=!1);var s=_g(1,i);try{gg(r,e,s)}catch(o){if(!(o instanceof uK))throw o;JA(r,e,s)}};return hd&&Eg&&gg(gs,e,{configurable:!0,set:n}),Sg(e,t)},GA(Cp=Ka[ql],"toString",(function(){return YA(this).tag})),GA(Ka,"withoutSetter",(function(t){return Sg(HA(t),t)})),jA.f=QA,BA.f=yp,iK.f=Tg,FA.f=ZA,eK.f=VA.f=$A,nK.f=tw,oK.f=function(t){return Sg(sK(t),t)},hd&&rK(Cp,"description",{configurable:!0,get:function(){return YA(this).description}})),Sp({global:!0,wrap:!0,forced:!pd,sham:!pd},{Symbol:Ka}),Rp(xA(_K),(function(t){aK(t)})),Sp({target:vp,stat:!0,forced:!pd},{useSetter:function(){Eg=!0},useSimple:function(){Eg=!1}}),Sp({target:"Object",stat:!0,forced:!pd,sham:!hd},{create:function(t,e){return e===void 0?_d(t):Tg(_d(t),e)},defineProperty:yp,defineProperties:Tg,getOwnPropertyDescriptor:ZA}),Sp({target:"Object",stat:!0,forced:!pd},{getOwnPropertyNames:$A}),cK(),dK(Ka,vp),WA[dr]=!0;var ew=vo&&!!Symbol.for&&!!Symbol.keyFor,fK=ge,mK=jt,EK=ii,gK=Yi,nw=Fc,SK=ew,Rg=nw("string-to-symbol-registry"),TK=nw("symbol-to-string-registry");fK({target:"Symbol",stat:!0,forced:!SK},{for:function(t){var e=gK(t);if(EK(Rg,e))return Rg[e];var n=mK("Symbol")(e);return Rg[e]=n,TK[n]=e,n}});var RK=ge,vK=ii,CK=Sl,yK=Vc,IK=ew,iw=Fc("symbol-to-string-registry");RK({target:"Symbol",stat:!0,forced:!IK},{keyFor:function(t){if(!CK(t))throw new TypeError(yK(t)+" is not a symbol");if(vK(iw,t))return iw[t]}});var rw=yl,bK=sn,sw=Je,AK=Yi,ow=W([].push),wK=ge,aw=jt,cw=ie,OK=ue,Xl=W,dw=O,lw=sn,uw=Sl,hw=$o,NK=function(t){if(bK(t))return t;if(rw(t)){for(var e=t.length,n=[],i=0;i<e;i++){var r=t[i];typeof r=="string"?ow(n,r):typeof r!="number"&&sw(r)!=="Number"&&sw(r)!=="String"||ow(n,AK(r))}var s=n.length,o=!0;return function(a,c){if(o)return o=!1,c;if(rw(this))return c;for(var d=0;d<s;d++)if(n[d]===a)return c}}},DK=vo,PK=String,sa=aw("JSON","stringify"),Ip=Xl(/./.exec),pw=Xl("".charAt),LK=Xl("".charCodeAt),kK=Xl("".replace),MK=Xl(1.1.toString),UK=/[\uD800-\uDFFF]/g,_w=/^[\uD800-\uDBFF]$/,fw=/^[\uDC00-\uDFFF]$/,mw=!DK||dw((function(){var t=aw("Symbol")("stringify detection");return sa([t])!=="[null]"||sa({a:t})!=="{}"||sa(Object(t))!=="{}"})),Ew=dw((function(){return sa("\uDF06\uD834")!=='"\\udf06\\ud834"'||sa("\uDEAD")!=='"\\udead"'})),xK=function(t,e){var n=hw(arguments),i=NK(e);if(lw(i)||t!==void 0&&!uw(t))return n[1]=function(r,s){if(lw(i)&&(s=OK(i,this,PK(r),s)),!uw(s))return s},cw(sa,null,n)},VK=function(t,e,n){var i=pw(n,e-1),r=pw(n,e+1);return Ip(_w,t)&&!Ip(fw,r)||Ip(fw,t)&&!Ip(_w,i)?"\\u"+MK(LK(t,0),16):t};sa&&wK({target:"JSON",stat:!0,forced:mw||Ew},{stringify:function(t,e,n){var i=hw(arguments),r=cw(mw?xK:sa,null,i);return Ew&&typeof r=="string"?kK(r,UK,VK):r}});var gw=Il,FK=Ws;ge({target:"Object",stat:!0,forced:!vo||O((function(){gw.f(1)}))},{getOwnPropertySymbols:function(t){var e=gw.f;return e?e(FK(t)):[]}}),Hn("asyncDispose"),Hn("asyncIterator"),Hn("dispose"),Hn("hasInstance"),Hn("isConcatSpreadable"),Hn("iterator"),Hn("match"),Hn("matchAll"),Hn("replace"),Hn("search"),Hn("species"),Hn("split");var BK=kA;Hn("toPrimitive"),BK();var jK=jt,GK=Co;Hn("toStringTag"),GK(jK("Symbol"),"Symbol"),Hn("unscopables"),Co(vt.JSON,"JSON",!0);var WK=It.Symbol,HK=gn,KK=Hr.f,Sw=HK("metadata"),Tw=Function.prototype;Tw[Sw]===void 0&&KK(Tw,Sw,{value:null}),Hn("metadata");var YK=WK,qK=W,vg=jt("Symbol"),zK=vg.keyFor,XK=qK(vg.prototype.valueOf),Rw=vg.isRegisteredSymbol||function(t){try{return zK(XK(t))!==void 0}catch{return!1}};ge({target:"Symbol",stat:!0},{isRegisteredSymbol:Rw});for(var JK=Fc,vw=jt,QK=W,ZK=Sl,$K=gn,bp=vw("Symbol"),Cw=bp.isWellKnownSymbol,yw=vw("Object","getOwnPropertyNames"),t6=QK(bp.prototype.valueOf),Iw=JK("wks"),Cg=0,bw=yw(bp),e6=bw.length;Cg<e6;Cg++)try{var Aw=bw[Cg];ZK(bp[Aw])&&$K(Aw)}catch{}var ww=function(t){if(Cw&&Cw(t))return!0;try{for(var e=t6(t),n=0,i=yw(Iw),r=i.length;n<r;n++)if(Iw[i[n]]==e)return!0}catch{}return!1};ge({target:"Symbol",stat:!0,forced:!0},{isWellKnownSymbol:ww}),Hn("customMatcher"),Hn("observable"),ge({target:"Symbol",stat:!0},{isRegistered:Rw}),ge({target:"Symbol",stat:!0,forced:!0},{isWellKnown:ww}),Hn("matcher"),Hn("metadataKey"),Hn("patternMatch"),Hn("replaceAll");var fd=y(YK),Ow=y(ud.f("iterator"));function Jl(t){return Jl=typeof fd=="function"&&typeof Ow=="symbol"?function(e){return typeof e}:function(e){return e&&typeof fd=="function"&&e.constructor===fd&&e!==fd.prototype?"symbol":typeof e},Jl(t)}var n6=y(ud.f("toPrimitive"));function i6(t){var e=(function(n,i){if(Jl(n)!="object"||!n)return n;var r=n[n6];if(r!==void 0){var s=r.call(n,i);if(Jl(s)!="object")return s;throw new TypeError("@@toPrimitive must return a primitive value.")}return(i==="string"?String:Number)(n)})(t,"string");return Jl(e)=="symbol"?e:e+""}function R(t,e,n){return(e=i6(e))in t?vA(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}var Nw=y(OW),r6={isBrowser:!0,classes:{URLSearchParams:Nw!==void 0?Nw:lg,FormData:typeof FormData<"u"?FormData:null,Blob:typeof Blob<"u"?Blob:null},protocols:["http","https","file","blob","url","data"]};const yg=typeof window<"u"&&typeof document<"u",Ig=typeof navigator=="object"&&navigator||void 0,s6=yg&&(!Ig||["ReactNative","NativeScript","NS"].indexOf(Ig.product)<0),o6=typeof WorkerGlobalScope<"u"&&self instanceof WorkerGlobalScope&&typeof self.importScripts=="function",a6=yg&&window.location.href||"http://localhost";function Dw(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable}))),n.push.apply(n,i)}return n}function Pw(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?Dw(Object(n),!0).forEach((function(i){R(t,i,n[i])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):Dw(Object(n)).forEach((function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i))}))}return t}var ki=Pw(Pw({},Object.freeze({__proto__:null,hasBrowserEnv:yg,hasStandardBrowserEnv:s6,hasStandardBrowserWebWorkerEnv:o6,navigator:Ig,origin:a6})),r6);function Lw(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable}))),n.push.apply(n,i)}return n}function c6(t,e){return gp(t,new ki.classes.URLSearchParams,(function(n){for(var i=1;i<arguments.length;i++){var r=arguments[i]!=null?arguments[i]:{};i%2?Lw(Object(r),!0).forEach((function(s){R(n,s,r[s])})):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(r)):Lw(Object(r)).forEach((function(s){Object.defineProperty(n,s,Object.getOwnPropertyDescriptor(r,s))}))}return n})({visitor:function(n,i,r,s){return ki.isNode&&at.isBuffer(n)?(this.append(i,n.toString("base64")),!1):s.defaultVisitor.apply(this,arguments)}},e))}var d6=sE.charAt,kw=ue,l6=Ki,u6=sn,h6=Je,p6=/./.exec,_6=TypeError,f6=ge,Mw=ue,Uw=Pi,m6=bm,Ap=Mh,xw=K,Vw=kv,Ql=Yi,E6=Ki,g6=bt,S6=Je,T6=nm,Fw=JE,R6=Tl,v6=O,C6=Pm,y6=function(t,e,n){return e+(n?d6(t,e).length:1)},I6=function(t,e){var n=t.exec;if(u6(n)){var i=kw(n,t,e);return i!==null&&l6(i),i}if(h6(t)==="RegExp")return kw(p6,t,e);throw new _6("RegExp#exec called on incompatible receiver")},Bw=Ua,b6=gn("matchAll"),jw="RegExp String",Gw=jw+" Iterator",A6=Bw.set,w6=Bw.getterFor(Gw),O6=TypeError,bg=Uw("".indexOf),wp=Uw("".matchAll),Ag=!!wp&&!v6((function(){wp("a",/./)})),N6=m6((function(t,e,n,i){A6(this,{type:Gw,regexp:t,string:e,global:n,unicode:i,done:!1})}),jw,(function(){var t=w6(this);if(t.done)return Ap(void 0,!0);var e=t.regexp,n=t.string,i=I6(e,n);return i===null?(t.done=!0,Ap(void 0,!0)):t.global?(Ql(i[0])===""&&(e.lastIndex=y6(n,Vw(e.lastIndex),t.unicode)),Ap(i,!1)):(t.done=!0,Ap(i,!1))})),Ww=function(t){var e,n,i,r=E6(this),s=Ql(t),o=C6(r,RegExp),a=Ql(Fw(r));return e=new o(o===RegExp?r.source:r,a),n=!!~bg(a,"g"),i=!!~bg(a,"u"),e.lastIndex=Vw(r.lastIndex),new N6(e,s,n,i)};f6({target:"String",proto:!0,forced:Ag},{matchAll:function(t){var e,n,i,r,s=xw(this);if(g6(t)){if(T6(t)&&(e=Ql(xw(Fw(t))),!~bg(e,"g")))throw new O6("`.matchAll` does not allow non-global regexes");if(Ag)return wp(s,t);if((i=R6(t,b6))===void 0&&S6(t)==="RegExp"&&(i=Ww),i)return Mw(i,t,s)}else if(Ag)return wp(s,t);return n=Ql(s),r=new RegExp(t,"g"),Mw(Ww,r,n)}});var D6=yr("String","matchAll"),P6=Z,L6=D6,wg=String.prototype,k6=function(t){var e=t.matchAll;return typeof t=="string"||t===wg||P6(wg,t)&&e===wg.matchAll?L6:e},M6=y(k6);function Hw(t){function e(n,i,r,s){let o=n[s++];if(o==="__proto__")return!0;const a=Number.isFinite(+o),c=s>=n.length;return o=!o&&at.isArray(r)?r.length:o,c?(at.hasOwnProp(r,o)?r[o]=[r[o],i]:r[o]=i,!a):(r[o]&&at.isObject(r[o])||(r[o]=[]),e(n,i,r[o],s)&&at.isArray(r[o])&&(r[o]=(function(d){const l={},h=Object.keys(d);let p;const f=h.length;let v;for(p=0;p<f;p++)v=h[p],l[v]=d[v];return l})(r[o])),!a)}if(at.isFormData(t)&&at.isFunction(t.entries)){const n={};return at.forEachEntry(t,((i,r)=>{e((function(s){return M6(at).call(at,/\w+|\[(\w*)]/g,s).map((o=>o[0]==="[]"?"":o[1]||o[0]))})(i),r,n,0)})),n}return null}const Og={transitional:gA,adapter:["xhr","http","fetch"],transformRequest:[function(t,e){const n=e.getContentType()||"",i=n.indexOf("application/json")>-1,r=at.isObject(t);if(r&&at.isHTMLForm(t)&&(t=new FormData(t)),at.isFormData(t))return i?JSON.stringify(Hw(t)):t;if(at.isArrayBuffer(t)||at.isBuffer(t)||at.isStream(t)||at.isFile(t)||at.isBlob(t)||at.isReadableStream(t))return t;if(at.isArrayBufferView(t))return t.buffer;if(at.isURLSearchParams(t))return e.setContentType("application/x-www-form-urlencoded;charset=utf-8",!1),t.toString();let s;if(r){if(n.indexOf("application/x-www-form-urlencoded")>-1)return c6(t,this.formSerializer).toString();if((s=at.isFileList(t))||n.indexOf("multipart/form-data")>-1){const o=this.env&&this.env.FormData;return gp(s?{"files[]":t}:t,o&&new o,this.formSerializer)}}return r||i?(e.setContentType("application/json",!1),(function(o,a,c){if(at.isString(o))try{return(a||JSON.parse)(o),_i(at).call(at,o)}catch(d){if(d.name!=="SyntaxError")throw d}return(c||JSON.stringify)(o)})(t)):t}],transformResponse:[function(t){const e=this.transitional||Og.transitional,n=e&&e.forcedJSONParsing,i=this.responseType==="json";if(at.isResponse(t)||at.isReadableStream(t))return t;if(t&&at.isString(t)&&(n&&!this.responseType||i)){const r=!(e&&e.silentJSONParsing)&&i;try{return JSON.parse(t,this.parseReviver)}catch(s){if(r)throw s.name==="SyntaxError"?we.from(s,we.ERR_BAD_RESPONSE,this,null,this.response):s}}return t}],timeout:0,xsrfCookieName:"XSRF-TOKEN",xsrfHeaderName:"X-XSRF-TOKEN",maxContentLength:-1,maxBodyLength:-1,env:{FormData:ki.classes.FormData,Blob:ki.classes.Blob},validateStatus:function(t){return t>=200&&t<300},headers:{common:{Accept:"application/json, text/plain, */*","Content-Type":void 0}}};at.forEach(["delete","get","head","post","put","patch"],(t=>{Og.headers[t]={}}));var Ng=Og;const U6=at.toObjectSet(["age","authorization","content-length","content-type","etag","expires","from","host","if-modified-since","if-unmodified-since","last-modified","location","max-forwards","proxy-authorization","referer","retry-after","user-agent"]),Kw=Symbol("internals");function Zl(t){var e;return t&&_i(e=String(t)).call(e).toLowerCase()}function Op(t){return t===!1||t==null?t:at.isArray(t)?t.map(Op):String(t)}function Dg(t,e,n,i,r){return at.isFunction(i)?i.call(this,e,n):(r&&(e=n),at.isString(e)?at.isString(i)?e.indexOf(i)!==-1:at.isRegExp(i)?i.test(e):void 0:void 0)}class Np{constructor(e){e&&this.set(e)}set(e,n,i){const r=this;function s(c,d,l){const h=Zl(d);if(!h)throw new Error("header name must be a non-empty string");const p=at.findKey(r,h);(!p||r[p]===void 0||l===!0||l===void 0&&r[p]!==!1)&&(r[p||d]=Op(c))}const o=(c,d)=>at.forEach(c,((l,h)=>s(l,h,d)));if(at.isPlainObject(e)||e instanceof this.constructor)o(e,n);else if(at.isString(e)&&(e=_i(e).call(e))&&!/^[-_a-zA-Z0-9^`|~,!#$%&'*+.]+$/.test(_i(a=e).call(a)))o((c=>{const d={};let l,h,p;return c&&c.split(`
`).forEach((function(f){var v,S;p=f.indexOf(":"),l=_i(v=f.substring(0,p)).call(v).toLowerCase(),h=_i(S=f.substring(p+1)).call(S),!l||d[l]&&U6[l]||(l==="set-cookie"?d[l]?d[l].push(h):d[l]=[h]:d[l]=d[l]?d[l]+", "+h:h)})),d})(e),n);else if(at.isObject(e)&&at.isIterable(e)){let c,d,l={};for(const h of e){if(!at.isArray(h))throw TypeError("Object iterator must return a key-value pair");l[d=h[0]]=(c=l[d])?at.isArray(c)?[...c,h[1]]:[c,h[1]]:h[1]}o(l,n)}else e!=null&&s(n,e,i);var a;return this}get(e,n){if(e=Zl(e)){const i=at.findKey(this,e);if(i){const r=this[i];if(!n)return r;if(n===!0)return(function(s){const o=Object.create(null),a=/([^\s,;=]+)\s*(?:=\s*([^,;]+))?/g;let c;for(;c=a.exec(s);)o[c[1]]=c[2];return o})(r);if(at.isFunction(n))return n.call(this,r,i);if(at.isRegExp(n))return n.exec(r);throw new TypeError("parser must be boolean|regexp|function")}}}has(e,n){if(e=Zl(e)){const i=at.findKey(this,e);return!(!i||this[i]===void 0||n&&!Dg(0,this[i],i,n))}return!1}delete(e,n){const i=this;let r=!1;function s(o){if(o=Zl(o)){const a=at.findKey(i,o);!a||n&&!Dg(0,i[a],a,n)||(delete i[a],r=!0)}}return at.isArray(e)?e.forEach(s):s(e),r}clear(e){const n=Object.keys(this);let i=n.length,r=!1;for(;i--;){const s=n[i];e&&!Dg(0,this[s],s,e,!0)||(delete this[s],r=!0)}return r}normalize(e){const n=this,i={};return at.forEach(this,((r,s)=>{var o;const a=at.findKey(i,s);if(a)return n[a]=Op(r),void delete n[s];const c=e?(function(d){return _i(d).call(d).toLowerCase().replace(/([a-z\d])(\w*)/g,((l,h,p)=>h.toUpperCase()+p))})(s):_i(o=String(s)).call(o);c!==s&&delete n[s],n[c]=Op(r),i[c]=!0})),this}concat(){for(var e=arguments.length,n=new Array(e),i=0;i<e;i++)n[i]=arguments[i];return this.constructor.concat(this,...n)}toJSON(e){const n=Object.create(null);return at.forEach(this,((i,r)=>{i!=null&&i!==!1&&(n[r]=e&&at.isArray(i)?i.join(", "):i)})),n}[Symbol.iterator](){return Object.entries(this.toJSON())[Symbol.iterator]()}toString(){return Object.entries(this.toJSON()).map((e=>{let[n,i]=e;return n+": "+i})).join(`
`)}getSetCookie(){return this.get("set-cookie")||[]}get[Symbol.toStringTag](){return"AxiosHeaders"}static from(e){return e instanceof this?e:new this(e)}static concat(e){const n=new this(e);for(var i=arguments.length,r=new Array(i>1?i-1:0),s=1;s<i;s++)r[s-1]=arguments[s];return r.forEach((o=>n.set(o))),n}static accessor(e){const n=(this[Kw]=this[Kw]={accessors:{}}).accessors,i=this.prototype;function r(s){const o=Zl(s);n[o]||((function(a,c){const d=at.toCamelCase(" "+c);["get","set","has"].forEach((l=>{Object.defineProperty(a,l+d,{value:function(h,p,f){return this[l].call(this,c,h,p,f)},configurable:!0})}))})(i,s),n[o]=!0)}return at.isArray(e)?e.forEach(r):r(e),this}}Np.accessor(["Content-Type","Content-Length","Accept","Accept-Encoding","User-Agent","Authorization"]),at.reduceDescriptors(Np.prototype,((t,e)=>{let{value:n}=t,i=e[0].toUpperCase()+e.slice(1);return{get:()=>n,set(r){this[i]=r}}})),at.freezeMethods(Np);var Ss=Np;function Pg(t,e){const n=this||Ng,i=e||n,r=Ss.from(i.headers);let s=i.data;return at.forEach(t,(function(o){s=o.call(n,s,r.normalize(),e?e.status:void 0)})),r.normalize(),s}function Yw(t){return!(!t||!t.__CANCEL__)}function md(t,e,n){we.call(this,t??"canceled",we.ERR_CANCELED,e,n),this.name="CanceledError"}function qw(t,e,n){const i=n.config.validateStatus;n.status&&i&&!i(n.status)?e(new we("Request failed with status code "+n.status,[we.ERR_BAD_REQUEST,we.ERR_BAD_RESPONSE][Math.floor(n.status/100)-4],n.config,n.request,n)):t(n)}at.inherits(md,we,{__CANCEL__:!0});const Dp=function(t,e){let n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:3,i=0;const r=(function(s,o){s=s||10;const a=new Array(s),c=new Array(s);let d,l=0,h=0;return o=o!==void 0?o:1e3,function(p){const f=Date.now(),v=c[h];d||(d=f),a[l]=p,c[l]=f;let S=h,T=0;for(;S!==l;)T+=a[S++],S%=s;if(l=(l+1)%s,l===h&&(h=(h+1)%s),f-d<o)return;const b=v&&f-v;return b?Math.round(1e3*T/b):void 0}})(50,250);return(function(s,o){let a,c,d=0,l=1e3/o;const h=function(p){d=arguments.length>1&&arguments[1]!==void 0?arguments[1]:Date.now(),a=null,c&&(clearTimeout(c),c=null),s(...p)};return[function(){const p=Date.now(),f=p-d;for(var v=arguments.length,S=new Array(v),T=0;T<v;T++)S[T]=arguments[T];f>=l?h(S,p):(a=S,c||(c=setTimeout((()=>{c=null,h(a)}),l-f)))},()=>a&&h(a)]})((s=>{const o=s.loaded,a=s.lengthComputable?s.total:void 0,c=o-i,d=r(c);i=o,t({loaded:o,total:a,progress:a?o/a:void 0,bytes:c,rate:d||void 0,estimated:d&&a&&o<=a?(a-o)/d:void 0,event:s,lengthComputable:a!=null,[e?"download":"upload"]:!0})}),n)},zw=(t,e)=>{const n=t!=null;return[i=>e[0]({lengthComputable:n,total:t,loaded:i}),e[1]]},Xw=t=>function(){for(var e=arguments.length,n=new Array(e),i=0;i<e;i++)n[i]=arguments[i];return at.asap((()=>t(...n)))};var x6=ki.hasStandardBrowserEnv?((t,e)=>n=>(n=new op(n,ki.origin),t.protocol===n.protocol&&t.host===n.host&&(e||t.port===n.port)))(new op(ki.origin),ki.navigator&&/(msie|trident)/i.test(ki.navigator.userAgent)):()=>!0,V6=ki.hasStandardBrowserEnv?{write(t,e,n,i,r,s,o){if(typeof document>"u")return;const a=["".concat(t,"=").concat(encodeURIComponent(e))];at.isNumber(n)&&a.push("expires=".concat(new Date(n).toUTCString())),at.isString(i)&&a.push("path=".concat(i)),at.isString(r)&&a.push("domain=".concat(r)),s===!0&&a.push("secure"),at.isString(o)&&a.push("SameSite=".concat(o)),document.cookie=a.join("; ")},read(t){if(typeof document>"u")return null;const e=document.cookie.match(new RegExp("(?:^|; )"+t+"=([^;]*)"));return e?decodeURIComponent(e[1]):null},remove(t){this.write(t,"",Date.now()-864e5,"/")}}:{write(){},read:()=>null,remove(){}};function Jw(t,e,n){let i=!(function(r){return/^([a-z][a-z\d+\-.]*:)?\/\//i.test(r)})(e);return t&&(i||n==0)?(function(r,s){return s?r.replace(/\/?\/$/,"")+"/"+s.replace(/^\/+/,""):r})(t,e):e}function Qw(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable}))),n.push.apply(n,i)}return n}function Lg(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?Qw(Object(n),!0).forEach((function(i){R(t,i,n[i])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):Qw(Object(n)).forEach((function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i))}))}return t}const Zw=t=>t instanceof Ss?Lg({},t):t;function qa(t,e){e=e||{};const n={};function i(d,l,h,p){return at.isPlainObject(d)&&at.isPlainObject(l)?at.merge.call({caseless:p},d,l):at.isPlainObject(l)?at.merge({},l):at.isArray(l)?l.slice():l}function r(d,l,h,p){return at.isUndefined(l)?at.isUndefined(d)?void 0:i(void 0,d,0,p):i(d,l,0,p)}function s(d,l){if(!at.isUndefined(l))return i(void 0,l)}function o(d,l){return at.isUndefined(l)?at.isUndefined(d)?void 0:i(void 0,d):i(void 0,l)}function a(d,l,h){return h in e?i(d,l):h in t?i(void 0,d):void 0}const c={url:s,method:s,data:s,baseURL:o,transformRequest:o,transformResponse:o,paramsSerializer:o,timeout:o,timeoutMessage:o,withCredentials:o,withXSRFToken:o,adapter:o,responseType:o,xsrfCookieName:o,xsrfHeaderName:o,onUploadProgress:o,onDownloadProgress:o,decompress:o,maxContentLength:o,maxBodyLength:o,beforeRedirect:o,transport:o,httpAgent:o,httpsAgent:o,cancelToken:o,socketPath:o,responseEncoding:o,validateStatus:a,headers:(d,l,h)=>r(Zw(d),Zw(l),0,!0)};return at.forEach(Object.keys(Lg(Lg({},t),e)),(function(d){const l=c[d]||r,h=l(t[d],e[d],d);at.isUndefined(h)&&l!==a||(n[d]=h)})),n}var $w=t=>{const e=qa({},t);let{data:n,withXSRFToken:i,xsrfHeaderName:r,xsrfCookieName:s,headers:o,auth:a}=e;if(e.headers=o=Ss.from(o),e.url=mA(Jw(e.baseURL,e.url,e.allowAbsoluteUrls),t.params,t.paramsSerializer),a&&o.set("Authorization","Basic "+btoa((a.username||"")+":"+(a.password?unescape(encodeURIComponent(a.password)):""))),at.isFormData(n)){if(ki.hasStandardBrowserEnv||ki.hasStandardBrowserWebWorkerEnv)o.setContentType(void 0);else if(at.isFunction(n.getHeaders)){const c=n.getHeaders(),d=["content-type","content-length"];Object.entries(c).forEach((l=>{let[h,p]=l;$(d).call(d,h.toLowerCase())&&o.set(h,p)}))}}if(ki.hasStandardBrowserEnv&&(i&&at.isFunction(i)&&(i=i(e)),i||i!==!1&&x6(e.url))){const c=r&&s&&V6.read(s);c&&o.set(r,c)}return e},F6=typeof XMLHttpRequest<"u"&&function(t){return new st((function(e,n){const i=$w(t);let r=i.data;const s=Ss.from(i.headers).normalize();let o,a,c,d,l,{responseType:h,onUploadProgress:p,onDownloadProgress:f}=i;function v(){d&&d(),l&&l(),i.cancelToken&&i.cancelToken.unsubscribe(o),i.signal&&i.signal.removeEventListener("abort",o)}let S=new XMLHttpRequest;function T(){if(!S)return;const w=Ss.from("getAllResponseHeaders"in S&&S.getAllResponseHeaders());qw((function(D){e(D),v()}),(function(D){n(D),v()}),{data:h&&h!=="text"&&h!=="json"?S.response:S.responseText,status:S.status,statusText:S.statusText,headers:w,config:t,request:S}),S=null}S.open(i.method.toUpperCase(),i.url,!0),S.timeout=i.timeout,"onloadend"in S?S.onloadend=T:S.onreadystatechange=function(){S&&S.readyState===4&&(S.status!==0||S.responseURL&&S.responseURL.indexOf("file:")===0)&&setTimeout(T)},S.onabort=function(){S&&(n(new we("Request aborted",we.ECONNABORTED,t,S)),S=null)},S.onerror=function(w){const D=new we(w&&w.message?w.message:"Network Error",we.ERR_NETWORK,t,S);D.event=w||null,n(D),S=null},S.ontimeout=function(){let w=i.timeout?"timeout of "+i.timeout+"ms exceeded":"timeout exceeded";const D=i.transitional||gA;i.timeoutErrorMessage&&(w=i.timeoutErrorMessage),n(new we(w,D.clarifyTimeoutError?we.ETIMEDOUT:we.ECONNABORTED,t,S)),S=null},r===void 0&&s.setContentType(null),"setRequestHeader"in S&&at.forEach(s.toJSON(),(function(w,D){S.setRequestHeader(D,w)})),at.isUndefined(i.withCredentials)||(S.withCredentials=!!i.withCredentials),h&&h!=="json"&&(S.responseType=i.responseType),f&&([c,l]=Dp(f,!0),S.addEventListener("progress",c)),p&&S.upload&&([a,d]=Dp(p),S.upload.addEventListener("progress",a),S.upload.addEventListener("loadend",d)),(i.cancelToken||i.signal)&&(o=w=>{S&&(n(!w||w.type?new md(null,t,S):w),S.abort(),S=null)},i.cancelToken&&i.cancelToken.subscribe(o),i.signal&&(i.signal.aborted?o():i.signal.addEventListener("abort",o)));const b=(function(w){const D=/^([-+\w]{1,25})(:?\/\/|:)/.exec(w);return D&&D[1]||""})(i.url);b&&ki.protocols.indexOf(b)===-1?n(new we("Unsupported protocol "+b+":",we.ERR_BAD_REQUEST,t)):S.send(r||null)}))},B6=(t,e)=>{const{length:n}=t=t?t.filter(Boolean):[];if(e||n){let i,r=new AbortController;const s=function(d){if(!i){i=!0,a();const l=d instanceof Error?d:this.reason;r.abort(l instanceof we?l:new md(l instanceof Error?l.message:l))}};let o=e&&setTimeout((()=>{o=null,s(new we("timeout ".concat(e," of ms exceeded"),we.ETIMEDOUT))}),e);const a=()=>{t&&(o&&clearTimeout(o),o=null,t.forEach((d=>{d.unsubscribe?d.unsubscribe(s):d.removeEventListener("abort",s)})),t=null)};t.forEach((d=>d.addEventListener("abort",s)));const{signal:c}=r;return c.unsubscribe=()=>at.asap(a),c}},kg=y(xy),tO=ud.f("asyncIterator"),j6=y(tO);function Mg(t,e){this.v=t,this.k=e}function Ci(t){return function(){return new $l(t.apply(this,arguments))}}function $l(t){var e,n;function i(s,o){try{var a=t[s](o),c=a.value,d=c instanceof Mg;kg.resolve(d?c.v:c).then((function(l){if(d){var h=s==="return"?"return":"next";if(!c.k||l.done)return i(h,l);l=t[h](l).value}r(a.done?"return":"normal",l)}),(function(l){i("throw",l)}))}catch(l){r("throw",l)}}function r(s,o){switch(s){case"return":e.resolve({value:o,done:!0});break;case"throw":e.reject(o);break;default:e.resolve({value:o,done:!1})}(e=e.next)?i(e.key,e.arg):n=null}this._invoke=function(s,o){return new kg((function(a,c){var d={key:s,arg:o,resolve:a,reject:c,next:null};n?n=n.next=d:(e=n=d,i(s,o))}))},typeof t.return!="function"&&(this.return=void 0)}function Ht(t){return new Mg(t,0)}function Ed(t){var e={},n=!1;function i(r,s){return n=!0,s=new kg((function(o){o(t[r](s))})),{done:!1,value:new Mg(s,1)}}return e[fd!==void 0&&Ow||"@@iterator"]=function(){return this},e.next=function(r){return n?(n=!1,r):i("next",r)},typeof t.throw=="function"&&(e.throw=function(r){if(n)throw n=!1,r;return i("throw",r)}),typeof t.return=="function"&&(e.return=function(r){return n?(n=!1,r):i("return",r)}),e}$l.prototype[typeof fd=="function"&&j6||"@@asyncIterator"]=function(){return this},$l.prototype.next=function(t){return this._invoke("next",t)},$l.prototype.throw=function(t){return this._invoke("throw",t)},$l.prototype.return=function(t){return this._invoke("return",t)};var Pp=y(tO);function Ug(t){var e,n,i,r=2;for(typeof Symbol<"u"&&(n=Pp,i=Symbol.iterator);r--;){if(n&&(e=t[n])!=null)return e.call(t);if(i&&(e=t[i])!=null)return new Lp(e.call(t));n="@@asyncIterator",i="@@iterator"}throw new TypeError("Object is not async iterable")}function Lp(t){function e(n){if(Object(n)!==n)return st.reject(new TypeError(n+" is not an object."));var i=n.done;return st.resolve(n.value).then((function(r){return{value:r,done:i}}))}return Lp=function(n){this.s=n,this.n=n.next},Lp.prototype={s:null,n:null,next:function(){return e(this.n.apply(this.s,arguments))},return:function(n){var i=this.s.return;return i===void 0?st.resolve({value:n,done:!0}):e(i.apply(this.s,arguments))},throw:function(n){var i=this.s.return;return i===void 0?st.reject(n):e(i.apply(this.s,arguments))}},new Lp(t)}const G6=function*(t,e){let n=t.byteLength;if(!e||n<e)return void(yield t);let i,r=0;for(;r<n;)i=r+e,yield t.slice(r,i),r=i},W6=(function(){var t=Ci((function*(e,n){var i,r=!1,s=!1;try{for(var o,a=Ug(H6(e));r=!(o=yield Ht(a.next())).done;r=!1){const c=o.value;yield*Ed(Ug(G6(c,n)))}}catch(c){s=!0,i=c}finally{try{r&&a.return!=null&&(yield Ht(a.return()))}finally{if(s)throw i}}}));return function(e,n){return t.apply(this,arguments)}})(),H6=(function(){var t=Ci((function*(e){if(e[Pp])return void(yield*Ed(Ug(e)));const n=e.getReader();try{for(;;){const{done:i,value:r}=yield Ht(n.read());if(i)break;yield r}}finally{yield Ht(n.cancel())}}));return function(e){return t.apply(this,arguments)}})(),eO=(t,e,n,i)=>{const r=W6(t,e);let s,o=0,a=c=>{s||(s=!0,i&&i(c))};return new ReadableStream({async pull(c){try{const{done:d,value:l}=await r.next();if(d)return a(),void c.close();let h=l.byteLength;if(n){let p=o+=h;n(p)}c.enqueue(new Uint8Array(l))}catch(d){throw a(d),d}},cancel:c=>(a(c),r.return())},{highWaterMark:2})};function nO(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable}))),n.push.apply(n,i)}return n}function iO(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?nO(Object(n),!0).forEach((function(i){R(t,i,n[i])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):nO(Object(n)).forEach((function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i))}))}return t}const{isFunction:kp}=at,K6=(t=>{let{Request:e,Response:n}=t;return{Request:e,Response:n}})(at.global),{ReadableStream:rO,TextEncoder:sO}=at.global,oO=function(t){try{for(var e=arguments.length,n=new Array(e>1?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];return!!t(...n)}catch{return!1}},Y6=t=>{t=at.merge.call({skipUndefined:!0},K6,t);const{fetch:e,Request:n,Response:i}=t,r=e?kp(e):typeof fetch=="function",s=kp(n),o=kp(i);if(!r)return!1;const a=r&&kp(rO),c=r&&(typeof sO=="function"?(d=new sO,v=>d.encode(v)):async v=>new Uint8Array(await new n(v).arrayBuffer()));var d;const l=s&&a&&oO((()=>{let v=!1;const S=new n(ki.origin,{body:new rO,method:"POST",get duplex(){return v=!0,"half"}}).headers.has("Content-Type");return v&&!S})),h=o&&a&&oO((()=>at.isReadableStream(new i("").body))),p={stream:h&&(v=>v.body)};r&&["text","arrayBuffer","blob","formData","stream"].forEach((v=>{!p[v]&&(p[v]=(S,T)=>{let b=S&&S[v];if(b)return b.call(S);throw new we("Response type '".concat(v,"' is not supported"),we.ERR_NOT_SUPPORT,T)})}));const f=async(v,S)=>{const T=at.toFiniteNumber(v.getContentLength());return T??(async b=>b==null?0:at.isBlob(b)?b.size:at.isSpecCompliantForm(b)?(await new n(ki.origin,{method:"POST",body:b}).arrayBuffer()).byteLength:at.isArrayBufferView(b)||at.isArrayBuffer(b)?b.byteLength:(at.isURLSearchParams(b)&&(b+=""),at.isString(b)?(await c(b)).byteLength:void 0))(S)};return async v=>{let{url:S,method:T,data:b,signal:w,cancelToken:D,timeout:k,onDownloadProgress:U,onUploadProgress:P,responseType:x,headers:q,withCredentials:Q="same-origin",fetchOptions:dt}=$w(v),Dt=e||fetch;x=x?(x+"").toLowerCase():"text";let Ot=B6([w,D&&D.toAbortSignal()],k),Wt=null;const Vt=Ot&&Ot.unsubscribe&&(()=>{Ot.unsubscribe()});let pe;try{if(P&&l&&T!=="get"&&T!=="head"&&(pe=await f(q,b))!==0){let g,N=new n(S,{method:"POST",body:b,duplex:"half"});if(at.isFormData(b)&&(g=N.headers.get("content-type"))&&q.setContentType(g),N.body){const[L,et]=zw(pe,Dp(Xw(P)));b=eO(N.body,65536,L,et)}}at.isString(Q)||(Q=Q?"include":"omit");const He=s&&"credentials"in n.prototype,X=iO(iO({},dt),{},{signal:Ot,method:T.toUpperCase(),headers:q.normalize().toJSON(),body:b,duplex:"half",credentials:He?Q:void 0});Wt=s&&new n(S,X);let rt=await(s?Dt(Wt,dt):Dt(S,X));const ht=h&&(x==="stream"||x==="response");if(h&&(U||ht&&Vt)){const g={};["status","statusText","headers"].forEach((Mt=>{g[Mt]=rt[Mt]}));const N=at.toFiniteNumber(rt.headers.get("content-length")),[L,et]=U&&zw(N,Dp(Xw(U),!0))||[];rt=new i(eO(rt.body,65536,L,(()=>{et&&et(),Vt&&Vt()})),g)}x=x||"text";let J=await p[at.findKey(p,x)||"text"](rt,v);return!ht&&Vt&&Vt(),await new st(((g,N)=>{qw(g,N,{data:J,headers:Ss.from(rt.headers),status:rt.status,statusText:rt.statusText,config:v,request:Wt})}))}catch(He){throw Vt&&Vt(),He&&He.name==="TypeError"&&/Load failed|fetch/i.test(He.message)?Object.assign(new we("Network Error",we.ERR_NETWORK,v,Wt),{cause:He.cause||He}):we.from(He,He&&He.code,v,Wt)}}},q6=new Map,aO=t=>{let e=t&&t.env||{};const{fetch:n,Request:i,Response:r}=e,s=[i,r,n];let o,a,c=s.length,d=q6;for(;c--;)o=s[c],a=d.get(o),a===void 0&&d.set(o,a=c?new Map:Y6(e)),d=a;return a};aO();const xg={http:null,xhr:F6,fetch:{get:aO}};at.forEach(xg,((t,e)=>{if(t){try{Object.defineProperty(t,"name",{value:e})}catch{}Object.defineProperty(t,"adapterName",{value:e})}}));const cO=t=>"- ".concat(t),z6=t=>at.isFunction(t)||t===null||t===!1;var dO={getAdapter:function(t,e){t=at.isArray(t)?t:[t];const{length:n}=t;let i,r;const s={};for(let o=0;o<n;o++){let a;if(i=t[o],r=i,!z6(i)&&(r=xg[(a=String(i)).toLowerCase()],r===void 0))throw new we("Unknown adapter '".concat(a,"'"));if(r&&(at.isFunction(r)||(r=r.get(e))))break;s[a||"#"+o]=r}if(!r){const o=Object.entries(s).map((a=>{let[c,d]=a;return"adapter ".concat(c," ")+(d===!1?"is not supported by the environment":"is not available in the build")}));throw new we("There is no suitable adapter to dispatch the request "+(n?o.length>1?`since :
`+o.map(cO).join(`
`):" "+cO(o[0]):"as no adapter specified"),"ERR_NOT_SUPPORT")}return r},adapters:xg};function Vg(t){if(t.cancelToken&&t.cancelToken.throwIfRequested(),t.signal&&t.signal.aborted)throw new md(null,t)}function lO(t){return Vg(t),t.headers=Ss.from(t.headers),t.data=Pg.call(t,t.transformRequest),["post","put","patch"].indexOf(t.method)!==-1&&t.headers.setContentType("application/x-www-form-urlencoded",!1),dO.getAdapter(t.adapter||Ng.adapter,t)(t).then((function(e){return Vg(t),e.data=Pg.call(t,t.transformResponse,e),e.headers=Ss.from(e.headers),e}),(function(e){return Yw(e)||(Vg(t),e&&e.response&&(e.response.data=Pg.call(t,t.transformResponse,e.response),e.response.headers=Ss.from(e.response.headers))),st.reject(e)}))}const uO="1.13.2",Mp={};["object","boolean","number","function","string","symbol"].forEach(((t,e)=>{Mp[t]=function(n){return typeof n===t||"a"+(e<1?"n ":" ")+t}}));const hO={};Mp.transitional=function(t,e,n){function i(r,s){return"[Axios v"+uO+"] Transitional option '"+r+"'"+s+(n?". "+n:"")}return(r,s,o)=>{if(t===!1)throw new we(i(s," has been removed"+(e?" in "+e:"")),we.ERR_DEPRECATED);return e&&!hO[s]&&(hO[s]=!0,console.warn(i(s," has been deprecated since v"+e+" and will be removed in the near future"))),!t||t(r,s,o)}},Mp.spelling=function(t){return(e,n)=>(console.warn("".concat(n," is likely a misspelling of ").concat(t)),!0)};var Up={assertOptions:function(t,e,n){if(typeof t!="object")throw new we("options must be an object",we.ERR_BAD_OPTION_VALUE);const i=Object.keys(t);let r=i.length;for(;r-- >0;){const s=i[r],o=e[s];if(o){const a=t[s],c=a===void 0||o(a,s,t);if(c!==!0)throw new we("option "+s+" must be "+c,we.ERR_BAD_OPTION_VALUE)}else if(n!==!0)throw new we("Unknown option "+s,we.ERR_BAD_OPTION)}},validators:Mp};const qs=Up.validators;let xp=class{constructor(t){this.defaults=t||{},this.interceptors={request:new EA,response:new EA}}async request(t,e){try{return await this._request(t,e)}catch(n){if(n instanceof Error){let i={};Error.captureStackTrace?Error.captureStackTrace(i):i=new Error;const r=i.stack?i.stack.replace(/^.+\n/,""):"";try{n.stack?r&&!String(n.stack).endsWith(r.replace(/^.+\n.+\n/,""))&&(n.stack+=`
`+r):n.stack=r}catch{}}throw n}}_request(t,e){typeof t=="string"?(e=e||{}).url=t:e=t||{},e=qa(this.defaults,e);const{transitional:n,paramsSerializer:i,headers:r}=e;n!==void 0&&Up.assertOptions(n,{silentJSONParsing:qs.transitional(qs.boolean),forcedJSONParsing:qs.transitional(qs.boolean),clarifyTimeoutError:qs.transitional(qs.boolean)},!1),i!=null&&(at.isFunction(i)?e.paramsSerializer={serialize:i}:Up.assertOptions(i,{encode:qs.function,serialize:qs.function},!0)),e.allowAbsoluteUrls!==void 0||(this.defaults.allowAbsoluteUrls!==void 0?e.allowAbsoluteUrls=this.defaults.allowAbsoluteUrls:e.allowAbsoluteUrls=!0),Up.assertOptions(e,{baseUrl:qs.spelling("baseURL"),withXsrfToken:qs.spelling("withXSRFToken")},!0),e.method=(e.method||this.defaults.method||"get").toLowerCase();let s=r&&at.merge(r.common,r[e.method]);r&&at.forEach(["delete","get","head","post","put","patch","common"],(f=>{delete r[f]})),e.headers=Ss.concat(s,r);const o=[];let a=!0;this.interceptors.request.forEach((function(f){typeof f.runWhen=="function"&&f.runWhen(e)===!1||(a=a&&f.synchronous,o.unshift(f.fulfilled,f.rejected))}));const c=[];let d;this.interceptors.response.forEach((function(f){c.push(f.fulfilled,f.rejected)}));let l,h=0;if(!a){const f=[lO.bind(this),void 0];for(f.unshift(...o),f.push(...c),l=f.length,d=st.resolve(e);h<l;)d=d.then(f[h++],f[h++]);return d}l=o.length;let p=e;for(;h<l;){const f=o[h++],v=o[h++];try{p=f(p)}catch(S){v.call(this,S);break}}try{d=lO.call(this,p)}catch(f){return st.reject(f)}for(h=0,l=c.length;h<l;)d=d.then(c[h++],c[h++]);return d}getUri(t){return mA(Jw((t=qa(this.defaults,t)).baseURL,t.url,t.allowAbsoluteUrls),t.params,t.paramsSerializer)}};at.forEach(["delete","get","head","options"],(function(t){xp.prototype[t]=function(e,n){return this.request(qa(n||{},{method:t,url:e,data:(n||{}).data}))}})),at.forEach(["post","put","patch"],(function(t){function e(n){return function(i,r,s){return this.request(qa(s||{},{method:t,headers:n?{"Content-Type":"multipart/form-data"}:{},url:i,data:r}))}}xp.prototype[t]=e(),xp.prototype[t+"Form"]=e(!0)}));var Vp=xp;class Fg{constructor(e){if(typeof e!="function")throw new TypeError("executor must be a function.");let n;this.promise=new st((function(r){n=r}));const i=this;this.promise.then((r=>{if(!i._listeners)return;let s=i._listeners.length;for(;s-- >0;)i._listeners[s](r);i._listeners=null})),this.promise.then=r=>{let s;const o=new st((a=>{i.subscribe(a),s=a})).then(r);return o.cancel=function(){i.unsubscribe(s)},o},e((function(r,s,o){i.reason||(i.reason=new md(r,s,o),n(i.reason))}))}throwIfRequested(){if(this.reason)throw this.reason}subscribe(e){this.reason?e(this.reason):this._listeners?this._listeners.push(e):this._listeners=[e]}unsubscribe(e){if(!this._listeners)return;const n=this._listeners.indexOf(e);n!==-1&&this._listeners.splice(n,1)}toAbortSignal(){const e=new AbortController,n=i=>{e.abort(i)};return this.subscribe(n),e.signal.unsubscribe=()=>this.unsubscribe(n),e.signal}static source(){let e;return{token:new Fg((function(i){e=i})),cancel:e}}}var X6=Fg;const Bg={Continue:100,SwitchingProtocols:101,Processing:102,EarlyHints:103,Ok:200,Created:201,Accepted:202,NonAuthoritativeInformation:203,NoContent:204,ResetContent:205,PartialContent:206,MultiStatus:207,AlreadyReported:208,ImUsed:226,MultipleChoices:300,MovedPermanently:301,Found:302,SeeOther:303,NotModified:304,UseProxy:305,Unused:306,TemporaryRedirect:307,PermanentRedirect:308,BadRequest:400,Unauthorized:401,PaymentRequired:402,Forbidden:403,NotFound:404,MethodNotAllowed:405,NotAcceptable:406,ProxyAuthenticationRequired:407,RequestTimeout:408,Conflict:409,Gone:410,LengthRequired:411,PreconditionFailed:412,PayloadTooLarge:413,UriTooLong:414,UnsupportedMediaType:415,RangeNotSatisfiable:416,ExpectationFailed:417,ImATeapot:418,MisdirectedRequest:421,UnprocessableEntity:422,Locked:423,FailedDependency:424,TooEarly:425,UpgradeRequired:426,PreconditionRequired:428,TooManyRequests:429,RequestHeaderFieldsTooLarge:431,UnavailableForLegalReasons:451,InternalServerError:500,NotImplemented:501,BadGateway:502,ServiceUnavailable:503,GatewayTimeout:504,HttpVersionNotSupported:505,VariantAlsoNegotiates:506,InsufficientStorage:507,LoopDetected:508,NotExtended:510,NetworkAuthenticationRequired:511,WebServerIsDown:521,ConnectionTimedOut:522,OriginIsUnreachable:523,TimeoutOccurred:524,SslHandshakeFailed:525,InvalidSslCertificate:526};Object.entries(Bg).forEach((t=>{let[e,n]=t;Bg[n]=e}));var J6=Bg;const ri=(function t(e){const n=new Vp(e),i=$b(Vp.prototype.request,n);return at.extend(i,Vp.prototype,n,{allOwnKeys:!0}),at.extend(i,n,null,{allOwnKeys:!0}),i.create=function(r){return t(qa(e,r))},i})(Ng);ri.Axios=Vp,ri.CanceledError=md,ri.CancelToken=X6,ri.isCancel=Yw,ri.VERSION=uO,ri.toFormData=gp,ri.AxiosError=we,ri.Cancel=ri.CanceledError,ri.all=function(t){return st.all(t)},ri.spread=function(t){return function(e){return t.apply(null,e)}},ri.isAxiosError=function(t){return at.isObject(t)&&t.isAxiosError===!0},ri.mergeConfig=qa,ri.AxiosHeaders=Ss,ri.formToJSON=t=>Hw(at.isHTMLForm(t)?new FormData(t):t),ri.getAdapter=dO.getAdapter,ri.HttpStatusCode=J6,ri.default=ri;var yi=ri;const Q6=()=>{};function tu(){const t={promise:void 0,isResolved:!1,isRejected:!1,isFinished:!1,resolve:void 0,reject:void 0,cancel:Q6};return t.promise=new st(((e,n)=>{t.resolve=i=>{t.isFinished||(t.isResolved=!0,t.isFinished=!0,e(i),t.value=i)},t.reject=i=>{t.isFinished||(t.isRejected=!0,t.isFinished=!0,n(i))}})),t}const Fp=new Map,Bp=new Map,zs=new Map;let On=(function(t){return t.WIN_10="Windows 10",t.WIN_81="Windows 8.1",t.WIN_8="Windows 8",t.WIN_7="Windows 7",t.WIN_VISTA="Windows Vista",t.WIN_SERVER_2003="Windows Server 2003",t.WIN_XP="Windows XP",t.WIN_2000="Windows 2000",t.ANDROID="Android",t.HARMONY_OS="HarmonyOS",t.OPEN_BSD="Open BSD",t.SUN_OS="Sun OS",t.LINUX="Linux",t.IOS="iOS",t.MAC_OS="Mac OS",t.CHROMIUM_OS="Chromium OS",t.QNX="QNX",t.UNIX="UNIX",t.BEOS="BeOS",t.OS_2="OS/2",t.SEARCH_BOT="Search Bot",t})({}),he=(function(t){return t.CHROME="Chrome",t.SAFARI="Safari",t.EDGE="Edge",t.FIREFOX="Firefox",t.OPERA="OPR",t.QQ="QQBrowser",t.WECHAT="MicroMessenger",t})({});const pO=new P4;let Ts=pO.getResult(),jg=null;function de(t){if(!jg){Ts=pO.getResult();const e=(function(a){if(a.engine.name==="Blink"&&a.browser.name!=="WeChat")return he.CHROME;switch(a.browser.name){case"Chrome Headless":case"Chrome":case"Chromium":return he.CHROME;case"Safari":case"Mobile Safari":return he.SAFARI;case"Edge":return he.EDGE;case"Firefox":return he.FIREFOX;case"QQ":case"QQBrowser":return he.QQ;case"Opera":return he.OPERA;case"WeChat":return he.WECHAT;default:return a.browser.name||""}})(Ts),n=_O(Ts),i=(function(a){return a.os.name==="Windows"?a.os.version?a.os.name+" "+a.os.version:a.os.name:a.os.name||""})(Ts),r=Ts.os.version,s=_O(Ts,!1),o=Ts.device.type;if(!(e&&n&&i&&r))return{name:e,version:n,os:i,osVersion:r,browserVersion:s,deviceType:o};jg={name:e,version:n,os:i,osVersion:r,browserVersion:s,deviceType:o}}return jg}function _O(t){let e,n=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];return e=t.engine.name==="Blink"?t.engine.version||"":t.browser.version||"",n?e.split(".")[0]:e}function jp(){return de().os}function fO(){const t=de();return"".concat(t.os," ").concat(t.osVersion)}function Gp(){const t=de();return!!(Ts.engine.name==="WebKit"&&t.os===On.MAC_OS&&navigator.maxTouchPoints&&navigator.maxTouchPoints>0&&t.name!==he.SAFARI||si()&&t.name!==he.SAFARI)}function Ao(){return de().name===he.CHROME}function Mn(){return de().name===he.SAFARI}function mO(){const t=de();if(t.name!==he.SAFARI||!t.browserVersion)return!1;const e=t.browserVersion.split(".");return Number(e[0])>15||Number(e[0])===15&&Number(e[1])>=4}function EO(){return de().name===he.EDGE}function xe(){return de().name===he.FIREFOX}function si(){return de().os===On.IOS}function Xs(t){const e=de();return!(e.name!==he.CHROME||!e.osVersion)&&Number(e.version)>=t}function gO(t){const e=de();return!(e.name!==he.CHROME||!e.osVersion)&&Number(e.version)<t}function Gg(t,e,n){const i=de();return!(i.name!==t||!i.osVersion)&&(n?Number(i.version)>=e&&Number(i.version)<=n:Number(i.version)===e)}function za(t){const e=de();return!(e.name!==he.EDGE||!e.osVersion)&&Number(e.version)>=t}function Wg(t){const e=de();return!(e.name!==he.FIREFOX||!e.osVersion)&&Number(e.version)>=t}function SO(t){const e=de();return!(e.name!==he.SAFARI||!e.osVersion)&&Number(e.version)>=t}function TO(t,e,n){const i=de();if(i.os!==On.IOS||!i.osVersion)return!1;const r=i.osVersion.split(".");return n?e&&Number(r[0])===t&&Number(r[1])>e||Number(r[0])>t:e?Number(r[0])===t&&Number(r[1])>=e||Number(r[0])>t:Number(r[0])>=t}function RO(t,e,n){const i=de();if(i.os!==On.IOS||!i.osVersion)return!1;const r=i.osVersion.split(".");return n?e&&Number(r[0])===t&&Number(r[1])<e||Number(r[0])<t:e?Number(r[0])===t&&Number(r[1])<=e||Number(r[0])<t:Number(r[0])<=t}function Hg(t,e,n){const i=de();if(i.name!==he.SAFARI||!i.osVersion||!i.browserVersion)return!1;const r=i.browserVersion.split(".");return n?e&&Number(r[0])===t&&Number(r[1])<e||Number(r[0])<t:e?Number(r[0])===t&&Number(r[1])<=e||Number(r[0])<t:Number(r[0])<=t}function Xa(t){const e=de();return!(e.name!==he.OPERA||!e.osVersion)&&Number(e.version)>=t}function vO(){const t=de();if(t.os!==On.IOS||!t.osVersion)return!1;const e=t.osVersion.split(".");return Number(e[0])<14||Number(e[0])===14&&Number(e[1])<=6}function gd(){const t=de();if(t.os!==On.IOS||!t.osVersion)return!1;const e=t.osVersion.split(".");return Number(e[0])===15}function Kg(){const t=de();if(t.os!==On.IOS||!t.osVersion)return!1;const e=t.osVersion.split(".");return Number(e[0])===16}function CO(){const t=de();if(t.os!==On.IOS||!t.osVersion)return!1;const e=t.osVersion.split(".");return Number(e[0])===15&&Number(e[1])>=1}function Qr(){return Mn()&&navigator.maxTouchPoints>0}function yO(){return de().name===he.WECHAT}function IO(){return window.navigator.appVersion&&window.navigator.appVersion.match(/Chrome\/([\w\W]*?)\./)!==null&&window.navigator.appVersion.match(/Chrome\/([\w\W]*?)\./)[1]<=35}function bO(){const t=jp();return(function(){const{deviceType:e}=de();return e==="mobile"||e==="tablet"})()||t===On.ANDROID||t===On.IOS||t===On.HARMONY_OS}function Js(){const t=de();return t.name!==he.EDGE&&t.name!==he.SAFARI&&!!navigator.userAgent.toLocaleLowerCase().match(/chrome\/[\d]./i)}function eu(){return jp()===On.ANDROID}function nu(){const t=de();return eu()&&(t.name===he.CHROME||t.name===he.WECHAT||/chrome|chromium/i.test(navigator.userAgent))}function Ut(t,e,n){return(e=(function(i){var r=(function(s,o){if(typeof s!="object"||!s)return s;var a=s[Symbol.toPrimitive];if(a!==void 0){var c=a.call(s,"string");if(typeof c!="object")return c;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(s)})(i);return typeof r=="symbol"?r:r+""})(e))in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function AO(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable}))),n.push.apply(n,i)}return n}function nt(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?AO(Object(n),!0).forEach((function(i){Ut(t,i,n[i])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):AO(Object(n)).forEach((function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i))}))}return t}let A=(function(t){return t.UNEXPECTED_ERROR="UNEXPECTED_ERROR",t.UNEXPECTED_RESPONSE="UNEXPECTED_RESPONSE",t.TIMEOUT="TIMEOUT",t.INVALID_PARAMS="INVALID_PARAMS",t.NOT_READABLE="NOT_READABLE",t.NOT_SUPPORTED="NOT_SUPPORTED",t.INVALID_OPERATION="INVALID_OPERATION",t.OPERATION_ABORTED="OPERATION_ABORTED",t.WEB_SECURITY_RESTRICT="WEB_SECURITY_RESTRICT",t.EXCHANGE_SDP_FAILED="EXCHANGE_SDP_FAILED",t.ADD_CANDIDATE_FAILED="ADD_CANDIDATE_FAILED",t.DATACHANNEL_FAILED="DATACHANNEL_FAILED",t.NETWORK_ERROR="NETWORK_ERROR",t.NETWORK_TIMEOUT="NETWORK_TIMEOUT",t.NETWORK_RESPONSE_ERROR="NETWORK_RESPONSE_ERROR",t.API_INVOKE_TIMEOUT="API_INVOKE_TIMEOUT",t.ENUMERATE_DEVICES_FAILED="ENUMERATE_DEVICES_FAILED",t.DEVICE_NOT_FOUND="DEVICE_NOT_FOUND",t.ELECTRON_IS_NULL="ELECTRON_IS_NULL",t.ELECTRON_DESKTOP_CAPTURER_GET_SOURCES_ERROR="ELECTRON_DESKTOP_CAPTURER_GET_SOURCES_ERROR",t.CHROME_PLUGIN_NO_RESPONSE="CHROME_PLUGIN_NO_RESPONSE",t.CHROME_PLUGIN_NOT_INSTALL="CHROME_PLUGIN_NOT_INSTALL",t.MEDIA_OPTION_INVALID="MEDIA_OPTION_INVALID",t.PERMISSION_DENIED="PERMISSION_DENIED",t.CONSTRAINT_NOT_SATISFIED="CONSTRAINT_NOT_SATISFIED",t.TRACK_IS_DISABLED="TRACK_IS_DISABLED",t.GET_VIDEO_ELEMENT_VISIBLE_ERROR="GET_VIDEO_ELEMENT_VISIBLE_ERROR",t.SHARE_AUDIO_NOT_ALLOWED="SHARE_AUDIO_NOT_ALLOWED",t.LOW_STREAM_ENCODING_ERROR="LOW_STREAM_ENCODING_ERROR",t.SET_ENCODING_PARAMETER_ERROR="SET_ENCODING_PARAMETER_ERROR",t.TRACK_STATE_UNREACHABLE="TRACK_STATE_UNREACHABLE",t.INVALID_UINT_UID_FROM_STRING_UID="INVALID_UINT_UID_FROM_STRING_UID",t.CAN_NOT_GET_PROXY_SERVER="CAN_NOT_GET_PROXY_SERVER",t.CAN_NOT_GET_GATEWAY_SERVER="CAN_NOT_GET_GATEWAY_SERVER",t.VOID_GATEWAY_ADDRESS="VOID_GATEWAY_ADDRESS",t.UID_CONFLICT="UID_CONFLICT",t.MULTI_UNILBS_RESPONSE_ERROR="MULTI_UNILBS_RESPONSE_ERROR",t.UPDATE_TICKET_FAILED="UPDATE_TICKET_FAILED",t.TOKEN_EXPIRE="TOKEN_EXPIRE",t.INVALID_LOCAL_TRACK="INVALID_LOCAL_TRACK",t.INVALID_TRACK="INVALID_TRACK",t.SENDER_NOT_FOUND="SENDER_NOT_FOUND",t.CREATE_OFFER_FAILED="CREATE_OFFER_FAILED",t.SET_ANSWER_FAILED="SET_ANSWER_FAILED",t.ICE_FAILED="ICE_FAILED",t.PC_CLOSED="PC_CLOSED",t.SENDER_REPLACE_FAILED="SENDER_REPLACE_FAILED",t.GET_LOCAL_CAPABILITIES_FAILED="GET_LOCAL_CAPABILITIES_FAILED",t.GET_LOCAL_CONNECTION_PARAMS_FAILED="GET_LOCAL_CONNECTION_PARAMS_FAILED",t.SUBSCRIBE_FAILED="SUBSCRIBE_FAILED",t.UNSUBSCRIBE_FAILED="UNSUBSCRIBE_FAILED",t.GATEWAY_P2P_LOST="GATEWAY_P2P_LOST",t.NO_ICE_CANDIDATE="NO_ICE_CANDIDATE",t.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS="CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS",t.EXIST_DISABLED_VIDEO_TRACK="EXIST_DISABLED_VIDEO_TRACK",t.INVALID_REMOTE_USER="INVALID_REMOTE_USER",t.REMOTE_USER_IS_NOT_PUBLISHED="REMOTE_USER_IS_NOT_PUBLISHED",t.CUSTOM_REPORT_SEND_FAILED="CUSTOM_REPORT_SEND_FAILED",t.CUSTOM_REPORT_FREQUENCY_TOO_HIGH="CUSTOM_REPORT_FREQUENCY_TOO_HIGH",t.FETCH_AUDIO_FILE_FAILED="FETCH_AUDIO_FILE_FAILED",t.READ_LOCAL_AUDIO_FILE_ERROR="READ_LOCAL_AUDIO_FILE_ERROR",t.DECODE_AUDIO_FILE_FAILED="DECODE_AUDIO_FILE_FAILED",t.WS_ABORT="WS_ABORT",t.WS_DISCONNECT="WS_DISCONNECT",t.WS_ERR="WS_ERR",t.EXTERNAL_SIGNAL_ABORT="EXTERNAL_SIGNAL_ABORT",t.LIVE_STREAMING_TASK_CONFLICT="LIVE_STREAMING_TASK_CONFLICT",t.LIVE_STREAMING_INVALID_ARGUMENT="LIVE_STREAMING_INVALID_ARGUMENT",t.LIVE_STREAMING_INTERNAL_SERVER_ERROR="LIVE_STREAMING_INTERNAL_SERVER_ERROR",t.LIVE_STREAMING_PUBLISH_STREAM_NOT_AUTHORIZED="LIVE_STREAMING_PUBLISH_STREAM_NOT_AUTHORIZED",t.LIVE_STREAMING_TRANSCODING_NOT_SUPPORTED="LIVE_STREAMING_TRANSCODING_NOT_SUPPORTED",t.LIVE_STREAMING_CDN_ERROR="LIVE_STREAMING_CDN_ERROR",t.LIVE_STREAMING_INVALID_RAW_STREAM="LIVE_STREAMING_INVALID_RAW_STREAM",t.LIVE_STREAMING_WARN_STREAM_NUM_REACH_LIMIT="LIVE_STREAMING_WARN_STREAM_NUM_REACH_LIMIT",t.LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE="LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE",t.LIVE_STREAMING_WARN_FREQUENT_REQUEST="LIVE_STREAMING_WARN_FREQUENT_REQUEST",t.WEBGL_INTERNAL_ERROR="WEBGL_INTERNAL_ERROR",t.BEAUTY_PROCESSOR_INTERNAL_ERROR="BEAUTY_PROCESSOR_INTERNAL_ERROR",t.CROSS_CHANNEL_WAIT_STATUS_ERROR="CROSS_CHANNEL_WAIT_STATUS_ERROR",t.CROSS_CHANNEL_FAILED_JOIN_SRC="CROSS_CHANNEL_FAILED_JOIN_SEC",t.CROSS_CHANNEL_FAILED_JOIN_DEST="CROSS_CHANNEL_FAILED_JOIN_DEST",t.CROSS_CHANNEL_FAILED_PACKET_SENT_TO_DEST="CROSS_CHANNEL_FAILED_PACKET_SENT_TO_DEST",t.CROSS_CHANNEL_SERVER_ERROR_RESPONSE="CROSS_CHANNEL_SERVER_ERROR_RESPONSE",t.METADATA_OUT_OF_RANGE="METADATA_OUT_OF_RANGE",t.LOCAL_AEC_ERROR="LOCAL_AEC_ERROR",t.INVALID_PLUGIN="INVALID_PLUGIN",t.DISCONNECT_P2P="DISCONNECT_P2P",t.CONVERTING_IMAGEDATA_TO_BLOB_FAILED="CONVERTING_IMAGEDATA_TO_BLOB_FAILED",t.CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED="CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED",t.INIT_DATACHANNEL_TIMEOUT="INIT_DATACHANNEL_TIMEOUT",t.CREATE_DATACHANNEL_ERROR="CREATE_DATACHANNEL_ERROR",t.DATACHANNEL_CONNECTION_TIMEOUT="DATACHANNEL_CONNECTION_TIMEOUT",t.PROHIBITED_OPERATION="PROHIBITED_OPERATION",t.IMAGE_MODERATION_UPLOAD_FAILED="IMAGE_MODERATION_UPLOAD_FAILED",t.P2P_MESSAGE_FAILED="P2P_MESSAGE_FAILED",t})({}),H=class extends Error{constructor(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"",n=arguments.length>2?arguments[2]:void 0;super(e),Ut(this,"code",void 0),Ut(this,"message",void 0),Ut(this,"data",void 0),Ut(this,"name","AgoraRTCException"),this.code=t,this.message="AgoraRTCError ".concat(this.code,": ").concat(e),this.data=n}toString(){return this.data?"".concat(this.message,`
data: `).concat(JSON.stringify(this.data)):this.message}print(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"error",e=arguments.length>1?arguments[1]:void 0;return t==="error"&&(e||console).error(this.toString()),t==="warning"&&(e||console).warn(this.toString()),this}throw(t){throw this.print("error",t),this}};function Zr(t,e){if(typeof t!="boolean")throw new H(A.INVALID_PARAMS,"Invalid ".concat(e,": The value is of the boolean type."))}function _n(t,e,n){if(!$(n).call(n,t))throw new H(A.INVALID_PARAMS,"".concat(e," can only be set as ").concat(JSON.stringify(n)))}function Oe(t,e){let n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:1,i=arguments.length>3&&arguments[3]!==void 0?arguments[3]:1e4;if(t<n||t>i||(!(arguments.length>4&&arguments[4]!==void 0)||arguments[4])&&!(function(r){return typeof r=="number"&&r%1==0})(t))throw new H(A.INVALID_PARAMS,"invalid ".concat(e,": the value range is [").concat(n,", ").concat(i,"]. integer only"))}function Yg(t,e){if(typeof t!="number"){if(!(t.min||t.max||t.ideal||t.exact))throw new H(A.INVALID_PARAMS,"".concat(e," is not a valid ConstrainLong"));t.min!==void 0&&Oe(t.min,"".concat(e,".min"),0,1/0),t.max!==void 0&&Oe(t.max,"".concat(e,".max"),1,1/0),t.exact!==void 0&&Oe(t.exact,"".concat(e,".exact"),1,1/0),t.ideal!==void 0&&Oe(t.ideal,"".concat(e,".ideal"),1,1/0)}else Oe(t,e,1,1/0)}function Kn(t,e){let n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:1,i=arguments.length>3&&arguments[3]!==void 0?arguments[3]:255,r=!(arguments.length>4&&arguments[4]!==void 0)||arguments[4];if(t==null)throw new H(A.INVALID_PARAMS,"".concat(e||"param"," cannot be empty"));if(!wO(t,n,i,r))throw new H(A.INVALID_PARAMS,"Invalid ".concat(e||"string param",": Length of the string: [").concat(n,",").concat(i,"].").concat(r?" ASCII characters only.":""))}function wo(t,e){if(!Array.isArray(t))throw new H(A.INVALID_PARAMS,"".concat(e," should be an array"))}function Ze(t){return t==null}function wO(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1,n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:255,i=!(arguments.length>3&&arguments[3]!==void 0)||arguments[3];return typeof t=="string"&&t.length<=n&&t.length>=e&&(!i||(function(r){if(typeof r!="string")return!1;for(let s=0;s<r.length;s+=1){const o=r.charCodeAt(s);if(o<0||o>255)return!1}return!0})(t))}function OO(t,e,n){if("getBigUint64"in DataView.prototype)return t.getBigUint64(e,n);const i=t.getUint32(e,n),r=t.getUint32(e+4,n),s=0,o=+!n;return BigInt(i*o+r*s)<<BigInt(32)|BigInt(i*s+r*o)}function NO(t,e,n,i){if("setBigUint64"in DataView.prototype)return t.setBigUint64(e,n,i);const r=Number(n>>BigInt(32)),s=Number(n&BigInt(4294967295));t.setUint32(e,r,i),t.setUint32(e+4,s,i)}var iu=(function(t){return t.COVERED="COVERED",t.POSITION="POSITION",t.SIZE="SIZE",t.STYLE="STYLE",t})(iu||{}),qg=(function(t){return t.UNMOUNTED="UNMOUNTED",t.INVALID_HTML_ELEMENT="INVALID_HTML_ELEMENT",t})(qg||{});const DO=new class{constructor(){Ut(this,"_clientSize",null),Ut(this,"getClientWidth",(()=>document.documentElement?document.documentElement.clientWidth:document.body.clientWidth)),Ut(this,"getClientHeight",(()=>document.documentElement?document.documentElement.clientHeight:document.body.clientHeight)),Ut(this,"getStyle",(t=>window.getComputedStyle(t,null))),Ut(this,"checkCssVisibleProperty",(t=>{var e;let n=!0;const i=this.getStyle(t),{display:r,visibility:s,opacity:o,filter:a}=i;return(r==="none"||$(e=["hidden","collapse"]).call(e,s)||Number(o)<.1)&&(n=!1),!!n&&(a&&a.split(" ").filter((c=>{var d;const l=c.split("(")[0];return $(d=["brightness","blur","opacity"]).call(d,l)})).map((c=>{const[d,l]=c.split(/\(|\)/);return[d,Number(l.match(/^[0-9\.]+/))]})).forEach((c=>{const[d,l]=c;switch(d){case"brightness":(l<.1||l>3)&&(n=!1);break;case"blur":l>3&&(n=!1);break;case"opacity":l<.1&&(n=!1)}})),n)})),Ut(this,"checkPropertyUpToAllParentNodes",((t,e)=>{let n=!0,i=!0;const r=o=>e(o);let s=t;for(;s&&i;)r(s)||(n=!1,i=!1),s=s.parentElement,s||(i=!1);return n})),Ut(this,"checkActualCssVisibleIncludeInherit",(t=>this.checkPropertyUpToAllParentNodes(t,this.checkCssVisibleProperty))),Ut(this,"getSizeAboutClient",(t=>{const{width:e,height:n,left:i,right:r,top:s,bottom:o}=t.getBoundingClientRect(),a=this.getClientWidth(),c=this.getClientHeight();return{width:e,height:n,left:i,right:r,top:s,bottom:o,clientWidth:a,clientHeight:c,clientMin:Math.min(a,c)}})),Ut(this,"checkActualSize",(()=>{const{width:t,height:e,clientMin:n}=this._clientSize;return this.checkSizeIsVisible(t,e,n)})),Ut(this,"elementFromPoint",((t,e)=>document.elementFromPoint?document.elementFromPoint(t,e):null)),Ut(this,"checkCoverForAPoint",((t,e,n)=>{const i=this.elementFromPoint(t,e);return i!==null&&i!==n})),Ut(this,"getPointPositionList",(()=>{const{width:t,height:e,left:n,top:i}=this._clientSize,r=t/6,s=e/6,o=[],a=10**6;for(let c=0;c<5;c++)for(let d=0;d<5;d++){const l=(n*a+(c===0?.1:c===4?(r*c*a-1e5)/a:r*c)*a)/a,h=(i*a+(d===0?.1:d===4?(s*d*a-1e5)/a:s*d)*a)/a;o.push({x:l,y:h})}return[...o]})),Ut(this,"checkElementCover",(t=>this.getPointPositionList().map((e=>this.checkCoverForAPoint(e.x,e.y,t))).filter((e=>!!e)).length>6)),Ut(this,"checkSizeIsVisible",((t,e,n)=>(t>50||n/t<=10)&&(e>50||n/e<=10))),Ut(this,"checkSizeOfPartInClient",(()=>{const{left:t,right:e,top:n,bottom:i,clientHeight:r,clientWidth:s,clientMin:o}=this._clientSize;let a,c,d,l;if(t<0)a=0;else{if(!(t<s))return!1;a=t}if(e<0)return!1;if(c=e<s?e:s,n<0)d=0;else{if(!(n<r))return!1;d=n}if(i<0)return!1;l=i<r?i:r;const h=c-a,p=l-d;return this.checkSizeIsVisible(h,p,o)})),Ut(this,"returnHiddenResult",(t=>(this._clientSize=null,{visible:!1,reason:t}))),Ut(this,"checkOneElementVisible",(t=>{if(t instanceof HTMLElement){if(this.checkElementIsMountedOnDom(t)){if(this.checkActualCssVisibleIncludeInherit(t)){if(this._clientSize=this.getSizeAboutClient(t),this.checkElementCover(t))return this.returnHiddenResult(iu.COVERED);{const e=this.checkActualSize(),n=this.checkSizeOfPartInClient();return e&&!n?this.returnHiddenResult(iu.POSITION):e?(this._clientSize=null,{visible:!0}):this.returnHiddenResult(iu.SIZE)}}return this.returnHiddenResult(iu.STYLE)}return this.returnHiddenResult(qg.UNMOUNTED)}return this.returnHiddenResult(qg.INVALID_HTML_ELEMENT)})),Ut(this,"checkElementIsMountedOnDom",(t=>this.checkPropertyUpToAllParentNodes(t,(e=>e.nodeName.toUpperCase()!=="HTML"?e.parentElement!==null:!!document.documentElement))))}};function zg(t){return new TextEncoder().encode(t)}const PO=function(t,e){const n=new Uint8Array(t.byteLength+e.byteLength);return n.set(new Uint8Array(t),0),n.set(new Uint8Array(e),t.byteLength),n},Xg=async t=>(function(e,n){let i="";return new Uint8Array(e).forEach((r=>{i+=r.toString(n).padStart(2,"0")})),i})(await crypto.subtle.digest("SHA-256",zg(t)),16);let qe=class{constructor(){Ut(this,"_events",{}),Ut(this,"addListener",this.on)}getListeners(t){return this._events[t]?this._events[t].map((e=>e.listener)):[]}on(t,e){this._events[t]||(this._events[t]=[]);const n=this._events[t];this._indexOfListener(n,e)===-1&&n.push({listener:e,once:!1})}once(t,e){this._events[t]||(this._events[t]=[]);const n=this._events[t];this._indexOfListener(n,e)===-1&&n.push({listener:e,once:!0})}off(t,e){if(!this._events[t])return;const n=this._events[t],i=this._indexOfListener(n,e);i!==-1&&n.splice(i,1),this._events[t].length===0&&delete this._events[t]}removeAllListeners(t){t?delete this._events[t]:this._events={}}emit(t){this._events[t]||(this._events[t]=[]);const e=this._events[t].map((s=>s));for(var n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];for(let s=0;s<e.length;s+=1){const o=e[s];o.once&&this.off(t,o.listener),o.listener.apply(this,i||[])}}safeEmit(t){for(var e=arguments.length,n=new Array(e>1?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];[...this._events[t]||[]].forEach((r=>{r.once&&this.off(t,r.listener);try{r.listener.apply(this,n)}catch(s){console.error("safeEmit event:".concat(t," error ").concat(s?.toString()))}}))}_indexOfListener(t,e){let n=t.length;for(;n--;)if(t[n].listener===e)return n;return-1}},ru=null;function LO(){if(ru)return ru;if(window.electron)return ru=window.electron;if(!window.require)return null;try{return ru=window.require("electron"),ru}catch{return null}}let Ge=(function(t){return t.CREATE_CLIENT="createClient",t.CHECK_SYSTEM_REQUIREMENTS="checkSystemRequirements",t.SET_AREA="setArea",t.PRELOAD="PRELOAD",t.CHECK_VIDEO_TRACK_IS_ACTIVE="checkVideoTrackIsActive",t.CHECK_AUDIO_TRACK_IS_ACTIVE="checkAudioTrackIsActive",t.CREATE_MIC_AUDIO_TRACK="createMicrophoneAudioTrack",t.CREATE_CUSTOM_AUDIO_TRACK="createCustomAudioTrack",t.CREATE_BUFFER_AUDIO_TRACK="createBufferSourceAudioTrack",t.CREATE_CAM_VIDEO_TRACK="createCameraVideoTrack",t.CREATE_CUSTOM_VIDEO_TRACK="createCustomVideoTrack",t.CREATE_MIC_AND_CAM_TRACKS="createMicrophoneAndCameraTracks",t.CREATE_SCREEN_VIDEO_TRACK="createScreenVideoTrack",t.SET_ENCRYPTION_CONFIG="Client.setEncryptionConfig",t.START_PROXY_SERVER="Client.startProxyServer",t.STOP_PROXY_SERVER="Client.stopProxyServer",t.SET_PROXY_SERVER="Client.setProxyServer",t.SET_TURN_SERVER="Client.setTurnServer",t.SET_CLIENT_ROLE="Client.setClientRole",t.SET_LOW_STREAM_PARAMETER="Client.setLowStreamParameter",t.ENABLE_DUAL_STREAM="Client.enableDualStream",t.DISABLE_DUAL_STREAM="Client.disableDualStream",t.JOIN="Client.join",t.LEAVE="Client.leave",t.PUBLISH="Client.publish",t.UNPUBLISH="Client.unpublish",t.SUBSCRIBE="Client.subscribe",t.MASS_SUBSCRIBE="Client.massSubscribe",t.MASS_UNSUBSCRIBE="Client.massUnsubscribe",t.UNSUBSCRIBE="Client.unsubscribe",t.RENEW_TOKEN="Client.renewToken",t.SET_REMOTE_VIDEO_STREAM_TYPE="Client.setRemoteVideoStreamType",t.SET_STREAM_FALLBACK_OPTION="Client.setStreamFallbackOption",t.ENABLE_AUDIO_VOLUME_INDICATOR="Client.enableAudioVolumeIndicator",t.SEND_CUSTOM_REPORT_MESSAGE="Client.sendCustomReportMessage",t.INSPECT_VIDEO_CONTENT="Client.inspectVideoContent",t.STOP_INSPECT_VIDEO_CONTENT="Client.stopInspectVideoContent",t.JOIN_FALLBACK_TO_PROXY="Client._joinFallbackToProxy",t.ON_LIVE_STREAM_WARNING="Client.onLiveStreamWarning",t.ON_LIVE_STREAM_ERROR="Client.onLiveStreamingError",t.START_LIVE_STREAMING="Client.startLiveStreaming",t.SET_LIVE_TRANSCODING="Client.setLiveTranscoding",t.STOP_LIVE_STREAMING="Client.stopLiveStreaming",t.START_CHANNEL_MEDIA_RELAY="Client.startChannelMediaRelay",t.UPDATE_CHANNEL_MEDIA_RELAY="Client.updateChannelMediaRelay",t.STOP_CHANNEL_MEDIA_RELAY="Client.stopChannelMediaRelay",t.REQUEST_CONFIG_DISTRIBUTE="_config-distribute-request",t.SET_CONFIG_DISTRIBUTE="_configDistribute",t.LOCAL_TRACK_SET_MUTED="LocalTrack.setMute",t.LOCAL_AUDIO_TRACK_PLAY="LocalAudioTrack.play",t.LOCAL_AUDIO_TRACK_PLAY_IN_ELEMENT="LocalAudioTrack.playInElement",t.LOCAL_AUDIO_TRACK_STOP="LocalAudioTrack.stop",t.LOCAL_AUDIO_TRACK_SET_VOLUME="LocalAudioTrack.setVolume",t.MIC_AUDIO_TRACK_SET_DEVICE="MicrophoneAudioTrack.setDevice",t.BUFFER_AUDIO_TRACK_START="BufferSourceAudioTrack.startProcessAudioBuffer",t.BUFFER_AUDIO_TRACK_STOP="BufferSourceAudioTrack.stopProcessAudioBuffer",t.BUFFER_AUDIO_TRACK_PAUSE="BufferSourceAudioTrack.pauseProcessAudioBuffer",t.BUFFER_AUDIO_TRACK_RESUME="BufferSourceAudioTrack.resumeProcessAudioBuffer",t.BUFFER_AUDIO_TRACK_SEEK="BufferSourceAudioTrack.seekAudioBuffer",t.LOCAL_VIDEO_TRACK_PLAY="LocalVideoTrack.play",t.LOCAL_VIDEO_TRACK_STOP="LocalVideoTrack.stop",t.LOCAL_VIDEO_TRACK_GET_VIDEO_VISIBLE="LocalVideoTrack.getVideoElementVisibleStatus",t.LOCAL_VIDEO_TRACK_BEAUTY="LocalVideoTrack.setBeautyEffect",t.LOCAL_VIDEO_SEND_SEI_DATA="LocalVideoTrack.sendSeiData",t.CAM_VIDEO_TRACK_SET_DEVICE="CameraVideoTrack.setDevice",t.CAM_VIDEO_TRACK_SET_ENCODER_CONFIG="CameraVideoTrack.setEncoderConfiguration",t.REMOTE_VIDEO_TRACK_PLAY="RemoteVideoTrack.play",t.REMOTE_VIDEO_TRACK_STOP="RemoteVideoTrack.stop",t.REMOTE_VIDEO_TRACK_GET_VIDEO_VISIBLE="RemoteVideoTrack.getVideoElementVisibleStatus",t.REMOTE_AUDIO_TRACK_PLAY="RemoteAudioTrack.play",t.REMOTE_AUDIO_TRACK_STOP="RemoteAudioTrack.stop",t.REMOTE_AUDIO_SET_VOLUME="RemoteAudioTrack.setVolume",t.REMOTE_AUDIO_SET_OUTPUT_DEVICE="RemoteAudioTrack.setOutputDevice",t.GET_MEDIA_STREAM_TRACK="Track.getMediaStreamTrack",t.STREAM_TYPE_CHANGE="streamTypeChange",t.CONNECTION_STATE_CHANGE="connectionStateChange",t.LOAD_CONFIG_FROM_LOCALSTORAGE="loadConfigFromLocalStorage",t.IMAGE_MODERATION_UPLOAD="imageModerationUpload",t.REPUB_AFTER_PC_CONNECTED="repubAfterPCConnected",t.PRELOAD_MEDIA_FAILED="preloadMediaFailed",t.MISMATCH_DTLS_PARAMETERS="mismatchDtlsParameters",t.VOS_FALLBACK_CN="vosFallbackCN",t.DATACHANNEL_FAILBACK="datachannelFailback",t})({}),Ne=(function(t){return t.TRACER="tracer",t})({});function kO(t){return Oe(t.timeout,"config.timeout",0,1e5),Oe(t.timeoutFactor,"config.timeoutFactor",0,100,!1),Oe(t.maxRetryCount,"config.maxRetryConfig",0,1/0),Oe(t.maxRetryTimeout,"config.maxRetryTimeout",0,1/0),!0}let Z6=(function(t){return t[t.AUDIENCE_LEVEL_LOW_LATENCY=1]="AUDIENCE_LEVEL_LOW_LATENCY",t[t.AUDIENCE_LEVEL_ULTRA_LOW_LATENCY=2]="AUDIENCE_LEVEL_ULTRA_LOW_LATENCY",t[t.AUDIENCE_LEVEL_SYNC_LATENCY=3]="AUDIENCE_LEVEL_SYNC_LATENCY",t})({}),te=(function(t){return t.LEAVE="LEAVE",t.NETWORK_ERROR="NETWORK_ERROR",t.SERVER_ERROR="SERVER_ERROR",t.UID_BANNED="UID_BANNED",t.FALLBACK="FALLBACK",t.IP_BANNED="IP_BANNED",t.CHANNEL_BANNED="CHANNEL_BANNED",t.LICENSE_MISSING="LICENSE_MISSING",t.LICENSE_EXPIRED="LICENSE_EXPIRED",t.LICENSE_MINUTES_EXCEEDED="LICENSE_MINUTES_EXCEEDED",t.LICENSE_PERIOD_INVALID="LICENSE_PERIOD_INVALID",t.LICENSE_MULTIPLE_SDK_SERVICE="LICENSE_MULTIPLE_SDK_SERVICE",t.LICENSE_ILLEGAL="LICENSE_ILLEGAL",t.TOKEN_EXPIRE="TOKEN_EXPIRE",t.FALLBACK_TO_HLS="FALLBACK_TO_HLS",t.UID_CONFLICT="UID_CONFLICT",t})({});function Ja(t){if(!Array.isArray(t)||t.length<1)return!1;try{t.forEach((e=>{if(!e.urls)throw Error()}))}catch{return!1}return!0}function MO(t){return Kn(t.turnServerURL,"turnServerURL"),Kn(t.username,"username"),Kn(t.password,"password"),t.udpport&&Oe(t.udpport,"udpport",1,99999,!0),t.forceturn&&Zr(t.forceturn,"forceturn"),t.security&&Zr(t.security,"security"),t.tcpport&&Oe(t.tcpport,"tcpport",1,99999,!0),!0}let Sd=(function(t){return t[t.AUTO_SIMULCAST_STREAM=-1]="AUTO_SIMULCAST_STREAM",t[t.DISABLE_SIMULCAST_STREM=0]="DISABLE_SIMULCAST_STREM",t[t.ENABLE_SIMULCAST_STREAM=1]="ENABLE_SIMULCAST_STREAM",t})({});function Jg(t){return t.level!==void 0&&_n(t.level,"level",[1,2,3]),t.delay!==void 0&&Oe(t.delay,"delay",0,3e3,!0),!0}let qt=(function(t){return t.PEERCONNECTION_STATE_CHANGE="peerconnection-state-change",t.AUDIO_METADATA="audio-metadata",t.AUDIO_PTS="audio-pts",t.CONNECTION_STATE_CHANGE="connection-state-change",t.MEDIA_RECONNECT_START="media-reconnect-start",t.MEDIA_RECONNECT_END="media-reconnect-end",t.IS_USING_CLOUD_PROXY="is-using-cloud-proxy",t.USER_JOINED="user-joined",t.USER_LEAVED="user-left",t.USER_PUBLISHED="user-published",t.USER_UNPUBLISHED="user-unpublished",t.USER_INFO_UPDATED="user-info-updated",t.CLIENT_BANNED="client-banned",t.CHANNEL_MEDIA_RELAY_STATE="channel-media-relay-state",t.CHANNEL_MEDIA_RELAY_EVENT="channel-media-relay-event",t.VOLUME_INDICATOR="volume-indicator",t.CRYPT_ERROR="crypt-error",t.ON_TOKEN_PRIVILEGE_WILL_EXPIRE="token-privilege-will-expire",t.ON_TOKEN_PRIVILEGE_DID_EXPIRE="token-privilege-did-expire",t.NETWORK_QUALITY="network-quality",t.STREAM_TYPE_CHANGED="stream-type-changed",t.STREAM_FALLBACK="stream-fallback",t.RECEIVE_METADATA="receive-metadata",t.STREAM_MESSAGE="stream-message",t.LIVE_STREAMING_ERROR="live-streaming-error",t.LIVE_STREAMING_WARNING="live-streaming-warning",t.EXCEPTION="exception",t.ERROR="error",t.P2P_LOST="p2p_lost",t.JOIN_FALLBACK_TO_PROXY="join-fallback-to-proxy",t.CHANNEL_FALLBACK_TO_WEBSOCKET="channel-fallback-to-websocket",t.MEDIA_CONNECTION_TYPE_CHANGE="media-connection-type-change",t.PUBLISHED_USER_LIST="published-user-list",t.CONTENT_INSPECT_CONNECTION_STATE_CHANGE="content-inspect-connection-state-change",t.CONTENT_INSPECT_ERROR="content-inspect-error",t.CONTENT_INSPECT_RESULT="content-inspect-result",t.IMAGE_MODERATION_CONNECTION_STATE_CHANGE="image-moderation-connection-state-change",t.FALLBACK_TO_HLS="fallback-to-hls",t.FIRST_VIDEO_BUFFER_READY="first-video-buffer-ready",t.FIRST_VIDEO_PRE_RENDER="first-video-pre-render",t.AV1_DECODABLE_RESULT="av1-decodable-result",t})({}),Qg=(function(t){return t.CONFIG="config",t.VOSERROR="vos_error",t.AP_ERROR="ap_error",t})({}),Xn=(function(t){return t.NETWORK_ERROR="NETWORK_ERROR",t.SERVER_ERROR="SERVER_ERROR",t.MULTI_IP="MULTI_IP",t.TIMEOUT="TIMEOUT",t.OFFLINE="OFFLINE",t.LEAVE="LEAVE",t.P2P_FAILED="P2P_FAILED",t.FALLBACK="FALLBACK",t.REGIONAL_DISTRIBUTION="REGIONAL_DISTRIBUTION",t})({}),mi=(function(t){return t.ONLINE="ONLINE",t.OFFLINE="OFFLINE",t})({}),Qa=(function(t){return t.NETWORK_STATE_CHANGE="NETWORK_STATE_CHANGE",t.ONLINE="ONLINE",t.OFFLINE="OFFLINE",t})({});function Sn(t,e){for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];return t.getListeners(e).length===0?st.reject(new H(A.UNEXPECTED_ERROR,"can not emit promise")):new st(((s,o)=>{t.emit(e,...i,s,o)}))}function Pe(t,e){if(t.getListeners(e).length===0)return st.resolve();for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];return Sn(t,e,...i)}function Ji(t,e){if(t.getListeners(e).length===0)return null;for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];return Za(t,e,...i)}function Za(t,e){let n=null,i=null;for(var r=arguments.length,s=new Array(r>2?r-2:0),o=2;o<r;o++)s[o-2]=arguments[o];if(t.emit(e,...s,(a=>{n=a}),(a=>{i=a})),i!==null)throw i;if(n===null)throw new H(A.UNEXPECTED_ERROR,"handler is not sync");return n}const $e=new class extends qe{set networkState(t){this.emit(Qa.NETWORK_STATE_CHANGE,t,this._networkState),t===mi.ONLINE?this.emit(Qa.ONLINE):t===mi.OFFLINE&&(this.onlineWaiter=new st((e=>{this.once(Qa.ONLINE,(()=>{this.onlineWaiter=void 0,e(mi.ONLINE)}))})),this.emit(Qa.OFFLINE)),this._networkState=t}get networkState(){return this._networkState}get isOnline(){return this._networkState===mi.ONLINE}constructor(){super(),Ut(this,"_moduleName","network-indicator"),Ut(this,"_networkState",mi.ONLINE),Ut(this,"onlineWaiter",void 0),window.addEventListener("online",(()=>{this.networkState=mi.ONLINE})),window.addEventListener("offline",(()=>{this.networkState=mi.OFFLINE}))}},Ii=[];for(let t=0;t<256;++t)Ii.push((t+256).toString(16).slice(1));const UO=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto);let Zg;const $6=new Uint8Array(16);function t8(){return UO?UO():(function(n,i,r){var s,o,a,c;const d=(s=(o=(n=n||{}).random)!==null&&o!==void 0?o:(a=(c=n).rng)===null||a===void 0?void 0:a.call(c))!==null&&s!==void 0?s:(function(){if(!Zg){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");Zg=crypto.getRandomValues.bind(crypto)}return Zg($6)})();if(d.length<16)throw new Error("Random bytes length must be >= 16");if(d[6]=15&d[6]|64,d[8]=63&d[8]|128,i){if((r=r||0)<0||r+16>i.length)throw new RangeError("UUID byte range ".concat(r,":").concat(r+15," is out of buffer bounds"));for(let l=0;l<16;++l)i[r+l]=d[l];return i}return(function(l){let h=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0;return(Ii[l[h+0]]+Ii[l[h+1]]+Ii[l[h+2]]+Ii[l[h+3]]+"-"+Ii[l[h+4]]+Ii[l[h+5]]+"-"+Ii[l[h+6]]+Ii[l[h+7]]+"-"+Ii[l[h+8]]+Ii[l[h+9]]+"-"+Ii[l[h+10]]+Ii[l[h+11]]+Ii[l[h+12]]+Ii[l[h+13]]+Ii[l[h+14]]+Ii[l[h+15]]).toLowerCase()})(d)})(t,e,void 0);var t,e}function Wp(t,e){const n=t.indexOf(e);n!==-1&&t.splice(n,1)}function Td(t){const e=[];return t.forEach((n=>{e.indexOf(n)===-1&&e.push(n)})),e}function Hp(t){st!==void 0?st.resolve().then(t):setTimeout(t,0)}function Ve(t){return JSON.parse(JSON.stringify(t))}function $a(t){try{return Ve(t)}catch{return t}}const xO={};function oa(t,e){xO[e]||(xO[e]=!0,t())}function tc(t){const e=window.atob(t),n=new Uint8Array(new ArrayBuffer(e.length));for(let i=0;i<e.length;i+=1)n[i]=e.charCodeAt(i);return n}function aa(t){let e="";for(let n=0;n<t.length;n+=1)e+=String.fromCharCode(t[n]);return window.btoa(e)}function VO(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:16,n=new TextEncoder().encode(t);if(n.length>e)n=n.slice(0,e);else if(n.length<e){const i=new Uint8Array(e);i.set(n),n=i}return n}function FO(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];const i=Ir(e).call(e,((o,a)=>o+a.length),0),r=new Uint8Array(new ArrayBuffer(i));let s=0;return e.forEach((o=>{r.set(o,s),s+=o.length})),r}function Qs(t){return window.TextEncoder?new TextEncoder().encode(t).length:t.length}function BO(t){let e=0;return(/DingTalk/i.test(navigator.userAgent)||/AliApp/i.test(navigator.userAgent))&&t.realFormData&&(t=t.realFormData),t.forEach((n=>{e+=typeof n=="string"?Qs(n):n.size})),e+138}function e8(t){const e=new H(A.TIMEOUT,"timeout");return new st(((n,i)=>{window.setTimeout((()=>i(e)),t)}))}function Nn(t){return new st((e=>{window.setTimeout(e,t)}))}function Se(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:7,e=arguments.length>1?arguments[1]:void 0;const n=Math.random().toString(16).substr(2,t).toLowerCase();return n.length===t?"".concat(e).concat(n):"".concat(e).concat(n)+Se(t-n.length,"")}function ec(){let t,e=!1;try{var n;t=D4(n=t8()).call(n,"-","")}catch{e=!0}return!e&&t&&t.length===32||(t=Se(32,"")),t.toUpperCase()}const su=()=>{},jO=new class{constructor(){Ut(this,"fnMap",new Map)}throttleByKey(t,e,n,i){for(var r=arguments.length,s=new Array(r>4?r-4:0),o=4;o<r;o++)s[o-4]=arguments[o];if(this.fnMap.has(e)){const a=this.fnMap.get(e);if(a.threshold!==n){a.fn(...a.args),clearTimeout(a.timer);const c=window.setTimeout((()=>{const d=this.fnMap.get(e);d&&d.fn(...d.args),this.fnMap.delete(e)}),n);this.fnMap.set(e,{fn:t,threshold:n,timer:c,args:s,skipFn:i})}else a.skipFn&&a.skipFn(...a.args),this.fnMap.set(e,nt(nt({},a),{},{fn:t,args:s,skipFn:i}))}else{const a=window.setTimeout((()=>{const c=this.fnMap.get(e);c&&c.fn(...c.args),this.fnMap.delete(e)}),n);this.fnMap.set(e,{fn:t,threshold:n,timer:a,args:s,skipFn:i})}}},GO=jO.throttleByKey.bind(jO);function WO(t){return typeof t=="object"&&t!==null&&!(t instanceof RegExp)}function $g(t,e){if(!WO(t)||!WO(e)||Array.isArray(t)&&!Array.isArray(e)||!Array.isArray(t)&&Array.isArray(e))return e;if(Array.isArray(e)&&Array.isArray(t)){const n=[...t];for(let i=0;i<e.length;i++)n[i]=$g(t[i],e[i]);return n}{const n=nt({},t);for(const i in e)Object.prototype.hasOwnProperty.call(e,i)&&(Object.prototype.hasOwnProperty.call(t,i)?n[i]=$g(t[i],e[i]):n[i]=e[i]);return n}}function HO(t,e){let n=[0];if(n=new Array(e).fill(0),t===0)return n;let i=0;for(;t>0&&(n[i]=255&t,t>>=8,i++,i!==e););return n}function Rd(t){return typeof t=="number"?t:t.exact||t.ideal||t.max||t.min||0}function tS(t,e){try{return typeof t=="object"&&typeof e=="object"&&JSON.stringify(t)===JSON.stringify(e)}catch{return!1}}function eS(t){return Ir(t).call(t,((e,n)=>e+n),0)}function KO(t){const e="0123456789abcdef";function n(D){let k,U="";for(k=0;k<=3;k++)U+=e.charAt(D>>8*k+4&15)+e.charAt(D>>8*k&15);return U}function i(D,k){const U=(65535&D)+(65535&k);return(D>>16)+(k>>16)+(U>>16)<<16|65535&U}function r(D,k,U,P,x,q){return i((function(Q,dt){return Q<<dt|Q>>>32-dt})(i(i(k,D),i(P,q)),x),U)}function s(D,k,U,P,x,q,Q){return r(k&U|~k&P,D,k,x,q,Q)}function o(D,k,U,P,x,q,Q){return r(k&P|U&~P,D,k,x,q,Q)}function a(D,k,U,P,x,q,Q){return r(k^U^P,D,k,x,q,Q)}function c(D,k,U,P,x,q,Q){return r(U^(k|~P),D,k,x,q,Q)}const d=(function(D){let k;const U=1+(D.length+8>>6),P=new Array(16*U);for(k=0;k<16*U;k++)P[k]=0;for(k=0;k<D.length;k++)P[k>>2]|=D.charCodeAt(k)<<k%4*8;return P[k>>2]|=128<<k%4*8,P[16*U-2]=8*D.length,P})(t);let l,h,p,f,v,S=1732584193,T=-271733879,b=-1732584194,w=271733878;for(l=0;l<d.length;l+=16)h=S,p=T,f=b,v=w,S=s(S,T,b,w,d[l+0],7,-680876936),w=s(w,S,T,b,d[l+1],12,-389564586),b=s(b,w,S,T,d[l+2],17,606105819),T=s(T,b,w,S,d[l+3],22,-1044525330),S=s(S,T,b,w,d[l+4],7,-176418897),w=s(w,S,T,b,d[l+5],12,1200080426),b=s(b,w,S,T,d[l+6],17,-1473231341),T=s(T,b,w,S,d[l+7],22,-45705983),S=s(S,T,b,w,d[l+8],7,1770035416),w=s(w,S,T,b,d[l+9],12,-1958414417),b=s(b,w,S,T,d[l+10],17,-42063),T=s(T,b,w,S,d[l+11],22,-1990404162),S=s(S,T,b,w,d[l+12],7,1804603682),w=s(w,S,T,b,d[l+13],12,-40341101),b=s(b,w,S,T,d[l+14],17,-1502002290),T=s(T,b,w,S,d[l+15],22,1236535329),S=o(S,T,b,w,d[l+1],5,-165796510),w=o(w,S,T,b,d[l+6],9,-1069501632),b=o(b,w,S,T,d[l+11],14,643717713),T=o(T,b,w,S,d[l+0],20,-373897302),S=o(S,T,b,w,d[l+5],5,-701558691),w=o(w,S,T,b,d[l+10],9,38016083),b=o(b,w,S,T,d[l+15],14,-660478335),T=o(T,b,w,S,d[l+4],20,-405537848),S=o(S,T,b,w,d[l+9],5,568446438),w=o(w,S,T,b,d[l+14],9,-1019803690),b=o(b,w,S,T,d[l+3],14,-187363961),T=o(T,b,w,S,d[l+8],20,1163531501),S=o(S,T,b,w,d[l+13],5,-1444681467),w=o(w,S,T,b,d[l+2],9,-51403784),b=o(b,w,S,T,d[l+7],14,1735328473),T=o(T,b,w,S,d[l+12],20,-1926607734),S=a(S,T,b,w,d[l+5],4,-378558),w=a(w,S,T,b,d[l+8],11,-2022574463),b=a(b,w,S,T,d[l+11],16,1839030562),T=a(T,b,w,S,d[l+14],23,-35309556),S=a(S,T,b,w,d[l+1],4,-1530992060),w=a(w,S,T,b,d[l+4],11,1272893353),b=a(b,w,S,T,d[l+7],16,-155497632),T=a(T,b,w,S,d[l+10],23,-1094730640),S=a(S,T,b,w,d[l+13],4,681279174),w=a(w,S,T,b,d[l+0],11,-358537222),b=a(b,w,S,T,d[l+3],16,-722521979),T=a(T,b,w,S,d[l+6],23,76029189),S=a(S,T,b,w,d[l+9],4,-640364487),w=a(w,S,T,b,d[l+12],11,-421815835),b=a(b,w,S,T,d[l+15],16,530742520),T=a(T,b,w,S,d[l+2],23,-995338651),S=c(S,T,b,w,d[l+0],6,-198630844),w=c(w,S,T,b,d[l+7],10,1126891415),b=c(b,w,S,T,d[l+14],15,-1416354905),T=c(T,b,w,S,d[l+5],21,-57434055),S=c(S,T,b,w,d[l+12],6,1700485571),w=c(w,S,T,b,d[l+3],10,-1894986606),b=c(b,w,S,T,d[l+10],15,-1051523),T=c(T,b,w,S,d[l+1],21,-2054922799),S=c(S,T,b,w,d[l+8],6,1873313359),w=c(w,S,T,b,d[l+15],10,-30611744),b=c(b,w,S,T,d[l+6],15,-1560198380),T=c(T,b,w,S,d[l+13],21,1309151649),S=c(S,T,b,w,d[l+4],6,-145523070),w=c(w,S,T,b,d[l+11],10,-1120210379),b=c(b,w,S,T,d[l+2],15,718787259),T=c(T,b,w,S,d[l+9],21,-343485551),S=i(S,h),T=i(T,p),b=i(b,f),w=i(w,v);return n(S)+n(T)+n(b)+n(w)}let n8=1,YO=console,Un=class{static setLogger(t){YO=t}constructor(t,e){Ut(this,"id",void 0),Ut(this,"lockingPromise",st.resolve()),Ut(this,"locks",0),Ut(this,"name",""),Ut(this,"lockId",void 0),this.lockId=n8++,t&&(this.name=t),e&&(this.id=e),this.logger("created")}logger(t,e){const n=(this.id?"[".concat(this.id,"]"):"")+"[lock-".concat(this.name,"-").concat(this.lockId,"]"),i=t==="created"?"is ".concat(t,"."):"is ".concat(t,", current queue ").concat(this.locks,". ").concat(e??"");YO.debug("".concat(n," ").concat(i))}setId(t){this.id=t}get isLocked(){return this.locks>0}lock(t){let e;this.locks+=1,this.logger("locked",t);const n=new st((r=>{e=()=>{this.locks-=1,this.logger("unlocked",t),r()}})),i=this.lockingPromise.then((()=>e));return this.lockingPromise=this.lockingPromise.then((()=>n)),i}};function vd(t,e){return function(n,i,r){const s=r.value;if(typeof s!="function")throw new Error("Cannot use mutex on object property.");return r.value=async function(){const o=this[e];if(!o)throw new Error("mutex property key ".concat(e," doesn't exist on ").concat(t));const a=await o.lock("From ".concat(t,".").concat(i));try{for(var c=arguments.length,d=new Array(c),l=0;l<c;l++)d[l]=arguments[l];return await s.apply(this,d)}finally{a()}},r}}const fn={timeout:500,timeoutFactor:1.5,maxRetryCount:1/0,maxRetryTimeout:1e4};function Kp(t,e){const n=Math.floor(e.timeout*Math.pow(e.timeoutFactor,t));return Math.min(e.maxRetryTimeout,n)}function Rs(t,e,n,i){const r=Object.assign({},fn,i);let s=r.timeout;const o=async()=>{await(function(d){return new st((l=>{window.setTimeout(l,d)}))})(s),s*=r.timeoutFactor,s=Math.min(r.maxRetryTimeout,s)};let a=!1;const c=new st((async(d,l)=>{e=e||(()=>!1),n=n||(()=>!0);for(let h=0;h<r.maxRetryCount;h+=1){if(a)return l(new H(A.OPERATION_ABORTED));try{const p=await t();if(!e(p,h)||h+1===r.maxRetryCount)return d(p);await o()}catch(p){if(!n(p,h)||h+1===r.maxRetryCount)return l(p);await o()}}}));return c.cancel=()=>a=!0,c}let Yp,nS=class{constructor(t){Ut(this,"input",[]),Ut(this,"size",void 0),this.size=t}add(t){this.input.push(t),this.input.length>this.size&&this.input.splice(0,1)}mean(){var t;return this.input.length===0?0:Ir(t=this.input).call(t,((e,n)=>e+n))/this.input.length}},qp=0,iS=0;function rS(t,e,n,i){return new st(((r,s)=>{e.responseType=e.responseType||"json",e.data&&!n?(e.data=JSON.stringify(e.data),qp+=Qs(e.data)):n&&(e.data.size?qp+=e.data.size:e.data instanceof FormData?qp+=BO(e.data):qp+=Qs(JSON.stringify(e.data))),e.headers=e.headers||{},e.headers["Content-Type"]=e.headers["Content-Type"]||"application/json",e.method="POST",e.url=t,yi.request(e).then((o=>{typeof o.data=="string"?iS+=Qs(o.data):o.data instanceof ArrayBuffer||o.data instanceof Uint8Array?iS+=o.data.byteLength:iS+=Qs(JSON.stringify(o.data)),r(o.data)})).catch((o=>{yi.isCancel(o)?s(new H(A.OPERATION_ABORTED,"cancel token canceled")):o.code==="ECONNABORTED"?s(new H(A.NETWORK_TIMEOUT,o.message)):o.response?s(new H(A.NETWORK_RESPONSE_ERROR,o.response.status)):s(new H(A.NETWORK_ERROR,o.message))}))}))}async function i8(t,e){const n=new Blob([e.data],{type:"buffer"});return await rS(t,nt(nt({},e),{},{data:n,headers:{"Content-Type":"application/octet-stream"}}),!0)}const qO=()=>window.isSecureContext!==void 0;function $r(t){if(Array.isArray(t))return t.map((n=>n));if(!zO(t))return t;const e={};for(const n in t){const i=t[n];zO(i)||Array.isArray(i)?e[n]=$r(i):e[n]=i}return e}function zO(t){return!(typeof t!="object"||Array.isArray(t)||!t)}let sS=class{constructor(t){Ut(this,"input",[]),Ut(this,"size",void 0),this.size=t}add(t){this.input.push(t),this.input.length>this.size&&this.input.splice(0,1)}diffMean(){return this.input.length===0?0:(this.input[this.input.length-1]-this.input[0])/this.input.length}};const ts={address:"unknown",candidateType:"unknown",id:"unknown",port:0,priority:0,protocol:"unknown",type:"unknown"},ou={timestamp:0,bitrate:{actualEncoded:0,transmit:0},sendPacketLossRate:0,recvPacketLossRate:0,videoRecv:[],videoSend:[],audioRecv:[],audioSend:[],transport:{bytesSent:0,bytesReceived:0,packetsSent:0,packetsReceived:0},selectedCandidatePair:{id:"unknown",localCandidate:ts,remoteCandidate:ts},updateInterval:0},XO={firsCount:0,nacksCount:0,plisCount:0,framesDecodeCount:0,framesDecodeInterval:0,framesDecodeFreezeTime:0,decodeFrameRate:0,bytes:0,packetsLost:0,packetLostRate:0,packets:0,ssrc:0,qpSumPerFrame:0,framesDroppedCount:0,outputFrameRate:0,packetsDiscarded:0,framesAssembledFromMultiplePackets:0,totalProcessingDelay:0,avgDecodeMs:0,avgFramesAssembledFromMultiplePacketsMs:0,avgProcessingDelayMs:0,avgInterFrameDelayMs:0,totalAssemblyTime:0},JO={firsCount:0,nacksCount:0,plisCount:0,frameCount:0,bytes:0,packets:0,packetsLost:0,packetLostRate:0,ssrc:0,rttMs:0,jitterMs:0,qpSumPerFrame:0},QO={bytes:0,packets:0,packetsLost:0,packetLostRate:0,ssrc:0,rttMs:0,jitterMs:0},ZO={jitterBufferMs:0,jitterMs:0,bytes:0,packetsLost:0,packetLostRate:0,packetsDiscarded:0,packets:0,ssrc:0,receivedFrames:0,droppedFrames:0,concealedSamples:0,totalSamplesReceived:0,silentConcealedSamples:0,concealmentEvents:0,freezeMs80:0,freezeMs200:0,freezeSamples80:0,freezeSamples200:0};let oS=class{constructor(t,e){Ut(this,"onFirstVideoReceived",void 0),Ut(this,"onFirstVideoDecoded",void 0),Ut(this,"onFirstAudioReceived",void 0),Ut(this,"onFirstVideoDecodedTimeout",void 0),Ut(this,"onFirstAudioDecoded",void 0),Ut(this,"onSelectedLocalCandidateChanged",void 0),Ut(this,"onSelectedRemoteCandidateChanged",void 0),Ut(this,"videoIsReady",!1),Ut(this,"videoIsReady2",{}),Ut(this,"pc",void 0),Ut(this,"options",void 0),Ut(this,"intervalTimer",void 0),Ut(this,"stats",$r(ou)),Ut(this,"isFirstVideoReceived",{}),Ut(this,"isFirstVideoDecoded",{}),Ut(this,"isFirstAudioReceived",{}),Ut(this,"isFirstAudioDecoded",{}),Ut(this,"isFirstVideoDecodedTimeout",{}),Ut(this,"lossRateWindowStats",[]),this.pc=t,this.options=e,this.intervalTimer=window.setInterval((async()=>{this.updateStats()}),this.options.updateInterval)}getStats(){return this.stats}getSelectedCandidatePair(){return new st((t=>{t({local:nt({},ts),remote:nt({},ts)})}))}setVideoIsReady(t){this.videoIsReady=t}setVideoIsReady2(t,e){this.videoIsReady2[t]=e}getVideoIsReady(t){return this.videoIsReady2[t]||!1}setIsFirstAudioDecoded(t){}destroy(){window.clearInterval(this.intervalTimer),this.pc=void 0}calcLossRate(t){this.lossRateWindowStats.push(t),this.lossRateWindowStats.length>this.options.lossRateInterval&&this.lossRateWindowStats.splice(0,1);const e=this.lossRateWindowStats.length,n=["videoSend","audioSend","videoRecv","audioRecv"];let i=0,r=0,s=0,o=0;for(const a of n)t[a].forEach(((c,d)=>{if(!this.lossRateWindowStats[e-1][a][d]||!this.lossRateWindowStats[0][a][d])return;const l=this.lossRateWindowStats[e-1][a][d].packets-this.lossRateWindowStats[0][a][d].packets,h=this.lossRateWindowStats[e-1][a][d].packetsLost-this.lossRateWindowStats[0][a][d].packetsLost;a==="videoSend"||a==="audioSend"?(i+=l,s+=h):(r+=l,o+=h),Number.isNaN(l)||Number.isNaN(l)?c.packetLostRate=0:c.packetLostRate=l<=0||h<=0?0:h/(l+h)}));t.sendPacketLossRate=i<=0||s<=0?0:s/(i+s),t.recvPacketLossRate=r<=0||o<=0?0:o/(r+o)}},r8=class extends oS{constructor(){super(...arguments),Ut(this,"_stats",ou),Ut(this,"lastDecodeVideoReceiverStats",new Map)}async updateStats(){const t=await this._getStats(),e=this.statsResponsesToObjects(t);this._stats=$r(ou);const n=e.filter((r=>r.type==="ssrc"));this.processSSRCStats(n);const i=e.find((r=>r.type==="VideoBwe"));i&&this.processBandwidthStats(i),this._stats.timestamp=Date.now(),this.calcLossRate(this._stats),this.stats=this._stats}processBandwidthStats(t){this._stats.bitrate={actualEncoded:Number(t.googActualEncBitrate),targetEncoded:Number(t.googTargetEncBitrate),retransmit:Number(t.googRetransmitBitrate),transmit:Number(t.googTransmitBitrate)},this._stats.sendBandwidth=Number(t.googAvailableSendBandwidth)}processSSRCStats(t){t.forEach((e=>{var n;const i=$(n=e.id).call(n,"send");switch("".concat(e.mediaType,"_").concat(i?"send":"recv")){case"video_send":{const r=$r(JO);r.codec=e.googCodecName,r.adaptionChangeReason="none",e.googCpuLimitedResolution&&(r.adaptionChangeReason="cpu"),e.googBandwidthLimitedResolution&&(r.adaptionChangeReason="bandwidth"),r.avgEncodeMs=Number(e.googAvgEncodeMs),r.inputFrame={width:Number(e.googFrameWidthInput)||Number(e.googFrameWidthSent),height:Number(e.googFrameHeightInput)||Number(e.googFrameHeightSent),frameRate:Number(e.googFrameRateInput)},r.sentFrame={width:Number(e.googFrameWidthSent),height:Number(e.googFrameHeightSent),frameRate:Number(e.googFrameRateInput)},r.firsCount=Number(e.googFirReceived),r.nacksCount=Number(e.googNacksReceived),r.plisCount=Number(e.googPlisReceived),r.frameCount=Number(e.framesEncoded),r.bytes=Number(e.bytesSent),r.packets=Number(e.packetsSent),r.packetsLost=Number(e.packetsLost),r.ssrc=Number(e.ssrc),r.rttMs=Number(e.googRtt||0),this._stats.videoSend.push(r),this._stats.rtt=r.rttMs;break}case"video_recv":{const r=$r(XO),s=this.lastDecodeVideoReceiverStats.get(Number(e.ssrc));if(r.codec=e.googCodecName,r.targetDelayMs=Number(e.googTargetDelayMs),r.renderDelayMs=Number(e.googRenderDelayMs),r.currentDelayMs=Number(e.googCurrentDelayMs),r.minPlayoutDelayMs=Number(e.googMinPlayoutDelayMs),r.decodeMs=Number(e.googDecodeMs),r.maxDecodeMs=Number(e.googMaxDecodeMs),r.receivedFrame={width:Number(e.googFrameWidthReceived),height:Number(e.googFrameHeightReceived),frameRate:Number(e.googFrameRateReceived)},r.decodedFrame={width:Number(e.googFrameWidthReceived),height:Number(e.googFrameHeightReceived),frameRate:Number(e.googFrameRateDecoded)},r.decodeFrameRate=Number(e.googFrameRateDecoded),r.outputFrame={width:Number(e.googFrameWidthReceived),height:Number(e.googFrameHeightReceived),frameRate:Number(e.googFrameRateOutput)},r.jitterBufferMs=Number(e.googJitterBufferMs),r.firsCount=Number(e.googFirsSent),r.nacksCount=Number(e.googNacksSent),r.plisCount=Number(e.googPlisSent),r.framesDecodeCount=Number(e.framesDecoded),r.bytes=Number(e.bytesReceived),r.packets=Number(e.packetsReceived),r.packetsLost=Number(e.packetsLost),r.ssrc=Number(e.ssrc),r.packets>0&&!this.isFirstVideoReceived[r.ssrc]&&(this.onFirstVideoReceived&&this.onFirstVideoReceived(r.ssrc),this.isFirstVideoReceived[r.ssrc]=!0),r.framesDecodeCount>0&&!this.isFirstVideoDecoded[r.ssrc]&&(this.onFirstVideoDecoded&&this.onFirstVideoDecoded(r.ssrc,r.decodedFrame.width,r.decodedFrame.height),this.isFirstVideoDecoded[r.ssrc]=!0),s){const o=s.stats,a=Date.now()-s.lts;r.framesDecodeFreezeTime=o.framesDecodeFreezeTime,r.framesDecodeInterval=o.framesDecodeInterval,r.framesDecodeCount>o.framesDecodeCount&&this.isFirstVideoDecoded[r.ssrc]?(s.lts=Date.now(),r.framesDecodeInterval=a,r.framesDecodeInterval>=this.options.freezeRateLimit&&(this.getVideoIsReady(parseInt(e.ssrc,10))?r.framesDecodeFreezeTime+=r.framesDecodeInterval:this.setVideoIsReady2(parseInt(e.ssrc,10),!0))):r.framesDecodeCount<s.stats.framesDecodeCount&&(r.framesDecodeInterval=0)}this.lastDecodeVideoReceiverStats.set(r.ssrc,{stats:nt({},r),lts:Date.now()}),this._stats.videoRecv.push(r);break}case"audio_recv":{const r=$r(ZO);r.codec=e.googCodecName,r.outputLevel=Math.abs(Number(e.audioOutputLevel))/32767,r.decodingCNG=Number(e.googDecodingCNG),r.decodingCTN=Number(e.googDecodingCTN),r.decodingCTSG=Number(e.googDecodingCTSG),r.decodingNormal=Number(e.googDecodingNormal),r.decodingPLC=Number(e.googDecodingPLC),r.decodingPLCCNG=Number(e.googDecodingPLCCNG),r.expandRate=Number(e.googExpandRate),r.accelerateRate=Number(e.googAccelerateRate),r.preemptiveExpandRate=Number(e.googPreemptiveExpandRate),r.secondaryDecodedRate=Number(e.googSecondaryDecodedRate),r.speechExpandRate=Number(e.googSpeechExpandRate),r.preferredJitterBufferMs=Number(e.googPreferredJitterBufferMs),r.jitterBufferMs=Number(e.googJitterBufferMs),r.jitterMs=Number(e.googJitterReceived),r.bytes=Number(e.bytesReceived),r.packets=Number(e.packetsReceived),r.packetsLost=Number(e.packetsLost),r.ssrc=Number(e.ssrc),r.receivedFrames=Number(e.googDecodingCTN)||Number(e.packetsReceived),r.droppedFrames=Number(e.googDecodingPLC)+Number(e.googDecodingPLCCNG)||Number(e.packetsLost),r.receivedFrames>0&&!this.isFirstAudioReceived[r.ssrc]&&(this.onFirstAudioReceived&&this.onFirstAudioReceived(r.ssrc),this.isFirstAudioReceived[r.ssrc]=!0),r.decodingNormal>0&&!this.isFirstAudioDecoded[r.ssrc]&&(this.onFirstAudioDecoded&&this.onFirstAudioDecoded(r.ssrc),this.isFirstAudioDecoded[r.ssrc]=!0),this._stats.audioRecv.push(r);break}case"audio_send":{const r=$r(QO);r.codec=e.googCodecName,r.inputLevel=Math.abs(Number(e.audioInputLevel))/32767,r.aecReturnLoss=Number(e.googEchoCancellationReturnLoss||0),r.aecReturnLossEnhancement=Number(e.googEchoCancellationReturnLossEnhancement||0),r.residualEchoLikelihood=Number(e.googResidualEchoLikelihood||0),r.residualEchoLikelihoodRecentMax=Number(e.googResidualEchoLikelihoodRecentMax||0),r.bytes=Number(e.bytesSent),r.packets=Number(e.packetsSent),r.packetsLost=Number(e.packetsLost),r.ssrc=Number(e.ssrc),r.rttMs=Number(e.googRtt||0),this._stats.rtt=r.rttMs,this._stats.audioSend.push(r);break}}}))}_getStats(){return new st(((t,e)=>{this.pc.getStats(t,e)}))}statsResponsesToObjects(t){const e=[];return t.result().forEach((n=>{const i={id:n.id,timestamp:n.timestamp.valueOf().toString(),type:n.type};n.names().forEach((r=>{i[r]=n.stat(r)})),e.push(i)})),e}},Cd=(function(t){return t.BANDWIDTH="bandwidth",t.CPU="cpu",t.NONE="none",t.OTHER="other",t})({}),zp=(function(t){return t.L1T1="L1T1",t.L1T2="L1T2",t.L1T3="L1T3",t.L1T3_KEY="L1T3_KEY",t.L2T1_KEY="L2T1_KEY",t.L2T2_KEY="L2T2_KEY",t.L2T3_KEY="L2T3_KEY",t.L3T1_KEY="L3T1_KEY",t.L3T2_KEY="L3T2_KEY",t.L3T3_KEY="L3T3_KEY",t})({}),aS=(function(t){return t[t.new=0]="new",t[t.connecting=1]="connecting",t[t.connected=2]="connected",t[t.disconnected=3]="disconnected",t[t.failed=4]="failed",t[t.closed=5]="closed",t})({}),lr=(function(t){return t.CERTIFICATE="certificate",t.CODEC="codec",t.CANDIDATE_PAIR="candidate-pair",t.LOCAL_CANDIDATE="local-candidate",t.REMOTE_CANDIDATE="remote-candidate",t.INBOUND="inbound-rtp",t.TRACK="track",t.OUTBOUND="outbound-rtp",t.PC="peer-connection",t.REMOTE_INBOUND="remote-inbound-rtp",t.REMOTE_OUTBOUND="remote-outbound-rtp",t.TRANSPORT="transport",t.CSRC="csrc",t.DATA_CHANNEL="data-channel",t.STREAM="stream",t.SENDER="sender",t.RECEIVER="receiver",t})({});var yd=(function(t){return t[t.kNone=1]="kNone",t[t.kMillisecondsFromSeconds=1e3]="kMillisecondsFromSeconds",t[t.kBytesToBits=8]="kBytesToBits",t})(yd||{});function au(t,e,n,i){let r=arguments.length>4&&arguments[4]!==void 0?arguments[4]:yd.kNone;if(!e)return;const s=Number(e[n]);if(typeof s!="number")return;const o=Number(e[i]);if(typeof o!="number")return;if(!t)return o?s/o*r:void 0;const a=Number(t[n]);if(typeof a!="number")return;const c=Number(t[i]);if(typeof c!="number")return;const d=o-c;return d?(s-a)/d*r:void 0}let $O=class extends oS{constructor(){super(...arguments),Ut(this,"_stats",ou),Ut(this,"report",void 0),Ut(this,"lastDecodeVideoReceiverStats",new Map),Ut(this,"lastVideoFramesRecv",new Map),Ut(this,"lastVideoFramesSent",new Map),Ut(this,"lastVideoFramesDecode",new Map),Ut(this,"lastVideoFramesOutput",new Map),Ut(this,"lastVideoJBDelay",new Map),Ut(this,"lastAudioJBDelay",new Map),Ut(this,"mediaBytesSent",new Map),Ut(this,"mediaBytesRetransmit",new Map),Ut(this,"mediaBytesTargetEncode",new Map),Ut(this,"lastDecodeAudioReceiverStats",new Map),Ut(this,"lastAudioConcealment",new Map),Ut(this,"lastEncoderMs",new Map)}async updateStats(){this.report=await this.pc.getStats(),this._stats=$r(ou),this.report.forEach((t=>{switch(t.type){case lr.OUTBOUND:case lr.INBOUND:{const e=t.mediaType||t.kind,n=!e&&"frameWidth"in t,i=!e&&!("frameWidth"in t);t.type===lr.OUTBOUND?e==="audio"||i?this.processAudioOutboundStats(t):(e==="video"||n)&&this.processVideoOutboundStats(t):t.type===lr.INBOUND&&(e==="audio"||i?this.processAudioInboundStats(t):(e==="video"||n)&&this.processVideoInboundStats(t));break}case lr.TRANSPORT:{this.processTransportStats(t);const e=this.report.get(t.selectedCandidatePairId);e&&this.processCandidatePairStats(e);break}case lr.CANDIDATE_PAIR:t.selected&&this.processCandidatePairStats(t)}})),this.updateSendBitrate(),this._stats.updateInterval=Date.now()-this.stats.timestamp,this._stats.timestamp=Date.now(),this.calcLossRate(this._stats),this.stats=this._stats}async getSelectedCandidatePair(){const t=await this.pc.getStats(),e={local:nt({},ts),remote:nt({},ts)};return t.forEach((n=>{let i;if(n.type===lr.TRANSPORT&&(i=t.get(n.selectedCandidatePairId)),n.type===lr.CANDIDATE_PAIR&&n.selected&&(i=n),i){const r=(s,o)=>{s.type=o.type,s.id=o.id,o.address&&(s.address=o.address),o.candidateType&&(s.candidateType=o.candidateType),o.port&&(s.port=o.port),o.priority&&(s.priority=o.priority),o.protocol&&(s.protocol=o.protocol),o.relayProtocol&&(s.relayProtocol=o.relayProtocol)};if(i.localCandidateId){const s=t.get(i.localCandidateId);s&&r(e.local,s)}if(i.remoteCandidateId){const s=t.get(i.remoteCandidateId);s&&r(e.remote,s)}}})),e}processCandidatePairStats(t){if(this._stats.sendBandwidth=t.availableOutgoingBitrate||0,t.currentRoundTripTime&&(this._stats.rtt=1e3*t.currentRoundTripTime),this._stats.videoSend.forEach((e=>{t.currentRoundTripTime&&(e.rttMs=1e3*t.currentRoundTripTime)})),this._stats.audioSend.forEach((e=>{t.currentRoundTripTime&&(e.rttMs=1e3*t.currentRoundTripTime)})),this._stats.selectedCandidatePair.id=t.id,t.localCandidateId){const e=this.report.get(t.localCandidateId);e&&this.processCandidateStats(e)}if(t.remoteCandidateId){const e=this.report.get(t.remoteCandidateId);e&&this.processCandidateStats(e)}}processCandidateStats(t){let e;t.type===lr.LOCAL_CANDIDATE&&(e=this._stats.selectedCandidatePair.localCandidate),t.type===lr.REMOTE_CANDIDATE&&(e=this._stats.selectedCandidatePair.remoteCandidate),e&&(e.type=t.type,e.id=t.id,t.address&&(e.address=t.address),t.candidateType&&(e.candidateType=t.candidateType),t.port&&(e.port=t.port),t.priority&&(e.priority=t.priority),t.protocol&&(e.protocol=t.protocol),t.relayProtocol&&(e.relayProtocol=t.relayProtocol),t.type===lr.LOCAL_CANDIDATE&&this.stats.selectedCandidatePair.localCandidate.id!==e.id&&this.onSelectedLocalCandidateChanged&&this.onSelectedLocalCandidateChanged(nt({},e),nt({},this.stats.selectedCandidatePair.localCandidate)),t.type===lr.REMOTE_CANDIDATE&&this.stats.selectedCandidatePair.remoteCandidate.id!==e.id&&this.onSelectedRemoteCandidateChanged&&this.onSelectedRemoteCandidateChanged(nt({},e),nt({},this.stats.selectedCandidatePair.remoteCandidate)))}processAudioInboundStats(t){let e=this._stats.audioRecv.find((i=>i.ssrc===t.ssrc));e||(e=$r(ZO),this._stats.audioRecv.push(e)),e.ssrc=t.ssrc,e.packets=t.packetsReceived,e.packetsLost=t.packetsLost,e.packetsDiscarded=t.packetsDiscarded,e.bytes=t.bytesReceived,e.jitterMs=1e3*t.jitter,e.retransmittedBytesReceived=t.retransmittedBytesReceived,e.retransmittedPacketsReceived=t.retransmittedPacketsReceived,e.totalProcessingDelay=t.totalProcessingDelay,e.jitterBufferEmittedCount=t.jitterBufferEmittedCount,e.estimatedPlayoutTimestamp=t.estimatedPlayoutTimestamp;const n=this.lastDecodeAudioReceiverStats.get(e.ssrc);e.avgProcessingDelayMs=au(n,e,"totalProcessingDelay","jitterBufferEmittedCount",yd.kMillisecondsFromSeconds),this.processAudioTrackReceiverStats(t,t.trackId,e),this.calculateAudioFreeze(e,n,t),t.codecId&&(e.codec=this.getCodecFromCodecStats(t.codecId)),e.receivedFrames||(e.receivedFrames=t.packetsReceived),e.droppedFrames||(e.droppedFrames=t.packetsLost),e.receivedFrames>0&&!this.isFirstAudioReceived[e.ssrc]&&(this.onFirstAudioReceived&&this.onFirstAudioReceived(e.ssrc),this.isFirstAudioReceived[e.ssrc]=!0),e.outputLevel&&e.outputLevel>0&&!this.isFirstAudioDecoded[e.ssrc]&&(this.onFirstAudioDecoded&&this.onFirstAudioDecoded(e.ssrc),this.isFirstAudioDecoded[e.ssrc]=!0),typeof t.concealedSamples=="number"&&(e.concealedSamples=t.concealedSamples),this.lastDecodeAudioReceiverStats.set(e.ssrc,nt({},e))}calculateAudioFreeze(t,e,n){const i=this.lastAudioConcealment.get(t.ssrc);if(e!=null&&i!=null){const r=i.lts,s=n.timestamp,o=s-r;if(o<=0)return;const a=t.concealedSamples-e.concealedSamples-0,c=i.nonSilent+a,d=t.totalSamplesReceived-e.totalSamplesReceived;if(d<=0)return;const l=80*d/o,h=200*d/o,p=o/d;let f=0;t.freezeSamples80=e.freezeSamples80,t.freezeMs80=e.freezeMs80,c>l&&(i.plc80>0?(t.freezeSamples80+=a,t.freezeMs80+=Math.round(a*p)):(t.freezeSamples80+=c,t.freezeMs80+=Math.round(c*p)),f=i.plc80+1);let v=0;t.freezeSamples200=e.freezeSamples200,t.freezeMs200=e.freezeMs200,c>h&&(i.plc200>0?(t.freezeSamples200+=a,t.freezeMs200+=Math.round(a*p)):(t.freezeSamples200+=c,t.freezeMs200+=Math.round(c*p)),v=i.plc200+1),this.lastAudioConcealment.set(t.ssrc,{nonSilent:a,lts:s,plc80:f,plc200:v})}else t.freezeSamples80=0,t.freezeSamples200=0,t.freezeMs80=0,t.freezeMs200=0,this.lastAudioConcealment.set(t.ssrc,{nonSilent:0,lts:n.timestamp,plc80:0,plc200:0})}processVideoInboundStats(t){let e=this._stats.videoRecv.find((o=>o.ssrc===t.ssrc));e||(e=$r(XO),this._stats.videoRecv.push(e)),e.ssrc=t.ssrc,e.packets=t.packetsReceived,e.packetsLost=t.packetsLost,e.bytes=t.bytesReceived,e.firsCount=t.firCount,e.nacksCount=t.nackCount,e.plisCount=t.pliCount,e.framesDecodeCount=t.framesDecoded,e.framesDroppedCount=t.framesDropped,e.totalInterFrameDelay=t.totalInterFrameDelay,e.totalSquaredInterFrameDelay=t.totalSquaredInterFrameDelay,e.totalFreezesDuration=t.totalFreezesDuration,e.totalProcessingDelay=t.totalProcessingDelay,e.packetsDiscarded=t.packetsDiscarded,e.framesAssembledFromMultiplePackets=t.framesAssembledFromMultiplePackets,e.totalAssemblyTime=t.totalAssemblyTime,e.keyFramesDecoded=t.keyFramesDecoded,e.retransmittedBytesReceived=t.retransmittedBytesReceived,e.retransmittedPacketsReceived=t.retransmittedPacketsReceived,e.estimatedPlayoutTimestamp=t.estimatedPlayoutTimestamp;const n=this.lastDecodeVideoReceiverStats.get(e.ssrc),i=this.lastVideoFramesDecode.get(e.ssrc),r=this.lastVideoFramesOutput.get(e.ssrc),s=Date.now();if(e.framesDecodeCount>0&&!this.isFirstVideoDecoded[e.ssrc]){const o=e.decodedFrame?e.decodedFrame.width:0,a=e.decodedFrame?e.decodedFrame.height:0;this.onFirstVideoDecoded&&this.onFirstVideoDecoded(e.ssrc,o,a),this.isFirstVideoDecoded[e.ssrc]=!0}if(n){const o=n.stats,a=s-n.lts;e.framesDecodeFreezeTime=o.framesDecodeFreezeTime,e.framesDecodeInterval=o.framesDecodeInterval,!this.isFirstVideoDecoded[e.ssrc]&&a>this.options.firstVideoDecodedTimeout&&!this.isFirstVideoDecodedTimeout[e.ssrc]&&(this.onFirstVideoDecodedTimeout&&this.onFirstVideoDecodedTimeout(e.ssrc),this.isFirstVideoDecodedTimeout[e.ssrc]=!0),e.framesDecodeCount>o.framesDecodeCount&&this.isFirstVideoDecoded[e.ssrc]?(n.lts=Date.now(),e.framesDecodeInterval=a,e.framesDecodeInterval>=this.options.freezeRateLimit&&(this.getVideoIsReady(parseInt(t.ssrc))?e.framesDecodeFreezeTime+=e.framesDecodeInterval:this.setVideoIsReady2(parseInt(t.ssrc,10),!0))):e.framesDecodeCount<o.framesDecodeCount&&(e.framesDecodeInterval=0),t.framesDecoded&&t.qpSum&&(n.stats.framesDecodeCount>t.framesDecoded?e.qpSumPerFrame=t.qpSum/t.framesDecoded:e.qpSumPerFrame=(t.qpSum-n.qpSum)/(t.framesDecoded-n.stats.framesDecodeCount))}t.totalDecodeTime&&(e.decodeMs=1e3*t.totalDecodeTime,e.avgDecodeMs=au(n?.stats,e,"decodeMs","framesDecodeCount")),e.avgProcessingDelayMs=au(n?.stats,e,"totalProcessingDelay","framesDecodeCount",yd.kMillisecondsFromSeconds),e.avgFramesAssembledFromMultiplePacketsMs=au(n?.stats,e,"totalAssemblyTime","framesAssembledFromMultiplePackets",yd.kMillisecondsFromSeconds),e.avgInterFrameDelayMs=au(n?.stats,e,"totalInterFrameDelay","framesDecodeCount",yd.kMillisecondsFromSeconds),i&&s-i.lts>=800?(e.decodeFrameRate=Math.round((e.framesDecodeCount-i.count)/((s-i.lts)/1e3)),this.lastVideoFramesDecode.set(e.ssrc,{count:e.framesDecodeCount,lts:s,rate:e.decodeFrameRate})):i?e.decodeFrameRate=i.rate:this.lastVideoFramesDecode.set(e.ssrc,{count:e.framesDecodeCount,lts:s,rate:0}),e.framesDroppedCount&&t.framesReceived&&(r&&s-r.lts>=800?(e.outputFrameRate=Math.round((t.framesReceived-e.framesDroppedCount-r.count)/((s-r.lts)/1e3)),this.lastVideoFramesOutput.set(e.ssrc,{count:t.framesReceived-e.framesDroppedCount,lts:s,rate:Math.max(e.outputFrameRate,0)})):r?e.outputFrameRate=r.rate:this.lastVideoFramesOutput.set(e.ssrc,{count:t.framesReceived-e.framesDroppedCount,lts:s,rate:0})),this.processVideoTrackReceiverStats(t,t.trackId,e),t.codecId&&(e.codec=this.getCodecFromCodecStats(t.codecId)),t.framerateMean&&(e.framesRateFirefox=t.framerateMean),e.packets>0&&!this.isFirstVideoReceived[e.ssrc]&&(this.onFirstVideoReceived&&this.onFirstVideoReceived(e.ssrc),this.isFirstVideoReceived[e.ssrc]=!0),this.lastDecodeVideoReceiverStats.set(e.ssrc,{stats:nt({},e),lts:n?n.lts:Date.now(),qpSum:t.qpSum})}processVideoOutboundStats(t){let e=this._stats.videoSend.find((i=>i.ssrc===t.ssrc));e||(e=$r(JO),this._stats.videoSend.push(e));const n=this.mediaBytesSent.get(t.ssrc);if(n)n.add(t.bytesSent);else{const i=new sS(10);i.add(t.bytesSent),this.mediaBytesSent.set(t.ssrc,i)}if(t.retransmittedBytesSent!==void 0){const i=this.mediaBytesRetransmit.get(t.ssrc);if(i)i.add(t.retransmittedBytesSent);else{const r=new sS(10);r.add(t.retransmittedBytesSent),this.mediaBytesRetransmit.set(t.ssrc,r)}}if(t.totalEncodedBytesTarget){const i=this.mediaBytesTargetEncode.get(t.ssrc);if(i)i.add(t.totalEncodedBytesTarget);else{const r=new sS(10);r.add(t.totalEncodedBytesTarget),this.mediaBytesTargetEncode.set(t.ssrc,r)}}if(e.ssrc=t.ssrc,e.bytes=t.bytesSent,e.packets=t.packetsSent,e.firsCount=t.firCount,e.nacksCount=t.nackCount,e.plisCount=t.pliCount,e.frameCount=t.framesEncoded,e.adaptionChangeReason=t.qualityLimitationReason,e.scalabilityMode=t.scalabilityMode,e.retransmittedBytesSent=t.retransmittedBytesSent,e.retransmittedPacketsSent=t.retransmittedPacketsSent,e.hugeFramesSent=t.hugeFramesSent,e.keyFramesEncoded=t.keyFramesEncoded,e.targetBitrate=t.targetBitrate,t.totalEncodeTime&&t.framesEncoded){const i=this.lastEncoderMs.get(t.ssrc);if(!i||i.lastFrameCount>t.framesEncoded)e.avgEncodeMs=1e3*t.totalEncodeTime/t.framesEncoded;else{const r=t.framesEncoded-i.lastFrameCount,s=t.totalEncodeTime-i.lastEncoderTime;e.avgEncodeMs=1e3*s/r}}if(t.framesEncoded&&t.qpSum){const i=this.lastEncoderMs.get(t.ssrc);!i||i.lastFrameCount>t.framesEncoded?e.qpSumPerFrame=t.qpSum/t.framesEncoded:e.qpSumPerFrame=(t.qpSum-i.lastQpSum)/(t.framesEncoded-i.lastFrameCount)}if(this.lastEncoderMs.set(t.ssrc,{lastFrameCount:t.framesEncoded,lastEncoderTime:t.totalEncodeTime,lastQpSum:t.qpSum,lts:Date.now()}),t.codecId&&(e.codec=this.getCodecFromCodecStats(t.codecId)),t.mediaSourceId&&this.processVideoMediaSource(t.mediaSourceId,e),this.processVideoTrackSenderStats(t,t.trackId,e),t.remoteId)this.processRemoteInboundStats(t.remoteId,e);else{const i=this.findRemoteStatsId(t.ssrc,lr.REMOTE_INBOUND);i&&this.processRemoteInboundStats(i,e)}}processAudioOutboundStats(t){let e=this._stats.audioSend.find((n=>n.ssrc===t.ssrc));if(e||(e=$r(QO),this._stats.audioSend.push(e)),e.ssrc=t.ssrc,e.packets=t.packetsSent,e.bytes=t.bytesSent,e.retransmittedBytesSent=t.retransmittedBytesSent,e.retransmittedPacketsSent=t.retransmittedPacketsSent,t.mediaSourceId&&this.processAudioMediaSource(t.mediaSourceId,e),t.codecId&&(e.codec=this.getCodecFromCodecStats(t.codecId)),this.processAudioTrackSenderStats(t,t.trackId,e),t.remoteId)this.processRemoteInboundStats(t.remoteId,e);else{const n=this.findRemoteStatsId(t.ssrc,lr.REMOTE_INBOUND);n&&this.processRemoteInboundStats(n,e)}}processTransportStats(t){this._stats.transport.bytesReceived=t.bytesReceived||this._stats.transport.bytesReceived,this._stats.transport.bytesSent=t.bytesSent||this._stats.transport.bytesSent,this._stats.transport.packetsReceived=t.packetsReceived||this._stats.transport.packetsReceived,this._stats.transport.packetsSent=t.packetsSent||this._stats.transport.packetsSent}findRemoteStatsId(t,e){var n;const i=Array.from(qi(n=this.report).call(n)).find((r=>r.type===e&&r.ssrc===t));return i?i.id:null}processVideoMediaSource(t,e){const n=this.report.get(t);n&&n.width&&n.height&&n.framesPerSecond&&(e.inputFrame={width:n.width,height:n.height,frameRate:n.framesPerSecond})}processAudioMediaSource(t,e){const n=this.report.get(t);n&&(e.inputLevel=n.audioLevel)}processVideoTrackSenderStats(t,e,n){var i,r,s,o;const a=e?this.report.get(e):void 0,c=(i=a?.framesSent)!==null&&i!==void 0?i:t.framesSent;if(typeof c!="number")return;let d=(r=a?.frameWidth)!==null&&r!==void 0?r:t.frameWidth,l=(s=a?.frameHeight)!==null&&s!==void 0?s:t.frameHeight,h=(o=a?.framesPerSecond)!==null&&o!==void 0?o:t.framesPerSecond;if(typeof d=="number"&&typeof l=="number"||(d=0,l=0),h==null){const p=Date.now(),f=this.lastVideoFramesSent.get(n.ssrc);f&&p-f.lts>=800?(h=Math.round((c-f.count)/((p-f.lts)/1e3)),this.lastVideoFramesSent.set(n.ssrc,{count:c,lts:p,rate:h})):f?h=f.rate:this.lastVideoFramesSent.set(n.ssrc,{count:c,lts:p,rate:0})}n.sentFrame={width:d,height:l,frameRate:Math.max(0,h)}}processVideoTrackReceiverStats(t,e,n){var i,r,s,o,a;const c=e?this.report.get(e):void 0,d=(i=c?.framesReceived)!==null&&i!==void 0?i:t.framesReceived,l=(r=c?.frameWidth)!==null&&r!==void 0?r:t.frameWidth,h=(s=c?.frameHeight)!==null&&s!==void 0?s:t.frameHeight,p=(o=c?.jitterBufferDelay)!==null&&o!==void 0?o:t.jitterBufferDelay,f=(a=c?.jitterBufferEmittedCount)!==null&&a!==void 0?a:t.jitterBufferEmittedCount;if(typeof d=="number"){const v=this.lastVideoFramesRecv.get(n.ssrc),S=Date.now();n.framesReceivedCount=d;let T=0;v&&S-v.lts>=800?(T=Math.round((d-v.count)/((S-v.lts)/1e3)),this.lastVideoFramesRecv.set(n.ssrc,{count:d,lts:S,rate:T})):v?T=v.rate:this.lastVideoFramesRecv.set(n.ssrc,{count:d,lts:S,rate:0}),n.receivedFrame={width:l||0,height:h||0,frameRate:T||0},n.decodedFrame={width:l||0,height:h||0,frameRate:n.decodeFrameRate||0},n.outputFrame={width:l||0,height:h||0,frameRate:n.outputFrameRate||n.decodeFrameRate||0}}if(p&&f){const v=this.lastVideoJBDelay.get(n.ssrc)||{jitterBufferDelay:0,jitterBufferEmittedCount:0,jitterBufferMs:0};let S=v.jitterBufferMs;const T=f-v.jitterBufferEmittedCount;T>0&&(S=1e3*(p-v.jitterBufferDelay)/T),n.jitterBufferMs=S,n.currentDelayMs=Math.round(S),this.lastVideoJBDelay.set(n.ssrc,{jitterBufferDelay:p,jitterBufferEmittedCount:f,jitterBufferMs:n.currentDelayMs})}}processAudioTrackSenderStats(t,e,n){var i,r,s,o;const a=e?this.report.get(e):void 0,c=(i=(r=a?.echoReturnLoss)!==null&&r!==void 0?r:t.echoReturnLoss)!==null&&i!==void 0?i:0,d=(s=(o=a?.echoReturnLossEnhancement)!==null&&o!==void 0?o:t.echoReturnLossEnhancement)!==null&&s!==void 0?s:0;n.aecReturnLoss=c,n.aecReturnLossEnhancement=d}processAudioTrackReceiverStats(t,e,n){var i,r,s,o,a,c,d,l,h;const p=e?this.report.get(e):void 0,f=(i=p?.removedSamplesForAcceleration)!==null&&i!==void 0?i:t.removedSamplesForAcceleration,v=(r=p?.totalSamplesReceived)!==null&&r!==void 0?r:t.totalSamplesReceived,S=(s=p?.jitterBufferDelay)!==null&&s!==void 0?s:t.jitterBufferDelay,T=(o=p?.jitterBufferEmittedCount)!==null&&o!==void 0?o:t.jitterBufferEmittedCount,b=(a=p?.audioLevel)!==null&&a!==void 0?a:t?.audioLevel,w=(c=p?.totalSamplesDuration)!==null&&c!==void 0?c:t?.totalSamplesDuration,D=(d=p?.concealedSamples)!==null&&d!==void 0?d:t.concealedSamples,k=(l=p?.silentConcealedSamples)!==null&&l!==void 0?l:t.silentConcealedSamples,U=(h=p?.concealmentEvents)!==null&&h!==void 0?h:t.concealmentEvents;if(typeof v=="number"&&(n.totalSamplesReceived=v),typeof k=="number"&&(n.silentConcealedSamples=k),typeof U=="number"&&(n.concealmentEvents=U),typeof D=="number"&&(n.concealedSamples=D),f&&v&&(n.accelerateRate=f/v),S&&T){const x=this.lastAudioJBDelay.get(n.ssrc)||{jitterBufferDelay:0,jitterBufferEmittedCount:0,jitterBufferMs:0};let q=x.jitterBufferMs;const Q=T-x.jitterBufferEmittedCount;Q>0&&(q=1e3*(S-x.jitterBufferDelay)/Q),n.jitterBufferMs=Math.round(q),this.lastAudioJBDelay.set(n.ssrc,{jitterBufferDelay:S,jitterBufferEmittedCount:T,jitterBufferMs:n.jitterBufferMs})}n.outputLevel=b;let P=1920;w&&v&&(P=v/w/50,n.receivedFrames=Math.round(v/P)),D&&(n.droppedFrames=Math.round(D/P))}processRemoteInboundStats(t,e){const n=this.report.get(t);n&&(e.packetsLost=n.packetsLost,n.roundTripTime&&(e.rttMs=1e3*n.roundTripTime),n.jitter&&(e.jitterMs=1e3*n.jitter),n.timestamp&&(e.timestamp=n.timestamp))}getCodecFromCodecStats(t){const e=this.report.get(t);if(!e)return"";const n=e.mimeType.match(/\/(.*)$/);return n&&n[1]?n[1]:""}updateSendBitrate(){let t=0,e=null,n=null;this.mediaBytesSent.forEach((r=>{t+=r.diffMean()})),this.mediaBytesRetransmit.forEach((r=>{e=e===null?r.diffMean():e+r.diffMean()})),this.mediaBytesTargetEncode.forEach((r=>{n=n===null?r.diffMean():n+r.diffMean()}));const i=e!==null?t-e:t;this._stats.bitrate={actualEncoded:8*i/(this.options.updateInterval/1e3),transmit:8*t/(this.options.updateInterval/1e3)},e!==null&&(this._stats.bitrate.retransmit=8*e/(this.options.updateInterval/1e3)),n!==null&&(this._stats.bitrate.targetEncoded=8*n/(this.options.updateInterval/1e3))}},s8=class extends oS{updateStats(){return st.resolve()}};function Xp(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:250,n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:8,i=arguments.length>3&&arguments[3]!==void 0?arguments[3]:500,r=arguments.length>4&&arguments[4]!==void 0?arguments[4]:1e4;const s=(function(){const o=navigator.userAgent.toLocaleLowerCase().match(/chrome\/[\d]*/i);return o&&o[0]?Number(o[0].split("/")[1]):null})();return s?s<76?new r8(t,{updateInterval:e,lossRateInterval:n,freezeRateLimit:i,firstVideoDecodedTimeout:r}):new $O(t,{updateInterval:e,lossRateInterval:n,freezeRateLimit:i,firstVideoDecodedTimeout:r}):(function(o){if(!window.RTCStatsReport)return!1;const a=o.getStats();return!!(a instanceof st||(function(c){return!!c&&(typeof c=="object"||typeof c=="function")&&typeof c.then=="function"})(a))})(t)?new $O(t,{updateInterval:e,lossRateInterval:n,freezeRateLimit:i,firstVideoDecodedTimeout:r}):new s8(t,{updateInterval:e,lossRateInterval:n,freezeRateLimit:i,firstVideoDecodedTimeout:r})}const t0="websdk_ng_install_id";function cS(){try{if(I("INSTALL_ID"))return I("INSTALL_ID");let t=window.localStorage.getItem(t0);return t||(t=ec(),window.localStorage.setItem(t0,t)),ye("INSTALL_ID",t),t}catch{return}}const Ar=(function(t){if(t.match(/[0-9]+\.[0-9]+\.[0-9]+$/))return t;const e=t.match(/([0-9]+\.[0-9]+\.[0-9]+)\-([0-9]+)/);if(e&&e[1]&&e[2]){const n=e[1],i=e[2];return"".concat(n,".").concat(i)}return"4.0.0.999"})("4.24.1"),dS=(function(){try{return JSON.parse("true")===!0}catch{return!0}})();let nc=(function(t){return t.Default="default",t.Auto="auto",t.Relay="relay",t.SdRtn="sd-rtn",t})({});const Jn=(function(){const t="us".concat("erna","me"),e="pa".concat("sswo","rd"),n=["t","s","t"];n.splice(1,0,"e");const i=n.join(""),r=[];for(let a=0;a<6;a++)r.push("1");const s=r.join(""),o={};return o[t]=i,o[e]=s,Object.assign(o,{turnServerURL:"",tcpport:3433,udpport:3478,forceturn:!1})})();window.DEFAULT_TURN_CONFIG=Jn;const Jp={ENABLE_PUBLISHED_USER_LIST:!0,MAX_SUBSCRIPTION:50,SUBSCRIBE_AUDIO_FILTER_TOPN:void 0,ENABLE_PUBLISH_AUDIO_FILTER:void 0,ENABLE_USER_LICENSE_CHECK:!0,DISABLE_FEC:void 0,ENABLE_NTP_REPORT:!1,ENABLE_INSTANT_VIDEO:!1,ENABLE_USER_AUTO_REBALANCE_CHECK:!0,ENABLE_LOSSBASED_BWE:!0,ENABLE_AUT_CC:!0,FORCE_ENABLE_AUT_CC:!1,ENABLE_CC_FALLBACK:void 0,SUBSCRIBE_TWCC:!0,PUBLISH_TWCC:!1,ENABLE_SVC_DEFAULT_CODECS:["H264","VP8","VP9","AV1"],SVC:[],ENABLE_FULL_LINK_AV_SYNC:!1,SVC_MODE:null,PRE_SUB_NUM:1,ENABLE_AUT_FEEDBACK:!0,SVC_EXTENDED:["VP9"]},lS={MIN_FRAME_RATE:1,MAX_FRAME_RATE:30,MAX_THRESHOLD_FRAMERATE:30,BITRATE_MIN_THRESHOLD:100,BITRATE_MAX_THRESHOLD:100,MAX_SCALE:5,BWE_SCALE_UP_THRESHOLD:.6,BWE_SCALE_DOWN_THRESHOLD:.6,PERF_SCALE_UP_THRESHOLD:.7,PERF_SCALE_DOWN_THRESHOLD:.6,MOTION_RESOLUTION_FACTOR:.8,MOTION_BITRATE_FACTOR:.6,DETAIL_FRAMERATE_FACTOR:.8,DETAIL_BITRATE_FACTOR:.6,BALANCE_RESOLUTION_FACTOR:.9,BALANCE_FRAMERATE_FACTOR:.9,BALANCE_BITRATE_FACTOR:.6,OVERUSE_TIMES_THRESHOLD:10,UNDERUSE_TIMES_THRESHOLD:40},uS="v4.24.1-0-g2cff7c6c-dirty(11/18/2025, 5:40:47 PM)",hS={ENABLE_EVENT_REPORT:!0,UPLOAD_LOG:!1,ENABLE_AG_ADAPTATION:!0,FORCE_AG_HIGH_FRAMERATE:!1,FORCE_SUPPORT_AG_ADAPTATION:!1,ENCODER_CONFIG_LIMIT:{},CAMERA_CAPTURE_CONFIG:void 0,ENABLE_PRELOAD:!0,NEW_ICE_RESTART:!0,ICE_RESTART_INTERVAL:1e4,RESTART_SEQUENCE:["udp_tcp_relay","relay"],FIRST_TCP_CANDIDATE:!1,FIRST_TCP_CANDIDATE_INTERVAL:1e3,TURN_DOMAIN:"edge.agora.io",TURN_DOMAINS:["edge.agora.io"],USE_TURN_IP:!0,NEW_TURN_MODE:4,NEW_FORCE_TURN:!1,USE_NEW_RENDER_FREEZE_TIME:!1,FLS_FALLBACK_TIMEOUT:3e4,RTE_DETAIL_REPORT_INTERVAL:6e4,ENCODE_EXCEPTION_TIMES:5,ENABLE_ENCODE_EXCEPTION:!0,ENCODE_EXCEPTION_VALIDATE_CODEC:["h264"],VIDEO_ENCODER_CONFIG_LIST:[{width:240,height:180},{width:320,height:240},{width:400,height:300},{width:480,height:360},{width:560,height:420},{width:640,height:480}],DELETE_NEQ_AFTER_USER_LEAVE:!0,UPDATE_RTP_CAP_IN_HOST:!1,IOS_BG_TAG:!0,IOS_AUTO_RESTART_BG_TAG:!0,IGNORE_UID_CHECK:!1,ENABLE_UP_SPS_PPS:!1,ENABLE_DOWN_SPS_PPS:!1,NO_EDGES_RETRY:!0,BUFFER_READY_FRAMES:3,FLS_SYNC_AV_PLAY_LIMIT:0,FLS_BUFFER_WAIT_TIME:1500,VOS_CONFIGURE:void 0,ENABLE_QUALITY_FALLBACK:!1,QUALITY_FALLBACK_REHEARSAL:!0,ENABLE_FLS_AV1_FIRST:!1,ENABLE_AP_MULTI_IP:!0,FLS_ENABLE_AV1_DETECT:!0,FLS_ENABLE_AV1_DECODE_DETECT:!0},Te=nt(nt(nt(nt({},hS),{},{PROCESS_ID:"",ENCRYPT_AES:!0,AREAS:["CHINA","GLOBAL"],WEBCS_DOMAIN:["webrtc2-ap-web-1.agora.io","webrtc2-2.ap.sd-rtn.com"],WEBCS_DOMAIN_BACKUP_LIST:["webrtc2-ap-web-3.agora.io","webrtc2-4.ap.sd-rtn.com"],PROXY_CS:["ap-proxy-1.agora.io","ap-proxy-2.agora.io"],CDS_AP:["cds-ap-web-1.agora.io","cds-web-2.ap.sd-rtn.com","cds-ap-web-3.agora.io","cds-web-4.ap.sd-rtn.com"],ACCOUNT_REGISTER:["sua-ap-web-1.agora.io","sua-web-2.ap.sd-rtn.com","sua-ap-web-3.agora.io","sua-web-4.ap.sd-rtn.com"],UAP_AP:["uap-ap-web-1.agora.io","uap-web-2.ap.sd-rtn.com","uap-ap-web-3.agora.io","uap-web-4.ap.sd-rtn.com"],LOG_UPLOAD_SERVER:"logservice.agora.io",EVENT_REPORT_DOMAIN:"statscollector-1.agora.io",EVENT_REPORT_BACKUP_DOMAIN:"web-2.statscollector.sd-rtn.com",GATEWAY_ADDRESS:[],GATEWAY_WSS_ADDRESS:"",LIVE_STREAMING_ADDRESS:"",HTTP_CONNECT_TIMEOUT:5e3,SIGNAL_REQUEST_TIMEOUT:1e4,REPORT_STATS:!0,NOT_REPORT_EVENT:[],PING_PONG_TIME_OUT:10,WEBSOCKET_TIMEOUT_MIN:1e4,EVENT_REPORT_SEND_INTERVAL:3e3,CONFIG_DISTRIBUTE_INTERVAL:3e5,ENABLE_CONFIG_DISTRIBUTE:!0,CANDIDATE_TIMEOUT:5e3,SHOW_REPORT_INVOKER_LOG:!1,SHOW_REPORT_USER_INVOKER_LOG:!0,JOIN_EXTEND:"",PUB_EXTEND:"",SUB_EXTEND:"",FORCE_TURN:!1,TURN_ENABLE_TCP:!0,TURN_ENABLE_UDP:!0,MAX_UPLOAD_CACHE:50,UPLOAD_CACHE_INTERVAL:2e3,AJAX_REQUEST_CONCURRENT:3,REPORT_APP_SCENARIO:void 0,GATEWAY_DOMAINS:["edge.agora.io","edge.sd-rtn.com"],CONNECT_GATEWAY_WITHOUT_DOMAIN:!1,WORKER_DOMAIN:"edge.agora.io",EVENT_REPORT_RETRY:!0,CHROME_FORCE_PLAN_B:!1,AUDIO_SOURCE_VOLUME_UPDATE_INTERVAL:400,AUDIO_SOURCE_AVG_VOLUME_DURATION:3e3,AUDIO_VOLUME_INDICATION_INTERVAL:2e3,VOLUME_VOICE_WEIGHT:10,GET_VOLUME_OF_MUTED_AUDIO_TRACK:!1,STATS_UPDATE_INTERVAL:250,NORMAL_EVENT_QUEUE_CAPACITY:100,CUSTOM_REPORT:!0,CUSTOM_REPORT_LIMIT:20,PROXY_SERVER_TYPE2:"webnginx-proxy.agora.io",PROXY_SERVER_TYPE3:["webrtc-cloud-proxy.sd-rtn.com","webrtc-cloud-proxy.agora.io"],CUSTOM_PUB_ANSWER_MODIFIER:null,CUSTOM_SUB_ANSWER_MODIFIER:null,CUSTOM_PUB_OFFER_MODIFIER:null,CUSTOM_SUB_OFFER_MODIFIER:null,DSCP_TYPE:"high",REMOVE_NEW_CODECS:!0,FRAGEMENT_LENGTH:3,WEBSOCKET_COMPRESS:!1,SIMULCAST:!1,CHECK_VIDEO_VISIBLE_INTERVAL:3e4,CHECK_LOCAL_STATS_INTERVAL:250,PROFILE_SWITCH_INTERVAL:2e3,UNSUPPORTED_VIDEO_CODEC:[],ENUMERATE_DEVICES_INTERVAL:!1,ENUMERATE_DEVICES_INTERVAL_TIME:1e4,USE_NEW_TOKEN:!1,CLOSE_AFB_FOR_LOCAL_AP:!0,JOIN_MAX_CONCURRENCY:6,JOIN_WITH_FALLBACK_SIGNAL_PROXY:!0,JOIN_WITH_FALLBACK_MEDIA_PROXY:!0,JOIN_WITH_FALLBACK_MEDIA_PROXY_FORCE:!1,JOIN_GATEWAY_TRY_443PORT_DURATION:2e3,JOIN_GATEWAY_USE_443PORT_ONLY:!1,JOIN_GATEWAY_USE_DUAL_DOMAIN:!0,JOIN_GATEWAY_FALLBACK_PORT:443,USE_TURN_SERVER_OF_GATEWAY:!1,H264_PROFILE_LEVEL_ID:"",USE_NEW_LOG:!1,LOG_VERSION:3,MEDIA_DEVICE_CONSTRAINTS:null,ENCRYPT_PROXY_USERNAME_AND_PSW:!0,SDP_LOGGING:!1,CSP_DETECTED_HOSTNAME_LIST:["agora.io","sd-rtn.com"],REMOTE_AUDIO_TRACK_USES_WEB_AUDIO:!1,LOCAL_AUDIO_TRACK_USES_WEB_AUDIO:!1,BITRATE_ADAPTER_TYPE:"STANDARD_BITRATE",AI_DENOISER_PARAMETERS:{excludedLinks:[]},ADJUST_3A_FROM_PLUGINS:!0,RAISE_H264_BASELINE_PRIORITY:!0,FILTER_SEND_H264_BASELINE:!1,FIRST_H264_PROFILE_LEVEL_ID:"42001f",FIRST_PACKETIZATION_MODE:"",X_GOOGLE_START_BITRATE:void 0,NEW_REPORT_SERVER:!1,NEW_REPORT_SERVER_DOMAINS:["data-reporting.agora.io","data-reporting.agora.io"],VIDEO_INSPECT_WORKER_MESSAGE_LENGTH_LIMIT:3e5,VIDEO_INSPECT_INTERVAL_MINIMUM:1e3,VIDEO_INSPECT_QUALITY_RATIO:.9,VIDEO_INSPECT_WORKER_MANAGER_HOST:"edge.agora.io",VIDEO_INSPECT_WORKER_MANAGER_PORT:"",VIDEO_INSPECT_WORKER_MANAGER_WSS:"",VIDEO_INSPECT_WORKER_PORT:"",SHOW_VIDEO_INSPECT_WORKER_MESSAGE:!1,STATS_COLLECTOR_PORT:443,FORCE_TURN_TCP:!1,WEBAUDIO_INIT_OPTIONS:void 0,FILTER_VIDEO_FEC:!0,FILTER_AUDIO_FEC:!1,CHROME_DUAL_STREAM_USE_ENCODING:!0,DISABLE_DUAL_STREAM_USE_ENCODING:!1,EXTENSION_USAGE_UPLOAD_INTERVAL:1e4,ICE_RESTART:!0,FINGERPRINT:null,ENABLE_VIDEO_FRAME_CALLBACK:!0,VIDEO_FREEZE_DURATION:500,SPATIALIZER_PARAMETERS:{},UPLOAD_LOG_INTERVAL:3e3,UPLOAD_LOG_REQUEST_RETRY_INTERVAL:2e3,UPLOAD_LOG_REQUEST_MAX_RETRY_INTERVAL:2e4,UPLOAD_LOG_TRY_INTERVAL_WHILE_OFF:5e3,UPLOAD_LOG_RETRY_INTERVAL_V1:1e4,UPLOAD_LOG_TWICE_RETRY_INTERVAL_V1:200,UPLOAD_LOG_LENGTH_EACH_TIME:10,APP_TYPE:0,DISABLE_WEBAUDIO:!1,CHANNEL_MEDIA_RELAY_SERVERS:void 0,KEEP_LAST_FRAME:!0,FORWARD_P2P_CREATION:!0,SYNC_GROUP:!0,BLOCK_LOCAL_CLIENT:!1,ENABLE_AUDIO_TOPN:!1,ENABLE_AUDIO_METADATA:!1,ENABLE_AUDIO_PTS:!1,TOPN_SMOOTH_LEVEL:void 0,TOPN_NEW_SPEAKER_DELAY:void 0,TOPN_SWITCH_HOLD_MS:void 0,TOPN_AUDIO_GAIN:void 0,TOPN_SILENCE_THRESHOLD:250,AP_AREA:!0,ENABLE_ENCODED_TRANSFORM:!1,ENABLE_VIDEO_SEI:!1,IMAGE_MODERATION_WORKER_HOST:"edge.agora.io",IMAGE_MODERATION_WORKER_WSS:"",IMAGE_MODERATION_WORKER_MESSAGE_LENGTH_LIMIT:3e5,IMAGE_MODERATION_INTERVAL_MINIMUM:1e3,SHOW_IMAGE_MODERATION_WORKER_MESSAGE:!1,IMAGE_MODERATION_QUALITY_RATIO:.9,IMAGE_MODERATION_UPLOAD_REPORT_INTERVAL:5e3,SHOW_GLOBAL_CLIENT_LIST:!1,DATASTREAM_MAX_RETRANSMITS:10,TCP_CANDIDATE_ONLY:!1,EXTERNAL_SIGNAL_REQUEST_TIMEOUT:3e3,SHOW_P2P_LOG:!1,MAX_P2P_TIMEOUT:3e4,P2P_TOKEN_INTERVAL:1e3,SHOW_DATASTREAM2_LOG:!1,RESTRICTION_SET_PLAYBACK_DEVICE:!0,USE_PURE_ENCRYPTION_MASTER_KEY:!1,ENABLE_AUDIO_RED:!1,OPUS_PTIME:void 0,AUDIO_DUPLICATE_NUM:void 0,ENABLE_ABSSENDTIME_AS_SENTTS:!0,ACCOUNT_REGISTER_RETRY_TIMEOUT:1,ACCOUNT_REGISTER_RETRY_RATIO:2,ACCOUNT_REGISTER_RETRY_TIMEOUT_MAX:6e4,ACCOUNT_REGISTER_RETRY_COUNT_MAX:1e5,AUDIO_CONTEXT:null,WEBCS_BACKUP_CONNECT_TIMEOUT:6e3,PLAYER_STATE_DEFER:2e3,SIGNAL_REQUEST_WATCH_INTERVAL:1e3,FILEPATH_LENMAX:255,DUALSTREAM_OPERATION_CHECK:!0,MEDIA_ELEMENT_EXISTS_DEPTH:3,SHIM_CANDIDATE:!1,LEAVE_MSG_TIMEOUT:2e3,STATS_FILTER:{transportId:!0,googTrackId:!0},FILTER_VIDEO_CODEC:[],SIGNAL_CHANNEL:0,TRANSMITTER_INITIAL_RTT:30,TRANSMITTER_INITIAL_RTO:30,TRANSMITTER_MAX_BATCH_ACK_COUNT:2,TRANSMITTER_MAX_RTO:500,DATACHANNEL_COMPRESS:!1,DC_JOIN_WITH_FAILBACK:4e3,DC_CONNECTION_TIMEOUT:2e3,DC_PINGPONG_INTERVAL:2e3,DC_DEBUG_LOG:!1,UNSUPPORTED_VIDEO_UPLINK_CODEC:[],UNSUPPORTED_VIDEO_DOWNLINK_CODEC:[],USE_NEW_NETWORK_CONFIG:!1,AUTO_RESET_AUDIO_ROUTE:!1,PLUGIN_INFO:[],OVERUSE_DETECTOR_PARAMS:lS,CUSTOM_ADAPTATION_DEFAULT_MODE:"",HIDE_NO_POSTER:!1,AP_CACHE_NUM:10,AP_UPDATE_INTERVAL:12e4,AP_CACHE_LIFETIME:12e4,MAX_PRELOAD_ASYNC_LENGTH:3,DISABLE_SCREEN_SHARE_REMB:!1},Jp),{},{USE_CANDIDATE_FROM_AP_DETAIL:!1,AP_REQUEST_DETAIL:void 0,ENABLE_ROLE_SELECT_EDGE:!1,CLIENT_ROLE_OPTIONS:void 0,REMOTE_VIDEO_STREAM_TYPE:void 0,COMPATIBLE_SDP_EXTENSION:["gdpr_forbidden"],LIMIT_BITRATE:void 0,EXPERIMENTS:{},USE_PUB_RTX:!0,USE_SUB_RTX:!0,ENABLE_DATASTREAM_2:!1,USE_XR:!0,ENABLE_PREALLOC_PC:!1,ENABLE_PRE_SUB:!1,ENABLE_SVC:!1,ENABLE_FORCE_HLS:!1,MAX_WEBAUDIO_VOLUME:300,ENABLE_VOS_FALLBACK:!1,ENABLE_FALLBACK_TO_HLS:!1,ENABLE_PRE_RENDER:!1,FORCE_DISABLE_AUTO_SUB:!1,ENABLE_PRE_SUB_WITH_PRE_PC:!0,PRE_USE_LOCAL_CODECS:!0},{INSTALL_ID:""}),{},{K_MIN_RENDER_DELAY:66,USE_STANDARD_BITRATE_DEFAULT:!1,VIDEO_NEW_BITRATE_RATIO:void 0,VIDEO_STANDARD_BITRATE_VERSION:2,BASELINE_MORE_H264_BITRATE_RATIO:1.1,IGNORE_RTC_DEVICE_CHECK:!1,FLS_AUTOPLAY_EMITS:!1,ENABLE_DUAL_STREAM_FLAG:!1});function ye(t,e,n){var i,r,s;$(i=Object.keys(Te)).call(i,t)&&(!n&&$(r=Object.keys(ur)).call(r,t)||(Te[t]=e,t!=="ENABLE_VIDEO_SEI"&&t!=="ENABLE_AUDIO_TOPN"&&t!=="ENABLE_AUDIO_METADATA"&&t!=="ENABLE_AUDIO_PTS"||e!==!0||(Te.ENABLE_ENCODED_TRANSFORM=!0),t==="USE_NEW_NETWORK_CONFIG"&&e&&(s=!!e,Te.USE_NEW_NETWORK_CONFIG=s,s&&(Te.WEBCS_DOMAIN=["webrtc2-2.ap.sd-rtn.com"],Te.WEBCS_DOMAIN_BACKUP_LIST=["webrtc2-4.ap.sd-rtn.com"],Te.CDS_AP=["cds-web-2.ap.sd-rtn.com","cds-web-4.ap.sd-rtn.com"],Te.ACCOUNT_REGISTER=["sua-web-2.ap.sd-rtn.com","sua-web-4.ap.sd-rtn.com"],Te.EVENT_REPORT_DOMAIN="web-2.statscollector.sd-rtn.com",Te.EVENT_REPORT_BACKUP_DOMAIN="statscollector-1.agora.io",Te.GATEWAY_DOMAINS=["edge.sd-rtn.com"])),t==="ENABLE_PRE_SUB"&&e&&(Te.ENABLE_INSTANT_VIDEO=!0,Te.ENABLE_PREALLOC_PC=!0),t==="ENABLE_SVC"&&e&&(Te.ENABLE_AUT_CC=!0),t==="NEW_FORCE_TURN"&&e&&(Te.NEW_TURN_MODE||(Te.NEW_TURN_MODE=4))))}function I(t){if(t==="TURN_DOMAINS"){const e=Te.TURN_DOMAINS;return $(e).call(e,I("TURN_DOMAIN"))?e:[I("TURN_DOMAIN")].concat(e)}return Te[t]}dS||(Te.WEBCS_DOMAIN=["ap-web-1-oversea.agora.io","ap-web-1-north-america.agora.io"],Te.WEBCS_DOMAIN_BACKUP_LIST=["ap-web-2-oversea.agora.io","ap-web-2-north-america.agora.io"],Te.PROXY_CS=["proxy-ap-web-oversea.agora.io","proxy-ap-web-america.agora.io"],Te.CDS_AP=["cds-ap-web-oversea.agora.io","cds-ap-web-america.agora.io","cds-ap-web-america2.agora.io"],Te.ACCOUNT_REGISTER=["sua-ap-web-oversea.agora.io","sua-ap-web-america.agora.io","sua-ap-web-america2.agora.io"],Te.UAP_AP=["uap-ap-web-oversea.agora.io","uap-ap-web-america.agora.io","uap-ap-web-america2.agora.io"],Te.LOG_UPLOAD_SERVER="logservice-oversea.agora.io",Te.EVENT_REPORT_DOMAIN="statscollector-1-oversea.agora.io",Te.EVENT_REPORT_BACKUP_DOMAIN="statscollector-2-oversea.agora.io",Te.PROXY_SERVER_TYPE3="webrtc-cloud-proxy.agora.io",Te.AREAS=["NORTH_AMERICA","OVERSEA"]);let e0=(function(t){return t[t.REALTIME=1]="REALTIME",t})({});const ur={};var Pt=(function(t){return t.SET_SESSION_ID="SET_SESSION_ID",t.SET_RTE_URL="SET_RTE_URL",t.SET_RTE_SID="SET_RTE_SID",t.SET_P2P_ID="SET_P2P_id",t.SET_DC_ID="SET_DC_id",t.SET_UID="SET_UID",t.SET_INT_UID="SET_INT_UID",t.SET_PUB_ID="SET_PUB_ID",t.SET_CLOUD_PROXY_SERVER_MODE="SET_CLOUD_PROXY_SERVER_MODE",t.KEY_METRIC_CLIENT_CREATED="KEY_METRIC_CLIENT_CREATED",t.KEY_METRIC_JOIN_START="KEY_METRIC_JOIN_START",t.KEY_METRIC_PRELOAD_START="KEY_METRIC_PRELOAD_START",t.KEY_METRIC_PRELOAD_END="KEY_METRIC_PRELOAD_END",t.KEY_METRIC_JOIN_END="KEY_METRIC_JOIN_END",t.KEY_METRIC_REQUEST_AP_START="KEY_METRIC_REQUEST_AP_START",t.KEY_METRIC_REQUEST_AP_END="KEY_METRIC_REQUEST_AP_END",t.KEY_METRIC_REQUEST_SUA_END="KEY_METRIC_REQUEST_SUA_END",t.KEY_METRIC_BEFORE_CONNECT="KEY_METRIC_BEFORE_CONNECT",t.KEY_METRIC_PEER_RECEIVER="KEY_METRIC_PEER_RECEIVER",t.KEY_METRIC_SIGNAL_CONNECTED="KEY_METRIC_SIGNAL_CONNECTED",t.KEY_METRIC_JOIN_REQ="KEY_METRIC_JOIN_REQ",t.KEY_METRIC_JOIN_REP="KEY_METRIC_JOIN_REP",t.KEY_METRIC_JOIN_GATEWAY_START="KEY_METRIC_JOIN_GATEWAY_START",t.KEY_METRIC_JOIN_GATEWAY_END="KEY_METRIC_JOIN_GATEWAY_END",t.KEY_METRIC_PEER_CONNECTION_START="KEY_METRIC_PEER_CONNECTION_START",t.KEY_METRIC_PEER_CONNECTION_END="KEY_METRIC_PEER_CONNECTION_END",t.KEY_METRIC_FIRST_VIDEO_FRAME_DECODED="KEY_METRIC_FIRST_VIDEO_FRAME_DECODED",t.KEY_METRIC_DESCRIPTION_START="KEY_METRIC_DESCRIPTION_START",t.KEY_METRIC_ICE_CONNECTION_END="KEY_METRIC_ICE_CONNECTION_END",t.KEY_METRIC_SIGNAL_CHANNEL_OPEN="KEY_METRIC_SIGNAL_CHANNEL_OPEN",t.KEY_METRIC_PUBLISH="KEY_METRIC_PUBLISH",t.KEY_METRIC_SUBSCRIBE="KEY_METRIC_SUBSCRIBE",t.RECORD_JOIN_CHANNEL_SERVICE="RECORD_JOIN_CHANNEL_SERVICE",t.RESET_JOIN_CHANNEL_SERVICE_RECORDS="RESET_JOIN_CHANNEL_SERVICE_RECORDS",t.RESET_KEY_METRICS="RESET_KEY_METRICS",t.RESET_FIRST_VIDEO_FRAME_DECODED="RESET_FIRST_VIDEO_FRAME_DECODED",t.SET_USE_P2P="SET_USE_P2P",t.SET_TRANSPORT_TYPE="SET_TRANSPORT_TYPE",t})(Pt||{});let ic=(function(t){return t.h264="h264",t.h265="h265",t.vp8="vp8",t.vp9="vp9",t.av1="av1",t})({});(function(t){t.opus="opus",t.pcma="pcma",t.pcmu="pcmu",t.g722="g722"})({});const n0=128,o8=96,i0=1e3,Id=10;let a8=0;var r0=(()=>{var t={8:(i,r,s)=>{s.r(r),s.d(r,{Parser:()=>Q,Printer:()=>Vt,parse:()=>rt,print:()=>ht});const o=`
`,a="".concat("\r").concat(o),c=" ";let d;function l(J){return J>="0"&&J<="9"}function h(J){return J>="!"&&J<="~"}function p(J){return h(J)||J>=""&&J<=""}function f(J){return J==="!"||J>="#"&&J<="'"||J>="*"&&J<="+"||J>="-"&&J<="."||J>="0"&&J<="9"||J>="A"&&J<="Z"||J>="^"&&J<="~"}function v(J){return J>="1"&&J<="9"}function S(J){return J>="A"&&J<="Z"||J>="a"&&J<="z"}function T(J){return J==="d"||J==="h"||J==="m"||J==="s"}function b(J){return J>""&&J<"	"||J>"\v"&&J<"\f"||J>""&&J<""}function w(J){return S(J)||l(J)||J==="+"||J==="/"}function D(J){return l(J)||S(J)||J==="+"||J==="/"||J==="-"||J==="_"}function k(J){return S(J)||l(J)||J==="+"||J==="/"}function U(J,g){var N=Object.keys(J);if(Object.getOwnPropertySymbols){var L=Object.getOwnPropertySymbols(J);g&&(L=L.filter((function(et){return Object.getOwnPropertyDescriptor(J,et).enumerable}))),N.push.apply(N,L)}return N}function P(J){for(var g=1;g<arguments.length;g++){var N=arguments[g]!=null?arguments[g]:{};g%2?U(Object(N),!0).forEach((function(L){x(J,L,N[L])})):Object.getOwnPropertyDescriptors?Object.defineProperties(J,Object.getOwnPropertyDescriptors(N)):U(Object(N)).forEach((function(L){Object.defineProperty(J,L,Object.getOwnPropertyDescriptor(N,L))}))}return J}function x(J,g,N){return g in J?Object.defineProperty(J,g,{value:N,enumerable:!0,configurable:!0,writable:!0}):J[g]=N,J}(function(J){J.VERSION="v",J.ORIGIN="o",J.SESSION_NAME="s",J.INFORMATION="i",J.URI="u",J.EMAIL="e",J.PHONE="p",J.CONNECTION="c",J.BANDWIDTH="b",J.TIME="t",J.REPEAT="r",J.ZONE_ADJUSTMENTS="z",J.KEY="k",J.ATTRIBUTE="a",J.MEDIA="m"})(d||(d={}));class q{consumeText(g,N){let L=N;for(;L<g.length;){const et=g[L];if(et==="\0"||et==="\r"||et===o)break;L+=1}if(L-N==0)throw new Error("Invalid text, at ".concat(g));return L}consumeUnicastAddress(g,N,L){return this.consumeTill(g,N,c)}consumeOneOrMore(g,N,L){let et=N;for(;L(g[et]);)et++;if(et-N==0)throw new Error("Invalid rule at ".concat(N,"."));return et}consumeSpace(g,N){if(g[N]===c)return N+1;throw new Error("Invalid space at ".concat(N,"."))}consumeIP4Address(g,N){let L=N;for(let et=0;et<4;et++)if(L=this.consumeDecimalUChar(g,L),et!==3){if(g[L]!==".")throw new Error("Invalid IP4 address.");L++}return L}consumeDecimalUChar(g,N){let L=N;for(let Mt=0;Mt<3&&l(g[L]);Mt++,L++);if(L-N==0)throw new Error("Invalid decimal uchar.");const et=parseInt(g.slice(N,L));if(et>=0&&et<=255)return L;throw new Error("Invalid decimal uchar")}consumeIP6Address(g,N){let L=this.consumeHexpart(g,N);return g[L]===":"&&(L+=1,L=this.consumeIP4Address(g,L)),L}consumeHexpart(g,N){let L=N;if(g[L]===":"&&g[L+1]===":"){L+=2;try{L=this.consumeHexseq(g,L)}catch{}return L}if(L=this.consumeHexseq(g,L),g[L]===":"&&g[L+1]===":"){L+=2;try{L=this.consumeHexseq(g,L)}catch{}return L}return L}consumeHexseq(g,N){let L=N;for(;L=this.consumeHex4(g,L),g[L]===":"&&g[L+1]!==":";)L+=1;return L}consumeHex4(g,N){let L=0;for(;L<4;L++)if(!((et=g[N+L])>="0"&&et<="9"||et>="a"&&et<="f"||et>="A"&&et<="F")){if(L===0)throw new Error("Invalid hex 4");break}var et;return N+L}consumeFQDN(g,N){let L=N;for(;l(g[L])||S(g[L])||g[L]==="-"||g[L]===".";)L+=1;if(L-N<4)throw new Error("Invalid FQDN");return L}consumeExtnAddr(g,N){return this.consumeOneOrMore(g,N,p)}consumeMulticastAddress(g,N,L){switch(L){case"IP4":case"ip4":return this.consumeIP4MulticastAddress(g,N);case"IP6":case"ip6":return this.consumeIP6MulticastAddress(g,N);default:try{return this.consumeFQDN(g,N)}catch{return this.consumeExtnAddr(g,N)}}}consumeIP6MulticastAddress(g,N){const L=this.consumeHexpart(g,N);return g[L]==="/"?this.consumeInteger(g,L+1):L}consumeIP4MulticastAddress(g,N){let L=N+3;const et=g.slice(N,L),Mt=parseInt(et);if(Mt<224||Mt>239)throw new Error("Invalid IP4 multicast address, IPv4 multicast addresses may be in the range 224.0.0.0 to 239.255.255.255.");for(let ke=0;ke<3;ke++){if(g[L]!==".")throw new Error("Invalid IP4 multicast address.");L+=1,L=this.consumeDecimalUChar(g,L)}return g[L]==="/"&&(L+=1),L=this.consumeTTL(g,L),g[L]==="/"&&(L=this.consumeInteger(g,L)),L}consumeInteger(g,N){if(!v(g[N]))throw new Error("Invalid integer.");for(N+=1;l(g[N]);)N+=1;return N}consumeTTL(g,N){if(g[N]==="0")return N+1;if(!v(g[N]))throw new Error("Invalid TTL.");N+=1;for(let L=0;L<2&&l(g[N]);L++)N+=1;return N}consumeToken(g,N){return this.consumeOneOrMore(g,N,f)}consumeTime(g,N){let L=N;if(g[L]==="0")return L+1;for(v(g[L])&&(L+=1);l(g[L]);)L++;if(L-N<10)throw new Error("Invalid time");return L}consumeAddress(g,N){return this.consumeTill(g,N,c)}consumeTypedTime(g,N){let L=N;return L=this.consumeOneOrMore(g,L,l),T(g[L])?L+1:L}consumeRepeatInterval(g,N){if(!v(g[N]))throw new Error("Invalid repeat interval");for(N+=1;l(g[N]);)N+=1;return T(g[N])&&(N+=1),N}consumePort(g,N){return this.consumeOneOrMore(g,N,l)}consume(g,N,L){for(let et=0;et<L.length;et++){if(N+et>=g.length)throw new Error("consume exceeding value length");if(g[N+et]!==L[et])throw new Error("consume ".concat(L," failed at ").concat(et))}return N+L.length}consumeTill(g,N,L){let et=N;for(;et<g.length&&(typeof L!="string"||g[et]!==L)&&(typeof L!="function"||!L(g[et]));)et++;return et}}class Q extends q{constructor(){super(),x(this,"records",[]),x(this,"currentLine",0)}parse(g){const N=this.probeEOL(g);this.records=g.split(N).filter((Ia=>!!_i(Ia).call(Ia))).map(this.parseLine),this.currentLine=0;const L=this.parseVersion(),et=this.parseOrigin(),Mt=this.parseSessionName(),ke=this.parseInformation(),kn=this.parseUri(),Ur=this.parseEmail(),ya=this.parsePhone(),pf=this.parseConnection(),il=this.parseBandWidth(),_f=this.parseTimeFields(),Ac=this.parseKey(),Ku=this.parseSessionAttribute(),wc=this.parseMediaDescription();if(this.currentLine!==this.records.length)throw new Error("parsing failed, non exhaustive sdp lines.");return{version:L,origin:et,sessionName:Mt,information:ke,uri:kn,emails:Ur,phones:ya,connection:pf,bandwidths:il,timeFields:_f,key:Ac,attributes:Ku,mediaDescriptions:wc}}getCurrentRecord(){const g=this.records[this.currentLine];if(!g)throw new Error("Record doesn't exit.");return g}probeEOL(g){for(let N=0;N<g.length;N++)if(g[N]===o)return g[N-1]==="\r"?a:o;throw new Error("Invalid newline character.")}parseLine(g,N){if(g.length<2)throw new Error("Invalid sdp line, sdp line should be of form <type>=<value>.");const L=g[0];if(g[1]!=="=")throw new Error('Invalid sdp line, <type> should be a single character followed by an "=" sign.');return{type:L,value:g.slice(2),line:N,cur:0}}parseSessionAttribute(){const g=new Dt;for(;this.currentLine<this.records.length;){const N=this.getCurrentRecord();if(N.type!==d.ATTRIBUTE)break;const L={attField:this.extractOneOrMore(N,(et=>f(et)&&et!==":")),_cur:0};N.value[N.cur]===":"&&(N.cur+=1,L.attValue=this.extractOneOrMore(N,b)),g.parse(L),this.currentLine++}return g.digest()}parseMediaAttributes(g){const N=new Ot(g);for(;this.currentLine<this.records.length;){const L=this.getCurrentRecord();if(L.type!==d.ATTRIBUTE)break;const et={attField:this.extractOneOrMore(L,(Mt=>f(Mt)&&Mt!==":")),_cur:0};L.value[L.cur]===":"&&(L.cur+=1,et.attValue=this.extractOneOrMore(L,b)),N.parse(et),this.currentLine++}return N.digest()}parseKey(){const g=this.getCurrentRecord();if(g.type===d.KEY){if(g.value==="prompt"||g.value==="clear:"||g.value==="base64:"||g.value==="uri:")return g.value;throw this.currentLine++,new Error("Invalid key.")}}parseZone(){const g=this.getCurrentRecord();if(g.type===d.ZONE_ADJUSTMENTS){const N=[];for(;;)try{const L=this.extract(g,this.consumeTime);this.consumeSpaceForRecord(g);let et=!1;g.value[g.cur]==="-"&&(et=!0,g.cur+=1);const Mt=this.extract(g,this.consumeTypedTime);N.push({time:L,typedTime:Mt,back:et})}catch{break}if(N.length===0)throw new Error("Invalid zone adjustments");return this.currentLine++,N}return[]}parseRepeat(){const g=[];for(;;){const N=this.getCurrentRecord();if(N.type!==d.REPEAT)break;{const L=this.extract(N,this.consumeRepeatInterval),et=this.parseTypedTime(N);g.push({repeatInterval:L,typedTimes:et}),this.currentLine++}}return g}parseTypedTime(g){const N=[];for(;;)try{this.consumeSpaceForRecord(g),N.push(this.extract(g,this.consumeTypedTime))}catch{break}if(N.length===0)throw new Error("Invalid typed time.");return N}parseTime(){const g=this.getCurrentRecord(),N=this.extract(g,this.consumeTime);this.consumeSpaceForRecord(g);const L=this.extract(g,this.consumeTime);return this.currentLine++,{startTime:N,stopTime:L}}parseBandWidth(){const g=[];for(;this.currentLine<this.records.length;){const N=this.getCurrentRecord();if(N.type!==d.BANDWIDTH)break;{const L=this.extractOneOrMore(N,f);if(N.value[N.cur]!==":")throw new Error("Invalid bandwidth field.");N.cur++;const et=this.extractOneOrMore(N,l);g.push({bwtype:L,bandwidth:et}),this.currentLine++}}return g}parseVersion(){const g=this.getCurrentRecord();if(g.type!==d.VERSION)throw new Error("first sdp record must be version");const N=g.value.slice(0,this.consumeOneOrMore(g.value,0,l));if(N.length!==g.value.length)throw new Error('invalid proto version, "v='.concat(g.value,'"'));return this.currentLine++,N}parseOrigin(){const g=this.getCurrentRecord();if(g.type!==d.ORIGIN)throw new Error("second line of sdp must be origin");const N=this.extractOneOrMore(g,p);this.consumeSpaceForRecord(g);const L=this.extractOneOrMore(g,l);this.consumeSpaceForRecord(g);const et=this.extractOneOrMore(g,l);this.consumeSpaceForRecord(g);const Mt=this.extractOneOrMore(g,f);this.consumeSpaceForRecord(g);const ke=this.extractOneOrMore(g,f);this.consumeSpaceForRecord(g);const kn=this.extract(g,this.consumeUnicastAddress);return this.currentLine++,{username:N,sessId:L,sessVersion:et,nettype:Mt,addrtype:ke,unicastAddress:kn}}parseSessionName(){const g=this.getCurrentRecord();if(g.type===d.SESSION_NAME){const N=this.extract(g,this.consumeText);return this.currentLine++,N}}parseInformation(){const g=this.getCurrentRecord();if(g.type!==d.INFORMATION)return;const N=this.extract(g,this.consumeText);return this.currentLine++,N}parseUri(){const g=this.getCurrentRecord();if(g.type===d.URI)return this.currentLine++,g.value}parseEmail(){const g=[];for(;;){const N=this.getCurrentRecord();if(N.type!==d.EMAIL)break;g.push(N.value),this.currentLine++}return g}parsePhone(){const g=[];for(;;){const N=this.getCurrentRecord();if(N.type!==d.PHONE)break;g.push(N.value),this.currentLine++}return g}parseConnection(){const g=this.getCurrentRecord();if(g.type===d.CONNECTION){const N=this.extractOneOrMore(g,f);this.consumeSpaceForRecord(g);const L=this.extractOneOrMore(g,f);this.consumeSpaceForRecord(g);const et=this.extract(g,this.consumeAddress);return this.currentLine++,{nettype:N,addrtype:L,address:et}}}parseMedia(){const g=this.getCurrentRecord(),N=this.extract(g,this.consumeToken);this.consumeSpaceForRecord(g);let L=this.extract(g,this.consumePort);g.value[g.cur]==="/"&&(g.cur+=1,L+=this.extract(g,this.consumeInteger)),this.consumeSpaceForRecord(g);const et=[];for(et.push(this.extract(g,this.consumeToken));g.value[g.cur]==="/";)g.cur+=1,et.push(this.extract(g,this.consumeToken));if(et.length===0)throw new Error("Invalid proto");const Mt=this.parseFmt(g);return this.currentLine++,{mediaType:N,port:L,protos:et,fmts:Mt}}parseTimeFields(){const g=[];for(;this.getCurrentRecord().type===d.TIME;){const N=this.parseTime(),L=this.parseRepeat(),et=this.parseZone();g.push({time:N,repeats:L,zones:et})}return g}parseMediaDescription(){const g=[];for(;this.currentLine<this.records.length&&this.getCurrentRecord().type===d.MEDIA;){const N=this.parseMedia(),L=this.parseInformation(),et=this.parseConnections(),Mt=this.parseBandWidth(),ke=this.parseKey(),kn=this.parseMediaAttributes(N);g.push({media:N,information:L,connections:et,bandwidths:Mt,key:ke,attributes:kn})}return g}parseConnections(){const g=[];for(;this.currentLine<this.records.length&&this.getCurrentRecord().type===d.CONNECTION;)g.push(this.parseConnection());return g}parseFmt(g){const N=[];for(;;)try{this.consumeSpaceForRecord(g),N.push(this.extract(g,this.consumeToken))}catch{break}if(N.length===0)throw new Error("Invalid fmts");return N}extract(g,N){for(var L=arguments.length,et=new Array(L>2?L-2:0),Mt=2;Mt<L;Mt++)et[Mt-2]=arguments[Mt];const ke=N.call(this,g.value,g.cur,...et),kn=g.value.slice(g.cur,ke);return g.cur=ke,kn}extractOneOrMore(g,N){const L=this.consumeOneOrMore(g.value,g.cur,N),et=g.value.slice(g.cur,L);return g.cur=L,et}consumeSpaceForRecord(g){if(g.value[g.cur]!==c)throw new Error("Invalid space at ".concat(g.cur,"."));g.cur+=1}}class dt extends q{constructor(){super(...arguments),x(this,"attributes",void 0),x(this,"digested",!1)}extractOneOrMore(g,N,L){const et=this.consumeOneOrMore(g.attValue,g._cur,N),Mt=g.attValue.slice(g._cur,et),[ke,kn]=L||[];if(typeof ke=="number"&&Mt.length<ke)throw new Error("error in length, should be more or equal than ".concat(ke," characters."));if(typeof kn=="number"&&Mt.length>kn)throw new Error("error in length, should be less or equal than ".concat(kn," characters."));return g._cur=et,Mt}consumeAttributeSpace(g){if(g.attValue[g._cur]!==c)throw new Error("Invalid space at ".concat(g._cur,"."));g._cur+=1}extract(g,N){if(!g.attValue)throw new Error("Nothing to extract from attValue.");for(var L=arguments.length,et=new Array(L>2?L-2:0),Mt=2;Mt<L;Mt++)et[Mt-2]=arguments[Mt];const ke=N.call(this,g.attValue,g._cur,...et),kn=g.attValue.slice(g._cur,ke);return g._cur=ke,kn}atEnd(g){if(!g.attValue)throw new Error;return g._cur>=g.attValue.length}peekChar(g){if(!g.attValue)throw new Error;return g.attValue[g._cur]}peek(g,N){if(!g.attValue)throw new Error;for(let L=0;L<N.length;L++)if(N[L]!==g.attValue[g._cur+L])return!1;return!0}parseIceUfrag(g){if(this.attributes.iceUfrag)throw new Error("Invalid ice-ufrag, should be only a single line if 'a=ice-ufrag'");this.attributes.iceUfrag=this.extractOneOrMore(g,w,[4,256])}parseIcePwd(g){if(this.attributes.icePwd)throw new Error("Invalid ice-pwd, should be only a single line if 'a=ice-pwd'");this.attributes.icePwd=this.extractOneOrMore(g,w,[22,256])}parseIceOptions(g){if(this.attributes.iceOptions)throw new Error("Invalid ice-options, should be only one 'ice-options' line");const N=[];for(;!this.atEnd(g);){N.push(this.extractOneOrMore(g,w));try{this.consumeAttributeSpace(g)}catch(L){if(this.atEnd(g))break;throw L}}this.attributes.iceOptions=N}parseFingerprint(g){const N=this.extract(g,this.consumeToken);this.consumeAttributeSpace(g);const L=this.extract(g,this.consumeTill);this.attributes.fingerprints.push({hashFunction:N,fingerprint:L})}parseExtmap(g){const N=this.extractOneOrMore(g,l);let L;this.peekChar(g)==="/"&&(this.extract(g,this.consume,"/"),L=this.extract(g,this.consumeToken)),this.consumeAttributeSpace(g);const et=this.extract(g,this.consumeTill,c),Mt=P(P({entry:parseInt(N,10)},L&&{direction:L}),{},{extensionName:et});this.peekChar(g)===c&&(this.consumeAttributeSpace(g),Mt.extensionAttributes=this.extract(g,this.consumeTill)),this.attributes.extmaps.push(Mt)}parseSetup(g){if(this.attributes.setup)throw new Error("must only be one single 'a=setup' line.");const N=this.extract(g,this.consumeTill);if(N!=="active"&&N!=="passive"&&N!=="actpass"&&N!=="holdconn")throw new Error("role must be one of 'active', 'passive', 'actpass', 'holdconn'.");this.attributes.setup=N}}class Dt extends dt{constructor(){super(...arguments),x(this,"attributes",{unrecognized:[],groups:[],extmaps:[],fingerprints:[],identities:[]})}parse(g){if(this.digested)throw new Error("already digested");try{switch(g.attField){case"group":this.parseGroup(g);break;case"ice-lite":this.parseIceLite();break;case"ice-ufrag":this.parseIceUfrag(g);break;case"ice-pwd":this.parseIcePwd(g);break;case"ice-options":this.parseIceOptions(g);break;case"fingerprint":this.parseFingerprint(g);break;case"setup":this.parseSetup(g);break;case"tls-id":this.parseTlsId(g);break;case"identity":this.parseIdentity(g);break;case"extmap":this.parseExtmap(g);break;case"msid-semantic":this.parseMsidSemantic(g);break;default:g.ignored=!0,this.attributes.unrecognized.push(g)}}catch(N){throw console.error("parsing session attribute ".concat(g.attField,' error, "a=').concat(g.attField,":").concat(g.attValue,'"')),N}if(!g.ignored&&g.attValue&&!this.atEnd(g))throw new Error("attribute parsing error")}digest(){return this.digested=!0,this.attributes}parseGroup(g){const N=this.extract(g,this.consumeToken),L=[];for(;!this.atEnd(g)&&this.peekChar(g)===c;)this.consumeAttributeSpace(g),L.push(this.extract(g,this.consumeToken));this.attributes.groups.push({semantic:N,identificationTag:L})}parseIceLite(){if(this.attributes.iceLite)throw new Error("Invalid ice-lite, should be only a single line of 'a=ice-lite'");this.attributes.iceLite=!0}parseTlsId(g){if(this.attributes.tlsId)throw new Error("must be only one tld-id line");this.attributes.tlsId=this.extractOneOrMore(g,D)}parseIdentity(g){const N=this.extractOneOrMore(g,k),L=[];for(;!this.atEnd(g)&&this.peekChar(g)===c;){this.consumeAttributeSpace(g);const et=this.extract(g,this.consumeToken);this.extract(g,this.consume,"=");const Mt=this.extractOneOrMore(g,(ke=>ke!==c&&b(ke)));L.push({name:et,value:Mt})}this.attributes.identities.push({assertionValue:N,extensions:L})}parseMsidSemantic(g){this.peekChar(g)===c&&this.consumeAttributeSpace(g);const N={semantic:this.extract(g,this.consumeToken),identifierList:[]};for(;;){try{this.consumeAttributeSpace(g)}catch{break}if(this.peekChar(g)==="*"){this.extract(g,this.consume,"*"),N.applyForAll=!0;break}{const L=this.extract(g,this.consumeTill,c);N.identifierList.push(L)}}this.attributes.msidSemantic=N}}class Ot extends dt{constructor(g){super(),x(this,"attributes",void 0),g.protos.indexOf("RTP")!==-1||g.protos.indexOf("rtp"),this.attributes={unrecognized:[],candidates:[],extmaps:[],fingerprints:[],imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:[],ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:[]}}parse(g){if(this.digested)throw new Error("already digested");try{switch(g.attField){case"extmap":this.parseExtmap(g);break;case"setup":this.parseSetup(g);break;case"ice-ufrag":this.parseIceUfrag(g);break;case"ice-pwd":this.parseIcePwd(g);break;case"ice-options":this.parseIceOptions(g);break;case"candidate":this.parseCandidate(g);break;case"remote-candidate":this.parseRemoteCandidate(g);break;case"end-of-candidates":this.parseEndOfCandidates();break;case"fingerprint":this.parseFingerprint(g);break;case"rtpmap":this.parseRtpmap(g);break;case"ptime":this.parsePtime(g);break;case"maxptime":this.parseMaxPtime(g);break;case"sendrecv":case"recvonly":case"sendonly":case"inactive":this.parseDirection(g);break;case"ssrc":this.parseSSRC(g);break;case"fmtp":this.parseFmtp(g);break;case"rtcp-fb":this.parseRtcpFb(g);break;case"rtcp-mux":this.parseRTCPMux();break;case"rtcp-mux-only":this.parseRTCPMuxOnly();break;case"rtcp-rsize":this.parseRTCPRsize();break;case"rtcp":this.parseRTCP(g);break;case"mid":this.parseMid(g);break;case"msid":this.parseMsid(g);break;case"imageattr":this.parseImageAttr(g);break;case"rid":this.parseRid(g);break;case"simulcast":this.parseSimulcast(g);break;case"sctp-port":this.parseSctpPort(g);break;case"max-message-size":this.parseMaxMessageSize(g);break;case"ssrc-group":this.parseSSRCGroup(g);break;default:g.ignored=!0,this.attributes.unrecognized.push(g)}}catch(N){throw console.error("parsing media attribute ".concat(g.attField,' error, "a=').concat(g.attField,":").concat(g.attValue,'"')),N}if(!g.ignored&&g.attValue&&!this.atEnd(g))throw new Error("attribute parsing error")}parseCandidate(g){const N=this.extractOneOrMore(g,w,[1,32]);this.consumeAttributeSpace(g);const L=this.extractOneOrMore(g,l,[1,5]);this.consumeAttributeSpace(g);const et=this.extract(g,this.consumeToken);this.consumeAttributeSpace(g);const Mt=this.extractOneOrMore(g,l,[1,10]);this.consumeAttributeSpace(g);const ke=this.extract(g,this.consumeAddress);this.consumeAttributeSpace(g);const kn=this.extract(g,this.consumePort);this.consumeAttributeSpace(g),this.extract(g,this.consume,"typ"),this.consumeAttributeSpace(g);const Ur={foundation:N,componentId:L,transport:et,priority:Mt,connectionAddress:ke,port:kn,type:this.extract(g,this.consumeToken),extension:{}};for(this.peek(g," raddr")&&(this.extract(g,this.consume," raddr"),this.consumeAttributeSpace(g),Ur.relAddr=this.extract(g,this.consumeAddress)),this.peek(g," rport")&&(this.extract(g,this.consume," rport"),this.consumeAttributeSpace(g),Ur.relPort=this.extract(g,this.consumePort));this.peekChar(g)===c;){this.consumeAttributeSpace(g);const ya=this.extract(g,this.consumeToken);this.consumeAttributeSpace(g),Ur.extension[ya]=this.extractOneOrMore(g,h)}this.attributes.candidates.push(Ur)}parseRemoteCandidate(g){const N=[];for(;;){const L=this.extractOneOrMore(g,l,[1,5]);this.consumeAttributeSpace(g);const et=this.extract(g,this.consumeAddress);this.consumeAttributeSpace(g);const Mt=this.extract(g,this.consumePort);N.push({componentId:L,connectionAddress:et,port:Mt});try{this.consumeAttributeSpace(g)}catch{break}}this.attributes.remoteCandidatesList.push(N)}parseEndOfCandidates(){if(this.attributes.endOfCandidates)throw new Error("must be only one line of end-of-candidates");this.attributes.endOfCandidates=!0}parseRtpmap(g){const N=this.extract(g,this.consumeToken);this.consumeAttributeSpace(g);const L=this.extract(g,this.consumeTill,"/");this.extract(g,this.consume,"/");const et={encodingName:L,clockRate:this.extractOneOrMore(g,l)};this.atEnd(g)||this.peekChar(g)!=="/"||(this.extract(g,this.consume,"/"),et.encodingParameters=parseInt(this.extract(g,this.consumeTill),10));const Mt=this.attributes.payloads.find((ke=>ke.payloadType===parseInt(N,10)));Mt?Mt.rtpMap=et:this.attributes.payloads.push({payloadType:parseInt(N,10),rtpMap:et,rtcpFeedbacks:[]})}parsePtime(g){if(this.attributes.ptime)throw new Error("must be only one line of ptime");this.attributes.ptime=this.extract(g,this.consumeTill)}parseMaxPtime(g){if(this.attributes.maxPtime)throw new Error("must be only one line of ptime");this.attributes.maxPtime=this.extract(g,this.consumeTill)}parseDirection(g){if(this.attributes.direction)throw new Error("must be only one line of direction info");this.attributes.direction=g.attField}parseSSRC(g){const N=this.extractOneOrMore(g,l);this.consumeAttributeSpace(g);const L=this.extract(g,this.consumeTill,":");let et;this.peekChar(g)===":"&&(this.extract(g,this.consume,":"),et=this.extract(g,this.consumeTill));const Mt=this.attributes.ssrcs.find((ke=>ke.ssrcId===parseInt(N,10)));Mt?Mt.attributes[L]=et:this.attributes.ssrcs.push({ssrcId:parseInt(N,10),attributes:{[L]:et}})}parseFmtp(g){const N=this.extract(g,this.consumeTill,c);this.consumeAttributeSpace(g);const L=this.extract(g,this.consumeTill),et={};L.split(";").forEach((ke=>{let[kn,Ur]=ke.split("=");kn=_i(kn).call(kn);const ya=typeof Ur=="string"?_i(Ur).call(Ur):null;typeof kn=="string"&&kn.length>0&&(et[kn]=ya)}));const Mt=this.attributes.payloads.find((ke=>ke.payloadType===parseInt(N,10)));Mt?Mt.fmtp={parameters:et}:this.attributes.payloads.push({payloadType:parseInt(N,10),rtcpFeedbacks:[],fmtp:{parameters:et}})}parseFmtParameters(g){const N={},L=this.extract(g,this.consumeTill,"=");g._cur++;const et=this.extract(g,this.consumeTill,";");for(N[L]=et;g.attValue[g._cur]===";";){const Mt=this.extract(g,this.consumeTill,"=");g._cur++;const ke=this.extract(g,this.consumeTill,";");N[Mt]=ke}return N}parseRtcpFb(g){let N="";N=this.peekChar(g)==="*"?this.extract(g,this.consume,"*"):this.extract(g,this.consumeTill,c),this.consumeAttributeSpace(g);const L=this.extract(g,this.consumeTill,c);let et;if(L==="trr-int")et={type:L,interval:this.extract(g,this.consumeTill)};else{const Mt={type:L};this.peekChar(g)===c&&(this.consumeAttributeSpace(g),Mt.parameter=this.extract(g,this.consumeToken),this.peekChar(g)===c&&(Mt.additional=this.extract(g,this.consumeTill))),et=Mt}if(N==="*")this.attributes.rtcpFeedbackWildcards.push(et);else{const Mt=this.attributes.payloads.find((ke=>ke.payloadType===parseInt(N,10)));Mt?Mt.rtcpFeedbacks.push(et):this.attributes.payloads.push({payloadType:parseInt(N,10),rtcpFeedbacks:[et]})}}parseRTCPMux(){if(this.attributes.rtcpMux)throw new Error("must be single line of rtcp-mux");this.attributes.rtcpMux=!0}parseRTCPMuxOnly(){if(this.attributes.rtcpMuxOnly)throw new Error("must be single line of rtcp-only");this.attributes.rtcpMuxOnly=!0}parseRTCPRsize(){if(this.attributes.rtcpRsize)throw new Error("must be single line of rtcp-rsize");this.attributes.rtcpRsize=!0}parseRTCP(g){if(this.attributes.rtcp)throw new Error("must be single line of rtcp");const N={port:this.extract(g,this.consumePort)};this.peekChar(g)===c&&(this.consumeAttributeSpace(g),N.netType=this.extractOneOrMore(g,f),this.consumeAttributeSpace(g),N.addressType=this.extractOneOrMore(g,f),this.consumeAttributeSpace(g),N.address=this.extract(g,this.consumeAddress)),this.attributes.rtcp=N}parseMsid(g){const N={id:this.extractOneOrMore(g,f,[1,64])};this.peekChar(g)===c&&(this.consumeAttributeSpace(g),N.appdata=this.extractOneOrMore(g,f,[1,64])),this.attributes.msids.push(N)}parseImageAttr(g){this.attributes.imageattr.push(g.attValue)}parseRid(g){const N=this.extractOneOrMore(g,(et=>S(et)||l(et)||et==="_"||et==="-"));this.consumeAttributeSpace(g);const L={id:N,direction:this.extract(g,this.consumeToken),params:[]};if(this.peekChar(g)===c){if(this.consumeAttributeSpace(g),this.peek(g,"pt=")){this.extract(g,this.consume,"pt=");const et=[];for(;;){const Mt=this.extract(g,this.consumeToken);et.push(Mt);try{this.extract(g,this.consume,",")}catch{break}}L.payloads=et,this.peekChar(g)===c&&this.extract(g,this.consume,c)}for(;;){const et=this.extract(g,this.consumeToken);switch(et){case"depend":{const Mt={type:et,rids:this.extract(g,this.consume,"=").split(",")};L.params.push(Mt);break}default:{const Mt={type:et};this.peekChar(g)==="="&&(this.extract(g,this.consume,"="),Mt.val=this.extract(g,this.consumeTill,";")),L.params.push(Mt)}}try{this.extract(g,this.consume,";")}catch{break}}}this.attributes.rids.push(L)}parseSimulcast(g){if(this.attributes.simulcast)throw new Error("must be single line of simulcast");this.attributes.simulcast=g.attValue,this.extract(g,this.consumeTill)}parseSctpPort(g){this.attributes.sctpPort=this.extractOneOrMore(g,l,[1,5])}parseMaxMessageSize(g){this.attributes.maxMessageSize=this.extractOneOrMore(g,l,[1,void 0])}digest(){return this.digested=!0,this.attributes}parseMid(g){this.attributes.mid=this.extract(g,this.consumeToken)}parseSSRCGroup(g){const N=this.extract(g,this.consumeToken),L=[];for(;;)try{this.consumeAttributeSpace(g);const et=this.extract(g,this.consumeInteger);L.push(parseInt(et,10))}catch{break}this.attributes.ssrcGroups.push({semantic:N,ssrcIds:L})}}function Wt(J,g,N){return g in J?Object.defineProperty(J,g,{value:N,enumerable:!0,configurable:!0,writable:!0}):J[g]=N,J}class Vt{constructor(){Wt(this,"eol",a)}print(g,N){let L="";return N&&(this.eol=N),L+=this.printVersion(g.version),L+=this.printOrigin(g.origin),L+=this.printSessionName(g.sessionName),L+=this.printInformation(g.information),L+=this.printUri(g.uri),L+=this.printEmail(g.emails),L+=this.printPhone(g.phones),L+=this.printConnection(g.connection),L+=this.printBandwidth(g.bandwidths),L+=this.printTimeFields(g.timeFields),L+=this.printKey(g.key),L+=this.printSessionAttributes(g.attributes),L+=this.printMediaDescription(g.mediaDescriptions),L}printVersion(g){return"v=".concat(g).concat(this.eol)}printOrigin(g){return"o=".concat(g.username," ").concat(g.sessId," ").concat(g.sessVersion," ").concat(g.nettype," ").concat(g.addrtype," ").concat(g.unicastAddress).concat(this.eol)}printSessionName(g){return g?"s=".concat(g).concat(this.eol):""}printInformation(g){return g?"i=".concat(g).concat(this.eol):""}printUri(g){return g?"u=".concat(g).concat(this.eol):""}printEmail(g){let N="";for(const L of g)N+="e=".concat(L).concat(this.eol);return N}printPhone(g){let N="";for(const L of g)N+="e=".concat(L).concat(this.eol);return N}printConnection(g){return g?"c=".concat(g.nettype," ").concat(g.addrtype," ").concat(g.address).concat(this.eol):""}printBandwidth(g){let N="";for(const L of g)N+="b=".concat(L.bwtype,":").concat(L.bandwidth).concat(this.eol);return N}printTimeFields(g){let N="";for(const L of g){N+="t=".concat(L.time.startTime," ").concat(L.time.startTime).concat(this.eol);for(const et of L.repeats)N+="r=".concat(et.repeatInterval," ").concat(et.typedTimes.join(" ")).concat(this.eol);L.zoneAdjustments&&(N+="z=",N+="z=".concat(L.zoneAdjustments.map((et=>"".concat(et.time," ").concat(et.back?"-":""," ").concat(et.typedTime))).join(" ")).concat(this.eol),N+=this.eol)}return N}printKey(g){return g?"k=".concat(g).concat(this.eol):""}printAttributes(g){let N="";for(const L of g)N+="a=".concat(L.attField).concat(L.attValue?":".concat(L.attValue):"").concat(this.eol);return N}printMediaDescription(g){let N="";for(const L of g)N+=this.printMedia(L.media),N+=this.printInformation(L.information),N+=this.printConnections(L.connections),N+=this.printBandwidth(L.bandwidths),N+=this.printKey(L.key),N+=this.printMediaAttributes(L);return N}printConnections(g){let N="";for(const L of g)N+=this.printConnection(L);return N}printMedia(g){return"m=".concat(g.mediaType," ").concat(g.port," ").concat(g.protos.join("/")," ").concat(g.fmts.join(" ")).concat(this.eol)}printSessionAttributes(g){return new He(this.eol).print(g)}printMediaAttributes(g){return new X(this.eol).print(g)}}class pe{constructor(g){Wt(this,"eol",void 0),this.eol=g}printIceUfrag(g){return g===void 0?"":"a=ice-ufrag:".concat(g).concat(this.eol)}printIcePwd(g){return g===void 0?"":"a=ice-pwd:".concat(g).concat(this.eol)}printIceOptions(g){return g===void 0?"":"a=ice-options:".concat(g.join(c)).concat(this.eol)}printFingerprints(g){return g.length>0?g.map((N=>"a=fingerprint:".concat(N.hashFunction).concat(c).concat(N.fingerprint))).join(this.eol)+this.eol:""}printExtmap(g){return g.map((N=>"a=extmap:".concat(N.entry).concat(N.direction?"/".concat(N.direction):"").concat(c).concat(N.extensionName).concat(N.extensionAttributes?"".concat(c).concat(N.extensionAttributes):"").concat(this.eol))).join("")}printSetup(g){return g===void 0?"":"a=setup:".concat(g).concat(this.eol)}printUnrecognized(g){return g.map((N=>"a=".concat(N.attField).concat(N.attValue?":".concat(N.attValue):"").concat(this.eol))).join("")}}class He extends pe{print(g){let N="";return N+=this.printGroups(g.groups),N+=this.printMsidSemantic(g.msidSemantic),N+=this.printIceLite(g.iceLite),N+=this.printIceUfrag(g.iceUfrag),N+=this.printIcePwd(g.icePwd),N+=this.printIceOptions(g.iceOptions),N+=this.printFingerprints(g.fingerprints),N+=this.printSetup(g.setup),N+=this.printTlsId(g.tlsId),N+=this.printIdentity(g.identities),N+=this.printExtmap(g.extmaps),N+=this.printUnrecognized(g.unrecognized),N}printGroups(g){let N="";return g.length>0&&(N+=g.map((L=>"a=group:".concat(L.semantic).concat(L.identificationTag.map((et=>"".concat(c).concat(et))).join("")).concat(this.eol))).join("")),N}printIceLite(g){return g===void 0?"":"a=ice-lite"+this.eol}printTlsId(g){return g?"a=tls-id:".concat(g).concat(this.eol):""}printIdentity(g){return g.length===0?"":g.map((N=>"a=identity:".concat(N.assertionValue).concat(N.extensions.map((L=>"".concat(c).concat(L.name).concat(L.value?"=".concat(L.value):"")))))).join(this.eol)+this.eol}printMsidSemantic(g){if(!g)return"";let N="a=msid-semantic:".concat(g.semantic);return g.applyForAll?N+="".concat(c,"*"):g.identifierList.length>0&&(N+=g.identifierList.map((L=>"".concat(c).concat(L)))),N+this.eol}}class X extends pe{print(g){const N=g.attributes;let L="";return L+=this.printRTCP(N.rtcp),L+=this.printIceUfrag(N.iceUfrag),L+=this.printIcePwd(N.icePwd),L+=this.printIceOptions(N.iceOptions),L+=this.printCandidates(N.candidates),L+=this.printRemoteCandidatesList(N.remoteCandidatesList),L+=this.printEndOfCandidates(N.endOfCandidates),L+=this.printFingerprints(N.fingerprints),L+=this.printSetup(N.setup),L+=this.printMid(N.mid),L+=this.printExtmap(N.extmaps),L+=this.printRTPRelated(N),L+=this.printPtime(N.ptime),L+=this.printMaxPtime(N.maxPtime),L+=this.printDirection(N.direction),L+=this.printSSRCGroups(N.ssrcGroups),L+=this.printSSRC(N.ssrcs),L+=this.printRTCPMux(N.rtcpMux),L+=this.printRTCPMuxOnly(N.rtcpMuxOnly),L+=this.printRTCPRsize(N.rtcpRsize),L+=this.printMSId(N.msids),L+=this.printImageattr(N.imageattr),L+=this.printRid(N.rids),L+=this.printSimulcast(N.simulcast),L+=this.printSCTPPort(N.sctpPort),L+=this.printMaxMessageSize(N.maxMessageSize),L+=this.printUnrecognized(N.unrecognized),L}printCandidates(g){return g.map((N=>"a=candidate:".concat(N.foundation).concat(c).concat(N.componentId).concat(c).concat(N.transport).concat(c).concat(N.priority).concat(c).concat(N.connectionAddress).concat(c).concat(N.port).concat(c,"typ").concat(c).concat(N.type).concat(N.relAddr?"".concat(c,"raddr").concat(c).concat(N.relAddr):"").concat(N.relPort?"".concat(c,"rport").concat(c).concat(N.relPort):"").concat(Object.keys(N.extension).map((L=>"".concat(c).concat(L).concat(c).concat(N.extension[L]))).join("")).concat(this.eol))).join("")}printRemoteCandidatesList(g){return g.map((N=>"a=remote-candidates:".concat(N.join(c)).concat(this.eol))).join("")}printEndOfCandidates(g){return g===void 0?"":"a=end-of-candidates"+this.eol}printRTPRelated(g){if(!g.payloads)return"";const N=g.payloads;let L="";L+=g.rtcpFeedbackWildcards.map((et=>this.printRTCPFeedback("*",et))).join("");for(const et of N)L+=this.printRtpMap(et.payloadType,et.rtpMap),L+=this.printFmtp(et.payloadType,et.fmtp),L+=et.rtcpFeedbacks.map((Mt=>this.printRTCPFeedback(et.payloadType,Mt))).join("");return L}printFmtp(g,N){if(!N)return"";const L=Object.keys(N.parameters);return L.length===1&&N.parameters[L[0]]===null?"a=fmtp:".concat(g).concat(c).concat(L[0]).concat(this.eol):"a=fmtp:".concat(g).concat(c).concat(Object.keys(N.parameters).map((et=>"".concat(et,"=").concat(N.parameters[et]))).join(";")).concat(this.eol)}printRtpMap(g,N){return N?"a=rtpmap:".concat(g).concat(c).concat(N.encodingName,"/").concat(N.clockRate).concat(N.encodingParameters?"/".concat(N.encodingParameters):"").concat(this.eol):""}printRTCPFeedback(g,N){let L="a=rtcp-fb:".concat(g).concat(c),et=N;return et.type==="trr-int"?L+="ttr-int".concat(c).concat(et.interval):(L+="".concat(et.type),et.parameter&&(L+="".concat(c).concat(et.parameter),et.additional&&(L+="".concat(c).concat(et.additional)))),L+this.eol}printPtime(g){return g===void 0?"":"a=ptime:".concat(g).concat(this.eol)}printMaxPtime(g){return g===void 0?"":"a=maxptime:".concat(g).concat(this.eol)}printDirection(g){return g===void 0?"":"a=".concat(g).concat(this.eol)}printSSRC(g){return g.map((N=>Object.keys(N.attributes).map((L=>"a=ssrc:".concat(N.ssrcId.toString(10)).concat(c).concat(L).concat(N.attributes[L]?":".concat(N.attributes[L]):"").concat(this.eol))).join(""))).join("")}printRTCPMux(g){return g===void 0?"":"a=rtcp-mux".concat(this.eol)}printRTCPMuxOnly(g){return g===void 0?"":"a=rtcp-mux-only".concat(this.eol)}printRTCPRsize(g){return g===void 0?"":"a=rtcp-rsize".concat(this.eol)}printRTCP(g){if(g===void 0)return"";let N="a=rtcp:".concat(g.port);return g.netType&&(N+="".concat(c).concat(g.netType)),g.addressType&&(N+="".concat(c).concat(g.addressType)),g.address&&(N+="".concat(c).concat(g.address)),N+this.eol}printMSId(g){return g.map((N=>"a=msid:".concat(N.id).concat(N.appdata?"".concat(c).concat(N.appdata):"").concat(this.eol))).join("")}printImageattr(g){return g.map((N=>"a=imageattr:".concat(N).concat(this.eol))).join("")}printRid(g){return g.map((N=>{let L="a=rid:".concat(N.id).concat(c).concat(N.direction);return N.payloads&&(L+="".concat(c,"pt=").concat(N.payloads.join(","))),N.params.length>0&&(L+="".concat(c).concat(N.params.map((et=>et.type==="depend"?"depend=".concat(et.rids.join(",")):"".concat(et.type,"=").concat(et.val))).join(";"))),L+this.eol})).join("")}printSimulcast(g){return g===void 0?"":"a=simulcast:".concat(g).concat(this.eol)}printSCTPPort(g){return g===void 0?"":"a=sctp-port:".concat(g).concat(this.eol)}printMaxMessageSize(g){return g===void 0?"":"a=max-message-size:".concat(g).concat(this.eol)}printMid(g){return g===void 0?"":"a=mid:".concat(g).concat(this.eol)}printSSRCGroups(g){return g.map((N=>"a=ssrc-group:".concat(N.semantic).concat(N.ssrcIds.map((L=>"".concat(c).concat(L.toString(10)))).join("")).concat(this.eol))).join("")}}function rt(J){return new Q().parse(J)}function ht(J,g){return new Vt().print(J,g)}}},e={};function n(i){if(e[i])return e[i].exports;var r=e[i]={exports:{}};return t[i](r,r.exports,n),r.exports}return n.d=(i,r)=>{for(var s in r)n.o(r,s)&&!n.o(i,s)&&Object.defineProperty(i,s,{enumerable:!0,get:r[s]})},n.o=(i,r)=>Object.prototype.hasOwnProperty.call(i,r),n.r=i=>{typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(i,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(i,"__esModule",{value:!0})},n(8)})();function Ei(t){return r0.parse(t)}function Oo(t,e){return r0.print(t,e)}var c8=yr("Array","keys"),d8=Qo,l8=ii,u8=Z,h8=c8,pS=Array.prototype,p8={DOMTokenList:!0,NodeList:!0},_8=function(t){var e=t.keys;return t===pS||u8(pS,t)&&e===pS.keys||l8(p8,d8(t))?h8:e},oi=y(_8);function tn(t,e,n){return(e=(function(i){var r=(function(s,o){if(typeof s!="object"||!s)return s;var a=s[Symbol.toPrimitive];if(a!==void 0){var c=a.call(s,"string");if(typeof c!="object")return c;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(s)})(i);return typeof r=="symbol"?r:r+""})(e))in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function s0(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable}))),n.push.apply(n,i)}return n}function Gt(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?s0(Object(n),!0).forEach((function(i){tn(t,i,n[i])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):s0(Object(n)).forEach((function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i))}))}return t}function Qp(t,e){return Qp=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(n,i){return n.__proto__=i,n},Qp(t,e)}function _S(){_S=function(r,s){return new n(r,void 0,s)};var t=RegExp.prototype,e=new WeakMap;function n(r,s,o){var a=RegExp(r,s);return e.set(a,o||e.get(r)),Qp(a,n.prototype)}function i(r,s){var o,a=e.get(s);return Ir(o=Object.keys(a)).call(o,(function(c,d){var l=a[d];if(typeof l=="number")c[d]=r[l];else{for(var h=0;r[l[h]]===void 0&&h+1<l.length;)h++;c[d]=r[l[h]]}return c}),Object.create(null))}return(function(r,s){if(typeof s!="function"&&s!==null)throw new TypeError("Super expression must either be null or a function");r.prototype=Object.create(s&&s.prototype,{constructor:{value:r,writable:!0,configurable:!0}}),Object.defineProperty(r,"prototype",{writable:!1}),s&&Qp(r,s)})(n,RegExp),n.prototype.exec=function(r){var s=t.exec.call(this,r);if(s){s.groups=i(s,this);var o=s.indices;o&&(o.groups=i(o,this))}return s},n.prototype[Symbol.replace]=function(r,s){if(typeof s=="string"){var o=e.get(this);return t[Symbol.replace].call(this,r,s.replace(/\$<([^>]+)(>|$)/g,(function(c,d,l){if(l==="")return c;var h=o[d];return Array.isArray(h)?"$"+h.join("$"):typeof h=="number"?"$"+h:""})))}if(typeof s=="function"){var a=this;return t[Symbol.replace].call(this,r,(function(){var c=arguments;return typeof c[c.length-1]!="object"&&(c=[].slice.call(c)).push(i(c,a)),s.apply(this,c)}))}return t[Symbol.replace].call(this,r,s)},_S.apply(this,arguments)}const o0=new class extends qe{constructor(){super(...arguments),tn(this,"currentUploadLogID",0)}reportLogUploadError(t){const{errorRange:e}=t;e[e.length-1]&&e[e.length-1]>this.currentUploadLogID&&(this.currentUploadLogID=e[e.length-1],this.emit("REPORT_LOG_UPLOAD",t))}};class f8{constructor(e){tn(this,"logger",void 0),tn(this,"prefixLists",[]),this.logger=e}debug(){for(var e=arguments.length,n=new Array(e),i=0;i<e;i++)n[i]=arguments[i];this.logger.debug(...this.prefixLists,...n)}info(){for(var e=arguments.length,n=new Array(e),i=0;i<e;i++)n[i]=arguments[i];this.logger.info(...this.prefixLists,...n)}warning(){for(var e=arguments.length,n=new Array(e),i=0;i<e;i++)n[i]=arguments[i];this.logger.warning(...this.prefixLists,...n)}error(){for(var e=arguments.length,n=new Array(e),i=0;i<e;i++)n[i]=arguments[i];this.logger.error(...this.prefixLists,...n)}prefix(e){return this.prefixLists.push(e),this}popPrefix(){return this.prefixLists.pop(),this}}function fS(){const t=new Date;return t.toTimeString().split(" ")[0]+":"+t.getMilliseconds()}function a0(){const t=new Date,e=/((\d+:){2}\d+)/.exec(new Date().toUTCString());return e?e?.[0]+":"+t.getUTCMilliseconds():t.toTimeString().split(" ")[0]+":"+t.getMilliseconds()}const wr={DEBUG:0,INFO:1,WARNING:2,ERROR:3,NONE:4},Zp=Date.now(),cu=t=>{for(const e in wr)if(Object.prototype.hasOwnProperty.call(wr,e)&&wr[e]===t)return e;return"DEFAULT"},m=new class{constructor(){tn(this,"proxyServerURL",void 0),tn(this,"logLevel",wr.DEBUG),tn(this,"uploadState","collecting"),tn(this,"uploadLogWaitingList",[]),tn(this,"uploadLogUploadingList",[]),tn(this,"uploadErrorCount",0),tn(this,"currentLogID",0),tn(this,"url",void 0),tn(this,"extLog",((t,e)=>{this.appendLogToWaitingList(t,...e)}))}debug(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];const i=[wr.DEBUG].concat(e);this.log.apply(this,i)}info(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];const i=[wr.INFO].concat(e);this.log.apply(this,i)}warning(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];const i=[wr.WARNING].concat(e);this.log.apply(this,i)}warn(){this.warning(...arguments)}error(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];const i=[wr.ERROR].concat(e);this.log.apply(this,i)}upload(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];const i=[wr.DEBUG].concat(e);this.uploadLog.apply(this,i)}setLogLevel(t){t=Math.min(Math.max(0,t),4),this.logLevel=t}enableLogUpload(){ye("UPLOAD_LOG",!0)}disableLogUpload(){ye("UPLOAD_LOG",!1),this.uploadLogUploadingList=[],this.uploadLogWaitingList=[]}setProxyServer(t){this.proxyServerURL=t}prefix(t){return new f8(this).prefix(t)}log(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];if(Date.now()-Zp<100)return void setTimeout((()=>{this.log(...e)}),Date.now()-Zp);const i=Math.max(0,Math.min(4,e[0]));if(e[0]=fS()+" Agora-SDK [".concat(cu(i),"]:"),this.appendLogToWaitingList(i,...e),i<this.logLevel)return;const r=fS()+" %cAgora-SDK [".concat(cu(i),"]:");let s=[];if(!I("USE_NEW_LOG"))switch(i){case wr.DEBUG:s=[r,"color: #64B5F6;"].concat(e.slice(1)),console.log.apply(console,s);break;case wr.INFO:s=[r,"color: #1E88E5; font-weight: bold;"].concat(e.slice(1)),console.log.apply(console,s);break;case wr.WARNING:s=[r,"color: #FB8C00; font-weight: bold;"].concat(e.slice(1)),console.warn.apply(console,s);break;case wr.ERROR:s=[r,"color: #B00020; font-weight: bold;"].concat(e.slice(1)),console.error.apply(console,s)}}uploadLog(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];if(Date.now()-Zp<100)return void setTimeout((()=>{this.uploadLog(...e)}),Date.now()-Zp);const i=Math.max(0,Math.min(4,e[0]));e[0]=fS()+" Agora-SDK [".concat(cu(i),"]:"),this.appendLogToWaitingList(i,...e)}appendLogToWaitingList(t){if(!I("UPLOAD_LOG"))return;for(var e=arguments.length,n=new Array(e>1?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];Array.isArray(n[0])?n[0][0]=a0()+" Agora-SDK [".concat(cu(t),"]:"):n[0]=a0()+" Agora-SDK [".concat(cu(t),"]:");let r="";n.forEach((s=>{typeof s=="object"&&(s=JSON.stringify(s)),r+="".concat(s," ")})),this.uploadLogWaitingList.push({payload_str:r,log_level:t,log_item_id:this.currentLogID++}),this.uploadState==="uploading"&&this.uploadLogUploadingList.length===0&&this.uploadLogInterval()}startUpload(){this.uploadState="uploading",this.uploadLogUploadingList.length===0&&this.uploadLogInterval()}async uploadLogs(){const t=this.uploadLogUploadingList,e={sdk_version:Ar,process_id:I("PROCESS_ID"),payload:JSON.stringify(t)};return Rs((async()=>{const n=await yi.post(this.url||(this.proxyServerURL?"https://".concat(this.proxyServerURL,"/ls/?h=").concat(I("LOG_UPLOAD_SERVER"),"&p=443&d=upload/v1"):"https://".concat(I("LOG_UPLOAD_SERVER"),"/upload/v1")),e,{responseType:"text"});if(n.data!=="OK"){const i=new Error("unexpected upload log response");throw i.response=n,i}}),(()=>(this.uploadLogUploadingList=[],!1)),(n=>{const i={status:-1,message:n.message,errorRange:t.map((r=>r.log_item_id))};return n.response?(i.status=n.response.status,i.data=n.response.data,i.headers=n.response.headers):n.request&&(i.status=n.request.status),o0.reportLogUploadError(i),!0}),{timeout:I("UPLOAD_LOG_REQUEST_RETRY_INTERVAL"),maxRetryTimeout:I("UPLOAD_LOG_REQUEST_MAX_RETRY_INTERVAL")})}uploadLogInterval(){this.uploadLogUploadingList.length===0&&this.uploadLogWaitingList.length===0||(this.uploadLogUploadingList.length===0&&(this.uploadLogUploadingList=this.uploadLogWaitingList.splice(0,I("UPLOAD_LOG_LENGTH_EACH_TIME"))),this.uploadLogs().then((()=>{this.uploadErrorCount=0,this.uploadLogWaitingList.length>0&&window.setTimeout((()=>this.uploadLogInterval()),I("UPLOAD_LOG_INTERVAL"))})).catch((t=>{this.uploadErrorCount+=1,this.uploadErrorCount<2?window.setTimeout((()=>this.uploadLogInterval()),I("UPLOAD_LOG_TWICE_RETRY_INTERVAL_V1")):window.setTimeout((()=>this.uploadLogInterval()),I("UPLOAD_LOG_RETRY_INTERVAL_V1"))})))}};var c0;function m8(t){return Kn(t.reportId,"params.reportId",0,100,!1),Kn(t.category,"params.category",0,100,!1),Kn(t.event,"params.event",0,100,!1),Kn(t.label,"params.label",0,100,!1),Oe(t.value,"params.value",Number.MIN_SAFE_INTEGER,Number.MAX_SAFE_INTEGER,!1),!0}(c0={}).FREE="free",c0.UPLOADING="uploading",(function(t){t[t.MISC=0]="MISC",t[t.INTERNAL_EVENT=1]="INTERNAL_EVENT",t[t.PUBLIC_EVENT=2]="PUBLIC_EVENT",t[t.WEB_EVENT=3]="WEB_EVENT",t[t.INTERNAL_API=4]="INTERNAL_API",t[t.WEB_API=5]="WEB_API",t[t.PUBLIC_API=6]="PUBLIC_API"})({});const E8={sid:"",lts:0,success:null,cname:null,uid:null,peer:null,cid:null,elapse:null,extend:null,vid:0};let vn=(function(t){return t.PUBLISH="publish",t.SUBSCRIBE="subscribe",t.WS_COMPRESSOR_INIT="ws_compressor_init",t.SESSION_INIT="session_init",t.JOIN_CHOOSE_SERVER="join_choose_server",t.RTE_DETAIL="rte_detail_stats",t.REQ_USER_ACCOUNT="req_user_account",t.JOIN_GATEWAY="join_gateway",t.REJOIN_GATEWAY="rejoin_gateway",t.STREAM_SWITCH="stream_switch",t.REQUEST_PROXY_WORKER_MANAGER="request_proxy_worker_manager",t.REQUEST_PROXY_APPCENTER="request_proxy_appcenter",t.FIRST_VIDEO_RECEIVED="first_video_received",t.FIRST_AUDIO_RECEIVED="first_audio_received",t.FIRST_VIDEO_DECODE="first_video_decode",t.FIRST_AUDIO_DECODE="first_audio_decode",t.XLA_PEER_FIRST_VIDEO_FRAME="xla_peer_first_video_frame",t.ON_ADD_AUDIO_STREAM="on_add_audio_stream",t.ON_ADD_VIDEO_STREAM="on_add_video_stream",t.ON_UPDATE_STREAM="on_update_stream",t.ON_REMOVE_STREAM="on_remove_stream",t.USER_ANALYTICS="req_user_analytics",t.PC_STATS="pc_stats",t.UPDATE_REMOTE_RTPCAPABILITIES="update_remote_rtpCapabilities",t.AB_TEST="ab_test",t})({}),We=(function(t){return t.SESSION="io.agora.pb.Wrtc.Session",t.JOIN_CHOOSE_SERVER="io.agora.pb.Wrtc.JoinChooseServer",t.RTE_DETAIL="io.agora.pb.Wrtc.RteDetailStats",t.REQ_USER_ACCOUNT="io.agora.pb.Wrtc.ReqUserAccount",t.JOIN_GATEWAY="io.agora.pb.Wrtc.JoinGateway",t.RE_JOIN_GATEWAY="io.agora.pb.Wrtc.ReJoinGateway",t.PUBLISH="io.agora.pb.Wrtc.Publish",t.SUBSCRIBE="io.agora.pb.Wrtc.Subscribe",t.WS_COMPRESSOR_INIT="io.agora.pb.Wrtc.WsCompressorInit",t.STREAM_SWITCH="io.agora.pb.Wrtc.StreamSwitch",t.AUDIO_SENDING_STOPPED="io.agora.pb.Wrtc.AudioSendingStopped",t.VIDEO_SENDING_STOPPED="io.agora.pb.Wrtc.VideoSendingStopped",t.REQUEST_PROXY_APPCENTER="io.agora.pb.Wrtc.RequestProxyAppCenter",t.REQUEST_PROXY_WORKER_MANAGER="io.agora.pb.Wrtc.RequestProxyWorkerManager",t.API_INVOKE="io.agora.pb.Wrtc.ApiInvoke",t.FIRST_VIDEO_RECEIVED="io.agora.pb.Wrtc.FirstVideoReceived",t.FIRST_AUDIO_RECEIVED="io.agora.pb.Wrtc.FirstAudioReceived",t.FIRST_VIDEO_DECODE="io.agora.pb.Wrtc.FirstVideoDecode",t.FIRST_AUDIO_DECODE="io.agora.pb.Wrtc.FirstAudioDecode",t.XLA_PEER_FIRST_VIDEO_FRAME="io.agora.pb.Wrtc.XLAPeerFirstVideoFrame",t.ON_ADD_AUDIO_STREAM="io.agora.pb.Wrtc.OnAddAudioStream",t.ON_ADD_VIDEO_STREAM="io.agora.pb.Wrtc.OnAddVideoStream",t.ON_UPDATE_STREAM="io.agora.pb.Wrtc.OnUpdateStream",t.ON_REMOVE_STREAM="io.agora.pb.Wrtc.OnRemoveStream",t.JOIN_CHANNEL_TIMEOUT="io.agora.pb.Wrtc.JoinChannelTimeout",t.PEER_PUBLISH_STATUS="io.agora.pb.Wrtc.PeerPublishStatus",t.WORKER_EVENT="io.agora.pb.Wrtc.WorkerEvent",t.AP_WORKER_EVENT="io.agora.pb.Wrtc.APWorkerEvent",t.JOIN_WEB_PROXY_AP="io.agora.pb.Wrtc.JoinWebProxyAP",t.WEBSOCKET_QUIT="io.agora.pb.Wrtc.WebSocketQuit",t.USER_ANALYTICS="io.agora.pb.Wrtc.UserAnalytics",t.AUTOPLAY_FAILED="io.agora.pb.Wrtc.AutoplayFailed",t.PC_STATS="io.agora.pb.Wrtc.PCStats",t.UPDATE_REMOTE_RTPCAPABILITIES="io.agora.pb.Wrtc.UpdateRemoteRTPCapabilities",t.AB_TEST="io.agora.pb.Wrtc.ABTest",t})({});(function(t){t[t.WORKER_EVENT=156]="WORKER_EVENT",t[t.AP_WORKER_EVENT=160]="AP_WORKER_EVENT"})({});let g8=(function(t){return t[t.SESSION=26]="SESSION",t[t.JOIN_CHOOSE_SERVER=27]="JOIN_CHOOSE_SERVER",t[t.REQ_USER_ACCOUNT=196]="REQ_USER_ACCOUNT",t[t.JOIN_GATEWAY=28]="JOIN_GATEWAY",t[t.PUBLISH=30]="PUBLISH",t[t.SUBSCRIBE=29]="SUBSCRIBE",t[t.WS_COMPRESSOR_INIT=9430]="WS_COMPRESSOR_INIT",t[t.STREAM_SWITCH=32]="STREAM_SWITCH",t[t.AUDIO_SENDING_STOPPED=33]="AUDIO_SENDING_STOPPED",t[t.VIDEO_SENDING_STOPPED=34]="VIDEO_SENDING_STOPPED",t[t.REQUEST_PROXY_APPCENTER=35]="REQUEST_PROXY_APPCENTER",t[t.REQUEST_PROXY_WORKER_MANAGER=36]="REQUEST_PROXY_WORKER_MANAGER",t[t.API_INVOKE=41]="API_INVOKE",t[t.FIRST_VIDEO_RECEIVED=348]="FIRST_VIDEO_RECEIVED",t[t.FIRST_AUDIO_RECEIVED=349]="FIRST_AUDIO_RECEIVED",t[t.FIRST_VIDEO_DECODE=350]="FIRST_VIDEO_DECODE",t[t.FIRST_AUDIO_DECODE=351]="FIRST_AUDIO_DECODE",t[t.ON_ADD_AUDIO_STREAM=352]="ON_ADD_AUDIO_STREAM",t[t.ON_ADD_VIDEO_STREAM=353]="ON_ADD_VIDEO_STREAM",t[t.ON_UPDATE_STREAM=356]="ON_UPDATE_STREAM",t[t.ON_REMOVE_STREAM=355]="ON_REMOVE_STREAM",t[t.JOIN_CHANNEL_TIMEOUT=407]="JOIN_CHANNEL_TIMEOUT",t[t.PEER_PUBLISH_STATUS=408]="PEER_PUBLISH_STATUS",t[t.WORKER_EVENT=156]="WORKER_EVENT",t[t.AP_WORKER_EVENT=160]="AP_WORKER_EVENT",t[t.JOIN_WEB_PROXY_AP=700]="JOIN_WEB_PROXY_AP",t[t.WEBSOCKET_QUIT=671]="WEBSOCKET_QUIT",t[t.USER_ANALYTICS=1e4]="USER_ANALYTICS",t[t.AUTOPLAY_FAILED=9178]="AUTOPLAY_FAILED",t})({});function At(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return function(e,n,i){const r=i.value;if(typeof r=="function"){const s=t.className||e.__className__||(e.constructor.name==="AgoraRTCClient"?"Client":e.constructor.name);i.value=function(){for(var o,a=arguments.length,c=new Array(a),d=0;d<a;d++)c[d]=arguments[d];let l=c;if(t.argsMap)try{l=t.argsMap(this,...c)}catch(p){m.warning(p),l=[]}try{JSON.stringify(l)}catch{m.warning("arguments for method ".concat(s,".").concat(String(n)," not serializable for apiInvoke.")),l=[]}const h=(t.report||pt).reportApiInvoke(this._sessionId||null,{id:this._clientId||((o=this.store)===null||o===void 0?void 0:o.clientId)||this._ID,name:"".concat(s,".").concat(String(n)),options:l,tag:Ne.TRACER,reportResult:t.reportResult},t.throttleTime);try{const p=r.apply(this,c);return p instanceof st?p.then((f=>(h.onSuccess(t.reportResult&&f),f))).catch((f=>{throw h.onError(f),f})):(h.onSuccess(t.reportResult&&p),p)}catch(p){throw h.onError(p),p}}}return i}}const pt=new class{constructor(){tn(this,"baseInfoMap",new Map),tn(this,"proxyServer",void 0),tn(this,"eventUploadTimer",void 0),tn(this,"setSessionIdTimer",void 0),tn(this,"url",void 0),tn(this,"sids",new Set),tn(this,"backupUrl",void 0),tn(this,"_appId",void 0),tn(this,"_aid",0),tn(this,"keyEventUploadPendingItems",[]),tn(this,"normalEventUploadPendingItems",[]),tn(this,"apiInvokeUploadPendingItems",[]),tn(this,"apiInvokeCount",0),tn(this,"apiInvokeLoggedCount",0),tn(this,"ltsList",[]),tn(this,"lastSendNormalEventTime",Date.now()),tn(this,"customReportCounterTimer",void 0),tn(this,"customReportCount",0),tn(this,"extApiInvoke",(async t=>{for(const e of t){const n=Gt(Gt({},e),{},{sid:null,invokeId:++this.apiInvokeCount,tag:Ne.TRACER});this.sendApiInvoke(n)}})),this.eventUploadTimer=window.setInterval(this.doSend.bind(this),I("EVENT_REPORT_SEND_INTERVAL")),this.setSessionIdTimer=window.setInterval(this.appendSessionId.bind(this),I("EVENT_REPORT_SEND_INTERVAL"))}getBaseInfoBySessionId(t){return this.baseInfoMap.get(t)}setAppId(t){this._appId=t,this._aid=parseInt(t.replace(/[a-fA-F0-9]{8}/g,(e=>{let[n,i]=e;return n+i})),16)||0}reportApiInvoke(t,e,n){e.timeout=e.timeout||6e4,e.reportResult=e.reportResult===void 0||e.reportResult;const i=Date.now();this.apiInvokeCount+=1;const r=this.apiInvokeCount,s=!!I("SHOW_REPORT_INVOKER_LOG"),o=!!I("SHOW_REPORT_USER_INVOKER_LOG"),a=s||o&&e.id;a&&(this.apiInvokeLoggedCount+=1);const c=this.apiInvokeLoggedCount;function d(f,v){if(a){let S="[apiInvoke-".concat(c,"]");if(e.id&&(S+="[".concat(e.id,"]")),e.name&&(S+="[".concat(e.name,"]"),e.name===Ge.JOIN))return m.info("".concat(S," ").concat(f));m.info("".concat(S," ").concat(f),f==="start"?e.options:v||"")}}const l=()=>({tag:e.tag,invokeId:r,sid:t,name:e.name,apiInvokeTime:i,options:e.options,states:e.states||null});d("start");let h=!1;Nn(e.timeout).then((()=>{h||(this.sendApiInvoke(Gt(Gt({},l()),{},{error:A.API_INVOKE_TIMEOUT,success:!1})),d("timeout"))}));const p=new H(A.UNEXPECTED_ERROR,"".concat(e.name,": this api invoke is end"));return{onSuccess:f=>{const v=()=>{if(h)throw p;return h=!0,this.sendApiInvoke(Gt(Gt({},l()),{},{success:!0},e.reportResult&&{result:f})),d("onSuccess"),f};return n?GO(v,e.name+"Success",n,(()=>h=!0)):v()},onError:f=>{const v=()=>{if(h)throw f;h=!0,this.sendApiInvoke(Gt(Gt({},l()),{},{success:!1,error:f})),d("onFailure",f.toString())};return n?GO(v,e.name+"Error",n,(()=>h=!0)):v()}}}_send(t,e,n){this.send({type:t,data:e},n)}_sendApiInvoke(t){return this.sendApiInvoke(t)}sessionInit(t,e){if(this.baseInfoMap.has(t))return;const n=Date.now(),i=this.createBaseInfo(t,n);i.cname=e.cname,i.rteUrl=e.rteUrl;const r=Object.assign({},{willUploadConsoleLog:I("UPLOAD_LOG"),maxTouchPoints:navigator.maxTouchPoints,areaVersion:dS?"global":"oversea",areas:I("AREAS")&&I("AREAS").join(",")},e.extend),{stringUid:s,channelProfile:o,channelMode:a,isABTestSuccess:c,lsid:d,clientRole:l}=e,h=Date.now(),p=Gt(Gt({},i),{},{eventType:vn.SESSION_INIT,appid:e.appid,browser:navigator.userAgent,buildFormat:e.buildFormat,build:uS,lts:h,elapse:h-n,extend:JSON.stringify(r),mode:e.mode,process:I("PROCESS_ID"),appType:I("APP_TYPE"),success:!0,version:Ar,stringUid:s,channelProfile:o,channelMode:a,isABTestSuccess:c,lsid:d,clientType:$(f=window.navigator.userAgent).call(f,"AgoraWebView")?42:20,clientRole:l,serviceId:I("PROCESS_ID"),extensionID:I("PLUGIN_INFO").join(",")||"",rteUrl:e.rteUrl,rteSid:e.rteSid});var f;this.send({type:We.SESSION,data:p},!0)}reportRteDetail(t){const e=this.baseInfoMap.get(t);if(!e)return;const n=e.info,i=Date.now(),r=Gt(Gt({},n),{},{eventType:vn.RTE_DETAIL,lts:i,success:!0,elapse:i-e.startTime,vid:n.vid===void 0?0:Number(n.vid),ua:navigator.userAgent});this.send({type:We.RTE_DETAIL,data:r},!0)}joinChooseServer(t,e){const n=this.baseInfoMap.get(t);if(!n)return;const i=n.info;e.vid&&(i.vid=e.vid);const r=Date.now(),s=Gt(Gt({},i),{},{role:e.role,eventType:vn.JOIN_CHOOSE_SERVER,lts:r,eventElapse:e.elapse||r-e.lts,chooseServerAddr:e.csAddr,errorCode:e.ec,elapse:r-n.startTime,success:e.succ,chooseServerAddrList:JSON.stringify(e.serverList),uid:e.uid?parseInt(e.uid):null,cid:e.cid?parseInt(e.cid):null,chooseServerIp:e.csIp||"",opid:e.opid,unilbsServerIds:e.unilbsServerIds,extend:e.extend||void 0,isHttp3:e.isHttp3,corssRegionTagReq:e.corssRegionTagReq||void 0,corssRegionTagRes:e.corssRegionTagRes||void 0,ua:navigator.userAgent,resourceTimingInfo:e.resourceTimingInfo||void 0});this.send({type:We.JOIN_CHOOSE_SERVER,data:s},!0)}reqUserAccount(t,e){const n=this.baseInfoMap.get(t);if(!n)return;const i=n.info,r=Date.now(),s=Gt(Gt({},i),{},{eventType:vn.REQ_USER_ACCOUNT,lts:r,success:e.success,serverAddress:e.serverAddr,stringUid:e.stringUid,uid:e.uid,errorCode:e.errorCode,elapse:e.elapse||r-n.startTime,eventElapse:r-e.lts,extend:JSON.stringify(e.extend)});this.send({type:We.REQ_USER_ACCOUNT,data:s},!0)}joinGateway(t,e){const n=this.baseInfoMap.get(t);if(!n)return;const i=n.info;e.vid&&(i.vid=e.vid),i.uid=e.uid,i.cid=e.cid;const r=Date.now(),{firstSuccess:s,addr:o,isProxy:a}=e,c=r-n.startTime,d=Gt(Gt({},i),{},{eventType:vn.JOIN_GATEWAY,lts:r,gatewayAddr:e.addr,success:e.succ,errorCode:e.ec,errorMsg:e.errorMsg||"",elapse:c,eventElapse:r-e.lts,firstSuccess:s,signalChannel:e.signalChannel,preload:e.preload?1:0,installId:cS(),isABTestSuccess:e.isABTestSuccess?1:0,gatewayIp:null,gatewayPort:null,isProxy:a?1:0}),l=d.success?1:0;if(e.succ&&(n.lastJoinSuccessTime=r),o)if(d.signalChannel==="1"){const h=_S(/(\d+\.\d+\.\d+\.\d+):(\d+)/,{ip:1,port:2}),p=o.match(h);d.gatewayIp=p&&p.groups?p.groups.ip:"",d.gatewayPort=p&&p.groups?p.groups.port:""}else if(a){const h=o.match(/h=(\d{1,3}-){3}\d{1,3}/g),p=o.match(/p=[0-9]{1,6}/g);d.gatewayIp=h&&h.length?h[0].split("=")[1].replace(/-/g,"."):"",d.gatewayPort=p&&p.length?p[0].split("=")[1]:""}else{const h=o.match(/wss:\/\/(\d{1,3}-){3}\d{1,3}/g),p=o.match(/(:|p=)[0-9]{1,6}/g);d.gatewayIp=h&&h.length?h[0].split("//")[1].replace(/-/g,"."):"",d.gatewayPort=p&&p.length?p[0].split(/:|p=/g)[1]:""}if(s)this.send({type:We.JOIN_GATEWAY,data:d},!0);else{let h={isSuccess:l,port:d.gatewayPort};delete d.success,delete d.eventType,delete d.firstSuccess,delete d.gatewayPort,d.vid=Number(d.vid);const p=Object.assign({},d,h,{eventType:vn.REJOIN_GATEWAY});this.send({type:We.RE_JOIN_GATEWAY,data:p},!0)}}joinChannelTimeout(t,e){const n=this.baseInfoMap.get(t);if(!n)return;const i=Date.now(),r=Gt(Gt({},n.info),{},{lts:i,timeout:e,elapse:i-n.startTime});this.send({type:We.JOIN_CHANNEL_TIMEOUT,data:r},!0)}publish(t,e){const n=this.baseInfoMap.get(t);if(!n)return;const i=n.info,r=Date.now(),s=Gt(Gt({},i),{},{eventType:vn.PUBLISH,lts:r,eventElapse:e.eventElapse,elapse:r-n.startTime,success:e.succ,errorCode:e.ec,videoName:e.videoName,audioName:e.audioName,screenName:e.screenName,screenshare:e.screenshare,audio:e.audio,video:e.video,p2pid:e.p2pid,publishRequestid:e.publishRequestid});this.send({type:We.PUBLISH,data:s},!0)}subscribe(t,e,n){const i=this.baseInfoMap.get(t);if(!i)return;const r=i.info,s=Date.now(),o=Gt(Gt({},r),{},{eventType:vn.SUBSCRIBE,lts:s,eventElapse:e.eventElapse,elapse:s-i.startTime,success:e.succ,errorCode:e.ec,video:e.video,audio:e.audio,subscribeRequestid:e.subscribeRequestid,p2pid:e.p2pid,preSsrc:e.preSsrc?1:0},n&&{extend:JSON.stringify({isMassSubscribe:!0})});typeof e.peerid=="string"?o.peerSuid=e.peerid:o.peer=e.peerid,this.send({type:We.SUBSCRIBE,data:o},!0)}wsCompressorInit(t){var e;const n=[...oi(e=this.baseInfoMap).call(e)],i=n.length?n[0]:"UnableToGetSid",r=this.baseInfoMap.get(i);if(!r)return;const s=r.info,o=Date.now(),a=Gt(Gt({},s),{},{eventType:vn.WS_COMPRESSOR_INIT,lts:o,eventElapse:t.eventElapse,elapse:o-r.startTime,status:t.status?1:2});this.send({type:We.WS_COMPRESSOR_INIT,data:a},!0)}firstXLAPeerFirstVideoFrame(t,e){const n=this.baseInfoMap.get(t);if(!n)return;const i=n.info,r=Date.now(),s=e.peerPubStatusMs-(n.lastJoinSuccessTime||r),o=Gt(Gt({},i),{},{elapse:r-n.startTime,eventType:vn.XLA_PEER_FIRST_VIDEO_FRAME,lts:r,peer:e.peer,width:e.width,height:e.height,ssrc:e.ssrc,p2pid:e.p2pid,peerPublishDuration:e.peerPublishDuration,joinChannelSuccessElapse:s,peerPubStatusMs:e.peerPubStatusMs-e.joinChannelStart,availablePublish:e.peerPublishDuration>s?1:0,preloadStart:Math.max(e.preloadStart-e.joinChannelStart,0),preloadEnd:Math.max(e.preloadEnd-e.joinChannelStart,0),encrypt:Math.max(e.apStart-e.joinChannelStart,0),ap:Math.max(e.apEnd-e.joinChannelStart,0),sua:Math.max(e.suaEnd-e.joinChannelStart,0),beforeConnect:Math.max(e.beforeConnect-e.joinChannelStart,0),peerRecevier:Math.max(e.peerReceiver-e.joinChannelStart,0),ice:Math.max(e.ice-e.joinChannelStart,0),pc:Math.max(e.pc-e.joinChannelStart,0),signalConnected:Math.max(e.signalConnected-e.joinChannelStart,0),joinReq:Math.max(e.joinReq-e.joinChannelStart,0),joinRes:Math.max(e.joinRes-e.joinChannelStart,0),userJoinNotify:Math.max(e.userJoinNotify-e.joinChannelStart,0),videoSsrcNotify:Math.max(e.videoAddNotify-e.joinChannelStart,0),subscribeDelayMs:Math.max(e.subscribeStart-e.videoAddNotify,0),subscribeStart:Math.max(e.subscribeStart-e.joinChannelStart,0),subscribeEnd:Math.max(e.subscribeEnd-e.joinChannelStart,0),firstReceived:Math.max(e.firstReceived-e.joinChannelStart,0),firstDecoded:Math.max(e.firstDecoded-e.joinChannelStart,0),firstPreRender:Math.max(e.firstPreRender-e.joinChannelStart,0),firstRender:Math.max(e.firstRender-e.joinChannelStart,0),playDelayMs:Math.max(e.playStart-e.subscribeEnd,0),playStart:Math.max(e.playStart-e.joinChannelStart,0),playEnd:Math.max(e.playEnd-e.joinChannelStart,0),isPreSub:e.isPreSub?1:0,isPrePc:e.isPrePc?1:0,isPreInstantVideo:e.isPreInstantVideo?1:0,firstReceivedEncodedFrame:e.firstReceivedEncodedFrame?Math.max(e.firstReceivedEncodedFrame-e.joinChannelStart,0):void 0,frameType:e.frameType||"",rtpTimestamp:e.rtpTimestamp||0,framePayloadType:e.framePayloadType||0,frameDataLength:e.frameDataLength||0,mimeType:e.mimeType||""});this.send({type:We.XLA_PEER_FIRST_VIDEO_FRAME,data:o},!0)}firstRemoteVideoDecode(t,e,n,i){const r=this.baseInfoMap.get(t);if(!r)return;const s=r.info,o=Date.now(),a=Gt(Gt(Gt({},s),i),{},{elapse:o-r.startTime,eventType:e,lts:o,firstDecodeFrame:Math.max((i.firstFrame||o)-r.startTime,0),apEnd:Math.max(i.apEnd-r.startTime,0),apStart:Math.max(i.apStart-r.startTime,0),joinGwEnd:Math.max(i.joinGwEnd-r.startTime,0),joinGwStart:Math.max(i.joinGwStart-r.startTime,0),pcEnd:Math.max(i.pcEnd-r.startTime,0),pcStart:Math.max(i.pcStart-r.startTime,0),subscriberEnd:Math.max(i.subscriberEnd-r.startTime,0),subscriberStart:Math.max(i.subscriberStart-r.startTime,0),videoAddNotify:Math.max(i.videoAddNotify-r.startTime,0)});this.send({type:n,data:a},!0)}firstRemoteFrame(t,e,n,i){const r=this.baseInfoMap.get(t);if(!r)return;const s=r.info,o=Date.now(),a=Gt(Gt(Gt({},s),i),{},{elapse:o-r.startTime,eventType:e,lts:o});this.send({type:n,data:a},!0)}abTest(t,e){const n=this.baseInfoMap.get(t);if(!n)return;const i=n.info,r=Date.now(),s=Gt(Gt(Gt({},i),e),{},{vid:i.vid===void 0?0:Number(i.vid),elapse:r-n.startTime,eventType:vn.AB_TEST,lts:r});this.send({type:We.AB_TEST,data:s},!0)}pcStats(t,e){const n=this.baseInfoMap.get(t);if(!n)return;const i=n.info,r=Date.now(),s=Gt(Gt(Gt({},i),e),{},{vid:i.vid===void 0?0:Number(i.vid),elapse:r-n.startTime,eventType:vn.PC_STATS,lts:r,preallocation:e.preallocation?1:0});this.send({type:We.PC_STATS,data:s},!0)}updateRemoteRTPCapabilities(t,e){if(t){const n=this.baseInfoMap.get(t);if(!n)return;const i=n.info,r=Date.now(),s=Gt(Gt(Gt({},i),e),{},{vid:i.vid===void 0?0:Number(i.vid),eventType:vn.UPDATE_REMOTE_RTPCAPABILITIES,lts:r});this.send({type:We.UPDATE_REMOTE_RTPCAPABILITIES,data:s},!0)}}onGatewayStream(t,e,n,i){const r=this.baseInfoMap.get(t);if(!r)return;const s=r.info,o=Date.now(),a=Gt(Gt(Gt({},s),i),{},{eventType:e,lts:o});this.send({type:n,data:a},!0)}streamSwitch(t,e){const n=this.baseInfoMap.get(t);if(!n)return;const i=n.info,r=Date.now(),s=Gt(Gt({},i),{},{eventType:vn.STREAM_SWITCH,lts:r,isDual:e.isdual,elapse:r-n.startTime,success:e.succ});this.send({type:We.STREAM_SWITCH,data:s},!0)}requestProxyAppCenter(t,e){const n=this.baseInfoMap.get(t);if(!n)return;const i=n.info,r=Date.now(),s=Gt(Gt({},i),{},{eventType:vn.REQUEST_PROXY_APPCENTER,lts:r,eventElapse:r-e.lts,elapse:r-n.startTime,APAddr:e.APAddr,workerManagerList:e.workerManagerList,response:e.response,errorCode:e.ec,success:e.succ});this.send({type:We.REQUEST_PROXY_APPCENTER,data:s},!0)}requestProxyWorkerManager(t,e){const n=this.baseInfoMap.get(t);if(!n)return;const i=n.info,r=Date.now(),s=Gt(Gt({},i),{},{eventType:vn.REQUEST_PROXY_WORKER_MANAGER,lts:r,eventElapse:r-e.lts,elapse:r-n.startTime,workerManagerAddr:e.workerManagerAddr,response:e.response,errorCode:e.ec,success:e.succ});this.send({type:We.REQUEST_PROXY_WORKER_MANAGER,data:s},!0)}setProxyServer(t){this.proxyServer=t,t?m.debug("reportProxyServerurl: ".concat(t)):m.debug("disable reportProxyServerurl: ".concat(t))}peerPublishStatus(t,e){const n=this.baseInfoMap.get(t);if(!n)return;const i=n.info,r=Date.now(),s=Gt(Gt({},i),{},{subscribeElapse:e.subscribeElapse,peer:e.peer,peerPublishDuration:Math.max(e.audioPublishDuration,e.videoPublishDuration),audiotag:e.audioPublishDuration>0?1:-1,videotag:e.videoPublishDuration>0?1:-1,lts:r,elapse:r-n.startTime,joinChannelSuccessElapse:r-(n.lastJoinSuccessTime||r),peerPublishDurationVideo:e.videoPublishDuration,peerPublishDurationAudio:e.audioPublishDuration});this.send({type:We.PEER_PUBLISH_STATUS,data:s},!0)}workerEvent(t,e){const n=this.baseInfoMap.get(t);if(!n)return;const i=n.info,r=Date.now();(function(s,o,a){const c=s[o];if(!c||typeof c!="string")return[s];s[o]="";const d=Qs(JSON.stringify(s));let l=0;const h=[];let p=0;for(let f=0;f<c.length;f++)p+=c.charCodeAt(f)<=127?1:3,p<=a-d||(h[h.length]=nt(nt({},s),{},{[o]:c.substring(l,f)}),l=f,p=c.charCodeAt(f)<=127?1:3);return l!==c.length-1&&(h[h.length]=nt(nt({},s),{},{[o]:c.substring(l)})),h})(Gt(Gt(Gt({},i),e),{},{elapse:r-n.startTime,lts:r,productType:"WebRTC"}),"payload",1300).forEach((s=>this.send({type:We.WORKER_EVENT,data:s},!0)))}apworkerEvent(t,e){const n=this.baseInfoMap.get(t);if(!n)return;const i=n.info,r=Date.now(),s=Gt(Gt(Gt({},i),e),{},{elapse:r-n.startTime,lts:r});this.send({type:We.AP_WORKER_EVENT,data:s},!0)}joinWebProxyAP(t,e){const n=this.baseInfoMap.get(t);if(!n)return;const i=n.info,r=Date.now(),s=Gt(Gt(Gt({},i),e),{},{elapse:r-n.startTime,lts:r,extend:e.extend||void 0});this.send({type:We.JOIN_WEB_PROXY_AP,data:s},!0)}WebSocketQuit(t,e){const n=this.baseInfoMap.get(t);if(!n)return;const i=n.info,r=Date.now(),s=Gt(Gt(Gt({},i),e),{},{elapse:r-n.startTime,lts:r});this.send({type:We.WEBSOCKET_QUIT,data:s},!0)}async sendCustomReportMessage(t,e){if(this.customReportCount+=e.length,this.customReportCount>I("CUSTOM_REPORT_LIMIT"))throw new H(A.CUSTOM_REPORT_FREQUENCY_TOO_HIGH);this.customReportCounterTimer||(this.customReportCounterTimer=window.setInterval((()=>{this.customReportCount=0}),5e3));const n=Date.now(),i=e.map((r=>({type:We.USER_ANALYTICS,data:Gt(Gt({sid:t},r),{},{lts:n})})));try{I("NEW_REPORT_SERVER")?await this.postDataToStatsCollector2(i):await this.postDataToStatsCollector(i)}catch(r){throw m.error("send custom report message failed",r.toString()),new H(A.CUSTOM_REPORT_SEND_FAILED,r.message)}}sendApiInvoke(t){const e=I("NOT_REPORT_EVENT");if(t.tag&&$(e)&&$(e).call(e,t.tag))return!1;if(t.sid===null)return this.apiInvokeUploadPendingItems.push(t),!1;const n=this.baseInfoMap.get(t.sid);if(!n)return this.apiInvokeUploadPendingItems.push(t),!1;const{cname:i,uid:r,cid:s}=n.info;let o;if(t.lts=t.lts||Date.now(),t.error)if(t.error instanceof H){const{code:c,message:d}=t.error;o=c||d||t.error.toString()}else o=t.error.toString();const a={invokeId:t.invokeId,sid:t.sid,cname:i,cid:s,uid:r,lts:t.lts,success:t.success,elapse:t.lts-n.startTime,execElapse:t.lts-t.apiInvokeTime,apiName:t.name,options:t.options?JSON.stringify(t.options):void 0,execStates:t.states?JSON.stringify(t.states):void 0,execResult:t.result?JSON.stringify(t.result):void 0,errorCode:t.error?o:void 0,errorMsg:t.error?JSON.stringify(t.error):void 0};return this.send({type:We.API_INVOKE,data:a},!1),!0}addSid(t){this.sids.add(t)}removeSid(t){this.sids.delete(t)}appendSessionId(){const t=this.apiInvokeUploadPendingItems;if(t.length===0)return;const e=Array.from(this.sids).find((n=>n!==null));e&&t.forEach((n=>{n&&(n.sid=e,this.sendApiInvoke(Object.assign({},n)))})),t.length=0}send(t,e){if(e)return this.keyEventUploadPendingItems.push(t),void this.sendItems(this.keyEventUploadPendingItems,!0);this.normalEventUploadPendingItems.push(t),this.normalEventUploadPendingItems.length>I("NORMAL_EVENT_QUEUE_CAPACITY")&&this.normalEventUploadPendingItems.splice(0,1),this.normalEventUploadPendingItems.length>=10&&this.sendItems(this.normalEventUploadPendingItems,!1)}doSend(){this.keyEventUploadPendingItems.length>0&&this.sendItems(this.keyEventUploadPendingItems,!0),this.normalEventUploadPendingItems.length>0&&Date.now()-this.lastSendNormalEventTime>=5e3&&this.sendItems(this.normalEventUploadPendingItems,!1)}sendItems(t,e){const n=[],i=[];for(;t.length;){const s=t.shift();n.length<20?n.push(s):i.push(s)}t.push(...i);for(const s of[...n]){var r;this.ltsList.indexOf(s.data.lts)!==-1?(s.data.lts=this.ltsList[this.ltsList.length-1]+1,this.ltsList.push(s.data.lts)):(this.ltsList.push(s.data.lts),Fa(r=this.ltsList).call(r,((o,a)=>o-a)))}return e||(this.lastSendNormalEventTime=Date.now()),I("ENABLE_EVENT_REPORT")&&n.length&&(I("NEW_REPORT_SERVER")?this.postDataToStatsCollector2(n):this.postDataToStatsCollector(n)).catch((s=>o=>{I("EVENT_REPORT_RETRY")&&(e?this.keyEventUploadPendingItems=this.keyEventUploadPendingItems.concat(s):(this.normalEventUploadPendingItems=this.normalEventUploadPendingItems.concat(s),this.normalEventUploadPendingItems.length>I("NORMAL_EVENT_QUEUE_CAPACITY")&&(this.normalEventUploadPendingItems.splice(0,this.normalEventUploadPendingItems.length-I("NORMAL_EVENT_QUEUE_CAPACITY")),m.warning("report: drop normal events"))))})(n)),t}async postDataToStatsCollector2(t){$e.networkState===mi.OFFLINE&&await st.race([$e.onlineWaiter,Nn(2*fn.maxRetryTimeout)]);const e=r=>{let s=new Uint8Array;return r.forEach((o=>{const a=zg(JSON.stringify(o.data)),c=new ArrayBuffer(5),d=(h=>{let p=0;return Object.entries(We).forEach((f=>{let[v,S]=f;S===h.type&&(p=g8[v])})),p})(o),l=new DataView(c);l.setUint16(0,a.byteLength,!0),l.setUint8(2,255&d),l.setUint8(3,d>>>8&255),l.setUint8(4,d>>>16&255),s=PO(s,new Uint8Array(c)),s=PO(s,a)})),s},n="event";let i=this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(I("NEW_REPORT_SERVER_DOMAINS")[0],"&p=443&d=").concat(n):"https://".concat(I("NEW_REPORT_SERVER_DOMAINS")[0],"/").concat(n);for(let r=0;r<2;r+=1){r===1&&(i=this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(I("NEW_REPORT_SERVER_DOMAINS")[1],"&p=443&d=").concat(n):"https://".concat(I("NEW_REPORT_SERVER_DOMAINS")[1],"/").concat(n));try{await rS(i,{timeout:1e4,data:e(t),headers:Gt(Gt({biz:"webrtc",sendts:Math.round(Date.now()/1e3),debug:"false"},this._appId&&{appid:this._appId}),{},{"Content-Type":"application/octet-stream"})},!0)}catch(s){if(r===1)throw s;continue}return}}async postDataToStatsCollector(t){let e=arguments.length>1&&arguments[1]!==void 0&&arguments[1];const n=(a=>{const c=a&&a.data.sid&&this.baseInfoMap.get(a.data.sid);return c&&c.info.vid&&+c.info.vid||0})(t[0]),i=n?void 0:this._aid,r={msgType:"EventMessages",sentTs:Math.round(Date.now()/1e3),payloads:t.map((a=>JSON.stringify(a))),vid:n,aid:i};$e.networkState===mi.OFFLINE&&await st.race([$e.onlineWaiter,Nn(2*fn.maxRetryTimeout)]);const s=e?"/events/proto-raws":"/events/messages";let o=this.url||(this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(I("EVENT_REPORT_DOMAIN"),"&p=").concat(I("STATS_COLLECTOR_PORT"),"&d=").concat(s):"https://".concat(I("EVENT_REPORT_DOMAIN"),":").concat(I("STATS_COLLECTOR_PORT")).concat(s));for(let a=0;a<2;a+=1){a===1&&(o=this.backupUrl||(this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(I("EVENT_REPORT_BACKUP_DOMAIN"),"&p=").concat(I("STATS_COLLECTOR_PORT"),"&d=").concat(s):"https://".concat(I("EVENT_REPORT_BACKUP_DOMAIN"),":").concat(I("STATS_COLLECTOR_PORT")).concat(s)));try{e?await i8(o,{timeout:1e4,data:r}):await rS(o,{timeout:1e4,data:r})}catch(c){if(a===1)throw c;continue}return}}createBaseInfo(t,e){const n=Object.assign({},E8);return n.sid=t,this.baseInfoMap.set(t,{info:n,startTime:e}),n}reportResourceTiming(t,e){const n=performance.getEntriesByName(t),i=n[n.length-1];i&&this.reportApiInvoke(e,{name:"Client.resourceTiming",options:i,tag:Ne.TRACER}).onSuccess()}};o0.on("REPORT_LOG_UPLOAD",(t=>{t.networkState=$e.networkState,pt.reportApiInvoke(null,{name:"logUploadError",options:t,tag:Ne.TRACER}).onSuccess("logUploadError")}));let B=class extends H{constructor(t){super(t,arguments.length>1&&arguments[1]!==void 0?arguments[1]:"",arguments.length>2?arguments[2]:void 0),tn(this,"name","AgoraRTCException")}print(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"error";return super.print(t,m)}throw(){super.throw(m)}};const Dn={getDisplayMedia:!1,getStreamFromExtension:!1,supportUnifiedPlan:!1,supportMinBitrate:!1,supportSetRtpSenderParameters:!1,supportDualStream:!0,webAudioMediaStreamDest:!1,supportReplaceTrack:!1,supportWebGL:!1,webAudioWithAEC:!1,supportRequestFrame:!1,supportShareAudio:!1,supportDualStreamEncoding:!1,supportDataChannel:!1,supportPCSetConfiguration:!1,supportWebRTCEncodedTransform:!1,supportWebRTCInsertableStream:!1,supportRequestVideoFrameCallback:!1,supportWebCrypto:!1,supportSuppressLocalAudioPlayback:!1,supportRestrictOwnAudio:!1};function Jt(){return Dn}function d0(){return"setSinkId"in HTMLAudioElement.prototype&&(!I("RESTRICTION_SET_PLAYBACK_DEVICE")||(Ao()||EO())&&!bO())}function $p(){return!Dn.supportUnifiedPlan||I("CHROME_FORCE_PLAN_B")&&Js()}function du(t){return!(xe()||gO(87)||$p()||!I("ENABLE_PRE_SUB")&&(t==null||!t.autoSubscribe||I("FORCE_DISABLE_AUTO_SUB")))}function l0(t){return I("ENABLE_INSTANT_VIDEO")?I("ENABLE_INSTANT_VIDEO"):!(t==null||!t.autoSubscribe||I("FORCE_DISABLE_AUTO_SUB"))}function u0(){return navigator.mediaDevices&&"getSupportedConstraints"in navigator.mediaDevices}function h0(){if(u0()){const t=navigator.mediaDevices.getSupportedConstraints();return!(!("suppressLocalAudioPlayback"in t)||!t.suppressLocalAudioPlayback)}return Xs(141)||za(141)||Xa(141)}function p0(){if(u0()){const t=navigator.mediaDevices.getSupportedConstraints();return!(!("restrictOwnAudio"in t)||!t.restrictOwnAudio)}return Xs(141)||za(141)||Xa(125)}let Yn=(function(t){return t.IOS_15_16_INTERRUPTION_START="ios15_16-interruption-start",t.IOS_15_16_INTERRUPTION_END="ios15_16-interruption-end",t.IOS_INTERRUPTION_START="ios-interruption-start",t.IOS_INTERRUPTION_END="ios-interruption-end",t.STATE_CHANGE="state-change",t})({});function bd(t,e,n){return{sampleRate:t,stereo:e,bitrate:n}}function le(t,e,n,i,r){return{width:t,height:e,frameRate:n,bitrateMin:i,bitrateMax:r}}function es(t,e,n,i,r){return{width:{max:t},height:{max:e},frameRate:n,bitrateMin:i,bitrateMax:r}}function mS(t,e){return{numSpatialLayers:t,numTemporalLayers:e}}const S8={"90p":le(160,90),"90p_1":le(160,90),"120p":le(160,120,15,30,65),"120p_1":le(160,120,15,30,65),"120p_3":le(120,120,15,30,50),"120p_4":le(212,120),"180p":le(320,180,15,30,140),"180p_1":le(320,180,15,30,140),"180p_3":le(180,180,15,30,100),"180p_4":le(240,180,15,30,120),"240p":le(320,240,15,40,200),"240p_1":le(320,240,15,40,200),"240p_3":le(240,240,15,40,140),"240p_4":le(424,240,15,40,220),"360p":le(640,360,15,80,400),"360p_1":le(640,360,15,80,400),"360p_3":le(360,360,15,80,260),"360p_4":le(640,360,30,80,600),"360p_6":le(360,360,30,80,400),"360p_7":le(480,360,15,80,320),"360p_8":le(480,360,30,80,490),"360p_9":le(640,360,15,80,800),"360p_10":le(640,360,24,80,800),"360p_11":le(640,360,24,80,1e3),"480p":le(640,480,15,100,500),"480p_1":le(640,480,15,100,500),"480p_2":le(640,480,30,100,1e3),"480p_3":le(480,480,15,100,400),"480p_4":le(640,480,30,100,750),"480p_6":le(480,480,30,100,600),"480p_8":le(848,480,15,100,610),"480p_9":le(848,480,30,100,930),"480p_10":le(640,480,10,100,400),"720p":le(1280,720,15,120,1130),"720p_auto":le(1280,720,30,900,3e3),"720p_1":le(1280,720,15,120,1130),"720p_2":le(1280,720,30,120,2e3),"720p_3":le(1280,720,30,120,1710),"720p_5":le(960,720,15,120,910),"720p_6":le(960,720,30,120,1380),"1080p":le(1920,1080,15,120,2080),"1080p_1":le(1920,1080,15,120,2080),"1080p_2":le(1920,1080,30,120,3e3),"1080p_3":le(1920,1080,30,120,3150),"1080p_5":le(1920,1080,60,120,4780),"1440p":le(2560,1440,30,120,4850),"1440p_1":le(2560,1440,30,120,4850),"1440p_2":le(2560,1440,60,120,7350),"4k":le(3840,2160,30,120,8910),"4k_1":le(3840,2160,30,120,8910),"4k_3":le(3840,2160,60,120,13500)},T8={"480p":es(640,480,5),"480p_1":es(640,480,5),"480p_2":es(640,480,30),"480p_3":es(640,480,15),"720p":es(1280,720,5),"720p_auto":le(1280,720,30,900,3e3),"720p_1":es(1280,720,5),"720p_2":es(1280,720,30),"720p_3":es(1280,720,15),"1080p":es(1920,1080,5),"1080p_1":es(1920,1080,5),"1080p_2":es(1920,1080,30),"1080p_3":es(1920,1080,15)},R8={"1SL1TL":mS(1,1),"3SL3TL":mS(3,3),"2SL3TL":mS(2,3)};function ns(t){return t||(t="480p_1"),typeof t=="string"?Object.assign({},S8[t]):t}function ES(t){return typeof t=="string"?Object.assign({},T8[t]):t}function t_(t){return typeof t=="string"?Object.assign({},R8[t]):t}const v8={speech_low_quality:bd(16e3,!1),speech_standard:bd(32e3,!1,18),music_standard:bd(48e3,!1),standard_stereo:bd(48e3,!0,56),high_quality:bd(48e3,!1,128),high_quality_stereo:bd(48e3,!0,192)};function e_(t){return typeof t=="string"?Object.assign({},v8[t]):t}const rc=[];function _0(t){return _n(t,"mediaSource",["screen","window","application"]),!0}let _t=(function(t){return t.NEED_RENEGOTIATE="@need_renegotiate",t.NEED_REPLACE_TRACK="@need_replace_track",t.NEED_REPLACE_MIXING_TRACK="@need_replace_mixing_track",t.NEED_CLOSE="@need_close",t.NEED_ENABLE_TRACK="@need_enable_track",t.NEED_DISABLE_TRACK="@need_disable_track",t.NEED_SESSION_ID="@need_sid",t.SET_OPTIMIZATION_MODE="@set_optimization_mode",t.GET_STATS="@get_stats",t.GET_RTC_STATS="@get_rtc_stats",t.GET_LOW_VIDEO_TRACK="@get_low_video_track",t.NEED_RESET_REMOTE_SDP="@need_reset_remote_sdp",t.NEED_UPDATE_VIDEO_ENCODER="@need_update_video_encoder",t.NEED_UPDATE_VIDEO_SEND_PARAMETERS="@need_update_video_send_parameters",t.NEED_MUTE_TRACK="@need_mute_track",t.NEED_UNMUTE_TRACK="@need_unmute_track",t})({}),Ee=(function(t){return t.SCREEN_TRACK="screen_track",t.CUSTOM_TRACK="custome_track",t.LOW_STREAM="low_stream",t.SCREEN_LOW_TRACK="screen_low_track",t})({}),Ad=(function(t){return t[t.HIGH_STREAM=0]="HIGH_STREAM",t[t.LOW_STREAM=1]="LOW_STREAM",t})({}),C8=(function(t){return t[t.HIGH_STREAM=0]="HIGH_STREAM",t[t.LOW_STREAM=1]="LOW_STREAM",t[t.HIGH_STREAM_LAYER1=4]="HIGH_STREAM_LAYER1",t[t.HIGH_STREAM_LAYER2=5]="HIGH_STREAM_LAYER2",t[t.HIGH_STREAM_LAYER3=6]="HIGH_STREAM_LAYER3",t[t.HIGH_STREAM_LAYER4=7]="HIGH_STREAM_LAYER4",t[t.HIGH_STREAM_LAYER5=8]="HIGH_STREAM_LAYER5",t[t.HIGH_STREAM_LAYER6=9]="HIGH_STREAM_LAYER6",t})({}),y8=(function(t){return t[t.DISABLE=0]="DISABLE",t[t.LOW_STREAM=1]="LOW_STREAM",t[t.AUDIO_ONLY=2]="AUDIO_ONLY",t[t.HIGH_STREAM_LAYER1=3]="HIGH_STREAM_LAYER1",t[t.HIGH_STREAM_LAYER2=4]="HIGH_STREAM_LAYER2",t[t.HIGH_STREAM_LAYER3=5]="HIGH_STREAM_LAYER3",t[t.HIGH_STREAM_LAYER4=6]="HIGH_STREAM_LAYER4",t[t.HIGH_STREAM_LAYER5=7]="HIGH_STREAM_LAYER5",t[t.HIGH_STREAM_LAYER6=8]="HIGH_STREAM_LAYER6",t})({}),sc=(function(t){return t.TRANSCEIVER_UPDATED="transceiver-updated",t.SEI_TO_SEND="sei-to-send",t.SEI_RECEIVED="sei-received",t.TRACK_UPDATED="track-updated",t})({}),wd=(function(t){return t.SOURCE_STATE_CHANGE="source-state-change",t.TRACK_ENDED="track-ended",t.BEAUTY_EFFECT_OVERLOAD="beauty-effect-overload",t.VIDEO_ELEMENT_VISIBLE_STATUS="video-element-visible-status",t.CLOSED="closed",t})({}),Or=(function(t){return t.FIRST_FRAME_DECODED="first-frame-decoded",t.VIDEO_ELEMENT_VISIBLE_STATUS="video-element-visible-status",t.VIDEO_STATE_CHANGED="video-state-changed",t.PLAY_START="play-start",t.PLAY_END="play-end",t.FIRST_FRAME_RENDER="first-frame-render",t})({}),Od=(function(t){return t.AUDIO="audio",t.VIDEO="video",t.DATA="data",t})({}),hr=(function(t){return t.AUDIO_SOURCE_STATE_CHANGE="audio_source_state_change",t.RECEIVE_TRACK_BUFFER="receive_track_buffer",t.ON_AUDIO_BUFFER="on_audio_buffer",t.UPDATE_SOURCE="update_source",t})({});(function(t){t.UPDATE_TRACK_SOURCE="update-track-source"})({});const gS={sendVolumeLevel:0,sendBitrate:0,sendBytes:0,sendPackets:0,sendPacketsLost:0,sendJitterMs:0,sendRttMs:0,currentPacketLossRate:0},SS={sendBytes:0,sendBitrate:0,sendPackets:0,sendPacketsLost:0,sendJitterMs:0,sendRttMs:0,sendResolutionHeight:0,sendResolutionWidth:0,captureResolutionHeight:0,captureResolutionWidth:0,targetSendBitrate:0,totalDuration:0,totalFreezeTime:0,currentPacketLossRate:0},f0={transportDelay:0,end2EndDelay:0,receiveBitrate:0,receiveLevel:0,receiveBytes:0,receiveDelay:0,receivePackets:0,receivePacketsLost:0,receivePacketsDiscarded:0,totalDuration:0,totalFreezeTime:0,freezeRate:0,packetLossRate:0,currentPacketLossRate:0,publishDuration:-1},I8={uplinkNetworkQuality:0,downlinkNetworkQuality:0},m0={transportDelay:0,end2EndDelay:0,receiveBitrate:0,receiveBytes:0,receiveDelay:0,receivePackets:0,receivePacketsLost:0,receiveResolutionHeight:0,receiveResolutionWidth:0,totalDuration:0,totalFreezeTime:0,freezeRate:0,packetLossRate:0,currentPacketLossRate:0,publishDuration:-1};let gi=(function(t){return t.ON_TRACK="on_track",t.ON_NODE="on_node",t})({}),pr=(function(t){return t.REQUEST_UPDATE_CONSTRAINTS="request_update_constraints",t.REQUEST_CONSTRAINTS="request_constraints",t})({}),lu=(function(t){return t.IDLE="IDLE",t.INITING="INITING",t.INITEND="INITEND",t})({}),oc=(function(t){return t.STATE_CHANGE="state_change",t.RECORDING_DEVICE_CHANGED="recordingDeviceChanged",t.PLAYOUT_DEVICE_CHANGED="playoutDeviceChanged",t.CAMERA_DEVICE_CHANGED="cameraDeviceChanged",t})({}),ti=(function(t){return t.NONE="none",t.INIT="init",t.CANPLAY="canplay",t.PLAYING="playing",t.PAUSED="paused",t.SUSPEND="suspend",t.STALLED="stalled",t.WAITING="waiting",t.ERROR="error",t.DESTROYED="destroyed",t.ABORT="abort",t.ENDED="ended",t.EMPTIED="emptied",t.LOADEDDATA="loadeddata",t})({}),Zs=(function(t){return t[t.VideoStateStopped=0]="VideoStateStopped",t[t.VideoStateStarting=1]="VideoStateStarting",t[t.VideoStateDecoding=2]="VideoStateDecoding",t[t.VideoStateFrozen=3]="VideoStateFrozen",t})({});const TS={uninit:100,none:110,init:120,loadeddata:130,canplay:200,playing:210,paused:220,suspend:300,stalled:310,waiting:320,error:330,destroyed:340,abort:350,ended:360,emptied:370};let n_=(function(t){return t.OPEN="open",t.MESSAGE="message",t.CLOSE="close",t.CLOSING="closing",t.ERROR="error",t})({});function re(t,e,n,i,r){var s,o,a={};return Object.keys(i).forEach((function(c){a[c]=i[c]})),a.enumerable=!!a.enumerable,a.configurable=!!a.configurable,("value"in a||a.initializer)&&(a.writable=!0),a=Ir(s=Hv(o=n.slice()).call(o)).call(s,(function(c,d){return d(t,e,c)||c}),a),r&&a.initializer!==void 0&&(a.value=a.initializer?a.initializer.call(r):void 0,a.initializer=void 0),a.initializer===void 0?(Object.defineProperty(t,e,a),null):a}function j(t,e,n){return(e=(function(i){var r=(function(s,o){if(typeof s!="object"||!s)return s;var a=s[Symbol.toPrimitive];if(a!==void 0){var c=a.call(s,"string");if(typeof c!="object")return c;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(s)})(i);return typeof r=="symbol"?r:r+""})(e))in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function E0(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable}))),n.push.apply(n,i)}return n}function Ue(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?E0(Object(n),!0).forEach((function(i){j(t,i,n[i])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):E0(Object(n)).forEach((function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i))}))}return t}class g0 extends qe{set _mediaStreamTrack(e){e!==this.mediaStreamTrack&&(this.safeEmit(sc.TRACK_UPDATED,e),this.mediaStreamTrack=e)}get _mediaStreamTrack(){return this.mediaStreamTrack}constructor(e,n){super(),j(this,"trackMediaType",void 0),j(this,"_ID",void 0),j(this,"_rtpTransceiver",void 0),j(this,"_lowRtpTransceiver",void 0),j(this,"_hints",[]),j(this,"_isClosed",!1),j(this,"_originMediaStreamTrack",void 0),j(this,"mediaStreamTrack",void 0),j(this,"_external",{}),this._ID=n||Se(8,"track-"),this._originMediaStreamTrack=e,this.mediaStreamTrack=e,(function(i){$(rc).call(rc,i)||rc.push(i)})(this)}toString(){return this._ID}getTrackId(){return this._ID}getMediaStreamTrack(e){return e||oa((()=>{var n;pt.reportApiInvoke(null,{name:Ge.GET_MEDIA_STREAM_TRACK,options:[],tag:Ne.TRACER}).onSuccess(((n=this._mediaStreamTrack)===null||n===void 0?void 0:n.label)||"")}),this.mediaStreamTrack.id||this.getTrackId()),this._mediaStreamTrack}getRTCRtpTransceiver(e){return e===Ad.LOW_STREAM?this._lowRtpTransceiver:this._rtpTransceiver}getMediaStreamTrackSettings(){return this.getMediaStreamTrack(!0).getSettings()}close(){this._isClosed=!0,this._lowRtpTransceiver=void 0,this._rtpTransceiver=void 0,(function(e){const n=rc.indexOf(e);n!==-1&&rc.splice(n,1)})(this),this.emit(wd.CLOSED),this.removeAllListeners(sc.SEI_RECEIVED)}_updateRtpTransceiver(e,n){if(n===Ad.LOW_STREAM){if(this._lowRtpTransceiver===e)return;this._lowRtpTransceiver=e}else{if(this._rtpTransceiver===e)return;this._rtpTransceiver=e}this.emit(sc.TRANSCEIVER_UPDATED,e,n)}}class Nd extends g0{get isExternalTrack(){return this._isExternalTrack}get muted(){return this._muted}get enabled(){return this._enabled}get processorContext(){return this._processorContext}constructor(e,n){super(e,n),j(this,"_enabled",!0),j(this,"_muted",!1),j(this,"_isExternalTrack",!1),j(this,"_isClosed",!1),j(this,"_enabledMutex",void 0),j(this,"processor",void 0),j(this,"_processorContext",void 0),j(this,"_handleTrackEnded",(()=>{this.onTrackEnded()})),this._enabledMutex=new Un("".concat(this.getTrackId())),e.addEventListener("ended",this._handleTrackEnded)}getTrackLabel(){var e,n;return(e=(n=this._originMediaStreamTrack)===null||n===void 0?void 0:n.label)!==null&&e!==void 0?e:""}close(){this._isClosed||(this.stop(),this._originMediaStreamTrack.stop(),this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack.stop(),this._mediaStreamTrack=null),this._originMediaStreamTrack=null,this._enabledMutex=null,m.debug("[".concat(this.getTrackId(),"] close")),this.emit(_t.NEED_CLOSE),super.close())}async _updateOriginMediaStreamTrack(e,n){let i=arguments.length>2&&arguments[2]!==void 0&&arguments[2];this._isExternalTrack=i,e!==this._originMediaStreamTrack&&(this._originMediaStreamTrack&&(this._originMediaStreamTrack.removeEventListener("ended",this._handleTrackEnded),n&&this._originMediaStreamTrack.stop()),e.addEventListener("ended",this._handleTrackEnded),this._originMediaStreamTrack=e,this._muted&&(this._originMediaStreamTrack.enabled=!1),this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await Pe(this,_t.NEED_REPLACE_TRACK,this),this.processor&&this._processorContext&&this.processor.updateInput({track:this._originMediaStreamTrack,context:this._processorContext}))}_getDefaultPlayerConfig(){return{}}onTrackEnded(){m.debug("[".concat(this.getTrackId(),"] track ended")),this.safeEmit(wd.TRACK_ENDED)}stateCheck(e,n){if(m.debug("check track state, [muted: ".concat(this._muted,", enabled: ").concat(this._enabled,"] to [").concat(e,": ").concat(n,"]")),Zr(n,e),this._enabled&&this._muted&&e==="enabled"&&n===!1)throw new H(A.TRACK_STATE_UNREACHABLE,"cannot set enabled while the track is muted").print("error",m);if(!this._enabled&&!this._muted&&e==="muted"&&n===!0)throw new H(A.TRACK_STATE_UNREACHABLE,"cannot set muted while the track is disabled").print("error",m)}getProcessorStats(){return this._processorContext&&this._processorContext.gatherStats()||[]}getProcessorUsage(){return this._processorContext?this._processorContext.gatherUsage():st.resolve([])}}const S0=window.AudioContext||window.webkitAudioContext;let RS,_r=null;const Ie=new class extends qe{constructor(){super(...arguments),j(this,"prevState",void 0),j(this,"curState",void 0),j(this,"currentTime",void 0),j(this,"currentTimeStuckAt",void 0),j(this,"interruptDetectorTrack",void 0),j(this,"onLocalAudioTrackMute",(()=>{m.info("ios15-interruption-start"),this.emit(Yn.IOS_15_16_INTERRUPTION_START)})),j(this,"onLocalAudioTrackUnmute",(async()=>{m.info("ios15-interruption-end"),this.curState!=="running"||this.duringInterruption?m.info("ios15-interruption-end-canceled"):(_r&&await _r.suspend(),this.emit(Yn.IOS_15_16_INTERRUPTION_END))}))}get duringInterruption(){return this.prevState==="running"&&this.curState==="interrupted"}bindInterruptDetectorTrack(t){m.debug("webaudio bindInterruptDetectorTrack ".concat(t.getTrackId())),this.interruptDetectorTrack||(this.interruptDetectorTrack=t,this.interruptDetectorTrack._mediaStreamTrack.onmute=this.onLocalAudioTrackMute,this.interruptDetectorTrack._mediaStreamTrack.onunmute=this.onLocalAudioTrackUnmute)}unbindInterruptDetectorTrack(t){m.debug("webaudio unbindInterruptDetectorTrack ".concat(t.getTrackId())),this.interruptDetectorTrack&&this.interruptDetectorTrack===t&&(this.interruptDetectorTrack._mediaStreamTrack&&(this.interruptDetectorTrack._mediaStreamTrack.onmute=null,this.interruptDetectorTrack._mediaStreamTrack.onunmute=null),this.interruptDetectorTrack=void 0)}};function Dd(){if(!_r){if((function(){if(!S0)return void m.error("your browser is not support web audio");m.info("create audio context");const t=Ue({},I("WEBAUDIO_INIT_OPTIONS"));m.debug("audio context init option:",JSON.stringify(t)),_r=new S0(t),Ie.curState=_r.state,_r.onstatechange=()=>{Ie.prevState=Ie.curState,Ie.curState=_r?_r.state:void 0;const{prevState:e,curState:n}=Ie,i=n==="running",r=n==="interrupted",s=e==="running",o=e==="suspended",a=e==="interrupted",c=de().osVersion;(si()||Qr())&&s&&r&&(m.info("ios".concat(c,"-interruption-start")),Ie.emit(Yn.IOS_INTERRUPTION_START)),(si()||Qr())&&(o||a)&&i&&(m.info("ios".concat(c,"-interruption-end")),Ie.emit(Yn.IOS_INTERRUPTION_END)),e!==n&&Ie.emit(Yn.STATE_CHANGE,n,e)},setInterval((()=>{var e;const n=(e=_r)===null||e===void 0?void 0:e.currentTime;Ie.currentTime!==n?(Ie.currentTimeStuckAt&&(m.debug("AudioContext current time resume at ".concat(n)),Ie.currentTimeStuckAt=void 0),Ie.currentTime=n):(n!==Ie.currentTimeStuckAt&&(pt.reportApiInvoke(null,{name:"WEB_AUDIO_CURRENT_TIME_STUCK",options:{currentTime:n},tag:Ne.TRACER}).onSuccess(),m.warning("AudioContext current time stuck at ".concat(n))),Ie.currentTimeStuckAt=n)}),5e3),(async function(e){const n=["click","contextmenu","auxclick","dblclick","mousedown","mouseup","touchend","keydown","keyup"];let i,r,s=!1,o=!1,a=!1;function c(b){e.state==="running"?d(!1):si()||Qr()?e.state==="suspended"&&(d(!0),b&&e.resume().then(l,l)):e.state!=="closed"&&(d(!0),b&&e.resume().then(l,l))}function d(b){if(s!==b){s=b;for(let w=0,D=n;w<D.length;w+=1){const k=D[w];b?window.addEventListener(k,h,{capture:!0,passive:!0}):window.removeEventListener(k,h,{capture:!0,passive:!0})}}}function l(){c(!1)}function h(){c(!0)}function p(){let b;try{b=i.play(),b?b.then(S,S):(i.addEventListener("playing",S),i.addEventListener("abort",S),i.addEventListener("error",S))}catch{S()}}function f(b){a||(i.paused?b?(v(!1),a=!0,p()):v(!0):v(!1))}function v(b){if(o!==b){o=b;for(let w=0,D=n;w<D.length;w++){const k=D[w];b?window.addEventListener(k,T,{capture:!0,passive:!0}):window.removeEventListener(k,T,{capture:!0,passive:!0})}}}function S(){i.removeEventListener("playing",S),i.removeEventListener("abort",S),i.removeEventListener("error",S),a=!1,f(!1)}function T(){f(!0)}if(si()&&I("IOS_BG_TAG")){const b=e.createMediaStreamDestination(),w=document.createElement("div");w.innerHTML="<audio x-webkit-airplay='deny'></audio>",i=w.children.item(0),i.controls=!1,i.disableRemotePlayback=!0,i.preload="auto",i.srcObject=b.stream,r=()=>{if(I("IOS_AUTO_RESTART_BG_TAG")&&i&&i.srcObject&&!a&&(!i.paused||o!==!0)){i.paused||i.pause();try{a=!0,p()}catch{a=!1}return!0}},f(!0)}return Ie.on(Yn.STATE_CHANGE,(function(){c(!0)})),c(!1),r})(_r).then((e=>{RS=e}))})(),!_r)throw new H(A.NOT_SUPPORTED,"can not create audio context");return _r}return _r}function ac(t){if((function(){if(vS!==null)return vS;const i=Dd(),r=i.createBufferSource(),s=i.createGain(),o=i.createGain();r.connect(s),r.connect(o),r.disconnect(s);let a=!1;try{r.disconnect(s)}catch{a=!0}return r.disconnect(),vS=a,a})())return;const e=t.connect,n=t.disconnect;t.connect=(i,r,s)=>{var o;return t._inputNodes||(t._inputNodes=[]),$(o=t._inputNodes).call(o,i)||(i instanceof AudioNode?(t._inputNodes.push(i),e.call(t,i,r,s)):e.call(t,i,r)),t},t.disconnect=(i,r,s)=>{n.call(t),i?Wp(t._inputNodes,i):t._inputNodes=[];for(const o of t._inputNodes)e.call(t,o)}}let vS=null;function CS(t,e){let n=!1;const i=1/e;if(I("DISABLE_WEBAUDIO")){const r=window.setInterval((()=>{n?window.clearInterval(r):t(performance.now()/1e3)}),1e3*i)}else{const r=Dd();let s=r.createGain();s.gain.value=0,s.connect(r.destination);const o=()=>{if(n)return void(s=null);const a=r.createOscillator();a.onended=o,a.connect(s),a.start(0),a.stop(r.currentTime+i),t(r.currentTime)};o()}return()=>{n=!0}}class T0{constructor(){j(this,"context",void 0),j(this,"analyserNode",void 0),j(this,"sourceNode",void 0),this.context=Dd(),this.analyserNode=this.context.createAnalyser(),this.analyserNode.fftSize=2048,this.analyserNode.smoothingTimeConstant=.4}updateSource(e){if(e!==this.sourceNode){if(this.sourceNode)try{this.sourceNode.disconnect(this.analyserNode)}catch{}this.sourceNode=e,e?.connect(this.analyserNode)}}getVolumeLevel(){if(!this.sourceNode||(!this.context||si()||Qr()||this.context.state!=="running"&&this.context.resume(),!this.analyserNode))return 0;const e=new Float32Array(this.analyserNode.fftSize);if(this.analyserNode.getFloatTimeDomainData)this.analyserNode.getFloatTimeDomainData(e);else{const i=new Uint8Array(this.analyserNode.fftSize);this.analyserNode.getByteTimeDomainData(i);for(let r=0;r<e.length;++r)e[r]=i[r]/128-1}const n=Ir(e).call(e,((i,r)=>i+r*r),0)/e.length;return Math.max(10*Math.log10(n)+100,0)/100}getAnalyserNode(){return this.analyserNode}rebuildAnalyser(){try{var e,n;(e=this.sourceNode)===null||e===void 0||e.disconnect(this.analyserNode),this.analyserNode=this.context.createAnalyser(),this.analyserNode.fftSize=2048,this.analyserNode.smoothingTimeConstant=.4,(n=this.sourceNode)===null||n===void 0||n.connect(this.analyserNode)}catch{m.warning("rebuild analyser node failed.")}}destroy(){this.updateSource(void 0)}}class R0 extends qe{get processSourceNode(){return this.sourceNode}set processedNode(e){var n;if(!this.isDestroyed&&this._processedNode!==e){try{var i;(i=this.sourceNode)===null||i===void 0||i.disconnect(this.outputNode)}catch{}(n=this._processedNode)===null||n===void 0||n.disconnect(),this._processedNode=e,this.connect()}}get processedNode(){return this._processedNode}constructor(){super(),j(this,"outputNode",void 0),j(this,"outputTrack",void 0),j(this,"isPlayed",!1),j(this,"sourceNode",void 0),j(this,"context",void 0),j(this,"audioBufferNode",void 0),j(this,"destNode",void 0),j(this,"audioOutputLevel",0),j(this,"volumeLevelAnalyser",void 0),j(this,"_processedNode",void 0),j(this,"playNode",void 0),j(this,"isDestroyed",!1),j(this,"onNoAudioInput",void 0),j(this,"isNoAudioInput",!1),j(this,"_noAudioInputCount",0),this.context=Dd(),this.playNode=this.context.destination,this.outputNode=this.context.createGain(),ac(this.outputNode),this.volumeLevelAnalyser=new T0}startGetAudioBuffer(e){this.audioBufferNode||(this.audioBufferNode=this.context.createScriptProcessor(e),this.outputNode.connect(this.audioBufferNode),this.audioBufferNode.connect(this.context.destination),this.audioBufferNode.onaudioprocess=n=>{this.emit(hr.ON_AUDIO_BUFFER,(function(i){for(let r=0;r<i.outputBuffer.numberOfChannels;r+=1){const s=i.outputBuffer.getChannelData(r);for(let o=0;o<s.length;o+=1)s[o]=0}return i.inputBuffer})(n))})}stopGetAudioBuffer(){this.audioBufferNode&&(this.audioBufferNode.onaudioprocess=null,this.outputNode.disconnect(this.audioBufferNode),this.audioBufferNode=void 0)}createOutputTrack(){if(!Jt().webAudioMediaStreamDest)throw new H(A.NOT_SUPPORTED,"your browser is not support audio processor");return this.destNode&&this.outputTrack||(this.destNode=this.context.createMediaStreamDestination(),this.outputNode.connect(this.destNode),this.outputTrack=this.destNode.stream.getAudioTracks()[0]),this.outputTrack}play(e){this.context.state!=="running"&&Hp((()=>{Ie.emit("autoplay-failed")})),this.isPlayed=!0,this.playNode=e||this.context.destination,this.outputNode.connect(this.playNode)}stop(){if(this.isPlayed)try{this.outputNode.disconnect(this.playNode)}catch{}this.isPlayed=!1}getAccurateVolumeLevel(){return this.volumeLevelAnalyser.getVolumeLevel()}async checkHasAudioInput(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:0;if(e>5)return this.isNoAudioInput=!0,this.onNoAudioInput&&this.onNoAudioInput(),!1;si()||Qr()?this.context.state==="suspended"&&this.context.resume():this.context.state!=="running"&&this.context.resume();const n=this.volumeLevelAnalyser.getAnalyserNode();let i;n.getFloatTimeDomainData?(i=new Float32Array(n.fftSize),n.getFloatTimeDomainData(i)):(i=new Uint8Array(n.fftSize),n.getByteTimeDomainData(i));let r=!1;for(let s=0;s<i.length;s++)i[s]!==0&&(r=!0);return r?(this.isNoAudioInput=!1,!0):(await Nn(200),await this.checkHasAudioInput(e?e+1:1)&&r)}getAudioVolume(){return this.outputNode.gain.value}setVolume(e){this.outputNode.gain.setValueAtTime(e,this.context.currentTime)}destroy(){this.disconnect(),this.stop(),this.isDestroyed=!0,this.onNoAudioInput=void 0}disconnect(){var e,n;(e=this.processedNode)===null||e===void 0||e.disconnect(),(n=this.sourceNode)===null||n===void 0||n.disconnect(),this.outputNode&&this.outputNode.disconnect()}connect(){var e;this.processedNode?(e=this.processedNode)===null||e===void 0||e.connect(this.outputNode):this.sourceNode&&this.sourceNode.connect(this.outputNode),this.volumeLevelAnalyser.updateSource(this.outputNode)}}class yS extends R0{get isFreeze(){return!1}constructor(e,n,i){var r;if(super(),j(this,"sourceNode",void 0),j(this,"track",void 0),j(this,"clonedTrack",void 0),j(this,"audioElement",void 0),j(this,"isCurrentTrackCloned",!1),j(this,"isRemoteTrack",!1),j(this,"originVolumeLevelAnalyser",void 0),j(this,"rebuildWebAudio",(async()=>{if(m.debug("ready to rebuild web audio, state:",this.context.state),this.isNoAudioInput&&await this.checkHasAudioInput(),!this.isNoAudioInput||this.isDestroyed)return document.body.removeEventListener("click",this.rebuildWebAudio,!0),void m.debug("rebuild web audio success, current volume status",this.getAccurateVolumeLevel());this.context.resume().then((()=>m.info("resume success"))),m.debug("rebuild web audio because of ios 12 bugs"),this.disconnect();const a=this.track;this.track=this.track.clone(),this.isCurrentTrackCloned?a.stop():this.isCurrentTrackCloned=!0;const c=new MediaStream([this.track]);this.sourceNode=this.context.createMediaStreamSource(c),ac(this.sourceNode),this.volumeLevelAnalyser.rebuildAnalyser();const d=this.outputNode.gain.value;this.outputNode=this.context.createGain(),this.outputNode.gain.setValueAtTime(d,this.context.currentTime),ac(this.outputNode),this.emit(hr.UPDATE_SOURCE),this.connect(),this.audioElement.srcObject=c,this.isPlayed&&this.play(this.playNode),this.checkHasAudioInput()})),e.kind!=="audio")throw new H(A.UNEXPECTED_ERROR);this.track=e;const s=new MediaStream([this.track]);if(this.isRemoteTrack=!!n,this.sourceNode=this.context.createMediaStreamSource(s),ac(this.sourceNode),i){const a=i.clone();a.enabled=!0,this.clonedTrack=a,m.debug("create an unmuted track ".concat(a.id," from the original track ").concat(i.id," to get the volume"));const c=this.context.createMediaStreamSource(new MediaStream([a]));ac(c),this.originVolumeLevelAnalyser=new T0,this.originVolumeLevelAnalyser.updateSource(c)}this.connect(),this.audioElement=document.createElement("audio"),this.audioElement.srcObject=s;const o=de();n&&o.os===On.IOS&&Number((r=o.osVersion)===null||r===void 0?void 0:r.split(".")[0])<15&&(Ie.on(Yn.STATE_CHANGE,(()=>{this.context.state==="suspended"?document.body.addEventListener("click",this.rebuildWebAudio,!0):this.context.state==="running"&&this.rebuildWebAudio()})),this.checkHasAudioInput().then((a=>{a||document.body.addEventListener("click",this.rebuildWebAudio,!0)})))}updateTrack(e){this.sourceNode.disconnect(),this.track=e,this.isCurrentTrackCloned=!1;const n=new MediaStream([e]);this.sourceNode=this.context.createMediaStreamSource(n),ac(this.sourceNode),this.processedNode||this.sourceNode.connect(this.outputNode),this.emit(hr.UPDATE_SOURCE),this.audioElement.srcObject=n}destroy(){var e;this.audioElement.srcObject=null,this.audioElement.remove(),Ie.off("state-change",this.rebuildWebAudio),(e=this.originVolumeLevelAnalyser)===null||e===void 0||e.destroy(),this.clonedTrack=void 0,super.destroy()}createMediaStreamSourceNode(e){return this.context.createMediaStreamSource(new MediaStream([e]))}updateOriginTrack(e){const n=e.clone();n.enabled=!0,this.clonedTrack&&(this.clonedTrack.stop(),this.clonedTrack=n),m.debug("create an unmuted track ".concat(n.id," from the original track ").concat(e.id," to get the volume"));const i=this.context.createMediaStreamSource(new MediaStream([n]));ac(i),this.originVolumeLevelAnalyser&&this.originVolumeLevelAnalyser.updateSource(i)}getOriginVolumeLevel(){return this.originVolumeLevelAnalyser?this.originVolumeLevelAnalyser.getVolumeLevel():this.getAccurateVolumeLevel()}}async function v0(t,e,n){const i=(s,o)=>s?typeof s!="number"?s.max||s.exact||s.ideal||s.min||o:s:o,r={audio:!!n&&{mandatory:{chromeMediaSource:"desktop"}},video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:t,maxHeight:i(e.height,1080),maxWidth:i(e.width,1920)}}};return e.frameRate&&typeof e.frameRate!="number"?(r.video.mandatory.maxFrameRate=e.frameRate.max,r.video.mandatory.minFrameRate=e.frameRate.min):typeof e.frameRate=="number"&&(r.video.mandatory.maxFrameRate=e.frameRate),await navigator.mediaDevices.getUserMedia(r)}async function b8(t,e){const n=await C0(t.mediaSource),{sourceId:i,audio:r}=await(function(s){let o=arguments.length>1&&arguments[1]!==void 0&&arguments[1];return new st(((a,c)=>{const d=document.createElement("div");d.innerText="share screen",d.setAttribute("style","text-align: center; height: 25px; line-height: 25px; border-radius: 4px 4px 0 0; background: #D4D2D4; border-bottom:  solid 1px #B9B8B9;");const l=document.createElement("div");l.setAttribute("style","width: 100%; height: 500px; padding: 15px 25px ; box-sizing: border-box;");const h=document.createElement("div");h.innerText="Agora Web Screensharing wants to share the contents of your screen with webdemo.agorabeckon.com. Choose what you'd like to share.",h.setAttribute("style","height: 12%;");const p=document.createElement("div");p.setAttribute("style","width: 100%; height: 80%; background: #FFF; border:  solid 1px #CBCBCB; display: flex; flex-wrap: wrap; justify-content: space-around; overflow-y: scroll; padding: 0 15px; box-sizing: border-box;");const f=document.createElement("div");f.setAttribute("style","display: flex; justify-content: space-between; padding: 16px 0;");const v=document.createElement("button");v.innerHTML="cancel",v.setAttribute("style","width: 85px;"),v.onclick=()=>{document.body.removeChild(b);const w=new Error("NotAllowedError");w.name="NotAllowedError",c(w)};let S=o;const T=document.createElement("div");if(o){const w=document.createElement("input");w.setAttribute("type","checkbox");const D=document.createElement("span");w.setAttribute("style","margin-right: 6px;"),D.innerText="Share audio",w.checked=S,w.onchange=()=>{S=w.checked},T.appendChild(w),T.appendChild(D)}f.appendChild(T),f.appendChild(v),l.appendChild(h),l.appendChild(p),l.appendChild(f);const b=document.createElement("div");b.setAttribute("style","position: fixed; z-index: 99999999; top: 50%; left: 50%; width: 620px; height: 525px; background: #ECECEC; border-radius: 4px; -webkit-transform: translate(-50%,-50%); transform: translate(-50%,-50%);"),b.appendChild(d),b.appendChild(l),document.body.appendChild(b),s.map((w=>{if(w.id){const D=document.createElement("div");D.setAttribute("style","width: 30%; height: 160px; padding: 20px 0; text-align: center;box-sizing: content-box;");let k=w.thumbnail;try{const{width:U}=k.getSize();U>1920&&(k=k.resize({width:1920}))}catch(U){throw U&&U.message.startsWith("Illegal invocation")&&console.error("Operate thumbnail error, please try to set contextIsolation: false. (https://github.com/electron/electron/issues/34953)"),U}D.innerHTML='<div style="height: 120px; display: table-cell; vertical-align: middle;"><img style="width: 100%; background: #333333; box-shadow: 1px 1px 1px 1px rgba(0, 0, 0, 0.2);" src='+k.toDataURL()+' /></div><span style="	height: 40px; line-height: 40px; display: inline-block; width: 70%; word-break: keep-all; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">'+w.name.replace(/[\u00A0-\u9999<>\&]/g,(function(U){return"&#"+U.charCodeAt(0)+";"}))+"</span>",D.onclick=()=>{document.body.removeChild(b),a({sourceId:w.id,audio:S})},p.appendChild(D)}}))}))})(n,e);return await v0(i,t,r)}async function C0(t){let e=["window","screen"];t!=="application"&&t!=="window"||(e=["window"]),t==="screen"&&(e=["screen"]);const n=LO();if(!n)throw console.error("failed to fetch electron, please mount it to window"),new H(A.ELECTRON_IS_NULL);let i=null;try{var r;i=((r=n.desktopCapturer)===null||r===void 0?void 0:r.getSources({types:e}))||n.ipcRenderer.invoke("DESKTOP_CAPTURER_GET_SOURCES",{types:e})}catch{i=null}i&&i.then||(i=new st(((s,o)=>{n.desktopCapturer.getSources({types:e},((a,c)=>{a?o(a):s(c)}))})));try{return await i}catch(s){throw new H(A.ELECTRON_DESKTOP_CAPTURER_GET_SOURCES_ERROR,s.toString())}}const IS=new Un("safari");let y0=!1,I0=!1;async function fr(t,e){let n=0,i=null;for(;n<2;)try{i=await A8(t,e,n>0);break}catch(r){if(r instanceof H)throw m.error("[".concat(e,"] ").concat(r.toString())),r;const s=i_(r.name||r.code||r,r.message);if(s.code===A.MEDIA_OPTION_INVALID){m.debug("[".concat(e,"] detect media option invalid, retry")),n+=1,await Nn(500);continue}throw m.error("[".concat(e,"] ").concat(s.toString())),s}if(!i)throw new H(A.UNEXPECTED_ERROR,"can not find stream after getUserMedia");return i}async function A8(t,e,n){if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)throw new H(A.NOT_SUPPORTED,"can not find getUserMedia");n&&(t.video&&(delete t.video.width,delete t.video.height),t.screen&&(delete t.screen.width,delete t.screen.height));const i=Jt(),r=new MediaStream;if(t.audioSource&&r.addTrack(t.audioSource),t.videoSource&&r.addTrack(t.videoSource),!t.audio&&!t.video&&!t.screen)return m.debug("Using Video Source/ Audio Source"),r;if(t.screen)if(LO())t.screen.sourceId?Pd(r,await v0(t.screen.sourceId,t.screen,!!t.screenAudio)):Pd(r,await b8(t.screen,!!t.screenAudio));else if(Ao()&&t.screen.extensionId&&t.screen.mandatory){if(!i.getStreamFromExtension)throw new H(A.NOT_SUPPORTED,"This browser does not support screen sharing");m.debug("[".concat(e,'] Screen access on chrome stable, looking for extension"'));const p=await(o=t.screen.extensionId,a=e,new st(((f,v)=>{try{chrome.runtime.sendMessage(o,{getStream:!0},(S=>{if(!S||!S.streamId)return m.error("[".concat(a,"] No response from Chrome Plugin. Plugin not installed properly"),S),void v(new H(A.CHROME_PLUGIN_NO_RESPONSE,"No response from Chrome Plugin. Plugin not installed properly"));f(S.streamId)}))}catch(S){m.error("[".concat(a,"] AgoraRTC screensharing plugin is not accessible(").concat(o,")"),S.toString()),v(new H(A.CHROME_PLUGIN_NOT_INSTALL))}})));t.screen.mandatory.chromeMediaSourceId=p,Pd(r,await navigator.mediaDevices.getUserMedia({video:{mandatory:t.screen.mandatory}}))}else if(i.getDisplayMedia){var s;t.screen.mediaSource&&_0(t.screen.mediaSource);const p={width:t.screen.width,height:t.screen.height,frameRate:t.screen.frameRate,displaySurface:(s=t.screen.displaySurface)!==null&&s!==void 0?s:t.screen.mediaSource==="screen"?"monitor":t.screen.mediaSource},{selfBrowserSurface:f,surfaceSwitching:v,systemAudio:S,preferCurrentTab:T,windowAudio:b,monitorTypeSurfaces:w}=t.screen,D={selfBrowserSurface:f,surfaceSwitching:v,systemAudio:S,preferCurrentTab:T,windowAudio:b,monitorTypeSurfaces:w};!f&&delete D.selfBrowserSurface,!v&&delete D.surfaceSwitching,!S&&delete D.systemAudio,!T&&delete D.preferCurrentTab,!b&&delete D.windowAudio,!w&&delete D.monitorTypeSurfaces,m.debug("[".concat(e,"] getDisplayMedia:"),JSON.stringify({video:p,audio:t.screenAudio,controls:D})),Pd(r,await navigator.mediaDevices.getDisplayMedia(Ue({video:p,audio:t.screenAudio},D)))}else{if(!xe())throw m.error("[".concat(e,"] This browser does not support screenSharing")),new H(A.NOT_SUPPORTED,"This browser does not support screen sharing");{t.screen.mediaSource&&_0(t.screen.mediaSource);const p={video:{mediaSource:t.screen.mediaSource,width:t.screen.width,height:t.screen.height,frameRate:t.screen.frameRate}};m.debug("[".concat(e,"] getUserMedia: ").concat(JSON.stringify(p))),Pd(r,await navigator.mediaDevices.getUserMedia(p))}}var o,a;if(!t.video&&!t.audio)return r;let c={video:t.video,audio:t.audio},d=I("MEDIA_DEVICE_CONSTRAINTS");if(d)try{typeof d=="string"&&(d=JSON.parse(d)),c=$g(c,d)}catch{}m.debug("[".concat(e,"] GetUserMedia"),JSON.stringify(c)),de();let l,h=null;(Mn()||si()||Gp())&&(h=await IS.lock());try{l=await navigator.mediaDevices.getUserMedia(c)}catch(p){throw h&&h(),p}return c.audio&&(y0=!0),c.video&&(I0=!0),Pd(r,l),h&&h(),r}function i_(t,e){switch(t){case"Starting video failed":case"OverconstrainedError":case"TrackStartError":return new H(A.MEDIA_OPTION_INVALID,"".concat(t,": ").concat(e));case"NotFoundError":case"DevicesNotFoundError":return new H(A.DEVICE_NOT_FOUND,"".concat(t,": ").concat(e));case"NotSupportedError":return new H(A.NOT_SUPPORTED,"".concat(t,": ").concat(e));case"NotReadableError":return new H(A.NOT_READABLE,"".concat(t,": ").concat(e));case"InvalidStateError":case"NotAllowedError":case"PERMISSION_DENIED":case"PermissionDeniedError":return new H(A.PERMISSION_DENIED,"".concat(t,": ").concat(e));case"ConstraintNotSatisfiedError":return new H(A.CONSTRAINT_NOT_SATISFIED,"".concat(t,": ").concat(e));default:return m.error("getUserMedia unexpected error",t),new H(A.UNEXPECTED_ERROR,"".concat(t,": ").concat(e))}}function Pd(t,e){const n=t.getVideoTracks()[0],i=t.getAudioTracks()[0],r=e.getVideoTracks()[0],s=e.getAudioTracks()[0];s&&(i&&t.removeTrack(i),t.addTrack(s)),r&&(n&&t.removeTrack(n),t.addTrack(r))}const mr=new class extends qe{get state(){return this._state}set state(t){t!==this._state&&(this.emit(oc.STATE_CHANGE,t),this._state=t)}constructor(){super(),j(this,"_state",lu.IDLE),j(this,"isAccessMicrophonePermission",!1),j(this,"isAccessCameraPermission",!1),j(this,"lastAccessMicrophonePermission",!1),j(this,"lastAccessCameraPermission",!1),j(this,"checkdeviceMatched",!1),j(this,"deviceInfoMap",new Map),this.init().then((()=>{navigator.mediaDevices.addEventListener&&navigator.mediaDevices.addEventListener("devicechange",this.updateDevicesInfo.bind(this)),window.setInterval((()=>{(I("ENUMERATE_DEVICES_INTERVAL")||(eu()||jp()===On.HARMONY_OS)&&Js())&&this.updateDevicesInfo()}),I("ENUMERATE_DEVICES_INTERVAL_TIME"))})).catch((t=>m.error(t.toString())))}async enumerateDevices(t,e){let n=arguments.length>2&&arguments[2]!==void 0&&arguments[2];if(!navigator.mediaDevices||!navigator.mediaDevices.enumerateDevices)throw new H(A.NOT_SUPPORTED,"enumerateDevices() not supported.");const i=await navigator.mediaDevices.enumerateDevices(),r=this.checkMediaDeviceInfoIsOk(i);let s=!this.isAccessMicrophonePermission&&t,o=!this.isAccessCameraPermission&&e;r.audio&&(s=!1),r.video&&(o=!1);let a=null,c=null,d=null;if(!n&&(s||o)){if(IS.isLocked&&(m.debug("[device manager] wait GUM lock"),(await IS.lock())(),m.debug("[device manager] GUM unlock")),y0&&(s=!1,this.isAccessMicrophonePermission=!0),I0&&(o=!1,this.isAccessCameraPermission=!0),m.debug("[device manager] check media device permissions",t,e,s,o),s&&o){try{d=await navigator.mediaDevices.getUserMedia({audio:!0,video:!0})}catch(l){const h=i_(l.name||l.code||l,l.message);if(h.code===A.PERMISSION_DENIED)throw h;m.warning("getUserMedia failed in getDevices",h)}this.isAccessCameraPermission=!0,this.isAccessMicrophonePermission=!0}else if(s){try{a=await navigator.mediaDevices.getUserMedia({audio:t})}catch(l){const h=i_(l.name||l.code||l,l.message);if(h.code===A.PERMISSION_DENIED)throw h;m.warning("getUserMedia failed in getDevices",h)}this.isAccessMicrophonePermission=!0}else if(o){try{c=await navigator.mediaDevices.getUserMedia({video:e})}catch(l){const h=i_(l.name||l.code||l,l.message);if(h.code===A.PERMISSION_DENIED)throw h;m.warning("getUserMedia failed in getDevices",h)}this.isAccessCameraPermission=!0}m.debug("[device manager] mic permission",t,"cam permission",e)}try{const l=await navigator.mediaDevices.enumerateDevices();return a&&a.getTracks().forEach((h=>h.stop())),c&&c.getTracks().forEach((h=>h.stop())),d&&d.getTracks().forEach((h=>h.stop())),a=null,c=null,d=null,l}catch(l){return a&&a.getTracks().forEach((h=>h.stop())),c&&c.getTracks().forEach((h=>h.stop())),d&&d.getTracks().forEach((h=>h.stop())),a=null,c=null,d=null,new H(A.ENUMERATE_DEVICES_FAILED,l.toString()).throw()}}async getRecordingDevices(){let t=arguments.length>0&&arguments[0]!==void 0&&arguments[0];return(await this.enumerateDevices(!0,!1,t)).filter((e=>e.kind==="audioinput"))}async getCamerasDevices(){let t=arguments.length>0&&arguments[0]!==void 0&&arguments[0];return(await this.enumerateDevices(!1,!0,t)).filter((e=>e.kind==="videoinput"))}async getSpeakers(){let t=arguments.length>0&&arguments[0]!==void 0&&arguments[0];return(await this.enumerateDevices(!0,!1,t)).filter((e=>e.kind==="audiooutput"))}searchDeviceIdByName(t){let e=null;return this.deviceInfoMap.forEach((n=>{n.device.label===t&&(e=n.device.deviceId)})),e}async getDeviceById(t){const e=(await this.enumerateDevices(!0,!0,!0)).find((n=>n.deviceId===t));if(!e)throw new H(A.DEVICE_NOT_FOUND,"deviceId: ".concat(t));return e}async init(){this.state=lu.INITING;try{await this.updateDevicesInfo(),this.state=lu.INITEND}catch(t){throw this.state=lu.IDLE,(typeof isSecureContext=="boolean"?isSecureContext:location.protocol==="https:"||location.protocol==="file:"||location.hostname==="localhost"||location.hostname==="127.0.0.1"||location.hostname==="::1")?(m.warning("Device Detection functionality cannot start properly.",t.toString()),t):new H(A.WEB_SECURITY_RESTRICT,"Your context is limited by web security, please try using https protocol or localhost.")}}async updateDevicesInfo(){const t=await this.enumerateDevices(!0,!0,!0),e=Date.now(),n=[];if(t[0]&&t[0].label&&this.checkdeviceMatched===!1){this.checkdeviceMatched=!0;const r=t.find((o=>o.kind==="audioinput"&&o.deviceId==="default")),s=t.find((o=>o.kind==="audiooutput"&&o.deviceId==="default"));r&&s?s.groupId===r.groupId?m.debug("[device-check] default input ".concat(r.label," and output ").concat(s.label," is the same group")):m.debug("[device-check] default input ".concat(r.label," and output ").concat(s.label," is not the same group")):m.debug("[device-check] default input or output not found")}const i=this.checkMediaDeviceInfoIsOk(t);if(t.forEach((r=>{if(!r.deviceId)return;const s=this.deviceInfoMap.get("".concat(r.kind,"_").concat(r.deviceId));if((s?s.state:"INACTIVE")!=="ACTIVE"){const o={initAt:e,updateAt:e,device:r,state:"ACTIVE"};this.deviceInfoMap.set("".concat(r.kind,"_").concat(r.deviceId),o),n.push(o)}s&&(s.updateAt=e)})),this.deviceInfoMap.forEach(((r,s)=>{r.state==="ACTIVE"&&r.updateAt!==e&&(r.state="INACTIVE",n.push(r))})),this.state!==lu.INITEND)return i.audio&&(this.lastAccessMicrophonePermission=!0,this.isAccessMicrophonePermission=!0),void(i.video&&(this.lastAccessCameraPermission=!0,this.isAccessCameraPermission=!0));n.forEach((r=>{switch(r.device.kind){case"audioinput":this.lastAccessMicrophonePermission&&this.isAccessMicrophonePermission&&this.emit(oc.RECORDING_DEVICE_CHANGED,r);break;case"videoinput":this.lastAccessCameraPermission&&this.isAccessCameraPermission&&this.emit(oc.CAMERA_DEVICE_CHANGED,r);break;case"audiooutput":this.lastAccessMicrophonePermission&&this.isAccessMicrophonePermission&&this.emit(oc.PLAYOUT_DEVICE_CHANGED,r)}})),i.audio&&(this.lastAccessMicrophonePermission=!0,this.isAccessMicrophonePermission=!0),i.video&&(this.lastAccessCameraPermission=!0,this.isAccessCameraPermission=!0)}checkMediaDeviceInfoIsOk(t){const e=t.filter((r=>r.kind==="audioinput")),n=t.filter((r=>r.kind==="videoinput")),i={audio:!1,video:!1};for(const r of e)if(r.label&&r.deviceId){i.audio=!0;break}for(const r of n)if(r.label&&r.deviceId){i.video=!0;break}return i}};let bS=!1;const bi=new class extends qe{constructor(){super(...arguments),j(this,"onAutoplayFailed",void 0),j(this,"onAudioAutoplayFailed",void 0)}};function b0(){if(bS)return I("FLS_AUTOPLAY_EMITS")?(bi.onAutoplayFailed&&bi.onAutoplayFailed(),bi.emit("autoplay-failed")):void 0;{const t=e=>{e.preventDefault(),bS=!1,nu()?document.body.removeEventListener("click",t,!0):(document.body.removeEventListener("touchstart",t,!0),document.body.removeEventListener("mousedown",t,!0))};bS=!0,nu()?document.body.addEventListener("click",t,!0):(document.body.addEventListener("touchstart",t,!0),document.body.addEventListener("mousedown",t,!0)),m.info("detect media autoplay failed, document: https://docs.agora.io/cn/Voice/autoplay_policy_web_ng?platform=Web"),bi.onAutoplayFailed?bi.onAutoplayFailed():bi.onAudioAutoplayFailed?m.warning(`AgoraRTC.onAudioAutoplayFailed has been deprecated in favor of AgoraRTC.onAutoplayFailed.

  Please refer to the Agora document to migrate the newer API, https://docs.agora.io/en/Voice/autoplay_policy_web_ng?platform=Web .`):m.warning(`We have detected a media autoplay failed event, and found out that you haven't implemented AgoraRTC.onAutoplayFailed callback yet.

  It will cause audio/video element not playing automatically on some browsers without user interaction, possibly hurting user experiences.

  Please refer to the Agora document to properly handle autoplay failed event, https://docs.agora.io/en/Voice/autoplay_policy_web_ng?platform=Web .`),bi.emit("autoplay-failed")}}function A0(t,e,n,i){if(!t)return;const r=pt.getBaseInfoBySessionId(t);if(!r)return;const s=r.info,o=Date.now(),a=Ue(Ue({},s),{},{vid:s.vid===void 0?0:Number(s.vid),lts:o,elapse:o-r.startTime,cbRegistered:bi.onAutoplayFailed||bi.onAudioAutoplayFailed?1:-1,errorMsg:n,mediaType:e,trackId:i,extend:void 0});pt.send({type:We.AUTOPLAY_FAILED,data:a},!0)}const w8=["play","playing","loadeddata","canplay","pause","stalled","suspend","waiting","abort","emptied","ended","error"],ci=new class{constructor(){j(this,"onAutoplayFailed",void 0),j(this,"elementMap",new Map),j(this,"elementStateMap",new Map),j(this,"elementsNeedToResume",[]),j(this,"sinkIdMap",new Map),j(this,"autoResumeAfterInterruption",(t=>st.all(Array.from(this.elementMap.entries()).map((async e=>{let[n,i]=e;const r=this.elementStateMap.get(n),s=i.srcObject.getAudioTracks()[0],o=s&&s.readyState;if(m.debug("resume after interrupted, ele: ".concat(r," audio: ").concat(o," ").concat(t)),o==="live"){if(t)return i.pause(),i.play();if(Ie.curState==="running")return gd()?(i.pause(),i.play()):r&&r==="paused"?i.play():void 0}}))))),j(this,"autoResumeAfterInterruptionOnIOS15_16",(()=>{Array.from(this.elementMap.entries()).forEach((t=>{let[e,n]=t;const i=n.srcObject.getAudioTracks()[0];i&&i.readyState==="live"&&(m.debug("auto resume after interruption inside autoResumeAfterInterruptionOnIOS15"),n.pause(),n.play())}))})),this.autoResumeAudioElement(),Ie.on(Yn.IOS_INTERRUPTION_END,this.autoResumeAfterInterruption),Ie.on(Yn.IOS_15_16_INTERRUPTION_END,this.autoResumeAfterInterruptionOnIOS15_16),Ie.on(Yn.STATE_CHANGE,(()=>{si()&&Ie.prevState==="suspended"&&Ie.curState==="running"&&this.autoResumeAfterInterruption()}))}async setSinkID(t,e){const n=this.elementMap.get(t);if(this.sinkIdMap.set(t,e),n)try{await n.setSinkId(e)}catch(i){throw new H(A.PERMISSION_DENIED,"can not set sink id: "+i.toString())}}play(t,e,n,i){if(this.elementMap.has(e))return;const r=document.createElement("audio");r.autoplay=!0,r.srcObject=new MediaStream([t]),this.bindAudioElementEvents(e,r),this.elementMap.set(e,r),this.elementStateMap.set(e,ti.INIT),this.setVolume(e,n);const s=this.sinkIdMap.get(e);if(s)try{r.setSinkId(s).catch((a=>{m.warning("[".concat(e,"] set sink id failed"),a.toString())}))}catch(a){m.warning("[".concat(e,"] set sink id failed"),a.toString())}const o=r.play();o&&o.then&&o.catch((a=>{i&&A0(i,"audio",a.message,e),m.warning("audio element play warning",a.toString()),this.elementMap.has(e)&&a.name==="NotAllowedError"&&(m.warning("detected audio element autoplay failed"),this.elementsNeedToResume.push(r),Hp((()=>{this.onAutoplayFailed&&this.onAutoplayFailed(),b0()})))}))}updateTrack(t,e){const n=this.elementMap.get(t);n&&(n.srcObject=new MediaStream([e]))}isPlaying(t){return this.elementMap.has(t)&&this.elementStateMap.get(t)==="playing"}setVolume(t,e){const n=this.elementMap.get(t);n&&(e=Math.max(0,Math.min(100,e)),n.volume=e/100)}getVolume(t){const e=this.elementMap.get(t);return e?e.volume:0}stop(t){const e=this.elementMap.get(t);if(this.sinkIdMap.delete(t),!e)return;const n=this.elementsNeedToResume.indexOf(e);this.elementsNeedToResume.splice(n,1),e.srcObject=null,e.remove(),this.elementMap.delete(t),this.elementStateMap.delete(t)}bindAudioElementEvents(t,e){w8.forEach((n=>{e.addEventListener(n,(i=>{const r=this.elementStateMap.get(t),s=i.type==="pause"?"paused":i.type;if(m.debug("[".concat(t,"] audio-element-status change ").concat(r," => ").concat(s)),i.type==="error"){const o=e?.error;o&&m.error("[".concat(t,"] media error, code: ").concat(o.code,", message: ").concat(o.message))}this.elementStateMap.set(t,s)}))}))}getPlayerState(t){return this.elementStateMap.get(t)||"uninit"}autoResumeAudioElement(){const t=()=>{this.elementsNeedToResume.forEach((e=>{e.play().then((n=>{m.debug("Auto resume audio element success")})).catch((n=>{m.warning("Auto resume audio element failed!",n)}))})),this.elementsNeedToResume=[]};new st((e=>{document.body?e():window.addEventListener("load",(()=>e()))})).then((()=>{nu()?document.body.addEventListener("click",t,!0):(document.body.addEventListener("touchstart",t,!0),document.body.addEventListener("mousedown",t,!0))}))}};function nn(){return function(t,e,n){const i=n.value;return typeof i=="function"&&(n.value=function(){this._isClosed&&new H(A.INVALID_OPERATION,"[".concat(this.getTrackId(),"] cannot operate a closed track")).print("warning",m);for(var r=arguments.length,s=new Array(r),o=0;o<r;o++)s[o]=arguments[o];const a=i.apply(this,s);return a instanceof st?new st(((c,d)=>{a.then(c).catch(d)})):a}),n}}class w0 extends qe{constructor(e){super(),j(this,"name","VideoProcessorDestination"),j(this,"ID","0"),j(this,"_source",void 0),j(this,"videoContext",void 0),j(this,"inputTrack",void 0),this.videoContext=e}get kind(){return"video"}get enabled(){return!0}pipe(){throw new H(A.NOT_SUPPORTED,"VideoProcessor cannot pipe to any other Processor")}unpipe(){throw new H(A.NOT_SUPPORTED,"VideoProcessor cannot unpipe to any other Processor")}enable(){}disable(){}updateInput(e){if(e.context!==this.videoContext)throw new Error(`ProcessorContext passed to VideoTrack.processorDestination doesn't match it's belonging VideoTrack's context.
Probably you are making pipeline like this:
videoTrack1.pipe(processor).pipe(videoTrack2.processorDestination).`);e.track&&e.track!==this.inputTrack&&(this.videoContext.chained=!0,this.inputTrack=e.track,this.emit(gi.ON_TRACK,e.track))}reset(){this.inputTrack=void 0,this.videoContext.chained=!1,this.emit(gi.ON_TRACK,void 0)}}class O0 extends qe{set chained(e){this._chained=e}get chained(){return this._chained}constructor(e,n){super(),j(this,"constraintsMap",new Map),j(this,"statsRegistry",[]),j(this,"usageRegistry",[]),j(this,"trackId",void 0),j(this,"direction",void 0),j(this,"_chained",!1),this.trackId=e,this.direction=n}async getConstraints(){return await Sn(this,pr.REQUEST_CONSTRAINTS)}async requestApplyConstraints(e,n){var i;return m.info("processor ".concat(n.name," requestApplyConstraints for ").concat(this.trackId)),e&&this.constraintsMap.set(n,e),Pe(this,pr.REQUEST_UPDATE_CONSTRAINTS,Array.from(qi(i=this.constraintsMap).call(i)))}async requestRevertConstraints(e){var n;if(this.constraintsMap.has(e))return m.info("processor ".concat(e.name," requestRevertConstraints for ").concat(this.trackId)),this.constraintsMap.delete(e),Pe(this,pr.REQUEST_UPDATE_CONSTRAINTS,Array.from(qi(n=this.constraintsMap).call(n)))}registerStats(e,n,i){this.statsRegistry.find((r=>r.processorID===e.ID&&r.processorName===e.name&&r.type===n))||this.statsRegistry.push({processorName:e.name,processorID:e.ID,type:n,cb:i})}unregisterStats(e,n){const i=this.statsRegistry.findIndex((r=>r.processorID===e.ID&&r.processorName===e.name&&r.type===n));i!==-1&&this.statsRegistry.splice(i,1)}gatherStats(){const e=[];for(const{processorID:n,processorName:i,type:r,cb:s}of this.statsRegistry)try{const o=s();e.push({processorID:n,processorName:i,type:r,stats:o})}catch(o){m.error(new H(A.UNEXPECTED_ERROR,o.message))}return e}registerUsage(e,n){this.usageRegistry.find((i=>i.processorID===e.ID&&i.processorName===e.name))||this.usageRegistry.push({processorID:e.ID,processorName:e.name,cb:n})}unregisterUsage(e){const n=this.usageRegistry.findIndex((i=>i.processorID===e.ID&&i.processorName===e.name));n!==-1&&this.usageRegistry.splice(n,1)}async gatherUsage(){const e=[];if(!this.chained)return[];for(const{cb:n}of this.usageRegistry)try{let i=n();i instanceof st&&(i=await i),e.push(Ue(Ue({},i),{},{direction:this.direction}))}catch(i){m.error("gather extension usage error",i)}return e}getDirection(){return this.direction}}class N0 extends qe{constructor(e){super(),j(this,"name","AudioProcessorDestination"),j(this,"ID","0"),j(this,"inputTrack",void 0),j(this,"inputNode",void 0),j(this,"audioProcessorContext",void 0),j(this,"_source",void 0),this.audioProcessorContext=e}get kind(){return"audio"}get enabled(){return!0}pipe(){throw new H(A.NOT_SUPPORTED,"AudioProcessorDestination cannot pipe to any other Processor")}unpipe(){throw new H(A.NOT_SUPPORTED,"AudioProcessor cannot unpipe to any other Processor")}enable(){}disable(){}reset(){this.inputTrack=void 0,this.inputNode=void 0,this.audioProcessorContext.chained=!1,this.emit(gi.ON_TRACK,void 0),this.emit(gi.ON_NODE,void 0)}updateInput(e){if(e.context!==this.audioProcessorContext)throw new Error(`ProcessorContext passed to AudioTrack.processorDestination doesn't match it's belonging AudioTrack's context.
        Probably you are making pipeline like this: audioTrack1.pipe(processor).pipe(audioTrack2.processorDestination).`);e.track&&this.inputTrack!==e.track&&(this.audioProcessorContext.chained=!0,this.inputTrack=e.track,this.emit(gi.ON_TRACK,this.inputTrack)),e.node&&this.inputNode!==e.node&&(this.audioProcessorContext.chained=!0,this.inputNode=e.node,this.emit(gi.ON_NODE,this.inputNode))}}class D0 extends qe{set chained(e){this._chained=e}get chained(){return this._chained}constructor(e,n,i){super(),j(this,"constraintsMap",new Map),j(this,"statsRegistry",[]),j(this,"audioContext",void 0),j(this,"trackId",void 0),j(this,"direction",void 0),j(this,"usageRegistry",[]),j(this,"_chained",!1),this.audioContext=e,this.trackId=n,this.direction=i}async getConstraints(){return Sn(this,pr.REQUEST_CONSTRAINTS)}getAudioContext(){return this.audioContext}async requestApplyConstraints(e,n){var i;return m.info("processor ".concat(n.name," requestApplyConstraints for ").concat(this.trackId)),e&&this.constraintsMap.set(n,e),Pe(this,pr.REQUEST_UPDATE_CONSTRAINTS,Array.from(qi(i=this.constraintsMap).call(i)))}async requestRevertConstraints(e){var n;if(this.constraintsMap.has(e))return this.constraintsMap.delete(e),Pe(this,pr.REQUEST_UPDATE_CONSTRAINTS,Array.from(qi(n=this.constraintsMap).call(n)))}registerStats(e,n,i){this.statsRegistry.find((r=>r.processorID===e.ID&&r.processorName===e.name&&r.type===n))||this.statsRegistry.push({processorName:e.name,processorID:e.ID,type:n,cb:i})}unregisterStats(e,n){const i=this.statsRegistry.findIndex((r=>r.processorID===e.ID&&r.processorName===e.name&&r.type===n));i!==-1&&this.statsRegistry.splice(i,1)}gatherStats(){const e=[];for(const{processorID:n,processorName:i,type:r,cb:s}of this.statsRegistry)try{const o=s();e.push({processorID:n,processorName:i,type:r,stats:o})}catch(o){m.error(new H(A.UNEXPECTED_ERROR,o.message))}return e}registerUsage(e,n){this.usageRegistry.find((i=>i.processorID===e.ID&&i.processorName===e.name))||this.usageRegistry.push({processorID:e.ID,processorName:e.name,cb:n})}unregisterUsage(e){const n=this.usageRegistry.findIndex((i=>i.processorID===e.ID&&i.processorName===e.name));n!==-1&&this.usageRegistry.splice(n,1)}async gatherUsage(){const e=[];if(!this.chained)return[];for(const{cb:n}of this.usageRegistry)try{let i=n();i instanceof st&&(i=await i),e.push(Ue(Ue({},i),{},{direction:this.direction}))}catch(i){m.error("gather extension usage error",i)}return e}getDirection(){return this.direction}}class AS extends qe{get isPlayed(){return!0}get isFreeze(){return!1}constructor(){super(),j(this,"context",void 0),j(this,"processSourceNode",void 0),j(this,"outputTrack",void 0),j(this,"processedNode",void 0),j(this,"clonedTrack",void 0),j(this,"outputNode",void 0),this.outputNode=new O8}setVolume(){}createOutputTrack(){throw new H(A.NOT_SUPPORTED,"can not create output MediaStreamTrack when WebAudio disabled")}getOriginVolumeLevel(){return 0}getAccurateVolumeLevel(){return 0}stopGetAudioBuffer(){}startGetAudioBuffer(){}play(){}stop(){}destroy(){}updateTrack(){}updateOriginTrack(){}createMediaStreamSourceNode(){}}class O8{disconnect(){}connect(){}}function P0(t){return new st(((e,n)=>{let i=!1;const r=document.createElement("video");r.setAttribute("autoplay",""),r.setAttribute("muted",""),r.muted=!0,r.autoplay=!0,r.setAttribute("playsinline",""),r.setAttribute("style","position: fixed; top: 0; left: 0; width: 1px; height: 1px"),document.body.appendChild(r);const s=si()?"canplay":"playing";r.addEventListener(s,(()=>{const o=r.videoWidth,a=r.videoHeight;!o&&xe()||(i=!0,r.srcObject=null,r.remove(),e([o,a]))})),r.srcObject=new MediaStream([t]),r.play().catch(su),setTimeout((()=>{i||(r.srcObject=null,r.remove(),e([r.videoWidth,r.videoHeight]))}),4e3)}))}function r_(t){const e={};t.facingMode&&(e.facingMode=t.facingMode),t.cameraId&&(e.deviceId={exact:t.cameraId});const n=ns(t.encoderConfig);return n.width!=null&&(e.width=n.width),n.height!=null&&(e.height=n.height),!IO()&&n.frameRate&&(e.frameRate=n.frameRate),EO()&&typeof e.frameRate=="object"&&(e.frameRate.max=60),xe()&&(e.frameRate={ideal:30,max:30}),e}function L0(t){const e={};return IO()||(t.AGC!==void 0&&(e.autoGainControl=t.AGC),t.AEC!==void 0&&(e.echoCancellation=t.AEC),t.ANS!==void 0&&(e.noiseSuppression=t.ANS,Ao()&&t.ANS&&(e.googHighpassFilter=t.ANS))),e}function k0(t){const e=L0(t);if(t.encoderConfig){const n=e_(t.encoderConfig);e.channelCount=n.stereo?2:1,e.sampleRate=n.sampleRate,e.sampleSize=n.sampleSize}return t.microphoneId&&(e.deviceId={exact:t.microphoneId}),eu()&&(e.sampleRate=void 0),e}const M0=t=>{const e=t._encoderConfig;if(!e)return;const{frameRate:n,width:i,height:r}=t.getMediaStreamTrackSettings();let{frameRate:s=n,width:o=i,height:a=r}=e;if(!s||!o||!a)return;o=Rd(o),a=Rd(a),s=Rd(s);const{max:c,min:d}=(function(f,v,S){const T=200*Math.pow(S/15,.6)*Math.pow(f*v/640/360,.75);return{min:Math.floor(T),max:Math.floor(4*T)}})(o,a,s),{bitrateMax:l,bitrateMin:h}=e||{};l||m.debug("calculate bitrate: [w: ".concat(o,", h: ").concat(a,", fps: ").concat(s,"] => [brMax: ").concat(l,", brMin: ").concat(h,"]"));const{maxFramerate:p}=I("ENCODER_CONFIG_LIMIT");return p&&typeof p=="number"&&(s=Math.min(s,p)),{frameRate:s,bitrateMax:l||c,bitrateMin:h||d,scaleResolutionDownBy:1,scale:0}},U0=async(t,e,n)=>await(async(i,r,s)=>{const o=(function(d){const l=[];for(let h=0;h<d.length;h+=2)l.push(parseInt(d.slice(h,h+2),16));return Uint8Array.from(l)})(KO(""+r+s)).slice(0,16),a=o.slice(0,12),c=await window.crypto.subtle.importKey("raw",o,"AES-GCM",!0,["encrypt"]);return new Uint8Array(await window.crypto.subtle.encrypt({name:"AES-GCM",iv:a},c,i))})(t.buffer,e,n),wS=t=>{const e=document.createElement("canvas");return e.width=2,e.height=2,new st(((n,i)=>{e.toBlob((async r=>{if(e.remove(),r){const s=await x0(r);n({buffer:s,width:e.width,height:e.height})}else i(new H(A.CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED))}),t,1)}))},x0=async t=>{const e=await t.arrayBuffer();return new Uint8Array(e)};var V0,F0,B0,j0,G0,W0,H0,K0,Y0,q0,z0,X0,J0,Q0,Z0,$0,tN,eN,Qe,nN,iN,rN,sN,oN,aN,$s,cN,dN,lN,uN,hN,pN,_N,fN,mN,EN,gN,SN,TN,Qn;let rn=(V0=At({argsMap:(t,e)=>[t.getTrackId(),e],throttleTime:300}),F0=At({argsMap:(t,e)=>[t.getTrackId(),e]}),B0=nn(),j0=vd("LocalAudioTrack","_enabledMutex"),G0=At({argsMap:(t,e)=>[t.getTrackId(),e]}),W0=nn(),H0=vd("LocalAudioTrack","_enabledMutex"),K0=At({argsMap:(t,e)=>[t.getTrackId(),e]}),Y0=nn(),q0=nn(),z0=nn(),X0=At({argsMap:t=>[t.getTrackId()]}),J0=nn(),Q0=At({argsMap:t=>[t.getTrackId()]}),Z0=nn(),$0=At({argsMap:t=>[t.getTrackId()]}),tN=At({argsMap:(t,e)=>[t.getTrackId(),e.name]}),eN=At({argsMap:t=>[t.getTrackId()]}),re((Qe=class extends Nd{get _source(){return this.initWebAudio()}set _source(t){this._trackSource=t}get processorContext(){return this._processorContext||(this._processorContext=this.initProcessor().processorContext),this._processorContext}get processorDestination(){return this._processorDestination||(this._processorDestination=this.initProcessor().processorDestination),this._processorDestination}get isPlaying(){return this._useAudioElement?ci.isPlaying(this.getTrackId()):this._source.isPlayed}get __className__(){return"LocalAudioTrack"}constructor(t,e,n,i){super(t,n),j(this,"trackMediaType",Od.AUDIO),j(this,"_encoderConfig",void 0),j(this,"_trackSource",void 0),j(this,"metadata",[]),j(this,"_enabled",!0),j(this,"_volume",100),j(this,"_useAudioElement",!0),j(this,"_bypassWebAudio",!1),j(this,"processor",void 0),j(this,"_processorContext",void 0),j(this,"_processorDestination",void 0),j(this,"_getOriginVolumeLevel",void 0),this._encoderConfig=e,this._getOriginVolumeLevel=!!i,this._trackSource=new AS,I("DISABLE_WEBAUDIO")&&(this._bypassWebAudio=!0),I("LOCAL_AUDIO_TRACK_USES_WEB_AUDIO")&&(this._useAudioElement=!1),Mn()&&!_r?setTimeout((()=>this.initWebAudio())):this.initWebAudio()}setVolume(t){Oe(t,"volume",0,1e3),this._volume=t,this._source.setVolume(t/100),this._useAudioElement&&ci.setVolume(this.getTrackId(),t);try{if(this._bypassWebAudio)return void m.debug("[".concat(this.getTrackId(),"] setVolume returned because no pass through WebAudio."));const e=this._source.createOutputTrack();this._mediaStreamTrack!==e&&(this._mediaStreamTrack=e,Pe(this,_t.NEED_REPLACE_TRACK,this).then((()=>{m.debug("[".concat(this.getTrackId(),"] replace web audio track success"))})).catch((n=>{m.warning("[".concat(this.getTrackId(),"] replace web audio track failed"),n)})))}catch{}}getVolumeLevel(){return this._muted&&this.enabled&&this._getOriginVolumeLevel?this._source.getOriginVolumeLevel():this._source.getAccurateVolumeLevel()}async setPlaybackDevice(t){if(!this._useAudioElement||!d0())throw new H(A.NOT_SUPPORTED,"your browser does not support setting the audio output device");await ci.setSinkID(this.getTrackId(),t)}async setEnabled(t,e,n){return this._setEnabled(t,e,n)}async _setEnabled(t,e,n){if(!n){if(t===this._enabled)return;this.stateCheck("enabled",t)}if(m.info("[".concat(this.getTrackId(),"] start setEnabled"),t),t){this._originMediaStreamTrack.enabled=!0;try{n||(this._enabled=!0),await Pe(this,_t.NEED_ENABLE_TRACK,this),m.info("[".concat(this.getTrackId(),"] setEnabled to ").concat(t," success"))}catch(i){throw n||(this._enabled=!1),m.error("[".concat(this.getTrackId(),"] setEnabled to true error"),i.toString()),i}}else{this._originMediaStreamTrack.enabled=!1,n||(this._enabled=!1);try{await Pe(this,_t.NEED_DISABLE_TRACK,this)}catch(i){throw n||(this._enabled=!0),m.error("[".concat(this.getTrackId(),"] setEnabled to false error"),i.toString()),i}}}async setMuted(t){t!==this._muted&&(this.stateCheck("muted",t),this._muted=t,this._originMediaStreamTrack.enabled=!t,m.debug("[".concat(this.getTrackId(),"] start set muted: ").concat(t)),t?await Pe(this,_t.NEED_MUTE_TRACK,this):await Pe(this,_t.NEED_UNMUTE_TRACK,this))}getStats(){return oa((()=>{m.warning("[deprecated] LocalAudioTrack.getStats will be removed in the future, use AgoraRTCClient.getLocalAudioStats instead")}),"localAudioTrackGetStatsWarning"),Ji(this,_t.GET_STATS)||Ue({},gS)}setAudioFrameCallback(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:4096;if(!t)return this._source.removeAllListeners(hr.ON_AUDIO_BUFFER),void this._source.stopGetAudioBuffer();this._source.startGetAudioBuffer(e),this._source.removeAllListeners(hr.ON_AUDIO_BUFFER),this._source.on(hr.ON_AUDIO_BUFFER,(n=>t(n)))}play(){m.debug("[".concat(this.getTrackId(),"] start audio playback")),this._useAudioElement?(m.debug("[".concat(this.getTrackId(),"] start audio playback in element")),ci.play(this._mediaStreamTrack,this.getTrackId(),this._volume)):this._source.play()}stop(){m.debug("[".concat(this.getTrackId(),"] stop audio playback")),this._useAudioElement?ci.stop(this.getTrackId()):this._source.stop()}close(){super.close(),this._processorDestination&&this.unbindProcessorDestinationEvents(this._processorDestination),this._processorContext&&this.unbindProcessorContextEvents(this._processorContext),this.unpipe(),this._processorDestination&&this._processorDestination._source&&this._processorDestination._source.unpipe(),this._source.destroy()}_updatePlayerSource(){let t=!(arguments.length>0&&arguments[0]!==void 0)||arguments[0];m.debug("[".concat(this.getTrackId(),"] update player source track")),t&&this._source.updateTrack(this._mediaStreamTrack),this._useAudioElement&&ci.updateTrack(this.getTrackId(),this._mediaStreamTrack)}async _updateOriginMediaStreamTrack(t,e){this._originMediaStreamTrack!==t&&(this._originMediaStreamTrack&&(this._originMediaStreamTrack.removeEventListener("ended",this._handleTrackEnded),e&&this._originMediaStreamTrack.stop()),t.addEventListener("ended",this._handleTrackEnded),this._originMediaStreamTrack=t,this._muted&&(this._originMediaStreamTrack.enabled=!1),this.processor&&this._processorContext&&this.processor.updateInput({track:t,context:this._processorContext}),this._mediaStreamTrack!==this._source.outputTrack?(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await Pe(this,_t.NEED_REPLACE_TRACK,this)):this._source.updateTrack(this._originMediaStreamTrack),this._getOriginVolumeLevel&&this._source.updateOriginTrack(t))}renewMediaStreamTrack(t){return st.resolve(void 0)}pipe(t){if(this._bypassWebAudio)throw new H(A.INVALID_OPERATION,"Can not process AudioTrack when bypassWebAudio set to true.");if(this.processor===t)return t;if(t._source)throw new H(A.INVALID_OPERATION,"Processor ".concat(t.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=t,this.processor._source=this,t.updateInput({track:this._originMediaStreamTrack,node:this._source.processSourceNode,context:this.processorContext}),t}unpipe(){var t;if(!this.processor)return;const e=this.processor;(t=this._source.processSourceNode)===null||t===void 0||t.disconnect(),this.processor._source=!1,this.processor=void 0,e.reset()}bindProcessorDestinationEvents(t){t.on(gi.ON_TRACK,(async e=>{e?e!==this._mediaStreamTrack&&(this._mediaStreamTrack=e,this._updatePlayerSource(!1),this._source.processedNode=this._source.createMediaStreamSourceNode(e),await Pe(this,_t.NEED_REPLACE_TRACK,this)):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await Pe(this,_t.NEED_REPLACE_TRACK,this))})),t.on(gi.ON_NODE,(e=>{this._source.processedNode=e}))}unbindProcessorDestinationEvents(t){t.removeAllListeners(gi.ON_TRACK),t.removeAllListeners(gi.ON_NODE)}bindProcessorContextEvents(t){t.on(pr.REQUEST_CONSTRAINTS,(async e=>{e(this._originMediaStreamTrack.getSettings())}))}unbindProcessorContextEvents(t){t.removeAllListeners(pr.REQUEST_CONSTRAINTS)}initWebAudio(){return this._trackSource instanceof AS&&(this._trackSource=new yS(this._mediaStreamTrack,!1,this._getOriginVolumeLevel?this._mediaStreamTrack:void 0)),this._trackSource}initProcessor(){const t=new D0(this._source.context,this.getTrackId(),"local"),e=new N0(t);return this._processorContext=t,this._processorDestination=e,this.bindProcessorContextEvents(t),this.bindProcessorDestinationEvents(e),this._source.on(hr.UPDATE_SOURCE,(()=>{this.processor&&this.processor.updateInput({node:this._source.processSourceNode,context:t})})),this._useAudioElement&&(this._useAudioElement=!1,this.isPlaying&&(ci.stop(this.getTrackId()),this._source.play()),Pe(this,_t.NEED_REPLACE_MIXING_TRACK,this).then((()=>{m.debug("[".concat(this.getTrackId(),"] replace from origin track to web audio track success"))})).catch((n=>{m.warning("[".concat(this.getTrackId(),"] replace from origin track to web audio track failed"),n)}))),{processorContext:t,processorDestination:e}}}).prototype,"setVolume",[V0],Object.getOwnPropertyDescriptor(Qe.prototype,"setVolume"),Qe.prototype),re(Qe.prototype,"setPlaybackDevice",[F0,B0],Object.getOwnPropertyDescriptor(Qe.prototype,"setPlaybackDevice"),Qe.prototype),re(Qe.prototype,"setEnabled",[j0,G0,W0],Object.getOwnPropertyDescriptor(Qe.prototype,"setEnabled"),Qe.prototype),re(Qe.prototype,"setMuted",[H0,K0,Y0],Object.getOwnPropertyDescriptor(Qe.prototype,"setMuted"),Qe.prototype),re(Qe.prototype,"getStats",[q0],Object.getOwnPropertyDescriptor(Qe.prototype,"getStats"),Qe.prototype),re(Qe.prototype,"setAudioFrameCallback",[z0],Object.getOwnPropertyDescriptor(Qe.prototype,"setAudioFrameCallback"),Qe.prototype),re(Qe.prototype,"play",[X0,J0],Object.getOwnPropertyDescriptor(Qe.prototype,"play"),Qe.prototype),re(Qe.prototype,"stop",[Q0,Z0],Object.getOwnPropertyDescriptor(Qe.prototype,"stop"),Qe.prototype),re(Qe.prototype,"close",[$0],Object.getOwnPropertyDescriptor(Qe.prototype,"close"),Qe.prototype),re(Qe.prototype,"pipe",[tN],Object.getOwnPropertyDescriptor(Qe.prototype,"pipe"),Qe.prototype),re(Qe.prototype,"unpipe",[eN],Object.getOwnPropertyDescriptor(Qe.prototype,"unpipe"),Qe.prototype),Qe),uu=(nN=At({argsMap:(t,e)=>[t.getTrackId(),e]}),iN=nn(),rN=vd("MicrophoneAudioTrack","_enabledMutex"),sN=At({argsMap:(t,e,n)=>[t.getTrackId(),e,n]}),oN=nn(),aN=At({argsMap:t=>[t.getTrackId()]}),re(($s=class extends rn{get __className__(){return"MicrophoneAudioTrack"}constructor(t,e,n,i){super(t,e.encoderConfig?e_(e.encoderConfig):{},i,I("GET_VOLUME_OF_MUTED_AUDIO_TRACK")),j(this,"_config",void 0),j(this,"_deviceName","default"),j(this,"_constraints",void 0),j(this,"_originalConstraints",void 0),j(this,"_enabled",!0),this._config=e,this._constraints=n,this._originalConstraints=n,this._deviceName=t.label,typeof e.bypassWebAudio=="boolean"&&(this._bypassWebAudio=e.bypassWebAudio),(gd()||Kg())&&Ie.bindInterruptDetectorTrack(this)}async setDevice(t){if(m.info("[".concat(this.getTrackId(),"] start set device to ").concat(t)),this._enabled)try{const e=await mr.getDeviceById(t),n={};n.audio=Ue({},this._constraints),n.audio.deviceId={exact:t},this._originMediaStreamTrack.stop();let i=null;try{i=await fr(n,this.getTrackId())}catch(r){throw m.error("[".concat(this.getTrackId(),"] setDevice failed"),r.toString()),i=await fr({audio:this._constraints},this.getTrackId()),await this._updateOriginMediaStreamTrack(i.getAudioTracks()[0],!1),r}await this._updateOriginMediaStreamTrack(i.getAudioTracks()[0],!1),this._deviceName=e.label,this._config.microphoneId=t,this._constraints.deviceId={exact:t}}catch(e){throw m.error("[".concat(this.getTrackId(),"] setDevice error"),e.toString()),e}else try{const e=await mr.getDeviceById(t);this._deviceName=e.label,this._config.microphoneId=t,this._constraints.deviceId={exact:t}}catch(e){throw m.error("[".concat(this.getTrackId(),"] setDevice error"),e.toString()),e}m.info("[".concat(this.getTrackId(),"] set device to ").concat(t," success"))}async setEnabled(t,e,n){if(e)return m.debug("[".concat(this.getTrackId(),"] setEnabled false (do not close microphone)")),await super._setEnabled(t);if(!n){if(t===this._enabled)return;this.stateCheck("enabled",t)}if(m.info("[".concat(this.getTrackId(),"] start setEnabled"),t),I("AUTO_RESET_AUDIO_ROUTE")&&(si()||Qr())){const o=navigator.audioSession;o&&(t||(o.type="playback"),o.type="auto")}if(!t){var i;this._originMediaStreamTrack.onended=null,this._originMediaStreamTrack.stop(),(i=this._source.clonedTrack)===null||i===void 0||i.stop(),n||(this._enabled=!1);try{await Pe(this,_t.NEED_DISABLE_TRACK,this)}catch(o){throw m.error("[".concat(this.getTrackId(),"] setEnabled false failed"),o.toString()),o}return}const r=Ue({},this._constraints),s=mr.searchDeviceIdByName(this._deviceName);s&&!r.deviceId&&(r.deviceId=s);try{n||(this._enabled=!0);const o=await fr({audio:this._constraints},this.getTrackId());await this._updateOriginMediaStreamTrack(o.getAudioTracks()[0],!1),await Pe(this,_t.NEED_ENABLE_TRACK,this)}catch(o){throw n||(this._enabled=!1),m.error("[".concat(this.getTrackId(),"] setEnabled true failed"),o.toString()),o}m.info("[".concat(this.getTrackId(),"] setEnabled success"))}close(){super.close(),(gd()||Kg())&&Ie.unbindInterruptDetectorTrack(this),rc.some((t=>(function(e){return"__className__"in e&&e.__className__==="MicrophoneAudioTrack"})(t)))||RS&&RS()&&(pt.reportApiInvoke(null,{name:"BG_AUDIO_TAG_RESTART",options:{},tag:Ne.TRACER}).onSuccess(),m.debug("restart background audio tag success"))}onTrackEnded(){if((si()||Qr())&&this._enabled&&!this._isClosed&&Ie.duringInterruption){const t=async()=>{Ie.off(Yn.IOS_INTERRUPTION_END,t),this._enabled&&!this._isClosed&&(m.debug("[".concat(this.getTrackId(),"] try capture microphone media device for interrupted iOS device.")),await this.setEnabled(!1),await this.setEnabled(!0))};Ie.on(Yn.IOS_INTERRUPTION_END,t)}else m.debug("[".concat(this.getTrackId(),"] track ended")),this.safeEmit(wd.TRACK_ENDED)}async renewMediaStreamTrack(t){const e=t||this._constraints,n=mr.searchDeviceIdByName(this._deviceName);if(n&&!e.deviceId&&(e.deviceId=n),this._constraints=e,this._enabled){this._originMediaStreamTrack.stop();const i=await fr({audio:this._constraints},this.getTrackId());await this._updateOriginMediaStreamTrack(i.getAudioTracks()[0],!0)}}bindProcessorContextEvents(t){super.bindProcessorContextEvents(t),t.on(pr.REQUEST_UPDATE_CONSTRAINTS,(async(e,n,i)=>{try{const r=Object.assign({},this._originalConstraints,...e);await this.renewMediaStreamTrack(r),n()}catch(r){i(r)}}))}unbindProcessorContextEvents(t){super.unbindProcessorContextEvents(t),t.removeAllListeners(pr.REQUEST_UPDATE_CONSTRAINTS)}}).prototype,"setDevice",[nN,iN],Object.getOwnPropertyDescriptor($s.prototype,"setDevice"),$s.prototype),re($s.prototype,"setEnabled",[rN,sN,oN],Object.getOwnPropertyDescriptor($s.prototype,"setEnabled"),$s.prototype),re($s.prototype,"close",[aN],Object.getOwnPropertyDescriptor($s.prototype,"close"),$s.prototype),$s),N8=(cN=At({argsMap:(t,e)=>[t.getTrackId(),e,t.duration]}),dN=nn(),lN=At({argsMap:t=>[t.getTrackId()]}),uN=nn(),hN=At({argsMap:t=>[t.getTrackId()]}),pN=nn(),_N=At({argsMap:t=>[t.getTrackId()]}),fN=nn(),mN=At({argsMap:t=>[t.getTrackId()]}),EN=nn(),gN=At({argsMap:t=>[t.getTrackId()]}),SN=At({argsMap:t=>[t.getTrackId()]}),TN=nn(),re((Qn=class extends rn{get __className__(){return"BufferSourceAudioTrack"}constructor(t,e,n,i){super(e.createOutputTrack(),n,i),j(this,"source",void 0),j(this,"_bufferSource",void 0),this._useAudioElement=!1,this.source=t,this._bufferSource=e,this._bufferSource.on(hr.AUDIO_SOURCE_STATE_CHANGE,(r=>{this.safeEmit(wd.SOURCE_STATE_CHANGE,r)}));try{this._mediaStreamTrack=this._source.createOutputTrack()}catch{}}get currentState(){return this._bufferSource.currentState}get duration(){return this._bufferSource.duration}get playbackSpeed(){return this._bufferSource.playbackSpeed}getCurrentTime(){return this._bufferSource.currentTime}startProcessAudioBuffer(t){t&&this._bufferSource.updateOptions(t),this._bufferSource.startProcessAudioBuffer()}pauseProcessAudioBuffer(){this._bufferSource.pauseProcessAudioBuffer()}seekAudioBuffer(t){this._bufferSource.seekAudioBuffer(t)}resumeProcessAudioBuffer(){this._bufferSource.resumeProcessAudioBuffer()}stopProcessAudioBuffer(){this._bufferSource.stopProcessAudioBuffer()}close(){this.source=null,this._bufferSource.destroy(),super.close()}setAudioBufferPlaybackSpeed(t){Oe(t,"speed",0),this._bufferSource.setAudioBufferPlaybackSpeed(t)}}).prototype,"startProcessAudioBuffer",[cN,dN],Object.getOwnPropertyDescriptor(Qn.prototype,"startProcessAudioBuffer"),Qn.prototype),re(Qn.prototype,"pauseProcessAudioBuffer",[lN,uN],Object.getOwnPropertyDescriptor(Qn.prototype,"pauseProcessAudioBuffer"),Qn.prototype),re(Qn.prototype,"seekAudioBuffer",[hN,pN],Object.getOwnPropertyDescriptor(Qn.prototype,"seekAudioBuffer"),Qn.prototype),re(Qn.prototype,"resumeProcessAudioBuffer",[_N,fN],Object.getOwnPropertyDescriptor(Qn.prototype,"resumeProcessAudioBuffer"),Qn.prototype),re(Qn.prototype,"stopProcessAudioBuffer",[mN,EN],Object.getOwnPropertyDescriptor(Qn.prototype,"stopProcessAudioBuffer"),Qn.prototype),re(Qn.prototype,"close",[gN],Object.getOwnPropertyDescriptor(Qn.prototype,"close"),Qn.prototype),re(Qn.prototype,"setAudioBufferPlaybackSpeed",[SN,TN],Object.getOwnPropertyDescriptor(Qn.prototype,"setAudioBufferPlaybackSpeed"),Qn.prototype),Qn);class Cn extends rn{get __className__(){return"MixingAudioTrack"}get isActive(){for(const e of this.trackList)if(e._enabled&&!e._isClosed&&!e.muted)return!0;return!1}constructor(){const e=Dd().createMediaStreamDestination();super(e.stream.getAudioTracks()[0],void 0,Se(8,"track-mix-")),j(this,"trackList",void 0),j(this,"destNode",void 0),this._useAudioElement=!1;try{this._mediaStreamTrack=this._source.createOutputTrack()}catch{}this.destNode=e,this.trackList=[]}hasAudioTrack(e){return this.trackList.indexOf(e)!==-1}addAudioTrack(e){this.trackList.indexOf(e)===-1?(m.debug("add ".concat(e.getTrackId()," to mixing track")),e._source.outputNode.connect(this.destNode),this.trackList.push(e),this.updateEncoderConfig()):m.debug("track ".concat(e.getTrackId()," is already added"))}removeAudioTrack(e){if(this.trackList.indexOf(e)!==-1){m.debug("remove ".concat(e.getTrackId()," from mixing track"));try{e._source.outputNode.disconnect(this.destNode)}catch{}Wp(this.trackList,e),this.updateEncoderConfig()}}updateEncoderConfig(){const e={};this.trackList.forEach((n=>{n._encoderConfig&&((n._encoderConfig.bitrate||0)>(e.bitrate||0)&&(e.bitrate=n._encoderConfig.bitrate),(n._encoderConfig.sampleRate||0)>(e.sampleRate||0)&&(e.sampleRate=n._encoderConfig.sampleRate),(n._encoderConfig.sampleSize||0)>(e.sampleSize||0)&&(e.sampleSize=n._encoderConfig.sampleSize),n._encoderConfig.stereo&&(e.stereo=!0))})),this._encoderConfig=e}_updateRtpTransceiver(e){this._rtpTransceiver!==e&&(this._rtpTransceiver=e,this.trackList.forEach((n=>{n instanceof Cn?n.emit(sc.TRANSCEIVER_UPDATED,e):n._updateRtpTransceiver(e)})))}}class D8 extends R0{set currentState(e){e!==this._currentState&&(this._currentState=e,this.safeEmit(hr.AUDIO_SOURCE_STATE_CHANGE,this._currentState))}get currentState(){return this._currentState}constructor(e){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};super(),j(this,"audioBuffer",void 0),j(this,"sourceNode",void 0),j(this,"startPlayTime",0),j(this,"startPlayOffset",0),j(this,"pausePlayTime",0),j(this,"options",void 0),j(this,"currentLoopCount",0),j(this,"currentPlaybackSpeed",100),j(this,"_currentState","stopped"),this.audioBuffer=e,this.options=n,this.startPlayOffset=this.options.startPlayTime||0}createWebAudioDiagram(){return this.context.createGain()}get duration(){return this.audioBuffer?this.audioBuffer.duration:0}get playbackSpeed(){return this.currentPlaybackSpeed}get currentTime(){return this.audioBuffer?this.currentState==="stopped"?0:this.currentState==="paused"?this.pausePlayTime:((this.context.currentTime-this.startPlayTime)*(this.playbackSpeed/100)+this.startPlayOffset)%this.audioBuffer.duration:0}updateOptions(e){this.currentState==="stopped"?(this.options=e,this.startPlayOffset=this.options.startPlayTime||0):m.warning("can not set audio source options")}startProcessAudioBuffer(){this.sourceNode&&this.stopProcessAudioBuffer(),this.sourceNode=this.createSourceNode(),this.startSourceNode(),this.currentState="playing"}pauseProcessAudioBuffer(){this.sourceNode&&this.currentState==="playing"&&(this.pausePlayTime=this.currentTime,this.sourceNode.onended=null,this.sourceNode.stop(),this.sourceNode.buffer=null,this.sourceNode=this.createSourceNode(),this.currentState="paused")}seekAudioBuffer(e){this.sourceNode&&(this.sourceNode.onended=null,this.currentState==="playing"&&this.sourceNode.stop(),this.sourceNode=this.createSourceNode(),this.currentState==="playing"?(this.startPlayOffset=e,this.startSourceNode()):this.currentState==="paused"&&(this.pausePlayTime=e))}resumeProcessAudioBuffer(){this.currentState==="paused"&&this.sourceNode&&(this.startPlayOffset=this.pausePlayTime,this.pausePlayTime=0,this.startSourceNode(),this.currentState="playing")}stopProcessAudioBuffer(){if(this.sourceNode){this.sourceNode.onended=null;try{this.sourceNode.stop()}catch{}this.reset()}}destroy(){this.audioBuffer=null,super.destroy()}setAudioBufferPlaybackSpeed(e){this.sourceNode&&(this.currentState==="playing"&&(this.startPlayOffset=this.currentTime,this.startPlayTime=this.context.currentTime),this.sourceNode.playbackRate.value=e/100),this.currentPlaybackSpeed=e}startSourceNode(){this.sourceNode&&this.sourceNode.buffer&&(this.sourceNode.start(0,this.startPlayOffset),this.startPlayTime=this.context.currentTime,this.sourceNode.onended=this.handleSourceNodeEnded.bind(this))}createSourceNode(){const e=this.context.createBufferSource();return e.buffer=this.audioBuffer,e.loop=!!this.options.loop,e.connect(this.outputNode),e.playbackRate.value=this.currentPlaybackSpeed/100,e}handleSourceNodeEnded(){if(this.currentLoopCount+=1,this.options.cycle&&this.options.cycle>this.currentLoopCount)return this.startPlayOffset=0,this.sourceNode=void 0,void this.startProcessAudioBuffer();this.reset()}reset(){this.startPlayOffset=this.options.startPlayTime||0,this.currentState="stopped",this.sourceNode&&(this.sourceNode.disconnect(),this.sourceNode=void 0),this.currentLoopCount=0}}const RN=new Map;function vN(t,e){if(t.length===0||e.length===0)return 1/0;const n=eS(t),i=eS(e);return Math.floor(i/n)}class OS{get rendFrameRate(){const e=Math.max(1,vN(this._render_interframe_delays_sizes,this._render_interframe_delays));return Math.floor(1e3/e)}get videoElementStatus(){return this._isInPage?this._videoElementStatus:ti.DESTROYED}set videoElementStatus(e){e!==this._videoElementStatus&&(m.debug("[".concat(this.trackId,"] video-element-status change ").concat(this._videoElementStatus," => ").concat(e)),this._videoElementStatus=e)}get videoState(){return this._videoState}set videoState(e){var n;e!==this._videoState&&(this._videoState=e,(n=this.onVideoStateChanged)===null||n===void 0||n.call(this,this.videoState))}constructor(e){j(this,"trackId",void 0),j(this,"config",void 0),j(this,"onFirstVideoFrameDecoded",void 0),j(this,"onFirstVideoFrameRender",void 0),j(this,"onVideoBufferReady",void 0),j(this,"onVideoStateChanged",void 0),j(this,"freezeTimeCounterList",[]),j(this,"renderFreezeAccTime",0),j(this,"renderFreezeAccTime2",0),j(this,"isKeepLastFrame",!1),j(this,"isDestroyed",!1),j(this,"timeUpdatedCount",0),j(this,"freezeTime",0),j(this,"playbackTime",0),j(this,"lastTimeUpdatedTime",0),j(this,"autoplayFailed",!1),j(this,"videoTrack",void 0),j(this,"videoElement",void 0),j(this,"cacheVideoElement",void 0),j(this,"cancelRVFId",void 0),j(this,"internal",!1),j(this,"_render_interframe_delays",[]),j(this,"_render_interframe_delays_sizes",[]),j(this,"_videoState",Zs.VideoStateStopped),j(this,"videoElementCheckInterval",void 0),j(this,"videoElementFreezeTimeout",void 0),j(this,"_videoElementStatus",ti.NONE),j(this,"_isInPage",!0),j(this,"isGettingVideoDimensions",!1),j(this,"startGetVideoDimensions",(()=>{const n=()=>{if(this.isGettingVideoDimensions=!0,this.videoElement.videoWidth*this.videoElement.videoHeight>4)return m.debug("[".concat(this.trackId,"] current video dimensions:"),this.videoElement.videoWidth,this.videoElement.videoHeight),void(this.isGettingVideoDimensions=!1);setTimeout(n,500)};!this.isGettingVideoDimensions&&n()})),j(this,"autoResumeAfterInterruption",(()=>{this.videoTrack&&this.videoTrack.readyState==="live"&&Ie.curState==="running"&&(m.debug("[track-".concat(this.trackId,"] video element paused, auto resume for ").concat(fO())),CO()?(this.videoElement.srcObject=null,this.videoElement.srcObject=new MediaStream([this.videoTrack]),this.videoElement.play()):(this.videoElement.pause(),this.videoElement.play()))})),j(this,"handleVideoEvents",(n=>{switch(n.type){case"play":case"playing":n.type==="play"&&m.debug("[".concat(this.trackId,"] video element status: play")),this.startGetVideoDimensions(),this.videoElementStatus=ti.PLAYING;break;case"loadeddata":if(this.videoState=Zs.VideoStateStarting,this.onFirstVideoFrameRender&&this.onFirstVideoFrameRender(),this.onFirstVideoFrameDecoded&&this.onFirstVideoFrameDecoded(),this.cacheVideoElement){try{this.cacheVideoElement.srcObject=null,this.cacheVideoElement.remove()}catch{}this.cacheVideoElement=void 0}break;case"canplay":this.videoElementStatus=ti.CANPLAY;break;case"stalled":this.videoElementStatus=ti.STALLED;break;case"suspend":this.videoElementStatus=ti.SUSPEND;break;case"pause":this.videoElementStatus=ti.PAUSED,si()||Qr()||Mn()&&this.autoplayFailed||!this.videoTrack||this.videoTrack.readyState!=="live"||(m.debug("[track-".concat(this.trackId,"] video element paused, auto resume")),this.videoElement.play());break;case"waiting":this.videoElementStatus=ti.WAITING;break;case"abort":this.videoElementStatus=ti.ABORT;break;case"ended":this.videoElementStatus=ti.ENDED;break;case"emptied":this.videoElementStatus=ti.EMPTIED;break;case"error":{const i=this.videoElement.error;i&&(this.videoElementStatus=ti.ERROR,m.error("[".concat(this.trackId,"] media error: ").concat(i.message," (").concat(i.code,")")));break}case"timeupdate":{const i=performance.now();if(this.timeUpdatedCount+=1,this.onVideoBufferReady&&this.timeUpdatedCount>I("BUFFER_READY_FRAMES")&&this.onVideoBufferReady(),this.timeUpdatedCount<10)return void(this.lastTimeUpdatedTime=i);const r=i-this.lastTimeUpdatedTime,s=this.lastTimeUpdatedTime;if(this.lastTimeUpdatedTime=i,Qi.lastVisibleTime<Qi.lastHiddenTime||s<Qi.lastHiddenTime||s<Qi.lastVisibleTime||this.isSkipCalcRenderFreezeTime())return;for(r>I("VIDEO_FREEZE_DURATION")&&(this.freezeTime+=r),this.playbackTime+=r;this.playbackTime>=6e3;){this.playbackTime-=6e3;const o=Math.min(6e3,this.freezeTime);this.freezeTimeCounterList.push(o),this.freezeTime=Math.max(0,this.freezeTime-6e3)}break}}})),j(this,"autoResumeAfterInterruptionOnIOS15_16",(()=>{this.videoTrack&&this.videoTrack.readyState==="live"&&(m.debug("[track-".concat(this.trackId,"] video element paused, auto resume for ").concat(fO())),CO()?(this.videoElement.srcObject=null,this.videoElement.srcObject=new MediaStream([this.videoTrack]),this.videoElement.play()):(this.videoElement.pause(),this.videoElement.play()))})),this.trackId=e.trackId,this.config=e,e.element instanceof HTMLVideoElement?this.videoElement=e.element:this.videoElement=document.createElement("video"),Ie.on(Yn.IOS_INTERRUPTION_END,this.autoResumeAfterInterruption),Ie.on(Yn.IOS_15_16_INTERRUPTION_END,this.autoResumeAfterInterruptionOnIOS15_16)}getVideoElement(){return this.videoElement}getContainerElement(){var e;return(e=this.videoElement.parentElement)!==null&&e!==void 0?e:void 0}updateConfig(e){this.config=e,this.trackId=e.trackId,e.element!==this.videoElement&&(this.destroy(),this.videoElement=e.element),this.videoTrack&&this.initVideoElement()}updateVideoTrack(e){this.videoTrack!==e&&(this.videoTrack=e,this.initVideoElement())}play(e){const n=this.videoElement.play();n&&n.catch&&n.catch((r=>{e&&A0(e,"video",r.message,this.trackId),r.name==="NotAllowedError"?(m.warning("detected video element autoplay failed",r),this.autoplayFailed=!0,this.handleAutoPlayFailed()):m.warning("[".concat(this.trackId,"] play warning: "),r)}));const i=de();if((i.name==="Safari"&&Number(i.version)===15||gd())&&n&&n.then){const r=()=>{this.config.mirror&&!this.config.noStyle&&(this.videoElement.style.transform="rotateY(180deg)")};n.then(r).catch(r)}}getCurrentFrame(){const e=document.createElement("canvas");e.width=this.videoElement.videoWidth,e.height=this.videoElement.videoHeight;const n=e.getContext("2d");if(!n)return m.error("create canvas context failed!"),new ImageData(2,2);n.drawImage(this.videoElement,0,0,e.width,e.height);const i=n.getImageData(0,0,e.width,e.height);return e.remove(),i}async getCurrentFrameToUint8Array(e){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1;const i=document.createElement("canvas");i.width=this.videoElement.videoWidth,i.height=this.videoElement.videoHeight;const r=i.getContext("2d");return r?(r.drawImage(this.videoElement,0,0,i.width,i.height),new st(((s,o)=>{i.toBlob((async a=>{if(i.remove(),a){const c=await x0(a);s({buffer:c,width:i.width,height:i.height})}else o(new H(A.CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED))}),e,n<0?.1:n>1?1:n)}))):await wS(e)}destroy(){let e=arguments.length>0&&arguments[0]!==void 0&&arguments[0];this.isDestroyed=!0,Ie.off(Yn.IOS_INTERRUPTION_END,this.autoResumeAfterInterruption),Ie.off(Yn.IOS_15_16_INTERRUPTION_END,this.autoResumeAfterInterruptionOnIOS15_16),e?this.videoElement.pause():this.videoElement.srcObject=null,this.resetVideoElement(),this.freezeTimeCounterList=[],this.videoState=Zs.VideoStateStopped}initVideoElement(){if(this.videoElementStatus=ti.INIT,!this.videoElementCheckInterval&&(CN.forEach((s=>{this.videoElement.addEventListener(s,this.handleVideoEvents)})),this.videoElementCheckInterval=window.setInterval((()=>{this._isInPage=(function(s){return s!==document.body&&document.body.contains(s)})(this.videoElement)}),1e3),I("ENABLE_VIDEO_FRAME_CALLBACK"))){var e,n;let s;const o=()=>{document.visibilityState==="visible"&&(document.removeEventListener("visibilitychange",o),this.videoElementFreezeTimeout=window.setTimeout(a,I("VIDEO_FREEZE_DURATION")))},a=()=>{this.videoElementFreezeTimeout=void 0,this.videoState===Zs.VideoStateDecoding&&(document.visibilityState==="visible"?this.videoState=Zs.VideoStateFrozen:document.addEventListener("visibilitychange",o))},c=(d,l)=>{if(this.videoElementStatus===ti.PLAYING){if(s){const f=l.presentationTime-s.presentationTime,v=l.presentedFrames-s.presentedFrames;this._render_interframe_delays_sizes.push(v),this._render_interframe_delays.push(f);const S=eS(this._render_interframe_delays_sizes),T=S-this._render_interframe_delays_sizes[0];if(S>30&&T>5&&(this._render_interframe_delays_sizes.shift(),this._render_interframe_delays.shift()),this.videoState===Zs.VideoStateStarting&&(this.videoState=Zs.VideoStateDecoding),this.videoState===Zs.VideoStateDecoding&&this.onVideoStateChanged&&(this.videoElementFreezeTimeout&&window.clearTimeout(this.videoElementFreezeTimeout),this.videoElementFreezeTimeout=window.setTimeout(a,I("VIDEO_FREEZE_DURATION"))),f<I("VIDEO_FREEZE_DURATION")&&this.videoState===Zs.VideoStateFrozen&&(this.videoState=Zs.VideoStateDecoding),f>I("VIDEO_FREEZE_DURATION")&&Qi.lastVisibleTime>=Qi.lastHiddenTime&&s.timestamp>Qi.lastVisibleTime&&s.timestamp>Qi.lastHiddenTime){const b=Math.min(66,vN(this._render_interframe_delays_sizes,this._render_interframe_delays)),w=Math.max(0,f-(v-1)*b);this.renderFreezeAccTime2+=w>b?w:0,this.renderFreezeAccTime+=f}}s=Ue(Ue({},l),{},{timestamp:d})}else this.isSkipCalcRenderFreezeTime()&&(s=Ue(Ue({},l),{},{timestamp:d}));var h,p;I("ENABLE_VIDEO_FRAME_CALLBACK")&&(this.cancelRVFId=(h=(p=this.videoElement).requestVideoFrameCallback)===null||h===void 0?void 0:h.call(p,c))};this.cancelRVFId=(e=(n=this.videoElement).requestVideoFrameCallback)===null||e===void 0?void 0:e.call(n,c)}this.videoElement.controls=!1,this.videoElement.setAttribute("playsinline",""),eu()&&!I("HIDE_NO_POSTER")&&(this.videoElement.poster="noposter");const i=de();this.config.noStyle||(i.name==="Safari"&&Number(i.version)===15||gd()||!this.config.mirror||(this.videoElement.style.transform="rotateY(180deg)"),this.config.fit?this.videoElement.style.objectFit=this.config.fit:this.videoElement.style.objectFit="cover"),this.videoElement.setAttribute("muted",""),this.videoElement.muted=!0,this.videoElement.srcObject&&this.videoElement.srcObject instanceof MediaStream?this.videoElement.srcObject.getVideoTracks()[0]!==this.videoTrack&&(this.videoElement.srcObject=this.videoTrack?new MediaStream([this.videoTrack]):null,xe()&&this.videoElement.load()):(this.videoElement.srcObject=this.videoTrack?new MediaStream([this.videoTrack]):null,xe()&&this.videoElement.load());const r=this.videoElement.play();r!==void 0&&r.catch((s=>{m.debug("[".concat(this.trackId,"] playback interrupted"),s.toString())}))}resetVideoElement(){var e,n;CN.forEach((i=>{this.videoElement&&this.videoElement.removeEventListener(i,this.handleVideoEvents)})),this.videoElementCheckInterval&&(window.clearInterval(this.videoElementCheckInterval),this.videoElementCheckInterval=void 0),this.cancelRVFId&&this.videoElement&&((e=(n=this.videoElement).cancelVideoFrameCallback)===null||e===void 0||e.call(n,this.cancelRVFId),this.cancelRVFId=void 0),this.videoElementStatus=ti.NONE}isSkipCalcRenderFreezeTime(){return this.videoElementStatus===ti.DESTROYED||this.internal}handleAutoPlayFailed(){const e=n=>{n.preventDefault(),this.videoElement.play().then((()=>{m.debug("[".concat(this.trackId,"] Video element for trackId:").concat(this.trackId," autoplay resumed."))})).catch((i=>{m.error(i)})),this.autoplayFailed=!1,nu()?document.body.removeEventListener("click",e,!0):(document.body.removeEventListener("touchstart",e,!0),document.body.removeEventListener("mousedown",e,!0))};nu()?document.body.addEventListener("click",e,!0):(document.body.addEventListener("touchstart",e,!0),document.body.addEventListener("mousedown",e,!0)),b0()}}const CN=["play","playing","loadeddata","canplay","pause","stalled","suspend","waiting","abort","emptied","ended","timeupdate","error"];class s_ extends OS{constructor(e){let n=arguments.length>1&&arguments[1]!==void 0&&arguments[1];super(e),j(this,"container",void 0),j(this,"slot",void 0),this.slot=e.element,this.internal=n,this.updateConfig(e)}updateConfig(e){this.config=e,this.trackId=e.trackId;const n=e.element;var i;!this.internal||this.slot?(n!==this.slot&&(this.destroy(),this.slot=n),this.createElements()):(this.slot=n,n&&this.container?(this.internal=!1,this.container.id="agora-video-player-".concat(this.trackId),this.videoElement.id="video_".concat(this.trackId),this.config.fit?this.videoElement.style.objectFit=this.config.fit:this.videoElement.style.objectFit="cover",(i=this.slot)===null||i===void 0||i.appendChild(this.container)):this.createElements())}updateVideoTrack(e){this.videoTrack!==e&&(this.videoTrack=e,this.createElements())}play(e){var n;(n=this.container)!==null&&n!==void 0&&n.contains(this.videoElement)&&super.play(e)}getCurrentFrame(){var e;return(e=this.container)!==null&&e!==void 0&&e.contains(this.videoElement)?super.getCurrentFrame():new ImageData(2,2)}async getCurrentFrameToUint8Array(e){var n;let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1;return(n=this.container)!==null&&n!==void 0&&n.contains(this.videoElement)?await super.getCurrentFrameToUint8Array(e,i):await wS(e)}destroy(){if(super.destroy(),this.videoElement.remove(),this.videoElement=document.createElement("video"),this.container){try{var e;this.container.remove(),(e=this.slot)===null||e===void 0||e.removeChild(this.container)}catch{}this.container=void 0}}createElements(){var e;this.container||(this.container=document.createElement("div")),this.container.id="agora-video-player-".concat(this.trackId),this.container.style.width="100%",this.container.style.height="100%",this.container.style.position="relative",this.container.style.overflow="hidden",this.videoTrack?(this.container.style.backgroundColor="black",I("KEEP_LAST_FRAME")&&this.isKeepLastFrame&&this.videoElement.paused&&this.resetVideoElement(),this.mountedVideoElement()):this.unmountedVideoElement(),(e=this.slot)===null||e===void 0||e.appendChild(this.container)}mountedVideoElement(){var e;!this.container||(e=this.container)!==null&&e!==void 0&&e.contains(this.videoElement)||this.container.appendChild(this.videoElement),super.initVideoElement(),this.videoElement.id="video_".concat(this.trackId),this.videoElement.className="agora_video_player",this.videoElement.style.width="100%",this.videoElement.style.height="100%",this.videoElement.style.position="absolute",this.videoElement.style.left="0",this.videoElement.style.top="0"}unmountedVideoElement(){var e;if((e=this.container)!==null&&e!==void 0&&e.contains(this.videoElement)){super.resetVideoElement();try{this.container&&this.container.removeChild(this.videoElement)}catch{}this.videoElement=document.createElement("video")}}resetVideoElement(){var e;(e=this.container)!==null&&e!==void 0&&e.contains(this.videoElement)&&(super.resetVideoElement(),this.cacheVideoElement=this.videoElement,this.videoElement=document.createElement("video"))}getContainerElement(){return this.container}}var yN,IN,bN,AN,wN,ON,NN,DN,PN,LN,kN,MN,UN,xN,VN,FN,BN,jN,GN,WN,HN,KN,YN,qN,zN,XN,JN,QN,Qt,ZN,$N,tD,eD,nD,iD,rD,sD,Er;let De=(yN=At({argsMap:(t,e,n)=>[t.getTrackId(),typeof e=="string"?e:e instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement",n]}),IN=nn(),bN=At({argsMap:t=>[t.getTrackId()]}),AN=vd("LocalVideoTrack","_enabledMutex"),wN=At({argsMap:(t,e)=>[t.getTrackId(),e]}),ON=nn(),NN=vd("LocalVideoTrack","_enabledMutex"),DN=At({argsMap:(t,e)=>[t.getTrackId(),e]}),PN=nn(),LN=At({argsMap:(t,e)=>[t.getTrackId(),e,t._saveEncodeBitrateRatio]}),kN=nn(),MN=At({argsMap:(t,e)=>[t.getTrackId(),e]}),UN=nn(),xN=nn(),VN=At({argsMap:(t,e,n)=>[t.getTrackId(),e,n]}),FN=nn(),BN=nn(),jN=nn(),GN=At({argsMap:t=>[t.getTrackId()]}),WN=nn(),HN=nn(),KN=nn(),YN=nn(),qN=nn(),zN=At({argsMap:(t,e)=>[t.getTrackId(),e.name]}),XN=At({argsMap:t=>[t.getTrackId()]}),JN=At({argsMap:t=>[t.getTrackId()]}),QN=At({argsMap:(t,e,n)=>[t.getTrackId(),e.label,n]}),Qt=class $U extends Nd{get videoHeight(){if(Mn()){const{height:e}=this._mediaStreamTrack.getSettings();return this._videoHeight=e,this._videoHeight}return this._videoHeight}get videoWidth(){if(Mn()){const{width:e}=this._mediaStreamTrack.getSettings();return this._videoWidth=e,this._videoWidth}return this._videoWidth}get isPlaying(){return!(!this._player||this._player.videoElementStatus!==ti.PLAYING)}get processorDestination(){return this._processorDestination}get processorContext(){return this._processorContext}set processorContext(e){this._processorContext=e}get __className__(){return"LocalVideoTrack"}constructor(e,n,i,r,s,o){if(super(e,s),j(this,"trackMediaType",Od.VIDEO),j(this,"_player",void 0),j(this,"isUseScaleResolutionDownBy",!1),j(this,"_videoVisibleTimer",null),j(this,"_previousVideoVisibleStatus",void 0),j(this,"_clearPreviousVideoVisibleStatus",(()=>this._previousVideoVisibleStatus=void 0)),j(this,"_encoderConfig",void 0),j(this,"_scalabilityMode",{numSpatialLayers:1,numTemporalLayers:1}),j(this,"_optimizationMode",void 0),j(this,"_saveEncodeBitrateRatio",1),j(this,"_videoHeight",void 0),j(this,"_videoWidth",void 0),j(this,"_forceBitrateLimit",void 0),j(this,"_enabled",!0),j(this,"_processorDestination",void 0),j(this,"_processorContext",void 0),Mn()){const{width:a,height:c}=e.getSettings();this._videoWidth=a,this._videoHeight=c}else this.updateMediaStreamTrackResolution();if(this._scalabilityMode=i,this._optimizationMode=r,this._hints=o||[],n&&this._hints.indexOf(Ee.CUSTOM_TRACK)!==-1?this._encoderConfig=Ve(n):this._encoderConfig=n,this._hints.indexOf(Ee.SCREEN_TRACK)===-1)this.updateBitrateFromProfile();else if(Gg(he.CHROME,115)&&jp().indexOf("Windows")!==-1){const a=(function(c,d){if("VideoFrame"in window&&"TransformStream"in window&&Jt().supportWebRTCInsertableStream){const l=new MediaStreamTrackProcessor(c),h=new MediaStreamTrackGenerator({kind:"video"});let p,f,v=Date.now();const S=()=>{T&&(clearInterval(T),T=void 0),p&&(p.close(),p=void 0),c.stop(),f=void 0,h.removeEventListener("ended",S)};let T=window.setInterval((()=>{if(f&&p&&Date.now()-v>1e3)try{h.readyState==="live"?f.enqueue(p.clone()):S()}catch{S()}}),1e3);const b=new TransformStream({transform:(w,D)=>{h.readyState==="live"?(f=D,v=Date.now(),p===void 0?(p=w,D.enqueue(w.clone())):(D.enqueue(p),p=w)):w.close()}});return h.addEventListener("ended",S),l.readable.pipeThrough(b).pipeTo(h.writable),h}})(e);a&&(m.info("local screen video track begin to inject frame"),this._mediaStreamTrack=a)}n&&this._hints.indexOf(Ee.CUSTOM_TRACK)!==-1&&this.setEncoderConfiguration(n),this._processorContext=new O0(this.getTrackId(),"local"),this._processorDestination=new w0(this.processorContext),this.bindProcessorDestinationEvents()}play(e){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(typeof e=="string"){const r=document.getElementById(e);r?e=r:(m.warning("[".concat(this.getTrackId(),'] can not find "#').concat(e,'" element, use document.body')),e=document.body)}m.debug("[".concat(this.getTrackId(),"] start video playback in ").concat(e instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement"),JSON.stringify(n));const i=Ue(Ue(Ue({},this._getDefaultPlayerConfig()),n),{},{trackId:this.getTrackId(),element:e});this._player?this._player.updateConfig(i):(e instanceof HTMLVideoElement?this._player=new OS(i):this._player=new s_(i),this._player.updateVideoTrack(this._mediaStreamTrack)),this._player.play(),this._videoVisibleTimer&&window.clearInterval(this._videoVisibleTimer),this._clearPreviousVideoVisibleStatus(),this._videoVisibleTimer=window.setInterval((()=>{try{const r=this.getVideoElementVisibleStatus();this.safeEmit(wd.VIDEO_ELEMENT_VISIBLE_STATUS,r)}catch{}}),I("CHECK_VIDEO_VISIBLE_INTERVAL"))}stop(){this._player&&(this._videoVisibleTimer&&(window.clearInterval(this._videoVisibleTimer),this._videoVisibleTimer=null),this._clearPreviousVideoVisibleStatus(),this._player.destroy(),this._player=void 0,m.debug("[".concat(this.getTrackId(),"] stop video playback")))}async setEnabled(e,n){if(!n){if(e===this._enabled)return;this.stateCheck("enabled",e)}if(m.info("[".concat(this.getTrackId(),"] start setEnabled"),e),!e){this._originMediaStreamTrack.enabled=!1;try{await Pe(this,_t.NEED_DISABLE_TRACK,this)}catch(i){throw m.error("[".concat(this.getTrackId(),"] setEnabled to false error"),i.toString()),i}return n||(this._enabled=!1),void m.info("[".concat(this.getTrackId(),"] setEnabled to false success"))}this._originMediaStreamTrack.enabled=!0;try{await Pe(this,_t.NEED_ENABLE_TRACK,this)}catch(i){throw m.error("[".concat(this.getTrackId(),"] setEnabled to true error"),i.toString()),i}m.info("[".concat(this.getTrackId(),"] setEnabled to true success")),n||(this._enabled=!0)}async setMuted(e){e!==this._muted&&(this.stateCheck("muted",e),this._muted=e,this._originMediaStreamTrack.enabled=!e,m.debug("[".concat(this.getTrackId(),"] start set muted: ").concat(e)),e?await Pe(this,_t.NEED_MUTE_TRACK,this):await Pe(this,_t.NEED_UNMUTE_TRACK,this))}async setSaveEncodeBitrateRatio(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:this._saveEncodeBitrateRatio;if(this._saveEncodeBitrateRatio!==1&&this._encoderConfig&&this._encoderConfig.bitrateMax&&this._encoderConfig.bitrateMin){this._encoderConfig.bitrateMin=Math.floor(this._encoderConfig.bitrateMin*e),this._encoderConfig.bitrateMax=Math.floor(this._encoderConfig.bitrateMax*e),m.debug("[".concat(this.getTrackId(),"] set save encode bitrate ratio, ").concat(e)),this._saveEncodeBitrateRatio=1;try{await Pe(this,_t.NEED_UPDATE_VIDEO_ENCODER,this)}catch(n){return n.throw(m)}}}async setEncoderConfiguration(e,n){if(!this._enabled)throw new H(A.TRACK_IS_DISABLED,"can not set encoder configuration when track is disabled");if(e=ns(e),I("USE_STANDARD_BITRATE_DEFAULT")&&(delete e.bitrateMax,delete e.bitrateMin),this._forceBitrateLimit&&(e.bitrateMax=this._forceBitrateLimit.max_bitrate?this._forceBitrateLimit.max_bitrate:e.bitrateMax,e.bitrateMin=this._forceBitrateLimit.min_bitrate?this._forceBitrateLimit.min_bitrate:e.bitrateMin),e.width||e.height||e.frameRate){const i=r_({encoderConfig:e});(Mn()||si()||Qr())&&(i.deviceId=void 0),m.debug("[".concat(this.getTrackId(),"] setEncoderConfiguration applyConstraints"),JSON.stringify(e),JSON.stringify(i));try{await this._originMediaStreamTrack.applyConstraints(i),this.updateMediaStreamTrackResolution()}catch(r){const s=new H(A.UNEXPECTED_ERROR,r.toString());throw m.error("[".concat(this.getTrackId(),"] applyConstraints error"),s.toString()),s}}this._encoderConfig=e,this._hints.indexOf(Ee.SCREEN_TRACK)===-1&&this.updateBitrateFromProfile();try{await Pe(this,_t.NEED_UPDATE_VIDEO_ENCODER,this)}catch(i){return i.throw(m)}}getStats(){return oa((()=>{m.warning("[deprecated] LocalVideoTrack.getStats will be removed in the future, use AgoraRTCClient.getLocalVideoStats instead")}),"localVideoTrackGetStatsWarning"),Ji(this,_t.GET_STATS)||Ue({},SS)}async setBeautyEffect(e){m.error("LocalVideoTrack.setBeautyEffect was deprecated, please migrate to agora-extension-beauty-effect")}getCurrentFrameData(){return this._player?this._player.getCurrentFrame():new ImageData(2,2)}async getCurrentFrameImage(e){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1;return this._player?this._player.getCurrentFrameToUint8Array(e,n):await wS(e)}async findClosestProfile(){const{width:e,height:n,frameRate:i}=this.getMediaStreamTrackSettings(),{width:r,height:s,frameRate:o}=this._encoderConfig||{},a=Rd(this._videoWidth||e||r||0),c=Rd(this._videoHeight||n||s||0),d=(function(l,h,p){if(!Array.isArray(I("VIDEO_ENCODER_CONFIG_LIST"))||I("VIDEO_ENCODER_CONFIG_LIST").length===0)return!1;const f=Math.min(l,h);return!(f>=480)&&Ue(Ue({},I("VIDEO_ENCODER_CONFIG_LIST").find((v=>v.height>f))),{},{frameRate:p})})(a,c,Rd(i||o||15));if(d)return m.debug("[".concat(this.getTrackId(),"] find closest profile, ").concat(a,"x").concat(c," => ").concat(JSON.stringify(d))),this.setEncoderConfiguration(d)}async setBitrateLimit(e){m.debug("[".concat(this.getTrackId(),"] set bitrate limit, ").concat(JSON.stringify(e))),e&&(this._forceBitrateLimit=e,this._encoderConfig&&(this._encoderConfig.bitrateMax?this._encoderConfig.bitrateMax=this._encoderConfig.bitrateMax<e.max_bitrate?this._encoderConfig.bitrateMax:e.max_bitrate:this._encoderConfig.bitrateMax=e.max_bitrate,this._encoderConfig.bitrateMin,this._encoderConfig.bitrateMin=e.min_bitrate))}async setOptimizationMode(e){if(e!=="motion"&&e!=="detail"&&e!=="balanced")return void m.error(A.INVALID_PARAMS,"optimization mode must be motion, detail or balanced");const n=this._optimizationMode;try{this._optimizationMode=e,await Pe(this,_t.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this)}catch(i){throw this._optimizationMode=n,m.error("[".concat(this.getTrackId(),"] set optimization mode failed"),i.toString()),i}m.info("[".concat(this.getTrackId(),"] set optimization mode success (").concat(e,")"))}setScalabiltyMode(e){if(e.numSpatialLayers===1&&e.numTemporalLayers!==1)return m.error(A.INVALID_PARAMS,"scalability mode currently not supported, no SVC."),void(this._scalabilityMode={numSpatialLayers:1,numTemporalLayers:1});this._scalabilityMode=e,m.info("[".concat(this.getTrackId(),"] set scalability mode success (").concat(e,")"))}updateMediaStreamTrackResolution(){P0(this._originMediaStreamTrack).then((e=>{let[n,i]=e;this._videoHeight=i,this._videoWidth=n})).catch(su)}_updatePlayerSource(){this._player&&this._player.updateVideoTrack(this._mediaStreamTrack)}_getDefaultPlayerConfig(){return{fit:"contain"}}async setSenderConfiguration(e){if(!this._enabled)throw new H(A.TRACK_IS_DISABLED,"can not set encoder configuration when track is disabled");m.debug("[".concat(this.getTrackId(),"] setSenderConfiguration applyConstraints"),JSON.stringify(e)),e=ns(e),this._forceBitrateLimit&&(e.bitrateMax=this._forceBitrateLimit.max_bitrate?this._forceBitrateLimit.max_bitrate:e.bitrateMax,e.bitrateMin=this._forceBitrateLimit.min_bitrate?this._forceBitrateLimit.min_bitrate:e.bitrateMin),this._encoderConfig=e,this._hints.indexOf(Ee.SCREEN_TRACK)===-1&&this.updateBitrateFromProfile();try{await Pe(this,_t.NEED_UPDATE_VIDEO_ENCODER,this)}catch(n){return n.throw(m)}}updateBitrateFromProfile(){if(!this._encoderConfig)return;const{width:e,height:n,frameRate:i}=this.getMediaStreamTrackSettings();if(!e||!n||!i)return;const{bitrateMax:r,bitrateMin:s}=this._encoderConfig;if(s==null||r==null){const{max:o,min:a}=(function(c,d,l,h,p){const f=I("BITRATE_ADAPTER_TYPE");if(f==="DEFAULT_BITRATE")return{min:h,max:p};if(p===void 0){const v=Math.floor(200*Math.pow(l/15,.6)*Math.pow(c*d/640/360,.75));p=f==="STANDARD_BITRATE"?4*v:2*v,h=h??v}else h=h??Math.floor(p/10);return{min:h,max:p}})(e,n,i,s,r);if(this._encoderConfig.bitrateMin=a,this._encoderConfig.bitrateMax=o,I("VIDEO_STANDARD_BITRATE_VERSION")&&s==null&&r==null){const[c,d]=(function(l,h,p){const f=4*Math.floor(2e5*Math.pow(p/15,.6)*Math.pow(l*h/230400,.75)),v=l*h,S=new Map([[19200,.9],[230400,.85],[518400,.75],[921600,.7],[2073600,.6],[3686400,.5]]),T=new Map([[230400,.95],[518400,.9],[921600,.85],[2073600,.8]]);let b=qi(S).call(S).next().value,w=1;if(S.has(v))b=S.get(v);else{var D;const dt=Fa(D=Array.from(S.entries())).call(D,((Ot,Wt)=>{let[Vt]=Ot,[pe]=Wt;return Vt-pe})),Dt=dt.find((Ot=>{let[Wt]=Ot;return Wt>v}));if(Dt){const Ot=dt.indexOf(Dt);if(Ot>0){const Wt=dt[Ot-1],Vt=(v-Wt[0])/(Dt[0]-Wt[0]);b=Wt[1]+Vt*(Dt[1]-Wt[1])}else b=Dt[1]}else b=dt[dt.length-1][1]}if(T.has(v))w=T.get(v);else{var k;const dt=Fa(k=Array.from(T.entries())).call(k,((Ot,Wt)=>{let[Vt]=Ot,[pe]=Wt;return Vt-pe})),Dt=dt.find((Ot=>{let[Wt]=Ot;return Wt>v}));if(Dt){const Ot=dt.indexOf(Dt);if(Ot>0){const Wt=dt[Ot-1],Vt=(v-Wt[0])/(Dt[0]-Wt[0]);w=Wt[1]+Vt*(Dt[1]-Wt[1])}else w=Dt[1]}else w=dt[dt.length-1][1]}const U=I("VIDEO_NEW_BITRATE_RATIO");U&&U>0&&(b=U/100);const P=Math.floor(f*b),x=Math.floor(65e4*Math.pow(l*h/230400,.5)*Math.pow(p/15,.69));let q=P;const Q=I("VIDEO_STANDARD_BITRATE_VERSION");return Q&&Q>0&&(Q===1?q=f:Q===2?q=P:Q===3&&(q=x)),[Math.floor(q/1e3),w]})(e,n,i);this._encoderConfig.bitrateMax=c,this._encoderConfig.bitrateMin=a?Math.min(a,c):c,this._saveEncodeBitrateRatio=d,m.debug("[".concat(this.getTrackId(),"] update new bitrate from profile, [w: ").concat(e,", h: ").concat(n,", fps: ").concat(i,"] => [brMax: ").concat(this._encoderConfig.bitrateMax,", brMin: ").concat(this._encoderConfig.bitrateMin,", save_bitrate_ratio: ").concat(this._saveEncodeBitrateRatio,"]"))}else m.debug("[".concat(this.getTrackId(),"] update bitrate from profile, [w: ").concat(e,", h: ").concat(n,", fps: ").concat(i,"] => [brMax: ").concat(o,", brMin: ").concat(a,"]")),this._saveEncodeBitrateRatio=1}}getVideoElementVisibleStatus(){try{var e,n;const i=this==null||(e=this._player)===null||e===void 0?void 0:e.getContainerElement(),r={track:this,element:this==null||(n=this._player)===null||n===void 0?void 0:n.getVideoElement(),slot:i?.parentElement},{element:s,slot:o}=r;if(this.isPlaying&&s instanceof HTMLVideoElement&&o instanceof HTMLElement){const a=DO.checkOneElementVisible(s),c=Object.assign({},a);if(c.visible!==this._previousVideoVisibleStatus){this._previousVideoVisibleStatus=c.visible;const d=pt.reportApiInvoke(null,{tag:Ne.TRACER,name:Ge.LOCAL_VIDEO_TRACK_GET_VIDEO_VISIBLE,options:[this.getTrackId()]});c.visible?d.onSuccess("Video is visible"):d.onSuccess("Invisible because of ".concat(c.reason))}return c}return}catch(i){throw new H(A.GET_VIDEO_ELEMENT_VISIBLE_ERROR,i.message)}}async renewMediaStreamTrack(e){}pipe(e){if(this.processor===e)return e;if(e._source)throw new H(A.INVALID_OPERATION,"Processor ".concat(e.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=e,this.processor._source=this,e.updateInput({track:this._originMediaStreamTrack,context:this.processorContext}),e}unpipe(){if(!this.processor)return;const e=this.processor;this.processor._source=void 0,this.processor=void 0,e.reset()}close(){super.close(),this.unbindProcessorDestinationEvents(),this.unbindProcessorContextEvents(),this.unpipe(),this.processorDestination._source&&this.processorDestination._source.unpipe()}clone(e){let n=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1],i=this._encoderConfig;e&&(i=Ue(Ue({},i),ns(e))),i=$a(i);const r=Se(8,"track-video-cloned-"),s=new $U(n?this._mediaStreamTrack.clone():this._mediaStreamTrack,i,$a(this._scalabilityMode),this._optimizationMode,r,$a(this._hints));return e&&i&&s.setEncoderConfiguration(i),m.debug("clone video track from ".concat(this.getTrackId()," to ").concat(r,", clone ").concat(n)),s}async replaceTrack(e,n){if(!(e instanceof MediaStreamTrack))throw new H(A.INVALID_PARAMS,"track should be an instance of MediaStreamTrack");if(e.kind!=="video")throw new H(A.INVALID_PARAMS,"track should be a video MediaStreamTrack");await this._updateOriginMediaStreamTrack(e,n,!0),this.updateMediaStreamTrackResolution()}sendSeiData(e){if(oa((()=>{pt.reportApiInvoke(null,{name:Ge.LOCAL_VIDEO_SEND_SEI_DATA,options:[],tag:Ne.TRACER}).onSuccess("")}),this._mediaStreamTrack.id||this.getTrackId()),!I("ENABLE_VIDEO_SEI")||!I("ENABLE_ENCODED_TRANSFORM"))return void m.warning('To send/receive SEI, please call AgoraRTC.setParameter("ENABLE_VIDEO_SEI", true) before instantiate IAgoraRtcClient');if(e instanceof Uint8Array==0)return new H(A.INVALID_PARAMS,"Invalid argument type, ILocalVideoTrack.sendSeiData() only accept Uint8Array argument.").throw();const n=this.getRTCRtpTransceiver();if(!n)return void m.warning("Video track is not published, SEI can not be send");const i=n.sender.getParameters();if(i.codecs.length===0)return;const r=i.codecs[0].mimeType.toLocaleLowerCase();r==="video/h264"||r==="video/h265"?this.safeEmit("sei-to-send",e):m.warning("SEI is not supported by ".concat(r))}bindProcessorDestinationEvents(){this.processorDestination.on(gi.ON_TRACK,(async e=>{e?e!==this._mediaStreamTrack&&(this._mediaStreamTrack=e,this._updatePlayerSource(),await Pe(this,_t.NEED_REPLACE_TRACK,this)):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await Pe(this,_t.NEED_REPLACE_TRACK,this))}))}unbindProcessorDestinationEvents(){this.processorDestination.removeAllListeners(gi.ON_TRACK)}unbindProcessorContextEvents(){this.processorContext.removeAllListeners(pr.REQUEST_UPDATE_CONSTRAINTS),this.processorContext.removeAllListeners(pr.REQUEST_CONSTRAINTS)}},re(Qt.prototype,"play",[yN,IN],Object.getOwnPropertyDescriptor(Qt.prototype,"play"),Qt.prototype),re(Qt.prototype,"stop",[bN],Object.getOwnPropertyDescriptor(Qt.prototype,"stop"),Qt.prototype),re(Qt.prototype,"setEnabled",[AN,wN,ON],Object.getOwnPropertyDescriptor(Qt.prototype,"setEnabled"),Qt.prototype),re(Qt.prototype,"setMuted",[NN,DN,PN],Object.getOwnPropertyDescriptor(Qt.prototype,"setMuted"),Qt.prototype),re(Qt.prototype,"setSaveEncodeBitrateRatio",[LN,kN],Object.getOwnPropertyDescriptor(Qt.prototype,"setSaveEncodeBitrateRatio"),Qt.prototype),re(Qt.prototype,"setEncoderConfiguration",[MN,UN],Object.getOwnPropertyDescriptor(Qt.prototype,"setEncoderConfiguration"),Qt.prototype),re(Qt.prototype,"getStats",[xN],Object.getOwnPropertyDescriptor(Qt.prototype,"getStats"),Qt.prototype),re(Qt.prototype,"setBeautyEffect",[VN,FN],Object.getOwnPropertyDescriptor(Qt.prototype,"setBeautyEffect"),Qt.prototype),re(Qt.prototype,"getCurrentFrameData",[BN],Object.getOwnPropertyDescriptor(Qt.prototype,"getCurrentFrameData"),Qt.prototype),re(Qt.prototype,"getCurrentFrameImage",[jN],Object.getOwnPropertyDescriptor(Qt.prototype,"getCurrentFrameImage"),Qt.prototype),re(Qt.prototype,"findClosestProfile",[GN,WN],Object.getOwnPropertyDescriptor(Qt.prototype,"findClosestProfile"),Qt.prototype),re(Qt.prototype,"setBitrateLimit",[HN],Object.getOwnPropertyDescriptor(Qt.prototype,"setBitrateLimit"),Qt.prototype),re(Qt.prototype,"setOptimizationMode",[KN],Object.getOwnPropertyDescriptor(Qt.prototype,"setOptimizationMode"),Qt.prototype),re(Qt.prototype,"setScalabiltyMode",[YN],Object.getOwnPropertyDescriptor(Qt.prototype,"setScalabiltyMode"),Qt.prototype),re(Qt.prototype,"updateMediaStreamTrackResolution",[qN],Object.getOwnPropertyDescriptor(Qt.prototype,"updateMediaStreamTrackResolution"),Qt.prototype),re(Qt.prototype,"pipe",[zN],Object.getOwnPropertyDescriptor(Qt.prototype,"pipe"),Qt.prototype),re(Qt.prototype,"unpipe",[XN],Object.getOwnPropertyDescriptor(Qt.prototype,"unpipe"),Qt.prototype),re(Qt.prototype,"close",[JN],Object.getOwnPropertyDescriptor(Qt.prototype,"close"),Qt.prototype),re(Qt.prototype,"replaceTrack",[QN],Object.getOwnPropertyDescriptor(Qt.prototype,"replaceTrack"),Qt.prototype),Qt),o_=(ZN=At({argsMap:(t,e)=>[t.getTrackId(),e]}),$N=nn(),tD=vd("CameraVideoTrack","_enabledMutex"),eD=At({argsMap:(t,e)=>[t.getTrackId(),e]}),nD=nn(),iD=At({argsMap:(t,e)=>[t.getTrackId(),e]}),rD=nn(),sD=At({argsMap:t=>[t.getTrackId()]}),Er=class t2 extends De{get __className__(){return"CameraVideoTrack"}constructor(e,n,i,r,s,o){super(e,ns(n.encoderConfig),r,s,o),j(this,"_config",void 0),j(this,"_originalConstraints",void 0),j(this,"_constraints",void 0),j(this,"_enabled",!0),j(this,"_deviceName","default"),j(this,"tryResumeVideoForIOS15_16WeChat",(async()=>{(gd()||Kg())&&!(function(){const a=de();if(a.os!==On.IOS||!a.osVersion)return!1;const c=a.osVersion.split(".");return Number(c[0])===15&&Number(c[1])>=2})()&&yO()&&this._enabled&&!this._isClosed&&(m.debug("[".concat(this.getTrackId(),"] try capture camera media device for interrupted iOS 15 device on WeChat.")),await this.renewMediaStreamTrack())})),this._config=n,this._originalConstraints=i,this._constraints=i,this._deviceName=e.label,this._encoderConfig=ns(this._config.encoderConfig),Ie.on(Yn.IOS_15_16_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat),Ie.on(Yn.IOS_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat),this.bindProcessorContextEvents()}async setDevice(e){return typeof e=="string"?this._setDeviceById(e):e.deviceId?this._setDeviceById(e.deviceId):e.facingMode?this._setDeviceByFacingModel(e.facingMode):void 0}async _setDeviceById(e){if(m.info("[".concat(this.getTrackId(),"] set device to ").concat(e)),this._enabled)try{const n=await mr.getDeviceById(e),i={};i.video=Ue({},this._constraints),i.video.deviceId={exact:e},i.video.facingMode=void 0,this._originMediaStreamTrack.stop();let r=null;try{r=await fr(i,this.getTrackId())}catch(s){throw m.error("[".concat(this.getTrackId(),"] setDevice failed"),s.toString()),r=await fr({video:this._constraints},this.getTrackId()),await this._updateOriginMediaStreamTrack(r.getVideoTracks()[0],!1),s}await this._updateOriginMediaStreamTrack(r.getVideoTracks()[0],!1),this.updateMediaStreamTrackResolution(),this._deviceName=n.label,this._config.cameraId=e,this._constraints.deviceId={exact:e}}catch(n){throw m.error("[".concat(this.getTrackId(),"] setDevice error"),n.toString()),n}else try{const n=await mr.getDeviceById(e);this._deviceName=n.label,this._config.cameraId=e,this._constraints.deviceId={exact:e}}catch(n){throw m.error("[".concat(this.getTrackId(),"] setDevice error"),n.toString()),n}m.info("[".concat(this.getTrackId(),"] setDevice success"))}async _setDeviceByFacingModel(e){m.info("[".concat(this.getTrackId(),"] set facingMode ").concat(e));const n={video:Ue(Ue({},this._constraints),{},{deviceId:void 0,facingMode:{exact:e}})};if(this._enabled){this._originMediaStreamTrack.stop();let i=null;try{i=await fr(n,this.getTrackId())}catch(r){throw m.error("[".concat(this.getTrackId(),"] setDeviceByFacingModel failed"),r.toString()),i=await fr({video:this._constraints},this.getTrackId()),await this._updateOriginMediaStreamTrack(i.getVideoTracks()[0],!1),r}await this._updateOriginMediaStreamTrack(i.getVideoTracks()[0],!1),this.updateMediaStreamTrackResolution()}this._deviceName="",this._config.facingMode=e,this._config.cameraId=void 0,this._constraints=Ue({},n.video),m.info("[".concat(this.getTrackId(),"] setDeviceByFacingModel success"))}async setEnabled(e,n){if(!n){if(e===this._enabled)return;this.stateCheck("enabled",e)}if(m.info("[".concat(this.getTrackId(),"] start setEnabled"),e),e){try{if(this.isExternalTrack)this._originMediaStreamTrack.enabled=!0;else{const i=await fr({video:this._constraints},this.getTrackId());await this._updateOriginMediaStreamTrack(i.getVideoTracks()[0],!1)}await Pe(this,_t.NEED_ENABLE_TRACK,this)}catch(i){throw m.error("[".concat(this.getTrackId(),"] setEnabled true error"),i.toString()),i}this.updateMediaStreamTrackResolution(),m.info("[".concat(this.getTrackId(),"] setEnabled to true success")),n||(this._enabled=!0)}else{this.isExternalTrack?this._originMediaStreamTrack.enabled=!1:(this._originMediaStreamTrack.onended=null,this._originMediaStreamTrack.stop()),n||(this._enabled=!1);try{await Pe(this,_t.NEED_DISABLE_TRACK,this)}catch(i){throw m.error("[".concat(this.getTrackId(),"] setEnabled to false error"),i.toString()),i}m.info("[".concat(this.getTrackId(),"] setEnabled to false success"))}}async setEncoderConfiguration(e,n){if(!this._enabled)throw new H(A.TRACK_IS_DISABLED,"can not set encoder configuration when track is disabled");e=ns(e),I("USE_STANDARD_BITRATE_DEFAULT")&&(delete e.bitrateMax,delete e.bitrateMin),this._forceBitrateLimit&&(e.bitrateMax=this._forceBitrateLimit.max_bitrate||e.bitrateMax,e.bitrateMin=this._forceBitrateLimit.min_bitrate||e.bitrateMin);const i=Ve(this._config);i.encoderConfig=e;const r=r_(i);(Mn()||si()||Qr())&&(r.deviceId=void 0),m.debug("[".concat(this.getTrackId(),"] setEncoderConfiguration applyConstraints"),JSON.stringify(e),JSON.stringify(r));try{await this._originMediaStreamTrack.applyConstraints(r),this.updateMediaStreamTrackResolution()}catch(s){const o=new H(A.UNEXPECTED_ERROR,s.toString());throw m.error("[".concat(this.getTrackId(),"] applyConstraints error"),o.toString()),o}this._config=i,this._constraints=r,this._originalConstraints=r,this._encoderConfig=e,this._hints.indexOf(Ee.SCREEN_TRACK)===-1&&this.updateBitrateFromProfile();try{await Pe(this,_t.NEED_UPDATE_VIDEO_ENCODER,this)}catch(s){return s.throw(m)}}_getDefaultPlayerConfig(){return{mirror:!0,fit:"cover"}}onTrackEnded(){if((si()||Qr())&&this._enabled&&!this._isClosed&&Ie.duringInterruption){const e=async()=>{Ie.off(Yn.IOS_INTERRUPTION_END,e),this._enabled&&!this._isClosed&&(m.debug("[".concat(this.getTrackId(),"] try capture camera media device for interrupted iOS device.")),await this.setEnabled(!1),await this.setEnabled(!0))};Ie.on(Yn.IOS_INTERRUPTION_END,e)}else m.debug("[".concat(this.getTrackId(),"] track ended")),this.safeEmit(wd.TRACK_ENDED)}async renewMediaStreamTrack(e){const n=e||this._constraints,i=mr.searchDeviceIdByName(this._deviceName);if(i&&!n.deviceId&&(n.deviceId={exact:i}),this._enabled){const r=await fr({video:n},this.getTrackId());this._constraints=n,await this._updateOriginMediaStreamTrack(r.getVideoTracks()[0],!0),this.updateMediaStreamTrackResolution()}}close(){super.close(),Ie.off(Yn.IOS_15_16_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat),Ie.off(Yn.IOS_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat)}clone(e){let n=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1],i=this._encoderConfig;e&&(i=Ue(Ue({},i),ns(e))),i=$a(i);const r=Se(8,"track-cam-cloned-"),s=new t2(n?this._mediaStreamTrack.clone():this._mediaStreamTrack,$a(Ue(Ue({},this._config),{},{encoderConfig:i})),$a(this._constraints),$a(this._scalabilityMode),this._optimizationMode,r);return e&&i&&s.setEncoderConfiguration(i),m.debug("clone track from ".concat(this.getTrackId()," to ").concat(r,", clone ").concat(n)),s}bindProcessorContextEvents(){this.processorContext.on(pr.REQUEST_UPDATE_CONSTRAINTS,(async(e,n,i)=>{try{const r=Object.assign({},this._originalConstraints,...e);await this.renewMediaStreamTrack(r),n()}catch(r){i(r)}})),this.processorContext.on(pr.REQUEST_CONSTRAINTS,(async e=>{e(this._originMediaStreamTrack.getSettings())}))}},re(Er.prototype,"setDevice",[ZN,$N],Object.getOwnPropertyDescriptor(Er.prototype,"setDevice"),Er.prototype),re(Er.prototype,"setEnabled",[tD,eD,nD],Object.getOwnPropertyDescriptor(Er.prototype,"setEnabled"),Er.prototype),re(Er.prototype,"setEncoderConfiguration",[iD,rD],Object.getOwnPropertyDescriptor(Er.prototype,"setEncoderConfiguration"),Er.prototype),re(Er.prototype,"close",[sD],Object.getOwnPropertyDescriptor(Er.prototype,"close"),Er.prototype),Er);function oD(t){const e=Se(8,"track-cus-"),n=pt.reportApiInvoke(null,{id:e,tag:Ne.TRACER,name:Ge.CREATE_CUSTOM_AUDIO_TRACK,options:[t]}),i=new rn(t.mediaStreamTrack,t.encoderConfig?e_(t.encoderConfig):{},e,!1);return m.info("create custom audio track success with config",t,"trackId",i.getTrackId()),n.onSuccess(i.getTrackId()),i}function NS(t,e,n,i){n.optimizationMode&&(i&&i.width&&i.height?(n.encoderConfig=Ue(Ue({},i),{},{bitrateMin:i.bitrateMin,bitrateMax:i.bitrateMax}),n.optimizationMode!=="motion"&&n.optimizationMode!=="detail"||(e.contentHint=n.optimizationMode,e.contentHint===n.optimizationMode?m.debug("[".concat(t,"] set content hint to"),n.optimizationMode):m.debug("[".concat(t,"] set content hint failed")))):m.warning("[".concat(t,"] can not apply optimization mode bitrate config, no encoderConfig")))}var aD,cD,dD,lD,Nr,uD,hD,pD,_D,fD,mD,ED,Zn;class gD extends g0{getUserId(){return this._userId}constructor(e,n,i,r){super(e,"track-".concat(e.kind,"-").concat(n,"-").concat(r.clientId,"_").concat(Se(5,""))),j(this,"_userId",void 0),j(this,"_uintId",void 0),j(this,"_isDestroyed",!1),j(this,"store",void 0),j(this,"processor",void 0),j(this,"processorContext",void 0),this._userId=n,this._uintId=i,this.store=r}_updateOriginMediaStreamTrack(e){this._originMediaStreamTrack=e,this._mediaStreamTrack=e,this._updatePlayerSource(),this.processor&&this.processor.updateInput({track:this._originMediaStreamTrack,context:this.processorContext})}_destroy(){this._isDestroyed=!0,m.info("[".concat(this.getTrackId(),"] is destroyed")),this.stop(),super.close()}getProcessorStats(){return this.processorContext.gatherStats()}getProcessorUsage(){return this.processorContext.gatherUsage()}}let Ld=(aD=At({argsMap:(t,e,n)=>[t.getTrackId(),typeof e=="string"?e:e instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement",n]}),cD=At({argsMap:t=>[t.getTrackId()]}),dD=At({argsMap:(t,e)=>[t.getTrackId(),e.name]}),lD=At({argsMap:t=>[t.getTrackId()]}),re((Nr=class extends gD{get isPlaying(){return!(!this._player||this._player.videoElementStatus!==ti.PLAYING)}get __className__(){return"RemoteVideoTrack"}constructor(t,e,n,i,r){super(t,e,n,i),j(this,"_videoVisibleTimer",null),j(this,"_previousVideoVisibleStatus",void 0),j(this,"_clearPreviousVideoVisibleStatus",(()=>this._previousVideoVisibleStatus=void 0)),j(this,"trackMediaType",Od.VIDEO),j(this,"_videoWidth",void 0),j(this,"_videoHeight",void 0),j(this,"_player",void 0),j(this,"_prePlayer",void 0),j(this,"processorDestination",void 0),j(this,"processorContext",void 0),this._prePlayer=r,this.updateMediaStreamTrackResolution(),this.processorContext=new O0(this.getTrackId(),"remote"),this.processorDestination=new w0(this.processorContext),this.bindProcessorDestinationEvents()}getStats(){return oa((()=>{m.warning("[deprecated] RemoteVideoTrack.getStats will be removed in the future, use AgoraRTCClient.getRemoteVideoStats instead")}),"remoteVideoTrackGetStatsWarning"),Ji(this,_t.GET_STATS)||Ue({},m0)}play(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(this.safeEmit(Or.PLAY_START),typeof t=="string"){const i=document.getElementById(t);i?t=i:(m.warning("[".concat(this.getTrackId(),'] can not find "#').concat(t,'" element, use document.body')),t=document.body)}m.debug("[".concat(this.getTrackId(),"] start video playback in ").concat(t instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement"),JSON.stringify(e));const n=Ue(Ue({fit:"cover"},e),{},{trackId:this.getTrackId(),element:t});if(this._player)this._player.updateConfig(n);else{let i=!1,r=!1;t instanceof HTMLVideoElement?(this._player=new OS(n),this._prePlayer&&(this._prePlayer.destroy(),this._prePlayer=void 0,r=!0)):this._prePlayer&&!this._prePlayer.isDestroyed?(this._player=this._prePlayer,this._prePlayer=void 0,i=this._player.videoState>0,this._player.updateConfig(n)):this._player=new s_(n),this._player.updateVideoTrack(this._mediaStreamTrack),this._player.onFirstVideoFrameDecoded=()=>{this.store.subscribe(this.getUserId(),"video",void 0,void 0,Date.now()),this.safeEmit(Or.FIRST_FRAME_DECODED),r&&this.safeEmit(Or.FIRST_FRAME_RENDER)},this._player.onVideoStateChanged=s=>{this.safeEmit(Or.VIDEO_STATE_CHANGED,s)},i&&(this._player.onFirstVideoFrameDecoded(),this._player.onVideoStateChanged(this._player.videoState))}this._player.play(this.store.sessionId||void 0),this._videoVisibleTimer&&window.clearInterval(this._videoVisibleTimer),this._clearPreviousVideoVisibleStatus(),this._videoVisibleTimer=window.setInterval((()=>{try{const i=this.getVideoElementVisibleStatus();this.safeEmit(Or.VIDEO_ELEMENT_VISIBLE_STATUS,i)}catch{}}),I("CHECK_VIDEO_VISIBLE_INTERVAL")),this.safeEmit(Or.PLAY_END)}stop(){let t=arguments.length>0&&arguments[0]!==void 0&&arguments[0];this._player&&(this._videoVisibleTimer&&(window.clearInterval(this._videoVisibleTimer),this._videoVisibleTimer=null),this._clearPreviousVideoVisibleStatus(),this._player.destroy(t),this._player=void 0,m.debug("[".concat(this.getTrackId(),"] stop video playback")))}getCurrentFrameData(){return this._player?this._player.getCurrentFrame():new ImageData(2,2)}updateMediaStreamTrackResolution(){P0(this._originMediaStreamTrack).then((t=>{let[e,n]=t;this._videoHeight=n,this._videoWidth=e})).catch(su)}_updatePlayerSource(){m.debug("[".concat(this.getTrackId(),"] update player source track")),this._player&&this._player.updateVideoTrack(this._mediaStreamTrack)}getVideoElementVisibleStatus(){try{var t,e;const n=this==null||(t=this._player)===null||t===void 0?void 0:t.getContainerElement(),i={track:this,element:this==null||(e=this._player)===null||e===void 0?void 0:e.getVideoElement(),slot:n?.parentElement},{element:r,slot:s}=i;if(this.isPlaying&&r instanceof HTMLVideoElement&&s instanceof HTMLElement){const o=DO.checkOneElementVisible(r),a=Object.assign({},o);if(a.visible!==this._previousVideoVisibleStatus){this._previousVideoVisibleStatus=a.visible;const c=pt.reportApiInvoke(null,{tag:Ne.TRACER,name:Ge.REMOTE_VIDEO_TRACK_GET_VIDEO_VISIBLE,options:[this.getTrackId()]});a.visible?c.onSuccess("Video is visible"):c.onSuccess("Invisible because of ".concat(a.reason))}return a}return}catch(n){throw new H(A.GET_VIDEO_ELEMENT_VISIBLE_ERROR,n.message)}}pipe(t){if(this.processor===t)return t;if(t._source)throw new H(A.INVALID_OPERATION,"Processor ".concat(t.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=t,this.processor._source=this,t.updateInput({track:this._originMediaStreamTrack,context:this.processorContext}),t}unpipe(){if(!this.processor)return;const t=this.processor;this.processor._source=void 0,this.processor=void 0,t.reset()}bindProcessorDestinationEvents(){this.processorDestination.on(gi.ON_TRACK,(async t=>{t?t!==this._mediaStreamTrack&&(this._mediaStreamTrack=t,this._updatePlayerSource()):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource())}))}unbindProcessorDestinationEvents(){this.processorDestination.removeAllListeners(gi.ON_TRACK)}_destroy(){this._prePlayer&&(this._prePlayer.destroy(),this._prePlayer=void 0),super._destroy(),this.unbindProcessorDestinationEvents()}_onSei(t){this.emit(sc.SEI_RECEIVED,t)}}).prototype,"play",[aD],Object.getOwnPropertyDescriptor(Nr.prototype,"play"),Nr.prototype),re(Nr.prototype,"stop",[cD],Object.getOwnPropertyDescriptor(Nr.prototype,"stop"),Nr.prototype),re(Nr.prototype,"pipe",[dD],Object.getOwnPropertyDescriptor(Nr.prototype,"pipe"),Nr.prototype),re(Nr.prototype,"unpipe",[lD],Object.getOwnPropertyDescriptor(Nr.prototype,"unpipe"),Nr.prototype),Nr),kd=(uD=At({argsMap:(t,e)=>[t.getTrackId(),e],throttleTime:300}),hD=At({argsMap:(t,e)=>[t.getTrackId(),e],throttleTime:300}),pD=At({argsMap:(t,e)=>[t.getTrackId(),e]}),_D=At({argsMap:t=>[t.getTrackId()]}),fD=At({argsMap:t=>[t.getTrackId()]}),mD=At({argsMap:(t,e)=>[t.getTrackId(),e.name]}),ED=At({argsMap:t=>[t.getTrackId()]}),re((Zn=class extends gD{get isPlaying(){return this._useAudioElement?ci.isPlaying(this.getTrackId()):this._source.isPlayed}get __className__(){return"RemoteAudioTrack"}constructor(t,e,n,i){super(t,e,n,i),j(this,"trackMediaType",Od.AUDIO),j(this,"_source",void 0),j(this,"_useAudioElement",!0),j(this,"_volume",100),j(this,"processorContext",void 0),j(this,"processorDestination",void 0),j(this,"_played",!1),j(this,"_bypassWebAudio",!1),I("DISABLE_WEBAUDIO")?(this._source=new AS,this._bypassWebAudio=!0,this._useAudioElement=!0):(this._source=new yS(t,!0),I("REMOTE_AUDIO_TRACK_USES_WEB_AUDIO")&&(this._useAudioElement=!1)),this._source.once(hr.RECEIVE_TRACK_BUFFER,(()=>{this.safeEmit(Or.FIRST_FRAME_DECODED)})),this.processorContext=new D0(this._source.context,this.getTrackId(),"remote"),this.processorDestination=new N0(this.processorContext),this.bindProcessorDestinationEvents(),this._source.on(hr.UPDATE_SOURCE,(()=>{this.processor&&this.processor.updateInput({node:this._source.processSourceNode,context:this.processorContext})}))}setAudioFrameCallback(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:4096;if(!t)return this._source.removeAllListeners(hr.ON_AUDIO_BUFFER),void this._source.stopGetAudioBuffer();this._source.startGetAudioBuffer(e),this._source.removeAllListeners(hr.ON_AUDIO_BUFFER),this._source.on(hr.ON_AUDIO_BUFFER,(n=>t(n)))}setVolume(t){this._volume=t,this._useAudioElement?ci.setVolume(this.getTrackId(),t):this._source.setVolume(t/100)}setAmplifiedVolume(t){this._useAudioElement&&this._played&&(ci.stop(this.getTrackId()),this._source.play()),this._useAudioElement=!1,t=Math.min(t,I("MAX_WEBAUDIO_VOLUME")),this._volume=t,this._source.setVolume(t/100)}async setPlaybackDevice(t){if(!this._useAudioElement||!d0())throw new H(A.NOT_SUPPORTED,"your browser does not support setting the audio output device");await ci.setSinkID(this.getTrackId(),t)}getVolumeLevel(){return this._source.getAccurateVolumeLevel()}getVolume(){return this._useAudioElement?ci.getVolume(this.getTrackId()):this._source instanceof yS?this._source.getAudioVolume():0}getStats(){return oa((()=>{m.warning("[deprecated] RemoteAudioTrack.getStats will be removed in the future, use AgoraRTCClient.getRemoteAudioStats instead")}),"remoteAudioTrackGetStatsWarning"),Ji(this,_t.GET_STATS)||Ue({},f0)}play(){m.debug("[".concat(this.getTrackId(),"] start audio playback")),this._played=!0,this._useAudioElement?(m.debug("[".concat(this.getTrackId(),"] use audio element to play")),ci.play(this._mediaStreamTrack,this.getTrackId(),this._volume,this.store.sessionId||void 0)):(m.debug("[".concat(this.getTrackId(),"] use audio context to play")),this._source.play())}stop(){m.debug("[".concat(this.getTrackId(),"] stop audio playback")),this._played=!1,this._useAudioElement?ci.stop(this.getTrackId()):this._source.stop()}_destroy(){super._destroy(),this._played=!1,this.unbindProcessorDestinationEvents(),this._source.destroy()}_isFreeze(){return this._source.isFreeze}_updatePlayerSource(){let t=!(arguments.length>0&&arguments[0]!==void 0)||arguments[0];m.debug("[".concat(this.getTrackId(),"] update player source track")),t&&this._source.updateTrack(this._mediaStreamTrack),this._useAudioElement&&ci.updateTrack(this.getTrackId(),this._mediaStreamTrack)}pipe(t){if(this._bypassWebAudio)throw new H(A.NOT_SUPPORTED,"can not pipe extension when WebAudio disabled");if(this.processor===t)return t;if(t._source)throw new H(A.INVALID_OPERATION,"Processor ".concat(t.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=t,this.processor._source=this,t.updateInput({track:this._originMediaStreamTrack,node:this._source.processSourceNode,context:this.processorContext}),t}unpipe(){var t;if(this._bypassWebAudio)throw new H(A.NOT_SUPPORTED,"can not unpipe extension when WebAudio disabled");if(!this.processor)return;const e=this.processor;(t=this._source.processSourceNode)===null||t===void 0||t.disconnect(),this.processor._source=!1,this.processor=void 0,e.reset()}bindProcessorDestinationEvents(){this.processorDestination.on(gi.ON_TRACK,(async t=>{t?t!==this._mediaStreamTrack&&(this._mediaStreamTrack=t,this._updatePlayerSource(!1),this._source.processedNode=this._source.createMediaStreamSourceNode(t)):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource())})),this.processorDestination.on(gi.ON_NODE,(t=>{this._source.processedNode=t;const e=!t;this._useAudioElement!==e&&(this._played?(this.stop(),this._useAudioElement=e,this.play()):this._useAudioElement=e)}))}unbindProcessorDestinationEvents(){this.processorDestination.removeAllListeners(gi.ON_TRACK),this.processorDestination.removeAllListeners(gi.ON_NODE)}}).prototype,"setVolume",[uD],Object.getOwnPropertyDescriptor(Zn.prototype,"setVolume"),Zn.prototype),re(Zn.prototype,"setAmplifiedVolume",[hD],Object.getOwnPropertyDescriptor(Zn.prototype,"setAmplifiedVolume"),Zn.prototype),re(Zn.prototype,"setPlaybackDevice",[pD],Object.getOwnPropertyDescriptor(Zn.prototype,"setPlaybackDevice"),Zn.prototype),re(Zn.prototype,"play",[_D],Object.getOwnPropertyDescriptor(Zn.prototype,"play"),Zn.prototype),re(Zn.prototype,"stop",[fD],Object.getOwnPropertyDescriptor(Zn.prototype,"stop"),Zn.prototype),re(Zn.prototype,"pipe",[mD],Object.getOwnPropertyDescriptor(Zn.prototype,"pipe"),Zn.prototype),re(Zn.prototype,"unpipe",[ED],Object.getOwnPropertyDescriptor(Zn.prototype,"unpipe"),Zn.prototype),Zn);const Qi=new class extends qe{get visibility(){return document.visibilityState}get lastHiddenTime(){return this._lastHiddenTime}get lastVisibleTime(){return this._lastVisibleTime}constructor(){super(),j(this,"_lastHiddenTime",0),j(this,"_lastVisibleTime",0),j(this,"needUploadStats",[]),j(this,"isCollectingStats",!1),document.addEventListener("visibilitychange",(()=>{document.visibilityState==="hidden"?this._lastHiddenTime=performance.now():this._lastVisibleTime=performance.now(),this.isCollectingStats&&this.needUploadStats.push(document.visibilityState==="visible"?1:0),m.debug("current web page is ".concat(document.visibilityState)),this.emit("VISIBILITY_CHANGE",document.visibilityState)}))}startCollectStats(){this.isCollectingStats=!0,this.needUploadStats.push(this.visibility==="visible"?1:0)}stopCollectStats(){this.isCollectingStats=!1,this.needUploadStats.length=0}};class SD extends qe{constructor(e,n){super(),j(this,"trackMediaType",Od.DATA),j(this,"_version",1),j(this,"_type",3),j(this,"_config",void 0),j(this,"_originDataChannel",void 0),j(this,"_dataStreamPacketHeader",new ArrayBuffer(4)),j(this,"_dataStreamPacketHandler",{serialize:i=>i,deserialize:i=>i}),j(this,"_datachannelEventMap",new Map),this._config=e,n&&(this._originDataChannel=n,this._bandDataChannelEvents(n)),this._initPacketHeader()}useDataStream(e){this._dataStreamPacketHandler=e}get id(){return this._config.id}get ordered(){return this._config.ordered}get maxRetransmits(){return I("DATASTREAM_MAX_RETRANSMITS")}get metadata(){return this._config.metadata}get readyState(){var e,n;return(e=(n=this._originDataChannel)===null||n===void 0?void 0:n.readyState)!==null&&e!==void 0?e:"connecting"}get _originDataChannelId(){var e,n;return(e=(n=this._originDataChannel)===null||n===void 0?void 0:n.id)!==null&&e!==void 0?e:null}getChannelId(){return this.id}getConfig(){return this._config}_close(){this._originDataChannel&&(this._unbindDataChannelEvents(this._originDataChannel),this._originDataChannel=void 0)}async _waitTillOpen(){return new st(((e,n)=>{if(this._originDataChannel){this._originDataChannel.readyState==="open"&&e();const i=setTimeout((()=>{var r;n(new H(A.DATACHANNEL_CONNECTION_TIMEOUT,"Cannot create datachannel, id: ".concat((r=this._originDataChannel)===null||r===void 0?void 0:r.id)))}),1e4);this._originDataChannel.onopen=()=>{clearTimeout(i),this._originDataChannel&&this._bandDataChannelEvents(this._originDataChannel),e()},this._originDataChannel.onerror=()=>{throw clearTimeout(i),new H(A.DATACHANNEL_CONNECTION_TIMEOUT)}}else n(new H(A.DATACHANNEL_CONNECTION_TIMEOUT,"cannot find dataChannel"))}))}_updateOriginDataChannel(e){this._originDataChannel=e,this._bandDataChannelEvents(e)}_initPacketHeader(){const e=new DataView(this._dataStreamPacketHeader);e.setUint16(0,this._version),e.setUint8(2,this._type),e.setUint8(3,this._config.id)}_bandDataChannelEvents(e){this._unbindDataChannelEvents(e),[n_.OPEN,n_.CLOSE,n_.ERROR].forEach((n=>{const i=()=>{this.emit(n)};this._datachannelEventMap.set(n,i),e.addEventListener(n,i)}))}_unbindDataChannelEvents(e){Array.from(this._datachannelEventMap.entries()).forEach((n=>{let[i,r]=n;e.removeEventListener(i,r)})),this._datachannelEventMap.clear()}}class P8 extends SD{constructor(e){super(e),j(this,"_messageListener",void 0),this._messageListener=n=>{if(n.data.byteLength<this._dataStreamPacketHeader.byteLength)throw Error("invalid byteLength: the byte length must exceed "+this._dataStreamPacketHeader.byteLength);const i=n.data.slice(0,this._dataStreamPacketHeader.byteLength),r=new DataView(i).getUint8(3);if(r!==this.id)return void(I("SHOW_DATASTREAM2_LOG")&&m.debug("invalid datachannel id: ".concat(r," !== ").concat(this.id)));let s=n.data.slice(this._dataStreamPacketHeader.byteLength);s=this._dataStreamPacketHandler.deserialize(s),this.emit(n_.MESSAGE,s)}}_updateOriginDataChannel(e){super._updateOriginDataChannel(e),this._bandRemoteDataChannelEvents()}_close(){this._originDataChannel&&(this._originDataChannel.removeEventListener("message",this._messageListener),super._close())}_bandRemoteDataChannelEvents(){this._originDataChannel&&this._originDataChannel.addEventListener("message",this._messageListener)}}class L8 extends SD{send(e){if(this._originDataChannel){let n=e;n=this._dataStreamPacketHandler.serialize(e);const i=new Uint8Array(this._dataStreamPacketHeader.byteLength+n.byteLength);i.set(new Uint8Array(this._dataStreamPacketHeader),0),i.set(new Uint8Array(n),this._dataStreamPacketHeader.byteLength),this._originDataChannel.send(i.buffer)}}}function a_(){const t=new Blob([atob("Y29uc3QgdD0idmlkZW8vaDI2NCIsZT0idmlkZW8vaDI2NSI7ZnVuY3Rpb24gbih0LGUsbil7bGV0IGE9bmV3IFVpbnQ4QXJyYXkodCxlLG4pLHI9W10sbz0wO2Zvcig7ci5sZW5ndGg8bjspbyszPG4mJjA9PT1hW29dJiYwPT09YVtvKzFdJiYzPT09YVtvKzJdJiYoMD09PWFbbyszXXx8MT09PWFbbyszXXx8Mj09PWFbbyszXXx8Mz09PWFbbyszXSk/KHIucHVzaChhW29dLGFbbysxXSxhW28rM10pLG8rPTQpOihyLnB1c2goYVtvXSksbysrKTtyZXR1cm4gbmV3IFVpbnQ4QXJyYXkocil9ZnVuY3Rpb24gYShhLHIpe3N3aXRjaChyKXtjYXNlIHQ6cmV0dXJuIGZ1bmN0aW9uKHQpe2NvbnN0IGU9bmV3IERhdGFWaWV3KHQuZGF0YSk7bGV0IGE9MDtmb3IoO2ErNDx0LmRhdGEuYnl0ZUxlbmd0aDspe2lmKDA9PT1lLmdldFVpbnQ4KGErMCkmJjA9PT1lLmdldFVpbnQ4KGErMSkmJjA9PT1lLmdldFVpbnQ4KGErMikmJjE9PT1lLmdldFVpbnQ4KGErMykmJjY9PT1lLmdldFVpbnQ4KGErNCkpe2xldCByPWErNixvPTAsaT0wO2Zvcig7MjU1PT09KGk9ZS5nZXRVaW50OChyKyspKTspbys9MjU1O28rPWk7Y29uc3Qgcz1uKHQuZGF0YSxyLG8pO3JldHVybiBuZXcgVWludDhBcnJheShzKX1hKyt9cmV0dXJuIG51bGx9KGEpO2Nhc2UgZTpyZXR1cm4gZnVuY3Rpb24odCl7Y29uc3QgZT1uZXcgRGF0YVZpZXcodC5kYXRhKTtsZXQgYT0wO2Zvcig7YSs1PHQuZGF0YS5ieXRlTGVuZ3RoOyl7aWYoMD09PWUuZ2V0VWludDgoYSswKSYmMD09PWUuZ2V0VWludDgoYSsxKSYmMD09PWUuZ2V0VWludDgoYSsyKSYmMT09PWUuZ2V0VWludDgoYSszKSYmNzg9PT1lLmdldFVpbnQ4KGErNCkmJjE9PT1lLmdldFVpbnQ4KGErNSkmJjEwMT09PWUuZ2V0VWludDgoYSs2KSl7bGV0IHI9YSs3LG89MCxpPTA7Zm9yKDsyNTU9PT0oaT1lLmdldFVpbnQ4KHIrKykpOylvKz0yNTU7bys9aTtjb25zdCBzPW4odC5kYXRhLHIsbyk7cmV0dXJuIG5ldyBVaW50OEFycmF5KHMpfWErK31yZXR1cm4gbnVsbH0oYSk7ZGVmYXVsdDpyZXR1cm4gbnVsbH19ZnVuY3Rpb24gcih0KXtjb25zdCBlPXQubGVuZ3RoO2xldCBuPVtdLGE9MDtmb3IoO2E8ZTspYSsyPGUmJjA9PT10W2FdJiYwPT09dFthKzFdJiYoMD09PXRbYSsyXXx8MT09PXRbYSsyXXx8Mj09PXRbYSsyXXx8Mz09PXRbYSsyXSk/KG4ucHVzaCh0W2FdLHRbYSsxXSwzLHRbYSsyXSksYSs9Myk6KG4ucHVzaCh0W2FdKSxhKyspO3JldHVybiBuZXcgVWludDhBcnJheShuKX1mdW5jdGlvbiBvKG4sYSxvKXtzd2l0Y2gobyl7Y2FzZSB0OnJldHVybiBmdW5jdGlvbih0LGUpe2NvbnN0IG49cihlKSxhPW4ubGVuZ3RoLG89TWF0aC5mbG9vcihhLzI1NSksaT1hJTI1NSxzPW5ldyBVaW50OEFycmF5KDYrbysxK2ErdC5ieXRlTGVuZ3RoKTtzWzBdPTAsc1sxXT0wLHNbMl09MCxzWzNdPTEsc1s0XT02LHNbNV09MTAxO2xldCBmPTA7Zm9yKDtmPG87KXNbNitmXT0yNTUsZisrO3JldHVybiBzWzYrZl09aSxmKysscy5zZXQobiw2K2YpLHMuc2V0KG5ldyBVaW50OEFycmF5KHQpLDYrZithKSxzLmJ1ZmZlcn0obixhKTtjYXNlIGU6cmV0dXJuIGZ1bmN0aW9uKHQsZSl7Y29uc3Qgbj1yKGUpLGE9bi5sZW5ndGgsbz1NYXRoLmZsb29yKGEvMjU1KSxpPWElMjU1LHM9bmV3IFVpbnQ4QXJyYXkoNytvKzErYSsxK3QuYnl0ZUxlbmd0aCk7c1swXT0wLHNbMV09MCxzWzJdPTAsc1szXT0xLHNbNF09Nzgsc1s1XT0xLHNbNl09MTAxO2xldCBmPTA7Zm9yKDtmPG87KXNbNytmXT0yNTUsZisrO3JldHVybiBzWzcrZl09aSxmKysscy5zZXQobiw3K2YpLGYrPWEsc1s3K2ZdPTEyOCxmKysscy5zZXQobmV3IFVpbnQ4QXJyYXkodCksNytmKSxzLmJ1ZmZlcn0obixhKTtkZWZhdWx0OnJldHVybiBudWxsfX1mdW5jdGlvbiBpKG4pe2lmKG4ubGVuZ3RoPDUpcmV0dXJuIiI7bGV0IGE9LTE7Zm9yKGxldCB0PTA7dDxuLmxlbmd0aC0zO3QrKyl7aWYoMD09PW5bdF0mJjA9PT1uW3QrMV0mJjE9PT1uW3QrMl0pe2E9dDticmVha31pZih0PG4ubGVuZ3RoLTQmJjA9PT1uW3RdJiYwPT09blt0KzFdJiYwPT09blt0KzJdJiYxPT09blt0KzNdKXthPXQ7YnJlYWt9fWlmKC0xPT09YSlyZXR1cm4iIjtjb25zdCByPWErKDA9PT1uW2ErMl0/NDozKTtpZihyPj1uLmxlbmd0aClyZXR1cm4iIjtjb25zdCBvPW5bcl07aWYoMTI4Jm8pcmV0dXJuIiI7aWYoKG8+PjEmNjMpPj0zMilyZXR1cm4gZTtpZihyKzE8bi5sZW5ndGgpe2lmKDA9PSgyNDgmbltyKzFdKSlyZXR1cm4gZX1yZXR1cm4oMzEmbyk8PTMxP3Q6IiJ9Y29uc3Qgcz03MSxmPTEsbD0yLHU9MSxnPTI7dmFyIGM7ZnVuY3Rpb24gZCh0LGU9ITEpe2NvbnN0IG49dC5nZXRVaW50OCgwKTtpZihuIT09cylyZXR1cm47Y29uc3QgYT10LmdldFVpbnQxNigxKSxyPWYrbCthLG89bmV3IFVpbnQ4QXJyYXkodC5ieXRlTGVuZ3RoLXIpO28uc2V0KG5ldyBVaW50OEFycmF5KHQuYnVmZmVyLHIsdC5ieXRlTGVuZ3RoLXIpKTtjb25zdCBpPXttOm4sdGx2TGVuOmEsdGx2OltdLGZyYW1lOm99O2xldCBkPWYrbDtmb3IoO2Q8cjspe2NvbnN0IG49dC5nZXRVaW50OChkKSxhPXQuZ2V0VWludDE2KGQrdSkscj11K2c7aWYobj09PWMuQVVESU9fTEVWRUwpe2xldCBvPXQuZ2V0VWludDgoZCtyKTtmb3IobGV0IGU9MTtlPGE7ZSsrKW89bzw8OHx0LmdldFVpbnQ4KGQrcitlKTtpLnRsdi5wdXNoKHt0YWc6bixsZW5ndGg6YSx2YWx1ZTplPzEyN15vPj4xOjEyNyZvfSl9ZWxzZSBpZihuPT09Yy5NRVRBREFUQXx8bj09PWMuQVVESU9fNjRfQklUX1BUUyl7Y29uc3QgZT1uZXcgVWludDhBcnJheShhKTtmb3IobGV0IG49MDtuPGE7bisrKWVbbl09dC5nZXRVaW50OChkK3Irbik7aS50bHYucHVzaCh7dGFnOm4sbGVuZ3RoOmEsdmFsdWU6ZX0pfWQrPXIrYX1yZXR1cm4gaX0hZnVuY3Rpb24odCl7dFt0LkFVRElPX0xFVkVMPTFdPSJBVURJT19MRVZFTCIsdFt0Lk1FVEFEQVRBPTJdPSJNRVRBREFUQSIsdFt0LkFVRElPXzY0X0JJVF9QVFM9M109IkFVRElPXzY0X0JJVF9QVFMifShjfHwoYz17fSkpLHNlbGYub25ydGN0cmFuc2Zvcm09dD0+e2NvbnN0IGU9dC50cmFuc2Zvcm1lcixuPVtdLHI9W107bGV0IGg9bnVsbDtlLm9wdGlvbnMucG9ydC5vbm1lc3NhZ2U9dD0+e3QuZGF0YS5zZWkmJm4ucHVzaCh0LmRhdGEuc2VpKSx0LmRhdGEubWV0YWRhdGEmJnIucHVzaCh0LmRhdGEubWV0YWRhdGEpfSxzZWxmLnBvc3RNZXNzYWdlKCJzdGFydGVkIik7Y29uc3QgcD1lLnJlYWRhYmxlLmdldFJlYWRlcigpLFU9ZS53cml0YWJsZS5nZXRXcml0ZXIoKTsic2VpLXJ4Ij09PWUub3B0aW9ucy5uYW1lP2Z1bmN0aW9uIHQoZSl7cC5yZWFkKCkudGhlbigobj0+e2lmKCFuLmRvbmUpe2lmKG4udmFsdWUgaW5zdGFuY2VvZiBSVENFbmNvZGVkVmlkZW9GcmFtZSl7Y29uc3QgdD1pKG5ldyBVaW50OEFycmF5KG4udmFsdWUuZGF0YSkpLHI9YShuLnZhbHVlLHQpO2lmKHImJmUub3B0aW9ucy5wb3J0LnBvc3RNZXNzYWdlKHtzZWk6cn0pLCFoKXtjb25zdCB0PW4udmFsdWUuZ2V0TWV0YWRhdGEoKXx8e307aD17dHlwZTpuLnZhbHVlLnR5cGUscnRwVGltZXN0YW1wOm4udmFsdWUudGltZXN0YW1wLHBheWxvYWRUeXBlOnQucGF5bG9hZFR5cGV8fDAsc3NyYzp0LnN5bmNocm9uaXphdGlvblNvdXJjZXx8MCxsZW5ndGg6bi52YWx1ZS5kYXRhLmJ5dGVMZW5ndGgsLi4uIm1pbWVUeXBlImluIHQ/e21pbWVUeXBlOnQubWltZVR5cGV9Ont9fSxlLm9wdGlvbnMucG9ydC5wb3N0TWVzc2FnZSh7Zmlyc3RGcmFtZUluZm86aH0pfX1VLndyaXRlKG4udmFsdWUpLGUub3B0aW9ucy5wb3J0LnBvc3RNZXNzYWdlKHt0cmFuc2Zvcm1lZDohMH0pLHQoZSl9fSkpfShlKToic2VpLXR4Ij09PWUub3B0aW9ucy5uYW1lP2Z1bmN0aW9uIHQoZSl7cC5yZWFkKCkudGhlbigoYT0+e2lmKCFhLmRvbmUpe2lmKGEudmFsdWUgaW5zdGFuY2VvZiBSVENFbmNvZGVkVmlkZW9GcmFtZSl7Y29uc3QgdD1pKG5ldyBVaW50OEFycmF5KGEudmFsdWUuZGF0YSkpLGU9bi5zaGlmdCgpO2lmKGUpe2NvbnN0IG49byhhLnZhbHVlLmRhdGEsZSx0KTtuJiYoYS52YWx1ZS5kYXRhPW4pfX1VLndyaXRlKGEudmFsdWUpLGUub3B0aW9ucy5wb3J0LnBvc3RNZXNzYWdlKHt0cmFuc2Zvcm1lZDohMH0pLHQoZSl9fSkpfShlKToiYXVkaW8tbWV0YWRhdGEtcngiPT09ZS5vcHRpb25zLm5hbWU/ZnVuY3Rpb24gdChlKXtwLnJlYWQoKS50aGVuKChuPT57aWYoIW4uZG9uZSl7aWYobi52YWx1ZSBpbnN0YW5jZW9mIFJUQ0VuY29kZWRBdWRpb0ZyYW1lKXtjb25zdCB0PW5ldyBEYXRhVmlldyhuLnZhbHVlLmRhdGEpLGE9dC5nZXRVaW50OCgwKTtsZXQgcjtpZigwIT0oMTI4JmEpJiY3MSE9PWEpe2NvbnN0IGU9ZnVuY3Rpb24odCl7aWYodC5ieXRlTGVuZ3RoPD0wKXJldHVybltdO2NvbnN0IGU9W107bGV0IG49MDtmb3IoO248dC5ieXRlTGVuZ3RoOyl7Y29uc3QgYT0oMTI4JnQuZ2V0VWludDgobikpPj43LHI9MTI3JnQuZ2V0VWludDgobik7aWYoIShhJiZuKzQ8PXQuYnl0ZUxlbmd0aCkpe24rKzticmVha317Y29uc3QgYT10LmdldFVpbnQzMihuLCExKSxvPSgxNjc3NjE5MiZhKT4+MTAsaT0xMDIzJmE7ZS5wdXNoKHtwdDpyLHRzX29mZnNldDpvLGxlbmd0aDppLGRhdGE6bmV3IFVpbnQ4QXJyYXl9KSxuKz00fX1sZXQgYT10LmJ5dGVMZW5ndGgtbjtmb3IoY29uc3QgciBvZiBlKXtpZihyLmxlbmd0aD5hKXJldHVybiBjb25zb2xlLndhcm4oIkJyb2tlbiByZWQgcGF5bG9hZCIpLFtdO3IubGVuZ3RoPjAmJihyLmRhdGE9bmV3IFVpbnQ4QXJyYXkodC5idWZmZXIsdC5ieXRlT2Zmc2V0K24sci5sZW5ndGgpLG4rPXIubGVuZ3RoLGEtPXIubGVuZ3RoKX1pZihhPjApe2NvbnN0IHI9e3B0OmUubGVuZ3RoPjA/ZVtlLmxlbmd0aC0xXS5wdDowLHRzX29mZnNldDowLGxlbmd0aDphLGRhdGE6bmV3IFVpbnQ4QXJyYXkodC5idWZmZXIsdC5ieXRlT2Zmc2V0K24sYSl9O2UucHVzaChyKX1yZXR1cm4gZX0odCk7aWYoZS5sZW5ndGg+MCl7Y29uc3QgdD1mdW5jdGlvbih0KXtsZXQgZT0wO2ZvcihsZXQgbj0wO248dC5sZW5ndGg7bisrKWUrPW48dC5sZW5ndGgtMT80OjEsZSs9dFtuXS5sZW5ndGg7Y29uc3Qgbj1uZXcgVWludDhBcnJheShlKTtsZXQgYT0wO2ZvcihsZXQgZT0wO2U8dC5sZW5ndGg7ZSsrKWlmKGU8dC5sZW5ndGgtMSl7Y29uc3Qgcj0oMjE0NzQ4MzY0OHwoMTI3JnRbZV0ucHQpPDwyNHwoMjYyMTQzJnRbZV0udHNfb2Zmc2V0KTw8MTB8MTAyMyZ0W2VdLmxlbmd0aCk+Pj4wO25bYSsrXT1yPj4yNCYyNTUsblthKytdPXI+PjE2JjI1NSxuW2ErK109cj4+OCYyNTUsblthKytdPTI1NSZyfWVsc2UgblthKytdPTEyNyZ0W2VdLnB0O2Zvcihjb25zdCBlIG9mIHQpbi5zZXQoZS5kYXRhLGEpLGErPWUubGVuZ3RoO3JldHVybiBufShlLm1hcCgodD0+e2NvbnN0IGU9bmV3IFVpbnQ4QXJyYXkodC5sZW5ndGgpO2Uuc2V0KHQuZGF0YSk7Y29uc3Qgbj1kKG5ldyBEYXRhVmlldyhlLmJ1ZmZlcikpO3JldHVybiBuPy5mcmFtZSYmKHQuZGF0YT1uPy5mcmFtZSkscj1uLHR9KSkpO24udmFsdWUuZGF0YT10LmJ1ZmZlcn19ZWxzZSByPWQodCksciYmKG4udmFsdWUuZGF0YT1yLmZyYW1lLmJ1ZmZlcik7aWYocil7bGV0IHQ9ci50bHYuZmluZCgodD0+dC50YWc9PT1jLk1FVEFEQVRBKSk7aWYodCYmdC52YWx1ZSBpbnN0YW5jZW9mIFVpbnQ4QXJyYXkmJmUub3B0aW9ucy5wb3J0LnBvc3RNZXNzYWdlKHttZXRhZGF0YTp0LnZhbHVlfSksdD1yLnRsdi5maW5kKCh0PT50LnRhZz09PWMuQVVESU9fNjRfQklUX1BUUykpLHQmJnQudmFsdWUgaW5zdGFuY2VvZiBVaW50OEFycmF5JiY4PT10LnZhbHVlLmxlbmd0aCl7Y29uc3Qgbj1uZXcgRGF0YVZpZXcodC52YWx1ZS5idWZmZXIpLmdldEJpZ1VpbnQ2NCgwLCEwKTt0JiZ0LnZhbHVlIGluc3RhbmNlb2YgVWludDhBcnJheSYmZS5vcHRpb25zLnBvcnQucG9zdE1lc3NhZ2Uoe3B0czpufSl9fX1VLndyaXRlKG4udmFsdWUpLGUub3B0aW9ucy5wb3J0LnBvc3RNZXNzYWdlKHt0cmFuc2Zvcm1lZDohMH0pLHQoZSl9fSkpfShlKToiYXVkaW8tbWV0YWRhdGEtdHgiPT09ZS5vcHRpb25zLm5hbWUmJmZ1bmN0aW9uIHQoZSl7cC5yZWFkKCkudGhlbigobj0+e2lmKCFuLmRvbmUpe2lmKGUub3B0aW9ucy5wb3J0LnBvc3RNZXNzYWdlKHtnZXRNZXRhZGF0YTohMH0pLG4udmFsdWUgaW5zdGFuY2VvZiBSVENFbmNvZGVkQXVkaW9GcmFtZSl7Y29uc3QgdD1yLnNoaWZ0KCk7dCYmKG4udmFsdWUuZGF0YT1mdW5jdGlvbih0LGUsbil7Y29uc3QgYT1uLmJ5dGVMZW5ndGgscj1hK3UrZyxvPWYrbCtyLGk9bmV3IEFycmF5QnVmZmVyKHQuYnl0ZUxlbmd0aCtvKSxjPW5ldyBEYXRhVmlldyhpKTtjLnNldFVpbnQ4KDAscyksYy5zZXRVaW50MTYoMSxyKSxjLnNldFVpbnQ4KDMsZSksYy5zZXRVaW50MTYoNCxhKTtmb3IobGV0IHQ9MDt0PGE7dCsrKWMuc2V0VWludDgoNit0LG5bdF0pO2NvbnN0IGQ9bmV3IFVpbnQ4QXJyYXkoYy5idWZmZXIpO3JldHVybiBkLnNldChuZXcgVWludDhBcnJheSh0KSxvKSxkLmJ1ZmZlcn0obi52YWx1ZS5kYXRhLGMuQVVESU9fNjRfQklUX1BUUyx0KSl9VS53cml0ZShuLnZhbHVlKSxlLm9wdGlvbnMucG9ydC5wb3N0TWVzc2FnZSh7dHJhbnNmb3JtZWQ6ITB9KSx0KGUpfX0pKX0oZSl9LHNlbGYucG9zdE1lc3NhZ2UoInJlZ2lzdGVyZWQiKTsK")],{type:"text/javascript"});return setTimeout((()=>op.revokeObjectURL(t)),0),new Worker(op.createObjectURL(t))}const TD=71,DS=1,PS=2,LS=1,RD=2;var ca=(function(t){return t[t.AUDIO_LEVEL=1]="AUDIO_LEVEL",t[t.METADATA=2]="METADATA",t[t.AUDIO_64_BIT_PTS=3]="AUDIO_64_BIT_PTS",t})(ca||{});function kS(t){let e=arguments.length>1&&arguments[1]!==void 0&&arguments[1];const n=t.getUint8(0);if(n!==TD)return;const i=t.getUint16(1),r=DS+PS+i,s=new Uint8Array(t.byteLength-r);s.set(new Uint8Array(t.buffer,r,t.byteLength-r));const o={m:n,tlvLen:i,tlv:[],frame:s};let a=DS+PS;for(;a<r;){const c=t.getUint8(a),d=t.getUint16(a+LS),l=LS+RD;if(c===ca.AUDIO_LEVEL){let h=t.getUint8(a+l);for(let p=1;p<d;p++)h=h<<8|t.getUint8(a+l+p);o.tlv.push({tag:c,length:d,value:e?127^h>>1:127&h})}else if(c===ca.METADATA||c===ca.AUDIO_64_BIT_PTS){const h=new Uint8Array(d);for(let p=0;p<d;p++)h[p]=t.getUint8(a+l+p);o.tlv.push({tag:c,length:d,value:h})}a+=l+d}return o}const c_=new Map,d_=127,cc=1e-10,MS=139/13,l_=new Map;function US(t,e,n){const i="".concat(t,"-").concat(e,"-").concat(n);let r=0;return l_.has(i)?r=l_.get(i):(r=Math.log((function(o,a){const c=o-a;a<c&&(a=c);let d=1;for(let l=o,h=1;l>a;l--,h++)d=d*l/h;return d})(e,t))+t*Math.log(.5)+(e-t)*Math.log(1-.5)-Math.log(n)+n*t,l_.set(i,r)),r<cc&&(r=cc),r}function vD(t,e,n){const i=e.length,r=t.length/i;let s=!1;for(let o=0,a=0;o<i;o++){let c=0;for(let d=a+r;a<d;a++)t[a]>n&&c++;e[o]!==c&&(e[o]=c,s=!0)}return s}window.cache=l_;let k8=0;class CD{constructor(e){j(this,"id",void 0),j(this,"immediates",[]),j(this,"lastNonSilence",-1),j(this,"immediateSpeechActivityScore",cc),j(this,"lastLevelChangedTime",Date.now()),j(this,"levels",[]),j(this,"longs",[]),j(this,"longSpeechActivityScore",cc),j(this,"mediums",[]),j(this,"mediumSpeechActivityScore",cc),j(this,"minLevel",0),j(this,"nextMinLevel",0),j(this,"nextMinLevelWindowLength",0),j(this,"energyScore",0),this.id=e||"".concat(k8++),this.immediates.length=50,this.mediums.length=10,this.longs.length=1,this.levels.length=this.immediates.length}computeImmediates(){const e=this.immediates,n=this.levels,i=this.minLevel+MS;let r=!1;for(let s=0;s<e.length;++s){let o=n[s];o<i&&(o=0);const a=Math.floor(o/MS);e[s]!==a&&(e[s]=a,r=!0)}return r}computeLongs(){return vD(this.mediums,this.longs,4)}computeMediums(){return vD(this.immediates,this.mediums,7)}evaluateImmediateSpeechActivityScore(){this.immediateSpeechActivityScore=US(this.immediates[0],13,.78)}evaluateLongSpeechActivityScore(e){this.longSpeechActivityScore=US(this.longs[0],10,47),this.longSpeechActivityScore>cc&&(this.lastNonSilence=e)}evaluateMediumSpeechActivityScore(){this.mediumSpeechActivityScore=US(this.mediums[0],5,24)}evaluateSpeechActivityScores(e){this.computeImmediates()&&(this.evaluateImmediateSpeechActivityScore(),this.computeMediums()&&(this.evaluateMediumSpeechActivityScore(),this.computeLongs()&&this.evaluateLongSpeechActivityScore(e)))}getLastLevelChangedTime(){return this.lastLevelChangedTime}getLevels(){var e;return"[".concat(Hv(e=[...this.levels]).call(e).join(),"]")}getSpeechActivityScore(e){switch(e){case 0:return this.immediateSpeechActivityScore;case 1:return this.mediumSpeechActivityScore;case 2:return this.longSpeechActivityScore;default:throw new Error("interval "+e)}}levelChanged(e,n){if(this.lastLevelChangedTime<=n){this.lastLevelChangedTime=n;let i=e;return e<0&&(i=0),e>d_&&(i=d_),this.levels.unshift(i),this.levels.length>this.immediates.length&&this.levels.pop(),this.updateMinLevel(i),i>=this.minLevel+MS?i:i/2}return-1}levelTimedOut(){this.levelChanged(0,this.lastLevelChangedTime)}updateMinLevel(e){if(e!==0){if(this.minLevel===0||this.minLevel>e)return this.minLevel=e,this.nextMinLevel=0,void(this.nextMinLevelWindowLength=0);if(this.nextMinLevel===0)return this.nextMinLevel=e,void(this.nextMinLevelWindowLength=1);if(this.nextMinLevel>e&&(this.nextMinLevel=e),this.nextMinLevelWindowLength++,this.nextMinLevelWindowLength>=750){let n=Math.sqrt(this.minLevel*this.nextMinLevel);n<0?n=0:n>d_&&(n=d_),this.minLevel=n,this.nextMinLevel=0,this.nextMinLevelWindowLength=0}}}}class M8{constructor(e){j(this,"algorithm",void 0),this.algorithm=e}execute(){let e=!this.algorithm;if(!e)try{const n=this.algorithm.runInDecisionMaker(this);n<=0?e=!0:setTimeout(this.execute.bind(this),n)}catch{e=!0}e&&this.algorithm&&this.algorithm.decisionMakerExited(this)}}class xS{constructor(e,n,i){j(this,"isDominant",void 0),j(this,"energyRanking",void 0),j(this,"energyScore",void 0),this.isDominant=e,this.energyRanking=n,this.energyScore=i}}class U8 extends qe{constructor(e){super(),j(this,"dominantId",null),j(this,"lastDecisionTime",0),j(this,"lastLevelChangedTime",0),j(this,"lastLevelIdleTime",0),j(this,"relativeSpeechActivities",[]),j(this,"speakers",new Map),j(this,"enableSilence",!1),j(this,"timeoutToSilenceInterval",0),j(this,"decisionMaker",null),j(this,"loudest",[]),j(this,"numLoudestToTrack",3),j(this,"energyExpireTimeMs",250),j(this,"energyAlphaPct",50),this.timeoutToSilenceInterval=e,this.enableSilence=e>0,this.relativeSpeechActivities.length=3}setLoudestConfig(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:3,n=arguments.length>1?arguments[1]:void 0,i=arguments.length>2?arguments[2]:void 0;this.numLoudestToTrack=e,n!=null&&(this.energyExpireTimeMs=n),i!=null&&(this.energyAlphaPct=i),this.loudest.length>e&&this.loudest.splice(e)}getDominantSpeaker(){return this.dominantId}isAmongLoudest(e){return this.loudest.some((n=>n.id===e))}levelChanged(e,n){const i=Date.now(),r=this.getOrCreateSpeaker(e);this.lastLevelChangedTime<i&&(this.lastLevelChangedTime=i,this.maybeStartDecisionMaker());const s=r.levelChanged(n,i);return this.updateLoudestList(r,s,i)}runInDecisionMaker(e){return this.decisionMaker!==e||this.lastDecisionTime>0&&this.lastDecisionTime-this.lastLevelChangedTime>=15e3?-1:this._runInDecisionMaker()}decisionMakerExited(e){this.decisionMaker===e&&(this.decisionMaker=null)}destroy(){this.decisionMaker=null,this.loudest.length=0,this.speakers.clear(),this.removeAllListeners()}addSpeakers(e){e.forEach((n=>{this.speakers.has(n.id)||this.speakers.set(n.id,n)}))}removeSpeakers(e){e.forEach((n=>{this.speakers.delete(n.id)}))}getOrCreateSpeaker(e){let n=this.speakers.get(e);return n||(n=new CD(e),this.speakers.set(e,n),this.maybeStartDecisionMaker()),n}updateLoudestList(e,n,i){const r=e.id===this.dominantId;if(n<0){let c=0;for(;c<this.loudest.length&&this.loudest[c]!==e;)++c;return new xS(r,c,e.energyScore)}if(e.energyScore=Math.floor((this.energyAlphaPct*n+(100-this.energyAlphaPct)*e.energyScore+50)/100),this.numLoudestToTrack===0)return new xS(r,0,e.energyScore);const s=i-this.energyExpireTimeMs;let o=0;for(;o<this.loudest.length;){const c=this.loudest[o];if(c.getLastLevelChangedTime()<s&&this.loudest.length>=this.numLoudestToTrack)this.loudest.splice(o,1);else if(c.id!==e.id)++o;else if(this.loudest.splice(o,1),this.loudest.length<this.numLoudestToTrack)break}let a=0;for(;a<this.loudest.length&&!(this.loudest[a].energyScore<e.energyScore);)++a;return a<this.numLoudestToTrack&&(this.loudest.splice(a,0,e),this.loudest.length>this.numLoudestToTrack&&this.loudest.splice(this.numLoudestToTrack,1)),new xS(r,a,e.energyScore)}maybeStartDecisionMaker(){!this.decisionMaker&&this.speakers.size>0&&(this.decisionMaker=new M8(this),this.decisionMaker.execute())}makeDecision(e){let n=null,i=null;const r=this.speakers.size;let s=null;if(r===0)s=null;else if(r===1){var o;const a=qi(o=this.speakers).call(o).next().value;this.enableSilence&&a&&(s=a.id,a.evaluateSpeechActivityScores(e),e-a.lastNonSilence>this.timeoutToSilenceInterval&&(s=null))}else{let a=this.dominantId==null?null:this.speakers.get(this.dominantId);if(a==null){const l=this.speakers.entries().next();l.value&&(s=l.value[0],a=l.value[1])}else s=a.id;a?.evaluateSpeechActivityScores(e);const c=this.relativeSpeechActivities;let d=2;for(const l of this.speakers.entries()){const[h,p]=l;if(p===a)continue;p.evaluateSpeechActivityScores(e);for(let T=0;T<c.length;++T){const b=a==null?cc:a.getSpeechActivityScore(T);c[T]=Math.log(p.getSpeechActivityScore(T)/b)}const f=c[0],v=c[1],S=c[2];f>3&&v>2&&S>0&&v>d&&(d=v,s=h)}this.enableSilence&&a!=null&&s===a.id&&e-a.lastNonSilence>this.timeoutToSilenceInterval&&(s=null)}s==null&&!this.enableSilence||s===this.dominantId||(n=this.dominantId,this.dominantId=s,i=this.dominantId),i==null&&!this.enableSilence||i===n||this.emit("ActiveSpeakerChanged",i)}_runInDecisionMaker(){const e=Date.now(),n=300-(e-this.lastLevelIdleTime);let i=0;n<=0?(this.lastLevelIdleTime!==0&&this.timeoutIdleLevels(e),this.lastLevelIdleTime=e):i=n;let r=300-(e-this.lastDecisionTime);return r<=0&&(this.lastDecisionTime=e,this.makeDecision(e),r=300-(Date.now()-e)),r>0&&i>r&&(i=r),i}timeoutIdleLevels(e){const n=[];for(const r of qi(i=this.speakers).call(i)){var i;const s=e-r.getLastLevelChangedTime();36e5<s&&(this.dominantId==null||r.id!==this.dominantId)?n.push(r.id):300<s&&r.levelTimedOut()}n.forEach((r=>this.speakers.delete(r)))}}const Md=new Map;let vs=null,u_=null;const yD=3;let dc=[];const Cs=new Map,h_=new Map;class x8{get samples(){return this.actives+this.inactives}get activeRate(){return this.actives/this.samples}constructor(e,n){j(this,"id",void 0),j(this,"track",void 0),j(this,"score",0),j(this,"active",!0),j(this,"muted",!1),j(this,"timer",0),j(this,"actives",0),j(this,"inactives",0),this.id=e,this.track=n,this.setActive(Cs.size<3)}autoCheckActive(){this.autoSetActive(),this.autoAdjustActive(),this.resetTimer(),this.actives=0,this.inactives=0}autoSetActive(){const e=this.active;this.active=this.activeRate>=.8;const{actives:n,inactives:i}=(function(){const r=[],s=[];return Array.from(qi(Cs).call(Cs)).forEach((o=>{o.active?r.push(o):s.push(o)})),{actives:r,inactives:s}})();if(n.length>3){let r;n.forEach((s=>{(!r||r.score>s.score)&&(r=s)})),r&&r.setActive(!1)}if(n.length<3&&i.length>0){let r;i.forEach((s=>{(!r||r.score<s.score)&&s.id!==this.id&&(r=s)})),r&&e&&!this.active&&(r.samples>40&&r.activeRate-this.activeRate>.4?r.setActive(!0):this.active=!0)}this.setMuted(!this.active)}setActive(e){this.active=e,this.resetTimer(),this.setMuted(!e)}autoAdjustActive(){this.active?this.autoSwitchToInactive():this.autoSwitchToActive()}autoSwitchToActive(){const e=(function(n){let i;return Array.from(qi(Cs).call(Cs)).forEach((r=>{!r.active||r.id===n||r.samples<40||(!i||r.score<i.score)&&(i=r)})),i})(this.id);e&&this.activeRate-e.activeRate>.4&&(e.setActive(!1),this.setActive(!0))}autoSwitchToInactive(){const e=(function(n){let i;return Array.from(qi(Cs).call(Cs)).forEach((r=>{r.active||r.id===n||r.samples<40||(!i||r.score>i.score)&&(i=r)})),i})(this.id);e&&e.activeRate-this.activeRate>.4&&(e.setActive(!0),this.setActive(!1))}addSample(e){e?this.actives+=1:this.inactives+=1,this.samples>66.66666666666667&&this.autoCheckActive()}setMuted(e){this.track&&(this.track.enabled=!e,this.muted=e)}resetTimer(){this.clearTimer(),this.timer=window.setTimeout((()=>{if(this.samples!==0)return this.samples<50?this.resetTimer():void this.autoCheckActive()}),1e3)}clearTimer(){this.timer&&(clearTimeout(this.timer),this.timer=0)}}let p_;function ID(t){const e=Cs.get(t);e&&(Cs.delete(t),e.clearTimer())}const __=new Map,V8=new Map,VS="video/h264",FS="video/h265";function bD(t,e,n){let i=new Uint8Array(t,e,n),r=[],s=0;for(;r.length<n;)s+3<n&&i[s]===0&&i[s+1]===0&&i[s+2]===3&&(i[s+3]===0||i[s+3]===1||i[s+3]===2||i[s+3]===3)?(r.push(i[s],i[s+1],i[s+3]),s+=4):(r.push(i[s]),s++);return new Uint8Array(r)}function AD(t){const e=t.length;let n=[],i=0;for(;i<e;)i+2<e&&t[i]===0&&t[i+1]===0&&(t[i+2]===0||t[i+2]===1||t[i+2]===2||t[i+2]===3)?(n.push(t[i],t[i+1],3,t[i+2]),i+=3):(n.push(t[i]),i++);return new Uint8Array(n)}function wD(t){if(t.length<5)return"";let e=-1;for(let r=0;r<t.length-3;r++){if(t[r]===0&&t[r+1]===0&&t[r+2]===1){e=r;break}if(r<t.length-4&&t[r]===0&&t[r+1]===0&&t[r+2]===0&&t[r+3]===1){e=r;break}}if(e===-1)return"";const n=e+(t[e+2]===0?4:3);if(n>=t.length)return"";const i=t[n];return 128&i?"":(i>>1&63)>=32||n+1<t.length&&(248&t[n+1])==0?FS:(31&i)<=31?VS:""}const f_=new Map,hu=new Map;(function(){const t=de();Dn.getDisplayMedia=!(!navigator.mediaDevices||!navigator.mediaDevices.getDisplayMedia),Dn.getStreamFromExtension=t.name===he.CHROME&&Number(t.version)>34,Dn.supportUnifiedPlan=(function(){if(!window.RTCRtpTransceiver||!("currentDirection"in RTCRtpTransceiver.prototype))return!1;const e=new RTCPeerConnection;let n=!1;try{e.addTransceiver("audio"),n=!0}catch{}return e.close(),n})(),Dn.supportMinBitrate=t.name===he.CHROME||t.name===he.EDGE,Dn.supportSetRtpSenderParameters=(function(){const e=de();return!!(window.RTCRtpSender&&window.RTCRtpSender.prototype.setParameters&&window.RTCRtpSender.prototype.getParameters)&&(!!Js()||!(!Mn()&&!Gp())||e.name===he.FIREFOX&&Number(e.version)>=64)})(),t.name===he.SAFARI&&(Number(t.version)>=14?Dn.supportDualStream=!0:Dn.supportDualStream=!1),Dn.webAudioMediaStreamDest=(function(){const e=de();return!(e.name===he.SAFARI&&Number(e.version)<12)})(),Dn.supportReplaceTrack=!!window.RTCRtpSender&&typeof RTCRtpSender.prototype.replaceTrack=="function",Dn.supportWebGL=typeof WebGLRenderingContext<"u",Dn.supportRequestFrame=!!window.CanvasCaptureMediaStreamTrack,Js()||(Dn.webAudioWithAEC=!0),Dn.supportShareAudio=(function(){const e=de();return(e.os===On.WIN_10||e.os===On.WIN_81||e.os===On.WIN_7||e.os===On.LINUX||e.os===On.MAC_OS||e.os===On.CHROMIUM_OS)&&e.name===he.CHROME&&Number(e.version)>=74})(),Dn.supportDataChannel=!!(Xs(76)||Wg(68)||SO(14)),Dn.supportPCSetConfiguration=(function(){const e=window.RTCPeerConnection;return!xe()&&!!e&&e.prototype.setConfiguration instanceof Function})(),Dn.supportWebRTCEncodedTransform=Xs(87)||mO()||Wg(117),Dn.supportWebRTCInsertableStream=(function(){const e=de();return(e.name===he.CHROME||e.name===he.EDGE)&&Number(e.version)>=94&&"MediaStreamTrackGenerator"in window&&"MediaStreamTrackProcessor"in window})(),Dn.supportRequestVideoFrameCallback="requestVideoFrameCallback"in HTMLVideoElement.prototype,Dn.supportWebCrypto=typeof window<"u"&&window.crypto!==void 0&&window.crypto.subtle!==void 0,Dn.supportSuppressLocalAudioPlayback=h0(),Dn.supportRestrictOwnAudio=p0(),Hp((()=>{Dn.supportDualStreamEncoding=(function(){const e=de();return!!I("DISABLE_WEBAUDIO")||e.name==="Safari"&&Number(e.version)>=14||!!(e.name==="Chrome"&&/Windows/i.test(e.os||"")&&Number(e.version)>=100&&I("CHROME_DUAL_STREAM_USE_ENCODING"))})(),m.debug("browser ua: ",navigator.userAgent),m.info("browser info: ",t),m.info("browser compatibility: ",Dn)}))})();const F8=["CHINA","GLOBAL"],OD=[[0,1,2,3,4,5,5],[0,2,2,3,4,5,5],[0,3,3,3,4,5,5],[0,4,4,4,4,5,5],[0,5,5,5,5,5,5]],lc=[],Ud=[];function uc(t,e){return!!e&&lc.some((n=>n.uid===t&&n.channelName===e))}function BS(){return Ud.length>0}var B8=UA.forEach,ND=gh("forEach")?[].forEach:function(t){return B8(this,t,arguments.length>1?arguments[1]:void 0)};ge({target:"Array",proto:!0,forced:[].forEach!==ND},{forEach:ND});var j8=yr("Array","forEach"),G8=Qo,W8=ii,H8=Z,K8=j8,jS=Array.prototype,Y8={DOMTokenList:!0,NodeList:!0},q8=function(t){var e=t.forEach;return t===jS||H8(jS,t)&&e===jS.forEach||W8(Y8,G8(t))?K8:e},z8=y(q8),X8=Ws,DD=yh;ge({target:"Object",stat:!0,forced:O((function(){DD(1)}))},{keys:function(t){return DD(X8(t))}});var J8=y(It.Object.keys),Q8=y(jv),Z8=y(Wv),$8=ge,PD=yl,tY=Vh,eY=bt,LD=tm,nY=Jo,iY=St,rY=SE,sY=gn,oY=$o,aY=bA("slice"),cY=sY("species"),GS=Array,dY=Math.max;$8({target:"Array",proto:!0,forced:!aY},{slice:function(t,e){var n,i,r,s=iY(this),o=nY(s),a=LD(t,o),c=LD(e===void 0?o:e,o);if(PD(s)&&(n=s.constructor,(tY(n)&&(n===GS||PD(n.prototype))||eY(n)&&(n=n[cY])===null)&&(n=void 0),n===GS||n===void 0))return oY(s,a,c);for(i=new(n===void 0?GS:n)(dY(c-a,0)),r=0;a<c;a++,r++)a in s&&rY(i,r,s[a]);return i.length=r,i}});var lY=yr("Array","slice"),uY=Z,hY=lY,WS=Array.prototype,pY=function(t){var e=t.slice;return t===WS||uY(WS,t)&&e===WS.slice?hY:e},_Y=y(pY);function ot(t,e,n,i,r){var s,o,a,c={};return z8(s=J8(i)).call(s,(function(d){c[d]=i[d]})),c.enumerable=!!c.enumerable,c.configurable=!!c.configurable,("value"in c||c.initializer)&&(c.writable=!0),c=Q8(o=Z8(a=_Y(n).call(n)).call(a)).call(o,(function(d,l){return l(t,e,d)||d}),c),r&&c.initializer!==void 0&&(c.value=c.initializer?c.initializer.call(r):void 0,c.initializer=void 0),c.initializer===void 0?(vA(t,e,c),null):c}let m_=(function(t){return t[t.ACCESS_POINT=101]="ACCESS_POINT",t[t.UNILBS=201]="UNILBS",t[t.STRING_UID_ALLOCATOR=901]="STRING_UID_ALLOCATOR",t})({}),HS=(function(t){return t[t.IIIEGAL_APPID=1]="IIIEGAL_APPID",t[t.IIIEGAL_UID=2]="IIIEGAL_UID",t[t.INTERNAL_ERROR=3]="INTERNAL_ERROR",t})({}),Dr=(function(t){return t[t.INVALID_VENDOR_KEY=5]="INVALID_VENDOR_KEY",t[t.INVALID_CHANNEL_NAME=7]="INVALID_CHANNEL_NAME",t[t.INTERNAL_ERROR=8]="INTERNAL_ERROR",t[t.NO_AUTHORIZED=9]="NO_AUTHORIZED",t[t.DYNAMIC_KEY_TIMEOUT=10]="DYNAMIC_KEY_TIMEOUT",t[t.NO_ACTIVE_STATUS=11]="NO_ACTIVE_STATUS",t[t.DYNAMIC_KEY_EXPIRED=13]="DYNAMIC_KEY_EXPIRED",t[t.STATIC_USE_DYNAMIC_KEY=14]="STATIC_USE_DYNAMIC_KEY",t[t.DYNAMIC_USE_STATIC_KEY=15]="DYNAMIC_USE_STATIC_KEY",t[t.USER_OVERLOAD=16]="USER_OVERLOAD",t[t.FORBIDDEN_REGION=18]="FORBIDDEN_REGION",t[t.CANNOT_MEET_AREA_DEMAND=19]="CANNOT_MEET_AREA_DEMAND",t[t.REQ_DOWNGRADE_FALLBACK=27]="REQ_DOWNGRADE_FALLBACK",t})({}),Si=(function(t){return t[t.NO_FLAG_SET=100]="NO_FLAG_SET",t[t.FLAG_SET_BUT_EMPTY=101]="FLAG_SET_BUT_EMPTY",t[t.INVALID_FALG_SET=102]="INVALID_FALG_SET",t[t.FLAG_SET_BUT_NO_RE=103]="FLAG_SET_BUT_NO_RE",t[t.INVALID_SERVICE_ID=104]="INVALID_SERVICE_ID",t[t.NO_SERVICE_AVAILABLE=200]="NO_SERVICE_AVAILABLE",t[t.NO_SERVICE_AVAILABLE_P2P=201]="NO_SERVICE_AVAILABLE_P2P",t[t.NO_SERVICE_AVAILABLE_VOICE=202]="NO_SERVICE_AVAILABLE_VOICE",t[t.NO_SERVICE_AVAILABLE_WEBRTC=203]="NO_SERVICE_AVAILABLE_WEBRTC",t[t.NO_SERVICE_AVAILABLE_CDS=204]="NO_SERVICE_AVAILABLE_CDS",t[t.NO_SERVICE_AVAILABLE_CDN=205]="NO_SERVICE_AVAILABLE_CDN",t[t.NO_SERVICE_AVAILABLE_TDS=206]="NO_SERVICE_AVAILABLE_TDS",t[t.NO_SERVICE_AVAILABLE_REPORT=207]="NO_SERVICE_AVAILABLE_REPORT",t[t.NO_SERVICE_AVAILABLE_APP_CENTER=208]="NO_SERVICE_AVAILABLE_APP_CENTER",t[t.NO_SERVICE_AVAILABLE_ENV0=209]="NO_SERVICE_AVAILABLE_ENV0",t[t.NO_SERVICE_AVAILABLE_VOET=210]="NO_SERVICE_AVAILABLE_VOET",t[t.NO_SERVICE_AVAILABLE_STRING_UID=211]="NO_SERVICE_AVAILABLE_STRING_UID",t[t.NO_SERVICE_AVAILABLE_WEBRTC_UNILBS=212]="NO_SERVICE_AVAILABLE_WEBRTC_UNILBS",t[t.NO_SERVICE_AVAILABLE_UNILBS_FLV=213]="NO_SERVICE_AVAILABLE_UNILBS_FLV",t})({}),yt=(function(t){return t[t.K_TIMESTAMP_EXPIRED=2]="K_TIMESTAMP_EXPIRED",t[t.K_CHANNEL_PERMISSION_INVALID=3]="K_CHANNEL_PERMISSION_INVALID",t[t.K_CERTIFICATE_INVALID=4]="K_CERTIFICATE_INVALID",t[t.K_CHANNEL_NAME_EMPTY=5]="K_CHANNEL_NAME_EMPTY",t[t.K_CHANNEL_NOT_FOUND=6]="K_CHANNEL_NOT_FOUND",t[t.K_TICKET_INVALID=7]="K_TICKET_INVALID",t[t.K_CHANNEL_CONFLICTED=8]="K_CHANNEL_CONFLICTED",t[t.K_SERVICE_NOT_READY=9]="K_SERVICE_NOT_READY",t[t.K_SERVICE_TOO_HEAVY=10]="K_SERVICE_TOO_HEAVY",t[t.K_UID_BANNED=14]="K_UID_BANNED",t[t.K_IP_BANNED=15]="K_IP_BANNED",t[t.K_CHANNEL_BANNED=16]="K_CHANNEL_BANNED",t[t.DATASTREAM2_NOT_AVAILABLE=27]="DATASTREAM2_NOT_AVAILABLE",t[t.K_AUTO_REBALANCE=28]="K_AUTO_REBALANCE",t[t.K_VOS_FALLBACK=30]="K_VOS_FALLBACK",t[t.WARN_NO_AVAILABLE_CHANNEL=103]="WARN_NO_AVAILABLE_CHANNEL",t[t.WARN_LOOKUP_CHANNEL_TIMEOUT=104]="WARN_LOOKUP_CHANNEL_TIMEOUT",t[t.WARN_LOOKUP_CHANNEL_REJECTED=105]="WARN_LOOKUP_CHANNEL_REJECTED",t[t.WARN_OPEN_CHANNEL_TIMEOUT=106]="WARN_OPEN_CHANNEL_TIMEOUT",t[t.WARN_OPEN_CHANNEL_REJECTED=107]="WARN_OPEN_CHANNEL_REJECTED",t[t.WARN_REQUEST_DEFERRED=108]="WARN_REQUEST_DEFERRED",t[t.ERR_DYNAMIC_KEY_TIMEOUT=109]="ERR_DYNAMIC_KEY_TIMEOUT",t[t.ERR_NO_AUTHORIZED=110]="ERR_NO_AUTHORIZED",t[t.ERR_VOM_SERVICE_UNAVAILABLE=111]="ERR_VOM_SERVICE_UNAVAILABLE",t[t.ERR_NO_CHANNEL_AVAILABLE_CODE=112]="ERR_NO_CHANNEL_AVAILABLE_CODE",t[t.ERR_MASTER_VOCS_UNAVAILABLE=114]="ERR_MASTER_VOCS_UNAVAILABLE",t[t.ERR_INTERNAL_ERROR=115]="ERR_INTERNAL_ERROR",t[t.ERR_NO_ACTIVE_STATUS=116]="ERR_NO_ACTIVE_STATUS",t[t.ERR_INVALID_UID=117]="ERR_INVALID_UID",t[t.ERR_DYNAMIC_KEY_EXPIRED=118]="ERR_DYNAMIC_KEY_EXPIRED",t[t.ERR_STATIC_USE_DYANMIC_KE=119]="ERR_STATIC_USE_DYANMIC_KE",t[t.ERR_DYNAMIC_USE_STATIC_KE=120]="ERR_DYNAMIC_USE_STATIC_KE",t[t.ERR_NO_VOCS_AVAILABLE=2e3]="ERR_NO_VOCS_AVAILABLE",t[t.ERR_NO_VOS_AVAILABLE=2001]="ERR_NO_VOS_AVAILABLE",t[t.ERR_JOIN_CHANNEL_TIMEOUT=2002]="ERR_JOIN_CHANNEL_TIMEOUT",t[t.ERR_REPEAT_JOIN_CHANNEL=2003]="ERR_REPEAT_JOIN_CHANNEL",t[t.ERR_JOIN_BY_MULTI_IP=2004]="ERR_JOIN_BY_MULTI_IP",t[t.ERR_NOT_JOINED=2011]="ERR_NOT_JOINED",t[t.ERR_REPEAT_JOIN_REQUEST=2012]="ERR_REPEAT_JOIN_REQUEST",t[t.ERR_INVALID_VENDOR_KEY=2013]="ERR_INVALID_VENDOR_KEY",t[t.ERR_INVALID_CHANNEL_NAME=2014]="ERR_INVALID_CHANNEL_NAME",t[t.ERR_INVALID_STRINGUID=2015]="ERR_INVALID_STRINGUID",t[t.ERR_TOO_MANY_USERS=2016]="ERR_TOO_MANY_USERS",t[t.ERR_SET_CLIENT_ROLE_TIMEOUT=2017]="ERR_SET_CLIENT_ROLE_TIMEOUT",t[t.ERR_SET_CLIENT_ROLE_NO_PERMISSION=2018]="ERR_SET_CLIENT_ROLE_NO_PERMISSION",t[t.ERR_SET_CLIENT_ROLE_ALREADY_IN_USE=2019]="ERR_SET_CLIENT_ROLE_ALREADY_IN_USE",t[t.ERR_PUBLISH_REQUEST_INVALID=2020]="ERR_PUBLISH_REQUEST_INVALID",t[t.ERR_SUBSCRIBE_REQUEST_INVALID=2021]="ERR_SUBSCRIBE_REQUEST_INVALID",t[t.ERR_NOT_SUPPORTED_MESSAGE=2022]="ERR_NOT_SUPPORTED_MESSAGE",t[t.ERR_ILLEAGAL_PLUGIN=2023]="ERR_ILLEAGAL_PLUGIN",t[t.ERR_REJOIN_TOKEN_INVALID=2024]="ERR_REJOIN_TOKEN_INVALID",t[t.ERR_REJOIN_USER_NOT_JOINED=2025]="ERR_REJOIN_USER_NOT_JOINED",t[t.ERR_INVALID_OPTIONAL_INFO=2027]="ERR_INVALID_OPTIONAL_INFO",t[t.ILLEGAL_AES_PASSWORD=2028]="ILLEGAL_AES_PASSWORD",t[t.ILLEGAL_CLIENT_ROLE_LEVEL=2029]="ILLEGAL_CLIENT_ROLE_LEVEL",t[t.ERR_TOO_MANY_BROADCASTERS=2031]="ERR_TOO_MANY_BROADCASTERS",t[t.ERR_TOO_MANY_SUBSCRIBERS=2032]="ERR_TOO_MANY_SUBSCRIBERS",t[t.ERR_LICENSE_MISSING=32769]="ERR_LICENSE_MISSING",t[t.ERR_LICENSE_EXPIRED=32771]="ERR_LICENSE_EXPIRED",t[t.ERR_LICENSE_MINUTES_EXCEEDED=32773]="ERR_LICENSE_MINUTES_EXCEEDED",t[t.ERR_LICENSE_PERIOD_INVALID=32774]="ERR_LICENSE_PERIOD_INVALID",t[t.ERR_LICENSE_MULTIPLE_SDK_SERVICE=32778]="ERR_LICENSE_MULTIPLE_SDK_SERVICE",t[t.ERR_LICENSE_ILLEGAL=32783]="ERR_LICENSE_ILLEGAL",t[t.ERR_TEST_RECOVER=9e3]="ERR_TEST_RECOVER",t[t.ERR_TEST_TRYNEXT=9001]="ERR_TEST_TRYNEXT",t[t.ERR_TEST_RETRY=9002]="ERR_TEST_RETRY",t})({}),ee=(function(t){return t.CONNECTING="connecting",t.CONNECTED="connected",t.RECONNECTING="reconnecting",t.CLOSED="closed",t})({}),ft=(function(t){return t.WS_CONNECTED="ws_connected",t.WS_RECONNECTING="ws_reconnecting",t.WS_CLOSED="ws_closed",t.WS_RECONNECT_CREATE_CONNECTION="ws_reconnect_create_connection",t.ON_BINARY_DATA="on_binary_data",t.REQUEST_RECOVER="request_recover",t.REQUEST_JOIN_INFO="request_join_info",t.REQUEST_REJOIN_INFO="req_rejoin_info",t.IS_P2P_DISCONNECTED="is_p2p_dis",t.DISCONNECT_P2P="dis_p2p",t.ABORT_P2P_EXECUTION="abort_p2p_execution",t.NEED_RENEW_SESSION="need-sid",t.REPORT_JOIN_GATEWAY="report_join_gateway",t.REQUEST_TIMEOUT="request_timeout",t.REQUEST_SUCCESS="request_success",t.JOIN_RESPONSE="join_response",t.PRE_CONNECT_PC="pre_connect_pc",t.DATACHANNEL_PRECONNECT="datachannel_preconnect",t.DATACHANNEL_CONNECTING="datachannel_connecting",t.DATACHANNEL_FAILBACK="datachannel_failback",t.P2P_CONNECTION="p2p_connection",t.P2P_REMOTE_CANDIDATE_UPDATE="p2p_remote_candidate_update",t.P2P_SUBSCRIBE="p2p_subscribe",t.P2P_UNSUBSCRIBE="p2p_unsubscribe",t.P2P_EXCHANGE_SDP="p2p_exchange_sdp",t.P2P_ON_ADD_VIDEO_STREAM="p2p_on_add_video_stream",t.P2P_ON_ADD_AUDIO_STREAM="p2p_on_add_audio_stream",t.RECOVER_NOTIFICATION="recover_notification",t.VOS_FALLBACK="vos_fallback",t.VOS_FALLBACK_PROMISE="vos_fallback_promise",t})({}),Tt=(function(t){return t.PING="ping",t.PING_BACK="ping_back",t.JOIN="join_v3",t.REJOIN="rejoin_v3",t.LEAVE="leave",t.SET_CLIENT_ROLE="set_client_role",t.PUBLISH="publish",t.PUBLISH_DATASTREAM="publish_datastream",t.UNPUBLISH="unpublish",t.UNPUBLISH_DATASTREAM="unpublish_datastream",t.SUBSCRIBE="subscribe",t.PRE_SUBSCRIBE="pre_subscribe",t.SUBSCRIBE_DATASTREAM="subscribe_datastream",t.SUBSCRIBE_STREAMS="subscribe_streams",t.UNSUBSCRIBE="unsubscribe",t.UNSUBSCRIBE_DATASTREAM="unsubscribe_datastream",t.UNSUBSCRIBE_STREAMS="unsubscribe_streams",t.SUBSCRIBE_CHANGE="subscribe_change",t.TRAFFIC_STATS="traffic_stats",t.RENEW_TOKEN="renew_token",t.SET_DUAL_STREAM_MODE="set_dual_stream_mode",t.SWITCH_VIDEO_STREAM="switch_video_stream",t.DEFAULT_VIDEO_STREAM="default_video_stream",t.SET_FALLBACK_OPTION="set_fallback_option",t.CONFIGURE="configure",t.GATEWAY_INFO="gateway_info",t.CONTROL="control",t.SEND_METADATA="send_metadata",t.DATA_STREAM="data_stream",t.PICK_SVC_LAYER="pick_svc_layer",t.RESTART_ICE="restart_ice",t.CONNECT_PC="connect_pc",t.SET_VIDEO_PROFILE="set_video_profile",t.SET_PARAMETER="set_parameter",t.SET_RTM2_FLAG="set_rtm2_flag",t.DOWNGRADE_CODEC="downgrade_codec",t})({}),hc=(function(t){return t.WRTC_STATS="wrtc_stats",t.WS_INFLATE_DATA_LENGTH="ws_inflate_data_length",t.DENOISER_STATS="denoiser_stats",t.EXTENSION_USAGE_STATS="extension_usage_stats",t})({}),Lt=(function(t){return t.ON_USER_ONLINE="on_user_online",t.ON_USER_OFFLINE="on_user_offline",t.ON_STREAM_FALLBACK_UPDATE="on_stream_fallback_update",t.ON_PUBLISH_STREAM="on_publish_stream",t.ON_UPLINK_STATS="on_uplink_stats",t.ON_P2P_LOST="on_p2p_lost",t.ON_REMOVE_STREAM="on_remove_stream",t.ON_ADD_AUDIO_STREAM="on_add_audio_stream",t.ON_ADD_VIDEO_STREAM="on_add_video_stream",t.ON_TOKEN_PRIVILEGE_WILL_EXPIRE="on_token_privilege_will_expire",t.ON_TOKEN_PRIVILEGE_DID_EXPIRE="on_token_privilege_did_expire",t.ON_USER_BANNED="on_user_banned",t.ON_USER_LICENSE_BANNED="on_user_license_banned",t.ON_NOTIFICATION="on_notification",t.ON_CRYPT_ERROR="on_crypt_error",t.MUTE_AUDIO="mute_audio",t.MUTE_VIDEO="mute_video",t.UNMUTE_AUDIO="unmute_audio",t.UNMUTE_VIDEO="unmute_video",t.ON_P2P_OK="on_p2p_ok",t.RECEIVE_METADATA="receive_metadata",t.ON_DATA_STREAM="on_data_stream",t.ON_RTP_CAPABILITY_CHANGE="on_rtp_capability_change",t.ON_REMOTE_DATASTREAM_UPDATE="on_remote_datastream_update",t.ON_REMOTE_FULL_DATASTREAM_INFO="on_remote_full_datastream_info",t.ENABLE_LOCAL_VIDEO="enable_local_video",t.DISABLE_LOCAL_VIDEO="disable_local_video",t.ENABLE_LOCAL_AUDIO="enable_local_audio",t.DISABLE_LOCAL_AUDIO="disable_local_audio",t.ON_PUBLISHED_USER_LIST="on_published_user_list",t.ENABLE_MULTI_STREAM="enable_multi_stream",t})({}),Ti=(function(t){return t.SEND_ONLY="SEND_ONLY",t.RECEIVE_ONLY="RECEIVE_ONLY",t})({}),Bt=(function(t){return t.CONNECTED="websocket:connected",t.RECONNECTING="websocket:reconnecting",t.WILL_RECONNECT="websocket:will_reconnect",t.CLOSED="websocket:closed",t.FAILED="websocket:failed",t.ON_MESSAGE="websocket:on_message",t.REQUEST_NEW_URLS="websocket:request_new_urls",t.RECONNECT_CREATE_CONNECTION="websocket:reconnect_create_connection",t.ON_TOKEN_PRIVILEGE_DID_EXPIRE="websocket:on_token_privilege_did_expire",t.ON_FALLBACK="websocket:on_fallback",t})({});function E_(t){if(typeof t!="string"||!/^[a-zA-Z0-9 \!\#\$\%\&\(\)\+\-\:\;\<\=\.\>\?\@\[\]\^\_\{\}\|\~\,]{1,64}$/.test(t))throw m.error("Invalid Channel Name ".concat(t)),new B(A.INVALID_PARAMS,"The length must be within 64 bytes. The supported characters: a-z,A-Z,0-9,space,!, #, $, %, &, (, ), +, -, :, ;, <, =, ., >, ?, @, [, ], ^, _,  {, }, |, ~, ,")}function g_(t){if(e=t,!(typeof e=="number"&&Math.floor(e)===e&&0<=e&&e<=4294967295||wO(t,1,255)))throw new B(A.INVALID_PARAMS,"[String uid] Length of the string: [1,255]. ASCII characters only. [Number uid] The value range is [0,10000]");var e;typeof t=="string"&&m.warn("You input a string as the user ID, to ensure better end-user experience, Agora highly suggests not using a string as the user ID.")}let No=(function(t){return t.TRANSCODE="mix_streaming",t.RAW="raw_streaming",t})({});const fY={alpha:1,height:640,width:360,x:0,y:0,zOrder:0,audioChannel:0},KS={x:0,y:0,width:160,height:160,zOrder:255,alpha:1};function YS(t,e){Kn(t.url,"".concat(e,".url"),1,1e3,!1),Ze(t.x)||Oe(t.x,"".concat(e,".x"),0,1e4),Ze(t.y)||Oe(t.y,"".concat(e,".y"),0,1e4),Ze(t.width)||Oe(t.width,"".concat(e,".width"),0,1e4),Ze(t.height)||Oe(t.height,"".concat(e,".height"),0,1e4),Ze(t.zOrder)||Oe(t.zOrder,"".concat(e,".zOrder"),0,255),Ze(t.alpha)||Oe(t.alpha,"".concat(e,".alpha"),0,1,!1)}const mY={audioBitrate:48,audioChannels:1,audioSampleRate:48e3,backgroundColor:0,height:360,lowLatency:!1,videoBitrate:400,videoCodecProfile:100,videoCodecType:1,videoFrameRate:15,videoGop:30,width:640,images:[],userConfigs:[],userConfigExtraInfo:""};let da=(function(t){return t.WARNING="@live_uap-warning",t.ERROR="@line_uap-error",t.PUBLISH_STREAM_STATUS="@live_uap-publish-status",t.WORKER_STATUS="@live_uap-worker-status",t.REQUEST_NEW_ADDRESS="@live_uap-request-address",t})({}),qS=(function(t){return t.REQUEST_WORKER_MANAGER_LIST="@live_req_worker_manager",t})({}),yn=(function(t){return t[t.LIVE_STREAM_RESPONSE_SUCCEED=200]="LIVE_STREAM_RESPONSE_SUCCEED",t[t.LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM=454]="LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM",t[t.LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR=450]="LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR",t[t.LIVE_STREAM_RESPONSE_BAD_STREAM=451]="LIVE_STREAM_RESPONSE_BAD_STREAM",t[t.LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR=400]="LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR",t[t.LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST=404]="LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST",t[t.LIVE_STREAM_RESPONSE_NOT_AUTHORIZED=456]="LIVE_STREAM_RESPONSE_NOT_AUTHORIZED",t[t.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE=457]="LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE",t[t.LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN=429]="LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN",t[t.LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH=452]="LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH",t[t.LIVE_STREAM_RESPONSE_NOT_SUPPORTED=453]="LIVE_STREAM_RESPONSE_NOT_SUPPORTED",t[t.LIVE_STREAM_RESPONSE_MAX_STREAM_NUM=455]="LIVE_STREAM_RESPONSE_MAX_STREAM_NUM",t[t.LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR=500]="LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR",t[t.LIVE_STREAM_RESPONSE_WORKER_LOST=501]="LIVE_STREAM_RESPONSE_WORKER_LOST",t[t.LIVE_STREAM_RESPONSE_RESOURCE_LIMIT=502]="LIVE_STREAM_RESPONSE_RESOURCE_LIMIT",t[t.LIVE_STREAM_RESPONSE_WORKER_QUIT=503]="LIVE_STREAM_RESPONSE_WORKER_QUIT",t[t.ERROR_FAIL_SEND_MESSAGE=504]="ERROR_FAIL_SEND_MESSAGE",t[t.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE=30]="PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE",t[t.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT=31]="PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT",t[t.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH=32]="PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH",t[t.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN=33]="PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN",t})({});function kD(t){if(!t.channelName)throw new B(A.INVALID_PARAMS,"invalid channelName in info");if(typeof t.uid!="number")throw new B(A.INVALID_PARAMS,"invalid uid in info, uid must be a number");return t.token&&Kn(t.token,"info.token",1,2047),g_(t.uid),E_(t.channelName),!0}let Ai=(function(t){return t[t.SetSdkProfile=0]="SetSdkProfile",t[t.SetSourceChannel=1]="SetSourceChannel",t[t.SetSourceUserId=2]="SetSourceUserId",t[t.SetDestChannel=3]="SetDestChannel",t[t.StartPacketTransfer=4]="StartPacketTransfer",t[t.StopPacketTransfer=5]="StopPacketTransfer",t[t.UpdateDestChannel=6]="UpdateDestChannel",t[t.Reconnect=7]="Reconnect",t[t.SetVideoProfile=8]="SetVideoProfile",t})({}),Do=(function(t){return t.NETWORK_DISCONNECTED="NETWORK_DISCONNECTED",t.NETWORK_CONNECTED="NETWORK_CONNECTED",t.PACKET_JOINED_SRC_CHANNEL="PACKET_JOINED_SRC_CHANNEL",t.PACKET_JOINED_DEST_CHANNEL="PACKET_JOINED_DEST_CHANNEL",t.PACKET_SENT_TO_DEST_CHANNEL="PACKET_SENT_TO_DEST_CHANNEL",t.PACKET_RECEIVED_VIDEO_FROM_SRC="PACKET_RECEIVED_VIDEO_FROM_SRC",t.PACKET_RECEIVED_AUDIO_FROM_SRC="PACKET_RECEIVED_AUDIO_FROM_SRC",t.PACKET_UPDATE_DEST_CHANNEL="PACKET_UPDATE_DEST_CHANNEL",t.PACKET_UPDATE_DEST_CHANNEL_REFUSED="PACKET_UPDATE_DEST_CHANNEL_REFUSED",t.PACKET_UPDATE_DEST_CHANNEL_NOT_CHANGE="PACKET_UPDATE_DEST_CHANNEL_NOT_CHANGE",t})({}),Mi=(function(t){return t.RELAY_STATE_IDLE="RELAY_STATE_IDLE",t.RELAY_STATE_CONNECTING="RELAY_STATE_CONNECTING",t.RELAY_STATE_RUNNING="RELAY_STATE_RUNNING",t.RELAY_STATE_FAILURE="RELAY_STATE_FAILURE",t})({}),xd=(function(t){return t.RELAY_OK="RELAY_OK",t.SERVER_CONNECTION_LOST="SERVER_CONNECTION_LOST",t.SRC_TOKEN_EXPIRED="SRC_TOKEN_EXPIRED",t.DEST_TOKEN_EXPIRED="DEST_TOKEN_EXPIRED",t})({}),Re=(function(t){return t.High="high",t.Low="low",t.Audio="audio",t.Screen="screen",t.ScreenLow="screen_low",t})({}),an=(function(t){return t.DISCONNECT="disconnect",t.CONNECTION_STATE_CHANGE="connection-state-change",t.NETWORK_QUALITY="network-quality",t.STREAM_TYPE_CHANGE="stream-type-change",t.IS_P2P_DISCONNECTED="is-p2p-dis",t.DISCONNECT_P2P="dis-p2p",t.REQUEST_NEW_GATEWAY_LIST="req-gate-url",t.NEED_RENEW_SESSION="need-sid",t.REQUEST_P2P_CONNECTION_PARAMS="request-p2p-connection-params",t.JOIN_RESPONSE="join-response",t.RESET_CONNECTION_EVENTS="reset-connection-events",t.PRE_CONNECT_PC="pre-connect_pc",t.UPDATE_GATEWAY_CONFIG="update-gateway-config",t.VOS_FALLBACK="vos-fallback",t.VOS_FALLBACK_PROMISE="vos-fallback-promise",t.RESET_SIGNAL="reset-signal",t.DATACHANNEL_FAILBACK="datachannel-failback",t})({}),S_=(function(t){return t.P2P_DISCONNECTED="P2P_DISCONNECTED",t.A_ROUND_WS_FAILED="A_ROUND_WS_FAILED",t.TIMEOUT="TIMEOUT",t.UNKNOWN_REASON="UNKNOWN_REASON",t})({}),Pn=(function(t){return t[t.Nothing=0]="Nothing",t[t.Audio=1]="Audio",t[t.LwoVideo=2]="LwoVideo",t[t.Video=4]="Video",t[t.Data=8]="Data",t[t.DataStream0=256]="DataStream0",t[t.DataStream1=512]="DataStream1",t[t.DataStream2=1024]="DataStream2",t[t.DataStream3=2048]="DataStream3",t[t.DataStream4=4096]="DataStream4",t[t.DataStream5=8192]="DataStream5",t[t.DataStream6=16384]="DataStream6",t[t.DataStream7=32768]="DataStream7",t})({}),fe=(function(t){return t.CHINA="CHINA",t.ASIA="ASIA",t.NORTH_AMERICA="NORTH_AMERICA",t.EUROPE="EUROPE",t.JAPAN="JAPAN",t.INDIA="INDIA",t.KOREA="KOREA",t.HKMC="HKMC",t.US="US",t.OCEANIA="OCEANIA",t.SOUTH_AMERICA="SOUTH_AMERICA",t.AFRICA="AFRICA",t.OVERSEA="OVERSEA",t.GLOBAL="GLOBAL",t.EXTENSIONS="EXTENSIONS",t})({});const MD=[fe.AFRICA,fe.ASIA,fe.CHINA,fe.EUROPE,fe.GLOBAL,fe.INDIA,fe.JAPAN,fe.NORTH_AMERICA,fe.OCEANIA,fe.OVERSEA,fe.SOUTH_AMERICA];let ei=(function(t){return t.CHINA="CN",t.ASIA="AS",t.NORTH_AMERICA="NA",t.EUROPE="EU",t.JAPAN="JP",t.INDIA="IN",t.KOREA="KR",t.HKMC="HK",t.US="US",t.OCEANIA="OC",t.SOUTH_AMERICA="SA",t.AFRICA="AF",t.OVERSEA="OVERSEA",t.GLOBAL="GLOBAL",t.EXTENSIONS="GLOBAL",t})({});const T_={CHINA:{},ASIA:{CODE:ei.ASIA,WEBCS_DOMAIN:["ap-web-1-asia.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-asia.agora.io"],PROXY_CS:["proxy-ap-web-asia.agora.io"],CDS_AP:["cds-ap-web-asia.agora.io","cds-ap-web-asia2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-asia.agora.io","sua-ap-web-asia2.agora.io"],UAP_AP:["uap-ap-web-asia.agora.io","uap-ap-web-asia2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-asia.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-asia.agora.io"],LOG_UPLOAD_SERVER:["logservice-asia.agora.io"],PROXY_SERVER_TYPE3:["southeast-asia.webrtc-cloud-proxy.sd-rtn.com"]},NORTH_AMERICA:{CODE:ei.NORTH_AMERICA,WEBCS_DOMAIN:["ap-web-1-north-america.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-north-america.agora.io"],PROXY_CS:["proxy-ap-web-america.agora.io"],CDS_AP:["cds-ap-web-america.agora.io","cds-ap-web-america2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-america.agora.io","sua-ap-web-america2.agora.io"],UAP_AP:["uap-ap-web-america.agora.io","uap-ap-web-america2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-north-america.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-north-america.agora.io"],LOG_UPLOAD_SERVER:["logservice-north-america.agora.io"],PROXY_SERVER_TYPE3:["east-usa.webrtc-cloud-proxy.sd-rtn.com"]},EUROPE:{CODE:ei.EUROPE,WEBCS_DOMAIN:["ap-web-1-europe.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-europe.agora.io"],PROXY_CS:["proxy-ap-web-europe.agora.io"],CDS_AP:["cds-ap-web-europe.agora.io","cds-ap-web-europe2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-europe.agora.io","sua-ap-web-europe.agora.io"],UAP_AP:["uap-ap-web-europe.agora.io","uap-ap-web-europe2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-europe.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-europe.agora.io"],LOG_UPLOAD_SERVER:["logservice-europe.agora.io"],PROXY_SERVER_TYPE3:["europe.webrtc-cloud-proxy.sd-rtn.com"]},JAPAN:{CODE:ei.JAPAN,WEBCS_DOMAIN:["ap-web-1-japan.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-japan.agora.io"],PROXY_CS:["proxy-ap-web-japan.agora.io"],CDS_AP:["cds-ap-web-japan.agora.io","cds-ap-web-japan2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-japan.agora.io","sua-ap-web-japan2.agora.io"],UAP_AP:["uap-ap-web-japan.agora.io","uap-ap-web-japan2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-japan.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-japan.agora.io"],LOG_UPLOAD_SERVER:["logservice-japan.agora.io"],PROXY_SERVER_TYPE3:["japan.webrtc-cloud-proxy.sd-rtn.com"]},INDIA:{CODE:ei.INDIA,WEBCS_DOMAIN:["ap-web-1-india.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-india.agora.io"],PROXY_CS:["proxy-ap-web-india.agora.io"],CDS_AP:["cds-ap-web-india.agora.io","cds-ap-web-india2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-india.agora.io","sua-ap-web-india2.agora.io"],UAP_AP:["uap-ap-web-india.agora.io","uap-ap-web-india2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-india.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-india.agora.io"],LOG_UPLOAD_SERVER:["logservice-india.agora.io"],PROXY_SERVER_TYPE3:["india.webrtc-cloud-proxy.sd-rtn.com"]},KOREA:{CODE:ei.KOREA,WEBCS_DOMAIN:["ap-web-1-korea.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-korea.agora.io"],PROXY_CS:["proxy-ap-web-korea.agora.io"],CDS_AP:["cds-ap-web-korea.agora.io","cds-ap-web-korea2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-korea.agora.io","sua-ap-web-korea2.agora.io"],UAP_AP:["uap-ap-web-korea.agora.io","uap-ap-web-korea2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-korea.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-korea.agora.io"],LOG_UPLOAD_SERVER:["logservice-korea.agora.io"],PROXY_SERVER_TYPE3:["korea.webrtc-cloud-proxy.sd-rtn.com"]},HKMC:{CODE:ei.HKMC,WEBCS_DOMAIN:["ap-web-1-hkmc.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-hkmc.agora.io"],PROXY_CS:["proxy-ap-web-hkmc.agora.io"],CDS_AP:["cds-ap-web-hkmc.agora.io","cds-ap-web-hkmc2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-hkmc.agora.io","sua-ap-web-hkmc2.agora.io"],UAP_AP:["uap-ap-web-hkmc.agora.io","uap-ap-web-hkmc2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-hkmc.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-hkmc.agora.io"],LOG_UPLOAD_SERVER:["logservice-hkmc.agora.io"],PROXY_SERVER_TYPE3:["hkmc.webrtc-cloud-proxy.sd-rtn.com"]},US:{CODE:ei.US,WEBCS_DOMAIN:["ap-web-1-us.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-us.agora.io"],PROXY_CS:["proxy-ap-web-us.agora.io"],CDS_AP:["cds-ap-web-us.agora.io","cds-ap-web-us2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-us.agora.io","sua-ap-web-us2.agora.io"],UAP_AP:["uap-ap-web-us.agora.io","uap-ap-web-us2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-us.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-us.agora.io"],LOG_UPLOAD_SERVER:["logservice-us.agora.io"],PROXY_SERVER_TYPE3:["us.webrtc-cloud-proxy.sd-rtn.com"]},OVERSEA:{CODE:ei.OVERSEA,WEBCS_DOMAIN:["ap-web-1-oversea.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-oversea.agora.io"],PROXY_CS:["proxy-ap-web-oversea.agora.io"],CDS_AP:["cds-ap-web-oversea.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-oversea.agora.io"],UAP_AP:["uap-ap-web-oversea.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-oversea.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-oversea.agora.io"],LOG_UPLOAD_SERVER:["logservice-oversea.agora.io"],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy.agora.io"]},GLOBAL:{CODE:ei.GLOBAL,WEBCS_DOMAIN:["webrtc2-ap-web-1.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["webrtc2-ap-web-3.agora.io"],PROXY_CS:["ap-proxy-1.agora.io","ap-proxy-2.agora.io"],CDS_AP:["cds-ap-web-1.agora.io","cds-ap-web-3.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-1.agora.io","sua-ap-web-3.agora.io"],UAP_AP:["uap-ap-web-1.agora.io","uap-ap-web-3.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2.agora.io"],LOG_UPLOAD_SERVER:["logservice.agora.io"],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy.sd-rtn.com"]},OCEANIA:{CODE:ei.OCEANIA,WEBCS_DOMAIN:["ap-web-1-oceania.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-oceania.agora.io"],PROXY_CS:["proxy-ap-web-oceania.agora.io"],CDS_AP:["cds-ap-web-oceania.agora.io","cds-ap-web-oceania2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-oceania.agora.io","sua-ap-web-oceania2.agora.io"],UAP_AP:["uap-ap-web-oceania.agora.io","uap-ap-web-oceania2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-oceania.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-oceania.agora.io"],LOG_UPLOAD_SERVER:["logservice-oceania.agora.io"],PROXY_SERVER_TYPE3:["oceania.webrtc-cloud-proxy.sd-rtn.com"]},SOUTH_AMERICA:{CODE:ei.SOUTH_AMERICA,WEBCS_DOMAIN:["ap-web-1-south-america.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-south-america.agora.io"],PROXY_CS:["proxy-ap-web-south-america.agora.io"],CDS_AP:["cds-ap-web-south-america.agora.io","cds-ap-web-south-america2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-south-america.agora.io","sua-ap-web-south-america2.agora.io"],UAP_AP:["uap-ap-web-south-america.agora.io","uap-ap-web-south-america2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-south-america.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-south-america.agora.io"],LOG_UPLOAD_SERVER:["logservice-south-america.agora.io"],PROXY_SERVER_TYPE3:["south-america.webrtc-cloud-proxy.sd-rtn.com"]},AFRICA:{CODE:ei.AFRICA,WEBCS_DOMAIN:["ap-web-1-africa.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-africa.agora.io"],PROXY_CS:["proxy-ap-web-africa.agora.io"],CDS_AP:["cds-ap-web-africa.agora.io","cds-ap-web-africa2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-africa.agora.io","sua-ap-web-africa2.agora.io"],UAP_AP:["uap-ap-web-africa.agora.io","uap-ap-web-africa2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-africa.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-africa.agora.io"],LOG_UPLOAD_SERVER:["logservice-south-africa.agora.io"],PROXY_SERVER_TYPE3:["africa.webrtc-cloud-proxy.sd-rtn.com"]},EXTENSIONS:{}};dS&&(T_.CHINA={CODE:ei.CHINA,WEBCS_DOMAIN:["webrtc2-2.ap.sd-rtn.com"],WEBCS_DOMAIN_BACKUP_LIST:["webrtc2-4.ap.sd-rtn.com"],PROXY_CS:["proxy-web.ap.sd-rtn.com"],CDS_AP:["cds-web-2.ap.sd-rtn.com","cds-web-4.ap.sd-rtn.com"],ACCOUNT_REGISTER:["sua-web-2.ap.sd-rtn.com","sua-web-4.ap.sd-rtn.com"],UAP_AP:["uap-web-2.ap.sd-rtn.com","uap-web-4.ap.sd-rtn.com"],EVENT_REPORT_DOMAIN:["web-3.statscollector.sd-rtn.com"],EVENT_REPORT_BACKUP_DOMAIN:["web-4.statscollector.sd-rtn.com"],LOG_UPLOAD_SERVER:["logservice-china.agora.io"],PROXY_SERVER_TYPE3:["east-cn.webrtc-cloud-proxy.sd-rtn.com"]});let ys=(function(t){return t.UPDATE_BITRATE_LIMIT="update_bitrate_limit",t.UPDATE_CLIENT_ROLE_OPTIONS="update_client_role_options",t.UPDATE_REMOTE_VIDEO_STREAM_TYPE="update_remote_video_stream_type",t.FALLBACK_TO_HLS="fallback_to_hls",t.UPDATE_VOS_CONFIGURE="update_vos_configure",t})({});function UD(t){return!!t&&!(!t.uplink||!t.id)&&t.uplink.max_bitrate!==void 0&&t.uplink.min_bitrate!==void 0}class xD extends qe{constructor(e,n){super(),R(this,"onICEConnectionStateChange",void 0),R(this,"onConnectionStateChange",void 0),R(this,"onDTLSTransportStateChange",void 0),R(this,"onDTLSTransportError",void 0),R(this,"onICETransportStateChange",void 0),R(this,"onFirstAudioReceived",void 0),R(this,"onFirstVideoReceived",void 0),R(this,"onFirstAudioDecoded",void 0),R(this,"onFirstVideoDecoded",void 0),R(this,"onFirstVideoRender",void 0),R(this,"onFirstVideoBufferReady",void 0),R(this,"onFirstVideoDecodedTimeout",void 0),R(this,"onSelectedLocalCandidateChanged",void 0),R(this,"onSelectedRemoteCandidateChanged",void 0),R(this,"onICECandidateError",void 0),R(this,"getLocalVideoStats",void 0)}}class R_ extends xD{constructor(e,n){super(e,n),R(this,"establishPromise",void 0)}}let ut=(function(t){return t.VIDEO="video",t.AUDIO="audio",t})({}),xn=(function(t){return t.UDP_RELAY="udp_relay",t.UDP_TCP_RELAY="udp_tcp_relay",t.TCP_RELAY="tcp_relay",t.RELAY="relay",t})({}),Po=(function(t){return t[t.FIRST_CONNECTION=0]="FIRST_CONNECTION",t[t.UDP_TCP_RESTART=1]="UDP_TCP_RESTART",t[t.RELAY_RESTART=2]="RELAY_RESTART",t[t.TCP_RESTART=3]="TCP_RESTART",t[t.OLD_FIRST_CONNECTION=10]="OLD_FIRST_CONNECTION",t[t.OLD_RESTART=11]="OLD_RESTART",t[t.DISCONNECTED_OR_FAILED=20]="DISCONNECTED_OR_FAILED",t})({});const VD=["disconnected","failed"];let tt=(function(t){return t.LocalVideoTrack="videoTrack",t.LocalAudioTrack="audioTrack",t.LocalVideoLowTrack="videoLowTrack",t})({}),me=(function(t){return t.New="new",t.Connected="connected",t.Reconnecting="reconnecting",t.Disconnected="disconnected",t})({}),Rt=(function(t){return t.AudioMetadata="audioMetadata",t.AudioPts="audioPts",t.StateChange="stateChange",t.IceConnectionStateChange="iceConnectionStateChange",t.RequestMuteLocal="requestMuteLocal",t.RequestUnmuteLocal="requestUnmuteLocal",t.RequestRePublish="requestRePublish",t.RequestRePublishDataChannel="requestRePublishDataChannel",t.RequestReSubscribe="requestReSubscribe",t.RequestUploadStats="requestUploadStats",t.RequestUpload="requestUpload",t.MediaReconnectStart="MediaReconnectStart",t.MediaReconnectEnd="MediaReconnectEnd",t.NeedSignalRTT="NeedSignalRTT",t.RequestRestartICE="RequestRestartIce",t.PeerConnectionStateChange="PeerConnectionStateChange",t.RequestReconnect="RequestReconnect",t.RequestReconnectPC="RequestReconnectPC",t.RequestUnpublishForReconnectPC="RequestUnpublishForReconnectPC",t.P2PLost="P2PLost",t.UpdateVideoEncoder="UpdateVideoEncoder",t.ConnectionTypeChange="ConnectionTypeChange",t.RequestLowStreamParameter="RequestLowStreamParameter",t.QueryClientConnectionState="QueryClientConnectionState",t.LocalCandidate="LocalCandidate",t.RequestP2PMuteLocal="requestP2PMuteLocal",t.RequestP2PUnPublish="RequestP2PUnPublish",t.RequestP2PUnmuteRemote="RequestP2PUnmuteRemote",t.RequestP2PMuteRemote="RequestP2PMuteRemote",t.RequestP2PRestartICE="RequestP2PRestartICE",t.FirstVideoPreRender="FirstVideoPreRender",t.FirstVideoBufferReady="FirstVideoBufferReady",t})({}),is=(function(t){return t.CONNECTING="CONNECTING",t.RECONNECTING="RECONNECTING",t.CONNECTED="CONNECTED",t.CLOSED="CLOSED",t})({}),rs=(function(t){return t[t.CONNECT_AP=0]="CONNECT_AP",t[t.AP_CONNECTED=1]="AP_CONNECTED",t[t.CONNECT_WORKER_MANAGER=2]="CONNECT_WORKER_MANAGER",t[t.WORKER_MANAGER_CONNECTED=3]="WORKER_MANAGER_CONNECTED",t[t.GET_WORKER_MANAGER_RESPONSE=4]="GET_WORKER_MANAGER_RESPONSE",t[t.CONNECT_WORKER=5]="CONNECT_WORKER",t[t.WORKER_CONNECTED=6]="WORKER_CONNECTED",t[t.CLOSED=7]="CLOSED",t})({}),Vn=(function(t){return t.CONNECTION_STATE_CHANGE="connection-state-change",t.STATE_CHANGE="state-change",t.INSPECT_RESULT="inspect-result",t.CLIENT_LOCAL_VIDEO_TRACK="client-local-video-track",t.REQUEST_NEW_WORKER_URL="request-new-worker-url",t})({}),la=(function(t){return t.NETWORK_ERROR="NETWORK_ERROR",t.SERVER_ERROR="SERVER_ERROR",t.MULTI_IP="MULTI_IP",t.TIMEOUT="TIMEOUT",t.OFFLINE="OFFLINE",t.LEAVE="LEAVE",t.P2P_FAILED="P2P_FAILED",t.FALLBACK="FALLBACK",t})({}),In=(function(t){return t.CONNECTED="transmitter:connected",t.RECONNECTING="transmitter:reconnecting",t.WILL_RECONNECT="transmitter:will_reconnect",t.CLOSED="transmitter:closed",t.FAILED="transmitter:failed",t.ON_MESSAGE="transmitter:on_message",t.REQUEST_NEW_URLS="transmitter:request_new_urls",t.RECONNECT_CREATE_CONNECTION="transmitter:reconnect_create_connection",t.ON_TOKEN_PRIVILEGE_DID_EXPIRE="transmitter:on_token_privilege_did_expire",t.TO_CONNECT_DATACHANNEL="transmitter:to_connect_datachannel",t.FAILBACK="transmitter:failback",t.PRE_CONNECT_PC="transmitter:pre_connect_pc",t})({}),to=(function(t){return t.CAMERA_CHANGED="camera-changed",t.MICROPHONE_CHANGED="microphone-changed",t.PLAYBACK_DEVICE_CHANGED="playback-device-changed",t.AUDIO_AUTOPLAY_FAILED="audio-autoplay-failed",t.AUTOPLAY_FAILED="autoplay-failed",t.AUDIO_CONTEXT_STATE_CHANGED="audio-context-state-changed",t.SECURITY_POLICY_VIOLATION="security-policy-violation",t})({}),Pr=(function(t){return t.CONNECTING="CONNECTING",t.RECONNECTING="RECONNECTING",t.CONNECTED="CONNECTED",t.CLOSED="CLOSED",t})({}),Is=(function(t){return t.CONNECTION_STATE_CHANGE="connection-state-change",t.STATE_CHANGE="state-change",t.INSPECT_RESULT="inspect-result",t.CLIENT_LOCAL_VIDEO_TRACK="client-local-video-track",t.REQUEST_NEW_WORKER_URL="request-new-worker-url",t})({}),Vd=(function(t){return t[t.CONNECT_AP=0]="CONNECT_AP",t[t.AP_CONNECTED=1]="AP_CONNECTED",t[t.CONNECT_WORKER_MANAGER=2]="CONNECT_WORKER_MANAGER",t[t.WORKER_MANAGER_CONNECTED=3]="WORKER_MANAGER_CONNECTED",t[t.GET_WORKER_MANAGER_RESPONSE=4]="GET_WORKER_MANAGER_RESPONSE",t[t.CONNECT_WORKER=5]="CONNECT_WORKER",t[t.WORKER_CONNECTED=6]="WORKER_CONNECTED",t[t.CLOSED=7]="CLOSED",t})({}),cn=(function(t){return t.CALL="call",t.CANDIDATE="candidate",t.PUBLISH="publish",t.UNPUBLISH="unpublish",t.CONTROL="control",t.RESTART_ICE="restart_ice",t.ACK="ack",t.RESPONSE="response",t.JOIN="join",t.CHECK="check",t})({}),Fd=(function(t){return t.ABORT="abort",t})({}),ua=(function(t){return t.MUTE_LOCAL_AUDIO="mute_local_audio",t.MUTE_LOCAL_VIDEO="mute_local_video",t.UNMUTE_LOCAL_AUDIO="unmute_local_audio",t.UNMUTE_LOCAL_VIDEO="unmute_local_video",t})({}),EY=(function(t){return t.P2P_TOKEN_TIMEOUT="p2p_token_timeout",t.P2P_TOKEN_CHANGED="p2p_token_changed",t})({});const gY={[m_.ACCESS_POINT]:{[Si.NO_FLAG_SET]:{desc:"flag is zero",retry:!1},[Si.FLAG_SET_BUT_EMPTY]:{desc:"flag is empty",retry:!1},[Si.INVALID_FALG_SET]:{desc:"invalid flag",retry:!1},[Si.FLAG_SET_BUT_NO_RE]:{desc:"flag set unilbs but no request",retry:!1},[Si.INVALID_SERVICE_ID]:{desc:"invalid service id",retry:!1},[Si.NO_SERVICE_AVAILABLE]:{desc:"no service available",retry:!0},[Si.NO_SERVICE_AVAILABLE_P2P]:{desc:"no unilbs p2p service available",retry:!0},[Si.NO_SERVICE_AVAILABLE_VOICE]:{desc:"no unilbs voice service available",retry:!0},[Si.NO_SERVICE_AVAILABLE_WEBRTC]:{desc:"no unilbs webrtc service available",retry:!0},[Si.NO_SERVICE_AVAILABLE_CDS]:{desc:"no cds service available",retry:!0},[Si.NO_SERVICE_AVAILABLE_CDN]:{desc:"no cdn dispatcher service available",retry:!0},[Si.NO_SERVICE_AVAILABLE_TDS]:{desc:"no tds service available",retry:!0},[Si.NO_SERVICE_AVAILABLE_REPORT]:{desc:"no unilbs report service available",retry:!0},[Si.NO_SERVICE_AVAILABLE_APP_CENTER]:{desc:"no app center service available",retry:!0},[Si.NO_SERVICE_AVAILABLE_ENV0]:{desc:"no unilbs sig env0 service available",retry:!0},[Si.NO_SERVICE_AVAILABLE_VOET]:{desc:"no unilbs voet service available",retry:!0},[Si.NO_SERVICE_AVAILABLE_STRING_UID]:{desc:"no string uid service available",retry:!0},[Si.NO_SERVICE_AVAILABLE_WEBRTC_UNILBS]:{desc:"no webrtc unilbs service available",retry:!0}},[m_.UNILBS]:{[Dr.INVALID_VENDOR_KEY]:{desc:"invalid vendor key, can not find appid",retry:!1},[Dr.INVALID_CHANNEL_NAME]:{desc:"invalid channel name",retry:!1},[Dr.INTERNAL_ERROR]:{desc:"unilbs internal error",retry:!1},[Dr.NO_AUTHORIZED]:{desc:"invalid token, authorized failed",retry:!1},[Dr.DYNAMIC_KEY_TIMEOUT]:{desc:"dynamic key or token timeout",retry:!1},[Dr.NO_ACTIVE_STATUS]:{desc:"no active status",retry:!1},[Dr.DYNAMIC_KEY_EXPIRED]:{desc:"dynamic key expired",retry:!1},[Dr.STATIC_USE_DYNAMIC_KEY]:{desc:"static use dynamic key",retry:!1},[Dr.DYNAMIC_USE_STATIC_KEY]:{desc:"dynamic use static key",retry:!1},[Dr.USER_OVERLOAD]:{desc:"amount of users over load",retry:!1},[Dr.FORBIDDEN_REGION]:{desc:"the request is forbidden in this area",retry:!1},[Dr.CANNOT_MEET_AREA_DEMAND]:{desc:"unable to allocate services in this area",retry:!1},[Dr.REQ_DOWNGRADE_FALLBACK]:{desc:"request downgrade fallback",retry:!1}},[m_.STRING_UID_ALLOCATOR]:{[HS.IIIEGAL_APPID]:{desc:"invalid appid",retry:!1},[HS.IIIEGAL_UID]:{desc:"invalid string uid",retry:!1},[HS.INTERNAL_ERROR]:{desc:"string uid allocator internal error",retry:!0}}};function Bd(t){const e=gY[Math.floor(t/1e4)];if(!e)return{desc:"unknown error",retry:!1};const n=e[t%1e4];if(!n){if(Math.floor(t/1e4)===m_.ACCESS_POINT){const i=t%1e4;if(i.toString()[0]==="1")return{desc:t.toString(),retry:!1};if(i.toString()[0]==="2")return{desc:t.toString(),retry:!0}}return{desc:"unknown error",retry:!1}}return n}const SY={[yt.K_TIMESTAMP_EXPIRED]:{desc:"K_TIMESTAMP_EXPIRED",action:"failed"},[yt.K_CHANNEL_PERMISSION_INVALID]:{desc:"K_CHANNEL_PERMISSION_INVALID",action:"failed"},[yt.K_CERTIFICATE_INVALID]:{desc:"K_CERTIFICATE_INVALID",action:"failed"},[yt.K_CHANNEL_NAME_EMPTY]:{desc:"K_CHANNEL_NAME_EMPTY",action:"failed"},[yt.K_CHANNEL_NOT_FOUND]:{desc:"K_CHANNEL_NOT_FOUND",action:"failed"},[yt.K_TICKET_INVALID]:{desc:"K_TICKET_INVALID",action:"failed"},[yt.K_CHANNEL_CONFLICTED]:{desc:"K_CHANNEL_CONFLICTED",action:"failed"},[yt.K_SERVICE_NOT_READY]:{desc:"K_SERVICE_NOT_READY",action:"tryNext"},[yt.K_SERVICE_TOO_HEAVY]:{desc:"K_SERVICE_TOO_HEAVY",action:"tryNext"},[yt.K_UID_BANNED]:{desc:"K_UID_BANNED",action:"failed"},[yt.K_IP_BANNED]:{desc:"K_IP_BANNED",action:"failed"},[yt.DATASTREAM2_NOT_AVAILABLE]:{desc:"DATASTREAM2_NOT_AVAILABLE",action:"quit"},[yt.K_AUTO_REBALANCE]:{desc:"k_AUTO_REBALANCE",action:"recover"},[yt.K_VOS_FALLBACK]:{desc:"K_VOS_FALLBACK",action:"tryNext"},[yt.ERR_INVALID_VENDOR_KEY]:{desc:"ERR_INVALID_VENDOR_KEY",action:"failed"},[yt.ERR_INVALID_CHANNEL_NAME]:{desc:"ERR_INVALID_CHANNEL_NAME",action:"failed"},[yt.WARN_NO_AVAILABLE_CHANNEL]:{desc:"WARN_NO_AVAILABLE_CHANNEL",action:"failed"},[yt.WARN_LOOKUP_CHANNEL_TIMEOUT]:{desc:"WARN_LOOKUP_CHANNEL_TIMEOUT",action:"tryNext"},[yt.WARN_LOOKUP_CHANNEL_REJECTED]:{desc:"WARN_LOOKUP_CHANNEL_REJECTED",action:"failed"},[yt.WARN_OPEN_CHANNEL_TIMEOUT]:{desc:"WARN_OPEN_CHANNEL_TIMEOUT",action:"tryNext"},[yt.WARN_OPEN_CHANNEL_REJECTED]:{desc:"WARN_OPEN_CHANNEL_REJECTED",action:"failed"},[yt.WARN_REQUEST_DEFERRED]:{desc:"WARN_REQUEST_DEFERRED",action:"failed"},[yt.ERR_DYNAMIC_KEY_TIMEOUT]:{desc:"ERR_DYNAMIC_KEY_TIMEOUT",action:"failed"},[yt.ERR_NO_AUTHORIZED]:{desc:"ERR_NO_AUTHORIZED",action:"failed"},[yt.ERR_VOM_SERVICE_UNAVAILABLE]:{desc:"ERR_VOM_SERVICE_UNAVAILABLE",action:"tryNext"},[yt.ERR_NO_CHANNEL_AVAILABLE_CODE]:{desc:"ERR_NO_CHANNEL_AVAILABLE_CODE",action:"failed"},[yt.ERR_MASTER_VOCS_UNAVAILABLE]:{desc:"ERR_MASTER_VOCS_UNAVAILABLE",action:"tryNext"},[yt.ERR_INTERNAL_ERROR]:{desc:"ERR_INTERNAL_ERROR",action:"tryNext"},[yt.ERR_NO_ACTIVE_STATUS]:{desc:"ERR_NO_ACTIVE_STATUS",action:"failed"},[yt.ERR_INVALID_UID]:{desc:"ERR_INVALID_UID",action:"failed"},[yt.ERR_DYNAMIC_KEY_EXPIRED]:{desc:"ERR_DYNAMIC_KEY_EXPIRED",action:"failed"},[yt.ERR_STATIC_USE_DYANMIC_KE]:{desc:"ERR_STATIC_USE_DYANMIC_KE",action:"failed"},[yt.ERR_DYNAMIC_USE_STATIC_KE]:{desc:"ERR_DYNAMIC_USE_STATIC_KE",action:"failed"},[yt.ERR_NO_VOCS_AVAILABLE]:{desc:"ERR_NO_VOCS_AVAILABLE",action:"tryNext"},[yt.ERR_NO_VOS_AVAILABLE]:{desc:"ERR_NO_VOS_AVAILABLE",action:"tryNext"},[yt.ERR_JOIN_CHANNEL_TIMEOUT]:{desc:"ERR_JOIN_CHANNEL_TIMEOUT",action:"tryNext"},[yt.ERR_JOIN_BY_MULTI_IP]:{desc:"ERR_JOIN_BY_MULTI_IP",action:"recover"},[yt.ERR_NOT_JOINED]:{desc:"ERR_NOT_JOINED",action:"failed"},[yt.ERR_REPEAT_JOIN_REQUEST]:{desc:"ERR_REPEAT_JOIN_REQUEST",action:"quit"},[yt.ERR_REPEAT_JOIN_CHANNEL]:{desc:"ERR_REPEAT_JOIN_CHANNEL",action:"quit"},[yt.ERR_INVALID_STRINGUID]:{desc:"ERR_INVALID_STRINGUID",action:"failed"},[yt.ERR_TOO_MANY_USERS]:{desc:"ERR_TOO_MANY_USERS",action:"tryNext"},[yt.ERR_SET_CLIENT_ROLE_TIMEOUT]:{desc:"ERR_SET_CLIENT_ROLE_TIMEOUT",action:"failed"},[yt.ERR_SET_CLIENT_ROLE_NO_PERMISSION]:{desc:"ERR_SET_CLIENT_ROLE_TIMEOUT",action:"failed"},[yt.ERR_SET_CLIENT_ROLE_ALREADY_IN_USE]:{desc:"ERR_SET_CLIENT_ROLE_ALREADY_IN_USE",action:"success"},[yt.ERR_PUBLISH_REQUEST_INVALID]:{desc:"ERR_PUBLISH_REQUEST_INVALID",action:"failed"},[yt.ERR_SUBSCRIBE_REQUEST_INVALID]:{desc:"ERR_SUBSCRIBE_REQUEST_INVALID",action:"failed"},[yt.ERR_NOT_SUPPORTED_MESSAGE]:{desc:"ERR_NOT_SUPPORTED_MESSAGE",action:"failed"},[yt.ERR_ILLEAGAL_PLUGIN]:{desc:"ERR_ILLEAGAL_PLUGIN",action:"failed"},[yt.ILLEGAL_CLIENT_ROLE_LEVEL]:{desc:"ILLEGAL_CLIENT_ROLE_LEVEL",action:"failed"},[yt.ERR_REJOIN_TOKEN_INVALID]:{desc:"ERR_REJOIN_TOKEN_INVALID",action:"failed"},[yt.ERR_REJOIN_USER_NOT_JOINED]:{desc:"ERR_REJOIN_NOT_JOINED",action:"failed"},[yt.ERR_INVALID_OPTIONAL_INFO]:{desc:"ERR_INVALID_OPTIONAL_INFO",action:"quit"},[yt.ERR_TEST_RECOVER]:{desc:"ERR_TEST_RECOVER",action:"recover"},[yt.ERR_TEST_TRYNEXT]:{desc:"ERR_TEST_TRYNEXT",action:"recover"},[yt.ERR_TEST_RETRY]:{desc:"ERR_TEST_RETRY",action:"recover"},[yt.ILLEGAL_AES_PASSWORD]:{desc:"ERR_TEST_RETRY",action:"failed"},[yt.ERR_TOO_MANY_BROADCASTERS]:{desc:"ERR_TOO_MANY_BROADCASTERS",action:"failed"},[yt.ERR_TOO_MANY_SUBSCRIBERS]:{desc:"ERR_TOO_MANY_SUBSCRIBERS",action:"failed"},[yt.ERR_LICENSE_ILLEGAL]:{desc:"ERR_LICENSE_ILLEGAL",action:"quit"},[yt.ERR_LICENSE_MISSING]:{desc:"ERR_LICENSE_MISSING",action:"quit"},[yt.ERR_LICENSE_EXPIRED]:{desc:"ERR_LICENSE_EXPIRED",action:"quit"},[yt.ERR_LICENSE_MINUTES_EXCEEDED]:{desc:"ERR_LICENSE_MINUTES_EXCEEDED",action:"quit"},[yt.ERR_LICENSE_PERIOD_INVALID]:{desc:"ERR_LICENSE_PERIOD_INVALID",action:"quit"},[yt.ERR_LICENSE_MULTIPLE_SDK_SERVICE]:{desc:"ERR_LICENSE_MULTIPLE_SDK_SERVICE",action:"quit"}};function pc(t){return SY[t]||{desc:"UNKNOWN_ERROR_".concat(t),action:"failed"}}function FD(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable}))),n.push.apply(n,i)}return n}function zS(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?FD(Object(n),!0).forEach((function(i){R(t,i,n[i])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):FD(Object(n)).forEach((function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i))}))}return t}function XS(t,e){if(typeof t=="string")return t;const{proxy:n,host:i,port:r}=t;if(e){const s=I("JOIN_GATEWAY_FALLBACK_PORT")||443;return s===443?"wss://".concat(i,"/ws/?p=").concat(Number(r)+150):"wss://".concat(i,":").concat(s,"/ws/?p=").concat(Number(r)+150)}return n?"wss://".concat(n,"/ws/?h=").concat(i,"&p=").concat(r):"wss://".concat(i,":").concat(r)}const TY=/wss:\/\/(.+)\/ws\/\?h=(.+)&p=([0-9]+)\/?/,RY=/wss:\/\/(.+)\/ws\/\?p=([0-9]+)\/?/,vY=/wss:\/\/(.+):([0-9]+)\/?/,CY=/wss:\/\/(.[^\/]+)\/?/;let yY=0;class IY{constructor(e,n){R(this,"id",0),R(this,"store",void 0),R(this,"recordIndex",void 0),R(this,"websockets",[]),R(this,"try443PortDuration",2e3),R(this,"forceCloseWSDuration",5e3),R(this,"try443PortTimeout",null),R(this,"forceCloseTimeout",null),R(this,"isTry443PortFailed",!1),R(this,"isNormalPortFailed",!1),R(this,"useDoubleDomain",!1),R(this,"useProxy",!1),R(this,"startTime",Date.now()),this.id=++yY,this.try443PortDuration=I("JOIN_GATEWAY_TRY_443PORT_DURATION")||2e3,this.forceCloseWSDuration=e||5e3,this.store=n}closeAllWebsockets(){this.websockets.forEach((e=>{e.onopen=null,e.onclose=null,e.onmessage=null,e.close()})),this.websockets.length=0}clearTimeout(){this.forceCloseTimeout&&clearTimeout(this.forceCloseTimeout),this.try443PortTimeout&&clearTimeout(this.try443PortTimeout),this.forceCloseTimeout=null,this.try443PortTimeout=null}logger(){var e;const n=Date.now()-this.startTime;for(var i=arguments.length,r=new Array(i),s=0;s<i;s++)r[s]=arguments[s];m.debug("[choose-best-ws ".concat((e=this.store)===null||e===void 0?void 0:e.clientId," ").concat(this.id,"] ").concat(n,"ms:"),...r)}createWebSocket(e,n,i){this.logger("createWebSocket:",e,{isTry443Port:n,hasTimeoutDetection:i});const r=I("GATEWAY_DOMAINS"),s=Date.now(),o=[],a=r.find((p=>{var f;return $(f=e.host).call(f,p)}));a||(this.useDoubleDomain=!1);const c=[];if(this.useDoubleDomain)r.forEach((p=>{c.push(XS(zS(zS({},e),{},{host:e.host.replace(a,p)}),n))}));else{const p=zS({},e);if(n&&a){const f=r.find((v=>v!==a));f&&(p.host=p.host.replace(a,f))}c.push(XS(p,n))}try{c.forEach((p=>{const f=new WebSocket(p);f.binaryType="arraybuffer",o.push(f),this.logger("ws is connecting:",f.url)}))}catch(p){if(this.logger("ws create failed"),o.forEach((f=>f.close())),o.length=0,this.useDoubleDomain)return this.useDoubleDomain=!1,this.createWebSocket(e,n,i);if(!n&&Number(e.port)!==443)return this.createWebSocket(e,!0,i);throw new B(A.WS_ERR,"init websocket failed! Error: ".concat(p.toString()))}const d=tu();this.store&&this.store.recordJoinChannelService({urls:o.map((p=>p.url)),service:"gateway"},this.recordIndex),o.forEach((p=>{p.onopen=()=>{this.logger("onopen: ws ".concat(p.url," open cost ").concat(Date.now()-s,"ms")),this.websockets.forEach((f=>{f!==p&&(f.onopen=null,f.onclose=null,f.onmessage=null,f.close(),this.logger("close backup websocket: ".concat(f.url)))})),this.websockets.length=0,d.resolve(p)},p.onclose=f=>{this.logger("onclose: ws ".concat(p.url," closed cost ").concat(Date.now()-s,"ms state: ").concat(p.readyState));const v=o.every((S=>S.readyState===WebSocket.CLOSED||S.readyState===WebSocket.CLOSING));this.logger("".concat(n?"443":"47xx"," websocket closed, all failed: ").concat(v)),v&&(n||this.isTry443PortFailed||this.useProxy)?(this.logger("onclose: all websocket is closed, ".concat(f.reason)),d.reject({code:f.code,reason:S_.A_ROUND_WS_FAILED})):!n&&v&&!this.isNormalPortFailed&&this.try443PortTimeout&&(this.logger("all 47xx websocket is closed, try 443 port"),this.clearTimeout(),h()),n?this.isTry443PortFailed=v:this.isNormalPortFailed=v},p.onmessage=f=>this.logger("".concat(p.url," onmessage: ").concat(f.data))})),this.websockets.push(...o);const l=()=>{this.websockets.forEach((p=>p.readyState!==WebSocket.OPEN&&p.close()))},h=()=>{if(d.isResolved)return l();de().os===On.MAC_OS&&xe()&&l(),this.createWebSocket(e,!0,!0).then((p=>{d.resolve(p)})).catch((p=>{this.isNormalPortFailed&&d.reject(p),this.logger("try 443 port to create ws failed")})),this.forceCloseTimeout=window.setTimeout((()=>{this.logger("5s timeout close un-opens, isWebsocket created: ",d.isResolved),this.forceCloseTimeout=null,l()}),this.forceCloseWSDuration)};return i||(()=>{if(n||this.useProxy)return this.logger("add 5s timeout at ".concat(n?"try-443":"proxy"," condition")),this.forceCloseTimeout=window.setTimeout((()=>{this.forceCloseTimeout=null,l()}),this.forceCloseWSDuration);this.try443PortTimeout=window.setTimeout((()=>{this.logger("2s timeout, isWebsocket created: ",d.isResolved),this.try443PortTimeout=null,h()}),this.try443PortDuration)})(),d.promise}chooseBestWebsocket(e,n,i,r){return this.useDoubleDomain=!!n,typeof e=="string"&&(e=(function(s){let o,a,c;return[,o,a,c]=s.match(TY)||[],o||([,a,c]=s.match(RY)||[]),a&&c||([,a,c]=s.match(vY)||[]),a&&c||([,a]=s.match(CY)||[]),a||m.warning("un-destructible url: ",s),{proxy:o,host:a,port:c||"443"}})(e)),this.recordIndex=r,this.useProxy=!!e.proxy,i&&this.useProxy&&(m.warn("cannot use 443 only when use proxy"),i=!1),this.createWebSocket(e,!!i,!1).finally((()=>this.clearTimeout()))}}function BD(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable}))),n.push.apply(n,i)}return n}class jD extends qe{get url(){return this.websocket&&this.websocket.url||this._websocketUrl}get reconnectMode(){return this._reconnectMode}set reconnectMode(e){var n;$(n=["tryNext","recover"]).call(n,e)&&this.resetReconnectCount(e),this._reconnectMode=e}get state(){return this._state}set state(e){e!==this._state&&(this._state=e,this._state==="reconnecting"?this.emit(Bt.RECONNECTING,this.reconnectReason):this._state==="connected"?this.emit(Bt.CONNECTED):this._state==="closed"?this.emit(Bt.CLOSED):this._state==="failed"&&this.emit(Bt.FAILED))}resetReconnectCount(e){m.debug("websocket reset reconnect count, reason: "+e),this.reconnectCount=0}constructor(e,n){let i=arguments.length>2&&arguments[2]!==void 0&&arguments[2],r=arguments.length>3&&arguments[3]!==void 0&&arguments[3],s=arguments.length>4&&arguments[4]!==void 0&&arguments[4],o=arguments.length>5?arguments[5]:void 0;super(),R(this,"_websocketUrl",null),R(this,"connectionID",0),R(this,"currentURLIndex",0),R(this,"urls",[]),R(this,"_reconnectMode","tryNext"),R(this,"reconnectReason",void 0),R(this,"_initMutex",void 0),R(this,"name",void 0),R(this,"_state","closed"),R(this,"reconnectInterrupter",void 0),R(this,"websocket",void 0),R(this,"retryConfig",void 0),R(this,"reconnectCount",0),R(this,"forceCloseTimeout",5e3),R(this,"onlineReconnectListener",void 0),R(this,"useCompress",void 0),R(this,"tryDoubleDomain",!1),R(this,"use443PortOnly",!1),R(this,"wsInflateLength",0),R(this,"wsDeflateLength",0),R(this,"closeEstablishingWs",(()=>{})),R(this,"store",void 0),R(this,"joinGatewayRecordIndex",void 0),this.store=o,this.name=e,this.retryConfig=(function(h){for(var p=1;p<arguments.length;p++){var f=arguments[p]!=null?arguments[p]:{};p%2?BD(Object(f),!0).forEach((function(v){R(h,v,f[v])})):Object.getOwnPropertyDescriptors?Object.defineProperties(h,Object.getOwnPropertyDescriptors(f)):BD(Object(f)).forEach((function(v){Object.defineProperty(h,v,Object.getOwnPropertyDescriptor(f,v))}))}return h})({},n),this.useCompress=i,this.tryDoubleDomain=r,this.use443PortOnly=s,this._initMutex=new Un("websocket",o?o.clientId:void 0);const{timeout:a,timeoutFactor:c}=n,d=Math.max(300,Math.floor(3*a/5)),l=Math.max(1.2,Math.floor(8*c)/10);mi.ONLINE&&(this.retryConfig.timeout=d,this.retryConfig.timeoutFactor=l),$e.on(Qa.NETWORK_STATE_CHANGE,((h,p)=>{h!==p&&(this.resetReconnectCount("network state change: ".concat(p," -> ").concat(h)),h===mi.ONLINE?(this.retryConfig.timeout=d,this.retryConfig.timeoutFactor=l):(this.retryConfig.timeout=a,this.retryConfig.timeoutFactor=c))}))}getConnection(){return this.websocket||void 0}async init(e){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:5e3;const i=await this._initMutex.lock();this._reconnectMode="tryNext",this.forceCloseTimeout=n,this.urls=e,this.state="connecting";try{var r;const s=tu(),o=this.urls[this.currentURLIndex];(r=this.store)===null||r===void 0||r.beforeConnect(),(function(a){return!($p()||I("USE_NEW_TOKEN")||!I("ENABLE_PREALLOC_PC")&&(a==null||!a.autoSubscribe||I("FORCE_DISABLE_AUTO_SUB")))})(this.store)&&this.emit(In.PRE_CONNECT_PC),this.createWebSocketConnection(o).then(s.resolve).catch(s.reject),this.once(Bt.CLOSED,(()=>{s.reject(new H(A.WS_DISCONNECT))})),this.once(Bt.CONNECTED,s.resolve),await s.promise}catch{}finally{i()}}close(e,n){if(this.currentURLIndex=0,this.resetReconnectCount("close"),this.reconnectInterrupter&&this.reconnectInterrupter(),this.websocket){this.websocket.onclose=null,this.websocket.onopen=null,this.websocket.onmessage=null;const i=this.websocket;n?setTimeout((()=>i.close()),500):i.close(),this.websocket=void 0,this._websocketUrl=null}this.state=e?"failed":"closed",this.closeEstablishingWs&&this.closeEstablishingWs()}reconnect(e,n){if(!this.websocket)return void m.warning("[".concat(this.name,"] can not reconnect, no websocket"));e!==void 0&&(this.reconnectMode=e),m.debug("[".concat(this.name,"] reconnect is triggered initiative")),typeof this.joinGatewayRecordIndex=="number"&&this.store&&this.store.recordJoinChannelService({status:"error",errors:[new Error(n)]},this.joinGatewayRecordIndex);const i=this.websocket.onclose;this.websocket.onclose=null,this.websocket.close(),i&&i.bind(this.websocket)({code:9999,reason:n})}sendMessage(e){let n=arguments.length>2&&arguments[2]!==void 0&&arguments[2];if(!this.websocket||this.websocket.readyState!==WebSocket.OPEN)throw new H(A.WS_ABORT,"websocket is not ready");try{n||(e=JSON.stringify(e)),this.websocket.send(e)}catch(i){throw new H(A.WS_ERR,"send websocket message error"+i.toString())}}setWsInflateData(e){this.wsDeflateLength=this.wsDeflateLength+e.originLength,this.wsInflateLength=this.wsInflateLength+e.compressedLength}getWsInflateData(){const e=this.wsInflateLength,n=this.wsDeflateLength;return this.clearWsInflateData(),{wsInflateLength:e,wsDeflateLength:n}}clearWsInflateData(){this.wsInflateLength=0,this.wsDeflateLength=0}async createWebSocketConnection(e){var n;const i=tu();this.connectionID+=1,this.joinGatewayRecordIndex=void 0;const r=l=>{var h;(h=this.store)===null||h===void 0||h.signalChannelOpen(),m.debug("[".concat(this.name,"] websocket opened:"),l),this.reconnectMode="retry",this.state="connected",this.resetReconnectCount("opened"),i.resolve()},s=async l=>{var h;if(m.debug("[".concat(this.name,"] websocket close ").concat((h=this.websocket)===null||h===void 0?void 0:h.url,", code: ").concat(l.code,", reason: ").concat(l.reason,", current mode: ").concat(this.reconnectMode)),this.reconnectCount>=this.retryConfig.maxRetryCount)i.reject(new H(A.WS_DISCONNECT,"websocket close: ".concat(l.code))),this.close();else{this.state==="connected"&&(this.reconnectReason=l.reason,this.state="reconnecting");const p=Ji(this,Bt.WILL_RECONNECT,this.reconnectMode,l.reason)||this.reconnectMode,f=await this.reconnectWithAction(p);if(this.state==="closed")return void m.debug("[".concat(this.connectionID,"] ws is closed, no need to reconnect"));if(!f)return i.reject(new H(A.WS_DISCONNECT,"websocket reconnect failed: ".concat(l.code))),this.close(!0);i.resolve()}},o=l=>{this.emit(Bt.ON_MESSAGE,l)},a=l=>{m.warn("[".concat(this.connectionID,"] ws open error ").concat(l))};this.websocket&&(this.websocket.onclose=null,this.websocket.close()),I("GATEWAY_WSS_ADDRESS")&&this.name.startsWith("gateway")&&(e=I("GATEWAY_WSS_ADDRESS")),m.debug("[".concat(this.name,"] start connect, url:"),e);const c=(n=this.store)===null||n===void 0?void 0:n.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"gateway"});try{var d;this._websocketUrl=XS(e);const l=await this.chooseBestWebsocketConnection(e);this.websocket=l,r&&r(this.websocket.url),this.websocket.onclose=s,this.websocket.onmessage=o,this.websocket.onerror=a,(d=this.store)===null||d===void 0||d.recordJoinChannelService({endTs:Date.now(),status:"success"},c),this.joinGatewayRecordIndex=c}catch(l){const h=this.state==="closed",p=l instanceof H,f=p&&l.code===A.WS_ABORT,v=p&&l.code===A.WS_ERR,S=p?l.message:l&&(l.reason||l.toString());m.warning("[choose-best-ws] chooseBestWebsocket error: ".concat(S)),this.store&&this.store.recordJoinChannelService({endTs:Date.now(),status:f?"aborted":"error",errors:[l]},c),h||v?(i.reject(h?new H(A.WS_DISCONNECT,"websocket is closed: ".concat(S)):new H(A.WS_ERR,"init websocket failed: ".concat(S))),v&&m.error("[".concat(this.name,"] init websocket failed: ").concat(S))):s&&s(l)}return i.promise}async reconnectWithAction(e){let n=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];if(this.reconnectCount>=this.retryConfig.maxRetryCount||this.urls.length===0||this.state==="closed")return!1;m.warning("[choose-best-ws] action: =>",e),this.onlineReconnectListener||$e.isOnline||!$e.onlineWaiter||(this.onlineReconnectListener=$e.onlineWaiter.then((()=>{this.onlineReconnectListener=void 0})));let i=!0;if(this.reconnectInterrupter=()=>i=!1,n){const o=Kp(this.reconnectCount,this.retryConfig);m.debug("[".concat(this.name,"] wait ").concat(o,"ms to reconnect websocket, mode: ").concat(e)),await st.race([Nn(o),this.onlineReconnectListener||new st((()=>{}))])}if(this._state==="closed"||!i)return!1;this.reconnectCount+=1;const r=async(o,a)=>{this.emit(Bt.RECONNECT_CREATE_CONNECTION,a),await this.createWebSocketConnection(o)};try{if(e==="retry")await r(this.urls[this.currentURLIndex],e);else if(e==="tryNext"){if(this.currentURLIndex+=1,this.currentURLIndex>=this.urls.length)return this.reconnectWithAction("recover",!1);m.debug("[".concat(this.name,"] websocket url length: ").concat(this.urls.length," current index: ").concat(this.currentURLIndex)),await r(this.urls[this.currentURLIndex],e)}else e==="recover"&&(m.debug("[".concat(this.name,"] request new urls")),this.resetReconnectCount("recover mode"),this.urls=await Sn(this,Bt.REQUEST_NEW_URLS),this.currentURLIndex=0,await r(this.urls[this.currentURLIndex],e))}catch(o){var s;m.error("[".concat(this.name,"] reconnect failed ").concat(o&&o.toString()));const a=o==null||(s=o.data)===null||s===void 0?void 0:s.desc;if(Array.isArray(a)){if($(a).call(a,"dynamic key expired"))return this.emit(Bt.ON_TOKEN_PRIVILEGE_DID_EXPIRE),!1;if($(a).call(a,"request downgrade fallback"))return this.emit(Bt.ON_FALLBACK),!1}return this.reconnectWithAction(e,n)}return!0}}class JS extends jD{constructor(e,n){super(e,n,arguments.length>2&&arguments[2]!==void 0&&arguments[2],arguments.length>3&&arguments[3]!==void 0&&arguments[3],arguments.length>4&&arguments[4]!==void 0&&arguments[4],arguments.length>5?arguments[5]:void 0)}async chooseBestWebsocketConnection(e,n){const i=tu(),r=(function(o,a){return new IY(o,a)})(this.forceCloseTimeout,this.store);this.closeEstablishingWs=()=>{m.debug("[choose-best-ws] close establishing websockets"),r.closeAllWebsockets(),i.reject(new H(A.WS_ABORT,"choose best websocket aborted"))};const s=I("GATEWAY_DOMAINS");return m.debug("[choose-best-ws] currentDomain: ",e,", domains: ",s,"total: ".concat(this.urls.length),"current: ".concat(this.currentURLIndex+1)),r.chooseBestWebsocket(e,this.tryDoubleDomain,this.use443PortOnly,n).then(i.resolve).catch(i.reject),i.promise.finally((()=>{this.closeEstablishingWs=void 0}))}}class pu extends jD{constructor(e,n){super(e,n,arguments.length>2&&arguments[2]!==void 0&&arguments[2],arguments.length>3&&arguments[3]!==void 0&&arguments[3],arguments.length>4&&arguments[4]!==void 0&&arguments[4],arguments.length>5?arguments[5]:void 0)}async chooseBestWebsocketConnection(e,n){return new st(((i,r)=>{let s=!1;const o=[];this.closeEstablishingWs=()=>{m.debug("[choose-best-ws] close establishing websockets"),o.forEach((v=>{v.onclose=null,v.onopen=null,v.onmessage=null,v.close()})),r(new H(A.WS_ABORT,"choose best websocket aborted"))};const a=I("GATEWAY_DOMAINS");let c;const d=e.indexOf("?h="),l=a.find((v=>d!==-1?$(e).call(e,v,d):$(e).call(e,v)));m.debug("[choose-best-ws] currentDomain: ",l,", domains: ",a);let h=!this.tryDoubleDomain||!l;if(!h&&l){var p;const v=Date.now();try{a.forEach((S=>{const T=d===-1?e.replace(l,S):e.substr(0,d)+e.substr(d).replace(l,S),b=new WebSocket(T);b.binaryType="arraybuffer",o.push(b),m.debug("[choose-best-ws] ws is connecting:",b.url)}))}catch{for(m.debug("[choose-best-ws] ws create failed, fallback to single url"),o.forEach((T=>T.close()));o.length;)o.pop();h=!0}(p=this.store)===null||p===void 0||p.recordJoinChannelService({urls:o.map((S=>S.url)),service:"gateway"},n),o.forEach((S=>{S.onopen=()=>{if(s)return;const T=Date.now()-v;m.debug("[choose-best-ws] ws open cost ".concat(T,"ms")),o.filter((b=>b!==S)).forEach((b=>{m.debug("[choose-best-ws]close backup websocket: ".concat(b.url)),b.close()})),s=!0,i(S)},S.onclose=T=>{c=T,!s&&(o.find((b=>!(b.readyState===WebSocket.CLOSED||b.readyState===WebSocket.CLOSING)))||(m.debug("[choose-best-ws] all websocket is closed"),s=!0,r(c)))},S.onmessage=T=>{m.debug("[choose-best-ws]".concat(S.url," onmessage: ").concat(T.data))}})),Nn(this.forceCloseTimeout).then((()=>{o.forEach((S=>{S.readyState!==WebSocket.OPEN&&S.close()}))}))}if(h){var f;let v;m.debug("[choose-best-ws] use single url: ",e),(f=this.store)===null||f===void 0||f.recordJoinChannelService({urls:[e],service:"gateway"},n);try{v=new WebSocket(e),o.push(v),v.binaryType="arraybuffer"}catch(S){const T=new H(A.WS_ERR,"init websocket failed! Error: ".concat(S.toString()));return m.error("[".concat(this.name,"]").concat(T)),void r(T)}v.onopen=()=>{i(v)},v.onclose=S=>{r(S)},v.onmessage=S=>{m.debug("[choose-best-ws]".concat(v.url," onmessage: ").concat(S.data))},Nn(this.forceCloseTimeout).then((()=>{v&&v.readyState!==WebSocket.OPEN&&v.close()}))}})).then((i=>(this.closeEstablishingWs=void 0,i))).catch((i=>{throw this.closeEstablishingWs=void 0,i}))}}class GD extends qe{get connectionState(){return this._connectionState}set connectionState(e){e!==this._connectionState&&(this._connectionState=e,e===ee.CONNECTED?this.emit(ft.WS_CONNECTED):e===ee.RECONNECTING?this.emit(ft.WS_RECONNECTING,this._websocketReconnectReason):e===ee.CLOSED&&this.emit(ft.WS_CLOSED,this._disconnectedReason))}get currentURLIndex(){return this.websocket.currentURLIndex}get url(){return this.websocket&&this.websocket.url||null}get rtt(){return this.rttRolling.mean()}constructor(e,n){super(),R(this,"__name__","AgoraRTCSignal"),R(this,"_disconnectedReason",void 0),R(this,"_websocketReconnectReason",void 0),R(this,"_connectionState",ee.CLOSED),R(this,"reconnectToken",void 0),R(this,"websocket",void 0),R(this,"openConnectionTime",void 0),R(this,"clientId",void 0),R(this,"lastMsgTime",Date.now()),R(this,"uploadCache",[]),R(this,"uploadCacheInterval",void 0),R(this,"rttRolling",new nS(5)),R(this,"pingpongTimer",void 0),R(this,"wsInflateDataTimer",void 0),R(this,"pingpongTimeoutCount",0),R(this,"ortc",void 0),R(this,"joinResponse",void 0),R(this,"multiIpOption",void 0),R(this,"initError",void 0),R(this,"spec",void 0),R(this,"store",void 0),R(this,"onWebsocketMessage",(i=>{if(i.data instanceof ArrayBuffer)return void this.emit(ft.ON_BINARY_DATA,i.data);const r=JSON.parse(i.data);if(this.lastMsgTime=Date.now(),Object.prototype.hasOwnProperty.call(r,"_id")){const s="res-@".concat(r._id);this.emit(s,r._result,r._message)}else if(Object.prototype.hasOwnProperty.call(r,"_type")){if(this.emit(r._type,r._message),r._type===Lt.ON_NOTIFICATION&&this.handleNotification(r._message),r._type===Lt.ON_USER_BANNED)switch(r._message.error_code){case 14:this.close(te.UID_BANNED);break;case 15:this.close(te.IP_BANNED);break;case 16:this.close(te.CHANNEL_BANNED)}if(r._type===Lt.ON_USER_LICENSE_BANNED)switch(r._message.error_code){case yt.ERR_LICENSE_MISSING:this.close(te.LICENSE_MISSING);break;case yt.ERR_LICENSE_EXPIRED:this.close(te.LICENSE_EXPIRED);break;case yt.ERR_LICENSE_MINUTES_EXCEEDED:this.close(te.LICENSE_MINUTES_EXCEEDED);break;case yt.ERR_LICENSE_PERIOD_INVALID:this.close(te.LICENSE_PERIOD_INVALID);break;case yt.ERR_LICENSE_MULTIPLE_SDK_SERVICE:this.close(te.LICENSE_MULTIPLE_SDK_SERVICE);break;case yt.ERR_LICENSE_ILLEGAL:this.close(te.LICENSE_ILLEGAL);break;default:this.close()}}})),this.clientId=e.clientId,this.spec=e,this.store=n,this.websocket=new JS("gateway-".concat(this.clientId),this.spec.retryConfig,!0,I("JOIN_GATEWAY_USE_DUAL_DOMAIN"),I("JOIN_GATEWAY_USE_443PORT_ONLY"),n),this.handleWebsocketEvents(),window.addEventListener("offline",(()=>{this.connectionState===ee.CONNECTED&&this.reconnect("retry",Xn.OFFLINE)}))}async request(e,n,i,r){const s=Se(6,""),o={_id:s,_type:e,_message:n},a=this.websocket.connectionID,c=()=>new st(((v,S)=>{if(this.connectionState===ee.CONNECTED)return v();const T=()=>{this.off(ft.WS_CLOSED,b),v()},b=()=>{this.off(ft.WS_CONNECTED,T),S(new B(A.WS_ABORT))};this.once(ft.WS_CONNECTED,T),this.once(ft.WS_CLOSED,b),e!==Tt.PUBLISH&&e!==Tt.PUBLISH_DATASTREAM&&e!==Tt.SUBSCRIBE&&e!==Tt.SUBSCRIBE_DATASTREAM&&e!==Tt.UNSUBSCRIBE&&e!==Tt.UNSUBSCRIBE_DATASTREAM&&e!==Tt.UNPUBLISH&&e!==Tt.UNPUBLISH_DATASTREAM&&e!==Tt.CONTROL&&e!==Tt.RESTART_ICE||this.once(ft.DISCONNECT_P2P,(()=>{S(new B(A.DISCONNECT_P2P))})),e!==Tt.PUBLISH&&e!==Tt.RESTART_ICE||this.once(ft.ABORT_P2P_EXECUTION,(()=>{S(new B(A.DISCONNECT_P2P))}))}));if(this.connectionState!==ee.CONNECTING&&this.connectionState!==ee.RECONNECTING||e===Tt.JOIN||e===Tt.REJOIN||await c(),this.websocket.sendMessage(o,!0),r)return;const d=new st(((v,S)=>{let T=!1;const b=(D,k)=>{T=!0,v({isSuccess:D==="success",message:k||{}}),this.off(ft.WS_CLOSED,w),this.off(ft.WS_RECONNECTING,w),this.emit(ft.REQUEST_SUCCESS,e,n)};this.once("res-@".concat(s),b);const w=()=>{S(new B(A.WS_ABORT,"type: ".concat(e))),this.off(ft.WS_CLOSED,w),this.off(ft.WS_RECONNECTING,w),this.off("res-@".concat(s),b)};this.once(ft.WS_CLOSED,w),this.once(ft.WS_RECONNECTING,w),Nn(I("SIGNAL_REQUEST_TIMEOUT")).then((()=>{this.websocket.connectionID!==a||T||(m.warning("[".concat(this.clientId,"] ws request timeout, type: ").concat(e)),this.emit(ft.REQUEST_TIMEOUT,e,n))}))}));let l=null;try{l=await d}catch(v){if(this.connectionState===ee.CLOSED||e===Tt.LEAVE)throw new B(A.WS_ABORT);return!this.spec.forceWaitGatewayResponse||i?v.throw():e===Tt.JOIN||e===Tt.REJOIN?null:(await c(),await this.request(e,n))}if(l.isSuccess)return l.message;const h=Number(l.message.error_code||l.message.code),p=pc(h),f=new B(A.UNEXPECTED_RESPONSE,"".concat(p.desc,": ").concat(l.message.error_str),{code:h,data:l.message,desc:p.desc});return p.action==="success"?l.message:(m.warning("[".concat(this.clientId,"] [").concat(this.websocket.connectionID,"] unexpected response from type ").concat(e,", error_code: ").concat(h,", message: ").concat(p.desc,", action: ").concat(p.action)),h===yt.ERR_TOO_MANY_BROADCASTERS?((e===Tt.JOIN||e===Tt.REJOIN)&&(this.initError=f,this.close()),f.throw()):p.action==="failed"?f.throw():p.action==="quit"?(this.initError=f,this.close(),f.throw()):(h===yt.ERR_JOIN_BY_MULTI_IP?(this.multiIpOption=l.message.option,m.warning("[".concat(this.clientId,"] detect multi ip, recover")),this.reconnect("recover",Xn.MULTI_IP)):this.reconnect(p.action,Xn.SERVER_ERROR),e===Tt.JOIN||e===Tt.REJOIN?null:await this.request(e,n)))}waitMessage(e,n){return new st((i=>{const r=s=>{(!n||n(s))&&(this.off(e,r),i(s))};this.on(e,r)}))}uploadWRTCStats(e){if(!this.store.sessionId)return void m.warn("[".concat(this.clientId,"] no session id when upload wrtc stats"));const n={lts:Date.now(),sid:this.store.sessionId,uid:this.store.intUid,stats:e};this.upload(hc.WRTC_STATS,n)}upload(e,n){const i={_type:e,_message:n};try{this.websocket.sendMessage(i)}catch{const s=I("MAX_UPLOAD_CACHE")||50;this.uploadCache.push(i),this.uploadCache.length>s&&this.uploadCache.splice(0,1),this.uploadCache.length>0&&!this.uploadCacheInterval&&(this.uploadCacheInterval=window.setInterval((()=>{if(this.connectionState!==ee.CONNECTED)return;const o=this.uploadCache.splice(0,1)[0];this.uploadCache.length===0&&(window.clearInterval(this.uploadCacheInterval),this.uploadCacheInterval=void 0),this.upload(o._type,o._message)}),I("UPLOAD_CACHE_INTERVAL")||2e3))}}send(e,n){const i={_type:e,_message:n};this.websocket.sendMessage(i)}init(e){return this.initError=void 0,this.multiIpOption=void 0,this.joinResponse=void 0,this.reconnectToken=void 0,this.openConnectionTime=void 0,new st(((n,i)=>{this.once(ft.WS_CONNECTED,(()=>n(this.joinResponse))),this.once(ft.WS_CLOSED,(r=>i(this.initError||new B(A.WS_ABORT,r)))),this.connectionState=ee.CONNECTING,this.websocket.init(e).catch(i),this.wsInflateDataTimer&&window.clearInterval(this.wsInflateDataTimer),this.wsInflateDataTimer=window.setInterval((()=>{this.handleWsInflateData()}),2e4)}))}close(e){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.wsInflateDataTimer&&(this.handleWsInflateData(),window.clearInterval(this.wsInflateDataTimer),this.wsInflateDataTimer=void 0),this.reconnectToken=void 0,this.joinResponse=void 0,this._disconnectedReason=e||te.LEAVE,this.connectionState=ee.CLOSED,m.debug("[".concat(this.clientId,"] ")+"will close websocket in signal"),this.websocket.close()}async join(){if(!this.joinResponse){this.emit(ft.ABORT_P2P_EXECUTION),this.store.signalConnected();const e=await Sn(this,ft.REQUEST_JOIN_INFO);this.store.joinReq();const n=await this.request(Tt.JOIN,e);if(this.ortc=e?.ortc,this.store.joinRep(),!n)return this.emit(ft.REPORT_JOIN_GATEWAY,S_.TIMEOUT,this.url||""),!1;this.joinResponse=n,this.emit(ft.JOIN_RESPONSE,this.joinResponse),this.reconnectToken=this.joinResponse.rejoin_token}return this.connectionState=ee.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),!0}async rejoin(){if(!this.reconnectToken)throw new B(A.UNEXPECTED_ERROR,"can not rejoin, no rejoin token");const e=Za(this,ft.REQUEST_REJOIN_INFO);e.token=this.reconnectToken;const n=await this.request(Tt.REJOIN,e);return!!n&&(this.connectionState=ee.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),n.peers&&n.peers.forEach((i=>{this.emit(Lt.ON_USER_ONLINE,{uid:i.uid}),i.audio&&this.emit(Lt.ON_ADD_AUDIO_STREAM,{uid:i.uid,uint_id:i.uint_id,audio:!0,ssrcId:i.audio_ssrc}),i.video&&this.emit(Lt.ON_ADD_VIDEO_STREAM,{uid:i.uid,uint_id:i.uint_id,video:!0,ssrcId:i.video_ssrc}),i.audio_mute?this.emit(Lt.MUTE_AUDIO,{uid:i.uid}):this.emit(Lt.UNMUTE_AUDIO,{uid:i.uid}),i.video_mute?this.emit(Lt.MUTE_VIDEO,{uid:i.uid}):this.emit(Lt.UNMUTE_VIDEO,{uid:i.uid}),i.audio_enable_local?this.emit(Lt.ENABLE_LOCAL_AUDIO,{uid:i.uid}):this.emit(Lt.DISABLE_LOCAL_AUDIO,{uid:i.uid}),i.video_enable_local?this.emit(Lt.ENABLE_LOCAL_VIDEO,{uid:i.uid}):this.emit(Lt.DISABLE_LOCAL_VIDEO,{uid:i.uid}),i.audio||i.video||this.emit(Lt.ON_REMOVE_STREAM,{uid:i.uid,uint_id:i.uint_id})})),!0)}reconnect(e,n){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.websocket.reconnect(e,n)}async downgradeCodec(e){if(!this.ortc)return!1;const n={downgrade_codec:e,ortc:this.ortc};return!!await this.request(Tt.DOWNGRADE_CODEC,n)}handleNotification(e){m.debug("[".concat(this.clientId,"] receive notification: "),e);const n=pc(e.code);if(e.code===28&&"detail"in e&&(m.info("[".concat(this.clientId,"] receive recover notification: "),e.detail),this.emit(ft.RECOVER_NOTIFICATION,e.detail)),n.action!=="success"){if(n.action!=="failed")return n.action==="quit"?e.code===yt.ERR_REPEAT_JOIN_CHANNEL&&I("IGNORE_UID_CHECK")?void this.close(te.UID_CONFLICT):(n.desc==="ERR_REPEAT_JOIN_CHANNEL"&&this.close(te.UID_BANNED),void this.close()):e.code===yt.K_VOS_FALLBACK&&"detail"in e?(m.info("[".concat(this.clientId,"] receive vos fallback notification: "),e.detail),e.detail==="FALLBACKCN"&&I("ENABLE_QUALITY_FALLBACK")?void Sn(this,ft.VOS_FALLBACK_PROMISE,e.detail).then((()=>{this.reconnect("recover",n.desc)})).catch((i=>{m.debug("[".concat(this.clientId,"] cancel vos fallback cn, error: "),i)})):e.detail==="fallback_hls"&&I("ENABLE_FALLBACK_TO_HLS")?(this.emit(ft.VOS_FALLBACK,e.detail),void this.close(te.FALLBACK_TO_HLS)):this.reconnect(n.action,n.desc)):void this.reconnect(n.action,Xn.SERVER_ERROR);m.error("[".concat(this.clientId,"] ignore error: "),n.desc)}}handlePingPong(){if(!this.websocket||this.websocket.state!=="connected")return;this.pingpongTimeoutCount>0&&this.rttRolling.add(3e3),this.pingpongTimeoutCount+=1;const e=I("PING_PONG_TIME_OUT"),n=Date.now();this.pingpongTimeoutCount>=e&&(m.warning("[".concat(this.clientId,"] PING-PONG Timeout. Last Socket Message: ").concat(n-this.lastMsgTime,"ms")),n-this.lastMsgTime>I("WEBSOCKET_TIMEOUT_MIN"))?this.reconnect("retry",Xn.TIMEOUT):this.request(Tt.PING,void 0,!0).then((()=>{this.pingpongTimeoutCount=0;const i=Date.now()-n;this.rttRolling.add(i),I("REPORT_STATS")&&this.send(Tt.PING_BACK,{pingpongElapse:i})})).catch((i=>{}))}handleWsInflateData(){const{wsInflateLength:e,wsDeflateLength:n}=this.websocket.getWsInflateData();e!==0&&n!==0&&this.upload(hc.WS_INFLATE_DATA_LENGTH,{ws_deflate_length:n,ws_inflate_length:e})}handleWebsocketEvents(){this.websocket.on(Bt.RECONNECT_CREATE_CONNECTION,(e=>{this.emit(ft.WS_RECONNECT_CREATE_CONNECTION,e)})),this.websocket.on(Bt.ON_MESSAGE,this.onWebsocketMessage),this.websocket.on(Bt.CLOSED,(()=>{this.connectionState=ee.CLOSED})),this.websocket.on(Bt.FAILED,(()=>{this._disconnectedReason=te.NETWORK_ERROR,this.connectionState=ee.CLOSED})),this.websocket.on(Bt.RECONNECTING,(e=>{this._websocketReconnectReason=e,this.joinResponse=void 0,this.connectionState===ee.CONNECTED?this.connectionState=ee.RECONNECTING:this.connectionState=ee.CONNECTING})),this.websocket.on(Bt.WILL_RECONNECT,((e,n,i)=>{const r=Za(this,ft.IS_P2P_DISCONNECTED),s=r||e!=="retry";r&&e==="retry"&&(m.debug("".concat(this.clientId," reconnect mode is retry, but p2p lost, change to tryNext")),e="tryNext",n=S_.P2P_DISCONNECTED),s&&(m.debug("".concat(this.clientId," will renewSession, reconnect mode: ").concat(e)),this.emit(ft.REPORT_JOIN_GATEWAY,n||S_.UNKNOWN_REASON,this.url||""),this.reconnectToken=void 0,this.emit(ft.DISCONNECT_P2P)),i(e)})),this.websocket.on(Bt.CONNECTED,(()=>{this.openConnectionTime=Date.now(),this.reconnectToken?this.rejoin().catch((e=>{m.warning("[".concat(this.clientId,"] rejoin failed ").concat(e)),this.reconnect("tryNext",Xn.SERVER_ERROR)})):this.join().catch((e=>{if(this.emit(ft.REPORT_JOIN_GATEWAY,e,this.url||""),e instanceof B){if(e.code===A.UNEXPECTED_RESPONSE&&e.data.code===yt.ERR_NO_AUTHORIZED)return this.initError=new B(A.TOKEN_EXPIRE,"dynamic key expired"),void this.close(te.TOKEN_EXPIRE);m.error("[".concat(this.clientId,"] join gateway request failed"),e.toString()),this.spec.forceWaitGatewayResponse?this.reconnect("tryNext",Xn.SERVER_ERROR):(this.initError=e,this.close())}}))})),this.websocket.on(Bt.REQUEST_NEW_URLS,((e,n)=>{Sn(this,ft.REQUEST_RECOVER,this.multiIpOption).then(e).catch(n)})),this.websocket.on(Bt.ON_TOKEN_PRIVILEGE_DID_EXPIRE,(()=>{this.emit(Lt.ON_TOKEN_PRIVILEGE_DID_EXPIRE)})),this.websocket.on(In.PRE_CONNECT_PC,(()=>{this.emit(ft.PRE_CONNECT_PC)})),this.websocket.on(Bt.ON_FALLBACK,(()=>{I("ENABLE_FALLBACK_TO_HLS")&&this.emit(ft.VOS_FALLBACK,"fallback_hls")}))}}let bY=(function(t){return t.NATIVE_RTC="native_rtc",t.NATIVE_RTM="native_rtm",t.WEB_RTC="web_rtc",t.WEB_RTM="web_rtm",t})({}),mn=(function(t){return t[t.CHOOSE_SERVER=11]="CHOOSE_SERVER",t[t.CLOUD_PROXY=18]="CLOUD_PROXY",t[t.CLOUD_PROXY_5=20]="CLOUD_PROXY_5",t[t.CLOUD_PROXY_FALLBACK=26]="CLOUD_PROXY_FALLBACK",t})({});function WD(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable}))),n.push.apply(n,i)}return n}function v_(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?WD(Object(n),!0).forEach((function(i){R(t,i,n[i])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):WD(Object(n)).forEach((function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i))}))}return t}let QS=0;function ss(t){const e=I("TURN_DOMAINS");QS=(QS+1)%e.length;const n=e[QS]||"edge.agora.io";return t.match(/^[\.\:\d]+$/)?"".concat(t.replace(/[^\d]/g,"-"),".").concat(n):(m.debug("Cannot recognized as ip address: ".concat(t,", use as host2")),t)}function C_(t){try{const e=I("TURN_DOMAINS"),n=I("GATEWAY_DOMAINS").concat(e).find((i=>$(t).call(t,i)));return n?t.split(".".concat(n))[0].replace(/-/g,"."):t}catch{return m.debug("serverUrlToIp error, fallback to url",t),t}}function ZS(t,e){t.addresses||(t.addresses=[]);const n=(function(a,c){if(I("CONNECT_GATEWAY_WITHOUT_DOMAIN"))return a.map((h=>{let{ip:p,port:f}=h;return{address:"".concat(p,":").concat(f)}}));const d=I("GATEWAY_DOMAINS");let l=d[1]&&$(c).call(c,d[1])?1:0;return a.map((h=>{let{domain_prefix:p,port:f,ip:v}=h;if(p)return{address:"".concat(p,".").concat(d[l++%d.length],":").concat(f)};const S=/^[\.\:\d]+$/.test(v),T=S?"".concat(v.replace(/[^\d]/g,"-"),".").concat(d[l++%d.length],":").concat(f):"".concat(v,":").concat(f);return S||m.debug("Cannot recognized as ip address: ".concat(v,", use as host3")),{ip:v,port:f,address:T}}))})(t.addresses,e),i=Array.isArray(t.detail)&&t.detail[18];if(i&&typeof i=="string"){const a=i.split(";");for(let c=0;c<a.length;c++){var r;const d=_i(r=a[c]).call(r);n[c]&&d&&(n[c].ip6=d)}}const s=t.detail&&t.detail.candidate;let o;if(s){const[a,c]=s.split(":");a&&c&&(o={port:Number(c),ip:a,address:"".concat(a,":").concat(c)})}return{gatewayAddrs:n,apGatewayAddress:o,uid:t.uid,cid:t.cid,cert:t.cert,vid:t.detail&&t.detail[8],uni_lbs_ip:t.detail&&t.detail[1],res:t,csIp:t.detail&&t.detail[502]}}function wi(t){return typeof t=="number"?t:t.exact||t.ideal||t.max||t.min||0}function HD(t){const e=t._encoderConfig;if(!e)return{};const n={resolution:e.width&&e.height?"".concat(wi(e.width),"x").concat(wi(e.height)):void 0,maxVideoBW:e.bitrateMax,minVideoBW:e.bitrateMin};return typeof e.frameRate=="number"?(n.maxFrameRate=e.frameRate,n.minFrameRate=e.frameRate):e.frameRate&&(n.maxFrameRate=e.frameRate.max||e.frameRate.ideal||e.frameRate.exact||e.frameRate.min,n.minFrameRate=e.frameRate.min||e.frameRate.ideal||e.frameRate.exact||e.frameRate.max),n}function y_(t){return t>=0&&t<.17?1:t>=.17&&t<.36?2:t>=.36&&t<.59?3:t>=.59&&t<=1?4:t>1?5:0}function _u(t,e){let n,i,r;switch(e){case mn.CHOOSE_SERVER:i=4096,r="choose server";break;case mn.CLOUD_PROXY:i=1048576,r="proxy";break;case mn.CLOUD_PROXY_5:i=4194304,r="proxy5";break;case mn.CLOUD_PROXY_FALLBACK:i=4194310,r="proxy fallback";break;default:throw new B(A.UNEXPECTED_ERROR,"multi unlibs response transformer get unknown service id",{csIp:t.detail&&t.detail[502],retry:!1})}if(t.response_body.forEach((s=>{s.buffer&&s.buffer.flag===i&&(n={code:s.buffer.code,addresses:(s.buffer.edges_services||[]).map((o=>v_(v_({},o),{},{ticket:s.buffer.cert}))),server_ts:t.enter_ts,uid:s.buffer.uid,cid:s.buffer.cid,cname:s.buffer.cname,detail:v_(v_({},s.buffer.detail),t.detail),flag:s.buffer.flag,opid:t.opid,cert:s.buffer.cert})})),!n)throw new B(A.MULTI_UNILBS_RESPONSE_ERROR,"cannot parse response ".concat(r," from multi unilbs response"),{csIp:t.detail&&t.detail[502]});return n}async function KD(t,e){return await st.all(t.addresses.map((async n=>({address:ss(n.ip),tcpport:n.port,udpport:n.port,username:e&&I("ENCRYPT_PROXY_USERNAME_AND_PSW")&&window.isSecureContext?e.toString():Jn.username,password:e&&I("ENCRYPT_PROXY_USERNAME_AND_PSW")&&window.isSecureContext?await Xg(e.toString()):Jn.password}))))}function $S(t,e){const n=e.getMediaStreamTrack(!0).getSettings(),i=e.videoHeight||n.height,r=e.videoWidth||n.width;return i&&r?Math.max(Math.min(i,r)/Math.min(wi(t.height),wi(t.width)),1):(m.warning("can't get ori-track's height, default scale down 4 times for low stream"),4)}function ha(t){let{candidateType:e,relayProtocol:n,type:i,address:r,port:s,protocol:o}=t;const a={candidateType:e,relayProtocol:n,protocol:o};if(i!=="local-candidate"){const c=r.split(".");c.length>=4&&(c[1]="*",c[2]="*"),a.address=c.join("."),a.port=s}return a}function eo(t){const e=t.split(":"),n=t.split(/[-.]/),i=$(t).call(t,"-")?"-":".";let r=t;return e.length>1?n.length>1?(n[1]="**",r=n[0]+i+"**:"+e[e.length-1]):r=e.length>2?e[0]+i+"**:"+e[e.length-1]:"**:"+e[e.length-1]:n.length>1&&(r=n[0]+i+"**"),r}function YD(t,e){return t.getTransceivers().find((n=>n.sender.track===e||n.receiver.track===e))}function fu(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:I("SVC_MODE");if(I("ENABLE_SVC"))return(function(e){return e in zp})(t)?t:zp.L1T3}const qD={[ut.VIDEO]:[{key:"abs-send-time",extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"},{key:"video-orientation",extensionName:"urn:3gpp:video-orientation"},{key:"draft-holmer-rmcat-transport-wide-cc-extensions-01",extensionName:"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"},{key:"playout-delay",extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/playout-delay"},{key:"video-content-type",extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/video-content-type"},{key:"color-space",extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/color-space"},{key:"video-timing",extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/video-timing"}],[ut.AUDIO]:[{key:"ssrc-audio-level",extensionName:"urn:ietf:params:rtp-hdrext:ssrc-audio-level"},{key:"draft-holmer-rmcat-transport-wide-cc-extensions-01",extensionName:"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"},{key:"abs-send-time",extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"}]};function zD(t){t.send&&(jd(ut.VIDEO,t.send.videoExtensions),jd(ut.AUDIO,t.send.audioExtensions)),t.recv&&(jd(ut.VIDEO,t.recv.videoExtensions),jd(ut.AUDIO,t.recv.audioExtensions)),t.sendrecv&&(jd(ut.VIDEO,t.sendrecv.videoExtensions),jd(ut.AUDIO,t.sendrecv.audioExtensions))}function XD(t,e){t.send&&(I_(ut.VIDEO,t.send.videoExtensions,e.send.videoExtensions),I_(ut.AUDIO,t.send.audioExtensions,e.send.audioExtensions)),t.recv&&(I_(ut.VIDEO,t.recv.videoExtensions,e.recv.videoExtensions),I_(ut.AUDIO,t.recv.audioExtensions,e.recv.audioExtensions))}function I_(t,e,n){e.forEach((i=>{var r;const s=qD[t].find((a=>{var c;let{key:d}=a;return $(c=i.extensionName).call(c,d)}));if(!s)return;const o=n.find((a=>{let{extensionName:c}=a;return $(c).call(c,s.key)}));o&&$(r=o.extensionName).call(r,"gdpr_forbidden")&&(i.extensionName=o.extensionName)}))}function jd(t,e){e.forEach((n=>{var i;const r=qD[t].find((s=>{var o;let{key:a}=s;return $(o=n.extensionName).call(o,a)}));$(i=n.extensionName).call(i,"gdpr_forbidden")&&r&&(n.extensionName=r.extensionName)}))}function JD(t){return t==="http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"||$(t).call(t,"abs-send-time")}function b_(t){return t==="http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"||$(t).call(t,"draft-holmer-rmcat-transport-wide-cc-extensions-01")}function QD(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable}))),n.push.apply(n,i)}return n}function ZD(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?QD(Object(n),!0).forEach((function(i){R(t,i,n[i])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):QD(Object(n)).forEach((function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i))}))}return t}function mu(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{},i=arguments.length>3?arguments[3]:void 0;const{filterRTX:r,filterVideoFec:s,filterAudioFec:o,filterAudioCodec:a,filterVideoCodec:c,unsupportedVideoUplinkCodec:d,unsupportedVideoDownlinkCodec:l}=e,{useXR:h}=n;let p=[],f=[],v=[],S=[],T=!1,b=!1;if(Ei(t).mediaDescriptions.forEach((D=>{i&&i!==D.attributes.direction||(D.media.mediaType!=="video"||T||(f=D.attributes.payloads,S=D.attributes.extmaps,T=!0),D.media.mediaType!=="audio"||b||(p=D.attributes.payloads,v=D.attributes.extmaps,b=!0))})),!S||f.length===0)throw new Error("Cannot get video capabilities from SDP.");if(!v||p.length===0)throw new Error("Cannot get audio capabilities from SDP.");if(f.forEach((D=>{var k;(k=D.rtpMap)!==null&&k!==void 0&&k.clockRate&&(D.rtpMap.clockRate=parseInt(D.rtpMap.clockRate)),h&&D.rtcpFeedbacks.push({type:"rrtr"})})),p.forEach((D=>{var k;(k=D.rtpMap)!==null&&k!==void 0&&k.clockRate&&(D.rtpMap.clockRate=parseInt(D.rtpMap.clockRate)),h&&D.rtcpFeedbacks.push({type:"rrtr"})})),r&&(p=p.filter((D=>{var k;return((k=D.rtpMap)===null||k===void 0?void 0:k.encodingName.toLowerCase())!=="rtx"})),f=f.filter((D=>{var k;return((k=D.rtpMap)===null||k===void 0?void 0:k.encodingName.toLowerCase())!=="rtx"}))),s){const D=f.filter((P=>{var x;return/(red)|(ulpfec)|(flexfec)/i.test(((x=P.rtpMap)===null||x===void 0?void 0:x.encodingName)||"")})),k=pa(D,f).map((P=>P.payloadType)),U=[...D.map((P=>P.payloadType)),...k];f=f.filter((P=>!$(U).call(U,P.payloadType)))}if(o&&(p=p.filter((D=>{var k;return!/(red)|(ulpfec)|(flexfec)/i.test(((k=D.rtpMap)===null||k===void 0?void 0:k.encodingName)||"")}))),a&&a?.length>0&&(p=p.filter((D=>{var k;return $(a).call(a,((k=D.rtpMap)===null||k===void 0?void 0:k.encodingName.toLowerCase())||"")}))),c&&c?.length>0){const D=f.filter((k=>{var U;return $(c).call(c,((U=k.rtpMap)===null||U===void 0?void 0:U.encodingName.toLowerCase())||"")}));f=D.concat(r?[]:pa(D,f))}const w=I("UNSUPPORTED_VIDEO_CODEC");if(w&&w.length>0){const D=f.filter((P=>P.rtpMap&&$(w).call(w,P.rtpMap.encodingName.toLowerCase()))),k=pa(D,f),U=D.concat(k).map((P=>P.payloadType));f=f.filter((P=>!$(U).call(U,P.payloadType))),m.debug("unsupportedVideoCodec: ".concat(w,", toBeRemoved: ").concat(U))}if(d&&d.length>0&&i==="sendonly"){const D=f.filter((P=>P.rtpMap&&$(d).call(d,P.rtpMap.encodingName.toLowerCase()))),k=pa(D,f),U=D.concat(k).map((P=>P.payloadType));f=f.filter((P=>!$(U).call(U,P.payloadType))),m.debug("unsupportedVideoUplinkCodec: ".concat(d,", toBeRemoved: ").concat(U))}if(l&&l.length>0&&i==="recvonly"){const D=f.filter((P=>P.rtpMap&&$(l).call(l,P.rtpMap.encodingName.toLowerCase()))),k=pa(D,f),U=D.concat(k).map((P=>P.payloadType));f=f.filter((P=>!$(U).call(U,P.payloadType))),m.debug("unsupportedVideoDownlinkCodec: ".concat(l,", toBeRemoved: ").concat(U))}return{audioCodecs:p,videoCodecs:f,audioExtensions:v,videoExtensions:S}}function no(t){const e=Ei(t);let n,i;for(const r of e.mediaDescriptions){if(!n){const s=r.attributes.iceUfrag,o=r.attributes.icePwd;if(!s||!o)throw new Error("Cannot get iceUfrag or icePwd from SDP.");n={iceUfrag:s,icePwd:o}}if(!i){const s=r.attributes.fingerprints;s.length>0&&(i={fingerprints:s})}}if(!i&&e.attributes.fingerprints.length>0&&(i={fingerprints:e.attributes.fingerprints}),!i||!n)throw new Error("Cannot get iceParameters or dtlsParameters from SDP.");return{iceParameters:n,dtlsParameters:i}}function tT(t,e){const n=[],i=t.attributes.ssrcGroups.filter((o=>o.semantic==="FID")),r=t.attributes.ssrcGroups.find((o=>o.semantic==="SIM")),s=t.attributes.ssrcs;if(r)r.ssrcIds.forEach((o=>{var a;const c=(a=i.find((d=>d.ssrcIds[0]===o)))===null||a===void 0?void 0:a.ssrcIds[1];n.push({ssrcId:o,rtx:e?c:void 0})}));else if(i.length>0){const o=i[0].ssrcIds[0],a=i[0].ssrcIds[1];n.push({ssrcId:o,rtx:e?a:void 0})}else{if(s.length===0)throw new Error("No ssrcs found on local media description.");n.push({ssrcId:s[0].ssrcId})}return n}function $D(t,e,n){const{cname:i}=t;let r=[];e&&(r=tP(e)),r.length===0&&(r=t.iceParameters.candidates.map((l=>({foundation:l.foundation,componentId:"1",transport:l.protocol,priority:l.priority.toString(),connectionAddress:l.ip,port:l.port.toString(),type:l.type,extension:{}}))),m.debug("Using candidates from gateway."));const s={fingerprints:t.dtlsParameters.fingerprints.map((l=>({hashFunction:l.algorithm,fingerprint:l.fingerprint})))},o={iceUfrag:t.iceParameters.iceUfrag,icePwd:t.iceParameters.icePwd};let a;switch(t.dtlsParameters.role){case"server":a="passive";break;case"client":a="active";break;case"auto":a="actpass"}const c=gu(t.rtpCapabilities),d=[];return Array.isArray(n)&&n.length>0&&n.forEach((l=>{d.push({kind:ut.VIDEO,ssrcMsg:[{ssrcId:l.v,rtx:l.v_rtx}],mslabel:"".concat(l.v,"_").concat(l.a)},{kind:ut.AUDIO,ssrcMsg:[{ssrcId:l.a}],mslabel:"".concat(l.v,"_").concat(l.a)})})),{dtlsParameters:s,iceParameters:o,candidates:r,rtpCapabilities:c,setup:a,cname:i,preSSRCs:d}}function tP(t){let e=[];return t.ip&&typeof t.port=="number"&&(e=[{foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:t.ip,port:t.port.toString(),type:"host",extension:{}}],m.debug("Using remote candidate from AP ".concat(eo(t.ip),":").concat(t.port)),t.ip6&&(e.push({foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:t.ip6,port:t.port.toString(),type:"host",extension:{}}),m.debug("Using IPV6 remote candidate from AP ".concat(eo(t.ip6),":").concat(t.port)))),e}function Eu(t,e,n){const i=[],r=[];return t.forEach((s=>{let{ssrcId:o,rtx:a}=s;const c=Se(8,"track-"),d={ssrcId:o,attributes:ZD({label:c,mslabel:n=n||Se(10,""),msid:"".concat(n," ").concat(c)},e&&{cname:e})};if(i.push(d),a!==void 0){const l={ssrcId:a,attributes:ZD({label:c,mslabel:n,msid:"".concat(n," ").concat(c)},e&&{cname:e})};i.push(l),r.push({semantic:"FID",ssrcIds:[o,a]})}})),t.length>1&&r.push({semantic:"SIM",ssrcIds:t.map((s=>{let{ssrcId:o}=s;return o}))}),{ssrcs:i,ssrcGroups:r}}function _c(t,e){e instanceof rn&&t.attributes.payloads.forEach((n=>{var i;const r=(i=n.rtpMap)===null||i===void 0?void 0:i.encodingName.toLowerCase();if(!r||["opus","pcmu","pcma","g722"].indexOf(r)===-1)return;n.fmtp||(n.fmtp={parameters:{}}),r==="opus"&&typeof I("OPUS_PTIME")=="number"?n.fmtp.parameters.ptime=I("OPUS_PTIME"):n.fmtp.parameters.minptime="10",n.fmtp.parameters.useinbandfec="1";const s=e._encoderConfig;s&&(r!=="pcmu"&&r!=="pcma"&&r!=="g722"&&(s.bitrate&&!xe()&&(n.fmtp.parameters.maxaveragebitrate="".concat(Math.floor(1e3*s.bitrate))),s.sampleRate&&(n.fmtp.parameters.maxplaybackrate="".concat(s.sampleRate),n.fmtp.parameters["sprop-maxcapturerate"]="".concat(s.sampleRate)),s.stereo&&(n.fmtp.parameters.stereo="1",n.fmtp.parameters["sprop-stereo"]="1")),e instanceof uu&&r==="opus"&&e._config.DTX&&(n.fmtp.parameters.usedtx="1"))}))}function eT(t){const e=t.attributes.unrecognized.findIndex((n=>n.attField==="x-google-flag"&&n.attValue==="conference"));e!==-1&&t.attributes.unrecognized.splice(e,1)}function nT(t,e){var n;if(t.attributes.payloads.forEach((r=>{var s;((s=r.rtpMap)===null||s===void 0?void 0:s.encodingName.toLowerCase())==="h264"&&r.fmtp&&r.fmtp.parameters&&I("ENABLE_UP_SPS_PPS")&&(r.fmtp.parameters["sps-pps-idr-in-keyframe"]="1")})),!(e instanceof De&&e._encoderConfig&&e._hints.indexOf(Ee.SCREEN_TRACK)===-1))return;const i=e._encoderConfig;Jt().supportMinBitrate&&i.bitrateMin&&t.attributes.payloads.forEach((r=>{var s,o;$(s=["h264","h265","vp8","vp9","av1"]).call(s,((o=r.rtpMap)===null||o===void 0?void 0:o.encodingName.toLowerCase())||"")&&(r.fmtp||(r.fmtp={parameters:{}}),r.fmtp.parameters["x-google-min-bitrate"]="".concat(i.bitrateMin))})),Jt().supportMinBitrate&&!$(n=e._hints).call(n,Ee.LOW_STREAM)&&i.bitrateMax&&t.attributes.payloads.forEach((r=>{var s,o;$(s=["h264","h265","vp8","vp9","av1"]).call(s,((o=r.rtpMap)===null||o===void 0?void 0:o.encodingName.toLowerCase())||"")&&(r.fmtp||(r.fmtp={parameters:{}}),r.fmtp.parameters["x-google-start-bitrate"]="".concat(I("X_GOOGLE_START_BITRATE")||Math.floor(i.bitrateMax)))}))}function eP(t){if(t.media.mediaType!=="video")return;const e=de();if(e.name!==he.SAFARI&&e.os!==On.IOS)return;const n=t.attributes.extmaps.findIndex((i=>/video-orientation/g.test(i.extensionName)));n!==-1&&t.attributes.extmaps.splice(n,1)}function A_(t,e,n){if(!e)return;let i,r;if(t.media.mediaType==="video"?(i=n.videoExtensions,r=n.videoCodecs):(i=n.audioExtensions,r=n.audioCodecs),e.twcc===!0){const s=i.find((o=>b_(o.extensionName)));if(s){const o=s.extensionName;t.attributes.extmaps.find((c=>b_(c.extensionName)))||t.attributes.extmaps.push({entry:s.entry,extensionName:o}),(function(c,d){return d.filter((l=>!!c.find((h=>h.payloadType===l.payloadType&&!!h.rtcpFeedbacks.find((p=>p.type==="transport-cc"))))))})(r,t.attributes.payloads).forEach((c=>{c.rtcpFeedbacks.find((d=>d.type==="transport-cc"))||c.rtcpFeedbacks.push({type:"transport-cc"})}))}}else if(e.twcc===!1){const s=t.attributes.extmaps.findIndex((o=>b_(o.extensionName)));s!==-1&&t.attributes.extmaps.splice(s,1),t.attributes.payloads.forEach((o=>{const a=o.rtcpFeedbacks.findIndex((c=>c.type==="transport-cc"));a!==-1&&o.rtcpFeedbacks.splice(a,1)}))}if(e.remb===!0){const s=i.find((o=>JD(o.extensionName)));if(s){const o=s.extensionName;t.attributes.extmaps.find((c=>c.extensionName===o))||t.attributes.extmaps.push({entry:s.entry,extensionName:o}),(function(c,d){return d.filter((l=>!!c.find((h=>h.payloadType===l.payloadType&&!!h.rtcpFeedbacks.find((p=>p.type==="goog-remb"))))))})(r,t.attributes.payloads).forEach((c=>{c.rtcpFeedbacks.find((d=>d.type==="goog-remb"))||c.rtcpFeedbacks.push({type:"goog-remb"})}))}}else if(e.remb===!1){const s=t.attributes.extmaps.findIndex((o=>JD(o.extensionName)));s!==-1&&t.attributes.extmaps.splice(s,1),t.attributes.payloads.forEach((o=>{const a=o.rtcpFeedbacks.findIndex((c=>c.type==="goog-remb"));a!==-1&&o.rtcpFeedbacks.splice(a,1)}))}}function iT(t,e,n){if(xe()||t.media.mediaType!=="video"||!(e instanceof De)||n!=="vp9"&&n!=="vp8"||n==="vp8"&&!I("SIMULCAST")||n==="vp9"&&I("ENABLE_SVC")||e._scalabilityMode===void 0||e._scalabilityMode.numSpatialLayers<=1)return;const i=n==="vp8"?2:e._scalabilityMode.numSpatialLayers,r=t.attributes.ssrcs[0],s=t.attributes.ssrcGroups.find((a=>a.semantic==="FID"&&a.ssrcIds[0]===r.ssrcId)),o={semantic:"SIM",ssrcIds:[r.ssrcId]};for(let a=1;a<i;a++)t.attributes.ssrcs.push({ssrcId:r.ssrcId+a,attributes:Ve(r.attributes)}),o.ssrcIds.push(r.ssrcId+a),s&&(t.attributes.ssrcs.push({ssrcId:s.ssrcIds[1]+a,attributes:Ve(r.attributes)}),t.attributes.ssrcGroups.push({semantic:"FID",ssrcIds:[r.ssrcId+a,s.ssrcIds[1]+a]}));t.attributes.ssrcGroups.unshift(o)}async function nP(){try{const t=new RTCPeerConnection;t.addTransceiver("video",{direction:"sendonly",sendEncodings:[{scalabilityMode:zp.L1T3}]});const e=await t.createOffer();if(!e.sdp)return void t.close();const n=Ei(e.sdp).mediaDescriptions[0];if(!n)return;const i=n.attributes.extmaps.find((r=>r.extensionName==="https://aomediacodec.github.io/av1-rtp-spec/#dependency-descriptor-rtp-header-extension"));return t.close(),i}catch{return}}async function rT(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};const n=new RTCPeerConnection;n.addTransceiver("video",{direction:"sendonly"}),n.addTransceiver("audio",{direction:"sendonly"}),n.addTransceiver("video",{direction:"recvonly"}),n.addTransceiver("audio",{direction:"recvonly"});const i=(await n.createOffer()).sdp,{send:r,recv:s,sendrecv:o}=(function(){let a=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},c=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},d=arguments.length>2?arguments[2]:void 0;const l=mu(d,a,c,"sendonly"),h=mu(d,a,c,"recvonly"),p={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},f={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},v={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]};if(os(l,h,"videoExtensions",p,f,v),os(l,h,"videoCodecs",p,f,v),os(l,h,"audioExtensions",p,f,v),os(l,h,"audioCodecs",p,f,v),I("RAISE_H264_BASELINE_PRIORITY")){const S=[],T=[];if(v.videoCodecs.forEach(((b,w)=>{var D;if(((D=b.rtpMap)===null||D===void 0?void 0:D.encodingName.toLocaleLowerCase())==="h264"){var k,U;const P=v.videoCodecs[w+1],x=P&&oP(b,P),q=(k=b.fmtp)===null||k===void 0?void 0:k.parameters["profile-level-id"],Q=(U=b.fmtp)===null||U===void 0?void 0:U.parameters["packetization-mode"];!q||q!==I("FIRST_H264_PROFILE_LEVEL_ID")||I("FIRST_PACKETIZATION_MODE")&&Q!==I("FIRST_PACKETIZATION_MODE")?x?T.push([b,P]):T.push([b]):x?S.push([b,P]):S.push([b])}})),S.length>0&&T.length>0){m.debug("raising H264 baseline profile priority"),v.videoCodecs.forEach(((w,D)=>{var k;if(((k=w.rtpMap)===null||k===void 0?void 0:k.encodingName.toLocaleLowerCase())==="h264"){const U=oP(w,v.videoCodecs[D+1]),P=S.shift()||T.shift()||[];P.length>0&&(U?v.videoCodecs.splice(D,2,...P):v.videoCodecs.splice(D,1,...P))}}));const b=f.videoCodecs.filter((w=>{var D,k;return((D=w.rtpMap)===null||D===void 0?void 0:D.encodingName.toLocaleLowerCase())==="h264"&&((k=w.fmtp)===null||k===void 0?void 0:k.parameters["profile-level-id"])!==I("FIRST_H264_PROFILE_LEVEL_ID")}));if(b.length>0){const w=pa(b,f.videoCodecs).map((k=>k.payloadType)),D=[...b.map((k=>k.payloadType)),...w];f.videoCodecs=f.videoCodecs.filter((k=>!$(D).call(D,k.payloadType)))}I("FILTER_SEND_H264_BASELINE")&&(p.videoCodecs=p.videoCodecs.filter((w=>{var D,k;return!(((D=w.rtpMap)===null||D===void 0?void 0:D.encodingName.toLocaleLowerCase())==="h264"&&((k=w.fmtp)===null||k===void 0?void 0:k.parameters["profile-level-id"])!==I("FIRST_H264_PROFILE_LEVEL_ID"))})))}return{send:p,recv:f,sendrecv:v}}return{send:p,recv:f,sendrecv:v}})(t,e,i);try{n.close()}catch{}return{send:r,recv:s,sendrecv:o}}function iP(){const t={audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]},e=mu(arguments.length>2?arguments[2]:void 0,arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},"recvonly"),n={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},i={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},r={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]};if(os(t,e,"videoExtensions",n,i,r),os(t,e,"videoCodecs",n,i,r),os(t,e,"audioExtensions",n,i,r),os(t,e,"audioCodecs",n,i,r),I("RAISE_H264_BASELINE_PRIORITY")){const s=r.videoCodecs.findIndex((o=>o.rtpMap&&o.rtpMap.encodingName.toLocaleLowerCase()==="h264"&&o.fmtp&&o.fmtp.parameters["profile-level-id"]==="42001f"));if(s!==-1){const o=r.videoCodecs.findIndex((a=>a.rtpMap&&a.rtpMap.encodingName.toLocaleLowerCase()==="h264"));if(o<s){m.debug("raising H264 baseline profile priority");const a=r.videoCodecs[s];r.videoCodecs.splice(s,1),r.videoCodecs.splice(o,0,a)}o!==-1&&(i.videoCodecs=i.videoCodecs.filter((a=>!(a.rtpMap&&a.rtpMap.encodingName.toLocaleLowerCase()==="h264"&&a.fmtp&&a.fmtp.parameters["profile-level-id"]!=="42001f"))))}}return{send:n,recv:i,sendrecv:r}}function os(t,e,n,i,r,s){if(n==="videoExtensions"||n==="audioExtensions"){const o=[];return t[n].forEach((a=>{e[n].some(((c,d)=>{if(a.entry===c.entry&&a.extensionName===c.extensionName)return o.push(d),!0}))?s[n].push(a):i[n].push(a)})),void e[n].forEach(((a,c)=>{o.indexOf(c)===-1&&r[n].push(a)}))}if(n==="videoCodecs"||n==="audioCodecs"){const o=[];return t[n].forEach((a=>{e[n].some(((c,d)=>{if(a.payloadType===c.payloadType&&JSON.stringify(a)===JSON.stringify(c))return o.push(d),!0}))?s[n].push(a):i[n].push(a)})),void e[n].forEach(((a,c)=>{o.indexOf(c)===-1&&r[n].push(a)}))}}function gu(t){const{send:e,recv:n,sendrecv:i}=t;if(!i){if(!e||!n)throw new Error("cannot merge rtp capabilities because one of send or recv is empty!");return{send:e,recv:n}}let r,s;return e?(r={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},r.audioCodecs=[...e.audioCodecs,...i.audioCodecs],r.videoCodecs=[...e.videoCodecs,...i.videoCodecs],r.audioExtensions=[...e.audioExtensions,...i.audioExtensions],r.videoExtensions=[...e.videoExtensions,...i.videoExtensions]):r=Ve(i),n?(s={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},s.audioCodecs=[...n.audioCodecs,...i.audioCodecs],s.videoCodecs=[...n.videoCodecs,...i.videoCodecs],s.audioExtensions=[...n.audioExtensions,...i.audioExtensions],s.videoExtensions=[...n.videoExtensions,...i.videoExtensions]):s=Ve(i),{send:r,recv:s}}function Gd(t){t.media.mediaType==="audio"&&t.attributes.payloads.filter((e=>{var n;return((n=e.rtpMap)===null||n===void 0?void 0:n.encodingName.toLowerCase())==="opus"})).forEach((e=>{e.fmtp||(e.fmtp={parameters:{}}),e.fmtp.parameters.stereo="1",e.fmtp.parameters["sprop-stereo"]="1"}))}function Su(t,e,n,i){let r=[];if(t===ut.VIDEO){if(I("H264_PROFILE_LEVEL_ID")&&i==="h264"&&(r=e.videoCodecs.filter((s=>{var o;return $(o=s.rtpMap&&s.rtpMap.encodingName.toLowerCase()||"").call(o,i)&&s&&s.fmtp&&s.fmtp.parameters["profile-level-id"]===I("H264_PROFILE_LEVEL_ID")}))),!Array.isArray(r)||r.length===0){let s=[];const o=[],a=[],c=[];if(n.videoCodecs.forEach((d=>{const l=d.rtpMap&&d.rtpMap.encodingName.toLowerCase()||"";$(l).call(l,i)?s.push(d):$(l).call(l,"vp9")?o.push(d):$(l).call(l,"vp8")?a.push(d):$(l).call(l,"h264")&&c.push(d)})),s.length===0){let d="";o.length!==0?(s=o,d="vp9"):a.length!==0?(s=a,d="vp8"):c.length!==0&&(s=c,d="h264"),m.warning("codec ".concat(i," not included in rtpCapabilities, fallback to default payloads: ").concat(d))}s.length!==0&&(r=e.videoCodecs.filter((d=>s.some((l=>l.payloadType===d.payloadType)))))}if(r.length===0&&(m.warning("codec ".concat(i," not included in rtpCapabilities, fallback to default payloads: ").concat(e.videoCodecs[0].rtpMap&&e.videoCodecs[0].rtpMap.encodingName)),r=e.videoCodecs),I("USE_PUB_RTX")||I("USE_SUB_RTX")){const s=pa(r,e.videoCodecs);r=[...r,...s]}}else{r=e.audioCodecs.filter((o=>{var a;return $(a=o.rtpMap&&o.rtpMap.encodingName.toLowerCase()||"").call(a,i)}));const s=e.audioCodecs.filter((o=>{var a;return $(a=o.rtpMap&&o.rtpMap.encodingName.toLowerCase()||"").call(a,"red")}));r.length===0&&(m.warning("codec ".concat(i," not included in rtpCapabilities, fallback to opus")),r=e.audioCodecs.filter((o=>{var a;return $(a=o.rtpMap&&o.rtpMap.encodingName.toLowerCase()||"").call(a,"opus")}))),I("ENABLE_AUDIO_RED")&&s.length!==0&&(r=[...s,...r])}return r}function pa(t,e){const n=t.map((i=>i.payloadType.toString()));return e.filter((i=>i.rtpMap&&i.rtpMap.encodingName==="rtx"&&i.fmtp&&i.fmtp.parameters.apt&&$(n).call(n,i.fmtp&&i.fmtp.parameters.apt)))}async function Ui(t,e,n){const i=e.toString(),r=rP(i,"offer","remote","exchangeSDP");await t.setRemoteDescription({type:"offer",sdp:i});const s=await t.createAnswer();if(!s.sdp)throw new Error("cannot get answer sdp");let o=s.sdp;o=sT(o,n||{}),r?.(o||""),await t.setLocalDescription({type:"answer",sdp:o})}function sT(t,e,n){const i=Ei(t),{useXR:r}=e;return i.mediaDescriptions.forEach((s=>{var o;s.attributes.mid&&(Array.isArray(n)&&!$(n).call(n,s.attributes.mid)||(s.media.mediaType==="audio"&&Gd(s),s.media.mediaType==="video"&&(function(a){a.media.mediaType==="video"&&I("ENABLE_DOWN_SPS_PPS")&&a.attributes.payloads.filter((c=>{var d;return((d=c.rtpMap)===null||d===void 0?void 0:d.encodingName.toLowerCase())==="h264"})).forEach((c=>{c.fmtp||(c.fmtp={parameters:{}}),c.fmtp.parameters["sps-pps-idr-in-keyframe"]="1"}))})(s),r&&$(o=["audio","video"]).call(o,s.media.mediaType)&&s.attributes.payloads.forEach((a=>{a.rtcpFeedbacks.findIndex((c=>c.type==="rrtr"))===-1&&a.rtcpFeedbacks.push({type:"rrtr"})}))))})),Oo(i)}function rP(t,e,n,i){if(I("SDP_LOGGING"))return m.upload("exchanging ".concat(n," ").concat(e," SDP during P2PConnection.").concat(i,`
`),t),e==="offer"?r=>{rP(r,"answer",n==="local"?"remote":"local",i)}:void 0}async function sP(t,e,n){try{var i;if(!Jt().supportSetRtpSenderParameters||!(function(c){return c==="vp9"||c==="av1"})(t)||!I("ENABLE_SVC"))return;const r={},s={},o=e.getParameters(),a=(i=o.encodings)===null||i===void 0?void 0:i[0];s.scalabilityMode=fu(n),a&&Object.assign(a,s),Object.assign(o,r),await e.setParameters(o),m.debug("[updateAdaptation] updateRtpSenderEncodings scalabilityMode success: ".concat(JSON.stringify(o.encodings)))}catch(r){m.debug("[updateAdaptation] updateRtpSenderEncodings scalabilityMode failed",r)}}function w_(t){const e=I("COMPATIBLE_SDP_EXTENSION");return!!(Array.isArray(e)&&e.length>0)&&e.some((n=>$(t).call(t,n)))}function oP(t,e){try{var n;return((n=t.fmtp)===null||n===void 0?void 0:n.parameters.apt)===e.payloadType.toString()}catch{return!1}}function aP(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable}))),n.push.apply(n,i)}return n}function Zi(t,e){return typeof I(t)===e?I(t):void 0}function AY(){try{const t=I("EXPERIMENTS")||{};return typeof t=="string"||Array.isArray(t)?{}:(function(e){for(var n=1;n<arguments.length;n++){var i=arguments[n]!=null?arguments[n]:{};n%2?aP(Object(i),!0).forEach((function(r){R(e,r,i[r])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):aP(Object(i)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(i,r))}))}return e})({},t)}catch(t){return m.debug("handle gateway attributes failed: ",t),{}}}const cP={};function io(t){(!(arguments.length>1&&arguments[1]!==void 0)||arguments[1])&&m.debug("install service ".concat(t.name)),cP[t.name]=t}function bs(t){const e=cP[t];if(!e)throw new H(A.INVALID_OPERATION,"".concat(t," not found, please use AgoraRTC.use(").concat(t,"Service) to load it first"));return e}function dP(t,e){return bs("DataStream").create(t,e)}function O_(){return bs("InterceptFrame").create()}function lP(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable}))),n.push.apply(n,i)}return n}function Fn(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?lP(Object(n),!0).forEach((function(i){R(t,i,n[i])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):lP(Object(n)).forEach((function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i))}))}return t}const oT=new Map;class wY extends qe{get state(){return this._state}set state(e){if(e===this._state)return;const n=this._state;this._state=e,e==="DISCONNECTED"&&this._disconnectedReason?this.emit(an.CONNECTION_STATE_CHANGE,e,n,this._disconnectedReason):this.emit(an.CONNECTION_STATE_CHANGE,e,n)}get joinGatewayStartTime(){return this._joinGatewayStartTime}set joinGatewayStartTime(e){m.debug("[".concat(this.store.clientId,"] set joinGatewayStartTime at ").concat(e)),this._joinGatewayStartTime=e}constructor(e,n){var i,r,s;super(),R(this,"store",void 0),R(this,"joinInfo",void 0),R(this,"key",void 0),R(this,"ntpOffset",0),R(this,"usingProxy",!1),R(this,"signal",void 0),R(this,"role",void 0),R(this,"isPreallocation",void 0),R(this,"isPreSub",void 0),R(this,"inChannelInfo",{joinAt:null,duration:0}),R(this,"spec",void 0),R(this,"_state","DISCONNECTED"),R(this,"_statsCollector",void 0),R(this,"_disconnectedReason",void 0),R(this,"isSignalRecover",!1),R(this,"hasChangeBGPAddress",!1),R(this,"trafficStatsInterval",void 0),R(this,"networkQualityInterval",void 0),R(this,"_joinGatewayStartTime",0),R(this,"_signalTimeout",!1),R(this,"_clientRoleOptions",void 0),R(this,"_isProactiveJoin",!1),this.store=e,this.spec=n,this.signal=this.store.useP2P?(i={spec:Fn(Fn({},n),{},{retryConfig:n.websocketRetryConfig}),store:e},(r=(s=bs("P2PChannel")).createSubmodule)===null||r===void 0?void 0:r.call(s,i)):this.store.useDcSignal?(function(o){return bs("DataChannelSignal").create(o)})({spec:Fn(Fn({},n),{},{retryConfig:n.websocketRetryConfig}),store:e}):new GD(Fn(Fn({},n),{},{retryConfig:n.websocketRetryConfig}),e),this._statsCollector=n.statsCollector,this.role=n.role||"audience",this._clientRoleOptions=n.clientRoleOptions,this.handleSignalEvents()}setUsingProxy(e){this.usingProxy=e}async join(e,n,i){if(this.store.useDcSignal){let l=!1;e.cloudProxyServer!=="disabled"?(m.debug("[".concat(this.store.clientId,"] Dc is not supported, because cloudProxyServer are not supported (").concat(e.cloudProxyServer,")")),l=!0):"".concat(e.apResponse.cid,"_").concat(e.apResponse.cert).length>255||"".concat(e.apResponse.cid,"_").concat(e.apResponse.cert).length<22?(m.debug("[".concat(this.store.clientId,"] Dc is not supported, because ticket length is incorrect, it has to be between 22 and 255")),l=!0):e.apResponse.addresses.some((h=>h.fingerprint))||I("FINGERPRINT")||(m.debug("[".concat(this.store.clientId,"] Dc is not supported, because fingerprint does not exist")),l=!0),l&&this.resetSignal()}this.store.joinGatewayStart(),e.cloudProxyServer!=="disabled"&&(this.hasChangeBGPAddress=!0);const r=Date.now();let s=oT.get(e.cname);if(s||(s=new Map,oT.set(e.cname,s)),this._isProactiveJoin=!0,s.has(e.uid)){const l=new B(A.UID_CONFLICT);throw pt.joinGateway(e.sid,{lts:r,succ:!1,ec:l.code,addr:null,uid:e.uid,cid:e.cid,firstSuccess:this._isProactiveJoin,isProxy:!!e.proxyServer||this.usingProxy,signalChannel:this.store.useDcSignal?"1":"0",preload:e.preload}),l}s.set(e.uid,!0),this.joinInfo=e,this.key=n;let o=0;this.joinGatewayStartTime=r;const a=e.proxyServer,c=this.store.useDcSignal?"datachannel":"websocket";try{m.debug("[".concat(this.store.clientId,"] use ").concat(c," join uid ").concat(o));const l=e.gatewayAddrs.map((p=>{let{address:f}=p;const[v,S]=f.split(":"),T={host:v,port:S};return e.proxyServer&&(T.proxy=e.proxyServer),T}));let h;h=this.store.useDcSignal?await this.signal.init(e.apResponse.addresses):await this.signal.init(l),o=h.uid,m.debug("[".concat(this.store.clientId,"] ").concat(c," join uid ").concat(o," cost ").concat(Date.now()-this.joinGatewayStartTime))}catch(l){var d;throw l.code===A.INIT_DATACHANNEL_TIMEOUT&&this.signal.__name__==="AgoraRTCSignal"||pt.joinGateway(e.sid,{lts:r,succ:!1,ec:((d=l.data)===null||d===void 0?void 0:d.desc)||l.code,errorMsg:l.message,addr:this.signal.url,uid:e.uid,cid:e.cid,firstSuccess:this._isProactiveJoin,isProxy:!!a||this.usingProxy,signalChannel:this.signal.__name__==="DataChannelSignal"?"1":"0",preload:e.preload}),l&&l.code===A.INIT_DATACHANNEL_TIMEOUT?(m.warning("[".concat(this.store.clientId,"] User join datachannel failed"),l.toString()),this.resetSignal(),l):(m.error("[".concat(this.store.clientId,"] User join failed"),l.toString()),s.delete(e.uid),this.signal.close(),l)}return this.state="CONNECTED",this.inChannelInfo.joinAt=Date.now(),m.debug("[".concat(this.store.clientId,"] Connected to gateway server")),this.trafficStatsInterval=window.setInterval((()=>{this.updateTrafficStats().catch((l=>{m.warning("[".concat(this.store.clientId,"] get traffic stats error"),l.toString())}))}),3e3),this.networkQualityInterval=window.setInterval((()=>{navigator&&navigator.onLine!==void 0&&!navigator.onLine?this.emit(an.NETWORK_QUALITY,{downlinkNetworkQuality:6,uplinkNetworkQuality:6}):this._signalTimeout?this.emit(an.NETWORK_QUALITY,{downlinkNetworkQuality:5,uplinkNetworkQuality:5}):this.state==="CONNECTED"&&this._statsCollector.trafficStats?this.emit(an.NETWORK_QUALITY,{uplinkNetworkQuality:y_(this._statsCollector.trafficStats.B_unq),downlinkNetworkQuality:y_(this._statsCollector.trafficStats.B_dnq)}):this.emit(an.NETWORK_QUALITY,{uplinkNetworkQuality:0,downlinkNetworkQuality:0})}),2e3),this.store.joinGatewayEnd(),o}async leave(){let e=arguments.length>0&&arguments[0]!==void 0&&arguments[0],n=arguments.length>1?arguments[1]:void 0;if(this.state!=="DISCONNECTED"){n!==te.FALLBACK&&(this.state="DISCONNECTING");try{e||this.signal.connectionState!==ee.CONNECTED||await(function(i,r){return r===1/0?i:st.race([i,e8(r)])})(this.signal.request(Tt.LEAVE,void 0,!0),3e3)}catch(i){m.warning("[".concat(this.store.clientId,"] leave request failed, ignore"),i)}this.signal.close(n),n!==te.FALLBACK&&(this.state="DISCONNECTED"),this.reset()}}async publish(e,n,i){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new B(A.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));const r={state:"offer",p2p_id:this.store.p2pId,ortc:n,mode:this.spec.mode,extend:I("PUB_EXTEND"),twcc:!!I("PUBLISH_TWCC"),rtx:!!I("USE_PUB_RTX")};try{return(await this.signal.request(Tt.PUBLISH,r,!0))._message}catch(s){if(i&&s.data&&s.data.code===yt.ERR_PUBLISH_REQUEST_INVALID)return m.warning("[".concat(this.store.clientId,"] receive publish error code, retry"),s.toString()),await this.tryUnpubBeforeRepub(e,n),this.publish(e,n,!1);throw s}}async publishDataChannel(e,n,i){var r;if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new B(A.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));const s={stream_id:n.streamId,ordered:n.ordered?1:0,max_retrans_times:(r=n.maxRetransmits)!==null&&r!==void 0?r:10,channel_id:n.channelId,metadata:n.metadata};try{await this.signal.request(Tt.PUBLISH_DATASTREAM,s,!0)}catch(o){if(i&&o.data&&o.data.code===yt.ERR_PUBLISH_REQUEST_INVALID)return m.warning("[".concat(this.store.clientId,"] receive publish datachannels error code, retry"),o.toString()),await this.tryUnpubDataChannelBeforeRepub(e,n),this.publishDataChannel(e,n,!1);throw o}}async unpublish(e,n){try{if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new B(A.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));await this.signal.request(Tt.UNPUBLISH,{stream_id:n,ortc:e},!0)}catch(i){m.warning("[".concat(this.store.clientId,"] unpublish warning: "),i)}}async unpublishDataChannel(e){try{if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new B(A.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));await st.all(e.map((n=>this.signal.request(Tt.UNPUBLISH_DATASTREAM,{channel_id:n},!0))))}catch(n){m.warning("unpublish datachannels warning: ",n)}}async presubscribe(e,n,i){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new B(A.INVALID_OPERATION,"can not presubscribe when connection state is ".concat(this.state));const r={stream_id:e,stream_type:n,mode:this.spec.mode,codec:this.spec.codec,p2p_id:this.store.p2pId,twcc:!!I("SUBSCRIBE_TWCC"),rtx:!!I("USE_SUB_RTX")||void 0,extend:I("SUB_EXTEND"),svc:Array.isArray(I("SVC"))&&I("SVC").length!==0?I("SVC"):void 0};try{return await this.signal.request(Tt.PRE_SUBSCRIBE,r,!0)}catch(s){if(i&&s.data&&s.data.code===yt.ERR_SUBSCRIBE_REQUEST_INVALID)return m.warning("[".concat(this.store.clientId,"] pre-subscribe error, retry"),s.toString()),this.presubscribe(e,n,!1);throw s}}async subscribe(e,n,i){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new B(A.INVALID_OPERATION,"can not subscribe when connection state is ".concat(this.state));const r={stream_id:e,stream_type:n.stream_type,mode:this.spec.mode,codec:this.spec.codec,p2p_id:this.store.p2pId,twcc:!!I("SUBSCRIBE_TWCC"),rtx:!!I("USE_SUB_RTX"),extend:I("SUB_EXTEND"),ssrcId:n.ssrcId,svc:Array.isArray(I("SVC"))&&I("SVC").length!==0?I("SVC"):void 0};try{return(await this.signal.request(Tt.SUBSCRIBE,r,!0))._message}catch(s){if(i&&s.data&&s.data.code===yt.ERR_SUBSCRIBE_REQUEST_INVALID)return m.warning("[".concat(this.store.clientId,"] receiver subscribe error code, retry"),s.toString()),await this.tryUnsubBeforeResub(e,n),await this.subscribe(e,n,!1);throw s}}async subscribeDataChannel(e,n,i){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new B(A.INVALID_OPERATION,"can not subscribe datachannel when connection state is ".concat(this.state));const r={uid:e,stream_id:n.id,channel_id:n.datachannelId};try{return void await this.signal.request(Tt.SUBSCRIBE_DATASTREAM,r,!0)}catch(s){if(i&&s.data&&s.data.code===yt.ERR_SUBSCRIBE_REQUEST_INVALID)return m.warning("[".concat(this.store.clientId,"] receiver subscribe datachannel error code, retry"),s.toString()),await this.tryUnsubDataChannelBeforeResub(e,n),await this.subscribeDataChannel(e,n,!1);throw s}}async subscribeAll(e,n){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new B(A.INVALID_OPERATION,"can not massSubscribe when connection state is ".concat(this.state));const i={p2p_id:this.store.p2pId,users:e,dtx:!1,rtx:!!I("USE_SUB_RTX"),twcc:!!I("SUBSCRIBE_TWCC"),svc:Array.isArray(I("SVC"))&&I("SVC").length!==0?I("SVC"):void 0};try{return await this.signal.request(Tt.SUBSCRIBE_STREAMS,i,!0)}catch(r){if(n&&r.data&&r.data.code===yt.ERR_SUBSCRIBE_REQUEST_INVALID)return m.warning("[".concat(this.store.clientId,"] receiver massSubscribe error code, retry"),r.toString()),await this.tryMassUnsubBeforeResub(e),await this.subscribeAll(e,!1);throw r}}async setVideoProfile(e){const n=(function(i){if(!(i.bitrateMax&&i.bitrateMin&&i.frameRate&&i.height&&i.width))return;let r=i.frameRate,s=i.width,o=i.height,a=!0;return typeof r!="number"&&(r=r.exact||r.ideal||r.max||r.min||0,r||(a=!1)),typeof s!="number"&&(s=s.exact||s.ideal||s.max||s.min||0,s||(a=!1)),typeof o!="number"&&(o=o.exact||o.ideal||o.max||o.min||0,r||(a=!1)),a?{stream_type:0,width:s,height:o,fps:r,start_bps:1e3*i.bitrateMax,min_bps:1e3*i.bitrateMin,target_bps:1e3*i.bitrateMax}:void 0})(e);if(n)return this.signal.request(Tt.SET_VIDEO_PROFILE,n);m.debug("[".concat(this.store.clientId,"] encoder config is not complete, do not report to gateway"))}async unsubscribe(e,n){try{await this.signal.request(Tt.UNSUBSCRIBE,{p2p_id:this.store.p2pId,ortc:e,stream_id:n},!0)}catch(i){m.warning("[".concat(this.store.clientId,"] unsubscribe warning: "),i)}}async unsubscribeDataChannel(e,n){try{if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new B(A.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));await st.all(e.map((i=>this.signal.request(Tt.UNSUBSCRIBE_DATASTREAM,{stream_id:i,uid:n},!0))))}catch(i){m.warning("unsubscribeDataChannel warning: ",i)}}async massUnsubscribe(e){try{await this.signal.request(Tt.UNSUBSCRIBE_STREAMS,e,!0)}catch(n){m.warning("[".concat(this.store.clientId,"] massUnsubscribeAll warning: "),n)}}async reconnectPC(e){const{iceParameters:n,dtlsParameters:i,rtpCapabilities:r}=e;return{gatewayEstablishParams:await this.signal.request(Tt.CONNECT_PC,{p2p_id:this.store.p2pId,stream_id:this.store.uid,ortc:{iceParameters:n,dtlsParameters:i,rtpCapabilities:r}},!0),gatewayAddress:this.getCurrentGatewayAddress()}}getGatewayInfo(){return this.signal.request(Tt.GATEWAY_INFO)}async renewToken(e){await this.signal.request(Tt.RENEW_TOKEN,e),this.key=e.token}updateClientRole(e,n){n&&(this._clientRoleOptions=Object.assign({},n)),I("CLIENT_ROLE_OPTIONS")&&(m.debug("[".concat(this.store.clientId,"] Set roleOptions for ").concat(JSON.stringify(I("CLIENT_ROLE_OPTIONS"))," instead of ").concat(JSON.stringify(this._clientRoleOptions)," ")),this._clientRoleOptions=Object.assign({},I("CLIENT_ROLE_OPTIONS"))),this.role=e}async setClientRole(e,n){if(n&&(this._clientRoleOptions=Object.assign({},n)),I("CLIENT_ROLE_OPTIONS")&&(this._clientRoleOptions=Object.assign({},I("CLIENT_ROLE_OPTIONS")),m.debug("[".concat(this.store.clientId,"] Set roleOptions for ").concat(JSON.stringify(I("CLIENT_ROLE_OPTIONS"))," instead of ").concat(JSON.stringify(this._clientRoleOptions)," "))),this.state!=="CONNECTED")return void(this.role=e);let i,r=0;e==="audience"?this._clientRoleOptions&&this._clientRoleOptions.delay?(i=this._clientRoleOptions.delay,r=1):r=this._clientRoleOptions&&this._clientRoleOptions.level?this._clientRoleOptions.level:2:r=0;const s=Object.assign({},n);delete s.delay,delete s.level,await this.signal.request(Tt.SET_CLIENT_ROLE,Fn(Fn({role:e,level:r,delay:i},s),{},{client_ts:Date.now()})),this.role=e}async setDualStreamMode(e,n,i){await this.signal.request(Tt.SET_DUAL_STREAM_MODE,{mode:e},i,n)}async setRemoteVideoStreamType(e,n){await this.signal.request(Tt.SWITCH_VIDEO_STREAM,{stream_id:e,stream_type:n})}async setDefaultRemoteVideoStreamType(e){await this.signal.request(Tt.DEFAULT_VIDEO_STREAM,{stream_type:e})}async setStreamFallbackOption(e,n){await this.signal.request(Tt.SET_FALLBACK_OPTION,{stream_id:e,fallback_type:n})}async pickSVCLayer(e,n){await this.signal.request(Tt.PICK_SVC_LAYER,{stream_id:e,spatial_layer:n.spatialLayer,temporal_layer:n.temporalLayer})}async setRTM2Flag(e){await this.signal.request(Tt.SET_RTM2_FLAG,{rtm2_flag:e})}async sendExtensionMessage(e,n,i){if(this.store.useP2P)return this.signal.sendExtensionMessage(e,n,i)}getInChannelInfo(){return this.inChannelInfo.joinAt&&(this.inChannelInfo.duration=Date.now()-this.inChannelInfo.joinAt),Fn({},this.inChannelInfo)}async setConfigure(e){if(e&&Array.isArray(e)&&e.length!==0)return this.signal.request(Tt.CONFIGURE,e)}async getGatewayVersion(){return(await this.signal.request(Tt.GATEWAY_INFO)).version}reset(){if(this.inChannelInfo.joinAt&&(this.inChannelInfo.duration=Date.now()-this.inChannelInfo.joinAt,this.inChannelInfo.joinAt=null),this.trafficStatsInterval&&(window.clearInterval(this.trafficStatsInterval),this.trafficStatsInterval=void 0),this.joinInfo){const e=oT.get(this.joinInfo.cname);e&&e.delete(this.joinInfo.uid)}this.joinInfo=void 0,this.key=void 0,this.networkQualityInterval&&(window.clearInterval(this.networkQualityInterval),this.networkQualityInterval=void 0),this.usingProxy=!1}updateTurnConfigFromSignal(){if(!this.joinInfo)return;const e=(function(n){let i;return i=n.startsWith("dc")?n.match(/(dc\:\/\/)?([^:]+):(\d+)/):n.match(/(wss\:\/\/)?([^:]+):(\d+)/),i?{username:Jn.username,password:Jn.password,turnServerURL:i[2],tcpport:parseInt(i[3])+30,udpport:parseInt(i[3])+30,forceturn:!1}:null})((this.joinInfo.cloudProxyServer==="disabled"?this.signal.url:this.joinInfo.gatewayAddrs[this.signal.currentURLIndex].address)||"");this.joinInfo.turnServer.serversFromGateway=[],e&&this.joinInfo.turnServer.mode!=="off"&&this.joinInfo.cloudProxyServer==="disabled"&&this.joinInfo.turnServer.serversFromGateway.push(Fn(Fn({},Jn),{},{turnServerURL:e.turnServerURL,tcpport:e.tcpport,udpport:e.udpport,username:this.joinInfo.uid.toString(),password:this.joinInfo.token}))}async updateTrafficStats(){if(this.state!=="CONNECTED")return;const e=await this.signal.request(Tt.TRAFFIC_STATS,void 0,!0);e.timestamp=Date.now(),e.ntp_offset!=null&&(this.ntpOffset=e.ntp_offset),e.peer_delay.forEach((n=>{const i=this._statsCollector.trafficStats&&this._statsCollector.trafficStats.peer_delay.find((r=>r.peer_uid===n.peer_uid));i&&i.B_st!==n.B_st&&Hp((()=>{this.emit(an.STREAM_TYPE_CHANGE,n.peer_uid,n.B_st)}))})),this._statsCollector.updateTrafficStats(e)}getJoinMessage(e){var n,i,r,s;if(!this.joinInfo||!this.key)throw new B(A.UNEXPECTED_ERROR,"can not generate join message, no join info");const o=Object.assign({},this.joinInfo.apResponse);let a=I("REPORT_APP_SCENARIO");if(typeof a!="string")try{a=JSON.stringify(a)}catch{a=void 0}var c;a&&a.length>128&&(a=void 0),this.store.hasStartJoinChannel=!0,this.store.isABTestSuccess||this.emit(an.UPDATE_GATEWAY_CONFIG),c=this.store.clientId,$(Ud).call(Ud,c)||Ud.push(c);const d=du(this.store),l=!((n=this.isPreallocation)===null||n===void 0||!n.call(this)),h=l0(this.store),p=AY(),f=Xs(87)||mO()||Wg(117),v=((function(){const w=de();if(w.name!==he.SAFARI||!w.browserVersion)return!1;const D=w.browserVersion.split(".");return Number(D[0])>18||Number(D[0])===18&&Number(D[1])>=4})()||TO(18,4,!1))&&Hg(18,6,!0)&&this.spec.codec==="h264"&&I("ENABLE_ABSSENDTIME_AS_SENTTS"),S=!(((i=o.detail)===null||i===void 0?void 0:i[3])!=="CN"||!I("ENABLE_QUALITY_FALLBACK"))&&I("ENABLE_QUALITY_FALLBACK"),T=!!I("ENABLE_AP_MULTI_IP")&&((r=o.detail)===null||r===void 0?void 0:r[5])==="multi-ip",b=Fn({license:this.joinInfo.license,p2p_id:this.store.p2pId,session_id:this.joinInfo.sid,app_id:this.joinInfo.appId,channel_key:this.key,channel_name:this.joinInfo.cname,sdk_version:Ar,browser:navigator.userAgent,process_id:I("PROCESS_ID"),mode:this.store.useP2P?"p2p":this.spec.mode,codec:this.spec.codec,role:this.role,has_changed_gateway:T||this.hasChangeBGPAddress,ap_response:o,extend:I("JOIN_EXTEND"),details:{6:this.joinInfo.stringUid,cservice_map:this.joinInfo.cloudProxyServer==="proxy3"?"1":this.joinInfo.cloudProxyServer==="proxy5"?"2":void 0},features:{rejoin:!0},optionalInfo:this.joinInfo.optionalInfo,appScenario:a,attributes:{userAttributes:Fn(Fn({enableEncodedTransform:(!!I("ENABLE_AUDIO_METADATA")||!!I("ENABLE_AUDIO_PTS"))&&f||!!I("ENABLE_AUDIO_TOPN")&&Gg(he.CHROME,87,116)||void 0,enableAudioMetadata:!!I("ENABLE_AUDIO_METADATA")&&f,enableAudioPts:!!I("ENABLE_AUDIO_PTS")&&f,topnSmoothLevel:I("TOPN_SMOOTH_LEVEL"),topnNewSpeakerDelay:I("TOPN_NEW_SPEAKER_DELAY"),topnSwitchHoldMs:I("TOPN_SWITCH_HOLD_MS"),topnAudioGain:I("TOPN_AUDIO_GAIN"),enableNetworkQualityProbe:this.store.networkQualityProbe,enablePublishedUserList:I("ENABLE_PUBLISHED_USER_LIST"),maxSubscription:I("MAX_SUBSCRIPTION"),subscribeAudioFilterTopN:Zi("SUBSCRIBE_AUDIO_FILTER_TOPN","number"),enablePublishAudioFilter:Zi("ENABLE_PUBLISH_AUDIO_FILTER","boolean"),enableUserLicenseCheck:Zi("ENABLE_USER_LICENSE_CHECK","boolean"),enableRTX:I("USE_PUB_RTX")===!0||I("USE_SUB_RTX")===!0||void 0,disableFEC:I("DISABLE_FEC"),enableNTPReport:!!I("ENABLE_NTP_REPORT")||void 0,enableInstantVideo:h,enableFulllinkAvSync:!!I("ENABLE_FULL_LINK_AV_SYNC")||void 0,enableDataStream2:Zi("ENABLE_DATASTREAM_2","boolean"),enableAutFeedback:!!I("FORCE_ENABLE_AUT_CC")||!$p()&&(!!I("ENABLE_AUT_FEEDBACK")||void 0),rtm2Flag:typeof this.joinInfo.rtmFlag=="number"?this.joinInfo.rtmFlag:void 0,enableUserAutoRebalanceCheck:!!I("ENABLE_USER_AUTO_REBALANCE_CHECK"),enableXR:Zi("USE_XR","boolean"),enableLossbasedBwe:Zi("ENABLE_LOSSBASED_BWE","boolean"),enableAutCC:!!I("FORCE_ENABLE_AUT_CC")||!$p()&&(!!I("ENABLE_AUT_CC")||void 0),enableCCFallback:Zi("ENABLE_CC_FALLBACK","boolean"),enablePreallocPC:l,preSubNum:d?Zi("PRE_SUB_NUM","number"):void 0,enablePubTWCC:Zi("PUBLISH_TWCC","boolean"),enableSubTWCC:Zi("SUBSCRIBE_TWCC","boolean"),enablePubRTX:Zi("USE_PUB_RTX","boolean"),enableSubRTX:Zi("USE_SUB_RTX","boolean"),enableSubSVC:I("ENABLE_SVC")?I("ENABLE_SVC_DEFAULT_CODECS"):Array.isArray(I("SVC"))&&I("SVC").length!==0?I("SVC"):void 0,enableSvcExtended:I("ENABLE_SVC")&&Array.isArray(I("SVC_EXTENDED"))&&I("SVC_EXTENDED").length!==0?I("SVC_EXTENDED"):void 0,enableVosFallback:I("ENABLE_VOS_FALLBACK"),enableQualityFallback:S},p),{},{audioDuplicate:Zi("ENABLE_AUDIO_RED","boolean")?(s=Zi("AUDIO_DUPLICATE_NUM","number"))!==null&&s!==void 0?s:2:void 0,senttsUsesAbsSendTime:!!v||void 0,enableDualStreamFlag:Zi("ENABLE_DUAL_STREAM_FLAG","boolean")})},join_ts:this.joinGatewayStartTime},e);return this.joinInfo.stringUid&&(b.string_uid=this.joinInfo.stringUid),this.joinInfo.aesmode&&this.joinInfo.aespassword&&(b.aes_mode=this.joinInfo.aesmode,I("ENCRYPT_AES")?(b.aes_secret=this.joinInfo.aespassword,b.aes_encrypt=!0):b.aes_secret=this.joinInfo.aespassword,this.joinInfo.aessalt&&(b.aes_salt=this.joinInfo.aessalt)),o.addresses[this.signal.websocket.currentURLIndex]&&(b.ap_response.ticket=o.addresses[this.signal.websocket.currentURLIndex].ticket,delete o.addresses),this.joinInfo.defaultVideoStream!==void 0&&(b.default_video_stream=this.joinInfo.defaultVideoStream),b}getRejoinMessage(){if(!this.joinInfo)throw new B(A.UNEXPECTED_ERROR,"can not generate rejoin message, no join info");return{session_id:this.joinInfo.sid,channel_name:this.joinInfo.cname,cid:this.joinInfo.cid,uid:this.joinInfo.uid,vid:Number(this.joinInfo.vid)}}handleSignalEvents(){this.signal.on(ft.WS_RECONNECT_CREATE_CONNECTION,(e=>{this.joinGatewayStartTime=Date.now()})),this.signal.on(ft.WS_RECONNECTING,(e=>{this.joinInfo&&pt.WebSocketQuit(this.joinInfo.sid,{lts:Date.now(),succ:-1,cname:this.joinInfo.cname,uid:this.joinInfo.uid,cid:this.joinInfo.cid,errorCode:e||Xn.NETWORK_ERROR}),this.joinInfo&&(this.state="RECONNECTING",pt.sessionInit(this.joinInfo.sid,{lts:new Date().getTime(),extend:this.isSignalRecover?{recover:!0}:{rejoin:!0},cname:this.joinInfo.cname,appid:this.joinInfo.appId,mode:this.spec.mode,stringUid:this.joinInfo.stringUid,channelProfile:this.spec.mode==="live"?1:0,channelMode:0,lsid:this.joinInfo.sid,clientRole:this.role==="audience"?2:1,buildFormat:1}),this.isSignalRecover=!1,this.joinGatewayStartTime=Date.now())})),this.signal.on(ft.WS_CLOSED,(e=>{let n;switch(e){case te.LEAVE:n=Xn.LEAVE;break;case te.UID_BANNED:case te.IP_BANNED:case te.CHANNEL_BANNED:case te.SERVER_ERROR:n=Xn.SERVER_ERROR;break;case te.FALLBACK:n=Xn.FALLBACK;break;case te.LICENSE_MISSING:case te.LICENSE_EXPIRED:case te.LICENSE_MINUTES_EXCEEDED:case te.LICENSE_PERIOD_INVALID:case te.LICENSE_MULTIPLE_SDK_SERVICE:case te.LICENSE_ILLEGAL:case te.TOKEN_EXPIRE:n=e;break;default:n=Xn.NETWORK_ERROR}m.debug("[".concat(this.store.clientId,"] [signal] websocket closed, reason: ").concat(n||"undefined -> "+Xn.NETWORK_ERROR)),this.joinInfo&&pt.WebSocketQuit(this.joinInfo.sid,{lts:Date.now(),succ:e===te.LEAVE?1:-1,cname:this.joinInfo.cname,uid:this.joinInfo.uid,cid:this.joinInfo.cid,errorCode:n}),this._disconnectedReason=e,e!==te.FALLBACK&&(this.state="DISCONNECTED"),this.reset()})),this.signal.on(ft.WS_CONNECTED,(()=>{if(this.updateTurnConfigFromSignal(),this.state="CONNECTED",this.joinInfo){if(this.role==="audience"){const e=I("CLIENT_ROLE_OPTIONS")||this._clientRoleOptions;e&&(e.level||e.delay)&&(m.debug("[".concat(this.store.clientId,"] patch to send set client role, role: ").concat(this.role,", mode: ").concat(this.spec.mode,", level: ").concat(e.level,", delay: ").concat(e.delay)),this.setClientRole(this.role,e))}if(pt.joinGateway(this.joinInfo.sid,{lts:this.joinGatewayStartTime,succ:!0,ec:null,vid:this.joinInfo.vid,addr:this.signal.url,uid:this.joinInfo.uid,cid:this.joinInfo.cid,firstSuccess:this._isProactiveJoin,isProxy:!!this.joinInfo.proxyServer||this.usingProxy,signalChannel:this.signal.__name__==="DataChannelSignal"?"1":"0",preload:this.joinInfo.preload,isABTestSuccess:this.store.isABTestSuccess}),this._isProactiveJoin=!1,this.joinInfo.useLocalAccessPoint&&this.joinInfo.setLocalAPVersion===1){const e=this.signal.url&&this.signal.url.match(/wss\:\/\/([^:]+):(\d+)/);if(!e)return void m.error("[".concat(this.store.clientId,"] set local access point after joined failed: ").concat(e));ye("EVENT_REPORT_DOMAIN",e[1]),ye("EVENT_REPORT_BACKUP_DOMAIN",e[1]),ye("LOG_UPLOAD_SERVER","".concat(e[1],":6444"))}}})),this.signal.on(Lt.ON_UPLINK_STATS,(e=>{this._statsCollector.updateUplinkStats(e)})),this.signal.on(ft.REQUEST_RECOVER,((e,n,i)=>{if(!this.joinInfo)return i(new B(A.UNEXPECTED_ERROR,"gateway: can not recover, no join info"));e&&(this.joinInfo.multiIP=e,this.hasChangeBGPAddress=!0),this.isSignalRecover=!0,Sn(this,an.REQUEST_NEW_GATEWAY_LIST).then(n).catch(i)})),this.signal.on(ft.REQUEST_JOIN_INFO,(async(e,n,i)=>{var r,s,o;if(this.updateTurnConfigFromSignal(),this.store.useP2P)return void e(this.getJoinMessage({ortc:{}}));const a=Ve((r=this.joinInfo)===null||r===void 0?void 0:r.turnServer);if(I("NEW_TURN_MODE")&&a&&((s=this.joinInfo)===null||s===void 0?void 0:s.cloudProxyServer)==="disabled"){var c;let p=a.servers.map((S=>"turnServerURL"in S&&I("USE_TURN_IP")?Fn(Fn({},S),{},{turnServerURL:C_(S.turnServerURL)}):S)),f=(c=a.serversFromGateway)===null||c===void 0?void 0:c.map((S=>I("USE_TURN_IP")?Fn(Fn({},S),{},{turnServerURL:C_(S.turnServerURL)}):S));const v=this.signal.currentURLIndex;p.length>0&&(p=[p[v%p.length]],a.servers=p),Array.isArray(f)&&f.length>0&&(f=[f[0]],a.serversFromGateway=f),m.debug("[".concat(this.store.clientId,"] use single turn, use turn server index: ").concat(v))}const{iceParameters:d,dtlsParameters:l,rtpCapabilities:h}=await Sn(this,an.REQUEST_P2P_CONNECTION_PARAMS,{turnServer:a,cloudProxyServer:(o=this.joinInfo)===null||o===void 0?void 0:o.cloudProxyServer});try{e(this.getJoinMessage({ortc:{iceParameters:d,dtlsParameters:l,rtpCapabilities:h,version:"2"}}))}catch(p){n(p)}})),this.signal.on(ft.REQUEST_REJOIN_INFO,(e=>{e(this.getRejoinMessage())})),this.signal.on(ft.REPORT_JOIN_GATEWAY,((e,n)=>{if(!this.joinInfo)return;let i,r="";var s;e instanceof B?(i=((s=e.data)===null||s===void 0?void 0:s.desc)||e.code,r=e.message):i=e,pt.joinGateway(this.joinInfo.sid,{lts:this.joinGatewayStartTime,succ:!1,ec:i,errorMsg:r,addr:n,uid:this.joinInfo.uid,cid:this.joinInfo.cid,firstSuccess:this._isProactiveJoin,isProxy:!!this.joinInfo.proxyServer||this.usingProxy,signalChannel:this.signal.__name__==="DataChannelSignal"?"1":"0",preload:this.joinInfo.preload})})),this.signal.on(ft.IS_P2P_DISCONNECTED,(e=>{e(Za(this,an.IS_P2P_DISCONNECTED))})),this.signal.on(ft.DISCONNECT_P2P,(()=>{this.emit(an.DISCONNECT_P2P)})),this.signal.on(ft.REQUEST_SUCCESS,(()=>{this._signalTimeout=!1})),this.signal.on(ft.REQUEST_TIMEOUT,(()=>{this._signalTimeout=!0})),this.signal.on(ft.JOIN_RESPONSE,(e=>{const n=this.getCurrentGatewayAddress();this.emit(an.JOIN_RESPONSE,e,n)})),this.signal.on(ft.PRE_CONNECT_PC,(async(e,n)=>{if(this.joinInfo){var i,r;this.updateTurnConfigFromSignal();const o=this.getCurrentGatewayAddress(),a=Ve((i=this.joinInfo)===null||i===void 0?void 0:i.turnServer);if(I("NEW_TURN_MODE")&&a&&((r=this.joinInfo)===null||r===void 0?void 0:r.cloudProxyServer)==="disabled"){var s;let d=a.servers.map((p=>"turnServerURL"in p&&I("USE_TURN_IP")?Fn(Fn({},p),{},{turnServerURL:C_(p.turnServerURL)}):p)),l=(s=a.serversFromGateway)===null||s===void 0?void 0:s.map((p=>I("USE_TURN_IP")?Fn(Fn({},p),{},{turnServerURL:C_(p.turnServerURL)}):p));const h=this.signal.currentURLIndex;d.length>0&&(d=[d[h%d.length]],a.servers=d),Array.isArray(l)&&l.length>0&&(l=[l[0]],a.serversFromGateway=l),m.debug("[".concat(this.store.clientId,"] use single turn, use turn server index: ").concat(h,",in pre pc"))}const c=I("FINGERPRINT")||this.joinInfo.apResponse.addresses[this.signal.currentURLIndex].fingerprint;if(o&&c){const d=tP(o);Sn(this,an.PRE_CONNECT_PC,{candidates:d,fingerprint:c,turnServer:a}).then((l=>{e?.(l)})).catch(n||(()=>{}))}}})),this.signal.on(ft.RECOVER_NOTIFICATION,(e=>{this.joinInfo&&typeof I("AP_REQUEST_DETAIL")=="string"&&(this.joinInfo.apRequestDetail="".concat(I("AP_REQUEST_DETAIL"),";").concat(e))})),this.signal.on(ft.VOS_FALLBACK,(e=>{this.emit(an.VOS_FALLBACK,e)})),this.signal.on(ft.DATACHANNEL_FAILBACK,(e=>{m.warning("[".concat(this.store.clientId,"] User join datachannel failed")),this.reset(),this.resetSignal(),this.emit(an.DATACHANNEL_FAILBACK)}))}async tryUnsubBeforeResub(e,n){try{await this.signal.request(Tt.UNSUBSCRIBE,{p2p_id:this.store.p2pId,stream_id:e,ortc:[n]},!0)}catch(i){throw m.warning("[".concat(this.store.clientId,"] tryUnsubBeforeResub warning"),i),i}}async tryUnsubDataChannelBeforeResub(e,n){try{await this.signal.request(Tt.UNSUBSCRIBE,{stream_id:n.id},!0)}catch(i){throw m.warning("unsubscribe datachannel warning",i),i}}async tryUnpubBeforeRepub(e,n){try{await this.signal.request(Tt.UNPUBLISH,{stream_id:e,ortc:n},!0)}catch(i){throw m.warning("[".concat(this.store.clientId,"] tryUnpubBeforeRepub warning: "),i),i}}async tryUnpubDataChannelBeforeRepub(e,n){try{await this.signal.request(Tt.UNPUBLISH_DATASTREAM,{channnel_id:n.channelId},!0)}catch(i){throw m.warning("unpublish datastream warning: ",i),i}}async tryMassUnsubBeforeResub(e){const n={users:e.map((i=>({stream_id:i.stream_id,stream_type:i.stream_type})))};try{await this.signal.request(Tt.UNSUBSCRIBE_STREAMS,n,!0)}catch(i){throw m.warning("[".concat(this.store.clientId,"] tryMassUnsubBeforeResub warning"),i),i}}async muteLocal(e,n){const i={action:e.find((r=>r.stream_type===Re.Audio))?"mute_local_audio":"mute_local_video",p2p_id:this.store.p2pId,ortc:e,stream_id:n};try{await this.signal.request(Tt.CONTROL,i,!0,!0)}catch(r){throw m.warning("[".concat(this.store.clientId,"] gateway muteLocal warning: "),r),r}}async unmuteLocal(e,n){const i={action:e.find((r=>r.stream_type===Re.Audio))?"unmute_local_audio":"unmute_local_video",p2p_id:this.store.p2pId,ortc:e,stream_id:n};try{await this.signal.request(Tt.CONTROL,i,!0,!0)}catch(r){throw m.warning("[".concat(this.store.clientId,"] gateway unmuteLocal warning: "),r),r}}async muteRemote(e,n){const i={action:e===ut.AUDIO?"mute_remote_audio":"mute_remote_video",p2p_id:this.store.p2pId,stream_id:n};try{await this.signal.request(Tt.CONTROL,i,!0,!0)}catch(r){throw m.warning("[".concat(this.store.clientId,"] gateway muteRemote warning: "),r),r}}async unmuteRemote(e,n){const i={action:e===ut.AUDIO?"unmute_remote_audio":"unmute_remote_video",p2p_id:this.store.p2pId,stream_id:n};try{await this.signal.request(Tt.CONTROL,i,!0,!0)}catch(r){throw m.warning("[".concat(this.store.clientId,"] gateway unmuteRemote warning: "),r),r}}uploadWRTCStats(e){this.signal.uploadWRTCStats(e)}upload(e,n){this.signal.upload(e,n)}getSignalRTT(){return this.signal.rtt}async restartICE(e){const n={p2p_id:this.store.p2pId,stream_id:this.store.uid,ortc:e};try{return await this.signal.request(Tt.RESTART_ICE,n,!0)}catch(i){throw m.warning("[".concat(this.store.clientId,"] P2PChannel.restartICE warning: "),i),i}}reconnect(e,n){this.state==="CONNECTED"&&this.signal.reconnect(e||void 0,n||Xn.P2P_FAILED)}getCurrentGatewayAddress(){var e,n;if(!I("GATEWAY_WSS_ADDRESS"))return I("USE_CANDIDATE_FROM_AP_DETAIL")&&(e=this.joinInfo)!==null&&e!==void 0&&e.apGatewayAddress?(m.debug("[".concat(this.store.clientId,"] use candidate from ap detail, ").concat(JSON.stringify(this.joinInfo.apGatewayAddress))),this.joinInfo.apGatewayAddress):(n=this.joinInfo)!==null&&n!==void 0&&n.gatewayAddrs?this.joinInfo.gatewayAddrs[this.signal.currentURLIndex]:void 0}async setPublishAudioFilterEnabled(e){await this.signal.request(Tt.SET_PARAMETER,{enablePublishAudioFilter:e})}downgradeCodec(e){this.signal.downgradeCodec(e)}resetSignal(){this.signal&&(this.signal.removeAllListeners(),this.signal.close(te.FALLBACK)),this.store.useDcSignal=!1,this.signal=new GD(Fn(Fn({},this.spec),{},{retryConfig:this.spec.websocketRetryConfig}),this.store),this.handleSignalEvents(),this.emit(an.RESET_SIGNAL)}}let N_=0,aT=0;function As(t,e,n,i){return new st(((r,s)=>{e.timeout=e.timeout||I("HTTP_CONNECT_TIMEOUT"),e.responseType=e.responseType||"json",e.data&&!n?(e.data=JSON.stringify(e.data),N_+=Qs(e.data)):n&&(e.data.size?N_+=e.data.size:e.data instanceof FormData?N_+=BO(e.data):N_+=Qs(JSON.stringify(e.data))),e.headers=e.headers||{},e.headers["Content-Type"]=e.headers["Content-Type"]||"application/json",e.method="POST",e.url=t,yi.request(e).then((o=>{typeof o.data=="string"?aT+=Qs(o.data):o.data instanceof ArrayBuffer||o.data instanceof Uint8Array?aT+=o.data.byteLength:aT+=Qs(JSON.stringify(o.data)),i&&r({data:o.data,headers:o.headers}),r(o.data)})).catch((o=>{yi.isCancel(o)?s(new B(A.OPERATION_ABORTED,"cancel token canceled")):o.code==="ECONNABORTED"?s(new B(A.NETWORK_TIMEOUT,o.message)):o.response?s(new B(A.NETWORK_RESPONSE_ERROR,o.response.status)):s(new B(A.NETWORK_ERROR,o.message))}))}))}(function(){var t;function e(X){var rt=0;return function(){return rt<X.length?{done:!1,value:X[rt++]}:{done:!0}}}var n=typeof Object.defineProperties=="function"?Object.defineProperty:function(X,rt,ht){return X==Array.prototype||X==Object.prototype||(X[rt]=ht.value),X},i,r=(function(X){X=[typeof globalThis=="object"&&globalThis,X,typeof window=="object"&&window,typeof self=="object"&&self,typeof C=="object"&&C];for(var rt=0;rt<X.length;++rt){var ht=X[rt];if(ht&&ht.Math==Math)return ht}throw Error("Cannot find global object")})(this);function s(X,rt){if(rt)t:{var ht=r;X=X.split(".");for(var J=0;J<X.length-1;J++){var g=X[J];if(!(g in ht))break t;ht=ht[g]}(rt=rt(J=ht[X=X[X.length-1]]))!=J&&rt!=null&&n(ht,X,{configurable:!0,writable:!0,value:rt})}}function o(X){return(X={next:X})[Symbol.iterator]=function(){return this},X}function a(X){var rt=typeof Symbol<"u"&&Symbol.iterator&&X[Symbol.iterator];return rt?rt.call(X):{next:e(X)}}if(s("Symbol",(function(X){function rt(g,N){this.A=g,n(this,"description",{configurable:!0,writable:!0,value:N})}if(X)return X;rt.prototype.toString=function(){return this.A};var ht="jscomp_symbol_"+(1e9*Math.random()>>>0)+"_",J=0;return function g(N){if(this instanceof g)throw new TypeError("Symbol is not a constructor");return new rt(ht+(N||"")+"_"+J++,N)}})),s("Symbol.iterator",(function(X){if(X)return X;X=Symbol("Symbol.iterator");for(var rt="Array Int8Array Uint8Array Uint8ClampedArray Int16Array Uint16Array Int32Array Uint32Array Float32Array Float64Array".split(" "),ht=0;ht<rt.length;ht++){var J=r[rt[ht]];typeof J=="function"&&typeof J.prototype[X]!="function"&&n(J.prototype,X,{configurable:!0,writable:!0,value:function(){return o(e(this))}})}return X})),typeof Object.setPrototypeOf=="function")i=Object.setPrototypeOf;else{var c;t:{var d={};try{d.__proto__={a:!0},c=d.a;break t}catch{}c=!1}i=c?function(X,rt){if(X.__proto__=rt,X.__proto__!==rt)throw new TypeError(X+" is not extensible");return X}:null}var l=i;function h(){this.m=!1,this.j=null,this.v=void 0,this.h=1,this.u=this.C=0,this.l=null}function p(X){if(X.m)throw new TypeError("Generator is already running");X.m=!0}function f(X,rt){return X.h=3,{value:rt}}function v(X){this.g=new h,this.G=X}function S(X,rt,ht,J){try{var g=rt.call(X.g.j,ht);if(!(g instanceof Object))throw new TypeError("Iterator result "+g+" is not an object");if(!g.done)return X.g.m=!1,g;var N=g.value}catch(L){return X.g.j=null,X.g.s(L),T(X)}return X.g.j=null,J.call(X.g,N),T(X)}function T(X){for(;X.g.h;)try{var rt=X.G(X.g);if(rt)return X.g.m=!1,{value:rt.value,done:!1}}catch(ht){X.g.v=void 0,X.g.s(ht)}if(X.g.m=!1,X.g.l){if(rt=X.g.l,X.g.l=null,rt.F)throw rt.D;return{value:rt.return,done:!0}}return{value:void 0,done:!0}}function b(X){this.next=function(rt){return X.o(rt)},this.throw=function(rt){return X.s(rt)},this.return=function(rt){return(function(ht,J){p(ht.g);var g=ht.g.j;return g?S(ht,"return"in g?g.return:function(N){return{value:N,done:!0}},J,ht.g.return):(ht.g.return(J),T(ht))})(X,rt)},this[Symbol.iterator]=function(){return this}}function w(X,rt){return rt=new b(new v(rt)),l&&X.prototype&&l(rt,X.prototype),rt}if(h.prototype.o=function(X){this.v=X},h.prototype.s=function(X){this.l={D:X,F:!0},this.h=this.C||this.u},h.prototype.return=function(X){this.l={return:X},this.h=this.u},v.prototype.o=function(X){return p(this.g),this.g.j?S(this,this.g.j.next,X,this.g.o):(this.g.o(X),T(this))},v.prototype.s=function(X){return p(this.g),this.g.j?S(this,this.g.j.throw,X,this.g.o):(this.g.s(X),T(this))},s("Array.prototype.entries",(function(X){return X||function(){return(function(rt,ht){rt instanceof String&&(rt+="");var J=0,g=!1,N={next:function(){if(!g&&J<rt.length){var L=J++;return{value:ht(L,rt[L]),done:!1}}return g=!0,{done:!0,value:void 0}}};return N[Symbol.iterator]=function(){return N},N})(this,(function(rt,ht){return[rt,ht]}))}})),typeof Blob<"u"&&(typeof FormData>"u"||!FormData.prototype.keys)){var D=function(X,rt){for(var ht=0;ht<X.length;ht++)rt(X[ht])},k=function(X){return X.replace(/\r?\n|\r/g,`\r
`)},U=function(X,rt,ht){return rt instanceof Blob?(ht=ht!==void 0?ht+"":typeof rt.name=="string"?rt.name:"blob",rt.name===ht&&Object.prototype.toString.call(rt)!=="[object Blob]"||(rt=new File([rt],ht)),[String(X),rt]):[String(X),String(rt)]},P=function(X,rt){if(X.length<rt)throw new TypeError(rt+" argument required, but only "+X.length+" present.")},x=typeof globalThis=="object"?globalThis:typeof window=="object"?window:typeof self=="object"?self:this,q=x.FormData,Q=x.XMLHttpRequest&&x.XMLHttpRequest.prototype.send,dt=x.Request&&x.fetch,Dt=x.navigator&&x.navigator.sendBeacon,Ot=x.Element&&x.Element.prototype,Wt=x.Symbol&&Symbol.toStringTag;Wt&&(Blob.prototype[Wt]||(Blob.prototype[Wt]="Blob"),"File"in x&&!File.prototype[Wt]&&(File.prototype[Wt]="File"));try{new File([],"")}catch{x.File=function(rt,ht,J){return rt=new Blob(rt,J||{}),Object.defineProperties(rt,{name:{value:ht},lastModified:{value:+(J&&J.lastModified!==void 0?new Date(J.lastModified):new Date)},toString:{value:function(){return"[object File]"}}}),Wt&&Object.defineProperty(rt,Wt,{value:"File"}),rt}}var Vt=function(X){return X.replace(/\n/g,"%0A").replace(/\r/g,"%0D").replace(/"/g,"%22")},pe=function(X){this.i=[];var rt=this;X&&D(X.elements,(function(ht){if(ht.name&&!ht.disabled&&ht.type!=="submit"&&ht.type!=="button"&&!ht.matches("form fieldset[disabled] *"))if(ht.type==="file"){var J=ht.files&&ht.files.length?ht.files:[new File([],"",{type:"application/octet-stream"})];D(J,(function(g){rt.append(ht.name,g)}))}else ht.type==="select-multiple"||ht.type==="select-one"?D(ht.options,(function(g){!g.disabled&&g.selected&&rt.append(ht.name,g.value)})):ht.type==="checkbox"||ht.type==="radio"?ht.checked&&rt.append(ht.name,ht.value):(J=ht.type==="textarea"?k(ht.value):ht.value,rt.append(ht.name,J))}))};if((t=pe.prototype).append=function(X,rt,ht){P(arguments,2),this.i.push(U(X,rt,ht))},t.delete=function(X){P(arguments,1);var rt=[];X=String(X),D(this.i,(function(ht){ht[0]!==X&&rt.push(ht)})),this.i=rt},t.entries=function X(){var rt,ht=this;return w(X,(function(J){if(J.h==1&&(rt=0),J.h!=3)return rt<ht.i.length?J=f(J,ht.i[rt]):(J.h=0,J=void 0),J;rt++,J.h=2}))},t.forEach=function(X,rt){P(arguments,1);for(var ht=a(this),J=ht.next();!J.done;J=ht.next()){var g=a(J.value);J=g.next().value,g=g.next().value,X.call(rt,g,J,this)}},t.get=function(X){P(arguments,1);var rt=this.i;X=String(X);for(var ht=0;ht<rt.length;ht++)if(rt[ht][0]===X)return rt[ht][1];return null},t.getAll=function(X){P(arguments,1);var rt=[];return X=String(X),D(this.i,(function(ht){ht[0]===X&&rt.push(ht[1])})),rt},t.has=function(X){P(arguments,1),X=String(X);for(var rt=0;rt<this.i.length;rt++)if(this.i[rt][0]===X)return!0;return!1},t.keys=function X(){var rt,ht,J,g,N=this;return w(X,(function(L){if(L.h==1&&(rt=a(N),ht=rt.next()),L.h!=3)return ht.done?void(L.h=0):(J=ht.value,g=a(J),f(L,g.next().value));ht=rt.next(),L.h=2}))},t.set=function(X,rt,ht){P(arguments,2),X=String(X);var J=[],g=U(X,rt,ht),N=!0;D(this.i,(function(L){L[0]===X?N&&(N=!J.push(g)):J.push(L)})),N&&J.push(g),this.i=J},t.values=function X(){var rt,ht,J,g,N=this;return w(X,(function(L){if(L.h==1&&(rt=a(N),ht=rt.next()),L.h!=3)return ht.done?void(L.h=0):(J=ht.value,(g=a(J)).next(),f(L,g.next().value));ht=rt.next(),L.h=2}))},pe.prototype._asNative=function(){for(var X=new q,rt=a(this),ht=rt.next();!ht.done;ht=rt.next()){var J=a(ht.value);ht=J.next().value,J=J.next().value,X.append(ht,J)}return X},pe.prototype._blob=function(){var X="----formdata-polyfill-"+Math.random(),rt=[],ht="--"+X+`\r
Content-Disposition: form-data; name="`;return this.forEach((function(J,g){return typeof J=="string"?rt.push(ht+Vt(k(g))+`"\r
\r
`+k(J)+`\r
`):rt.push(ht+Vt(k(g))+'"; filename="'+Vt(J.name)+`"\r
Content-Type: `+(J.type||"application/octet-stream")+`\r
\r
`,J,`\r
`)})),rt.push("--"+X+"--"),new Blob(rt,{type:"multipart/form-data; boundary="+X})},pe.prototype[Symbol.iterator]=function(){return this.entries()},pe.prototype.toString=function(){return"[object FormData]"},Ot&&!Ot.matches&&(Ot.matches=Ot.matchesSelector||Ot.mozMatchesSelector||Ot.msMatchesSelector||Ot.oMatchesSelector||Ot.webkitMatchesSelector||function(X){for(var rt=(X=(this.document||this.ownerDocument).querySelectorAll(X)).length;0<=--rt&&X.item(rt)!==this;);return-1<rt}),Wt&&(pe.prototype[Wt]="FormData"),Q){var He=x.XMLHttpRequest.prototype.setRequestHeader;x.XMLHttpRequest.prototype.setRequestHeader=function(X,rt){He.call(this,X,rt),X.toLowerCase()==="content-type"&&(this.B=!0)},x.XMLHttpRequest.prototype.send=function(X){X instanceof pe?(X=X._blob(),this.B||this.setRequestHeader("Content-Type",X.type),Q.call(this,X)):Q.call(this,X)}}dt&&(x.fetch=function(X,rt){return rt&&rt.body&&rt.body instanceof pe&&(rt.body=rt.body._blob()),dt.call(this,X,rt)}),Dt&&(x.navigator.sendBeacon=function(X,rt){return rt instanceof pe&&(rt=rt._asNative()),Dt.call(this,X,rt)}),x.FormData=pe}})();const Tu=()=>{const t=I("AREAS");return t.length===0&&t.push(fe.GLOBAL),Ir(t).call(t,((e,n,i)=>{const r=uP(n);return r?i===0?r:"".concat(e,",").concat(r):e}),"")},uP=t=>t===fe.OVERSEA?"".concat(ei.ASIA,",").concat(ei.EUROPE,",").concat(ei.AFRICA,",").concat(ei.NORTH_AMERICA,",").concat(ei.SOUTH_AMERICA,",").concat(ei.OCEANIA):ei[t],OY=t=>{const e={CODE:"",WEBCS_DOMAIN:[],WEBCS_DOMAIN_BACKUP_LIST:[],PROXY_CS:[],CDS_AP:[],ACCOUNT_REGISTER:[],UAP_AP:[],EVENT_REPORT_DOMAIN:[],EVENT_REPORT_BACKUP_DOMAIN:[],LOG_UPLOAD_SERVER:[],PROXY_SERVER_TYPE3:[]};return t.map((n=>{const i=T_[n],r=Object.keys(i);r&&r.map((s=>{s!=="CODE"&&(e[s]=e[s].concat(i[s]))}))})),e},D_={GLOBAL:{ASIA:[fe.CHINA,fe.JAPAN,fe.INDIA,fe.KOREA,fe.HKMC],EUROPE:[],NORTH_AMERICA:[fe.US],SOUTH_AMERICA:[],OCEANIA:[],AFRICA:[]}},P_=Object.keys(D_[fe.GLOBAL]),cT=[fe.CHINA,fe.NORTH_AMERICA,fe.EUROPE,fe.ASIA,fe.JAPAN,fe.INDIA,fe.OCEANIA,fe.SOUTH_AMERICA,fe.AFRICA,fe.KOREA,fe.HKMC,fe.US],NY=function(t,e){let n=[];if($(t).call(t,fe.GLOBAL)){const s=[fe.GLOBAL,fe.OVERSEA],o=Object.keys(T_);if(e===fe.GLOBAL)throw new B(A.INVALID_PARAMS,"GLOBAL is an invalid excludedArea value");if(e===fe.CHINA)n=[fe.OVERSEA];else if(r=e,$(P_).call(P_,r)){const a=(i=e,D_[fe.GLOBAL][i]||[]),c=[...s,e,...a];n=o.filter((d=>!$(c).call(c,d)))}else if((function(a){let c=!1;return P_.forEach((d=>{var l;$(l=D_[fe.GLOBAL][d]).call(l,a)&&(c=!0)})),c})(e)){const a=(function(d){let l;return P_.forEach((h=>{var p;$(p=D_[fe.GLOBAL][h]).call(p,d)&&(l=h)})),l})(e),c=[...s,a,e];n=o.filter((d=>!$(c).call(c,d)))}else n=t;n=(function(a){const c=[];return cT.forEach((d=>{$(a).call(a,d)&&c.push(d)})),c.concat(a.filter((d=>!$(cT).call(cT,d))))})(n)}else n=t;var i,r;return n};function hP(t){var e,n;if(!t&&$(e=I("AREAS")).call(e,fe.EXTENSIONS))return m.debug("update area from ap : reset"),void dT(F8,!0);if(!$(n=I("AREAS")).call(n,fe.GLOBAL)||!t)return;let i=T_.EXTENSIONS;i&&(i={CODE:uP(fe.EXTENSIONS),WEBCS_DOMAIN:["ap-web-1-".concat(t,".agora.io")],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-".concat(t,".ap.sd-rtn.com")],PROXY_CS:["proxy-ap-web-".concat(t,".agora.io")],CDS_AP:["cds-ap-web-1-".concat(t,".agora.io"),"cds-ap-web-2-".concat(t,".ap.sd-rtn.com")],ACCOUNT_REGISTER:["sua-ap-web-1-".concat(t,".agora.io"),"sua-ap-web-2-".concat(t,".ap.sd-rtn.com")],UAP_AP:["uap-ap-web-1-".concat(t,".agora.io"),"uap-ap-web-2-".concat(t,".ap.sd-rtn.com")],EVENT_REPORT_DOMAIN:["statscollector-1-".concat(t,".agora.io")],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-".concat(t,".agora.io")],LOG_UPLOAD_SERVER:["logservice-".concat(t,".agora.io")],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy-".concat(t,".agora.io")]},m.debug("update area from ap success: ".concat(t,",config is "),i),ye("AREAS",[fe.EXTENSIONS],!0),Object.keys(i).map((r=>{r==="LOG_UPLOAD_SERVER"||r==="EVENT_REPORT_DOMAIN"||r==="EVENT_REPORT_BACKUP_DOMAIN"||r==="PROXY_SERVER_TYPE3"?ye(r,i[r][0]):ye(r,i[r])})))}function dT(t){let e=arguments.length>1&&arguments[1]!==void 0&&arguments[1];const n=pt.reportApiInvoke(null,{name:Ge.SET_AREA,options:t,tag:Ne.TRACER});try{let i=[];if(typeof t=="string"&&(i=[t]),Array.isArray(t)&&(t.forEach((s=>{if(!$(MD).call(MD,s))throw new B(A.INVALID_PARAMS,"invalid area code")})),i=t),Object.prototype.toString.call(t)==="[object Object]"){const{areaCode:s,excludedArea:o}=t;if(!s)throw new B(A.INVALID_PARAMS,"area code is needed");let a=s;typeof s=="string"&&(a=[s]),i=o?NY(a,o):a}if(!e){if(ur.AREAS){const s=new B(A.PROHIBITED_OPERATION,"setArea is prohibited because of config-distribute");return n.onError(s),void m.warning("setArea is prohibited because of config-distribute")}if($(i).call(i,fe.GLOBAL)&&I("AREAS")===fe.EXTENSIONS){const s=new B(A.PROHIBITED_OPERATION,"setArea is prohibited because of ap extensions");return n.onError(s),void m.warning("setArea is prohibited because of ap extensions")}}ye("AREAS",i,e);const r=OY(i);Object.keys(r).map((s=>{s==="LOG_UPLOAD_SERVER"||s==="EVENT_REPORT_DOMAIN"||s==="EVENT_REPORT_BACKUP_DOMAIN"||s==="PROXY_SERVER_TYPE3"?ye(s,r[s][0]):ye(s,r[s])})),m.debug("set area success:",i.join(","))}catch(i){throw n.onError(i),i}n.onSuccess()}function pP(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable}))),n.push.apply(n,i)}return n}function ro(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?pP(Object(n),!0).forEach((function(i){R(t,i,n[i])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):pP(Object(n)).forEach((function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i))}))}return t}let lT=1;function DY(t,e,n,i,r){lT+=1;const s={sid:n.sid,command:"convergeAllocateEdge",uid:"666",appId:n.appId,ts:Math.floor(Date.now()/1e3),seq:lT,requestId:lT,version:Ar,cname:n.cname},o={service_name:e,json_body:JSON.stringify(s)};let a,c,d=t[0];return Rs((async()=>{a=Date.now();const l=await As(d,{data:o,cancelToken:i,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"}});if(c=Date.now()-a,l.code!==0){const f=new B(A.UNEXPECTED_RESPONSE,"live streaming ap error, code"+l.code,{retry:!0,responseTime:c});throw m.error(f.toString()),f}const h=JSON.parse(l.json_body);if(h.code!==200){const f=new B(A.UNEXPECTED_RESPONSE,"live streaming app center error, code: ".concat(h.code,", reason: ").concat(h.reason),{code:h.code,responseTime:c});throw m.error(f.toString()),f}if(!h.servers||h.servers.length===0){const f=new B(A.UNEXPECTED_RESPONSE,"live streaming app center empty server",{code:h.code,responseTime:c});throw m.error(f.toString()),f}const p=(function(f,v){return{addressList:f.servers.map((S=>"wss://".concat(S.address.replace(/\./g,"-"),".").concat(I("WORKER_DOMAIN"),":").concat(S.wss,"?serviceName=").concat(encodeURIComponent(v)))),workerToken:f.workerToken,vid:f.vid}})(h,e);return I("LIVE_STREAMING_ADDRESS")&&(p.addressList=I("LIVE_STREAMING_ADDRESS")instanceof Array?I("LIVE_STREAMING_ADDRESS"):[I("LIVE_STREAMING_ADDRESS")]),ro(ro({},p),{},{responseTime:c})}),((l,h)=>(pt.apworkerEvent(n.sid,{success:!0,sc:200,serviceName:e,responseDetail:JSON.stringify(l.addressList),firstSuccess:h===0,responseTime:c,serverIp:t[h%t.length]}),!1)),((l,h)=>(pt.apworkerEvent(n.sid,{success:!1,sc:l.data&&l.data.code||200,serviceName:e,responseTime:c,serverIp:t[h%t.length]}),!!(l.code!==A.OPERATION_ABORTED&&l.code!==A.UNEXPECTED_RESPONSE||l.data&&l.data.retry)&&(d=t[(h+1)%t.length],!0))),r)}let uT=1;function _P(t,e,n,i){let{url:r,areaCode:s}=t;const{clientId:o,sid:a}=e,c=Date.now();let d;const l=e.role,[h,p]=pT(e,s,[mn.CHOOSE_SERVER]);let f=$e.networkState;return Rs((async()=>{f&&$e.networkState===mi.OFFLINE&&$e.onlineWaiter&&await st.race([$e.onlineWaiter,Nn(i&&i.maxRetryTimeout||fn.maxRetryTimeout)]),f=$e.networkState;const{data:v,headers:S}=await As(r,{data:h,cancelToken:n,headers:{"Content-Type":"multipart/form-data;"}},!0,!0);d=S.http3==="1"?1:-1,pt.reportResourceTiming(r,a),mP(v,r,e,c,[mn.CHOOSE_SERVER],d);const T=_u(v,mn.CHOOSE_SERVER);return hT(T),ZS(T,r)}),(v=>(v&&pt.joinChooseServer(a,{role:l,lts:c,succ:!0,csAddr:r,opid:p,serverList:v.gatewayAddrs.map((S=>S.address)),ec:null,cid:v.cid.toString(),uid:v.uid.toString(),csIp:v.csIp,unilbsServerIds:[mn.CHOOSE_SERVER].toString(),isHttp3:d,corssRegionTagReq:e.apRequestDetail,corssRegionTagRes:v.res.detail&&v.res.detail[38],vid:v.vid}),!1)),(v=>v.code!==A.OPERATION_ABORTED&&(v.code===A.CAN_NOT_GET_GATEWAY_SERVER?v.data.retry:(pt.joinChooseServer(a,{role:l,lts:c,succ:!1,csAddr:r,serverList:null,opid:p,ec:v.code,csIp:v.data&&v.data.csIp,unilbsServerIds:[mn.CHOOSE_SERVER].toString(),extend:JSON.stringify({networkState:f}),isHttp3:d,corssRegionTagReq:e.apRequestDetail}),m.warning("[".concat(o||"sid-".concat(a.slice(0,6)),"] Choose server network error, retry"),v),!0))),i)}function fP(t,e,n,i){let r,{url:s,areaCode:o,serviceIds:a}=t;const c=Date.now(),d=e.role,[l,h]=pT(e,o,a);let p;return Rs((async()=>{p&&$e.networkState===mi.OFFLINE&&$e.onlineWaiter&&await st.race([$e.onlineWaiter,Nn(i&&i.maxRetryTimeout||fn.maxRetryTimeout)]),p=$e.networkState;const{data:f,headers:v}=await As(s,{data:l,cancelToken:n,headers:{"Content-Type":"multipart/form-data;"}},!0,!0);r=v.http3==="1"?1:-1,pt.reportResourceTiming(s,e.sid),mP(f,s,e,c,a,r);const S=_u(f,mn.CHOOSE_SERVER),T=_u(f,e.cloudProxyServer==="proxy5"?mn.CLOUD_PROXY_5:e.cloudProxyServer==="proxy3"||e.cloudProxyServer==="proxy4"?mn.CLOUD_PROXY:mn.CLOUD_PROXY_FALLBACK),b=performance.getEntriesByName(s),w=b[b.length-1];let D;return w&&(D={name:w.name,protocol:"nextHopProtocol"in w?w.nextHopProtocol:"",dnscost:"domainLookupEnd"in w&&"domainLookupStart"in w&&typeof w.domainLookupEnd=="number"&&typeof w.domainLookupStart=="number"?w.domainLookupEnd-w.domainLookupStart:-1,tcpTlsCost:"connectEnd"in w&&"connectStart"in w&&typeof w.connectEnd=="number"&&typeof w.connectStart=="number"?w.connectEnd-w.connectStart:-1,reqCost:"requestStart"in w&&typeof w.requestStart=="number"&&"responseEnd"in w&&typeof w.responseEnd=="number"?w.responseEnd-w.requestStart:-1,handleCost:"leave_ts"in f&&"enter_ts"in f&&typeof f.leave_ts=="number"&&typeof f.enter_ts=="number"?f.leave_ts-f.enter_ts:-1}),hT(S),{gatewayInfo:ZS(S,s),proxyInfo:T,url:s,resourceTimingInfo:D}}),(f=>{var v;return f.gatewayInfo&&pt.joinChooseServer(e.sid,{role:d,lts:c,succ:!0,csAddr:s,serverList:f.gatewayInfo.gatewayAddrs.map((S=>S.address)),ec:null,opid:h,cid:f.gatewayInfo.cid.toString(),uid:f.gatewayInfo.uid.toString(),csIp:f.gatewayInfo.csIp,unilbsServerIds:a.toString(),isHttp3:r,corssRegionTagReq:e.apRequestDetail,corssRegionTagRes:f.gatewayInfo.res.detail&&f.gatewayInfo.res.detail[38],vid:(v=f.gatewayInfo)===null||v===void 0?void 0:v.vid,resourceTimingInfo:f.resourceTimingInfo?JSON.stringify(f.resourceTimingInfo):void 0}),f.proxyInfo&&pt.joinWebProxyAP(e.sid,{lts:c,sucess:1,apServerAddr:s,turnServerAddrList:f.proxyInfo.addresses.map((S=>S.ip)).join(","),errorCode:null,eventType:e.cloudProxyServer,unilbsServerIds:a.toString()}),!1}),(f=>f.code!==A.OPERATION_ABORTED&&(f.code===A.CAN_NOT_GET_GATEWAY_SERVER?f.data.retry:(pt.joinWebProxyAP(e.sid,{lts:c,sucess:0,apServerAddr:s,turnServerAddrList:null,errorCode:f.code,eventType:e.cloudProxyServer,unilbsServerIds:a.toString(),extend:JSON.stringify({networkState:p})}),m.warning("[".concat(e.clientId,"] multi unilbs network error, retry"),f),!0))),i)}const mP=(t,e,n,i,r,s)=>{const{sid:o,clientId:a,cloudProxyServer:c}=n,d=[],l=h=>{h.flag===4096?pt.joinChooseServer(o,{role:n.role,lts:i,succ:!1,csAddr:e,opid:t.opid,serverList:null,ec:h.error.message,csIp:h.error.data&&h.error.data.csIp,unilbsServerIds:r.toString(),isHttp3:s,corssRegionTagReq:n.apRequestDetail}):h.flag!==1048576&&h.flag!==4194304&&h.flag!==4194310||pt.joinWebProxyAP(o,{lts:i,sucess:0,apServerAddr:e,turnServerAddrList:null,errorCode:h.error.code,eventType:c,unilbsServerIds:r.toString()})};if(t.response_body.forEach((h=>{const p=h.buffer.code;if(h.uri===23&&p===0&&!h.buffer.edges_services)if(h.buffer.flag===4194310)m.warning("no edge services in ap response of proxy fallback, will not set proxy in iceServers"),h.buffer.edges_services=[];else{const f={error:new B(A.CAN_NOT_GET_GATEWAY_SERVER,"no edge services in ap response",{retry:I("NO_EDGES_RETRY"),csIp:t.detail[502]}),flag:h.buffer.flag};d.push(f),l(f)}if(p!==0){const f=Bd(p),v={error:new B(A.CAN_NOT_GET_GATEWAY_SERVER,f.desc,{desc:f.desc,retry:f.retry,csIp:t.detail[502]}),flag:h.buffer.flag};h.buffer.flag===4194310?m.warning(v.error.toString()):d.push(v),l(v)}})),d.length)throw m.warning("[".concat(a||"sid-".concat(o.slice(0,6)),"] multi unilbs ").concat(e," failed, ").concat(d.map((h=>"flag: ".concat(h.flag,", message: ").concat(h.error.message,", retry: ").concat(h.error.data.retry))).join(" | "))),new B(A.CAN_NOT_GET_GATEWAY_SERVER,d.map((h=>"flag: ".concat(h.flag,", message: ").concat(h.error.message))).join(" | "),{retry:!!d.find((h=>h.error.data.retry)),csIp:t.detail[502],desc:[...new Set(d.map((h=>{var p;return h==null||(p=h.error)===null||p===void 0||(p=p.data)===null||p===void 0?void 0:p.desc})).filter((h=>!!h)))]})},hT=t=>{var e,n,i,r;if(t.addresses&&t.addresses.length===0&&t.code===0)throw new B(A.CAN_NOT_GET_GATEWAY_SERVER,"void gateway address",{retry:!0,csIp:t.detail&&t.detail[502]});if(I("AP_AREA")&&((i=t.detail)!==null&&i!==void 0&&i[23]&&typeof((r=t.detail)===null||r===void 0?void 0:r[23])=="string"?hP(t.detail[23].toLowerCase()):hP()),(e=t.detail)!==null&&e!==void 0&&e[19]&&typeof((n=t.detail)===null||n===void 0?void 0:n[19])=="string"){const o=t.detail[19],a=o?.split(";");for(let c=0;c<a.length;c++){var s;const d=_i(s=a[c]).call(s);t.addresses[c]&&a&&(t.addresses[c].fingerprint=d)}}if(I("GATEWAY_ADDRESS")&&I("GATEWAY_ADDRESS").length>0){m.debug("assign gateway address to",I("GATEWAY_ADDRESS"));const o=I("GATEWAY_ADDRESS").map((a=>{var c,d;const l=(c=(d=t.addresses.find((h=>h.ip===a.ip&&h.port===a.port)))===null||d===void 0?void 0:d.fingerprint)!==null&&c!==void 0?c:"";return{ip:a.ip,port:a.port,ticket:t.addresses[0]&&t.addresses[0].ticket,fingerprint:a.fingerprint||l}}));t.addresses=o}},PY=(t,e)=>{if(t.response_body&&t.response_body.length){const n=t.response_body[0];if(n.buffer.code!==0){const i=Bd(n.buffer.code);throw new B(A.UPDATE_TICKET_FAILED,"[".concat(n.buffer.code,"]: ").concat(i.desc),{retry:i.retry})}return n.buffer.ticket}throw m.debug("update ticket request received ap response without response body:",e),new B(A.UPDATE_TICKET_FAILED,"cannot find response body from ap response",{retry:!1})},pT=(t,e,n)=>{const i=Math.floor(Math.random()*1e12),r=t.role==="host"?"1":t.role==="audience"?"2":void 0,s={appid:t.appId,client_ts:Date.now(),opid:i,sid:t.sid,request_bodies:[{uri:22,buffer:{cname:t.cname,detail:ro(ro(ro({6:t.stringUid,11:e,12:I("USE_NEW_TOKEN")?"1":void 0},r?{17:r}:{}),{},{22:e},t.apRequestDetail?{33:t.apRequestDetail}:{}),t.apRTM?{26:"RTM2"}:{}),key:t.token,service_ids:n,uid:t.uid||0}}]};s.request_bodies.forEach((a=>{t.multiIP&&t.multiIP.gateway_ip&&(a.buffer.detail[5]=JSON.stringify({vocs_ip:[t.multiIP.uni_lbs_ip],vos_ip:[t.multiIP.gateway_ip]}))}));const o=new FormData;return o.append("request",JSON.stringify(s)),[o,i]},LY=(t,e)=>{const n=Math.floor(Math.random()*1e12),i={appid:t.appId,client_ts:Date.now(),opid:n,sid:t.sid,request_bodies:[{uri:28,buffer:{cname:t.cname,detail:{1:"",6:t.stringUid,12:"1"},token:t.token,service_ids:e,uid:t.uid||0,edges_services:t.apResponse.addresses.map((s=>({ip:s.ip,port:s.port})))}}]},r=new FormData;return r.append("request",JSON.stringify(i)),[r,n]};let Wd=0;function Hd(t){return st.all(t.map((e=>e.then((n=>{throw n}),(n=>n))))).then((e=>{throw e}),(e=>e))}const Ru=async t=>{let{fragementLength:e,referenceList:n,asyncMapHandler:i,allFailedhandler:r,promisesCollector:s}=t,o=0;const a=e;let c,d=0;const l=async()=>{const h=(()=>{const p=o*a,f=p+a;return n.slice(p,f).map(i)})();s&&s.push(...h);try{c=await Hd(h)}catch(p){if(d+=a,o++,!(d>=n.length))return void await l();r(p)}h.forEach((p=>p.cancel()))};return await l(),c},EP=async t=>{let{referenceList:e,asyncMapHandler:n,closeFn:i}=t;const r=e.length;let s=0;const o=async()=>{const a=n(e.shift());try{return await a}catch(c){if(s++,s>=r||i!=null&&i(c))throw c;return o()}};return o()};async function kY(){if(typeof VideoDecoder>"u")return!0;let t;const e=[18,0,10,13,0,0,0,3,180,253,144,6,136,8,8,8,32,50,85,16,66,128,2,8,32,132,0,8,0,180,90,204,169,166,242,109,241,190,143,149,160,133,4,144,43,122,168,159,120,159,205,39,82,131,57,52,87,187,68,23,248,134,204,226,97,17,49,183,55,236,219,249,221,98,208,215,190,59,179,167,213,47,1,246,150,14,194,245,159,83,35,64,103,218,38,21,82,3,135,21,185,84,248,134],n=[18,0,10,13,0,0,0,3,180,253,144,6,136,8,8,8,32,50,87,16,66,128,2,8,32,132,0,8,0,180,90,204,169,166,242,109,241,190,143,148,62,134,140,92,172,141,77,35,94,181,164,65,169,65,156,154,43,221,162,11,252,67,102,113,48,136,137,219,62,43,113,239,23,126,250,186,252,10,138,218,25,193,244,74,68,194,209,107,23,52,206,199,78,72,98,103,151,71,96,62,51,210,158,72,231,158],i=[18,0,10,13,0,0,0,3,180,253,144,6,136,8,8,8,32,50,87,16,66,128,2,8,32,132,0,8,0,180,90,204,169,166,242,109,241,190,143,143,233,163,51,196,98,95,151,224,22,134,33,240,150,248,67,18,34,196,142,81,238,173,140,80,205,232,132,144,67,12,131,157,4,171,243,86,122,35,6,166,184,243,85,126,13,206,103,152,62,168,160,187,2,241,138,52,211,72,121,128,151,63,147,128,19,42],r=[18,0,50,138,1,48,192,64,253,248,65,17,67,192,32,0,16,0,0,0,0,0,0,0,195,12,48,144,64,32,0,209,75,61,9,204,25,115,79,226,115,63,63,208,70,210,220,153,126,241,237,37,107,195,153,1,99,112,230,189,209,169,130,10,11,22,167,215,159,205,197,7,183,162,26,48,254,141,134,103,32,16,235,45,1,15,18,119,169,110,206,251,51,115,202,60,148,1,46,39,109,25,28,86,168,15,77,211,239,2,58,43,146,26,230,184,81,48,140,226,226,250,222,146,171,133,164,13,188,180,64,122,142,146,32,208,238,170,193,35,53,44,225],s=[18,0,50,107,48,0,133,125,248,65,26,195,64,62,32,31,16,0,0,0,0,0,1,4,16,64,144,64,32,0,204,24,122,65,56,165,18,52,206,218,4,187,51,97,9,29,191,90,253,106,185,31,197,155,52,205,245,185,203,131,20,226,25,124,95,113,220,113,141,15,15,104,211,144,152,237,150,157,127,51,143,24,231,218,171,255,176,241,128,229,149,150,148,66,245,228,91,27,182,228,136,61,182,237,133,45,220,24,103,214,152],o=[18,0,50,122,48,1,9,253,248,65,26,67,64,62,32,31,16,0,0,0,0,0,1,4,16,64,144,64,32,0,198,182,231,242,220,235,163,140,12,36,36,166,46,132,210,4,71,23,218,132,27,30,17,45,244,79,31,243,195,136,100,169,76,88,142,85,204,217,121,168,29,163,198,17,251,223,73,12,212,244,139,123,151,179,75,216,96,208,136,40,229,42,59,149,10,116,228,85,99,93,221,108,255,140,248,20,30,167,122,109,206,164,108,197,110,251,23,243,133,160,63,13,207,177,12,128];return await new st(((c,d)=>{let l;(async function(){t&&t.state!=="closed"||await(async function(){t=new VideoDecoder({output:p=>{p.close(),clearTimeout(l),c(!0)},error:p=>{clearTimeout(l),c(!1)}}),await t.configure({codec:"av01.0.05M.08",width:160,height:90})})();const h=[e,n,i,r,s,o];for(let p=0;p<h.length;p++){const f=new EncodedVideoChunk({type:p==0?"key":"delta",timestamp:33333*p,duration:33333,data:new Uint8Array(h[p])});try{await t.decode(f)}catch{return void c(!1)}}})(),l=setTimeout((()=>{c(!1)}),5e3)}))}async function L_(t,e,n,i){return{gatewayInfo:await(async function(s,o,a,c){let d=null;const l=[],h=async()=>{const f=I("WEBCS_DOMAIN").slice(0,I("AJAX_REQUEST_CONCURRENT")).map((T=>({url:s.proxyServer?"https://".concat(s.proxyServer,"/ap/?url=").concat(T+"/api/v2/transpond/webrtc?v=2"):"https://".concat(T,"/api/v2/transpond/webrtc?v=2"),areaCode:Tu()}))),v=c.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:f.map((T=>T.url))}),S=await Ru({fragementLength:I("FRAGEMENT_LENGTH"),referenceList:f,asyncMapHandler:T=>(m.debug("[".concat(s.clientId,"] Connect to choose_server:"),T.url),_P(T,s,o,a)),allFailedhandler:T=>{throw c.recordJoinChannelService({endTs:Date.now(),status:"error",errors:T},v),T[0]},promisesCollector:l});return c.recordJoinChannelService({endTs:Date.now(),status:"success"},v),S},p=async()=>{if(await Nn(1e3),d!==null)return d;const f=I("WEBCS_DOMAIN_BACKUP_LIST").map((T=>({url:s.proxyServer?"https://".concat(s.proxyServer,"/ap/?url=").concat(T+"/api/v2/transpond/webrtc?v=2"):"https://".concat(T,"/api/v2/transpond/webrtc?v=2"),areaCode:Tu()}))),v=c.recordJoinChannelService({endTs:void 0,startTs:Date.now(),status:"pending",service:"chooseServer",urls:f.map((T=>T.url))}),S=await Ru({fragementLength:I("FRAGEMENT_LENGTH"),referenceList:f,asyncMapHandler:T=>(m.debug("[".concat(s.clientId,"] Connect to backup choose_server:"),T.url),_P(T,s,o,a)),allFailedhandler:T=>{throw c.recordJoinChannelService({endTs:Date.now(),status:"error",errors:T},v),T[0]},promisesCollector:l});return c.recordJoinChannelService({endTs:Date.now(),status:"success"},v),S};try{return d=await Hd([h(),p()]),l.length&&l.forEach((f=>f.cancel&&typeof f.cancel=="function"&&f.cancel())),d}catch(f){throw f[0]}})(t,e,n,i)}}async function gP(t,e,n,i,r){const s=t.cloudProxyServer;if(s==="disabled"){if(t.useLocalAccessPoint)return await L_(t,e,n,r);if(I("JOIN_WITH_FALLBACK_MEDIA_PROXY")){const{gatewayInfo:p,proxyInfo:f}=await RP(t,e,n,r);if(t.turnServer&&t.turnServer.mode!=="auto")return{gatewayInfo:p};const v=f.map((S=>({turnServerURL:S.address,tcpport:S.tcpport||Jn.tcpport,udpport:S.udpport||Jn.udpport,username:S.username||Jn.username,password:S.password||Jn.password,forceturn:!1,security:!0})));if(r.useP2P){var o;const S=(o=t.uid)!==null&&o!==void 0?o:p.uid,T="glb:".concat(S.toString()),b=await Xg(T),w=f.map((D=>({turnServerURL:D.address,tcpport:D.tcpport||Jn.tcpport,udpport:D.udpport||Jn.udpport,username:T,password:b,forceturn:!1,security:!0})));v.push(...w)}return t.turnServer={mode:"manual",servers:v},{gatewayInfo:p}}return await L_(t,e,n,r)}const{proxyInfo:a,gatewayInfo:c}=await RP(t,e,n,r),d={gatewayInfo:c},l=a.map((p=>({turnServerURL:p.address,tcpport:s==="proxy3"?void 0:p.tcpport?p.tcpport:Jn.tcpport,udpport:s==="proxy4"?void 0:p.udpport?p.udpport:Jn.udpport,username:p.username||Jn.username,password:p.password||Jn.password,forceturn:s!=="proxy4",security:s==="proxy5"})));if(r.useP2P){var h;const p=(h=t.uid)!==null&&h!==void 0?h:c.uid,f="glb:".concat(p.toString()),v=await Xg(f),S=a.map((T=>({turnServerURL:T.address,tcpport:s==="proxy3"?void 0:T.tcpport||Jn.tcpport,udpport:s==="proxy4"?void 0:T.udpport||Jn.udpport,username:f,password:v,forceturn:s!=="proxy4",security:s==="proxy5"})));l.push(...S)}return t.turnServer={mode:"manual",servers:l},m.debug("[".concat(t.clientId,"] set proxy server: ").concat(t.proxyServer,", mode: ").concat(s)),d}async function SP(t,e,n,i,r){const s=I("ACCOUNT_REGISTER").slice(0,I("AJAX_REQUEST_CONCURRENT"));let o=[];o=e.proxyServer?s.map((c=>"https://".concat(e.proxyServer,"/ap/?url=").concat(c+"/api/v1"))):s.map((c=>"https://".concat(c,"/api/v1")));const a=r?.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"stringUID",urls:o});try{const c=await(async function(d,l,h,p,f){const v=Date.now(),S={sid:h.sid,opid:10,appid:h.appId,string_uid:l};let T=d[0];const b=await Rs((()=>As(T+"".concat(T.indexOf("?")===-1?"?":"&","action=stringuid"),{data:S,cancelToken:p,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":72}})),((w,D)=>{if(w.code===0){if(w.uid<=0||w.uid>=Math.pow(2,32))throw m.error("Invalid Uint Uid ".concat(l," => ").concat(w.uid),w),pt.reqUserAccount(S.sid,{lts:v,success:!1,serverAddr:T,stringUid:S.string_uid,uid:w.uid,errorCode:A.INVALID_UINT_UID_FROM_STRING_UID,extend:S}),new B(A.INVALID_UINT_UID_FROM_STRING_UID);return pt.reqUserAccount(S.sid,{lts:v,success:!0,serverAddr:T,stringUid:S.string_uid,uid:w.uid,errorCode:null,extend:S}),!1}const k=Bd(w.code);return k.retry&&(T=d[(D+1)%d.length]),pt.reqUserAccount(S.sid,{lts:v,success:!1,serverAddr:T,stringUid:S.string_uid,uid:w.uid,errorCode:k.desc,extend:S}),k.retry}),((w,D)=>w.code!==A.OPERATION_ABORTED&&(pt.reqUserAccount(S.sid,{lts:v,success:!1,serverAddr:T,stringUid:S.string_uid,uid:null,errorCode:w.code,extend:S}),T=d[(D+1)%d.length],!0)),f);if(b.code!==0){const w=Bd(b.code);throw new B(A.UNEXPECTED_RESPONSE,w.desc)}return b})(o,t,e,n,i);return r?.recordJoinChannelService({status:"success",endTs:Date.now()},a),c.uid}catch(c){throw r?.recordJoinChannelService({status:"error",endTs:Date.now(),errors:[c]},a),c}}async function MY(t,e,n){const i=I("ACCOUNT_REGISTER");let r=[];r=e.proxyServer?i.map((s=>"https://".concat(e.proxyServer,"/ap/?url=").concat(s+"/api/v1"))):i.map((s=>"https://".concat(s,"/api/v1")));try{return await EP({referenceList:r,asyncMapHandler:o=>(async function(a,c,d,l){const h=Date.now(),p={sid:d.sid,opid:10,appid:d.appId,string_uid:c};try{const f=await As(a+"".concat(a.indexOf("?")===-1?"?":"&","action=stringuid"),{data:p,cancelToken:l,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":72}});if(f.code!==0){const v=Bd(f.code);throw new B(A.UNEXPECTED_RESPONSE,"preload sua error:".concat(v.desc),v)}if(f.uid<=0||f.uid>=Math.pow(2,32))throw new B(A.INVALID_UINT_UID_FROM_STRING_UID);return{requestTime:h,url:a,req:p,uid:f.uid,elapse:Date.now()-h}}catch(f){throw f}})(o,t,e,n),closeFn:o=>o.code===A.OPERATION_ABORTED||o.code===A.UNEXPECTED_RESPONSE&&!o.data.retry})}catch(s){throw s}}async function UY(t,e,n){const i=I("CDS_AP").slice(0,I("AJAX_REQUEST_CONCURRENT")).map((c=>t.proxyServer?"https://".concat(t.proxyServer,"/ap/?url=").concat(c+"/api/v1"):"https://".concat(c,"/api/v1?action=config"))),r=i.map((c=>(function(d,l,h,p){const f=de(),v={flag:64,cipher_method:0,features:ro(ro(ro(ro(ro({install_id:cS(),device:f.name,system:f.os,system_general:navigator.userAgent,vendor:l.appId,version:Ar,cname:l.cname,session_id:l.sid,proxyServer:l.proxyServer,sdk_type:bY.WEB_RTC,browser_name:f.name,browser_version:f.version,user_agent:navigator.userAgent,channel_name:l.cname},l.stringUid&&{string_uid:l.stringUid}),l.uid&&{uid:l.uid+""}),f.os&&{os_name:f.os}),f.osVersion&&{os_version:f.osVersion}),{},{detail:""})};return Rs((()=>As(d,{data:v,timeout:1e3,cancelToken:h,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":54}})),void 0,(S=>S.code!==A.OPERATION_ABORTED),p)})(c,t,e,n)));let s=null,o=null,a={};try{s=await Hd(r)}catch(c){if(c.code===A.OPERATION_ABORTED)throw c;o=c}if(r.forEach((c=>c.cancel())),pt.reportApiInvoke(t.sid,{name:Ge.REQUEST_CONFIG_DISTRIBUTE,options:{error:o,res:s}}).onSuccess(),s&&s.test_tags)try{a=(function(c){if(!c.test_tags)return{};const d=c.test_tags,l=Object.keys(d),h={};return l.forEach((p=>{var f;const v=_i(f=p.slice(4)).call(f),S=JSON.parse(d[p]),T=S[1];h[v]={tag:S[0]||"",value:T}})),h})(s)}catch{}return a}async function TP(t,e){const n=I("WEBCS_DOMAIN").concat(I("WEBCS_DOMAIN_BACKUP_LIST")).map((i=>({url:"https://".concat(i,"/api/v2/transpond/webrtc?v=2"),areaCode:Tu(),serviceIds:[mn.CHOOSE_SERVER,mn.CLOUD_PROXY_FALLBACK]})));try{return await EP({referenceList:n,asyncMapHandler:r=>(async function(s,o,a){let c,{url:d,areaCode:l,serviceIds:h}=s;const p=Date.now(),[f,v]=pT(o,l,h);let S=$e.networkState;try{S&&$e.networkState===mi.OFFLINE&&$e.onlineWaiter&&await st.race([$e.onlineWaiter,Nn(fn.maxRetryTimeout)]),S=$e.networkState;const{data:T,headers:b}=await As(d,{data:f,cancelToken:a,headers:{"Content-Type":"multipart/form-data;"}},!0,!0);c=b.http3==="1"?1:-1,(U=>{const P=[];if(U.response_body.forEach((x=>{const q=x.buffer.code;if(x.uri===23&&q===0&&!x.buffer.edges_services)if(x.buffer.flag===4194310)x.buffer.edges_services=[];else{const Q={error:new B(A.CAN_NOT_GET_GATEWAY_SERVER,"no edge services in ap response",{retry:I("NO_EDGES_RETRY"),csIp:U.detail[502]}),flag:x.buffer.flag};P.push(Q)}if(q!==0){const Q=Bd(q),dt={error:new B(A.CAN_NOT_GET_GATEWAY_SERVER,Q.desc,{desc:Q.desc,retry:Q.retry,csIp:U.detail[502]}),flag:x.buffer.flag};x.buffer.flag===4194310?m.warning(dt.error.toString()):P.push(dt)}})),P.length)throw new B(A.CAN_NOT_GET_GATEWAY_SERVER,P.map((x=>"flag: ".concat(x.flag,", message: ").concat(x.error.message))).join(" | "),{retry:!!P.find((x=>x.error.data.retry)),csIp:U.detail[502],desc:[...new Set(P.map((x=>{var q;return x==null||(q=x.error)===null||q===void 0||(q=q.data)===null||q===void 0?void 0:q.desc})).filter((x=>!!x)))]})})(T);const D=_u(T,mn.CHOOSE_SERVER),k=_u(T,mn.CLOUD_PROXY_FALLBACK);return hT(D),{gatewayInfo:ZS(D,d),proxyInfo:k,opid:v,requestTime:p,url:d,isHttp3:c,elapse:Date.now()-p}}catch(T){throw T}})(r,t,e),closeFn:r=>r.code===A.OPERATION_ABORTED||r.code===A.CAN_NOT_GET_GATEWAY_SERVER&&!r.data.retry})}catch(i){throw i}}async function RP(t,e,n,i){const r=I("PROXY_SERVER_TYPE3"),s=(f,v,S)=>{let T=S||r;return Array.isArray(T)&&(T=v%2==0&&r[1]||r[0]),"https://".concat(T,"/ap/?url=").concat(f)};let o=null;const a=[],c=async()=>{const f=I("WEBCS_DOMAIN").slice(0,I("AJAX_REQUEST_CONCURRENT")).map(((T,b)=>{let w;return w=t.cloudProxyServer==="disabled"&&t.proxyServer?s("".concat(T,"/api/v2/transpond/webrtc?v=2"),b,t.proxyServer):t.cloudProxyServer==="disabled"||t.cloudProxyServer==="fallback"?"https://".concat(T,"/api/v2/transpond/webrtc?v=2"):s("".concat(T,"/api/v2/transpond/webrtc?v=2"),b),{url:w,areaCode:Tu(),serviceIds:[mn.CHOOSE_SERVER,t.cloudProxyServer==="proxy5"?mn.CLOUD_PROXY_5:t.cloudProxyServer==="proxy3"||t.cloudProxyServer==="proxy4"?mn.CLOUD_PROXY:mn.CLOUD_PROXY_FALLBACK]}})),v=i.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:f.map((T=>T.url))}),S=await Ru({fragementLength:I("FRAGEMENT_LENGTH"),referenceList:f,asyncMapHandler:T=>(m.debug("[".concat(t.clientId,"] Connect to choose_server:"),T.url),fP(T,t,e,n)),allFailedhandler:T=>{throw i.recordJoinChannelService({endTs:Date.now(),status:"error",errors:T},v),T[0]},promisesCollector:a});return i.recordJoinChannelService({endTs:Date.now(),status:"success"},v),S},d=async()=>{if(await Nn(1e3),o!==null)return o;const f=I("WEBCS_DOMAIN_BACKUP_LIST").map(((T,b)=>{let w;return w=t.cloudProxyServer==="disabled"&&t.proxyServer?s("".concat(T,"/api/v2/transpond/webrtc?v=2"),b,t.proxyServer):t.cloudProxyServer==="disabled"||t.cloudProxyServer==="fallback"?"https://".concat(T,"/api/v2/transpond/webrtc?v=2"):s("".concat(T,"/api/v2/transpond/webrtc?v=2"),b),{url:w,areaCode:Tu(),serviceIds:[mn.CHOOSE_SERVER,t.cloudProxyServer==="proxy5"?mn.CLOUD_PROXY_5:t.cloudProxyServer==="proxy3"||t.cloudProxyServer==="proxy4"?mn.CLOUD_PROXY:mn.CLOUD_PROXY_FALLBACK]}})),v=i.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:f.map((T=>T.url))}),S=await Ru({fragementLength:I("FRAGEMENT_LENGTH"),referenceList:f,asyncMapHandler:T=>(m.debug("[".concat(t.clientId,"] Connect to backup choose_server:"),T.url),fP(T,t,e,n)),allFailedhandler:T=>{throw i.recordJoinChannelService({endTs:Date.now(),status:"error",errors:T},v),T[0]},promisesCollector:a});return i.recordJoinChannelService({endTs:Date.now(),status:"success"},v),S};let l,h,p;try{({gatewayInfo:l,proxyInfo:h,url:p}=await Hd([c(),d()]))}catch(f){throw f[0]}if(a.length&&a.forEach((f=>f.cancel&&typeof f.cancel=="function"&&f.cancel())),!l||!h)throw new B(A.UNEXPECTED_ERROR,"missing gateway or proxy response").print();if(t.apUrl=p,t.cloudProxyServer!=="disabled"&&Array.isArray(r)&&p){const f=/^https?:\/\/(.+?)(\/.*)?$/.exec(p)[1];$(r).call(r,f)&&(t.proxyServer=f,m.setProxyServer(f),pt.setProxyServer(f))}return o={gatewayInfo:l,proxyInfo:await KD(h,l.uid)},o}async function xY(t,e,n){const i=I("UAP_AP").slice(0,I("AJAX_REQUEST_CONCURRENT")).map((s=>t.proxyServer?"https://".concat(t.proxyServer,"/ap/?url=").concat(s+"/api/v1?action=uap"):"https://".concat(s,"/api/v1?action=uap"))),r=i.map((s=>(function(o,a,c,d){const l={command:"convergeAllocateEdge",sid:a.sid,appId:a.appId,token:a.token,ts:Date.now(),version:Ar,cname:a.cname,uid:a.uid.toString(),requestId:uT,seq:uT};uT+=1;const h={service_name:"tele_channel",json_body:JSON.stringify(l)};return Rs((async()=>{const p=await As(o,{data:h,cancelToken:c,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":61}});if(p.code!==0){const v=new B(A.UNEXPECTED_RESPONSE,"cross channel ap error, code"+p.code,{retry:!0});throw m.error(v.toString()),v}const f=JSON.parse(p.json_body);if(f.code!==200){const v=new B(A.UNEXPECTED_RESPONSE,"cross channel app center error, code: ".concat(f.code,", reason: ").concat(f.reason));throw m.error(v.toString()),v}if(!f.servers||f.servers.length===0){const v=new B(A.UNEXPECTED_RESPONSE,"cross channel app center empty server");throw m.error(v.toString()),v}return{vid:f.vid,workerToken:f.workerToken,addressList:(I("CHANNEL_MEDIA_RELAY_SERVERS")||f.servers).map((v=>"wss://".concat(v.address.replace(/\./g,"-"),".").concat(I("WORKER_DOMAIN"),":").concat(v.wss)))}}),void 0,(p=>!!(p.code!==A.OPERATION_ABORTED&&p.code!==A.UNEXPECTED_RESPONSE||p.data&&p.data.retry)),d)})(s,t,e,n)));try{const s=await Hd(r);return r.forEach((o=>o.cancel())),s}catch(s){throw s[0]}}async function VY(t,e,n){let i=null;const r=[],s=async o=>{const a=I(o?"WEBCS_DOMAIN_BACKUP_LIST":"WEBCS_DOMAIN").map((c=>t.proxyServer?"https://".concat(t.proxyServer,"/ap/?url=").concat(c+"/api/v2/transpond/webrtc?v=2"):"https://".concat(c,"/api/v2/transpond/webrtc?v=2")));return o&&(await Nn(1e3),i!==null)?i:await Ru({fragementLength:I("FRAGEMENT_LENGTH"),referenceList:a,asyncMapHandler:c=>(m.debug("[".concat(t.clientId,"] update ticket, Connect to ").concat(o?"backup":""," choose_server:"),c),(function(d,l,h,p){const[f]=LY(l,[mn.CHOOSE_SERVER]);let v=$e.networkState;return Rs((async()=>{v&&$e.networkState===mi.OFFLINE&&$e.onlineWaiter&&await st.race([$e.onlineWaiter,Nn(p&&p.maxRetryTimeout||fn.maxRetryTimeout)]),v=$e.networkState;const S=await As(d,{data:f,cancelToken:h,headers:{"Content-Type":"multipart/form-data;"}},!0);return PY(S,d)}),(()=>!1),(S=>S.code!==A.OPERATION_ABORTED&&(S.code===A.UPDATE_TICKET_FAILED?S.data.retry:(m.warning("[".concat(l.clientId,"] update ticket network error, retry"),S),!0))),p)})(c,t,e,n)),allFailedhandler:c=>{throw c[0]},promisesCollector:r})};try{return i=await Hd([s(!1),s(!0)]),r.length&&r.forEach((o=>o.cancel&&typeof o.cancel=="function"&&o.cancel())),i}catch(o){throw o[0]}}function vP(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable}))),n.push.apply(n,i)}return n}function _T(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?vP(Object(n),!0).forEach((function(i){R(t,i,n[i])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):vP(Object(n)).forEach((function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i))}))}return t}class FY extends qe{get isSuccess(){return!!this.configs}constructor(e,n){super(),R(this,"configs",void 0),R(this,"store",void 0),R(this,"joinInfo",void 0),R(this,"cancelToken",void 0),R(this,"retryConfig",{timeout:3e3,timeoutFactor:1.5,maxRetryCount:1,maxRetryTimeout:1e4}),R(this,"interval",void 0),R(this,"mutex",void 0),R(this,"mutableParamsRead",!1),R(this,"configCache",{}),R(this,"limit_bitrate",void 0),this.mutex=new Un("config-distribute",e),this.store=n}startGetConfigDistribute(e,n){this.joinInfo=e,this.cancelToken=n,this.interval&&this.stopGetConfigDistribute(),I("ENABLE_CONFIG_DISTRIBUTE")&&(this.updateConfigDistribute(),this.interval=window.setInterval((()=>{this.updateConfigDistribute()}),I("CONFIG_DISTRIBUTE_INTERVAL")))}stopGetConfigDistribute(){this.interval&&clearInterval(this.interval),this.interval=void 0,this.joinInfo=void 0,this.cancelToken=void 0,this.configs=void 0,this.limit_bitrate=void 0}async awaitConfigDistributeComplete(){this.mutex.isLocked&&(await this.mutex.lock())()}async updateConfigDistribute(){if(this.mutableParamsRead||(this.mutableParamsRead=!0,pt.reportApiInvoke(null,{options:void 0,name:Ge.LOAD_CONFIG_FROM_LOCALSTORAGE,tag:Ne.TRACER}).onSuccess(JSON.stringify(ur))),!this.joinInfo||!this.cancelToken||!this.retryConfig)return void m.debug("[config-distribute] get config distribute interrupted have no joininfo");let e;const n=await this.mutex.lock();try{e=await UY(this.joinInfo,this.cancelToken,this.retryConfig),m.debug("[config-distribute] get config distribute",JSON.stringify(e));const i=(function(r){var s;const o=Fa(s=Object.keys(r).filter((d=>/^webrtc_ng_global_parameter/.test(d)))).call(s);for(let d=0;d<o.length;d++)for(let l=o.length-1;l>d;l--){const h=o[l],p=r[h].value;if(typeof p.__priority=="number"){const f=p.__priority,v=o[l-1],S=r[v].value;if(typeof S.__priority=="number"){if(!(f>S.__priority))continue;{const T=h;o[l]=o[l-1],o[l-1]=T}}else{const T=h;o[l]=o[l-1],o[l-1]=T}}}const a=Date.now(),c={};return o.forEach((d=>{const l=r[d].value.__expires;l&&l<=a||(c[d]=r[d])})),c})(e);this.cacheGlobalParameterConfig(i),this.store.hasStartJoinChannel||(this.store.isABTestSuccess=!0),this.configs=i}catch(i){const r=new B(A.NETWORK_RESPONSE_ERROR,i);m.warning("[config-distribute] ".concat(r.toString()))}finally{n()}}getBitrateLimit(){return this.limit_bitrate||void 0}handleBitrateLimit(e){UD(e)&&(this.limit_bitrate?this.limit_bitrate&&this.limit_bitrate.id!==e.id&&this.emit(ys.UPDATE_BITRATE_LIMIT,e):this.emit(ys.UPDATE_BITRATE_LIMIT,e))}getLowStreamConfigDistribute(){return this.limit_bitrate&&_T({},this.limit_bitrate.low_stream_uplink)}handleABTestConfigDistribute(e){try{const n={},i=Object.keys(e),r=[];i.forEach((s=>{const o=e[s].value;n[s]=o;const a=o.__id;if(a&&this.configCache[s]&&this.configCache[s].__id===a)return;const c=o.__type,d=e[s].value,l=e[s].tag;let h=0;c?c===e0.REALTIME&&(h=1):Object.keys(d).some((p=>Object.prototype.hasOwnProperty.call(hS,p)||!BS()&&Object.prototype.hasOwnProperty.call(Jp,p)?(h=1,!0):void 0)),r.push({tag:l,isApplied:h,feature:s,params:JSON.stringify(o)})})),r.forEach((s=>{let{tag:o,feature:a,params:c,isApplied:d}=s;this.store.sessionId&&pt.abTest(this.store.sessionId,{intSucc:1,isApplied:d,tag:o,feature:a,params:c,cid:this.store.cid,uid:this.store.intUid})})),this.configCache=n}catch(n){m.debug("handleABTestConfigDistribute error",n)}}cacheGlobalParameterConfig(e){const n=(function(r){const s={};return Object.keys(r).forEach((o=>{const a=r[o].value,c=a.__expires,d=a.__type;Object.keys(a).forEach((l=>{l==="__id"||l==="__type"||l==="__priority"||l==="__expires"||Object.prototype.hasOwnProperty.call(s,l)||(s[l]=_T(_T({value:a[l]},c&&{expires:c}),d&&{type:d}))}))})),s})(e);try{var i;const r=(i=n.LIMIT_BITRATE)===null||i===void 0?void 0:i.value;delete n.LIMIT_BITRATE,r&&UD(r)&&this.handleBitrateLimit(r),this.limit_bitrate=r,this.handleGlobalParameterConfig(n),this.handleABTestConfigDistribute(e),(function(a){try{const c=Date.now();Object.keys(a).forEach((d=>{const{value:l,type:h,expires:p}=a[d];p&&p<=c||((h===e0.REALTIME||Object.prototype.hasOwnProperty.call(hS,d))&&(ur[d]=l,Te[d]=l,m.debug("Update realtime parameters from config distribute",d,l)),h||BS()||!Object.prototype.hasOwnProperty.call(Jp,d)||(ur[d]=l,Te[d]=l,m.debug("Update gateway parameters from config distribute",d,l)))}))}catch(c){m.error("Error update config immediately: ".concat(a),c.message)}})(n);const s=JSON.stringify(n),o=window.btoa(s);window.localStorage.setItem("websdk_ng_global_parameter",o),m.debug("Caching global parameters ".concat(s))}catch(r){m.error("Error caching global parameters:",r.message)}}handleGlobalParameterConfig(e){try{const n=Date.now();Object.keys(e).forEach((i=>{switch(i){case"CLIENT_ROLE_OPTIONS":if(Object.prototype.hasOwnProperty.call(Te,i)){const{value:s,expires:o}=e[i];if(o&&o<=n)return;tS(Te[i],s)||(ur[i]=s,Te[i]=s,this.emit(ys.UPDATE_CLIENT_ROLE_OPTIONS,s),m.debug("Updating client role options: ".concat(JSON.stringify(s))))}break;case"REMOTE_VIDEO_STREAM_TYPE":if(Object.prototype.hasOwnProperty.call(Te,i)){var r;const{value:s,expires:o}=e[i];if(o&&o<=n)return;typeof s=="number"&&$(r=[0,1,4,5,6,7,8,9]).call(r,s)&&(ur[i]={value:s},Te[i]=s,this.emit(ys.UPDATE_REMOTE_VIDEO_STREAM_TYPE,s),m.debug("Updating client remote stream type: ".concat(JSON.stringify(s))))}break;case"ENABLE_FORCE_HLS":if(Object.prototype.hasOwnProperty.call(Te,i)){const{value:s,expires:o}=e[i];if(o&&o<=n)return;tS(Te[i],s)||(ur[i]=s,Te[i]=s,this.emit(ys.FALLBACK_TO_HLS,s),m.debug("Updating enable force hls: ".concat(JSON.stringify(s))))}break;case"VOS_CONFIGURE":if(Object.prototype.hasOwnProperty.call(Te,i)){const{value:s,expires:o}=e[i];if(o&&o<=n)return;tS(Te[i],s)||(ur[i]=s,Te[i]=s,this.emit(ys.UPDATE_VOS_CONFIGURE,s),m.debug("Updating vos configure: ".concat(JSON.stringify(s))))}}}))}catch(n){m.error("Error handling global parameter config:",n.message)}}}class BY extends qe{constructor(){super(...arguments),R(this,"resultStorage",new Map)}setLocalAudioStats(e,n,i){this.record("AUDIO_INPUT_LEVEL_TOO_LOW",e,this.checkAudioInputLevel(i,n)),this.record("SEND_AUDIO_BITRATE_TOO_LOW",e,this.checkSendAudioBitrate(i,n))}setLocalVideoStats(e,n,i){this.record("SEND_VIDEO_BITRATE_TOO_LOW",e,this.checkSendVideoBitrate(i,n)),this.record("FRAMERATE_INPUT_TOO_LOW",e,this.checkFramerateInput(i,n)),this.record("FRAMERATE_SENT_TOO_LOW",e,this.checkFramerateSent(i)),!n.muted&&this.record("VIDEO_ENCODE_FAILED",e,this.checResolutionSent(i))}setRemoteAudioStats(e,n){const i=e.getUserId();this.record("AUDIO_OUTPUT_LEVEL_TOO_LOW",i,this.checkAudioOutputLevel(n))}setRemoteVideoStats(e,n){const i=e.getUserId();this.record("RECV_VIDEO_DECODE_FAILED",i,this.checkVideoDecode(n))}record(e,n,i){if(I("STATS_UPDATE_INTERVAL")>500)return;this.resultStorage.has(e)||this.resultStorage.set(e,{result:[],isPrevNormal:!0});const r=this.resultStorage.get(e);if(!r)return;r.result.push(i);const s=e==="VIDEO_ENCODE_FAILED"?I("ENCODE_EXCEPTION_TIMES"):5;if(r.result.length>=s){var o;const a=$(o=r.result).call(o,!0);r.isPrevNormal&&!a&&this.emit("exception",fT[e],e,n),!r.isPrevNormal&&a&&this.emit("exception",fT[e]+2e3,e+"_RECOVER",n),r.isPrevNormal=a,r.result=[]}}checkAudioOutputLevel(e){return!(e.receiveBitrate>0&&e.receiveLevel===0)}checkAudioInputLevel(e,n){return n instanceof Cn&&!n.isActive||!!n.muted||e.sendVolumeLevel!==0}checkFramerateInput(e,n){let i=null;n._encoderConfig&&n._encoderConfig.frameRate&&(i=wi(n._encoderConfig.frameRate));const r=e.captureFrameRate;return!i||!r||!(i>10&&r<5||i<10&&i>=5&&r<=1)}checkFramerateSent(e){return!(e.captureFrameRate&&e.sendFrameRate&&e.captureFrameRate>5&&e.sendFrameRate<=1)}checResolutionSent(e){var n;return!(!e.codecType||$(n=I("ENCODE_EXCEPTION_VALIDATE_CODEC")).call(n,e.codecType.toLocaleLowerCase()))||!e.captureFrameRate||e.sendFrameRate!==0||e.sendResolutionWidth!==0||e.sendResolutionHeight!==0}checkSendVideoBitrate(e,n){return!!n.muted||e.sendBitrate!==0}checkSendAudioBitrate(e,n){return n instanceof Cn&&!n.isActive||!!n.muted||e.sendBitrate!==0}checkVideoDecode(e){return e.receiveBitrate===0||e.decodeFrameRate!==0}}const fT={FRAMERATE_INPUT_TOO_LOW:1001,FRAMERATE_SENT_TOO_LOW:1002,SEND_VIDEO_BITRATE_TOO_LOW:1003,RECV_VIDEO_DECODE_FAILED:1005,AUDIO_INPUT_LEVEL_TOO_LOW:2001,AUDIO_OUTPUT_LEVEL_TOO_LOW:2002,SEND_AUDIO_BITRATE_TOO_LOW:2003,VIDEO_ENCODE_FAILED:2004},ni=new class{markSubscribeStart(t,e){performance.mark("agora-web-sdk/".concat(t,"/subscribe-").concat(e))}markPublishStart(t,e){performance.mark("agora-web-sdk/".concat(t,"/publish-").concat(e))}measureFromSubscribeStart(t,e){const n=performance.getEntriesByName("agora-web-sdk/".concat(t,"/subscribe-").concat(e));if(n.length>0){const i=n[n.length-1];return Math.round(performance.now()-i.startTime)}return 0}measureFromPublishStart(t,e){const n=performance.getEntriesByName("agora-web-sdk/".concat(t,"/publish-").concat(e));if(n.length>0){const i=n[n.length-1];return Math.round(performance.now()-i.startTime)}return 0}};function CP(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable}))),n.push.apply(n,i)}return n}function fc(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?CP(Object(n),!0).forEach((function(i){R(t,i,n[i])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):CP(Object(n)).forEach((function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i))}))}return t}class vu{constructor(e){R(this,"store",void 0),R(this,"onStatsException",void 0),R(this,"onUploadPublishDuration",void 0),R(this,"onStatsChanged",void 0),R(this,"onVideoCodecChanged",void 0),R(this,"localStats",new Map),R(this,"remoteStats",new Map),R(this,"updateStatsInterval",void 0),R(this,"trafficStats",void 0),R(this,"trafficStatsPeerList",[]),R(this,"uplinkStats",void 0),R(this,"exceptionMonitor",void 0),R(this,"p2pChannel",void 0),R(this,"scalabilityMode",zp.L1T1),R(this,"updateStats",(()=>{this.p2pChannel&&(this.updateRemoteStats(this.p2pChannel),this.updateLocalStats(this.p2pChannel))})),this.store=e,this.exceptionMonitor=new BY,this.exceptionMonitor.on("exception",((n,i,r)=>{this.onStatsException&&this.onStatsException(n,i,r)}))}startUpdateStats(){this.updateStatsInterval||(this.updateStatsInterval=window.setInterval(this.updateStats,1e3))}stopUpdateStats(){this.updateStatsInterval&&(window.clearInterval(this.updateStatsInterval),this.updateStatsInterval=void 0)}reset(){this.localStats=new Map,this.remoteStats=new Map,this.trafficStats=void 0,this.trafficStatsPeerList=[],this.uplinkStats=void 0}getLocalAudioTrackStats(){return this.localStats.get(tt.LocalAudioTrack)||fc({},gS)}getLocalVideoTrackStats(){return this.localStats.get(tt.LocalVideoTrack)||fc({},SS)}getRemoteAudioTrackStats(e){const n=(s,o)=>{if(!this.trafficStats)return o;const a=this.trafficStats.peer_delay.find((c=>c.peer_uid===s));return a&&(o.publishDuration=a.B_ppad+(Date.now()-this.trafficStats.timestamp)),o},i={};if(e){var r;const s=(r=this.remoteStats.get(e))===null||r===void 0?void 0:r.audioStats;s&&(i[e]=n(e,s))}else Array.from(this.remoteStats.entries()).forEach((s=>{let[o,{audioStats:a}]=s;a&&(i[o]=n(o,a))}));return i}getRemoteNetworkQualityStats(e){const n={};if(e){var i;const r=(i=this.remoteStats.get(e))===null||i===void 0?void 0:i.networkStats;r&&(n[e]=r)}else Array.from(this.remoteStats.entries()).forEach((r=>{let[s,{networkStats:o}]=r;o&&(n[s]=o)}));return n}getNetworkQuality(){let e=0,n=0;return this.trafficStats&&(e=y_(this.trafficStats.B_unq),n=y_(this.trafficStats.B_dnq)),{uplinkNetworkQuality:e,downlinkNetworkQuality:n}}getRemoteVideoTrackStats(e){const n=(s,o)=>{if(!this.trafficStats)return o;const a=this.trafficStats.peer_delay.find((c=>c.peer_uid===s));return a&&(o.publishDuration=a.B_ppvd+(Date.now()-this.trafficStats.timestamp)),o},i={};if(e){var r;const s=(r=this.remoteStats.get(e))===null||r===void 0?void 0:r.videoStats;s&&(i[e]=n(e,s))}else Array.from(this.remoteStats.entries()).forEach((s=>{let[o,{videoStats:a}]=s;a&&(i[o]=n(o,a))}));return i}getRTCStats(){let e=0,n=0,i=0,r=0;const s=this.localStats.get(tt.LocalAudioTrack);s&&(e+=s.sendBytes,n+=s.sendBitrate);const o=this.localStats.get(tt.LocalVideoTrack);o&&(e+=o.sendBytes,n+=o.sendBitrate);const a=this.localStats.get(tt.LocalVideoLowTrack);a&&(e+=a.sendBytes,n+=a.sendBitrate),this.remoteStats.forEach((d=>{let{audioStats:l,videoStats:h}=d;l&&(i+=l.receiveBytes,r+=l.receiveBitrate),h&&(i+=h.receiveBytes,r+=h.receiveBitrate)}));let c=1;return this.trafficStats&&(c+=this.trafficStats.peer_delay.length),{Duration:0,UserCount:c,SendBitrate:n,SendBytes:e,RecvBytes:i,RecvBitrate:r,OutgoingAvailableBandwidth:this.uplinkStats?this.uplinkStats.B_uab/1e3:0,RTT:this.trafficStats?2*this.trafficStats.B_acd:0}}addLocalStats(e){this.localStats.set(e,void 0)}removeLocalStats(e){e?this.localStats.delete(e):this.localStats.clear()}addRemoteStats(e){this.remoteStats.set(e,{})}removeRemoteStats(e){e?this.remoteStats.delete(e):this.remoteStats.clear()}addP2PChannel(e){this.p2pChannel=e}updateTrafficStats(e){e.peer_delay=e.peer_delay.filter((n=>n.B_ppad!==void 0||n.B_ppvd!==void 0)),e.peer_delay.filter((n=>this.trafficStatsPeerList.indexOf(n.peer_uid)===-1)).forEach((n=>{var i;const r=(i=this.p2pChannel)===null||i===void 0?void 0:i.getRemoteMedia(n.peer_uid),s=r!=null&&r.videoSSRC?ni.measureFromSubscribeStart(this.store.clientId,r.videoSSRC):0,o=r!=null&&r.audioSSRC?ni.measureFromSubscribeStart(this.store.clientId,r.audioSSRC):0;n.B_ppad!==void 0&&n.B_ppvd!==void 0&&(this.onUploadPublishDuration&&this.onUploadPublishDuration(n.peer_uid,n.B_ppad,n.B_ppvd,s>o?s:o),this.trafficStatsPeerList.push(n.peer_uid))})),this.trafficStats=e}updateUplinkStats(e){this.uplinkStats&&this.uplinkStats.B_fir!==e.B_fir&&m.debug("[".concat(this.store.clientId,"]: Period fir changes to ").concat(e.B_fir)),this.uplinkStats=e}static isRemoteVideoFreeze(e,n,i){if(!e)return!1;const r=!!i&&n.framesDecodeFreezeTime>i.framesDecodeFreezeTime,s=!i||n.framesDecodeCount>i.framesDecodeCount;return r||!s}static isRemoteAudioFreeze(e){return!!e&&e._isFreeze()}isLocalVideoFreeze(e){return!(!e.inputFrame||!e.sentFrame)&&e.inputFrame.frameRate>5&&e.sentFrame.frameRate<3}updateLocalStats(e){Array.from(this.localStats.entries()).forEach((n=>{let[i,r]=n;switch(i){case tt.LocalVideoTrack:case tt.LocalVideoLowTrack:{const a=r,c=fc({},SS),d=e.getStats(),l=e.getLocalMedia(i);if(d){const h=d.videoSend.find((p=>p.ssrc===l?.ssrcs[0].ssrcId));if(h){const p=e.getLocalVideoSize(),f=e.getEncoderConfig(tt.LocalVideoTrack);var s;(h.codec==="H264"||h.codec==="H265"||h.codec==="VP8"||h.codec==="VP9"||h.codec==="AV1X"||h.codec==="AV1")&&(c.codecType=h.codec,a?.codecType!==h.codec&&((s=this.onVideoCodecChanged)===null||s===void 0||s.call(this,h.codec.toLocaleLowerCase()))),c.sendBytes=h.bytes,c.sendBitrate=a?8*Math.max(0,c.sendBytes-a.sendBytes):0,h.inputFrame?(c.captureFrameRate=h.inputFrame.frameRate,c.captureResolutionHeight=h.inputFrame.height,c.captureResolutionWidth=h.inputFrame.width):p&&(c.captureResolutionWidth=p.width,c.captureResolutionHeight=p.height),h.sentFrame?(c.sendFrameRate=h.sentFrame.frameRate,c.sendResolutionHeight=h.sentFrame.height,c.sendResolutionWidth=h.sentFrame.width):p&&(c.sendResolutionWidth=p.width,c.sendResolutionHeight=p.height),h.avgEncodeMs&&(c.encodeDelay=h.avgEncodeMs),f&&f.bitrateMax?c.targetSendBitrate=1e3*f.bitrateMax:h.targetBitrate&&(c.targetSendBitrate=h.targetBitrate),c.sendPackets=h.packets,c.sendPacketsLost=h.packetsLost,c.sendJitterMs=h.jitterMs,c.sendRttMs=h.rttMs,c.totalDuration=a?a.totalDuration+1:1,c.totalFreezeTime=a?a.totalFreezeTime:0,this.isLocalVideoFreeze(h)&&(c.totalFreezeTime+=1),h.scalabilityMode&&this.scalabilityMode!==h.scalabilityMode&&(m.debug("[".concat(this.store.clientId,"]: The scalabilityMode of the video sending stream is ").concat(h.scalabilityMode)),this.scalabilityMode=h.scalabilityMode)}this.trafficStats&&(c.currentPacketLossRate=(this.trafficStats.B_pvlr4||0)/100)}var o;this.localStats.set(i,c),(a?.sendResolutionWidth!==c.sendResolutionWidth||a?.sendResolutionHeight!==c.sendResolutionHeight)&&((o=this.onStatsChanged)===null||o===void 0||o.call(this,"resolution",{width:c.sendResolutionWidth,height:c.sendResolutionHeight})),c&&l&&this.exceptionMonitor.setLocalVideoStats(this.store.uid,l.track,c);break}case tt.LocalAudioTrack:{const a=r,c=fc({},gS),d=e.getStats(),l=e.getLocalMedia(i);if(d){const h=d.audioSend.find((p=>p.ssrc===l?.ssrcs[0].ssrcId));if(h){if(h.codec!=="opus"&&h.codec!=="aac"&&h.codec!=="PCMU"&&h.codec!=="PCMA"&&h.codec!=="G722"||(c.codecType=h.codec),h.inputLevel)c.sendVolumeLevel=Math.round(32767*h.inputLevel);else{const p=e.getLocalAudioVolume();p&&(c.sendVolumeLevel=Math.round(32767*p))}c.sendBytes=h.bytes,c.sendPackets=h.packets,c.sendPacketsLost=h.packetsLost,c.sendJitterMs=h.jitterMs,c.sendRttMs=h.rttMs,c.sendBitrate=a?8*Math.max(0,c.sendBytes-a.sendBytes):0}}this.trafficStats&&(c.currentPacketLossRate=(this.trafficStats.B_palr4||0)/100),this.localStats.set(tt.LocalAudioTrack,c),c&&l&&this.exceptionMonitor.setLocalAudioStats(this.store.uid,l.track,c);break}}}))}updateRemoteStats(e){Array.from(this.remoteStats.entries()).forEach((n=>{var i,r;let[s,{videoStats:o,audioStats:a,videoPcStats:c}]=n;const d=a,l=o,h=c,p=fc({},f0),f=fc({},m0),v=fc({},I8),{audioTrack:S,videoTrack:T,audioSSRC:b,videoSSRC:w}=e.getRemoteMedia(s);let D;D=this.store.useP2P?e.getStats(!0):e.getStats();const k=(i=D)===null||i===void 0?void 0:i.audioRecv.find((q=>q.ssrc===b)),U=(r=D)===null||r===void 0?void 0:r.videoRecv.find((q=>q.ssrc===w)),P=this.trafficStats&&this.trafficStats.peer_delay.find((q=>q.peer_uid===s));if(k&&(k.codec!=="opus"&&k.codec!=="aac"&&k.codec!=="PCMU"&&k.codec!=="PCMA"&&k.codec!=="G722"||(p.codecType=k.codec),k.outputLevel?p.receiveLevel=Math.round(32767*k.outputLevel):S&&(p.receiveLevel=Math.round(32767*S.getVolumeLevel())),p.receiveBytes=k.bytes,p.receivePackets=k.packets,p.receivePacketsLost=k.packetsLost,p.receivePacketsDiscarded=k.packetsDiscarded,p.packetLossRate=p.receivePacketsLost/(p.receivePackets+p.receivePacketsLost),p.receiveBitrate=d?8*Math.max(0,p.receiveBytes-d.receiveBytes):0,p.totalDuration=d?d.totalDuration+1:1,p.totalFreezeTime=d?d.totalFreezeTime:0,p.freezeRate=p.totalFreezeTime/p.totalDuration,p.receiveDelay=k.jitterBufferMs,p.totalDuration>10&&vu.isRemoteAudioFreeze(S)&&(p.totalFreezeTime+=1)),U){var x;U.codec!=="H264"&&U.codec!=="H265"&&U.codec!=="VP8"&&U.codec!=="VP9"&&U.codec!=="AV1X"&&U.codec!=="AV1"||(f.codecType=U.codec),f.receiveBytes=U.bytes,f.receiveBitrate=l?8*Math.max(0,f.receiveBytes-l.receiveBytes):0,f.decodeFrameRate=U.decodeFrameRate<0?0:U.decodeFrameRate,f.renderFrameRate=U.decodeFrameRate<0?0:U.decodeFrameRate,U.outputFrame&&(f.renderFrameRate=U.outputFrame.frameRate),U.receivedFrame?(f.receiveFrameRate=U.receivedFrame.frameRate,f.receiveResolutionHeight=U.receivedFrame.height,f.receiveResolutionWidth=U.receivedFrame.width):T&&(f.receiveResolutionHeight=T._videoHeight||0,f.receiveResolutionWidth=T._videoWidth||0),U.framesRateFirefox!==void 0&&(f.receiveFrameRate=Math.round(U.framesRateFirefox)),f.receivePackets=U.packets,f.receivePacketsLost=U.packetsLost,f.packetLossRate=f.receivePacketsLost/(f.receivePackets+f.receivePacketsLost);const q=l?l.totalFreezeTime:0,Q=l?l.totalDuration:0;f.totalDuration=l?l.totalDuration+1:1,f.totalFreezeTime=(x=U.totalFreezesDuration)!==null&&x!==void 0?x:q||0,f.receiveDelay=U.jitterBufferMs||0;const dt=!!w&&e.getRemoteVideoIsReady(w);U.totalFreezesDuration===void 0&&T&&dt&&vu.isRemoteVideoFreeze(T,U,h)&&(f.totalFreezeTime+=1),f.freezeRate=Math.max(0,Math.min((f.totalFreezeTime-q)/(f.totalDuration-Q),1))}P&&(p.end2EndDelay=P.B_ad,f.end2EndDelay=P.B_vd,p.transportDelay=P.B_ed,f.transportDelay=P.B_ed,p.currentPacketLossRate=P.B_ealr4/100,f.currentPacketLossRate=P.B_evlr4/100,v.uplinkNetworkQuality=P.B_punq?P.B_punq:0,v.downlinkNetworkQuality=P.B_pdnq?P.B_pdnq:0),this.remoteStats.set(s,{audioStats:p,videoStats:f,videoPcStats:U,networkStats:v}),S&&this.exceptionMonitor.setRemoteAudioStats(S,p),T&&this.exceptionMonitor.setRemoteVideoStats(T,f)}))}}class yP{constructor(){R(this,"destChannelMediaInfos",new Map),R(this,"srcChannelMediaInfo",void 0)}setSrcChannelInfo(e){kD(e),this.srcChannelMediaInfo=e}addDestChannelInfo(e){kD(e),this.destChannelMediaInfos.set(e.channelName,e)}removeDestChannelInfo(e){E_(e),this.destChannelMediaInfos.delete(e)}getSrcChannelMediaInfo(){return this.srcChannelMediaInfo}getDestChannelMediaInfo(){return this.destChannelMediaInfos}}function IP(t){if(!(t instanceof yP))return new B(A.INVALID_PARAMS,"Config should be instance of [ChannelMediaRelayConfiguration]").throw();const e=t.getSrcChannelMediaInfo(),n=t.getDestChannelMediaInfo();if(!e)return new B(A.INVALID_PARAMS,"srcChannelMediaInfo should not be empty").throw();if(n.size===0)return new B(A.INVALID_PARAMS,"destChannelMediaInfo should not be empty").throw()}class _a{get hasVideo(){return this._video_enabled_&&!this._video_muted_&&this._video_added_}get hasAudio(){return this._audio_enabled_&&!this._audio_muted_&&this._audio_added_}get audioTrack(){if(this.hasAudio||this._audio_pre_subscribed)return this._audioTrack}get videoTrack(){if(this.hasVideo||this._video_pre_subscribed)return this._videoTrack}get dataChannels(){return this._dataChannels}constructor(e,n){R(this,"uid",void 0),R(this,"_uintid",void 0),R(this,"_trust_in_room_",!0),R(this,"_trust_audio_enabled_state_",!0),R(this,"_trust_video_enabled_state_",!0),R(this,"_trust_audio_mute_state_",!0),R(this,"_trust_video_mute_state_",!0),R(this,"_audio_muted_",!1),R(this,"_video_muted_",!1),R(this,"_audio_enabled_",!0),R(this,"_video_enabled_",!0),R(this,"_audio_added_",!1),R(this,"_video_added_",!1),R(this,"_is_pre_created",!1),R(this,"_video_pre_subscribed",!1),R(this,"_audio_pre_subscribed",!1),R(this,"_trust_video_stream_added_state_",!0),R(this,"_trust_audio_stream_added_state_",!0),R(this,"_audioTrack",void 0),R(this,"_videoTrack",void 0),R(this,"_dataChannels",[]),R(this,"_audioSSRC",void 0),R(this,"_videoSSRC",void 0),R(this,"_audioOrtc",void 0),R(this,"_videoOrtc",void 0),R(this,"_cname",void 0),R(this,"_rtxSsrcId",void 0),R(this,"_videoMid",void 0),R(this,"_audioMid",void 0),this.uid=e,this._uintid=n}}function bP(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable}))),n.push.apply(n,i)}return n}function mT(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?bP(Object(n),!0).forEach((function(i){R(t,i,n[i])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):bP(Object(n)).forEach((function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i))}))}return t}const jY=t=>`v=0
o=- 0 0 IN IP4 127.0.0.1
s=AgoraGateway
t=0 0
a=group:BUNDLE 0 1 2
a=msid-semantic: WMS
a=ice-lite`.concat(t?`
a=extmap-allow-mixed`:"",`
m=video 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendonly
a=rtcp-mux
a=rtcp-rsize
a=mid:0
m=audio 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendonly
a=rtcp-mux
a=rtcp-rsize
a=mid:1
m=application 9 UDP/DTLS/SCTP webrtc-datachannel
c=IN IP4 127.0.0.1
a=mid:2
`),k_="9",ET=2e4,M_=4e4;let AP=class{get localCapabilities(){return Ve(this._localCapabilities)}get rtpCapabilities(){return Ve(this._rtpCapabilities)}get candidates(){return Ve(this._candidates)}get iceParameters(){return Ve(this._iceParameters)}get dtlsParameters(){return Ve(this._dtlsParameters)}constructor(t){let e=arguments.length>1&&arguments[1]!==void 0&&arguments[1],n=arguments.length>2&&arguments[2]!==void 0&&arguments[2],i=arguments.length>3&&arguments[3]!==void 0&&arguments[3];R(this,"sessionDesc",void 0),R(this,"_localCapabilities",void 0),R(this,"_rtpCapabilities",void 0),R(this,"_candidates",void 0),R(this,"_originCandidates",void 0),R(this,"_iceParameters",void 0),R(this,"_isUseExtmapAllowMixed",void 0),R(this,"_isUseLocalCodecs",void 0),R(this,"_isUseDataChannel",void 0),R(this,"_dtlsParameters",void 0),R(this,"setup",void 0),R(this,"currentMidIndex",void 0),R(this,"cname",void 0),R(this,"useLocalCodecsMids",[]),R(this,"preloadSsrcs",[]),R(this,"firefoxSsrcMidMap",new Map),this._isUseExtmapAllowMixed=e,this._isUseLocalCodecs=n,this._isUseDataChannel=i,t=Ve(t);const{iceParameters:r,dtlsParameters:s,candidates:o,rtpCapabilities:a,setup:c,localCapabilities:d,cname:l}=t;this._rtpCapabilities=a,this._candidates=o,this._originCandidates=Ve(o),this._iceParameters=r,this._dtlsParameters=s,this._localCapabilities=d,this.setup=c,this.cname=l,[this.sessionDesc]=this.updateRemoteRTPCapabilities(a),this.currentMidIndex=this.sessionDesc.mediaDescriptions.length-1}checkPreloadSsrcs(t){return t.length===this.preloadSsrcs.length&&t.every((e=>{var n;return $(n=this.preloadSsrcs).call(n,e)}))}preloadRemoteMedia(t){let e=0;const n=[],i=[];for(;t>0;){const r=[mT({ssrcId:M_+e},I("USE_SUB_RTX")?{rtx:M_+e+1}:{})],s="".concat(M_+e,"_").concat(ET+e),{ssrcs:o,ssrcGroups:a}=Eu(r,this.cname,I("SYNC_GROUP")?s:void 0),c=this.preCreateOrRecycleSendMedia("video",o,a,void 0),d=[{ssrcId:ET+e}],l="".concat(M_+e,"_").concat(ET+e),{ssrcs:h,ssrcGroups:p}=Eu(d,this.cname,I("SYNC_GROUP")?l:void 0),f=this.preCreateOrRecycleSendMedia("audio",h,p,void 0);t--,e+=2,n.push(c,f),i.push(o[0].ssrcId,h[0].ssrcId)}return this.useLocalCodecsMids.push(...n),this.preloadSsrcs=i,{mids:n,preSSRCs:i,isAvailable:!0}}preCreateOrRecycleSendMedia(t,e,n,i){const r=this.rtpCapabilities.send.videoCodecs,s=this._isUseLocalCodecs||r.length===0?this.localCapabilities.recv:this.rtpCapabilities.send;m.debug("create or recycle send media without remote rtp capabilities, ssrcs ",e[0].ssrcId);const o=t===ut.VIDEO?s.videoCodecs:s.audioCodecs,a=t===ut.VIDEO?s.videoExtensions:s.audioExtensions;this.currentMidIndex+=1;const c="".concat(this.currentMidIndex);let d={media:{mediaType:t,port:k_,protos:["UDP","TLS","RTP","SAVPF"],fmts:o.map((l=>l.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:a,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:e,ssrcGroups:n,rtcpFeedbackWildcards:[],payloads:o,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(c)}};return d=this.mungSendMediaDesc(d,i),this.sessionDesc.mediaDescriptions.push(d),this.updateBundleMids(),c}toString(){return Oo(this.sessionDesc)}send(t,e,n,i){const{ssrcs:r,ssrcGroups:s}=Eu(e,this.cname,I("SYNC_GROUP")?n:void 0),o=this.findPreloadMediaDesc(r);if(o){if(xe()&&this.firefoxSsrcMidMap.set(r[0].ssrcId,o.attributes.mid),i&&(i.twcc||i.remb)){const a=this.sessionDesc.mediaDescriptions.indexOf(o);return this.sessionDesc.mediaDescriptions[a]=this.mungSendMediaDesc(o,i),{mid:o.attributes.mid,needExchangeSDP:!0}}return{mid:o.attributes.mid,needExchangeSDP:!1}}{const a=this.findAvailableMediaIndex(t,r);let c;return a===-1||a===1&&(Mn()||(function(){const d=de();return!(d.name!==he.CHROME||!d.osVersion)&&Number(d.version)<=90})()||I("ENABLE_ENCODED_TRANSFORM")&&Ao())||a===0&&!(function(d){const l=de();return!(l.name!==he.FIREFOX||!l.osVersion)&&Number(l.version)===d})(138)&&I("USE_SUB_RTX")||vO()?(c=this.createOrRecycleSendMedia(t,r,s,"sendonly",i),this.updateBundleMids()):(c=Ve(this.sessionDesc.mediaDescriptions[a]),c.attributes.direction="sendonly",c.attributes.ssrcs=r,c.attributes.ssrcGroups=s,this.sessionDesc.mediaDescriptions[a]=this.mungSendMediaDesc(c,i)),xe()&&this.firefoxSsrcMidMap.set(r[0].ssrcId,c.attributes.mid),{mid:c.attributes.mid,needExchangeSDP:!0}}}sendDataChannel(){const{mediaDesc:t,needExchangeSDP:e}=this.createOrRecycleDataChannel();return this.updateBundleMids(),{mid:t.attributes.mid,needExchangeSDP:e}}batchSend(t){const e=t.map((r=>{let{kind:s,ssrcMsg:o,mslabel:a}=r;return this.send(s,o,a)})),n=[];let i=!1;return e.forEach((r=>{let{mid:s,needExchangeSDP:o}=r;o&&(i=!0),n.push(s)})),{mids:n,needExchangeSDP:i}}stopSending(t){const e=this.sessionDesc.mediaDescriptions.filter((n=>n.attributes.mid&&t.indexOf(n.attributes.mid)!==-1));if(e.length!==t.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.stopSending.");e.forEach((n=>{n.attributes.mid==="0"||xe()||vO()?n.attributes.ssrcs=[]:(n.attributes.ssrcs=[],n.attributes.direction="inactive",n.media.port="0")})),this.updateBundleMids()}mute(t){const e=this.sessionDesc.mediaDescriptions.find((n=>n.attributes.mid===t));if(!e)throw new Error("mediaDescription not found with ".concat(t," in remote SDP when calling RemoteSDP.mute."));e.attributes.direction="inactive"}unmute(t){const e=this.sessionDesc.mediaDescriptions.find((n=>n.attributes.mid===t));if(!e)throw new Error("mediaDescription not found with ".concat(t," in remote SDP when calling RemoteSDP.unmute."));e.attributes.direction="sendonly"}muteRemote(t){const e=this.sessionDesc.mediaDescriptions.filter((n=>$(t).call(t,n.attributes.mid||"")));if(e.length!==t.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");e.forEach((n=>{n.attributes.direction="inactive"}))}unmuteRemote(t){const e=this.sessionDesc.mediaDescriptions.filter((n=>$(t).call(t,n.attributes.mid||"")));if(e.length!==t.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");e.forEach((n=>{n.attributes.direction="recvonly"}))}receive(t,e,n,i){t.forEach(((r,s)=>{this.createOrRecycleRecvMedia(r,[],"recvonly",e,n,i[s])})),this.updateBundleMids()}stopReceiving(t){const e=this.sessionDesc.mediaDescriptions.filter((n=>t.indexOf(n.attributes.mid)!==-1));if(e.length!==t.length)throw new Error("MediaDescriptions' length doesn't match mids's length when calling RemoteSDP.receive.");e.forEach((n=>{n.media.port="0",n.attributes.direction="inactive"})),this.updateBundleMids()}updateRemoteRTPCapabilities(t){const e=this.sessionDesc||Ei((n=this._isUseExtmapAllowMixed,this._isUseDataChannel?jY(n):`v=0
o=- 0 0 IN IP4 127.0.0.1
s=AgoraGateway
t=0 0
a=group:BUNDLE 0 1
a=msid-semantic: WMS
a=ice-lite`.concat(n?`
a=extmap-allow-mixed`:"",`
m=video 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendonly
a=rtcp-mux
a=rtcp-rsize
a=mid:0
m=audio 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendonly
a=rtcp-mux
a=rtcp-rsize
a=mid:1
`)));var n;this._rtpCapabilities=t;let i=!1;const r=this.rtpCapabilities.send,s=this.localCapabilities.send,o=this.localCapabilities.recv,a=o.videoCodecs,c=o.audioCodecs,d=o.videoExtensions,l=o.audioExtensions;for(const v of e.mediaDescriptions){var h;if(v.attributes.direction!=="sendonly"||typeof v.attributes.mid!="string"||!$(h=this.useLocalCodecsMids).call(h,v.attributes.mid)){if(i=!0,v.attributes.iceUfrag=this._iceParameters.iceUfrag,v.attributes.icePwd=this._iceParameters.icePwd,v.attributes.fingerprints=this._dtlsParameters.fingerprints,v.attributes.candidates=this._candidates,v.attributes.setup=this.setup,v.media.mediaType==="application"&&(v.attributes.sctpPort="5000"),v.media.mediaType==="video")if(this._isUseLocalCodecs&&v.attributes.direction==="sendonly"){var p;v.media.fmts=a.map((T=>T.payloadType.toString(10))),v.attributes.payloads=a,v.attributes.extmaps=d;const S=v.attributes.mid;typeof S!="string"||$(p=this.useLocalCodecsMids).call(p,S)||this.useLocalCodecsMids.push(S)}else if(r.videoCodecs.length===0){const S=s.videoCodecs.filter((T=>{var b,w;return(b=T.rtpMap)===null||b===void 0?void 0:$(w=b.encodingName.toLowerCase()).call(w,"vp8")}));S.length===0&&S.push(s.videoCodecs[0]),v.media.fmts=S.map((T=>T.payloadType.toString(10))),v.attributes.payloads=S,v.attributes.extmaps=[]}else v.media.fmts=r.videoCodecs.map((S=>S.payloadType.toString(10))),v.attributes.payloads=r.videoCodecs,v.attributes.extmaps=r.videoExtensions;if(v.media.mediaType==="audio")if(this._isUseLocalCodecs&&v.attributes.direction==="sendonly"){var f;v.media.fmts=c.map((T=>T.payloadType.toString(10))),v.attributes.payloads=c,v.attributes.extmaps=l;const S=v.attributes.mid;typeof S!="string"||$(f=this.useLocalCodecsMids).call(f,S)||this.useLocalCodecsMids.push(S)}else if(r.audioCodecs.length===0){const S=s.audioCodecs.filter((T=>{var b,w;return(b=T.rtpMap)===null||b===void 0?void 0:$(w=b.encodingName.toLowerCase()).call(w,"opus")}))||[s.audioCodecs[0]];v.media.fmts=S.map((T=>T.payloadType.toString(10))),v.attributes.payloads=S,v.attributes.extmaps=[]}else v.media.fmts=r.audioCodecs.map((S=>S.payloadType.toString(10))),v.attributes.payloads=r.audioCodecs,v.attributes.extmaps=r.audioExtensions,Gd(v)}}return this.sessionDesc=e,this.currentMidIndex=e.mediaDescriptions.length-1,[this.sessionDesc,i]}updateCandidates(t){const e=this._originCandidates.filter((i=>i.transport==="udp")),n=[];if(e.forEach((i=>{n.push(mT(mT({},i),{},{foundation:"tcpcandidate",priority:Number(i.priority)-1+"",transport:"tcp",port:Number(i.port)+90+""}))})),e.length!==0){switch(t){case xn.TCP_RELAY:this._candidates=n;break;case xn.UDP_TCP_RELAY:case xn.RELAY:this._candidates=[...e,...n];break;default:this._candidates=e}for(const i of this.sessionDesc.mediaDescriptions)i.attributes.candidates=this.candidates}}restartICE(t){t=Ve(t),this._iceParameters=t,this.sessionDesc.mediaDescriptions.forEach((e=>{e.attributes.iceUfrag=t.iceUfrag,e.attributes.icePwd=t.icePwd}))}predictReceivingMids(t){const e=[];for(let n=0;n<t;n++)e.push((this.currentMidIndex+n+1).toString(10));return e}findAvailableMediaIndex(t,e){return this.sessionDesc.mediaDescriptions.findIndex((n=>{const i=n.media.mediaType===t&&n.media.port!=="0"&&(n.attributes.direction==="sendonly"||n.attributes.direction==="sendrecv")&&n.attributes.ssrcs.length===0;if(xe()){if(i){const r=this.firefoxSsrcMidMap.get(e[0].ssrcId);return!(r||n.attributes.mid!=="0"&&n.attributes.mid!=="1")||!(!r||r!==n.attributes.mid)}return!1}return i}))}createOrRecycleDataChannel(){for(const n of this.sessionDesc.mediaDescriptions)if(n.media.mediaType==="application")return{mediaDesc:n,needExchangeSDP:!1};this.currentMidIndex+=1;const t="".concat(this.currentMidIndex),e={media:{mediaType:"application",port:k_,protos:["UDP","DTLS","SCTP"],fmts:["webrtc-datachannel"]},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:[],fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:[],ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:[],rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,mid:"".concat(t),sctpPort:"5000"}};return this.sessionDesc.mediaDescriptions.push(e),{mediaDesc:e,needExchangeSDP:!0}}createOrRecycleRecvMedia(t,e,n,i,r,s){const o=t._mediaStreamTrack.kind,a=this.rtpCapabilities.recv,c=Su(o,a,this.localCapabilities.send,o===ut.VIDEO?i:r),d=o===ut.VIDEO?a.videoExtensions:a.audioExtensions;this.currentMidIndex+=1;const l="".concat(this.currentMidIndex);let h={media:{mediaType:o,port:k_,protos:["UDP","TLS","RTP","SAVPF"],fmts:c.map((f=>f.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:d,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:e,ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:c,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:n,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(l)}};h=this.mungRecvMediaDsec(h,t,s);const p=this.findFirstClosedMedia(o);if(p){const f=this.sessionDesc.mediaDescriptions.indexOf(p);this.sessionDesc.mediaDescriptions[f]=h}else this.sessionDesc.mediaDescriptions.push(h);return h}updateRemoteDtlsParameters(t){const e=new Set(this._dtlsParameters.fingerprints.map((r=>r.fingerprint))),n=new Set(t.map((r=>r.fingerprint)));let i=!1;e.size!==n.size&&(i=!0);for(const r of e)n.has(r)||(i=!0);return i}updateRemoteCodec(t,e,n){const i=[...new Set(this._rtpCapabilities.recv.videoCodecs.map((h=>h.rtpMap&&h.rtpMap.encodingName.toLowerCase()||"")).filter((h=>{var p;return $(p=Object.keys(ic)).call(p,h)})))],r=new Set(e);if(i.every((h=>r.has(h))))return m.debug("codecs has not changed, no need to updateRemoteCodec, codecs: ".concat(e)),!1;const s=this._rtpCapabilities.recv.videoCodecs.filter((h=>e.some((p=>{var f;return $(f=h.rtpMap&&h.rtpMap.encodingName.toLowerCase()||"").call(f,p)}))));if(s.length===0)return m.debug("updateRemoteCodec failed, because cannot find matched codec, remoteCapabilities codecs: ".concat(i," codecs: ").concat(e)),!1;const o=[...new Set(s.map((h=>h.rtpMap&&h.rtpMap.encodingName.toLowerCase()||"")))];let a;if(m.debug("updateRemoteCodec, from ".concat(i," to ").concat(o)),t.length===0)a=this.sessionDesc.mediaDescriptions.filter((h=>h.media.mediaType==="video"&&h.attributes.direction==="recvonly"));else if(a=this.sessionDesc.mediaDescriptions.filter((h=>h.attributes.mid&&h.media.mediaType==="video"&&$(t).call(t,h.attributes.mid)&&h.attributes.direction==="recvonly")),a.length!==t.length)return m.debug("updateRemoteCodec failed, because cannot find mids, mids: ".concat(t,", codecs: ").concat(e)),!1;if(I("USE_PUB_RTX")||I("USE_SUB_RTX")){const h=pa(s,this.rtpCapabilities.recv.videoCodecs);s.push(...h)}this._rtpCapabilities.recv.videoCodecs=s;const c=this.localCapabilities.send,d=this.rtpCapabilities.recv,l=Su(ut.VIDEO,d,c,n);return a.forEach((h=>{const p=l.map((f=>f.payloadType.toString(10)));m.debug("updateRemoteCodec mid: ".concat(h.attributes.mid,", from"),h.attributes.payloads,"to",l),h.attributes.payloads=l,h.media.fmts=p})),m.debug("updateRemoteCodec success, mids: ".concat(t,", codecs: ").concat(e,", remote recv: ").concat(this._rtpCapabilities.recv.videoCodecs.length,", remote send: ").concat(this._rtpCapabilities.send.videoCodecs.length)),!0}createOrRecycleSendMedia(t,e,n,i,r){const s=this.rtpCapabilities.send.videoCodecs,o=this._isUseLocalCodecs||s.length===0?this.localCapabilities.recv:this.rtpCapabilities.send,a=t===ut.VIDEO?o.videoCodecs:o.audioCodecs,c=t===ut.VIDEO?o.videoExtensions:o.audioExtensions;this.currentMidIndex+=1;const d="".concat(this.currentMidIndex);let l={media:{mediaType:t,port:k_,protos:["UDP","TLS","RTP","SAVPF"],fmts:a.map((p=>p.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:c,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:e,ssrcGroups:n,rtcpFeedbackWildcards:[],payloads:a,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:i,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(d)}};l=this.mungSendMediaDesc(l,r);const h=this.findFirstClosedMedia(t);if(h){const p=this.sessionDesc.mediaDescriptions.indexOf(h);this.sessionDesc.mediaDescriptions[p]=l}else this.sessionDesc.mediaDescriptions.push(l);return l}updateBundleMids(){this.sessionDesc.attributes.groups[0].identificationTag=this.sessionDesc.mediaDescriptions.filter((t=>t.media.port!=="0")).map((t=>t.attributes.mid))}mungRecvMediaDsec(t,e,n){const i=Ve(t);return eT(i),_c(i,e),nT(i,e),eP(i),A_(i,n,this.localCapabilities.send),i}mungSendMediaDesc(t,e){const n=Ve(t);return n.attributes&&n.attributes.payloads&&Array.isArray(n.attributes.payloads)&&n.attributes.payloads.length>0&&n.attributes.payloads.forEach((i=>{i.rtpMap&&i.rtpMap.encodingName.toLocaleLowerCase()==="h264"&&I("ENABLE_DOWN_SPS_PPS")&&(i.fmtp&&i.fmtp.parameters||(i.fmtp={parameters:{}}),i.fmtp.parameters["sps-pps-idr-in-keyframe"]="1")})),A_(n,e,this.localCapabilities.recv),Gd(n),n}updateRecvMedia(t,e){const n=this.sessionDesc.mediaDescriptions.findIndex((i=>i.attributes.mid===t));if(n!==-1){const i=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[n],e);this.sessionDesc.mediaDescriptions[n]=i}}bumpMid(t){this.currentMidIndex+=t}findFirstClosedMedia(t){return this.sessionDesc.mediaDescriptions.find((e=>xe()?e.media.port==="0"&&e.media.mediaType===t:e.media.port==="0"))}findPreloadMediaDesc(t){return this.sessionDesc.mediaDescriptions.find((e=>{var n;return((n=e.attributes)===null||n===void 0||(n=n.ssrcs[0])===null||n===void 0?void 0:n.ssrcId)===t[0].ssrcId}))}getSSRC(t){var e;return(e=this.sessionDesc.mediaDescriptions.find((n=>n.attributes.mid===t)))===null||e===void 0?void 0:e.attributes.ssrcs}};function wP(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable}))),n.push.apply(n,i)}return n}function Lo(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?wP(Object(n),!0).forEach((function(i){R(t,i,n[i])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):wP(Object(n)).forEach((function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i))}))}return t}var Kd=(function(t){return t[t.DOWN=0]="DOWN",t[t.UP=1]="UP",t})(Kd||{});const U_=new Map;function OP(t,e,n,i){let{scale:r}=t;if(r===0&&i===Kd.UP||r>=e.length-1&&i===Kd.DOWN)return t;let s=Lo(Lo({},t),{},{scale:i===Kd.DOWN?++r:--r});switch(n){case"maintain-framerate":s=Lo(Lo({},s),e[r].motion);break;case"maintain-resolution":s=Lo(Lo({},s),e[r].detail);break;case"balanced":s=Lo(Lo({},s),e[r].balanced)}return s}function NP(t,e){if(e){const n={overUse:0,underUse:0,adaptationList:DP(e)};U_.set(t,n)}else U_.delete(t)}function DP(t){const e=Lo({},t),{bitrateMax:n,frameRate:i,scaleResolutionDownBy:r,bitrateMin:s}=e,{MIN_FRAME_RATE:o,MAX_THRESHOLD_FRAMERATE:a,MAX_SCALE:c,BITRATE_MIN_THRESHOLD:d,BITRATE_MAX_THRESHOLD:l,BWE_SCALE_UP_THRESHOLD:h,BWE_SCALE_DOWN_THRESHOLD:p,PERF_SCALE_DOWN_THRESHOLD:f,PERF_SCALE_UP_THRESHOLD:v,BALANCE_BITRATE_FACTOR:S,BALANCE_FRAMERATE_FACTOR:T,BALANCE_RESOLUTION_FACTOR:b,MOTION_RESOLUTION_FACTOR:w,MOTION_BITRATE_FACTOR:D,DETAIL_FRAMERATE_FACTOR:k,DETAIL_BITRATE_FACTOR:U}=lS,P=Math.min(e.frameRate,a),x=[{scale:0,threshold:{bwe_down:Math.round(Math.pow(p,1)*n),bwe_up:n,fps_down:Math.round(Math.pow(f,1)*P),fps_up:i},balanced:{scaleResolutionDownBy:1,frameRate:i,bitrateMax:n,bitrateMin:s},motion:{scaleResolutionDownBy:1,frameRate:i,bitrateMax:n,bitrateMin:s},detail:{scaleResolutionDownBy:1,frameRate:i,bitrateMax:n,bitrateMin:s}}];for(let q=1;q<=c;q++){const Q={bwe_up:Math.round(Math.pow(h,q)*n),bwe_down:Math.round(Math.pow(p,q+1)*n),fps_up:Math.round(Math.pow(v,q)*P),fps_down:Math.round(Math.pow(f,q+1)*P)},dt={scaleResolutionDownBy:r/Math.pow(b,q),frameRate:Math.max(Math.round(Math.pow(T,q)*i),o),bitrateMax:Math.max(Math.round(Math.pow(S,q)*n),l),bitrateMin:Math.max(Math.round(Math.pow(S,q)*s),d)},Dt={scaleResolutionDownBy:r/Math.pow(w,q),frameRate:i,bitrateMax:Math.max(Math.round(Math.pow(D,q)*n),l),bitrateMin:Math.max(Math.round(Math.pow(D,q)*s),d)},Ot={scaleResolutionDownBy:1,frameRate:Math.max(Math.round(Math.pow(k,q)*i),o),bitrateMax:Math.max(Math.round(Math.pow(U,q)*n),l),bitrateMin:Math.max(Math.round(Math.pow(U,q)*s),d)};x.push({scale:q,threshold:Q,balanced:dt,motion:Dt,detail:Ot})}return x}function GY(t,e,n,i,r,s){const o=U_.get(t)||{overUse:0,underUse:0,adaptationList:DP(r)},{adaptationList:a}=o;U_.set(t,o);const{OVERUSE_TIMES_THRESHOLD:c,UNDERUSE_TIMES_THRESHOLD:d}=lS,{scale:l}=i;let h,p;return typeof e=="number"&&e>0&&(function(f,v,S,T){if(v>=S.length)return!1;let{threshold:{fps_down:b}}=S[v];return I("FORCE_AG_HIGH_FRAMERATE")&&T==="maintain-framerate"&&(b=S[0].threshold.fps_down),f<b})(e,l,a,s)&&(o.overUse++,p=Cd.CPU,o.overUse>c)||typeof n=="number"&&n>0&&(function(f,v,S){if(v>=S.length)return!1;const{threshold:{bwe_down:T}}=S[v];return f<T})(n,l,a)&&(o.overUse++,p=Cd.BANDWIDTH,o.overUse>c)?(o.overUse=0,o.underUse=0,h=OP(i,a,s,Kd.DOWN),[h,p]):(typeof e=="number"&&e>0&&typeof n=="number"&&n>0&&(function(f,v,S,T){if(v===0)return;let{threshold:{fps_up:b}}=S[v];return I("FORCE_AG_HIGH_FRAMERATE")&&T==="maintain-framerate"&&(b=S[1].threshold.fps_up),f>b})(e,l,a,s)&&(function(f,v,S){if(v===0)return;const{threshold:{bwe_up:T}}=S[v];return f>T})(n,l,a)&&(o.underUse++,o.underUse>d&&(o.overUse=0,o.underUse=0,h=OP(i,a,s,Kd.UP),h.scale===0&&(p=Cd.NONE))),[h,p])}function PP(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable}))),n.push.apply(n,i)}return n}function gT(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?PP(Object(n),!0).forEach((function(i){R(t,i,n[i])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):PP(Object(n)).forEach((function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i))}))}return t}function LP(t){var e;return!!I("ENABLE_AG_ADAPTATION")&&!!(t instanceof o_||$(e=t._hints).call(e,Ee.CUSTOM_TRACK))&&(!!I("FORCE_SUPPORT_AG_ADAPTATION")||!!(TO(14,0,!1)&&RO(17,4,!0)||SO(14)&&Hg(17,4,!0)))}const x_=new Map;function kP(t,e,n,i,r,s){if(Yd(t,n),r(e),i!=="balanced"&&i!=="maintain-framerate"&&i!=="maintain-resolution")return;let o=-1;NP(t,e);const a=window.setInterval((()=>{const d=x_.get(t);if(!I("ENABLE_AG_ADAPTATION")||!d)return Yd(t,n),void r(e);const l=s();if(l.sendPackets>0&&l.OutgoingAvailableBandwidth>0){if(o===-1)return void(o=Date.now());if(Date.now()-o<1e3)return;const h=l.sendFrameRate,p=l.OutgoingAvailableBandwidth,[f,v]=GY(t,h,p,d.adaptationConfig,e,i);v&&(n.qualityLimitationReason=v),f&&d.adaptationConfig.scale!==f.scale&&(m.debug("[".concat(t,"] applyAdaptation: ").concat(n.qualityLimitationReason,`
           sendFps `).concat(h,", bwe ").concat(p,", switch from ").concat(d.adaptationConfig.scale," to ").concat(f.scale," ")),d.adaptationConfig=gT(gT({},d.adaptationConfig),f),r(f))}}),I("CHECK_LOCAL_STATS_INTERVAL")),c=gT({},e);x_.set(t,{timer:a,adaptationConfig:c,originConfig:e,adaptationFunc:r}),m.debug("[".concat(t,"] start adaptation, originConfig: ").concat(JSON.stringify(e),", degradationPreference: ").concat(i))}function Yd(t,e){const n=x_.get(t);if(n){const{timer:i}=n;window.clearTimeout(i),x_.delete(t)}e.qualityLimitationReason=Cd.NONE,NP(t)}function WY(t,e){var n;let i;switch(e){case tt.LocalAudioTrack:i=Re.Audio;break;case tt.LocalVideoTrack:i=$(n=t._hints).call(n,Ee.SCREEN_TRACK)?Re.Screen:Re.High;break;case tt.LocalVideoLowTrack:i=Re.Low}return i}function ST(t){const e=Jt();if(t.some((n=>n._bypassWebAudio)))throw new H(A.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");if(!e.webAudioMediaStreamDest)throw new H(A.NOT_SUPPORTED,"cannot publish multiple tracks because your browser does not support audio mixing")}function TT(t,e){ST(t);const n=new Cn;return t.forEach((i=>n.addAudioTrack(i))),n}const HY=!Jt().supportUnifiedPlan||I("CHROME_FORCE_PLAN_B")&&Js();function Cu(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(t.useDcSignal)return n={spec:e,store:t},bs("DataChannelConnection").create(n);var n;return HY?(function(r){return bs("PlanBConnection").create(r)})({spec:e,store:t}):new gr(e,t)}function RT(t){return t&&(t.iceConnectionState==="disconnected"||t.iceConnectionState==="checking"||t.iceConnectionState==="failed")}function vT(t){try{if(t.iceServers)return!1;if(t.turnServer&&t.turnServer.mode!=="off"){if(Ja(t.turnServer.servers))return!1;if(I("FORCE_TURN_TCP")||t.turnServer.servers.concat(t.turnServer.serversFromGateway||[]).some((e=>e.forceturn)))return!0}return!1}catch{return!1}}var se;function MP(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable}))),n.push.apply(n,i)}return n}function ws(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?MP(Object(n),!0).forEach((function(i){R(t,i,n[i])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):MP(Object(n)).forEach((function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i))}))}return t}let gr=(se=class Lc extends R_{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get dtlsTransportState(){var e,n;return(e=(n=this.peerConnection.getReceivers()[0])===null||n===void 0||(n=n.transport)===null||n===void 0?void 0:n.state)!==null&&e!==void 0?e:null}get localCodecs(){return[...new Set(this.localCapabilities&&this.localCapabilities.send.videoCodecs.map((e=>e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"")).filter((e=>{var n;return $(n=Object.keys(ic)).call(n,e)})))]}constructor(e,n){super(e,n),R(this,"id",Se(5,"connection-")),R(this,"store",void 0),R(this,"peerConnection",void 0),R(this,"forceTurn",!1),R(this,"remoteSDP",void 0),R(this,"initialOffer",void 0),R(this,"transportEventReceiver",void 0),R(this,"statsFilter",void 0),R(this,"extension",{useXR:I("USE_XR")}),R(this,"localCapabilities",void 0),R(this,"remoteCodecs",void 0),R(this,"localCandidateCount",0),R(this,"allCandidatesReceived",!1),R(this,"isPreallocation",!1),R(this,"isPreRender",!1),R(this,"preMediaMap",new Map),R(this,"dataStreamChannelMap",new Map),R(this,"establishPromise",void 0),R(this,"recoveredDataChannelIds",[]),R(this,"currentDataChannelId",1),R(this,"supportAV1RtpSpec",!1),R(this,"mutex",void 0),R(this,"qualityLimitationReason",Cd.NONE),R(this,"isFirstConnected",!1),this.store=n,this.forceTurn=vT(e),this.mutex=new Un("P2PConnection-mutex",n.clientId),this.peerConnection=new RTCPeerConnection(Lc.resolvePCConfiguration(e),{optional:[{googDscp:!0}]}),this.isFirstConnected=!1,this.statsFilter=Xp(this.peerConnection,I("STATS_UPDATE_INTERVAL"),void 0,xe()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1,e.isPreallocation&&(this.isPreallocation=!0),this.establishPromise=this.establish()}getPreMedia(e){return this.preMediaMap.get(e)}isPreSub(){return this.preMediaMap.size>0}async updateRemoteRTPCapabilities(e,n){if(this.remoteCodecs=n,!this.remoteSDP)return void m.debug("[P2PConnection] cannot updateRemoteRTPCapabilities before remote SDP created, local codecs: ".concat(this.localCodecs,", codecs: ").concat(n));if(this.remoteSDP.updateRemoteCodec(e,n,this.store.codec)){const i=await this.peerConnection.createOffer(),r=this.logSDPExchange(i.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(i);const s=this.remoteSDP.toString();r?.(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}else m.debug("[P2PConnection] updateRemoteRTPCapabilities no need to exchange SDP.")}async establish(){try{this.peerConnection.addTransceiver("video",{direction:"recvonly"}),this.peerConnection.addTransceiver("audio",{direction:"recvonly"});const n=await this.peerConnection.createOffer();if(!n.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const i=no(n.sdp),r=await rT({filterRTX:!I("USE_PUB_RTX")&&!I("USE_SUB_RTX"),filterVideoFec:I("FILTER_VIDEO_FEC"),filterAudioFec:I("FILTER_AUDIO_FEC"),filterVideoCodec:I("FILTER_VIDEO_CODEC"),unsupportedVideoUplinkCodec:I("UNSUPPORTED_VIDEO_UPLINK_CODEC"),unsupportedVideoDownlinkCodec:I("UNSUPPORTED_VIDEO_DOWNLINK_CODEC")},this.extension);if(this.localCapabilities=gu(r),this.initialOffer=n,I("ENABLE_SVC")&&this.store.codec=="av1"){const o=await nP();var e;o&&(this.supportAV1RtpSpec=!0,(e=r.send)===null||e===void 0||e.videoExtensions.push(o))}let s;return n.sdp&&w_(n.sdp)&&(s=Ve(r),zD(s)),ws(ws({},i),{},{rtpCapabilities:s||r,offerSDP:n.sdp})}catch(n){throw new H(A.GET_LOCAL_CONNECTION_PARAMS_FAILED,n.toString())}}async connect(e){try{if(!this.initialOffer)throw new Error("Cannot establish P2PConnection without initial offer.");this.initialOffer.sdp&&w_(this.initialOffer.sdp)&&XD(e.rtpCapabilities,this.localCapabilities),this.remoteSDP=new AP(ws(ws({},e),{},{localCapabilities:this.localCapabilities}),this.supportAV1RtpSpec,!(!I("ENABLE_PRE_SUB_WITH_PRE_PC")||!I("PRE_USE_LOCAL_CODECS"))&&du(this.store)),e.preallocation&&(this.isPreallocation=!0),Array.isArray(this.remoteCodecs)&&this.remoteCodecs.length>0&&this.remoteSDP.updateRemoteCodec([],this.remoteCodecs,this.store.codec);const n=this.remoteSDP.toString(),i=sT(this.initialOffer.sdp,this.extension),r=this.logSDPExchange(i||"","offer","local","connect");this.store.descriptionStart(),await this.peerConnection.setLocalDescription({type:"offer",sdp:i}),r?.(n),await this.peerConnection.setRemoteDescription({type:"answer",sdp:n});const s=this.peerConnection.getTransceivers()[0];if(s!=null&&s.receiver&&this.tryBindTransportEvents(s.receiver),du(this.store))if(e.preallocation&&I("ENABLE_PRE_SUB_WITH_PRE_PC")){const o=I("PRE_SUB_NUM"),{mids:a,preSSRCs:c}=this.remoteSDP.preloadRemoteMedia(o);await Ui(this.peerConnection,this.remoteSDP,this.extension),m.debug("[".concat(this.store.clientId,"] [P2PConnection] preload media, in pre pc,add preload ssrcs ").concat(c)),this.presetMedia(a,c)}else{const{preSSRCs:o=[]}=e,a=o.map((d=>d.ssrcMsg[0].ssrcId));if(o.length===0)return;const{mids:c}=this.remoteSDP.batchSend(o.map((d=>Object.assign({},d))));await Ui(this.peerConnection,this.remoteSDP,this.extension),m.debug("[P2PConnection.connect] preload media, after join, add preload ssrcs ".concat(a)),this.presetMedia(c,a)}}catch(n){throw new H(A.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(n.toString()))}}presetMedia(e,n){e.forEach(((i,r)=>{this.peerConnection.getTransceivers().forEach((s=>{if(s.mid!=null&&i===s.mid&&s.receiver.track){const o=s.receiver.track;let a;o.kind==="video"&&I("ENABLE_PRE_RENDER")&&(a=new s_({trackId:"track-".concat(o.kind,"-unknown-").concat(this.store.clientId,"_").concat(Se(5,""))},!0),a.updateVideoTrack(o),a.onFirstVideoFrameRender=()=>{var c;const d=this.preMediaMap.get(n[r]);d&&(d.firstVideoRender=Date.now()),(c=this.onFirstVideoRender)===null||c===void 0||c.call(this,n[r])},a.onVideoBufferReady=()=>{var c;(c=this.onFirstVideoBufferReady)===null||c===void 0||c.call(this,n[r])},a.play(this.store.sessionId||void 0),this.isPreRender=!0),this.preMediaMap.set(n[r],{mid:i,track:o,player:a,transceiver:s})}})),this.store.peerReceiver()}))}checkDtlsParameters(e){return!!this.remoteSDP&&e.length>0&&this.remoteSDP.updateRemoteDtlsParameters(e)}async updateRemoteConnect(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateRemoteConnect before remote SDP created");let n=!1;const{rtpCapabilities:i}=e;if([,n]=this.remoteSDP.updateRemoteRTPCapabilities(i),Array.isArray(this.remoteCodecs)&&this.remoteCodecs.length>0){const o=this.remoteSDP.updateRemoteCodec([],this.remoteCodecs,this.store.codec);n=n||o}const{preSSRCs:r=[]}=e,s=r.map((o=>o.ssrcMsg[0].ssrcId));if(!this.remoteSDP.checkPreloadSsrcs(s)){const o=[],a=[];if(Array.from(this.preMediaMap.entries()).every((c=>{let[d,{mid:l,player:h,track:p}]=c;return o.push(l),a.push(d),this.preMediaMap.delete(d),h&&h.destroy(),!0})),o.length>0&&(this.remoteSDP.stopSending(o),await Ui(this.peerConnection,this.remoteSDP,this.extension),m.warn("[P2PConnection.updateRemoteConnect] preload media, failed, del preload ssrcs ".concat(a)),pt.reportApiInvoke(this.store.sessionId,{name:Ge.PRELOAD_MEDIA_FAILED,options:[r,a],tag:Ne.TRACER}).onSuccess()),r.length>0){const{mids:c}=this.remoteSDP.batchSend(r.map((d=>Object.assign({},d))));await Ui(this.peerConnection,this.remoteSDP,this.extension),m.debug("[P2PConnection.updateRemoteConnect] preload media, after join, add preload ssrcs ".concat(s)),this.presetMedia(c,s)}}n?(await Ui(this.peerConnection,this.remoteSDP,this.extension),m.debug("[P2PConnection] updateRemoteConnect by exchanging SDP.")):m.debug("[P2PConnection] updateRemoteConnect no need to exchange SDP, because no need to update remote codecs (use local codecs)")}catch(n){throw new H(A.EXCHANGE_SDP_FAILED,"P2PConnection.updateRemoteConnect failed; ".concat(n.toString()))}}send(e,n,i){var r=this;return Ci((function*(){const s=yield Ht(r.mutex.lock("From P2PConnection.send"));try{if(!r.remoteSDP)throw new Error("Cannot call P2PConnection.send before remote SDP created");const o=[],a=fu();e.forEach((T=>{const b=r.peerConnection.addTransceiver(T._mediaStreamTrack,ws({direction:"sendonly"},T.trackMediaType==="video"&&r.supportAV1RtpSpec&&a?{sendEncodings:[{scalabilityMode:a}]}:{}));o.push(b),T._updateRtpTransceiver(b)})),xe()&&I("SIMULCAST")===!0&&(yield Ht(r.applySimulcastForFirefox(o,e)));const c=yield Ht(r.peerConnection.createOffer()),d=r.remoteSDP.predictReceivingMids(e.length),l=r.mungSendOfferSDP(c.sdp,e,d),h=Ei(l),p=d.map((T=>{const b=h.mediaDescriptions.find((w=>w.attributes.mid===T));if(!b)throw new Error("Cannot extract ssrc from mediaDescription.");return tT(b,I("USE_PUB_RTX"))}));let f;try{f=yield p}catch(T){f=[],r.remoteSDP.receive(e,n,i,f);const b=r.remoteSDP.toString();throw yield Ht(r.peerConnection.setLocalDescription({type:"offer",sdp:l})),yield Ht(r.peerConnection.setRemoteDescription({type:"answer",sdp:b})),yield Ht(r.stopSending(d,!0)),T}r.remoteSDP.receive(e,n,i,f);const v=r.remoteSDP.toString(),S=r.logSDPExchange(l,"offer","local","send");return yield Ht(r.peerConnection.setLocalDescription({type:"offer",sdp:l})),yield Ht(r.applySimulcastEncodings(o,e)),yield Ht(r.applySendEncodings(o,e)),S?.(v),yield Ht(r.peerConnection.setRemoteDescription({type:"answer",sdp:v})),o.map(((T,b)=>{const w=d[b];return{localSSRC:p[b],id:w,transceiver:T}}))}catch(o){throw o instanceof H?o:new H(A.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(o.toString()))}finally{s()}}))()}async createDataChannels(e,n){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.createDataChannels before remote SDP created");let i=this.dataStreamChannelMap.get(e);if(i&&i.readyState==="open")m.debug("[P2PConnection] Channels are already available and can be reused directly.");else{const s=this.currentDataChannelId<1023?this.currentDataChannelId++:this.recoveredDataChannelIds.shift();if(typeof s!="number")throw new Error("create DataChannel error, because cannot get dc id");i=this.peerConnection.createDataChannel("datastream-channel",{id:s,negotiated:!0,ordered:!1,maxRetransmits:I("DATASTREAM_MAX_RETRANSMITS")}),i.binaryType="arraybuffer",this.dataStreamChannelMap.set(e,i)}n.forEach((s=>{s._updateOriginDataChannel(i)}));const{needExchangeSDP:r}=this.remoteSDP.sendDataChannel();if(r){const s=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:s});const o=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(o),m.debug("[P2PConnection] createDataChannels by exchanging SDP.")}else m.debug("[P2PConnection] createDataChannels no need to exchange SDP.");return}catch(i){throw i instanceof H?i:new H(A.EXCHANGE_SDP_FAILED,"P2PConnection.createDataChannels failed; ".concat(i.toString()))}}async stopDataChannels(e){try{const n=this.dataStreamChannelMap.get(e);return n&&(n.id&&this.recoveredDataChannelIds.push(n.id),n.close()),void this.dataStreamChannelMap.delete(e)}catch(n){throw n instanceof H?n:new H(A.DATACHANNEL_FAILED,"P2PConnection.stopDataChannels failed; ".concat(n.toString()))}}async stopSending(e,n){const i=n?void 0:await this.mutex.lock("From P2PConnection.stopSending");try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopSending before remote SDP created");const r=this.peerConnection.getTransceivers().filter((c=>e.indexOf(c.mid)!==-1));if(r.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length when trying to call P2PConnection.stopSending.");r.map((c=>{var d;Yd(this.id+c.mid,this),c.direction="inactive",(d=c.stop)===null||d===void 0||d.call(c)}));const s=await this.peerConnection.createOffer(),o=this.logSDPExchange(s.sdp||"","offer","local","stopSending");await this.peerConnection.setLocalDescription(s),this.remoteSDP.stopReceiving(e);const a=this.remoteSDP.toString();o?.(a),await this.peerConnection.setRemoteDescription({type:"answer",sdp:a})}catch(r){throw new H(A.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(r.toString()))}finally{i&&i()}}async receive(e,n,i,r){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(e," before remoteSDP created."));const{mid:s,needExchangeSDP:o}=this.remoteSDP.send(e,n,i,r);o&&(await Ui(this.peerConnection,this.remoteSDP,this.extension),m.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(e," by exchanging SDP.")));const a=this.peerConnection.getTransceivers().find((c=>c.mid===s));if(!a)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:a.receiver.track,id:s,transceiver:a}}catch(s){throw new H(A.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(s.toString()))}}async batchReceive(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.batchReceive before remoteSDP created.");const{mids:n,needExchangeSDP:i}=this.remoteSDP.batchSend(e);return i&&(await Ui(this.peerConnection,this.remoteSDP,this.extension),m.debug("[".concat(this.store.clientId,"] [P2PConnection] batchReceive by exchanging SDP."))),n.map((r=>{const s=this.peerConnection.getTransceivers().find((o=>o.mid===r));if(!s)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:s.receiver.track,id:r,transceiver:s}}))}catch(n){throw new H(A.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(n.toString()))}}async stopReceiving(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");e.forEach((s=>{Array.from(this.preMediaMap.entries()).some((o=>{let[a,{mid:c,player:d}]=o;if(c===s)return this.preMediaMap.delete(a),d&&d.destroy(),!0}))})),this.remoteSDP.stopSending(e);const n=this.remoteSDP.toString(),i=this.logSDPExchange(n,"offer","remote","stopReceiving");await this.peerConnection.setRemoteDescription({type:"offer",sdp:n});const r=await this.peerConnection.createAnswer();i?.(r.sdp||""),await this.peerConnection.setLocalDescription(r)}catch(n){throw new H(A.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(n.toString()))}}async muteRemote(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteRemote mid=".concat(e," before remote SDP created."));this.remoteSDP.mute(e);const n=this.remoteSDP.toString(),i=this.logSDPExchange(n,"offer","remote","muteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:n});const r=await this.peerConnection.createAnswer();i?.(r.sdp||""),await this.peerConnection.setLocalDescription(r)}catch(n){throw new H(A.EXCHANGE_SDP_FAILED,"P2PConnection.muteRemote failed; ".concat(n.toString()))}}async unmuteRemote(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteRemote mid=".concat(e," before remote SDP created."));this.remoteSDP.unmute(e);const n=this.remoteSDP.toString(),i=this.logSDPExchange(n,"offer","remote","unmuteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:n});const r=await this.peerConnection.createAnswer();i?.(r.sdp||""),await this.peerConnection.setLocalDescription(r)}catch(n){throw new H(A.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteRemote failed; ".concat(n.toString()))}}async muteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteLocal before remote SDP created.");const n=this.peerConnection.getTransceivers().filter((o=>o.mid&&e.indexOf(o.mid)!==-1));if(n.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");n.map((o=>{o.direction="inactive"}));const i=await this.peerConnection.createOffer(),r=this.logSDPExchange(i.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(i),this.remoteSDP.muteRemote(e);const s=this.remoteSDP.toString();r?.(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(n){throw new H(A.EXCHANGE_SDP_FAILED,"P2PConnection.muteLocal failed; ".concat(n.toString()))}}async unmuteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteLocal before remote SDP created.");const n=this.peerConnection.getTransceivers().filter((o=>o.mid&&e.indexOf(o.mid)!==-1));if(n.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");n.map((async(o,a)=>{o.direction="sendonly"}));const i=await this.peerConnection.createOffer(),r=this.logSDPExchange(i.sdp||"","offer","local","unmuteLocal");await this.peerConnection.setLocalDescription(i),this.remoteSDP.unmuteRemote(e),Array.isArray(this.remoteCodecs)&&this.remoteCodecs.length>0&&this.remoteSDP.updateRemoteCodec(e,this.remoteCodecs,this.store.codec);const s=this.remoteSDP.toString();r?.(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(n){throw new H(A.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteLocal failed; ".concat(n.toString()))}}restartICE(e){var n=this;return Ci((function*(){const i=yield Ht(n.mutex.lock("From P2PConnection.restartICE"));try{if(!n.remoteSDP)throw new Error("Cannot restartICE before remoteSDP created.");const r=Jt().supportPCSetConfiguration,s=I("FORCE_TURN_TCP")||n.forceTurn;if(e===xn.RELAY&&!r)return;if(r&&!s){const h=e===xn.RELAY?"relay":"all",p=n.peerConnection.getConfiguration();p.iceTransportPolicy!==h&&(m.debug("[".concat(n.store.clientId,"] restartICE change iceTransportPolicy from [").concat(p.iceTransportPolicy,"] to [").concat(h,"]")),p.iceTransportPolicy=h,n.peerConnection.setConfiguration(p))}n.remoteSDP.updateCandidates(e);const o=yield Ht(n.peerConnection.createOffer({iceRestart:!0}));if(!o.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const a=no(o.sdp),{remoteIceParameters:c}=yield a.iceParameters;n.remoteSDP.restartICE(c);const d=n.remoteSDP.toString(),l=n.logSDPExchange(o.sdp||"","offer","local","restartICE");n.store.descriptionStart(),yield Ht(n.peerConnection.setLocalDescription(o)),l?.(d),yield Ht(n.peerConnection.setRemoteDescription({type:"answer",sdp:d}))}catch(r){m.warning("[".concat(n.store.clientId,"] restart ICE failed, abort operation"),r)}finally{i()}}))()}async extendCandidate(){if(!this.remoteSDP||this.isFirstConnected)return;const e=await this.mutex.lock("From P2PConnection.extendCandidate");try{this.remoteSDP.updateCandidates(xn.TCP_RELAY),await Ui(this.peerConnection,this.remoteSDP,this.extension)}catch(n){m.warning("[".concat(this.store.clientId,"] extend candidate failed, abort operation"),n)}finally{e()}}close(){var e;this.peerConnection.getTransceivers().forEach((n=>{Yd(this.id+n.mid,this)})),this.preMediaMap.forEach((n=>{let{player:i}=n;i&&i.destroy()})),this.preMediaMap.clear(),this.peerConnection.close(),(e=this.onConnectionStateChange)===null||e===void 0||e.call(this,"closed"),this.tryUnbindTransportEvents(),this.unbindPCEvents(),this.unbindStatsEvents(),this.removeAllListeners(),this.transportEventReceiver=void 0,this.statsFilter.destroy(),this.dataStreamChannelMap.clear(),this.recoveredDataChannelIds=[],this.currentDataChannelId=1}getStats(){return ws(ws({},this.statsFilter.getStats()),{},{qualityLimitationReason:this.qualityLimitationReason})}getRemoteVideoIsReady(e){return this.statsFilter.getVideoIsReady(e)}async updateEncoderConfig(e,n){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateEncoderConfig before remote SDP created.");const i=await this.peerConnection.createOffer(),r=this.mungSendOfferSDP(i.sdp,[n],[e]);this.remoteSDP.updateRecvMedia(e,n);const s=this.remoteSDP.toString(),o=this.logSDPExchange(r,"offer","local","updateEncoderConfig");await this.peerConnection.setLocalDescription({type:"offer",sdp:r}),o?.(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(i){throw new H(A.EXCHANGE_SDP_FAILED,i.toString())}}async updateSendParameters(e,n){const i=this.peerConnection.getTransceivers().filter((r=>r.mid===e));i.length===1&&(this.isVP8Simulcast(n)?xe()||await this.applySimulcastEncodings(i,[n]):await this.applySendEncodings(i,[n]))}setStatsRemoteVideoIsReady(e,n){this.statsFilter.setVideoIsReady2(e,n)}async replaceTrack(e,n){const i=this.peerConnection.getTransceivers().find((r=>r.mid===n));i&&await i.sender.replaceTrack(e._mediaStreamTrack)}async getSelectedCandidatePair(){const e=this.peerConnection.getReceivers();if(e.length>0&&e[0].transport&&e[0].transport.iceTransport&&e[0].transport.iceTransport.getSelectedCandidatePair&&e[0].transport.iceTransport.getSelectedCandidatePair()){const n=e[0].transport.iceTransport,{local:i,remote:r}=n.getSelectedCandidatePair();return{local:ws(ws({},ts),{},{candidateType:i.type,protocol:i.protocol,address:i.address,port:i.port}),remote:ws(ws({},ts),{},{candidateType:r.type,protocol:r.protocol,address:r.address,port:r.port})}}return this.statsFilter.getSelectedCandidatePair()}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var e;(e=this.onICEConnectionStateChange)===null||e===void 0||e.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var e;this.peerConnection.connectionState==="connected"&&(this.isFirstConnected=!0),(e=this.onConnectionStateChange)===null||e===void 0||e.call(this,this.peerConnection.connectionState)},this.peerConnection.onicecandidateerror=e=>{if(e&&(e.errorCode||e.errorText)){var n;const i="code: ".concat(e.errorCode,", message: ").concat(e.errorText),r=e.port?"local: ".concat(e.port):"",s=eo(e.url||"");m.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICECandidateError(").concat(i,"), url: ").concat(s||"",", host_candidate:").concat(r)),(n=this.onICECandidateError)===null||n===void 0||n.call(this,i)}},this.peerConnection.onicegatheringstatechange=e=>{e&&e.target&&"iceGatheringState"in e.target&&m.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] RTCPeerConnection.onicegatheringstatechange(").concat(e.target.iceGatheringState,")"))},this.peerConnection.onicecandidate=e=>{e.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,m.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))},setTimeout((()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,m.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount))}),I("CANDIDATE_TIMEOUT"))}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(e){const n={iceServers:[]},i=e.cloudProxyServer||"disabled";return e.iceServers?n.iceServers=e.iceServers:e.turnServer&&(Ja(e.turnServer.servers)?n.iceServers=e.turnServer.servers:I("NEW_TURN_MODE")&&n.iceServers&&i==="disabled"?(I("USE_TURN_SERVER_OF_GATEWAY")?e.turnServer.serversFromGateway&&n.iceServers.push(...Lc.newTurnServerConfigToIceServers(e.turnServer.serversFromGateway)):n.iceServers.push(...Lc.newTurnServerConfigToIceServers(e.turnServer.servers)),I("NEW_FORCE_TURN")&&(n.iceTransportPolicy="relay")):e.turnServer.mode!=="off"&&(n.iceServers&&n.iceServers.push(...Lc.turnServerConfigToIceServers(e.turnServer.servers)),I("USE_TURN_SERVER_OF_GATEWAY")&&n.iceServers&&e.turnServer.serversFromGateway&&n.iceServers.push(...Lc.turnServerConfigToIceServers(e.turnServer.serversFromGateway)),I("FORCE_TURN_TCP")?n.iceTransportPolicy="relay":e.turnServer.servers.concat(e.turnServer.serversFromGateway||[]).forEach((r=>{r.forceturn&&(n.iceTransportPolicy="relay")})))),I("ENABLE_ENCODED_TRANSFORM")&&Jt().supportWebRTCEncodedTransform&&(n.encodedInsertableStreams=!0),n}static turnServerConfigToIceServers(e){const n=[];return e.forEach((i=>{i.security?i.tcpport&&n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turns:".concat(ss(i.turnServerURL),":").concat(i.tcpport,"?transport=tcp")}):(i.udpport&&!I("FORCE_TURN_TCP")&&n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":").concat(i.udpport,"?transport=udp")}),i.tcpport&&n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":").concat(i.tcpport,"?transport=tcp")}))})),n}static newTurnServerConfigToIceServers(e){const n=[];return e.forEach((i=>{const r=I("NEW_TURN_MODE");r===1?n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":3478?transport=udp")}):r===2?n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":3478?transport=tcp")}):r===3?n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turns:".concat(ss(i.turnServerURL),":443?transport=tcp")}):r===4&&(n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":3478?transport=udp")}),n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":3478?transport=tcp")}),n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turns:".concat(ss(i.turnServerURL),":443?transport=tcp")}))})),n}tryBindTransportEvents(e){const n=e.transport;if(n){this.transportEventReceiver=e,n.onstatechange=()=>{var r;n!=null&&n.state&&((r=this.onDTLSTransportStateChange)===null||r===void 0||r.call(this,n.state))},n.onerror=r=>{var s;(s=this.onDTLSTransportError)===null||s===void 0||s.call(this,"error"in r?r.error:r)};const i=n.iceTransport;i&&(i.onstatechange=()=>{const r=n?.iceTransport.state;var s;r&&((s=this.onICETransportStateChange)===null||s===void 0||s.call(this,r))},i.getSelectedCandidatePair&&(i.onselectedcandidatepairchange=()=>{if(i.getSelectedCandidatePair()){const{local:r,remote:s}=i.getSelectedCandidatePair()||{};if(r&&s){const o=r.address+":"+r.port,a=s.address+":"+s.port;m.info("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] selectedcandidatepairchange: local ").concat(JSON.stringify(eo(o)),", remote ").concat(JSON.stringify(eo(a))))}}}))}}tryUnbindTransportEvents(){this.transportEventReceiver&&this.transportEventReceiver.transport&&(this.transportEventReceiver.transport.onstatechange=null,this.transportEventReceiver.transport.onerror=null,this.transportEventReceiver.transport.iceTransport&&(this.transportEventReceiver.transport.iceTransport.onstatechange=null))}async updateRtpSenderEncodings(e,n){var i,r;if(n||(n=this.peerConnection.getSenders().find((T=>T.track===e._mediaStreamTrack))),!n)return m.warn("[".concat(e.getTrackId(),"] no rtpSender found}"));if(this.isVP8Simulcast(e))return m.warn("[updateRtpSenderEncodings] Track is VP8 simulcast, please apply simulcast encodings");if(!Jt().supportSetRtpSenderParameters)return m.warn("[updateRtpSenderEncodings] Browser not support set rtp-sender parameters");const s={},o={};switch(e._optimizationMode){case"motion":s.degradationPreference="maintain-framerate";break;case"detail":s.degradationPreference="maintain-resolution";break;case"balanced":s.degradationPreference="balanced"}const a=YD(this.peerConnection,e._mediaStreamTrack),c=M0(e);if(LP(e)&&a&&n&&c&&this.getLocalVideoStats&&$(i=["vp8","vp9"]).call(i,this.store.codec)){var d;const S=s.degradationPreference||($(d=e._hints).call(d,Ee.CUSTOM_TRACK)?I("CUSTOM_ADAPTATION_DEFAULT_MODE"):"maintain-framerate");kP(this.id+a.mid,c,this,S,(T=>{n&&this.updateAdaptation(n,T)}),this.getLocalVideoStats.bind(this))}if(e._encoderConfig){var l;const{bitrateMax:S,frameRate:T,scaleResolutionDownBy:b}=e._encoderConfig;S&&(o.maxBitrate=1e3*S),($(l=e._hints).call(l,Ee.LOW_STREAM)||e.isUseScaleResolutionDownBy)&&(T&&(o.maxFramerate=wi(T)),b&&b>=1&&(o.scaleResolutionDownBy=b))}const{maxFramerate:h}=I("ENCODER_CONFIG_LIMIT");if(h&&typeof h=="number"&&(o.maxFramerate=o.maxFramerate?Math.min(o.maxFramerate,h):h),I("DSCP_TYPE")&&Js()){var p;const S=I("DSCP_TYPE");$(p=["very-low","low","medium","high"]).call(p,S)&&(o.networkPriority=S)}const f=n.getParameters(),v=(r=f.encodings)===null||r===void 0?void 0:r[0];xe()&&!v&&(s.encodings=[o]),v&&Object.assign(v,o),Object.assign(f,s),m.debug("[".concat(e.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(f.encodings))),await n.setParameters(f),await sP(this.store.codec,n,I("SVC_MODE"))}async updateAdaptation(e,n){var i,r;if(!e)return m.debug("[updateAdaptation] no rtpSender found");if(!Jt().supportSetRtpSenderParameters)return m.debug("[updateAdaptation] Browser not support set rtp-sender parameters");const s={},{bitrateMax:o,frameRate:a,scaleResolutionDownBy:c}=n;o&&(s.maxBitrate=1e3*o),a&&(s.maxFramerate=wi(a)),c&&c>=1&&$(i=["vp8","vp9"]).call(i,this.store.codec)&&(s.scaleResolutionDownBy=c);const d=e.getParameters(),l=(r=d.encodings)===null||r===void 0?void 0:r[0];l&&Object.assign(l,s),Object.assign(d,{});try{await e.setParameters(d),m.debug("[updateAdaptation] updateRtpSenderEncodings: ".concat(JSON.stringify(d.encodings)))}catch(h){!("transport"in e)||e.transport&&e.transport.state==="connected"?this.peerConnectionState!=="connected"?m.debug("[updateAdaptation] peerConnection not connected}"):m.debug("[updateAdaptation] updateRtpSenderEncodings failed",h):m.debug("[updateAdaptation] rtpSender transport not connected}")}}async applySendEncodings(e,n){try{if(!Jt().supportSetRtpSenderParameters||e.length!==n.length)return;for(let i=0;i<e.length;i++){const r=e[i],s=n[i];s instanceof De&&!this.isVP8Simulcast(s)&&await this.updateRtpSenderEncodings(s,r.sender)}}catch{m.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}}mungSendOfferSDP(e,n,i){const r=Ei(e);return n.forEach(((s,o)=>{const a=i[o],c=r.mediaDescriptions.find((d=>d.attributes.mid===a));c&&(_c(c,s),iT(c,s,this.store.codec))})),Oo(r)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=e=>{var n;(n=this.onFirstAudioReceived)===null||n===void 0||n.call(this,e)},this.statsFilter.onFirstVideoReceived=e=>{var n;(n=this.onFirstVideoReceived)===null||n===void 0||n.call(this,e)},this.statsFilter.onFirstAudioDecoded=e=>{var n;(n=this.onFirstAudioDecoded)===null||n===void 0||n.call(this,e)},this.statsFilter.onFirstVideoDecoded=(e,n,i)=>{var r;(r=this.onFirstVideoDecoded)===null||r===void 0||r.call(this,e,n,i)},this.statsFilter.onSelectedLocalCandidateChanged=(e,n)=>{var i;(i=this.onSelectedLocalCandidateChanged)===null||i===void 0||i.call(this,e,n)},this.statsFilter.onSelectedRemoteCandidateChanged=(e,n)=>{var i;(i=this.onSelectedRemoteCandidateChanged)===null||i===void 0||i.call(this,e,n)},this.statsFilter.onFirstVideoDecodedTimeout=e=>{var n;(n=this.onFirstVideoDecodedTimeout)===null||n===void 0||n.call(this,e)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0,this.statsFilter.onFirstVideoDecodedTimeout=void 0}async applySimulcastForFirefox(e,n){if(e.length===n.length)for(let c=0;c<e.length;c++){var i,r,s,o,a;const d=e[c],l=n[c];if(l instanceof De&&!$(i=l._hints).call(i,Ee.LOW_STREAM)&&(r=l._encoderConfig)!==null&&r!==void 0&&r.bitrateMax&&((s=l._encoderConfig)===null||s===void 0?void 0:s.bitrateMax)>200&&(o=l._scalabilityMode)!==null&&o!==void 0&&o.numSpatialLayers&&((a=l._scalabilityMode)===null||a===void 0?void 0:a.numSpatialLayers)>1&&this.store.codec==="vp8"){const h={},p={high:1e3*(l._encoderConfig.bitrateMax-50),medium:5e4};h.encodings=[{rid:"m",active:!0,maxBitrate:p.medium,scaleResolutionDownBy:4},{rid:"h",active:!0,maxBitrate:p.high}];const f=d.sender.getParameters();await d.sender.setParameters(Object.assign(f,h))}}}async applySimulcastEncodings(e,n){if(!xe()&&e.length===n.length)for(let i=0;i<e.length;i++){const r=n[i];if(r instanceof De&&this.isVP8Simulcast(r)){const s=e[i],o={},a={high:1e3*(r._encoderConfig.bitrateMax-50),medium:5e4};o.encodings=[{active:!0,adaptivePtime:!1,networkPriority:"high",priority:"high",maxBitrate:a.high},{active:!0,adaptivePtime:!1,networkPriority:"low",priority:"low",maxBitrate:a.medium,scaleResolutionDownBy:4}];const c=s.sender.getParameters();await s.sender.setParameters(Object.assign(c,o))}}}isVP8Simulcast(e){var n,i,r,s,o;return!!(e instanceof De&&I("SIMULCAST")&&this.store.codec==="vp8"&&!$(n=e._hints).call(n,Ee.LOW_STREAM)&&(i=e._encoderConfig)!==null&&i!==void 0&&i.bitrateMax&&((r=e._encoderConfig)===null||r===void 0?void 0:r.bitrateMax)>200&&(s=e._scalabilityMode)!==null&&s!==void 0&&s.numSpatialLayers&&((o=e._scalabilityMode)===null||o===void 0?void 0:o.numSpatialLayers)>1)}logSDPExchange(e,n,i,r){if(I("SDP_LOGGING"))return m.upload("[".concat(this.store.clientId,"] exchanging ").concat(i," ").concat(n," SDP during P2PConnection.").concat(r,`
`),e),n==="offer"?s=>{this.logSDPExchange(s,"answer",i==="local"?"remote":"local",r)}:void 0}async getRemoteSSRC(e){if(!this.remoteSDP)return;const n=this.remoteSDP.getSSRC(e);return n&&n.length!==0?n[0].ssrcId:void 0}setConfiguration(e){if(Jt().supportPCSetConfiguration){const n=Lc.resolvePCConfiguration(e);this.peerConnection.setConfiguration(n)}e.isPreallocation&&(this.isPreallocation=!0)}},ot(se.prototype,"updateRemoteRTPCapabilities",[Oi],Object.getOwnPropertyDescriptor(se.prototype,"updateRemoteRTPCapabilities"),se.prototype),ot(se.prototype,"connect",[Oi],Object.getOwnPropertyDescriptor(se.prototype,"connect"),se.prototype),ot(se.prototype,"updateRemoteConnect",[Oi],Object.getOwnPropertyDescriptor(se.prototype,"updateRemoteConnect"),se.prototype),ot(se.prototype,"createDataChannels",[Oi],Object.getOwnPropertyDescriptor(se.prototype,"createDataChannels"),se.prototype),ot(se.prototype,"receive",[Oi],Object.getOwnPropertyDescriptor(se.prototype,"receive"),se.prototype),ot(se.prototype,"batchReceive",[Oi],Object.getOwnPropertyDescriptor(se.prototype,"batchReceive"),se.prototype),ot(se.prototype,"stopReceiving",[Oi],Object.getOwnPropertyDescriptor(se.prototype,"stopReceiving"),se.prototype),ot(se.prototype,"muteRemote",[Oi],Object.getOwnPropertyDescriptor(se.prototype,"muteRemote"),se.prototype),ot(se.prototype,"unmuteRemote",[Oi],Object.getOwnPropertyDescriptor(se.prototype,"unmuteRemote"),se.prototype),ot(se.prototype,"muteLocal",[Oi],Object.getOwnPropertyDescriptor(se.prototype,"muteLocal"),se.prototype),ot(se.prototype,"unmuteLocal",[Oi],Object.getOwnPropertyDescriptor(se.prototype,"unmuteLocal"),se.prototype),ot(se.prototype,"close",[Oi],Object.getOwnPropertyDescriptor(se.prototype,"close"),se.prototype),ot(se.prototype,"updateEncoderConfig",[Oi],Object.getOwnPropertyDescriptor(se.prototype,"updateEncoderConfig"),se.prototype),ot(se.prototype,"updateSendParameters",[Oi],Object.getOwnPropertyDescriptor(se.prototype,"updateSendParameters"),se.prototype),ot(se.prototype,"replaceTrack",[Oi],Object.getOwnPropertyDescriptor(se.prototype,"replaceTrack"),se.prototype),ot(se.prototype,"updateAdaptation",[Oi],Object.getOwnPropertyDescriptor(se.prototype,"updateAdaptation"),se.prototype),ot(se.prototype,"getRemoteSSRC",[Oi],Object.getOwnPropertyDescriptor(se.prototype,"getRemoteSSRC"),se.prototype),se);function Oi(t,e,n){const i=t[e];if(typeof i!="function")throw new Error("Cannot use mutex on object property.");return n.value=async function(){const r=this.mutex,s=await r.lock("From P2PConnection.".concat(e));try{for(var o=arguments.length,a=new Array(o),c=0;c<o;c++)a[c]=arguments[c];return await i.apply(this,a)}finally{s()}},n}function CT(t,e){let n=document.createElement("video"),i=document.createElement("canvas");n.setAttribute("style","display:none"),i.setAttribute("style","display:none"),n.setAttribute("muted",""),n.muted=!0,n.setAttribute("autoplay",""),n.autoplay=!0,n.setAttribute("playsinline",""),i.width=wi(e.width),i.height=wi(e.height);const r=wi(e.framerate||15);document.body.append(n),document.body.append(i);let s=t._mediaStreamTrack;n.srcObject=new MediaStream([s]),n.play().catch(su);const o=i.getContext("2d");if(!o)throw new B(A.UNEXPECTED_ERROR,"can not get canvas context");const a=Jt(),c=i.captureStream(a.supportRequestFrame?0:r).getVideoTracks()[0];c.canvas||(c.canvas=i),i.startCapture=()=>{if(!n)return i.stopCapture&&i.stopCapture();if(n.paused&&n.play(),n.videoHeight>2&&n.videoWidth>2){const l=n.videoWidth,h=n.videoHeight/l,p=i.width*h;Math.abs(p-i.height)>=2&&(m.debug("adjust low stream resolution","".concat(i.width,"x").concat(i.height," -> ").concat(i.width,"x").concat(p)),i.height=p)}o.drawImage(n,0,0,i.width,i.height),c.requestFrame&&c.requestFrame(),s!==t._mediaStreamTrack&&(s=t._mediaStreamTrack,n.srcObject=new MediaStream([s]))},i.stopCapture=CS((()=>i.startCapture&&i.startCapture()),r);const d=c.stop;return c.stop=()=>{d.call(c),n&&(n.remove(),n.srcObject=null,n=null),i&&(i.width=0,i.remove(),i.stopCapture&&i.stopCapture(),i.startCapture=void 0,i.stopCapture=void 0,i=null),m.debug("clean low stream renderer")},c}var UP=(function(t){return t[t.Video_Send_Type=190]="Video_Send_Type",t})(UP||{}),Os=(function(t){return t[t.Video_Send_Qp_Sum=2143]="Video_Send_Qp_Sum",t[t.Video_Send_Freeze=2082]="Video_Send_Freeze",t[t.Video_Recv_Qp_Sum=2144]="Video_Recv_Qp_Sum",t[t.Video_Recv_Freeze=2084]="Video_Recv_Freeze",t[t.Video_Render_Freeze_Time=2109]="Video_Render_Freeze_Time",t[t.Video_Render_Freeze_Time_Render=2147]="Video_Render_Freeze_Time_Render",t[t.Video_Render_Freeze_Time_Render2=2223]="Video_Render_Freeze_Time_Render2",t[t.Audio_Recv_Freeze=2083]="Audio_Recv_Freeze",t})(Os||{}),xt=(function(t){return t[t.Video_Send_Retransmit=2062]="Video_Send_Retransmit",t[t.Video_Send_Target_Encoded=2064]="Video_Send_Target_Encoded",t[t.Video_Send_Actual_Encoded=2060]="Video_Send_Actual_Encoded",t[t.Video_Send_Transmit=2066]="Video_Send_Transmit",t[t.Video_Send_Bandwidth=2061]="Video_Send_Bandwidth",t[t.Video_Capture_Height=2033]="Video_Capture_Height",t[t.Video_Capture_Width=2035]="Video_Capture_Width",t[t.Video_Capture_Frame_Rate=2034]="Video_Capture_Frame_Rate",t[t.Video_Send_Low_Height=2073]="Video_Send_Low_Height",t[t.Video_Send_Low_Frame_Rate=2075]="Video_Send_Low_Frame_Rate",t[t.Video_Send_Low_Width=2077]="Video_Send_Low_Width",t[t.Video_Send_Low_Bitrate=2069]="Video_Send_Low_Bitrate",t[t.Video_Send_Low_Package_Lost=2070]="Video_Send_Low_Package_Lost",t[t.Video_Send_Low_Package_Rate=2071]="Video_Send_Low_Package_Rate",t[t.Video_Send_Frame_Rate=2002]="Video_Send_Frame_Rate",t[t.Video_Send_Width=2003]="Video_Send_Width",t[t.Video_Send_Height=2004]="Video_Send_Height",t[t.Video_Send_Disabled=2095]="Video_Send_Disabled",t[t.Video_Send_Adaptation=2032]="Video_Send_Adaptation",t[t.Video_Send_Player_Status=2128]="Video_Send_Player_Status",t[t.Video_Send_Nacks=2009]="Video_Send_Nacks",t[t.Video_Send_Plis=2010]="Video_Send_Plis",t[t.Video_Send_Firs=2011]="Video_Send_Firs",t[t.Video_Send_Avg_Encode=2007]="Video_Send_Avg_Encode",t[t.Video_Send_Huge_Frame_Sent=2174]="Video_Send_Huge_Frame_Sent",t[t.Video_Send_Bytes_Retransmit=2173]="Video_Send_Bytes_Retransmit",t[t.Video_Send_Packages_Retransmit=2172]="Video_Send_Packages_Retransmit",t[t.Video_Send_Key_Frames_Encoded=2207]="Video_Send_Key_Frames_Encoded",t[t.Video_Send_Bitrate=2012]="Video_Send_Bitrate",t[t.Video_Send_Package_Rate=2031]="Video_Send_Package_Rate",t[t.Video_Send_Package_Lost=2005]="Video_Send_Package_Lost",t[t.Audio_Capture_PCM_Level=2104]="Audio_Capture_PCM_Level",t[t.Audio_Send_Level=2038]="Audio_Send_Level",t[t.Audio_Send_Bitrate=2039]="Audio_Send_Bitrate",t[t.Audio_Send_Package_Rate=2040]="Audio_Send_Package_Rate",t[t.Audio_Send_AEC_Return_Loss=2041]="Audio_Send_AEC_Return_Loss",t[t.Audio_Send_AEC_Return_Loss_Enhancement=2042]="Audio_Send_AEC_Return_Loss_Enhancement",t[t.Audio_Send_Freeze=2081]="Audio_Send_Freeze",t[t.Audio_Send_Disabled=2096]="Audio_Send_Disabled",t[t.Audio_Send_Bytes_Retransmit=2179]="Audio_Send_Bytes_Retransmit",t[t.Audio_Send_Packages_Retransmit=2180]="Audio_Send_Packages_Retransmit",t[t.Video_Recv_Height=2019]="Video_Recv_Height",t[t.Video_Recv_Width=2018]="Video_Recv_Width",t[t.Video_Recv_Frame_Rate_Output=2155]="Video_Recv_Frame_Rate_Output",t[t.Video_Recv_Jitter_Buffer=2023]="Video_Recv_Jitter_Buffer",t[t.Video_Recv_Current_Delay=2024]="Video_Recv_Current_Delay",t[t.Video_Recv_Nacks=2026]="Video_Recv_Nacks",t[t.Video_Recv_Plis=2027]="Video_Recv_Plis",t[t.Video_Recv_Firs=2028]="Video_Recv_Firs",t[t.Video_Recv_Disabled=2101]="Video_Recv_Disabled",t[t.Video_Recv_Player_Status=2129]="Video_Recv_Player_Status",t[t.Video_Recv_I_Frame_Delay=2149]="Video_Recv_I_Frame_Delay",t[t.Video_Render_Frame_Rate_Render=2022]="Video_Render_Frame_Rate_Render",t[t.Video_Render_Freeze_Duration=2156]="Video_Render_Freeze_Duration",t[t.Audio_Render_Level=2043]="Audio_Render_Level",t[t.Audio_Render_Freeze_Time_80ms=2226]="Audio_Render_Freeze_Time_80ms",t[t.Audio_Render_Freeze_Time_200ms=2227]="Audio_Render_Freeze_Time_200ms",t[t.Audio_Render_Freeze_Samples_80ms=2228]="Audio_Render_Freeze_Samples_80ms",t[t.Audio_Render_Freeze_Samples_200ms=2229]="Audio_Render_Freeze_Samples_200ms",t[t.Audio_Recv_PCM_Level=2105]="Audio_Recv_PCM_Level",t[t.Audio_Recv_Disabled=2102]="Audio_Recv_Disabled",t[t.Audio_Recv_Jitter_Buffer=2054]="Audio_Recv_Jitter_Buffer",t[t.Audio_Recv_Current_Delay=2047]="Audio_Recv_Current_Delay",t[t.Audio_Recv_Player_Status=2130]="Audio_Recv_Player_Status",t[t.Audio_Recv_Bitrate=2044]="Audio_Recv_Bitrate",t[t.Audio_Recv_Concealed_Samples=2148]="Audio_Recv_Concealed_Samples",t[t.Audio_Recv_Total_Samples_Received=2224]="Audio_Recv_Total_Samples_Received",t})(xt||{}),Ln=(function(t){return t[t.Video_Render_Frame_Rate_Decode=2021]="Video_Render_Frame_Rate_Decode",t[t.Video_Recv_Frame_Rate=2020]="Video_Recv_Frame_Rate",t[t.Video_Recv_Frame_Dropped=2181]="Video_Recv_Frame_Dropped",t[t.Video_Recv_Bytes_Retransmit=2175]="Video_Recv_Bytes_Retransmit",t[t.Video_Recv_Packages_Retransmit=2176]="Video_Recv_Packages_Retransmit",t[t.Video_Recv_Packages_Discarded=2198]="Video_Recv_Packages_Discarded",t[t.Video_Recv_Avg_Decode=2200]="Video_Recv_Avg_Decode",t[t.Video_Recv_Avg_Processing_Delay=2202]="Video_Recv_Avg_Processing_Delay",t[t.Video_Recv_Avg_Assembly_Time=2203]="Video_Recv_Avg_Assembly_Time",t[t.Video_Recv_Avg_Inter_Frame_Delay=2204]="Video_Recv_Avg_Inter_Frame_Delay",t[t.Video_Recv_Key_Frames_Decoded=2206]="Video_Recv_Key_Frames_Decoded",t[t.Video_Recv_Package_Lost=2014]="Video_Recv_Package_Lost",t[t.Video_Recv_Bitrate=2029]="Video_Recv_Bitrate",t[t.Video_Recv_Package_Rate=2078]="Video_Recv_Package_Rate",t[t.Audio_Recv_Jitter=2055]="Audio_Recv_Jitter",t[t.Audio_Recv_Bytes_Retransmit=2178]="Audio_Recv_Bytes_Retransmit",t[t.Audio_Recv_Packages_Retransmit=2177]="Audio_Recv_Packages_Retransmit",t[t.Audio_Recv_Packages_Discarded=2199]="Audio_Recv_Packages_Discarded",t[t.Audio_Recv_Avg_Processing_Delay=2201]="Audio_Recv_Avg_Processing_Delay",t[t.Audio_Recv_Package_Rate=2046]="Audio_Recv_Package_Rate",t[t.Audio_Recv_Package_Lost=2045]="Audio_Recv_Package_Lost",t[t.Audio_Recv_AV_Sync_TIME=2237]="Audio_Recv_AV_Sync_TIME",t})(Ln||{}),qn=(function(t){return t[t.RTT=2006]="RTT",t[t.CONN_TYPE=801]="CONN_TYPE",t[t.STATS_UPDATE_INTERVAL=2205]="STATS_UPDATE_INTERVAL",t})(qn||{}),qd=(function(t){return t[t.RTC_PEER_CONNECTION_STATE=2219]="RTC_PEER_CONNECTION_STATE",t[t.PAGE_VISIBILITY=2233]="PAGE_VISIBILITY",t})(qd||{}),yT=(function(t){return t[t.Transport_Send_Bitrate=2234]="Transport_Send_Bitrate",t[t.Transport_Recv_Bitrate=2235]="Transport_Recv_Bitrate",t})(yT||{});const mc=1e3,V_=6,yu=3,KY=Math.max(V_,yu,60);function wt(t,e,n){n!=null&&Number.isFinite(n)&&(t[e]=Math.round(Math.max(0,n)))}function xP(t){const e={[qn.CONN_TYPE]:0,[qn.RTT]:t.rtt,[qn.STATS_UPDATE_INTERVAL]:t.updateInterval?Math.round(Math.max(0,t.updateInterval)):void 0};switch(t.selectedCandidatePair.localCandidate.candidateType){case"relay":{const n=t.selectedCandidatePair.localCandidate.relayProtocol;n==="udp"&&(e[qn.CONN_TYPE]=1),n==="tcp"&&(e[qn.CONN_TYPE]=3),n==="tls"&&(e[qn.CONN_TYPE]=4);break}case"srflx":e[qn.CONN_TYPE]=2;break;case"unknown":e[qn.CONN_TYPE]=5;break;default:e[qn.CONN_TYPE]=0}return e}function VP(t){let e=0;switch(t){case"none":e=0;break;case"cpu":e=1;break;case"bandwidth":e=2;break;case"other":e=3}return e}class FP extends qe{constructor(e){super(),R(this,"store",void 0),R(this,"uploadWRTCStatsTimer",void 0),R(this,"uploadOutboundDenoiserStatsTimer",void 0),R(this,"uploadExtStatsTimer",void 0),R(this,"uploadExtUsageStatsTimer",void 0),R(this,"uploadInboundExtStatsTimer",void 0),R(this,"requestStats",void 0),R(this,"requestTransportStats",void 0),R(this,"requestLocalMedia",void 0),R(this,"requestRemoteMedia",void 0),R(this,"requestAllTracks",void 0),R(this,"requestVideoIsReady",void 0),R(this,"requestUploadStats",void 0),R(this,"requestUpload",void 0),R(this,"uploadOutboundStarted",!1),R(this,"uploadInboundStarted",!1),R(this,"uploadTransportStarted",!1),R(this,"uploadBaseStatsStarted",!1),R(this,"uploadExtensionUsageStarted",!1),R(this,"lastRecvStats",void 0),R(this,"lastSendStats",void 0),R(this,"lastRefRecvStats",void 0),R(this,"lastRefSendStats",void 0),R(this,"lastNormalRecvStats",void 0),R(this,"lastNormalSendStats",void 0),R(this,"lastExtendStats",{}),R(this,"needUploadStats",{}),R(this,"needUploadRenderFreezeTime",!0),R(this,"lastUploadCompensateTime",-1),R(this,"uploadCompensateDeltaTime",0),this.store=e}uploadWRTCStats(e){if(!this.requestStats||!this.requestUploadStats)return;const n=e%yu==0,i=e%V_==0,r=e%60==0;let s,o;if(this.uploadTransportStarted&&(s=this.requestStats(),this.store.useP2P&&(o=this.requestStats(!0))),!s&&this.uploadOutboundStarted&&(s=this.requestStats()),!o&&this.uploadInboundStarted&&(o=this.requestStats(!0)),s||o){var a;const c={};if(this.uploadTransportStarted&&s){const l=this.getTransportStats(s,n?this.lastRefSendStats:void 0,o,n);l&&(c.misc=[l])}if(this.uploadOutboundStarted&&s){const l=this.getOutboundStats(s,i?this.lastNormalSendStats:void 0,n?this.lastRefSendStats:void 0,this.lastSendStats,r);l&&(c.outbound=[l])}if(this.uploadInboundStarted&&o){this.uploadCompensateStats(e);const l=this.getInboundStats(o,i?this.lastNormalRecvStats:void 0,n?this.lastRefRecvStats:void 0,this.lastRecvStats);l&&(c.inbound=l)}const d=(a=this.requestTransportStats)===null||a===void 0?void 0:a.call(this).connectState;if(d&&(Array.isArray(c.misc)?c.misc[0]&&c.misc[0].addition&&(c.misc[0].addition[qd.RTC_PEER_CONNECTION_STATE]=aS[d]):c.misc=[{addition:{[qd.RTC_PEER_CONNECTION_STATE]:aS[d]}}]),Qi.needUploadStats.length>0||i){const l=Qi.needUploadStats.shift()||(Qi.visibility==="visible"?1:0);Array.isArray(c.misc)?c.misc[0]&&c.misc[0].addition&&(c.misc[0].addition[qd.PAGE_VISIBILITY]=l):c.misc=[{addition:{[qd.PAGE_VISIBILITY]:l}}]}this.needUploadStats.sendType&&(Array.isArray(c.outbound)&&c.outbound[0]&&c.outbound[0].high&&(c.outbound[0].high[UP.Video_Send_Type]=this.needUploadStats.sendType),this.needUploadStats.sendType=void 0),this.requestUploadStats(c)}this.lastRecvStats=o,this.lastSendStats=s,i&&(this.lastNormalRecvStats=o,this.lastNormalSendStats=s),n&&(this.lastRefRecvStats=o,this.lastRefSendStats=s)}startUploadWRTCStats(){if(this.uploadWRTCStatsTimer)return;this.uploadBaseStatsStarted=!0,Qi.startCollectStats();let e=1;this.uploadWRTCStatsTimer=window.setInterval((()=>{if(!this.uploadTransportStarted&&!this.uploadInboundStarted&&!this.uploadOutboundStarted){if(this.uploadBaseStatsStarted){var n,i;const r=(n=this.requestTransportStats)===null||n===void 0?void 0:n.call(this);return void(r&&((i=this.requestUploadStats)===null||i===void 0||i.call(this,{misc:[{addition:{[qd.RTC_PEER_CONNECTION_STATE]:aS[r.connectState]}}]})))}return this.stopUploadWRTCStats()}this.uploadWRTCStats(e),++e===KY+1&&(e=1)}),mc)}uploadCompensateStats(e){if(!this.requestStats||!this.requestUploadStats||!this.requestRemoteMedia)return;const n=e%yu==0&&this.needUploadRenderFreezeTime;if(!this.uploadInboundStarted||!n)return;if(this.lastUploadCompensateTime===-1)return void(this.lastUploadCompensateTime=Date.now());const i=Math.max(-6e3,Date.now()-this.lastUploadCompensateTime-6e3);if(this.uploadCompensateDeltaTime+=i,this.lastUploadCompensateTime=Date.now(),this.uploadCompensateDeltaTime<6e3)return;const r=Math.min(Math.floor(this.uploadCompensateDeltaTime/6e3),10);this.uploadCompensateDeltaTime-=6e3*r;const s=this.requestStats(!0);new Array(r).fill(0).forEach((()=>{if(!this.requestStats||!this.requestUploadStats||!this.requestRemoteMedia)return;const o={};if(this.uploadInboundStarted&&s){const a=this.requestRemoteMedia()||[],c=[];a.forEach((d=>{let[l,h]=d;const p={peer:l.uid};if(l._videoSSRC&&this.requestVideoIsReady&&this.requestVideoIsReady(l._videoSSRC)&&h.has(ut.VIDEO)&&l.videoTrack){const f=(function(v,S,T){if(!S.videoRecv.find((w=>w.ssrc===v)))return;const b={};if(T&&T._player){const w=T._player,{renderFreezeAccTime2:D,videoElementStatus:k}=w;if(Qi.visibility==="visible"&&k===ti.PLAYING&&Jt().supportRequestVideoFrameCallback){const U=Math.min(6e3,D);w.renderFreezeAccTime2=Math.max(0,D-U),wt(b,Os.Video_Render_Freeze_Time_Render2,U),I("USE_NEW_RENDER_FREEZE_TIME")&&wt(b,Os.Video_Render_Freeze_Time_Render,U)}}return b})(l._videoSSRC,s,l.videoTrack);f&&(p.video=f)}p.video&&c.push(p)})),c.length>0&&(o.inbound=c,this.requestUploadStats(o))}}))}stopUploadWRTCStats(){window.clearInterval(this.uploadWRTCStatsTimer),this.uploadWRTCStatsTimer=void 0,this.lastSendStats&&(this.lastSendStats.videoSend=[],this.lastSendStats.audioSend=[],this.lastSendStats=void 0),this.lastRecvStats&&(this.lastRecvStats.videoRecv=[],this.lastRecvStats.audioRecv=[],this.lastRecvStats=void 0),this.lastRefSendStats&&(this.lastRefSendStats.videoSend=[],this.lastRefSendStats.audioSend=[],this.lastRefSendStats=void 0),this.lastRefRecvStats&&(this.lastRefRecvStats.videoRecv=[],this.lastRefRecvStats.audioRecv=[],this.lastRefRecvStats=void 0),this.lastNormalSendStats&&(this.lastNormalSendStats.videoSend=[],this.lastNormalSendStats.audioSend=[],this.lastNormalSendStats=void 0),this.lastNormalRecvStats&&(this.lastNormalRecvStats.videoRecv=[],this.lastNormalRecvStats.audioRecv=[],this.lastNormalRecvStats=void 0),this.lastExtendStats={},this.needUploadStats={},this.lastUploadCompensateTime=-1,this.uploadCompensateDeltaTime=0,this.needUploadRenderFreezeTime=!0}getTransportStats(e,n,i,r){if(!this.requestStats)return;if(!r)return e.rtt==null?void 0:{addition:{[qn.RTT]:e.rtt,[qn.CONN_TYPE]:void 0,[qn.STATS_UPDATE_INTERVAL]:e.updateInterval||void 0}};const s=xP(e);if(this.store.useP2P){if(i){const o=xP(i);s[qn.CONN_TYPE]&&o[qn.CONN_TYPE]&&(s[qn.CONN_TYPE]+=o[qn.CONN_TYPE]<<3)}s[qn.CONN_TYPE]?s[qn.CONN_TYPE]+=110:s[qn.CONN_TYPE]=110}else{s[qn.CONN_TYPE]?s[qn.CONN_TYPE]+=100:s[qn.CONN_TYPE]=100;const o=(function(a,c){return c?[Math.ceil(8*(a.transport.bytesSent-c.transport.bytesSent)/(a.timestamp-c.timestamp)),Math.ceil(8*(a.transport.bytesReceived-c.transport.bytesReceived)/(a.timestamp-c.timestamp))]:[0,0]})(e,n);s[yT.Transport_Send_Bitrate]=o[0],s[yT.Transport_Recv_Bitrate]=o[1]}return{addition:s}}getOutboundStats(e,n,i,r,s){if(!this.requestUploadStats||!this.requestLocalMedia)return;const o=this.requestLocalMedia();if(!o||o.length===0)return;let a,c,d;return o.forEach((l=>{let[h,{track:p,ssrcs:f}]=l;switch(h){case tt.LocalVideoLowTrack:case tt.LocalVideoTrack:if(h===tt.LocalVideoTrack){var v;const S=(function(D,k,U,P,x,q){const Q=k.videoSend.find((Wt=>Wt.ssrc===D));if(!Q)return;const dt={},{sentFrame:Dt,inputFrame:Ot}=Q;if(P&&(wt(dt,Os.Video_Send_Qp_Sum,Q.qpSumPerFrame),Ot&&Dt)){const Wt=Ot.frameRate,Vt=Dt.frameRate;dt[Os.Video_Send_Freeze]=(function(pe,He){let X=!0;return X=!(pe<=5)&&(pe<=10?He<3:pe<=20?He<4:He<5),X})(Wt,Vt)?1:0}if(x){switch(Dt&&(wt(dt,xt.Video_Send_Height,Dt.height),wt(dt,xt.Video_Send_Width,Dt.width),wt(dt,xt.Video_Send_Frame_Rate,Dt.frameRate)),dt[xt.Video_Send_Disabled]=U._originMediaStreamTrack&&!U._originMediaStreamTrack.enabled||U._mediaStreamTrack&&!U._mediaStreamTrack.enabled?1:0,Q.adaptionChangeReason){case"none":dt[xt.Video_Send_Adaptation]=0;break;case"cpu":dt[xt.Video_Send_Adaptation]=1;break;case"bandwidth":dt[xt.Video_Send_Adaptation]=2;break;case"other":dt[xt.Video_Send_Adaptation]=3}let Wt=0;Q.adaptionChangeReason&&(Wt+=VP(Q.adaptionChangeReason)),k.qualityLimitationReason&&(Wt+=VP(k.qualityLimitationReason)<<3),dt[xt.Video_Send_Adaptation]=Wt,dt[xt.Video_Send_Player_Status]=TS[U._player?U._player.videoElementStatus:"uninit"],wt(dt,xt.Video_Send_Nacks,Q.nacksCount),wt(dt,xt.Video_Send_Plis,Q.plisCount),wt(dt,xt.Video_Send_Firs,Q.firsCount),wt(dt,xt.Video_Send_Avg_Encode,Q.avgEncodeMs),wt(dt,xt.Video_Send_Huge_Frame_Sent,Q.hugeFramesSent),wt(dt,xt.Video_Send_Bytes_Retransmit,Q.retransmittedBytesSent),wt(dt,xt.Video_Send_Packages_Retransmit,Q.retransmittedPacketsSent),wt(dt,xt.Video_Send_Key_Frames_Encoded,Q.keyFramesEncoded);const Vt=x.videoSend.find((pe=>pe.ssrc===D));if(Vt){let pe=mc*yu;Vt.timestamp&&Q.timestamp&&(pe=Q.timestamp-Vt.timestamp),Vt.packets!=null&&Q.packets!=null&&wt(dt,xt.Video_Send_Package_Rate,1e3*(Q.packets-Vt.packets)/pe),Q.packetsLost!=null&&Vt.packetsLost!=null&&wt(dt,xt.Video_Send_Package_Lost,Q.packetsLost-Vt.packetsLost),Vt.bytes!=null&&Q.bytes!=null&&wt(dt,xt.Video_Send_Bitrate,8*(Q.bytes-Vt.bytes)/pe)}}return dt})(f[0].ssrcId,e,p,n,i),T=p.__className__==="CameraVideoTrack"?3:$(v=p._hints).call(v,Ee.SCREEN_TRACK)?7:10;(this.lastExtendStats.sendType!==T||s)&&(this.needUploadStats={sendType:T},this.lastExtendStats.sendType=T);const b=p&&(function(D,k,U,P){const x=k.videoSend.find((Q=>Q.ssrc===D));if(!x)return null;const q={};if(P){const Q=x.inputFrame,dt=Q&&Q.height||U.videoHeight||0,Dt=Q&&Q.width||U.videoWidth||0,Ot=Q&&Q.frameRate||0;wt(q,xt.Video_Capture_Height,dt),wt(q,xt.Video_Capture_Width,Dt),wt(q,xt.Video_Capture_Frame_Rate,Ot)}return q})(f[0].ssrcId,e,p,!!i),w=(function(D,k){const U={};return k&&(wt(U,xt.Video_Send_Retransmit,D.bitrate.retransmit),wt(U,xt.Video_Send_Target_Encoded,D.bitrate.targetEncoded),wt(U,xt.Video_Send_Actual_Encoded,D.bitrate.actualEncoded),wt(U,xt.Video_Send_Transmit,D.bitrate.transmit),wt(U,xt.Video_Send_Bandwidth,D.sendBandwidth)),U})(e,!!i);c=Object.assign({},S,b,w)}else d=(function(S,T,b,w,D){const k=T.videoSend.find((P=>P.ssrc===S));if(!k)return;const U={};if(w){const P=k.sentFrame;P&&(wt(U,xt.Video_Send_Low_Height,P.height),wt(U,xt.Video_Send_Low_Width,P.width),wt(U,xt.Video_Send_Low_Frame_Rate,P.frameRate));const x=w.videoSend.find((q=>q.ssrc===S));if(x){let q=mc*V_;x.timestamp&&k.timestamp&&(q=k.timestamp-x.timestamp),x.packets!=null&&k.packets!=null&&wt(U,xt.Video_Send_Low_Package_Rate,1e3*(k.packets-x.packets)/q),k.packetsLost!=null&&x.packetsLost!=null&&wt(U,xt.Video_Send_Low_Package_Lost,k.packetsLost-x.packetsLost),x.bytes!=null&&k.bytes!=null&&wt(U,xt.Video_Send_Low_Bitrate,8*(k.bytes-x.bytes)/q)}}return U})(f[0].ssrcId,e,0,i);break;case tt.LocalAudioTrack:a=p&&(function(S,T,b,w,D,k){const U=T.audioSend.find((x=>x.ssrc===S));if(!U)return;const P={};if(D){P[xt.Audio_Send_Disabled]=b._originMediaStreamTrack&&!b._originMediaStreamTrack.enabled||b._mediaStreamTrack&&!b._mediaStreamTrack.enabled?1:0;const x=100*b._source.getAccurateVolumeLevel(),q=U.inputLevel;if(q!=null){const dt=Math.ceil(50*Math.log10(100*q+1));wt(P,xt.Audio_Send_Level,dt)}wt(P,xt.Audio_Capture_PCM_Level,x),wt(P,xt.Audio_Send_AEC_Return_Loss,U.aecReturnLoss),wt(P,xt.Audio_Send_AEC_Return_Loss_Enhancement,U.aecReturnLossEnhancement),wt(P,xt.Audio_Send_Bytes_Retransmit,U.retransmittedBytesSent),wt(P,xt.Audio_Send_Packages_Retransmit,U.retransmittedPacketsSent),P[xt.Audio_Send_Freeze]=0;const Q=D.audioSend.find((dt=>dt.ssrc===S));if(Q){let dt=mc*V_;Q.timestamp&&U.timestamp&&(dt=U.timestamp-Q.timestamp),Q.bytes!=null&&U.bytes!=null&&wt(P,xt.Audio_Send_Bitrate,8*(U.bytes-Q.bytes)/dt),Q.packets!=null&&U.packets!=null&&wt(P,xt.Audio_Send_Package_Rate,1e3*(U.packets-Q.packets)/dt)}}return P})(f[0].ssrcId,e,p,0,i)}})),{high:c,low:d,audio:a}}getInboundStats(e,n,i,r){if(!this.requestRemoteMedia)return;const s=this.requestRemoteMedia()||[],o=[];return s.forEach((a=>{let[c,d]=a;const l={peer:c.uid};let h;if(d.has(ut.VIDEO)&&c.videoTrack){const p=c._videoSSRC&&this.requestVideoIsReady&&this.requestVideoIsReady(c._videoSSRC)||!1,f=c.videoTrack?(function(v,S,T,b,w,D,k,U){const P=S.videoRecv.find((Vt=>Vt.ssrc===v));if(!P)return;const x={},{receivedFrame:q,outputFrame:Q,decodeFrameRate:dt}=P;wt(x,Ln.Video_Render_Frame_Rate_Decode,dt),P.framesRateFirefox&&wt(x,Ln.Video_Recv_Frame_Rate,P.framesRateFirefox),q&&wt(x,Ln.Video_Recv_Frame_Rate,q.frameRate),wt(x,Ln.Video_Recv_Frame_Dropped,P.framesDroppedCount),wt(x,Ln.Video_Recv_Bytes_Retransmit,P.retransmittedBytesReceived),wt(x,Ln.Video_Recv_Packages_Retransmit,P.retransmittedPacketsReceived),wt(x,Ln.Video_Recv_Packages_Discarded,P.packetsDiscarded),wt(x,Ln.Video_Recv_Avg_Decode,P.avgDecodeMs),wt(x,Ln.Video_Recv_Avg_Processing_Delay,P.avgProcessingDelayMs),wt(x,Ln.Video_Recv_Avg_Assembly_Time,P.avgFramesAssembledFromMultiplePacketsMs),wt(x,Ln.Video_Recv_Avg_Inter_Frame_Delay,P.avgInterFrameDelayMs),wt(x,Ln.Video_Recv_Key_Frames_Decoded,P.keyFramesDecoded);const Dt=U&&U.videoRecv.find((Vt=>Vt.ssrc===v));if(Dt){const Vt=S.timestamp-U.timestamp||mc;P.packetsLost!=null&&Dt.packetsLost!=null&&wt(x,Ln.Video_Recv_Package_Lost,P.packetsLost-Dt.packetsLost),Dt.bytes!=null&&P.bytes!=null&&wt(x,Ln.Video_Recv_Bitrate,8*(P.bytes-Dt.bytes)/Vt),Dt.packets!=null&&P.packets!=null&&wt(x,Ln.Video_Recv_Package_Rate,1e3*(P.packets-Dt.packets)/Vt)}const Ot=D&&D.videoRecv.find((Vt=>Vt.ssrc===v));if(Ot&&(wt(x,Os.Video_Recv_Qp_Sum,P.qpSumPerFrame),x[Os.Video_Recv_Freeze]=b&&vu.isRemoteVideoFreeze(T,P,Ot)?1:0),k){var Wt;const Vt=k.videoRecv.find((He=>He.ssrc===v));q?(wt(x,xt.Video_Recv_Height,q.height),wt(x,xt.Video_Recv_Width,q.width)):T&&(wt(x,xt.Video_Recv_Height,T._videoHeight||0),wt(x,xt.Video_Recv_Width,T._videoWidth||0)),Q&&wt(x,xt.Video_Recv_Frame_Rate_Output,Q.frameRate);const pe=(Wt=T._player)===null||Wt===void 0?void 0:Wt.rendFrameRate.toFixed(0);if(pe&&wt(x,xt.Video_Render_Frame_Rate_Render,+pe),wt(x,xt.Video_Recv_Jitter_Buffer,P.jitterBufferMs),wt(x,xt.Video_Recv_Current_Delay,P.currentDelayMs),wt(x,xt.Video_Recv_Firs,P.firsCount),wt(x,xt.Video_Recv_Nacks,P.nacksCount),wt(x,xt.Video_Recv_Plis,P.plisCount),T){x[xt.Video_Recv_Disabled]=T._originMediaStreamTrack.enabled&&T._mediaStreamTrack.enabled?0:1;const He=T._player;if(He){const{freezeTimeCounterList:X,renderFreezeAccTime:rt,renderFreezeAccTime2:ht,videoElementStatus:J}=He;if(X&&X.length>0&&wt(x,Os.Video_Render_Freeze_Time,X.splice(0,1)[0]),w&&Qi.visibility==="visible"&&J===ti.PLAYING&&Jt().supportRequestVideoFrameCallback){const g=Math.min(6e3,ht);He.renderFreezeAccTime2=Math.max(0,ht-g),wt(x,Os.Video_Render_Freeze_Time_Render2,g);const N=Math.min(6e3,rt);He.renderFreezeAccTime=Math.max(0,rt-N),wt(x,Os.Video_Render_Freeze_Time_Render,I("USE_NEW_RENDER_FREEZE_TIME")?g:N)}if(typeof P.totalFreezesDuration=="number"){const g=Vt&&Vt.totalFreezesDuration?P.totalFreezesDuration-Vt.totalFreezesDuration:P.totalFreezesDuration;wt(x,xt.Video_Render_Freeze_Duration,1e3*g)}}}if(x[xt.Video_Recv_Player_Status]=TS[T._player?T._player.videoElementStatus:"uninit"],Vt&&P.totalInterFrameDelay!==void 0&&P.totalSquaredInterFrameDelay!==void 0&&Vt.totalInterFrameDelay!==void 0&&Vt.totalSquaredInterFrameDelay!==void 0){const He=P.totalInterFrameDelay-Vt.totalInterFrameDelay,X=P.totalSquaredInterFrameDelay-Vt.totalSquaredInterFrameDelay,rt=P.framesDecodeCount-Vt.framesDecodeCount,ht=He/rt*1e3,J=Math.round(1e3*Math.sqrt((X-Math.pow(He,2)/rt)/rt));!isNaN(J)&&ht+J>Math.max(3*ht,ht+150)&&(x[xt.Video_Recv_I_Frame_Delay]=J)}}return x})(c._videoSSRC,e,c.videoTrack,p===!0,this.needUploadRenderFreezeTime,n,i,r):void 0;if(f&&(l.video=f),c.videoTrack){const v=e.videoRecv.find((S=>S.ssrc===c._videoSSRC));v&&v.estimatedPlayoutTimestamp&&(h=v.estimatedPlayoutTimestamp)}}if(d.has(ut.AUDIO)&&c.audioTrack){const p=c.audioTrack?(function(f,v,S,T,b,w){const D=v.audioRecv.find((x=>x.ssrc===f));if(!D)return;const k={};wt(k,Ln.Audio_Recv_Jitter,D.jitterMs),wt(k,Ln.Audio_Recv_Bytes_Retransmit,D.retransmittedBytesReceived),wt(k,Ln.Audio_Recv_Packages_Retransmit,D.retransmittedPacketsReceived),wt(k,Ln.Audio_Recv_Packages_Discarded,D.packetsDiscarded),wt(k,Ln.Audio_Recv_Avg_Processing_Delay,D.avgProcessingDelayMs);const U=w&&w.audioRecv.find((x=>x.ssrc===f));if(U){const x=mc;D.packets!=null&&U.packets!=null&&wt(k,Ln.Audio_Recv_Package_Rate,1e3*(D.packets-U.packets)/x),D.packetsLost!=null&&U.packetsLost!=null&&wt(k,Ln.Audio_Recv_Package_Lost,D.packetsLost-U.packetsLost)}if(T){const{receivedFrames:x,droppedFrames:q}=D;x!=null&&q!=null&&(k[Os.Audio_Recv_Freeze]=(P=x)===0||100*q/P>20?1:0)}var P;if(b){const x=100*S._source.getAccurateVolumeLevel(),q=D.outputLevel;if(q!=null){const dt=Math.ceil(50*Math.log10(100*q+1));wt(k,xt.Audio_Render_Level,dt)}wt(k,xt.Audio_Recv_PCM_Level,x),S&&(k[xt.Audio_Recv_Disabled]=S._originMediaStreamTrack.enabled&&S._mediaStreamTrack.enabled?0:1),wt(k,xt.Audio_Recv_Jitter_Buffer,D.jitterBufferMs),wt(k,xt.Audio_Recv_Current_Delay,D.jitterBufferMs),k[xt.Audio_Recv_Player_Status]=TS[ci.getPlayerState(S.getTrackId())];const Q=b.audioRecv.find((dt=>dt.ssrc===f));if(Q){Q.bytes!=null&&D.bytes!=null&&wt(k,xt.Audio_Recv_Bitrate,8*(D.bytes-Q.bytes)/(mc*yu));const dt=D.concealedSamples-Q.concealedSamples;dt>0&&wt(k,xt.Audio_Recv_Concealed_Samples,dt);const Dt=D.totalSamplesReceived-Q.totalSamplesReceived;Dt>0&&wt(k,xt.Audio_Recv_Total_Samples_Received,Dt);const Ot=D.freezeSamples80-Q.freezeSamples80;Ot>0&&wt(k,xt.Audio_Render_Freeze_Samples_80ms,Ot);const Wt=D.freezeSamples200-Q.freezeSamples200;Wt>0&&wt(k,xt.Audio_Render_Freeze_Samples_200ms,Wt);const Vt=D.freezeMs80-Q.freezeMs80;wt(k,xt.Audio_Render_Freeze_Time_80ms,Vt<0?0:Vt);const pe=D.freezeMs200-Q.freezeMs200;wt(k,xt.Audio_Render_Freeze_Time_200ms,pe<0?0:pe)}}return k})(c._audioSSRC,e,c.audioTrack,n,i,r):void 0;if(p&&(l.audio=p),c.audioTrack&&h){const f=e.audioRecv.find((v=>v.ssrc===c._audioSSRC));if(f&&f.estimatedPlayoutTimestamp){const v=f.estimatedPlayoutTimestamp-h;l.audio?l.audio[Ln.Audio_Recv_AV_Sync_TIME]=v:l.audio={[Ln.Audio_Recv_AV_Sync_TIME]:v}}}}(l.video||l.audio)&&o.push(l)})),this.needUploadRenderFreezeTime=!this.needUploadRenderFreezeTime,o}startUploadTransportStats(){this.uploadTransportStarted=!0,this.uploadWRTCStatsTimer||this.startUploadWRTCStats()}stopUploadTransportStats(){this.uploadTransportStarted=!1}startUploadOutboundStats(){this.uploadOutboundStarted||(this.uploadOutboundStarted=!0,this.uploadWRTCStatsTimer||this.startUploadWRTCStats(),this.uploadOutboundDenoiserStatsTimer&&window.clearInterval(this.uploadOutboundDenoiserStatsTimer),this.uploadOutboundDenoiserStatsTimer=window.setInterval((()=>{if(!this.requestAllTracks||!this.requestUpload)return;const e=(this.requestAllTracks()||[]).find((n=>n instanceof uu));if(e&&e._external.getDenoiserStats){const n=e._external.getDenoiserStats();n&&this.requestUpload(hc.DENOISER_STATS,n)}}),2e3),this.uploadExtStatsTimer&&window.clearInterval(this.uploadExtStatsTimer),this.uploadExtStatsTimer=window.setInterval((()=>{!this.requestAllTracks||!this.requestUpload||this.requestAllTracks().forEach((e=>{e.getProcessorStats().forEach((n=>{this.requestUpload&&this.requestUpload(n.type,n.stats)}))}))}),2e3))}stopUploadOutboundStats(){this.uploadOutboundStarted&&(this.uploadOutboundStarted=!1,this.lastSendStats&&(this.lastSendStats.videoSend=[],this.lastSendStats.audioSend=[],this.lastSendStats=void 0),this.lastRefSendStats&&(this.lastRefSendStats.videoSend=[],this.lastRefSendStats.audioSend=[],this.lastRefSendStats=void 0),this.lastNormalSendStats&&(this.lastNormalSendStats.videoSend=[],this.lastNormalSendStats.audioSend=[],this.lastNormalSendStats=void 0),this.lastExtendStats={},this.needUploadStats={},this.uploadOutboundDenoiserStatsTimer&&window.clearInterval(this.uploadOutboundDenoiserStatsTimer),this.uploadOutboundDenoiserStatsTimer=void 0,this.uploadExtStatsTimer&&window.clearInterval(this.uploadExtStatsTimer),this.uploadExtStatsTimer=void 0)}startUploadInboundStats(){this.uploadInboundStarted||(this.uploadInboundStarted=!0,this.uploadWRTCStatsTimer||this.startUploadWRTCStats(),this.uploadInboundExtStatsTimer&&window.clearInterval(this.uploadInboundExtStatsTimer),this.uploadInboundExtStatsTimer=window.setInterval((()=>{!this.requestUpload||!this.requestRemoteMedia||(this.requestRemoteMedia()||[]).forEach((e=>{let[n,i]=e;i.has(ut.VIDEO)&&n.videoTrack&&n.videoTrack.getProcessorStats().forEach((r=>{this.requestUpload&&this.requestUpload(r.type,r.stats)})),i.has(ut.AUDIO)&&n.audioTrack&&n.audioTrack.getProcessorStats().forEach((r=>{this.requestUpload&&this.requestUpload(r.type,r.stats)}))}))}),2e3))}stopUploadInboundStats(){this.uploadInboundStarted&&(this.uploadInboundStarted=!1,this.lastRecvStats&&(this.lastRecvStats.videoRecv=[],this.lastRecvStats.audioRecv=[],this.lastRecvStats=void 0),this.lastRefRecvStats&&(this.lastRefRecvStats.videoRecv=[],this.lastRefRecvStats.audioRecv=[],this.lastRefRecvStats=void 0),this.lastNormalRecvStats&&(this.lastNormalRecvStats.videoRecv=[],this.lastNormalRecvStats.audioRecv=[],this.lastNormalRecvStats=void 0),this.lastUploadCompensateTime=-1,this.uploadCompensateDeltaTime=0,this.needUploadRenderFreezeTime=!0,this.uploadInboundExtStatsTimer&&window.clearInterval(this.uploadInboundExtStatsTimer),this.uploadInboundExtStatsTimer=void 0)}startUploadExtensionUsageStats(){if(this.uploadExtensionUsageStarted)return;this.uploadExtensionUsageStarted=!0,this.uploadExtUsageStatsTimer&&window.clearInterval(this.uploadExtUsageStatsTimer);const e=new Map;this.uploadExtUsageStatsTimer=window.setInterval((async()=>{const n=Date.now(),i={connectionInterval:I("EXTENSION_USAGE_UPLOAD_INTERVAL")/1e3,details:[],lts:n};let r=[];const s=this.requestAllTracks&&this.requestAllTracks()||[];for(const d of s)!d.muted&&d.enabled&&(r=r.concat(await d.getProcessorUsage()));const o=this.requestRemoteMedia&&this.requestRemoteMedia()||[];for(const[d,l]of o)l.has(ut.VIDEO)&&d.videoTrack&&(r=r.concat(await d.videoTrack.getProcessorUsage())),l.has(ut.AUDIO)&&d.audioTrack&&(r=r.concat(await d.audioTrack.getProcessorUsage()));if(r.length===0)return;i.details=(function(d,l){const h={};for(const{id:S,value:T,level:b,direction:w}of d){var p;const D=(p=l.get(S))!==null&&p!==void 0?p:0,k=T===2?D+I("EXTENSION_USAGE_UPLOAD_INTERVAL")/1e3:D;var f,v;l.set(S,k),h[S]?(T===2&&(h[S].value=T),b>h[S].level&&(h[S].level=b),w==="remote"&&(h[S].remoteUidCount+=1),h[S].totalTs=(f=l.get(S))!==null&&f!==void 0?f:0):h[S]={value:T,level:b,remoteUidCount:w==="local"?0:1,totalTs:(v=l.get(S))!==null&&v!==void 0?v:0}}return Object.keys(h).map((S=>{const{level:T,value:b,totalTs:w}=h[S];return{id:S,level:T,value:b,totalTs:w}}))})(r,e);const a=Date.now(),c=a>n?a:n+1;this.requestUpload&&this.requestUpload(hc.EXTENSION_USAGE_STATS,{usageStats:i,sendTs:c})}),I("EXTENSION_USAGE_UPLOAD_INTERVAL"))}stopUploadExtensionUsageStats(){this.uploadExtensionUsageStarted&&(this.uploadExtensionUsageStarted=!1,this.uploadExtUsageStatsTimer&&window.clearInterval(this.uploadExtUsageStatsTimer),this.uploadExtUsageStatsTimer=void 0)}stopUploadBaseStats(){this.uploadBaseStatsStarted=!1,Qi.stopCollectStats()}}const YY=I("ICE_RESTART_INTERVAL");let F_=new Map,zd=new Map,fa=[xn.UDP_TCP_RELAY,xn.TCP_RELAY,xn.RELAY],IT=I("JOIN_WITH_FALLBACK_MEDIA_PROXY_FORCE")&&Jt().supportPCSetConfiguration;function BP(t){let e=arguments.length>1&&arguments[1]!==void 0&&arguments[1];const n=F_.get(t.id);n&&(window.clearTimeout(n),F_.delete(t.id));const i=zd.get(t.id);e&&i&&i.index===fa.length-1&&(m.debug("[".concat(t.id,"] reset ICE restart policy")),zd.delete(t.id))}function jP(t,e,n){if(F_.size===0&&zd.size===0&&(Array.isArray(I("RESTART_SEQUENCE"))&&I("RESTART_SEQUENCE").length>0&&!(function(a,c){if(a.length!==c.length)return!1;for(let d=0;d<a.length;d+=1){const l=a[d];if(a.filter((h=>h===l)).length!==c.filter((h=>h===l)).length)return!1}return!0})(fa,I("RESTART_SEQUENCE"))&&(fa=I("RESTART_SEQUENCE").filter((a=>{var c;if($(c=Object.values(xn)).call(c,a))return!0})),m.debug("use reconnection policy from config distribution, queues: ".concat(fa.join(" => ")))),IT=I("JOIN_WITH_FALLBACK_MEDIA_PROXY_FORCE")&&Jt().supportPCSetConfiguration),fa.length===0)return void n();let i,{index:r=0,type:s}=zd.get(t.id)||{};if(IT&&s===xn.RELAY)return void n();let o=s&&r>=fa.length-1;if(IT)s=xn.RELAY;else{if(o)return void n();s?(r++,s=fa[r]):(s=fa[0],r=0)}m.debug("[".concat(t.id,"] choose ICE restart policy: ").concat(s,", index: ").concat(r)),e(s),zd.set(t.id,{index:r,type:s}),i=window.setTimeout((()=>jP(t,e,n)),YY),F_.set(t.id,i)}var Zt;function GP(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable}))),n.push.apply(n,i)}return n}function so(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?GP(Object(n),!0).forEach((function(i){R(t,i,n[i])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):GP(Object(n)).forEach((function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i))}))}return t}function WP(t){var e,n,i,r=2;for(typeof Symbol<"u"&&(n=Pp,i=Symbol.iterator);r--;){if(n&&(e=t[n])!=null)return e.call(t);if(i&&(e=t[i])!=null)return new B_(e.call(t));n="@@asyncIterator",i="@@iterator"}throw new TypeError("Object is not async iterable")}function B_(t){function e(n){if(Object(n)!==n)return st.reject(new TypeError(n+" is not an object."));var i=n.done;return st.resolve(n.value).then((function(r){return{value:r,done:i}}))}return B_=function(n){this.s=n,this.n=n.next},B_.prototype={s:null,n:null,next:function(){return e(this.n.apply(this.s,arguments))},return:function(n){var i=this.s.return;return i===void 0?st.resolve({value:n,done:!0}):e(i.apply(this.s,arguments))},throw:function(n){var i=this.s.return;return i===void 0?st.reject(n):e(i.apply(this.s,arguments))}},new B_(t)}let Ec=(Zt=class extends qe{get state(){return this._state}set state(t){const e=this._state;this._state=t,this.emit(Rt.StateChange,e,this._state)}constructor(t,e){super(),R(this,"isPlanB",void 0),R(this,"store",void 0),R(this,"statsUploader",void 0),R(this,"connection",void 0),R(this,"localTrackMap",new Map),R(this,"remoteUserMap",new Map),R(this,"localDataChannels",[]),R(this,"remoteDataChannelMap",new Map),R(this,"pendingLocalTracks",[]),R(this,"pendingRemoteTracks",[]),R(this,"pendingLocalDataChannels",[]),R(this,"pendingRemoteDataChannels",[]),R(this,"statsCollector",void 0),R(this,"shouldForwardP2PCreation",void 0),R(this,"iceFailedCount",0),R(this,"dtlsFailedCount",0),R(this,"mutex",void 0),R(this,"_state",me.Disconnected),R(this,"_pcStatsUploadType",I("NEW_ICE_RESTART")?Po.FIRST_CONNECTION:Po.OLD_FIRST_CONNECTION),R(this,"_isStartRestartIce",!1),R(this,"_restartTimer",void 0),R(this,"_isTryConnecting",!1),R(this,"_iceError",null),R(this,"_forceTurn",!1),R(this,"_isWaitPcToRePub",!1),R(this,"handleMuteLocalTrack",(async(n,i,r)=>{const s=await this.mutex.lock("Locking from P2PChannel.handleMuteLocalTrack");try{if(!this.connection||this.state!==me.Connected)return void r(new H(A.INVALID_OPERATION,"Cannot call P2PChannel.handleMuteLocalTrack before connection established."));const o=this.filterTobeMutedTracks(n);if(o.length===0)return void i();const a=o.find((d=>d[0]==="videoLowTrack"));if(a){const d=a[1];this.store.enableInstantMuteRestore?(d.track._originMediaStreamTrack.enabled=!1,m.info("[".concat(this.store.clientId,"] P2PChannel muteLocalLowTrack without close sender because enableInstantMuteRestore is true"))):d.track._originMediaStreamTrack.stop()}this.store.enableInstantMuteRestore?m.info("[".concat(this.store.clientId,"] P2PChannel muteLocalTrack without close sender because enableInstantMuteRestore is true")):await this.connection.muteLocal(o.map((d=>{let[,{id:l}]=d;return l})));const c=this.createMuteMessage(o);await Pe(this,Rt.RequestMuteLocal,c),i()}catch(o){r(o)}finally{s()}})),R(this,"handleUnmuteLocalTrack",(async(n,i,r)=>{const s=await this.mutex.lock("Locking from P2PChannel.handleUnmuteLocalTrack");try{if(!this.connection||this.state!==me.Connected)return void r(new H(A.INVALID_OPERATION,"Cannot call P2PChannel.handleUnmuteLocalTrack before connection established."));const o=this.filterTobeUnmutedTracks(n);if(o.length===0)return void i();const a=o.find((d=>d[0]==="videoLowTrack"));if(a){const d=a[1];if(this.store.enableInstantMuteRestore)d.track._originMediaStreamTrack.enabled=!0,m.info("[".concat(this.store.clientId,"] P2PChannel unmuteLocalLowTrack without close sender because enableInstantMuteRestore is true"));else{if(d.track._originMediaStreamTrack.stop(),!I("DISABLE_DUAL_STREAM_USE_ENCODING")&&Jt().supportDualStreamEncoding){const l=n._mediaStreamTrack.clone();d.track._mediaStreamTrack=l,d.track._originMediaStreamTrack=l}else{const l=CT(n,Za(this,Rt.RequestLowStreamParameter));d.track._mediaStreamTrack=l,d.track._originMediaStreamTrack=l}await new st(((l,h)=>{this.handleReplaceTrack(d.track,l,h,!0)}))}}this.store.enableInstantMuteRestore?m.info("[".concat(this.store.clientId,"] P2PChannel unmuteLocalTrack without close sender because enableInstantMuteRestore is true")):await this.connection.unmuteLocal(o.map((d=>{let[,{id:l}]=d;return l})));const c=this.createUnmuteMessage(o);await Pe(this,Rt.RequestUnmuteLocal,c),i()}catch(o){r(o)}finally{s()}})),R(this,"handleUpdateVideoEncoder",(async(n,i,r,s)=>{let o;s||(o=await this.mutex.lock("Locking from P2PChannel.handleUpdateVideoEncoder"));try{const c=this.localTrackMap.get(tt.LocalVideoTrack);if(!this.connection||!c||c.track!==n||this.state!==me.Connected)return void i();const{id:d,track:l}=c;await this.connection.updateSendParameters(d,l),await this.connection.updateEncoderConfig(d,l),this.emit(Rt.UpdateVideoEncoder,l),i()}catch(c){r(c)}finally{var a;(a=o)===null||a===void 0||a()}})),R(this,"handleUpdateVideoSendParameters",(async(n,i,r)=>{const s=await this.mutex.lock("Locking from P2PChannel.handleUpdateVideoSendParameters");try{const o=this.localTrackMap.get(tt.LocalVideoTrack);if(!this.connection||!o||o.track!==n||this.state!==me.Connected)return void i();const{id:a,track:c}=o;await this.connection.updateSendParameters(a,c),i()}catch(o){r(o)}finally{s()}})),R(this,"handleReplaceMixingTrack",(async(n,i,r,s)=>{if(!this.connection||this.state!==me.Connected)return void i();const o=TT([n]);let a;m.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection will replace audioTrack [").concat(o.getTrackId(),"]")),typeof s=="boolean"&&s||(a=await this.mutex.lock("From P2PChannel.handleReplaceMixingTrack"));try{await this.replaceTrack(n,o),i()}catch(d){r(d)}finally{var c;(c=a)===null||c===void 0||c()}})),R(this,"handleReplaceTrack",(async(n,i,r,s)=>{let o;m.debug("[".concat(this.store.clientId,"] P2PChannel handleReplaceTrack for [track-id-").concat(n.getTrackId(),"]")),typeof s=="boolean"&&s||(o=await this.mutex.lock("From P2PChannel.handleReplaceTrack"));try{var a;const d=Array.from(this.localTrackMap.entries()).find((l=>{let[,{track:h}]=l;return n===h}));if(!this.connection||!d||this.state!==me.Connected)return void i();if(await((a=this.connection)===null||a===void 0?void 0:a.replaceTrack(n,d[1].id)),this.isPlanB){const l=d[1];l.id=n._mediaStreamTrack.id,this.localTrackMap.set(d[0],l)}if(d[0]===tt.LocalVideoTrack&&!I("DISABLE_DUAL_STREAM_USE_ENCODING")&&Jt().supportDualStreamEncoding){const l=this.localTrackMap.get(tt.LocalVideoLowTrack);if(l){const h=n._mediaStreamTrack.clone();l.track._originMediaStreamTrack.stop(),l.track._mediaStreamTrack=h,l.track._originMediaStreamTrack=h,await new st(((p,f)=>{this.handleReplaceTrack(l.track,p,f,!0)}))}}i()}catch(d){r(d)}finally{var c;(c=o)===null||c===void 0||c()}})),R(this,"handleGetRTCStats",(n=>{n(this.statsCollector.getRTCStats())})),R(this,"handleGetLocalVideoStats",(n=>{n(this.statsCollector.getLocalVideoTrackStats())})),R(this,"handleGetLocalAudioStats",(n=>{n(this.statsCollector.getLocalAudioTrackStats())})),R(this,"handleGetRemoteVideoStats",(n=>this.statsCollector.getRemoteVideoTrackStats(n.uid)[n.uid])),R(this,"handleGetRemoteAudioStats",(n=>this.statsCollector.getRemoteAudioTrackStats(n.uid)[n.uid])),this.store=t,this.statsCollector=e,this.statsCollector.addP2PChannel(this),this.statsUploader=new FP(this.store),this.bindStatsUploaderEvents(),this.mutex=new Un("P2PChannel-mutex",this.store.clientId),this.isPlanB=!Jt().supportUnifiedPlan||I("CHROME_FORCE_PLAN_B")&&Js(),this.shouldForwardP2PCreation=I("FORWARD_P2P_CREATION")&&Jt().supportPCSetConfiguration&&bO(),this.shouldForwardP2PCreation&&(this.connection=Cu(this.store),this.emit(Rt.PeerConnectionStateChange,this.connection.peerConnectionState),this.bindConnectionEvents(this.connection))}async startP2PConnection(t,e){var n;this.state=me.New,this._forceTurn=vT(t),m.debug("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] forceTurn: ").concat(this._forceTurn));const i=this.shouldForwardP2PCreation&&((n=this.connection)===null||n===void 0?void 0:n.peerConnectionState)==="closed";if((!this.shouldForwardP2PCreation||i||e)&&((i||e)&&this.connection&&(m.warning("[".concat(this.store.clientId,"] P2PChannel.startP2PConnection ForwardP2P closed.")),this.resetConnection(this.connection)),this.connection=Cu(this.store,t),this.emit(Rt.PeerConnectionStateChange,this.connection.peerConnectionState),this.bindConnectionEvents(this.connection)),!this.connection)throw new H(A.UNEXPECTED_ERROR,"Cannot P2PChannel.startConnection before P2PConnection initialization .");return this._pcStatsUploadType=I("NEW_ICE_RESTART")?Po.FIRST_CONNECTION:Po.OLD_FIRST_CONNECTION,this._isTryConnecting=!0,this._isStartRestartIce=!1,this._iceError=null,this.connection.setConfiguration(t),this.connection.establishPromise}async connect(t){if(!this.connection)throw new H(A.UNEXPECTED_ERROR,"Cannot P2PChannel.connect before P2PChannel.startP2PConnection .");if(!this.isPreallocation()||this.state!==me.Connected){this.store.peerConnectionStart();const e=await this.connection.connect(t);return this.statsUploader.startUploadTransportStats(),this.statsUploader.startUploadExtensionUsageStats(),this.state=me.Connected,e}if(this.connection instanceof gr&&this.connection.checkDtlsParameters(t.dtlsParameters.fingerprints))return m.debug("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] dtls parameters mismatch, try next.")),pt.reportApiInvoke(this.store.sessionId,{name:Ge.MISMATCH_DTLS_PARAMETERS,options:[t.dtlsParameters.fingerprints],tag:Ne.TRACER}).onSuccess(),void setTimeout((()=>{this.emit(Rt.RequestReconnect)}));await this.connection.updateRemoteConnect(t)}updateRemoteRTPCapabilities(t){const e=Array.from(this.localTrackMap.entries()).filter((r=>{var s;let[o]=r;return $(s=[tt.LocalVideoLowTrack,tt.LocalVideoTrack]).call(s,o)})),n=e.map((r=>{let[,{id:s}]=r;return s})),i=e.map((r=>{let[s]=r;return s}));if(this.connection instanceof gr||this.connection&&"name"in this.connection&&this.connection.name==="DataChannelConnection"){if(pt.updateRemoteRTPCapabilities(this.store.sessionId,{trackTypes:JSON.stringify(i),localCodecs:JSON.stringify(this.connection.localCodecs),remoteCodecs:JSON.stringify(t)}),!$(t).call(t,this.store.codec)){const r=["vp9","vp8","h264"].find((s=>$(t).call(t,s)));r&&(this.store.codec=r,m.debug("[".concat(this.store.clientId,"] [").concat(this.store.p2pId," updateRemoteRTPCapabilities] default codec is not available, hence the fallback to ").concat(r,".")))}this.connection.updateRemoteRTPCapabilities(n,t)}}async getEstablishParams(){var t;return this.connection&&"name"in this.connection&&this.connection.name==="DataChannelConnection"&&this.connection.peerConnectionState!=="closed"||this.connection instanceof gr&&this.connection.peerConnectionState!=="closed"&&$(t=[me.New,me.Connected]).call(t,this.state)?this.connection.establishPromise:void 0}async publishDataChannel(t){if(!this.connection||this.state!==me.Connected){if(this.state===me.Disconnected)throw new H(A.UNEXPECTED_ERROR,"PeerConnection already disconnected.");return t.forEach((n=>{var i;$(i=this.pendingLocalDataChannels).call(i,n)||this.pendingLocalDataChannels.push(n)})),[]}const e=this.filterTobePublishedDataChannels(t);return e.length===0?[]:(e.forEach((n=>{const i=Date.now();this.store.publish(n.id.toString(),"datachannel",i)})),await this.connection.createDataChannels(this.store.uid,e),e.forEach((n=>{this.localDataChannels.push(n);const i=Date.now();this.store.publish(n.id+"","datachannel",void 0,i)})),t.map((n=>({streamId:n.id,ordered:n.ordered,maxRetransmits:n.maxRetransmits,metadata:n.metadata,channelId:n._originDataChannelId}))))}publish(t,e,n){var i=this;return Ci((function*(){const r=yield Ht(i.mutex.lock("From P2PChannel.publish"));try{var s;const o=i.connection&&$(s=["disconnected","failed"]).call(s,i.connection.peerConnectionState);if(!i.connection||i.state!==me.Connected||o){if(i.state===me.Disconnected)throw new H(A.UNEXPECTED_ERROR,"PeerConnection already disconnected.");i.throwIfTrackTypeNotMatch(t);const c=t.filter((d=>i.pendingLocalTracks.indexOf(d)===-1));return i.pendingLocalTracks=i.pendingLocalTracks.concat(c),void(o&&(i._isWaitPcToRePub=!0))}i.store.pubId=i.store.pubId+1,ni.markPublishStart(i.store.clientId,i.store.pubId);const a=i.filterTobePublishedTracks(t,e,n);if(a.length===0)return void(yield Ht(i.tryToUnmuteAudio(t)));yield*Ed(WP(i.doPublish(i.connection,a)))}finally{r()}}))()}doPublish(t,e){var n=this;return Ci((function*(){e.forEach((p=>{let{track:f,type:v}=p;const S=Date.now();n.store.publish(f.getTrackId(),v===tt.LocalAudioTrack?"audio":"video",S)})),n.bindLocalTrackEvents(e);const i=e.map((p=>{let{track:f}=p;return f})),r=yield Ht(t.send(i,n.store.codec,n.store.audioCodec)),s=(yield Ht(r.next())).value,o=n.createGatewayPublishMessage(e,s);let a;try{a=yield o}catch(p){throw r.throw(p),p?.code===A.WS_ABORT&&e.forEach((f=>{let{track:v}=f;n.pendingLocalTracks.indexOf(v)===-1&&n.pendingLocalTracks.push(v)})),n.unbindLocalTrackEvents(e),p}const c=n.mapPubResToRemoteConfig(o,a,i),d=(yield Ht(r.next(c))).value;if(n.state===me.Disconnected)throw new H(A.UNEXPECTED_ERROR,"PeerConnection already disconnected.");I("ENABLE_VIDEO_SEI");const l=I("ENABLE_ENCODED_TRANSFORM"),h=I("ENABLE_AUDIO_METADATA");i.forEach((async p=>{const f=p.getRTCRtpTransceiver();if(!f||!l)return;const{interceptLocalVideoFrame:v,interceptLocalAudioFrame:S}=O_();p.trackMediaType===ut.VIDEO?await v(f.sender,p):p.trackMediaType===ut.AUDIO&&await S(f.sender,{metadata:h?()=>{const T=p.metadata.shift();return T&&T.value}:void 0})})),e.forEach((p=>{let{type:f}=p;n.statsCollector.addLocalStats(f)})),n.assignLocalTracks(e,d),n.statsUploader.startUploadOutboundStats(),e.forEach((p=>{let{track:f,type:v}=p;const S=Date.now();n.store.publish(f.getTrackId(),v===tt.LocalAudioTrack?"audio":"video",void 0,S)}))}))()}async updateVideoStreamParameter(t,e){const n=this.localTrackMap.get(e);if(!n||!this.connection)return;if(!(n.track instanceof De))return m.warn("[updateVideoStreamParameter]: track is not an instance of LocalVideoTrack");const{track:i}=n,r=(function(s,o){const a={};return s.height&&s.width&&(a.scaleResolutionDownBy=$S(s,o)),a.maxFramerate=s.framerate?wi(s.framerate):void 0,a.maxBitrate=s.bitrate?1e3*s.bitrate:void 0,a})(t,i);if(i._encoderConfig||(i._encoderConfig={}),e!==tt.LocalVideoLowTrack||!I("DISABLE_DUAL_STREAM_USE_ENCODING")&&Jt().supportDualStreamEncoding)r.scaleResolutionDownBy!=null&&(i._encoderConfig.scaleResolutionDownBy=r.scaleResolutionDownBy);else{const s=i._originMediaStreamTrack;if(!s.canvas)return m.warn("[".concat(i.getTrackId(),"] no canvas on track"));(function(o,a){const c=o.canvas;a.width&&(c.width=wi(a.width)),a.height&&(c.height=wi(a.height)),a.framerate&&(c.stopCapture&&c.stopCapture(),c.stopCapture=CS((()=>{!c.startCapture&&c.stopCapture&&c.stopCapture(),c.startCapture&&c.startCapture()}),wi(a.framerate)))})(s,t)}r.maxBitrate!=null&&(i._encoderConfig.bitrateMax=r.maxBitrate/1e3),r.maxFramerate!=null&&(i._encoderConfig.frameRate&&typeof i._encoderConfig.frameRate=="object"?i._encoderConfig.frameRate.max=r.maxFramerate:i._encoderConfig.frameRate={max:r.maxFramerate}),m.debug("[".concat(i.getTrackId(),"] LowStreamEncoderConfig: , ").concat(JSON.stringify(i._encoderConfig))),await this.connection.updateRtpSenderEncodings(i)}publishLowStream(t){var e=this;return Ci((function*(){if(!e.connection||e.state!==me.Connected)return;const n=yield Ht(e.mutex.lock("Locking from P2PChannel.publishLowStream"));try{const r=e.localTrackMap.get(tt.LocalVideoTrack);if(!r)throw new H(A.UNEXPECTED_ERROR,"Could not find high stream");if(e.localTrackMap.has(tt.LocalVideoLowTrack))throw new H(A.UNEXPECTED_ERROR,"[".concat(e.store.clientId,"] Can't publish low stream when stream already publish"));const s=[{track:e.getLowVideoTrack(r.track,t),type:tt.LocalVideoLowTrack}];if(yield*Ed(WP(e.doPublish(e.connection,s))),r.track.muted||!r.track.enabled){var i;const o=(i=e.localTrackMap.get(tt.LocalVideoLowTrack))===null||i===void 0?void 0:i.id;o!==void 0&&(yield Ht(e.connection.muteLocal([o])))}}finally{n()}}))()}async republish(){this.pendingLocalTracks.length>0&&(m.debug("[".concat(this.store.clientId,"] Emit P2PChannelEvents.RequestRePublish to republish tracks.")),await Sn(this,Rt.RequestRePublish,this.pendingLocalTracks),this.emit(Rt.MediaReconnectEnd,this.store.uid),this.pendingLocalTracks=[]),this.pendingLocalDataChannels.length>0&&(m.debug("Emit P2PChannelEvents.RequestRePublishDataChannel to republish datachannels."),await Sn(this,Rt.RequestRePublishDataChannel,this.pendingLocalDataChannels),this.pendingLocalDataChannels=[]),this._isWaitPcToRePub=!1}async reSubscribe(t){for(let e=this.pendingRemoteTracks.length-1;e>=0;e--){const{user:n,kind:i}=this.pendingRemoteTracks[e];(i!==ut.AUDIO||n._audio_added_&&n._audioSSRC)&&(i!==ut.VIDEO||n._video_added_&&n._videoSSRC)||this.pendingRemoteTracks.splice(e,1)}if(t)await Sn(this,Rt.RequestReSubscribe,this.pendingRemoteTracks);else for(const{user:e,kind:n}of this.pendingRemoteTracks)await this.subscribe(e,n,n===ut.VIDEO?e._videoSSRC:e._audioSSRC);this.pendingRemoteTracks.forEach((e=>{let{user:n}=e;this.emit(Rt.MediaReconnectEnd,n.uid)})),this.pendingRemoteTracks=[]}async unpublish(t){if(!this.connection||this.state!==me.Connected)return void t.forEach((i=>{const r=this.pendingLocalTracks.indexOf(i);r!==-1&&this.pendingLocalTracks.splice(r,1)}));const e=this.filterTobeUnpublishedTracks(t);if(e.length===0)return;const n=e.find((i=>i[0]==="videoLowTrack"));return n&&n[1].track.close(),this.doUnpublish(this.connection,e)}async unpublishDataChannel(t){if(!this.connection||this.state!==me.Connected)return void t.forEach((n=>{const i=this.pendingLocalDataChannels.indexOf(n);i!==-1&&this.pendingLocalDataChannels.splice(i,1)}));const e=this.filterTobeUnpublishedDataChannels(t);return e.length!==0?(e.forEach((n=>{const i=this.localDataChannels.indexOf(n);i!==-1&&this.localDataChannels.splice(i,1)})),this.localDataChannels.length===0&&await this.connection.stopDataChannels(this.store.uid),e.map((n=>n.id))):void 0}async unpublishLowStream(){if(!this.connection||this.state!==me.Connected)return;const t=this.localTrackMap.get(tt.LocalVideoLowTrack);if(!t)return;t.track.close();const e=[[tt.LocalVideoLowTrack,t]];return this.doUnpublish(this.connection,e)}async doUnpublish(t,e){const n=this.createGatewayUnpublishMessage(e);return await t.stopSending(e.map((i=>{let[,{id:r}]=i;return r}))),this.withdrawLocalTracks(e),this.unbindLocalTrackEvents(e.map((i=>{let[r,{track:s}]=i;return{type:r,track:s}}))),e.forEach((i=>{let[r]=i;this.statsCollector.removeLocalStats(r)})),this.localTrackMap.size===0&&this.statsUploader.stopUploadOutboundStats(),n}async subscribeDataChannel(t,e){if(!this.connection||this.state!==me.Connected)throw new H(A.INVALID_OPERATION,"Cannot subscribe remote user when peerConnection disconnected.");const n=e.filter((i=>{var r;return!((r=this.remoteDataChannelMap.get(t))!==null&&r!==void 0&&r.get(i.id))}));if(n.length!==0)return await this.connection.createDataChannels(t.uid,n),n.forEach((i=>{var r;this.remoteDataChannelMap.has(t)?(r=this.remoteDataChannelMap.get(t))===null||r===void 0||r.set(i.id,i):this.remoteDataChannelMap.set(t,new Map([[i.id,i]]));const s=this.pendingRemoteDataChannels.findIndex((o=>{let{user:a,id:c}=o;return a.uid===t.uid&&c===i.id}));s!==-1&&this.pendingRemoteDataChannels.splice(s,1)})),n.map((i=>i.id))}async subscribe(t,e,n,i,r){var s;if(!this.connection||this.state!==me.Connected)throw new H(A.INVALID_OPERATION,"Cannot subscribe remote user when peerConnection disconnected.");if((s=this.remoteUserMap.get(t))!==null&&s!==void 0&&s.has(e))return;let o,a,c,d;const l=this.connection.getPreMedia(n);if(l)m.debug("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] preSSRCMap has ssrcId: ").concat(n,", no need to send sub to gateway.")),c=l.transceiver,o=l.track,a=l.mid,d=l.player,l.firstVideoRender&&this.store.firstVideoFrameDecoded(t.uid,{firstPreRender:l.firstVideoRender});else if(r){const f=r.find((S=>{let{stream_type:T}=S;return T===e}));if(!f)throw new H(A.UNEXPECTED_ERROR,"Cannot subscribe to remote ".concat(e," for user: ").concat(t.uid," because subscribe answer from gateway does not contain stream_type: ").concat(e,"."));const v=await this.connection.receive(e,f.ssrcs,String(t._uintid),f.attributes);(this.connection instanceof gr||"name"in this.connection&&this.connection.name==="DataChannelConnection")&&(c=v.transceiver),o=v.track,a=v.id}else{const f=await this.connection.receive(e,[{ssrcId:n,rtx:i}],String(t._uintid),void 0);(this.connection instanceof gr||"name"in this.connection&&this.connection.name==="DataChannelConnection")&&(c=f.transceiver),o=f.track,a=f.id}if(e===ut.AUDIO?(t._audioTrack?t._audioTrack._updateOriginMediaStreamTrack(o):(t._audioTrack=new kd(o,t.uid,t._uintid,this.store),m.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote audio track: ").concat(t._audioTrack.getTrackId()))),c&&t._audioTrack._updateRtpTransceiver(c),this.bindRemoteTrackEvents(t,t._audioTrack)):(t._videoTrack?t._videoTrack._updateOriginMediaStreamTrack(o):(t._videoTrack=new Ld(o,t.uid,t._uintid,this.store,d),m.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote video track: ").concat(t._videoTrack.getTrackId())),t._videoTrack.once(Or.PLAY_START,(()=>{this.store.firstVideoFrameDecoded(t.uid,{playStart:Date.now()})})),t._videoTrack.once(Or.PLAY_END,(()=>{this.store.firstVideoFrameDecoded(t.uid,{playEnd:Date.now()}),this.reportVideoFirstFrameRender(t)})),d?t._videoTrack.once(Or.FIRST_FRAME_RENDER,(()=>{this.store.firstVideoFrameDecoded(t.uid,{firstRender:Date.now()}),this.reportVideoFirstFrameRender(t)})):t._videoTrack.once(Or.FIRST_FRAME_DECODED,(()=>{this.store.firstVideoFrameDecoded(t.uid,{firstRender:Date.now()}),this.reportVideoFirstFrameRender(t)}))),c&&t._videoTrack._updateRtpTransceiver(c),this.bindRemoteTrackEvents(t,t._videoTrack)),c&&I("ENABLE_ENCODED_TRANSFORM")){const{interceptRemoteVideoFrame:f,interceptRemoteAudioFrame:v}=O_();e==ut.VIDEO?await f(c.receiver,{onSei:I("ENABLE_VIDEO_SEI")&&(S=>{var T;return(T=t._videoTrack)===null||T===void 0?void 0:T._onSei(S)}),onFirstFrame:S=>{var T;const b=Array.from(oi(T=this.remoteUserMap).call(T)).find((w=>w._videoSSRC===S.ssrc));b&&this.store.firstVideoFrameDecoded(b.uid,{firstReceivedEncodedFrame:Date.now(),frameType:S.type,rtpTimestamp:S.rtpTimestamp,framePayloadType:S.payloadType,frameDataLength:S.length,mimeType:S.mimeType})}}):e==ut.AUDIO&&await v(c.receiver,{enableTopn:!!I("ENABLE_AUDIO_TOPN"),enableMetadata:!!I("ENABLE_AUDIO_METADATA"),enablePts:!!I("ENABLE_AUDIO_PTS"),onMetadata:S=>{this.safeEmit(Rt.AudioMetadata,S)},onPts:S=>{this.safeEmit(Rt.AudioPts,S)}})}const h=this.remoteUserMap.get(t);h?h.set(e,a):this.remoteUserMap.set(t,new Map([[e,a]])),this.statsCollector.addRemoteStats(t.uid),this.statsUploader.startUploadInboundStats();const p=this.pendingRemoteTracks.findIndex((f=>{let{user:v,kind:S}=f;return v.uid===t.uid&&e===S}));p!==-1&&(this.pendingRemoteTracks.splice(p,1),this.emit(Rt.MediaReconnectEnd,t.uid))}async massSubscribe(t){return this.massSubscribeNoLock(t)}async massSubscribeNoLock(t){if(!this.connection||this.state!==me.Connected)throw new H(A.INVALID_OPERATION,"Cannot subscribeAll remote users when peerConnection disconnected.");t=t.filter((r=>{var s;let{user:o,mediaType:a}=r;return!((s=this.remoteUserMap.get(o))!==null&&s!==void 0&&s.has(a))}));const e=[],n=new Map;t.forEach((r=>{if(!this.connection)return;const s=this.connection.getPreMedia(r.ssrcId);if(s){const{track:o,mid:a,transceiver:c,player:d}=s;n.set(r.ssrcId,{track:o,id:a,transceiver:c,player:d})}else e.push(r)}));const i=await this.connection.batchReceive(e.map((r=>{let{user:s,mediaType:o,ssrcId:a,rtxSsrcId:c}=r;return{kind:o,ssrcMsg:[{ssrcId:a,rtx:c}],mslabel:String(s._uintid)}})));e.forEach(((r,s)=>{n.set(r.ssrcId,i[s])}));for(const{user:r,mediaType:s,ssrcId:o}of t){const a=n.get(o);if(!a)return void m.debug("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] cannot find ").concat(r.uid," subscribe data,").concat(s,", ").concat(o));const{track:c,id:d,transceiver:l,player:h}=a;if(l&&I("ENABLE_ENCODED_TRANSFORM")){const{interceptRemoteVideoFrame:v,interceptRemoteAudioFrame:S}=O_();s==ut.VIDEO?await v(l.receiver,{onSei:I("ENABLE_VIDEO_SEI")&&(T=>{var b;return(b=r._videoTrack)===null||b===void 0?void 0:b._onSei(T)}),onFirstFrame:T=>{var b;const w=Array.from(oi(b=this.remoteUserMap).call(b)).find((D=>D._videoSSRC===T.ssrc));w&&this.store.firstVideoFrameDecoded(w.uid,{firstReceivedEncodedFrame:Date.now(),frameType:T.type,rtpTimestamp:T.rtpTimestamp,framePayloadType:T.payloadType,frameDataLength:T.length,mimeType:T.mimeType})}}):s==ut.AUDIO&&await S(l.receiver,{enableTopn:!!I("ENABLE_AUDIO_TOPN"),enableMetadata:!!I("ENABLE_AUDIO_METADATA"),enablePts:!!I("ENABLE_AUDIO_PTS"),onMetadata:T=>{this.safeEmit(Rt.AudioMetadata,T)},onPts:T=>{this.safeEmit(Rt.AudioPts,T)}})}if(s===ut.AUDIO?(r._audioTrack?r._audioTrack._updateOriginMediaStreamTrack(c):(r._audioTrack=new kd(c,r.uid,r._uintid,this.store),m.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote audio track: ").concat(r._audioTrack.getTrackId()))),l&&r._audioTrack._updateRtpTransceiver(l),this.bindRemoteTrackEvents(r,r._audioTrack)):(r._videoTrack?r._videoTrack._updateOriginMediaStreamTrack(c):(r._videoTrack=new Ld(c,r.uid,r._uintid,this.store,h),m.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote video track: ").concat(r._videoTrack.getTrackId()))),l&&r._videoTrack._updateRtpTransceiver(l),this.bindRemoteTrackEvents(r,r._videoTrack)),I("ENABLE_VIDEO_SEI")&&l){const{interceptRemoteVideoFrame:v,interceptRemoteAudioFrame:S}=O_();s==ut.VIDEO?await v(l.receiver,{onSei:T=>{var b;(b=r._videoTrack)===null||b===void 0||b._onSei(T)},onFirstFrame:T=>{var b;const w=Array.from(oi(b=this.remoteUserMap).call(b)).find((D=>D._videoSSRC===T.ssrc));w&&this.store.firstVideoFrameDecoded(w.uid,{firstReceivedEncodedFrame:Date.now(),frameType:T.type,rtpTimestamp:T.rtpTimestamp,framePayloadType:T.payloadType,frameDataLength:T.length,mimeType:T.mimeType})}}):s==ut.AUDIO&&await S(l.receiver)}const p=this.remoteUserMap.get(r);p?p.set(s,d):this.remoteUserMap.set(r,new Map([[s,d]])),this.statsCollector.addRemoteStats(r.uid),this.statsUploader.startUploadInboundStats();const f=this.pendingRemoteTracks.findIndex((v=>{let{user:S,kind:T}=v;return S.uid===r.uid&&s===T}));f!==-1&&(this.pendingRemoteTracks.splice(f,1),this.emit(Rt.MediaReconnectEnd,r.uid))}}async unsubscribe(t,e,n){const i=this.pendingRemoteTracks.filter((o=>{let{user:a,kind:c}=o;return e!==void 0?a.uid===t.uid&&e===c:a.uid===t.uid}));if(i.forEach((o=>{const a=this.pendingRemoteTracks.indexOf(o);this.pendingRemoteTracks.splice(a,1)})),this.connection&&this.state===me.Connected||n||i.forEach((o=>{let{kind:a}=o;var c;if(a===ut.AUDIO)(c=t._audioTrack)===null||c===void 0||c._destroy(),t._audioTrack=void 0;else if(a===ut.VIDEO){var d;(d=t._videoTrack)===null||d===void 0||d._destroy(),t._videoTrack=void 0}})),!this.connection||this.state!==me.Connected)return;const r=this.filterTobeUnSubscribedTracks(t,e);if(r.length===0)return;await this.connection.stopReceiving(r.map((o=>{let[,{id:a}]=o;return a})));const s=this.createUnsubscribeMessage(r);return this.withdrawRemoteTracks(r),this.remoteUserMap.size===0&&this.statsUploader.stopUploadInboundStats(),r.forEach((o=>{let[a,{kind:c}]=o;var d,l;if(c===ut.VIDEO&&a._videoSSRC&&((d=this.connection)===null||d===void 0||d.setStatsRemoteVideoIsReady(a._videoSSRC,!1)),c===ut.VIDEO)this.unbindRemoteTrackEvents(a._videoTrack),n||((l=a._videoTrack)===null||l===void 0||l._destroy(),a._videoTrack=void 0);else if(c===ut.AUDIO){var h;this.unbindRemoteTrackEvents(a._audioTrack),!n&&((h=a._audioTrack)===null||h===void 0||h._destroy(),a._audioTrack=void 0)}})),s}async unsubscribeDataChannel(t,e){if(e.forEach((r=>{const s=this.pendingRemoteDataChannels.findIndex((o=>o.id===r.id));s!==-1&&this.pendingRemoteDataChannels.splice(s,1)})),!this.connection)return;const n=this.filterTobeUnSubscribedDataChannels(t,e);if(n.length===0)return;e.forEach((r=>{r._close()}));const i=this.remoteDataChannelMap.get(t);return n.forEach((r=>{i&&i.delete(r.id)})),i&&i.size===0&&(this.remoteDataChannelMap.delete(t),await this.connection.stopDataChannels(t.uid)),n.map((r=>r.id))}async massUnsubscribe(t){return this.massUnsubscribeNoLock(t)}async massUnsubscribeNoLock(t){let e=[];for(const{user:r,mediaType:s}of t){const o=this.pendingRemoteTracks.filter((a=>{let{user:c,kind:d}=a;return s!==void 0?c.uid===r.uid&&s===d:c.uid===r.uid}));o.forEach((a=>{const c=this.pendingRemoteTracks.indexOf(a);this.pendingRemoteTracks.splice(c,1)})),e=e.concat(o)}if(!this.connection||this.state!==me.Connected)return void e.forEach((r=>{let{user:s,kind:o}=r;var a;if(o===ut.AUDIO)(a=s._audioTrack)===null||a===void 0||a._destroy(),s._audioTrack=void 0;else if(o===ut.VIDEO){var c;(c=s._videoTrack)===null||c===void 0||c._destroy(),s._videoTrack=void 0}}));const n=Ir(t).call(t,((r,s)=>{let{user:o,mediaType:a}=s;const c=this.filterTobeUnSubscribedTracks(o,a);return r.concat(c)}),[]);if(n.length===0)return;await this.connection.stopReceiving(n.map((r=>{let[,{id:s}]=r;return s})));const i=this.createUnsubscribeAllMessage(n);return this.withdrawRemoteTracks(n),this.remoteUserMap.size===0&&this.statsUploader.stopUploadInboundStats(),n.forEach((r=>{let[s,{kind:o}]=r;var a,c;if(o===ut.VIDEO&&s._videoSSRC&&((a=this.connection)===null||a===void 0||a.setStatsRemoteVideoIsReady(s._videoSSRC,!1)),o===ut.VIDEO)this.unbindRemoteTrackEvents(s._videoTrack),(c=s._videoTrack)===null||c===void 0||c._destroy(),s._videoTrack=void 0;else if(o===ut.AUDIO){var d;this.unbindRemoteTrackEvents(s._audioTrack),(d=s._audioTrack)===null||d===void 0||d._destroy(),s._audioTrack=void 0}})),i}isPreSubScribe(t){return!this.connection||this.state!==me.Connected?!1:!!this.connection.getPreMedia(t)}async muteRemote(t,e){if(!this.connection)return;const n=this.remoteUserMap.get(t);if(!n)return void m.warning("[".concat(this.store.clientId,"] P2PChannel.muteRemote has no remote user ").concat(t.uid,"."));if(!n.get(e))return void m.warning("[".concat(this.store.clientId,"] P2PChannel.muteRemote has no remote user ").concat(t.uid," media type ").concat(e,"."));const i=e===ut.VIDEO?t._videoSSRC:t._audioSSRC;i!==void 0&&this.connection.setStatsRemoteVideoIsReady(i,!1)}async unmuteRemote(t,e){return this.unmuteRemoteNoLock(t,e)}async unmuteRemoteNoLock(t,e){if(!this.connection)return;const n=this.remoteUserMap.get(t);if(!n)return void m.warning("[".concat(this.store.clientId,"] P2PChannel.unmuteRemote has no remote user ").concat(t.uid,"."));n.get(e)||m.warning("[".concat(this.store.clientId,"] P2PChannel.unmuteRemote has no remote user ").concat(t.uid," media type ").concat(e,"."))}addAudioMetadata(t){const e=this.localTrackMap.get(tt.LocalAudioTrack),n=e&&e.track;n&&n.metadata.push(t)}getAllTracks(t){const e=this.localTrackMap.get(tt.LocalAudioTrack);if(e?.track instanceof Cn){const n=e.track;return Array.from(this.localTrackMap.entries()).filter((i=>{let[r]=i;return r!==tt.LocalAudioTrack})).filter((i=>{let[r]=i;return!(t&&r===tt.LocalVideoLowTrack)})).map((i=>{let[,{track:r}]=i;return r})).concat(n.trackList)}return Array.from(this.localTrackMap.entries()).filter((n=>{let[i]=n;return!(t&&i===tt.LocalVideoLowTrack)})).map((n=>{let[,{track:i}]=n;return i}))}getAllDataChannels(){return this.localDataChannels}reportPublishEvent(t,e,n,i,r){if(t){const o=this.localTrackMap.get(tt.LocalAudioTrack),a=i?this.localTrackMap.get(tt.LocalVideoLowTrack):this.localTrackMap.get(tt.LocalVideoTrack);pt.publish(this.store.sessionId,{eventElapse:ni.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:t,ec:e,audioName:o?.track.getTrackLabel(),videoName:a?.track.getTrackLabel(),screenshare:a?.track._hints.indexOf(Ee.SCREEN_TRACK)!==-1,audio:!!o,video:!!a,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:r})}else{var s;n||(n=[]);const o=n.find((c=>c instanceof rn)),a=i?(s=this.localTrackMap.get(tt.LocalVideoTrack))===null||s===void 0?void 0:s.track:n.find((c=>c instanceof De));pt.publish(this.store.sessionId,{eventElapse:ni.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:t,ec:e,audioName:o?.getTrackLabel(),videoName:a?.getTrackLabel(),screenshare:a?._hints.indexOf(Ee.SCREEN_TRACK)!==-1,audio:!!o,video:!!a,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:r})}}reportSubscribeEvent(t,e,n,i){const r=i===ut.VIDEO?n._videoSSRC:n._audioSSRC;r&&pt.subscribe(this.store.sessionId,{succ:t,ec:e,video:i===ut.VIDEO,audio:i===ut.AUDIO,peerid:n.uid,subscribeRequestid:r,p2pid:this.store.p2pId,eventElapse:ni.measureFromSubscribeStart(this.store.clientId,r),preSsrc:this.isPreSubScribe(r)})}reset(){m.debug("[".concat(this.store.clientId,"] P2PChannel.reset")),this.mutex=new Un("P2PChannel-mutex",this.store.clientId),this.connection&&(this.resetConnection(this.connection),this.connection=void 0),this.shouldForwardP2PCreation&&(this.connection=Cu(this.store),this.emit(Rt.PeerConnectionStateChange,this.connection.peerConnectionState),this.bindConnectionEvents(this.connection)),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),this.statsUploader.stopUploadExtensionUsageStats(),this.statsUploader.stopUploadBaseStats(),this.unbindLocalTrackEvents(),this.unbindAllRemoteTrackEvents(),this.unbindRtpTransceiver();const t=this.localTrackMap.get(tt.LocalAudioTrack);if(t?.track instanceof Cn){if(t.track.trackList.length>0){const e=t.track;t.track.trackList.forEach((n=>{e.removeAudioTrack(n)}))}t.track.close()}this.localTrackMap.clear(),this.remoteUserMap.clear(),this.statsCollector.removeRemoteStats(),this.statsCollector.removeLocalStats(),this.iceFailedCount=0,this.dtlsFailedCount=0,this.pendingLocalTracks=[],this.pendingRemoteTracks=[],this.localDataChannels=[],this.remoteDataChannelMap.clear(),this.pendingLocalDataChannels=[],this.pendingRemoteDataChannels=[],this.state=me.Disconnected}getStats(){var t;return(t=this.connection)===null||t===void 0?void 0:t.getStats()}getRemoteVideoIsReady(t){var e;return((e=this.connection)===null||e===void 0?void 0:e.getRemoteVideoIsReady(t))||!1}getLocalAudioVolume(){const t=this.localTrackMap.get(tt.LocalAudioTrack);if(t)return t.track.getVolumeLevel()}getLocalVideoSize(){const t=this.localTrackMap.get(tt.LocalVideoTrack);if(t)return{width:t.track.videoWidth||0,height:t.track.videoHeight||0}}getEncoderConfig(t){const e=this.localTrackMap.get(t);return e&&e.track instanceof De||e&&e.track instanceof rn?e.track._encoderConfig:void 0}getLocalMedia(t){return this.localTrackMap.get(t)}hasLocalMedia(){return this.localTrackMap.size>0}hasRemoteMedia(t,e){if(!t)return this.remoteUserMap.size>0;const n=this.remoteUserMap.get(t);return!!n&&(!e||n.has(e))}async hasRemoteMediaWithLock(t,e){if(!t)return this.remoteUserMap.size>0;const n=this.remoteUserMap.get(t);return!!n&&(!e||n.has(e))}getRemoteMedia(t){var e;const n=Array.from(oi(e=this.remoteUserMap).call(e)).find((i=>i.uid===t));return n?{audioTrack:n.audioTrack,audioSSRC:n._audioSSRC,videoTrack:n.videoTrack,videoSSRC:n._videoSSRC}:{}}getAudioLevels(){let t=Array.from(this.remoteUserMap.entries()).map((n=>{let[i]=n;return{uid:i.uid,level:i.audioTrack?100*i.audioTrack._source.getAccurateVolumeLevel():0}}));const e=this.localTrackMap.get(tt.LocalAudioTrack);return e&&t.push({level:100*e.track._source.getAccurateVolumeLevel(),uid:this.store.uid}),t=Fa(t).call(t,((n,i)=>n.level-i.level)),t}async disconnectForReconnect(){this.connection&&(m.debug("[".concat(this.store.clientId,"] P2PChannel.disconnectForReconnect closing P2PConnection")),this.state=me.Reconnecting,I("KEEP_LAST_FRAME")&&this.remoteUserMap.size!==0&&Array.from(this.remoteUserMap.entries()).forEach((t=>{let[e]=t;var n;e._videoTrack&&e._videoTrack._player&&((n=e._videoTrack._player.getVideoElement())===null||n===void 0||n.pause(),e._videoTrack._player.isKeepLastFrame=!0,e._videoTrack._originMediaStreamTrack.stop())})),this.resetConnection(this.connection),this.connection=void 0,this.shouldForwardP2PCreation&&(this.connection=Cu(this.store),this.emit(Rt.PeerConnectionStateChange,this.connection.peerConnectionState),this.bindConnectionEvents(this.connection)),this.localTrackMap.size!==0&&(Array.from(this.localTrackMap.entries()).forEach((t=>{var e;let[n,{track:i}]=t;switch(n){case tt.LocalVideoTrack:$(e=i._hints).call(e,Ee.LOW_STREAM)?i.close():this.pendingLocalTracks.push(i);break;case tt.LocalAudioTrack:i instanceof Cn?this.pendingLocalTracks=this.pendingLocalTracks.concat(i.trackList):this.pendingLocalTracks.push(i);case tt.LocalVideoLowTrack:}})),this.emit(Rt.MediaReconnectStart,this.store.uid)),this.unbindLocalTrackEvents(),this.localTrackMap.clear(),this.remoteUserMap.size!==0&&Array.from(this.remoteUserMap.entries()).forEach((t=>{let[e,n]=t;Array.from(oi(n).call(n)).forEach((i=>{this.setPendingRemoteMedia(e,i)})),this.emit(Rt.MediaReconnectStart,e.uid)})),this.unbindAllRemoteTrackEvents(),this.remoteUserMap.clear(),this.localDataChannels.length!==0&&(this.localDataChannels.forEach((t=>{this.pendingLocalDataChannels.push(t)})),this.localDataChannels.length=0),this.remoteDataChannelMap.size!==0&&(Array.from(this.remoteDataChannelMap.entries()).forEach((t=>{let[e,n]=t;Array.from(oi(n).call(n)).forEach((i=>{this.setPendingRemoteDataChannel(e,i)}))})),this.remoteDataChannelMap.clear()),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),m.debug("[".concat(this.store.clientId,"] P2PChannel disconnected, waiting to reconnect.")))}hasPendingRemoteDataChannel(t,e){for(const n of this.pendingRemoteDataChannels){const{user:i,id:r}=n;if((t instanceof _a?t.uid:t)===i.uid&&r===e)return!0}return!1}setPendingRemoteDataChannel(t,e){this.hasPendingRemoteDataChannel(t,e)||this.pendingRemoteDataChannels.push({user:t,id:e})}hasPendingRemoteMedia(t,e){for(const n of this.pendingRemoteTracks){const{user:i,kind:r}=n;if((t instanceof _a?t.uid:t)===i.uid&&e===r)return!0}return!1}setPendingRemoteMedia(t,e){this.hasPendingRemoteMedia(t,e)||this.pendingRemoteTracks.push({user:t,kind:e})}restartICE(t){var e=this;return Ci((function*(){if(!e.connection||e.state!==me.Connected)return;const n=yield Ht(e.mutex.lock("From P2PChannel.restartICE"));let i;try{i=yield Ht(e.connection.restartICE(t));const s=yield Ht(i.next());if(s.done)return;const o=s.value,a=yield o;switch(RT(e.connection)&&e.reportPCStats(Date.now(),!1,e._pcStatsUploadType),t){case xn.UDP_TCP_RELAY:e._pcStatsUploadType=Po.UDP_TCP_RESTART;break;case xn.TCP_RELAY:e._pcStatsUploadType=Po.TCP_RESTART;break;case xn.RELAY:e._pcStatsUploadType=Po.RELAY_RESTART;break;default:e._pcStatsUploadType=Po.OLD_RESTART}e._isTryConnecting=!0,i.next(a)}catch(s){var r;(r=i)===null||r===void 0||r.throw(s)}finally{n()}}))()}getUplinkNetworkQuality(){if(!this.connection)return 0;const t=this.connection.getStats(),e=this.localTrackMap.get(tt.LocalVideoTrack),n=this.localTrackMap.get(tt.LocalAudioTrack),i=t.videoSend.find((f=>f.ssrc===e?.ssrcs[0].ssrcId)),r=t.audioSend.find((f=>f.ssrc===n?.ssrcs[0].ssrcId));if(!i||!r)return 1;const s=Ji(this,Rt.NeedSignalRTT),o=i?i.rttMs:void 0,a=r?r.rttMs:void 0,c=o&&a?(o+a)/2:o||a,d=(c&&s?(c+s)/2:c||s)||0,l=100*t.sendPacketLossRate*.7/50+.3*d/1500,h=l<.17?1:l<.36?2:l<.59?3:l<.1?4:5,p=e?.track;if(p&&p._encoderConfig&&p._hints.indexOf(Ee.SCREEN_TRACK)===-1){const f=p._encoderConfig.bitrateMax,v=t.bitrate.actualEncoded;if(f&&v){const S=(1e3*f-v)/(1e3*f);return OD[S<.15?0:S<.3?1:S<.45?2:S<.6?3:4][h]}}return h}getDownlinkNetworkQuality(){if(!this.connection)return 0;const t=this.connection.getStats();let e=0;return Array.from(this.remoteUserMap.entries()).forEach((n=>{let[i]=n;const r=i._audioSSRC,s=i._videoSSRC,o=t.audioRecv.find((v=>v.ssrc===r)),a=t.videoRecv.find((v=>v.ssrc===s));if(!o&&!a)return void(e+=1);const c=Ji(this,Rt.NeedSignalRTT),d=t.rtt,l=(d&&c?(d+c)/2:d||c)||0,h=o?o.jitterMs:void 0,p=t.recvPacketLossRate;let f=.7*p*100/50+.3*l/1500;h&&(f=.6*p*100/50+.2*l/1500+.2*h/400),e+=f<.1?1:f<.17?2:f<.36?3:f<.59?4:5})),this.remoteUserMap.size>0?Math.round(e/this.remoteUserMap.size):e}async muteLocalTrack(t){return new st(((e,n)=>{this.handleMuteLocalTrack(t,e,n)}))}async replaceTrack(t,e){var n;if(m.debug("[".concat(this.store.clientId,"] P2PChannel replaceTrack from [").concat(t.getTrackId(),"] to [").concat(e.getTrackId(),"]")),!this.connection||this.state!==me.Connected)return;const i=Array.from(this.localTrackMap.entries()).find((s=>{let[,{track:o}]=s;return t===o}));if(!i)return;const r=i[0];if(t!==e&&(this.unbindLocalTrackEvents([{track:t,type:r}]),this.bindLocalTrackEvents([{track:e,type:r}]),i[1].track=e),await((n=this.connection)===null||n===void 0?void 0:n.replaceTrack(e,i[1].id)),this.isPlanB){const s=i[1];s.id=e._mediaStreamTrack.id,this.localTrackMap.set(r,s)}if(r===tt.LocalVideoTrack&&!I("DISABLE_DUAL_STREAM_USE_ENCODING")&&Jt().supportDualStreamEncoding){const s=this.localTrackMap.get(tt.LocalVideoLowTrack);if(s){const o=t._mediaStreamTrack.clone();s.track._originMediaStreamTrack.stop(),s.track._mediaStreamTrack=o,s.track._originMediaStreamTrack=o,await new st(((a,c)=>{this.handleReplaceTrack(s.track,a,c,!0)}))}}}filterTobePublishedTracks(t,e,n){const i=[],r=this.getAllTracks();t=Td(t=t.filter((c=>r.indexOf(c)===-1)));let s,o=!1;const a=this.localTrackMap.get(tt.LocalAudioTrack);for(const c of t){if(c instanceof De&&(this.localTrackMap.has(tt.LocalVideoTrack)||o?new H(A.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS).throw():(i.push({track:c,type:tt.LocalVideoTrack}),o=!0),e)){const d=this.getLowVideoTrack(c,n);i.push({track:d,type:tt.LocalVideoLowTrack})}if(c instanceof rn)if(a){const d=a.track;if(d instanceof Cn)ST([c]),d.addAudioTrack(c),this.bindLocalAudioTrackEvents(c,!0);else{const l=TT([d,c]);m.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection will replace audioTrack [").concat(l.getTrackId(),"]")),this.replaceTrack(d,l)}}else s instanceof Cn?(ST([c]),s.addAudioTrack(c)):s||!c._useAudioElement&&Jt().webAudioMediaStreamDest&&!c._bypassWebAudio?s=TT(s?[c,s]:[c]):s=c}return s&&(m.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection will send audioTrack [").concat(s.getTrackId(),"]")),i.push({track:s,type:tt.LocalAudioTrack})),i}filterTobeUnpublishedTracks(t){const e=[],n=this.getAllTracks();t=Td(t=t.filter((i=>n.indexOf(i)!==-1)));for(const i of t){if(i instanceof rn){const r=this.localTrackMap.get(tt.LocalAudioTrack);if(!r)continue;r.track instanceof Cn?(r.track.removeAudioTrack(i),this.unbindLocalAudioTrackEvents(i),r.track.trackList.length===0&&(e.push([tt.LocalAudioTrack,r]),r.track.close())):e.push([tt.LocalAudioTrack,r])}if(i instanceof De){const r=this.localTrackMap.get(tt.LocalVideoTrack);if(!r)continue;e.push([tt.LocalVideoTrack,r]);const s=this.localTrackMap.get(tt.LocalVideoLowTrack);s&&e.push([tt.LocalVideoLowTrack,s])}}return e}filterTobePublishedDataChannels(t){return t=(t=Td(t)).filter((e=>this.localDataChannels.findIndex((n=>n.id===e.id))===-1))}filterTobeUnpublishedDataChannels(t){return t=(t=(t=Td(t)).filter((e=>this.localDataChannels.indexOf(e)!==-1))).filter((e=>e._originDataChannel))}bindLocalTrackEvents(t){t.forEach((e=>{let{track:n,type:i}=e;switch(i){case tt.LocalVideoTrack:n.addListener(_t.GET_STATS,this.handleGetLocalVideoStats),n.addListener(_t.GET_RTC_STATS,this.handleGetRTCStats),n.addListener(_t.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),n.addListener(_t.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),n.addListener(_t.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),n.addListener(_t.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this.handleUpdateVideoSendParameters),n.addListener(_t.NEED_REPLACE_TRACK,this.handleReplaceTrack),n.addListener(_t.NEED_MUTE_TRACK,this.handleMuteLocalTrack),n.addListener(_t.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case tt.LocalAudioTrack:this.bindLocalAudioTrackEvents(n);case tt.LocalVideoLowTrack:}}))}bindLocalAudioTrackEvents(t,e){t instanceof Cn?t.trackList.forEach((n=>{n.addListener(_t.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),n.addListener(_t.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),n.addListener(_t.GET_STATS,this.handleGetLocalAudioStats),n.addListener(_t.NEED_MUTE_TRACK,this.handleMuteLocalTrack),n.addListener(_t.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)})):(t.addListener(_t.GET_STATS,this.handleGetLocalAudioStats),t.addListener(_t.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.addListener(_t.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.addListener(_t.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.addListener(_t.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack),e||(t.addListener(_t.NEED_REPLACE_TRACK,this.handleReplaceTrack),t.addListener(_t.NEED_REPLACE_MIXING_TRACK,this.handleReplaceMixingTrack)))}unbindLocalTrackEvents(t){t||(t=Array.from(this.localTrackMap.entries()).map((e=>{let[n,{track:i}]=e;return{track:i,type:n}}))),t.forEach((e=>{let{track:n,type:i}=e;switch(i){case tt.LocalVideoTrack:n.off(_t.GET_STATS,this.handleGetLocalVideoStats),n.off(_t.GET_RTC_STATS,this.handleGetRTCStats),n.off(_t.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),n.off(_t.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),n.off(_t.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),n.off(_t.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this.handleUpdateVideoSendParameters),n.off(_t.NEED_REPLACE_TRACK,this.handleReplaceTrack),n.off(_t.NEED_MUTE_TRACK,this.handleMuteLocalTrack),n.off(_t.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case tt.LocalAudioTrack:this.unbindLocalAudioTrackEvents(n);case tt.LocalVideoLowTrack:}}))}unbindLocalAudioTrackEvents(t){t instanceof Cn?t.trackList.forEach((e=>{e.off(_t.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.off(_t.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.off(_t.GET_STATS,this.handleGetLocalAudioStats),e.off(_t.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.off(_t.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)})):(t.off(_t.GET_STATS,this.handleGetLocalAudioStats),t.off(_t.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.off(_t.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.off(_t.NEED_REPLACE_TRACK,this.handleReplaceTrack),t.off(_t.NEED_REPLACE_MIXING_TRACK,this.handleReplaceMixingTrack),t.off(_t.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.off(_t.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack))}bindRemoteTrackEvents(t,e){e instanceof Ld&&e.addListener(_t.GET_STATS,(n=>{n(this.handleGetRemoteVideoStats(t))})),e instanceof kd&&e.addListener(_t.GET_STATS,(n=>{n(this.handleGetRemoteAudioStats(t))}))}unbindRemoteTrackEvents(t){t&&t.removeAllListeners(_t.GET_STATS)}unbindAllRemoteTrackEvents(){Array.from(this.remoteUserMap.entries()).forEach((t=>{let[e,n]=t;n.has(ut.AUDIO)&&this.unbindRemoteTrackEvents(e._audioTrack),n.has(ut.VIDEO)&&this.unbindRemoteTrackEvents(e._videoTrack)}))}createGatewayPublishMessage(t,e){return t.map(((n,i)=>{var r;let s,o,{track:a,type:c}=n;switch(c){case tt.LocalAudioTrack:s=Re.Audio,o={dtx:a instanceof uu&&a._config.DTX,hq:!1,lq:!1,stereo:!1,speech:!1};break;case tt.LocalVideoTrack:s=$(r=a._hints).call(r,Ee.SCREEN_TRACK)?Re.Screen:Re.High,o=so(so({},HD(a)),{},{codec:this.store.codec,svc_mode:fu()});break;case tt.LocalVideoLowTrack:s=Re.Low,o=so(so({},HD(a)),{},{codec:this.store.codec,svc_mode:fu()})}return{stream_type:s,attributes:o,ssrcs:e[i]}}))}createGatewayUnpublishMessage(t){return t.map((e=>{var n;let i,[r,{track:s,ssrcs:o,id:a}]=e;switch(r){case tt.LocalVideoTrack:i=$(n=s._hints).call(n,Ee.SCREEN_TRACK)?Re.Screen:Re.High;break;case tt.LocalAudioTrack:i=Re.Audio;break;case tt.LocalVideoLowTrack:i=Re.Low}return{stream_type:i,ssrcs:o,mid:a}}))}assignLocalTracks(t,e){t.forEach(((n,i)=>{let{track:r,type:s}=n;this.localTrackMap.set(s,{track:r,id:e[i].id,ssrcs:e[i].localSSRC})}))}withdrawLocalTracks(t){t.forEach((e=>{let[n]=e;this.localTrackMap.delete(n)}))}bindConnectionEvents(t){t.onConnectionStateChange=async e=>{if(m.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onConnectionStateChange(").concat(e,")")),this.emit(Rt.PeerConnectionStateChange,e),e==="connecting"&&t instanceof gr&&!xe()&&I("FIRST_TCP_CANDIDATE")&&window.setTimeout((()=>{e==="connecting"&&t.extendCandidate()}),I("FIRST_TCP_CANDIDATE_INTERVAL")),e!=="connected"||this.store.keyMetrics.peerConnectionEnd||this.store.peerConnectionEnd(),e==="connected"&&(this._restartTimer&&(window.clearTimeout(this._restartTimer),this._restartTimer=void 0),t instanceof gr&&BP(t,!0),this._isTryConnecting&&this.reportPCStats(Date.now(),!0,this._pcStatsUploadType),this._isTryConnecting=!1,this._isStartRestartIce=!1,this._pcStatsUploadType=Po.DISCONNECTED_OR_FAILED,Ji(this,Rt.QueryClientConnectionState)==="CONNECTED"&&this._isWaitPcToRePub)){const n=this.pendingLocalTracks.map((r=>r.getTrackId())),i=this.pendingLocalDataChannels.map((r=>"dc_".concat(r.id)));pt.reportApiInvoke(this.store.sessionId,{name:Ge.REPUB_AFTER_PC_CONNECTED,options:n.concat(i),tag:Ne.TRACER}).onSuccess(),this.republish()}if(I("NEW_ICE_RESTART")&&t instanceof gr&&!xe()&&!this._forceTurn&&!this.store.useDcSignal){if($(VD).call(VD,e)){if(this._isStartRestartIce)return;this._isStartRestartIce=!0;const n=r=>{RT(t)&&(m.debug("[".concat(this.store.clientId,"] [P2PChannel] try to restartICE, type is ").concat(r)),Ji(this,Rt.QueryClientConnectionState)==="CONNECTED"&&this.emit(Rt.RequestRestartICE,r))},i=()=>{RT(t)&&(this.reportPCStats(Date.now(),!1,this._pcStatsUploadType),m.debug("[".concat(this.store.clientId,"] P2PConnection disconnected timeout, force reconnect")),setTimeout((()=>this.emit(Rt.P2PLost)),0),this.iceFailedCount+=1,this.requestReconnect())};return void(this._restartTimer=window.setTimeout((()=>{jP(t,n,i)}),800))}}else{if(e==="disconnected"&&t.iceConnectionState==="disconnected")return setTimeout((()=>{t.iceConnectionState==="disconnected"&&I("ICE_RESTART")&&Ji(this,Rt.QueryClientConnectionState)==="CONNECTED"&&this.emit(Rt.RequestRestartICE)}),800),void setTimeout((()=>{t.peerConnectionState==="disconnected"&&(m.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection disconnected timeout 4000ms, force reconnect")),this.reportPCStats(Date.now(),!1,this._pcStatsUploadType),this._isTryConnecting=!1,setTimeout((()=>this.emit(Rt.P2PLost)),0),this.iceFailedCount+=1,this.requestReconnect())}),4e3);e==="failed"&&(m.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection state failed, force reconnect")),this.reportPCStats(Date.now(),!1,this._pcStatsUploadType),setTimeout((()=>this.emit(Rt.P2PLost)),0),this.iceFailedCount+=1,await this.requestReconnect())}},t.onICEConnectionStateChange=e=>{e!=="connected"||this.store.keyMetrics.iceConnectionEnd||this.store.iceConnectionEnd(),m.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICEConnectionStateChange(").concat(e,")")),pt.reportApiInvoke(this.store.sessionId,{name:"ICEConnectionStateChange",options:e,tag:Ne.TRACER}).onSuccess(),this.emit(Rt.IceConnectionStateChange,e)},t.onICETransportStateChange=e=>{m.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICETransportStateChange(").concat(e,")"))},t.onDTLSTransportStateChange=e=>{m.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportStateChange(").concat(e,")"))},t.onDTLSTransportError=e=>{m.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportError(").concat(e,")"))},t.onFirstAudioDecoded=e=>{var n;const i=Array.from(oi(n=this.remoteUserMap).call(n)).find((s=>s._audioSSRC===e));var r;i&&(this.store.subscribe(i.uid,"audio",void 0,void 0,void 0,Date.now()),(r=i.audioTrack)===null||r===void 0||r.emit(Or.FIRST_FRAME_DECODED),pt.firstRemoteFrame(this.store.sessionId,vn.FIRST_AUDIO_DECODE,We.FIRST_AUDIO_DECODE,{peer:i._uintid,subscribeElapse:ni.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId}))},t.onFirstAudioReceived=e=>{var n;const i=Array.from(oi(n=this.remoteUserMap).call(n)).find((r=>r._audioSSRC===e));i&&pt.firstRemoteFrame(this.store.sessionId,vn.FIRST_AUDIO_RECEIVED,We.FIRST_AUDIO_RECEIVED,{peer:i._uintid,subscribeElapse:ni.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId})},t.onFirstVideoDecoded=(e,n,i)=>{var r;const s=Array.from(oi(r=this.remoteUserMap).call(r)).find((o=>o._videoSSRC===e));s&&this.store.firstVideoFrameDecoded(s.uid,{firstDecoded:Date.now()}),this.reportVideoFirstFrameDecoded(e,n,i)},t.onFirstVideoRender=e=>{var n;const i=Array.from(oi(n=this.remoteUserMap).call(n)).find((r=>r._videoSSRC===e));i&&(this.store.firstVideoFrameDecoded(i.uid,{firstPreRender:Date.now()}),this.reportVideoFirstFrameRender(i),this.emit(Rt.FirstVideoPreRender,i.uid,e))},t.onFirstVideoReceived=e=>{var n;const i=Array.from(oi(n=this.remoteUserMap).call(n)).find((r=>r._videoSSRC===e));i&&(this.store.firstVideoFrameDecoded(i.uid,{firstReceived:Date.now()}),pt.firstRemoteFrame(this.store.sessionId,vn.FIRST_VIDEO_RECEIVED,We.FIRST_VIDEO_RECEIVED,{peer:i._uintid,subscribeElapse:ni.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId}))},t.onFirstVideoBufferReady=e=>{var n;const i=Array.from(oi(n=this.remoteUserMap).call(n)).find((r=>r._videoSSRC===e));i&&this.emit(Rt.FirstVideoBufferReady,i.uid,e)},t.onSelectedLocalCandidateChanged=(e,n)=>{const i=e.candidateType==="relay",r=n.candidateType==="relay";n.candidateType!=="unknown"&&i===r||this.emit(Rt.ConnectionTypeChange,i),m.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedLocalCandidateChanged(").concat(JSON.stringify(ha(n))," -> ").concat(JSON.stringify(ha(e)),")"))},t.onSelectedRemoteCandidateChanged=(e,n)=>{m.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedRemoteCandidateChanged(").concat(JSON.stringify(ha(n))," -> ").concat(JSON.stringify(ha(e)),")"))},t.onFirstVideoDecodedTimeout=e=>{this.reportVideoFirstFrameDecoded(e,void 0,void 0,!0)},t.getLocalVideoStats=()=>{const e=this.statsCollector.getLocalVideoTrackStats(),n=this.statsCollector.getRTCStats();return so(so({},e),n)},t.onICECandidateError=e=>{this._iceError=e}}fallbackConnection(){m.debug("[".concat(this.store.clientId,"] [P2PChannel] try to fallback connection")),this.state===me.Connected?(m.debug("[".concat(this.store.clientId,"] [P2PChannel] fallback to websocket but P2PChannel state still connected, disconnect first")),this.disconnectForReconnect()):(this.connection&&this.resetConnection(this.connection),this.shouldForwardP2PCreation&&(this.connection=Cu(this.store),this.emit(Rt.PeerConnectionStateChange,this.connection.peerConnectionState),this.bindConnectionEvents(this.connection)))}resetConnection(t){t instanceof gr&&(function(e){zd.delete(e.id),BP(e)})(t),t.close(),this.emit(Rt.PeerConnectionStateChange,"closed"),(function(e){e.onConnectionStateChange=void 0,e.onICEConnectionStateChange=void 0,e.onICETransportStateChange=void 0,e.onDTLSTransportStateChange=void 0,e.onDTLSTransportError=void 0,e.onFirstAudioDecoded=void 0,e.onFirstAudioReceived=void 0,e.onFirstVideoDecoded=void 0,e.onFirstVideoReceived=void 0,e.onSelectedLocalCandidateChanged=void 0,e.onSelectedRemoteCandidateChanged=void 0,e.onFirstVideoDecodedTimeout=void 0,e.getLocalVideoStats=void 0})(t),this._isWaitPcToRePub=!1}filterTobeMutedTracks(t){const e=[];if(this.getAllTracks().indexOf(t)===-1)return e;const n=this.localTrackMap.get(tt.LocalAudioTrack);if(t instanceof rn&&n?.track instanceof Cn)return n.track.isActive||e.push([tt.LocalAudioTrack,n]),e;const i=Array.from(this.localTrackMap.entries()).find((r=>{let[,{track:s}]=r;return t===s}));if(i&&(e.push(i),i[0]===tt.LocalVideoTrack)){const r=this.localTrackMap.get(tt.LocalVideoLowTrack);r&&e.push([tt.LocalVideoLowTrack,r])}return e}filterTobeUnmutedTracks(t){const e=[],n=this.localTrackMap.get(tt.LocalAudioTrack);if(t instanceof rn&&n?.track instanceof Cn)return n.track.isActive&&e.push([tt.LocalAudioTrack,n]),e;const i=Array.from(this.localTrackMap.entries()).find((r=>{let[,{track:s}]=r;return t===s}));if(i)if(i[0]===tt.LocalVideoTrack){e.push(i);const r=this.localTrackMap.get(tt.LocalVideoLowTrack);r&&e.push([tt.LocalVideoLowTrack,r])}else e.push(i);return e}createMuteMessage(t){return t.map((e=>{var n;let i,[r,{track:s,ssrcs:o,id:a}]=e;switch(r){case tt.LocalAudioTrack:i=Re.Audio;break;case tt.LocalVideoTrack:i=$(n=s._hints).call(n,Ee.SCREEN_TRACK)?Re.Screen:Re.High;break;case tt.LocalVideoLowTrack:i=Re.Low}return{stream_type:i,ssrcs:o,mid:a}}))}createUnmuteMessage(t){return t.map((e=>{var n;let i,[r,{track:s,ssrcs:o,id:a}]=e;switch(r){case tt.LocalAudioTrack:i=Re.Audio;break;case tt.LocalVideoTrack:i=$(n=s._hints).call(n,Ee.SCREEN_TRACK)?Re.Screen:Re.High;break;case tt.LocalVideoLowTrack:i=Re.Low}return{stream_type:i,ssrcs:o,mid:a}}))}filterTobeUnSubscribedTracks(t,e){const n=[],i=this.remoteUserMap.get(t);if(!i)return n;if(e){const r=i.get(e);if(!r)return n;n.push([t,{kind:e,id:r}])}else Array.from(i.entries()).forEach((r=>{let[s,o]=r;n.push([t,{kind:s,id:o}])}));return n}filterTobeUnSubscribedDataChannels(t,e){const n=[];return e.forEach((i=>{var r;(r=this.remoteDataChannelMap.get(t))!==null&&r!==void 0&&r.has(i.id)&&n.push(i)})),n}createUnsubscribeMessage(t){const e=[];return t.forEach((n=>{let[i,{kind:r,id:s}]=n;switch(r){case ut.VIDEO:return void(i._videoSSRC&&e.push({stream_type:ut.VIDEO,ssrcId:i._videoSSRC}));case ut.AUDIO:return void(i._audioSSRC&&e.push({stream_type:ut.AUDIO,ssrcId:i._audioSSRC}))}})),e}createUnsubscribeAllMessage(t){const e=new Map;return t.forEach((n=>{let[i,{kind:r}]=n;if(e.has(i)){let s=e.get(i);r===ut.VIDEO?s|=Pn.Video:s|=Pn.Audio,e.set(i,s)}else r===ut.VIDEO?e.set(i,Pn.Video):e.set(i,Pn.Audio)})),{users:Array.from(e.entries()).map((n=>{let[i,r]=n;return{stream_id:i.uid,stream_type:r}}))}}withdrawRemoteTracks(t){t.forEach((e=>{let[n,{kind:i}]=e;const r=this.remoteUserMap.get(n);r&&(r.delete(i),Array.from(r.entries()).length===0&&this.remoteUserMap.delete(n))}))}async updateBitrateLimit(t){const e=this.localTrackMap.get(tt.LocalVideoTrack),n=this.localTrackMap.get(tt.LocalVideoLowTrack);e&&(await e.track.setBitrateLimit(t.uplink),await new st(((i,r)=>{this.handleUpdateVideoEncoder(e.track,i,r,!0)}))),n&&t.low_stream_uplink&&(await n.track.setBitrateLimit({max_bitrate:t.low_stream_uplink.bitrate,min_bitrate:t.low_stream_uplink.bitrate||0}),await new st(((i,r)=>{this.handleUpdateVideoEncoder(n.track,i,r,!0)})))}isP2PDisconnected(){return this.connection?this.connection.peerConnectionState!=="connected":!0}isPreallocation(){return!(!this.connection||!("name"in this.connection)||this.connection.name!=="DataChannelConnection"||this.connection.peerConnectionState==="closed")||this.connection instanceof gr&&this.connection.isPreallocation}isPreSub(){return(this.connection&&"name"in this.connection&&this.connection.name==="DataChannelConnection"&&this.connection.peerConnectionState!=="closed"||this.connection instanceof gr)&&this.connection.isPreSub()}isPreRender(){return this.connection instanceof gr&&this.connection.isPreRender}mapPubResToRemoteConfig(t,e,n){return t.map(((i,r)=>{var s;let{stream_type:o}=i;const a=(s=e.find((c=>{let{stream_type:d}=c;return o===d})))===null||s===void 0?void 0:s.attributes;if(a&&I("DISABLE_SCREEN_SHARE_REMB")){const c=n[r]._hints;($(c).call(c,Ee.SCREEN_TRACK)||$(c).call(c,Ee.SCREEN_LOW_TRACK))&&(a.remb=!1,m.debug("disable remb for screen share, hints:",c))}return a}))}async tryToUnmuteAudio(t){for(let n=0;n<t.length;n++)if(t[n]instanceof rn){var e;const i=this.filterTobeUnmutedTracks(t[n]);if(i.length===0)continue;await((e=this.connection)===null||e===void 0?void 0:e.unmuteLocal(i.map((s=>{let[,{id:o}]=s;return o}))));const r=this.createUnmuteMessage(i);return void await Pe(this,Rt.RequestUnmuteLocal,r)}}bindStatsUploaderEvents(){this.statsUploader.requestStats=()=>this.getStats(),this.statsUploader.requestLocalMedia=()=>Array.from(this.localTrackMap.entries()),this.statsUploader.requestRemoteMedia=()=>Array.from(this.remoteUserMap.entries()),this.statsUploader.requestVideoIsReady=t=>{var e;return!((e=this.connection)===null||e===void 0||!e.getRemoteVideoIsReady(t))},this.statsUploader.requestUpload=(t,e)=>this.emit(Rt.RequestUpload,t,e),this.statsUploader.requestUploadStats=t=>this.emit(Rt.RequestUploadStats,t),this.statsUploader.requestAllTracks=()=>this.getAllTracks(),this.statsUploader.requestTransportStats=()=>{var t;return{connectState:((t=this.connection)===null||t===void 0?void 0:t.peerConnectionState)||"closed"}}}unbindStatsUploaderEvents(){this.statsUploader.requestStats=void 0,this.statsUploader.requestLocalMedia=void 0,this.statsUploader.requestRemoteMedia=void 0,this.statsUploader.requestVideoIsReady=void 0}async requestReconnect(){this.dtlsFailedCount+=1,await Nn(Kp(this.dtlsFailedCount,fn)),this.emit(Rt.RequestReconnect)}async reconnectP2P(){const t=Array.from(this.localTrackMap.entries()),e=this.createGatewayUnpublishMessage(t);Array.from(this.remoteUserMap.entries()),e.length>0&&await Sn(this,Rt.RequestUnpublishForReconnectPC,e),this.disconnectForReconnect(),this.emit(Rt.RequestReconnectPC)}canPublishLowStream(){return this.localTrackMap.has(tt.LocalVideoTrack)||this.pendingLocalTracks.some((t=>t instanceof De))}throwIfTrackTypeNotMatch(t){if(t.filter((e=>e instanceof De)).length>1)throw new H(A.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(t.filter((e=>e instanceof rn)).length>1&&(t.some((e=>e instanceof rn&&e._bypassWebAudio))||!Jt().webAudioMediaStreamDest))throw new H(A.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode");for(const e of t){if(e instanceof De&&this.pendingLocalTracks.some((n=>n instanceof De)))throw new H(A.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(e instanceof rn&&this.pendingLocalTracks.some((n=>n instanceof rn))&&(!Jt().webAudioMediaStreamDest||e._bypassWebAudio||this.pendingLocalTracks.some((n=>n instanceof rn&&n._bypassWebAudio))))throw new H(A.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode")}}getLowVideoTrack(t,e){var n;const i=!I("DISABLE_DUAL_STREAM_USE_ENCODING")&&Jt().supportDualStreamEncoding,r=so(so({},{width:160,height:120,framerate:15,bitrate:50}),e);let s;s=i?t._mediaStreamTrack.clone():CT(t,r);const o=Se(8,"track-low-"),a=new De(s,so(so({},i&&{scaleResolutionDownBy:$S(r,t)}),{},{frameRate:r.framerate,bitrateMax:r.bitrate,bitrateMin:r.bitrate}),void 0,void 0,o);return a.on(sc.TRANSCEIVER_UPDATED,(c=>{t._updateRtpTransceiver(c,Ad.LOW_STREAM)})),a._hints.push(Ee.LOW_STREAM),$(n=t._hints).call(n,Ee.SCREEN_TRACK)&&a._hints.push(Ee.SCREEN_LOW_TRACK),t.on("sei-to-send",(c=>{a.emit("sei-to-send",c)})),t.addListener(_t.NEED_CLOSE,(()=>{a.close()})),a}async globalLock(){return this.mutex.lock("From P2PChannel.globalLock")}async reportPCStats(t,e,n){let i=arguments.length>3&&arguments[3]!==void 0?arguments[3]:null;if(this.connection&&this.connection instanceof gr){var r,s,o,a;const c=this.store.keyMetrics.descriptionStart||0,{iceConnectionState:d,dtlsTransportState:l,peerConnectionState:h}=this.connection,{local:p,remote:f}=await this.connection.getSelectedCandidatePair();pt.pcStats(this.store.sessionId,{startTime:c,eventElapse:t-c||0,iceconnectionsate:d,dtlsstate:l,connectionstate:h,intSucc:e?1:2,error:this._iceError||i||"",selectedLocalCandidateProtocol:(r=p?.protocol)!==null&&r!==void 0?r:"",selectedLocalCandidateType:(s=p.candidateType)!==null&&s!==void 0?s:"",selectedLocalCandidateAddress:"".concat(p.address,":").concat(p.port),selectedRemoteCandidateProtocol:(o=f.protocol)!==null&&o!==void 0?o:"",selectedRemoteCandidateType:(a=f.candidateType)!==null&&a!==void 0?a:"",selectedRemoteCandidateAddress:"".concat(f.address,":").concat(f.port),restartCnt:n,preallocation:this.connection.isPreallocation}),this._iceError=null}}reportVideoFirstFrameRender(t){const e=this.store.keyMetrics,n=e.firstVideoFrameDecoded.find((l=>l.userId===t.uid));if(!n)return;const{isInternalUpload:i,isExternalUpload:r}=n;if(i&&r)return;const{subscribeEnd:s,firstPreRender:o,peerPublishDuration:a,peerPubStatusMs:c}=n;let{firstRender:d=0}=n;if(s&&(d||o)&&a&&c){n.isInternalUpload=!0;const{playEnd:l}=n;l&&(n.isExternalUpload=!0);const{firstPreRender:h=0}=n;d=h||d;const p=t.videoTrack,f={peer:t._uintid,width:p?._videoWidth||0,height:p?._videoHeight||0,ssrc:t._videoSSRC||0,p2pid:this.store.p2pId,peerPublishDuration:a,peerPubStatusMs:c,joinChannelStart:e.joinStart||0,preloadStart:e.preloadStart||0,preloadEnd:e.preloadEnd||0,apStart:e.requestAPStart||0,apEnd:e.requestAPEnd||0,suaEnd:e.requestSUAEnd||0,beforeConnect:e.beforeConnect||0,peerReceiver:e.peerReceiver||0,ice:e.iceConnectionEnd||0,pc:e.peerConnectionEnd||0,signalConnected:e.signalConnected||0,joinReq:e.joinReq||0,joinRes:e.joinRep||0,userJoinNotify:n.userJoinNotify||0,videoAddNotify:n.videoAddNotify||0,subscribeStart:n.subscribeStart||0,subscribeEnd:n.subscribeEnd||0,firstReceived:n.firstReceived||0,firstDecoded:n.firstDecoded||0,firstPreRender:h||0,firstRender:l?Math.max(d,l):Math.max(d,s),playStart:n.playStart||0,playEnd:n.playEnd||0,isPreSub:!(!t._videoSSRC||!this.isPreSubScribe(t._videoSSRC)),isPrePc:this.isPreallocation(),isPreInstantVideo:l0(this.store),firstReceivedEncodedFrame:n.firstReceivedEncodedFrame||0,frameType:n.frameType||"",rtpTimestamp:n.rtpTimestamp||0,framePayloadType:n.framePayloadType||0,frameDataLength:n.frameDataLength||0,mimeType:n.mimeType||""};pt.firstXLAPeerFirstVideoFrame(this.store.sessionId,f)}}reportVideoFirstFrameDecoded(t,e,n,i){var r;const s=Array.from(oi(r=this.remoteUserMap).call(r)).find((o=>o._videoSSRC===t));if(s){i||this.store.subscribe(s.uid,"video",void 0,void 0,void 0,void 0,Date.now());const o=this.store.keyMetrics,a=o.subscribe.find((c=>c.userId===s.uid&&c.type==="video"));pt.firstRemoteVideoDecode(this.store.sessionId,vn.FIRST_VIDEO_DECODE,We.FIRST_VIDEO_DECODE,{peer:s._uintid,videowidth:e,videoheight:n,subscribeElapse:ni.measureFromSubscribeStart(this.store.clientId,t),subscribeRequestid:t,p2pid:this.store.p2pId,apEnd:o.requestAPEnd||0,apStart:o.requestAPStart||0,joinGwEnd:o.joinGatewayEnd||0,joinGwStart:o.joinGatewayStart||0,pcEnd:o.peerConnectionEnd||0,pcStart:o.peerConnectionStart||0,subscriberEnd:a?.subscribeEnd||0,subscriberStart:a?.subscribeStart||0,videoAddNotify:a?.streamAdded||0,state:i?1:0,firstFrame:a?.firstFrame||0})}}async remoteMediaSsrcChanged(t,e,n){if(!this.connection)return!1;const i=this.remoteUserMap.get(t);if(!i)return!1;const r=i.get(e);if(!r)return!1;const s=await this.connection.getRemoteSSRC(r);return s!==void 0&&s!==n}unbindRtpTransceiver(){this.localTrackMap.size!==0&&Array.from(this.localTrackMap.entries()).forEach((t=>{let[e,{track:n}]=t;e===tt.LocalVideoLowTrack?n._updateRtpTransceiver(void 0,Ad.LOW_STREAM):n._updateRtpTransceiver(void 0)}))}},ot(Zt.prototype,"startP2PConnection",[di],Object.getOwnPropertyDescriptor(Zt.prototype,"startP2PConnection"),Zt.prototype),ot(Zt.prototype,"connect",[di],Object.getOwnPropertyDescriptor(Zt.prototype,"connect"),Zt.prototype),ot(Zt.prototype,"updateRemoteRTPCapabilities",[di],Object.getOwnPropertyDescriptor(Zt.prototype,"updateRemoteRTPCapabilities"),Zt.prototype),ot(Zt.prototype,"publishDataChannel",[di],Object.getOwnPropertyDescriptor(Zt.prototype,"publishDataChannel"),Zt.prototype),ot(Zt.prototype,"unpublish",[di],Object.getOwnPropertyDescriptor(Zt.prototype,"unpublish"),Zt.prototype),ot(Zt.prototype,"unpublishDataChannel",[di],Object.getOwnPropertyDescriptor(Zt.prototype,"unpublishDataChannel"),Zt.prototype),ot(Zt.prototype,"unpublishLowStream",[di],Object.getOwnPropertyDescriptor(Zt.prototype,"unpublishLowStream"),Zt.prototype),ot(Zt.prototype,"subscribeDataChannel",[di],Object.getOwnPropertyDescriptor(Zt.prototype,"subscribeDataChannel"),Zt.prototype),ot(Zt.prototype,"subscribe",[di],Object.getOwnPropertyDescriptor(Zt.prototype,"subscribe"),Zt.prototype),ot(Zt.prototype,"massSubscribe",[di],Object.getOwnPropertyDescriptor(Zt.prototype,"massSubscribe"),Zt.prototype),ot(Zt.prototype,"unsubscribe",[di],Object.getOwnPropertyDescriptor(Zt.prototype,"unsubscribe"),Zt.prototype),ot(Zt.prototype,"unsubscribeDataChannel",[di],Object.getOwnPropertyDescriptor(Zt.prototype,"unsubscribeDataChannel"),Zt.prototype),ot(Zt.prototype,"massUnsubscribe",[di],Object.getOwnPropertyDescriptor(Zt.prototype,"massUnsubscribe"),Zt.prototype),ot(Zt.prototype,"muteRemote",[di],Object.getOwnPropertyDescriptor(Zt.prototype,"muteRemote"),Zt.prototype),ot(Zt.prototype,"unmuteRemote",[di],Object.getOwnPropertyDescriptor(Zt.prototype,"unmuteRemote"),Zt.prototype),ot(Zt.prototype,"hasRemoteMediaWithLock",[di],Object.getOwnPropertyDescriptor(Zt.prototype,"hasRemoteMediaWithLock"),Zt.prototype),ot(Zt.prototype,"disconnectForReconnect",[di],Object.getOwnPropertyDescriptor(Zt.prototype,"disconnectForReconnect"),Zt.prototype),ot(Zt.prototype,"updateBitrateLimit",[di],Object.getOwnPropertyDescriptor(Zt.prototype,"updateBitrateLimit"),Zt.prototype),ot(Zt.prototype,"remoteMediaSsrcChanged",[di],Object.getOwnPropertyDescriptor(Zt.prototype,"remoteMediaSsrcChanged"),Zt.prototype),Zt);function di(t,e,n){const i=t[e];if(typeof i!="function")throw new Error("Cannot use mutex on object property.");return n.value=async function(){const r=this.mutex,s=await r.lock("From P2PChannel.".concat(e));try{for(var o=arguments.length,a=new Array(o),c=0;c<o;c++)a[c]=arguments[c];return await i.apply(this,a)}finally{s()}},n}function HP(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable}))),n.push.apply(n,i)}return n}function KP(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?HP(Object(n),!0).forEach((function(i){R(t,i,n[i])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):HP(Object(n)).forEach((function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i))}))}return t}const qY=Date.now(),zY=20,bT=new Map,j_=new Map;async function YP(t){const e=bT.get(t),n=Array.isArray(e)&&e[e.length-1],i=j_.get(t);if(!n)return void(i.isSyncing=!1);const r={uid:n.uid,payload:n.payload};i.firstRecvTs===0&&(i.firstRecvTs=n.recvTs,i.firstSendTs=n.sendTs);const s=n.sendTs-i.firstSendTs,o=s-(Date.now()-i.firstRecvTs);o>0&&(i.firstRecvTs=Date.now()-s);let a=n.mediaDelay+o;a<=0?(e.pop(),qP(n.context,r),a=0):a=Math.min(a,zY),setTimeout((()=>e.length&&YP(t)),a)}function qP(t,e){t.safeEmit(qt.STREAM_MESSAGE,e.uid,e.payload),t.onStreamMessage&&t.onStreamMessage(e)}function XY(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0,n=arguments.length>2?arguments[2]:void 0;if(!t.syncWithAudio)return qP(n,{uid:t.uid,payload:t.payload});const i="".concat(n.id,"-").concat(t.uid),r=bT.get(i)||[],s=r.findIndex((d=>t.sendTs>=d.sendTs)),o=KP(KP({},t),{},{context:n,mediaDelay:e,recvTs:Date.now()});s===-1?r.push(o):r.splice(s,0,o),bT.set(i,r);let a=!1;var c;j_.has(i)?a=!((c=j_.get(i))===null||c===void 0||!c.isSyncing):j_.set(i,{isSyncing:a,firstRecvTs:0,firstSendTs:0}),a||YP(i)}const JY=de().name;function zP(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable}))),n.push.apply(n,i)}return n}function XP(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?zP(Object(n),!0).forEach((function(i){R(t,i,n[i])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):zP(Object(n)).forEach((function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i))}))}return t}const Xd="websdk_ng_cache_parameter",QY=I("MAX_PRELOAD_ASYNC_LENGTH"),ZY=1e4,gc=new Map,Sc=[];let AT=null,wT=0,OT=0;const G_=new Map,JP=new Uint8Array([241,141,127,212,103,139,200,225,251,157,127,139,143,2,22,163]),$Y=(function(t,e){const n=[];let i=0;const r=async()=>{const s=n.shift();s&&await s(),n.length>0&&i<e?r():i--};return async function(){for(var s=arguments.length,o=new Array(s),a=0;a<s;a++)o[a]=arguments[a];return new st((async(c,d)=>{n.push((async()=>{try{const l=await t(...o);c(l)}catch(l){d(l)}})),i<e&&(i++,r())}))}})(DT,QY),NT=yi.CancelToken.source();class tq{constructor(){R(this,"_audioContext",null)}createMuteAudioTrack(){this._audioContext=new AudioContext;const e=this._audioContext.sampleRate,n=10*e,i=this._audioContext.createBuffer(2,n,e),r=this._audioContext.createBufferSource();r.buffer=i;const s=this._audioContext.createMediaStreamDestination();return r.connect(s),r.start(),s.stream.getAudioTracks()[0]}close(){this._audioContext&&(this._audioContext.close(),this._audioContext=null)}}async function DT(t,e,n,i,r,s,o){try{if(!I("ENABLE_PRELOAD"))return;if(!Jt().supportWebCrypto)return void oa((()=>{m.warn("Your browser does not support preloading, this feature  be run in a secure environment")}),"preload_webcrypto_not_supported");if(!n&&n!==null)throw new H(A.INVALID_PARAMS,"Invalid token: ".concat(n,". If you don not use token, set it to null"));n&&Kn(n,"token",1,2047),Kn(t,"appid",1,2047),E_(e),i&&g_(i);const a=ec();m.debug("preload channel ".concat(e,", uid is ").concat(i));const c={appId:t,cname:e,token:n||t,uid:typeof i!="string"?i:null,sid:a,proxyServer:r,role:o};let d,l;typeof i=="string"?(c.stringUid=i,[l,d]=await st.all([MY(i,{sid:a,appId:t},NT.token),TP(XP(XP({},c),{},{token:n||t,uid:0}),NT.token)]),c.uid=l.uid,d.gatewayInfo.uid=c.uid,d.gatewayInfo.res.uid=c.uid):(s&&(c.stringUid=s),d=await TP(c,NT.token));const h={sid:a,appId:t,cname:e,token:n||t,uid:c.stringUid||i,intUid:c.uid||d.gatewayInfo.uid,stringUid:c.stringUid,ts:Date.now(),sua:l,ap:d};await LT(h),wT++}catch(a){throw OT++,(function(c){AT||(AT=window.setTimeout((()=>{let l="";G_.forEach(((h,p)=>{l+="".concat(p,": ").concat(h," ;")})),pt.reportApiInvoke(null,{name:Ge.PRELOAD,options:{success:wT,failed:OT,err:l}}).onError(c),wT=0,OT=0,G_.clear(),AT=null}),ZY));const d=G_.get(c.code)||0;G_.set(c.code,d+1)})(a),a}}async function PT(t){try{if(I("AP_REQUEST_DETAIL")||I("ENABLE_ROLE_SELECT_EDGE"))return;const e=QP(t);if(!e||t.cloudProxyServer!=="disabled")return;const n=await(async function(i,r){try{const s=await window.crypto.subtle.importKey("raw",VO(r),"AES-GCM",!1,["decrypt"]),o=await window.crypto.subtle.decrypt({name:"AES-GCM",iv:JP},s,tc(i));return JSON.parse(window.atob(aa(new Uint8Array(o))))}catch{return}})(e,t.token||t.appId);if(!n||!(function(i,r){return i.cname===r.cname&&i.appId===r.appId&&i.token===r.token?r.stringUid?i.stringUid===r.stringUid:typeof r.uid=="number"?i.uid===r.uid:i.uid==r.uid:!1})(n,t))return;if(n&&Date.now()-n.ts<I("AP_CACHE_LIFETIME"))return n}catch(e){m.warn("Error get preloadInfo",e.message)}}function QP(t){let e;try{if(e=tL(Xd),!e)return;const n=JSON.parse(e),i=eL(t),r=(function(o,a){for(let c=o.length-1;c>=0;c--)if(a(o[c]))return c;return-1})(n,(o=>i in o));if(r===-1)return;const s=n.splice(r,1)[0];return W_(Xd,JSON.stringify(n)),s[i]}catch(n){m.warn("Error delete preload info: ".concat(e),n.message),W_(Xd,"")}}async function LT(t){let e;try{t.uid&&QP({appId:t.appId,cname:t.cname,token:t.token,uid:t.uid,stringUid:t.stringUid});const n=eL(t),i=await(async function(s,o){try{const a=await window.crypto.subtle.importKey("raw",VO(o),"AES-GCM",!1,["encrypt"]),c=await window.crypto.subtle.encrypt({name:"AES-GCM",iv:JP},a,tc(window.btoa(JSON.stringify(s))));return aa(new Uint8Array(c))}catch{return}})(t,t.token||t.appId);if(!i)return;e=tL(Xd);const r=e?JSON.parse(e):[];r.push({[n]:i}),r.length>I("AP_CACHE_NUM")&&r.shift(),W_(Xd,JSON.stringify(r))}catch(n){m.warn("Error caching server parameters:",n.message),W_(Xd,"")}}function kT(t){if(t){let e=gc.get(t);e&&(window.clearTimeout(e),e=null,gc.delete(t)),$(Sc).call(Sc,t)||t.cloudProxyServer!=="disabled"||Sc.push(t)}if(gc.size<I("AP_CACHE_NUM")&&Sc.length>0){const e=Sc.shift();gc.set(e,window.setTimeout((async()=>{const{appId:n,cname:i,token:r,stringUid:s,uid:o,proxyServer:a,role:c}=e;try{await $Y(n,i,r,o,a,s,c),gc.has(e)&&kT(e)}catch(d){m.warn("update preload failed",d.message),ZP(e)}}),I("AP_UPDATE_INTERVAL")))}}function ZP(t){const e=Sc.indexOf(t);e!==-1&&Sc.splice(e,1);let n=gc.get(t);n&&(window.clearTimeout(n),n=null,gc.delete(t),kT())}function $P(t,e){const n=t.sua,i=t.ap;e&&n&&pt.reqUserAccount(t.sid,{lts:n.requestTime,elapse:n.elapse,success:!0,serverAddr:n.url,stringUid:e,uid:t.intUid,errorCode:null,extend:n.req}),pt.reportResourceTiming(t.ap.url,t.sid),pt.joinWebProxyAP(t.sid,{lts:i.requestTime,elapse:i.elapse,sucess:1,apServerAddr:i.url,turnServerAddrList:i.proxyInfo.addresses.map((r=>r.ip)).join(","),eventType:"disabled",unilbsServerIds:[mn.CHOOSE_SERVER,mn.CLOUD_PROXY_FALLBACK].toString()}),pt.joinChooseServer(t.sid,{lts:i.requestTime,elapse:i.elapse,succ:!0,csAddr:i.url,opid:i.opid,serverList:i.gatewayInfo.gatewayAddrs.map((r=>r.address)),ec:null,cid:i.gatewayInfo.cid.toString(),uid:i.gatewayInfo.uid.toString(),csIp:i.gatewayInfo.csIp,unilbsServerIds:[mn.CHOOSE_SERVER].toString(),isHttp3:i.isHttp3})}function tL(t){return window.atob(window.localStorage.getItem(t)||"")}function W_(t,e){window.localStorage.setItem(t,window.btoa(e))}function eL(t){let e="".concat(t.appId,"_").concat(t.cname);return typeof t.uid=="string"&&(e+="_s_".concat(t.uid)),typeof t.uid=="number"&&(e+="_".concat(t.uid)),t.token&&(e+="_".concat(t.token)),KO(e)}function eq(t){let e=(function(){const n=rq.pop();return n?(n.offset=n.limit=0,n):{bytes:new Uint8Array(64),offset:0,limit:0}})();return(function(n,i){let r=n.appId;r!==void 0&&(En(i,10),ma(i,r));let s=n.cid;s!==void 0&&(En(i,16),En(i,s));let o=n.cname;o!==void 0&&(En(i,26),ma(i,o));let a=n.deviceId;a!==void 0&&(En(i,34),ma(i,a));let c=n.elapse;c!==void 0&&(En(i,40),Ea(i,c));let d=n.fileSize;d!==void 0&&(En(i,48),Ea(i,Jd(d)));let l=n.height;l!==void 0&&(En(i,56),Ea(i,Jd(l)));let h=n.jpg;h!==void 0&&(En(i,66),En(i,h.length),iL(i,h));let p=n.networkType;p!==void 0&&(En(i,72),Ea(i,Jd(p)));let f=n.osType;f!==void 0&&(En(i,80),Ea(i,Jd(f)));let v=n.requestId;v!==void 0&&(En(i,90),ma(i,v));let S=n.sdkVersion;S!==void 0&&(En(i,98),ma(i,S));let T=n.sequence;T!==void 0&&(En(i,104),Ea(i,Jd(T)));let b=n.sid;b!==void 0&&(En(i,114),ma(i,b));let w=n.timestamp;w!==void 0&&(En(i,120),Ea(i,w));let D=n.uid;D!==void 0&&(En(i,128),En(i,D));let k=n.vid;k!==void 0&&(En(i,136),En(i,k));let U=n.width;U!==void 0&&(En(i,144),Ea(i,Jd(U)));let P=n.service;P!==void 0&&(En(i,152),En(i,P));let x=n.callbackData;x!==void 0&&(En(i,162),En(i,x.length),iL(i,x));let q=n.ticket;q!==void 0&&(En(i,170),ma(i,q));let Q=n.vendorConfigs;Q!==void 0&&(En(i,178),ma(i,Q))})(t,e),(function(n){let i=n.bytes,r=n.limit;return i.length===r?i:i.subarray(0,r)})(e)}function nq(t){return(function(n){let i={};t:for(;!sq(n);){let r=Iu(n);switch(r>>>3){case 0:break t;case 1:i.code=Iu(n);break;case 2:i.msg=rL(n,Iu(n));break;case 3:i.requestId=rL(n,Iu(n));break;case 4:i.timestamp=oq(n,!1);break;default:iq(n,7&r)}}return i})({bytes:e=t,offset:0,limit:e.length});var e}function iq(t,e){switch(e){case 0:for(;128&as(t););break;case 2:MT(t,Iu(t));break;case 5:MT(t,4);break;case 1:MT(t,8);break;default:throw new Error("Unimplemented type: "+e)}}function Jd(t){return{low:t|=0,high:t>>31,unsigned:t>=0}}let rq=[];function MT(t,e){if(t.offset+e>t.limit)throw new Error("Skip past limit");t.offset+=e}function sq(t){return t.offset>=t.limit}function H_(t,e){let n=t.bytes,i=t.offset,r=t.limit,s=i+e;if(s>n.length){let o=new Uint8Array(2*s);o.set(n),t.bytes=o}return t.offset=s,s>r&&(t.limit=s),i}function nL(t,e){let n=t.offset;if(n+e>t.limit)throw new Error("Read past limit");return t.offset+=e,n}function iL(t,e){let n=H_(t,e.length);t.bytes.set(e,n)}function rL(t,e){let n=nL(t,e),i=String.fromCharCode,r=t.bytes,s="",o="";for(let a=0;a<e;a++){let c,d,l,h,p=r[a+n];(128&p)==0?o+=i(p):(224&p)==192?a+1>=e?o+=s:(c=r[a+n+1],(192&c)!=128?o+=s:(h=(31&p)<<6|63&c,h<128?o+=s:(o+=i(h),a++))):(240&p)==224?a+2>=e?o+=s:(c=r[a+n+1],d=r[a+n+2],(49344&(c|d<<8))!=32896?o+=s:(h=(15&p)<<12|(63&c)<<6|63&d,h<2048||h>=55296&&h<=57343?o+=s:(o+=i(h),a+=2))):(248&p)==240?a+3>=e?o+=s:(c=r[a+n+1],d=r[a+n+2],l=r[a+n+3],(12632256&(c|d<<8|l<<16))!=8421504?o+=s:(h=(7&p)<<18|(63&c)<<12|(63&d)<<6|63&l,h<65536||h>1114111?o+=s:(h-=65536,o+=i(55296+(h>>10),56320+(1023&h)),a+=3))):o+=s}return o}function ma(t,e){let n=e.length,i=0;for(let o=0;o<n;o++){let a=e.charCodeAt(o);a>=55296&&a<=56319&&o+1<n&&(a=(a<<10)+e.charCodeAt(++o)-56613888),i+=a<128?1:a<2048?2:a<65536?3:4}En(t,i);let r=H_(t,i),s=t.bytes;for(let o=0;o<n;o++){let a=e.charCodeAt(o);a>=55296&&a<=56319&&o+1<n&&(a=(a<<10)+e.charCodeAt(++o)-56613888),a<128?s[r++]=a:(a<2048?s[r++]=a>>6&31|192:(a<65536?s[r++]=a>>12&15|224:(s[r++]=a>>18&7|240,s[r++]=a>>12&63|128),s[r++]=a>>6&63|128),s[r++]=63&a|128)}}function as(t){return t.bytes[nL(t,1)]}function sL(t,e){let n=H_(t,1);t.bytes[n]=e}function Iu(t){let e,n=0,i=0;do e=as(t),n<32&&(i|=(127&e)<<n),n+=7;while(128&e);return i}function En(t,e){for(e>>>=0;e>=128;)sL(t,127&e|128),e>>>=7;sL(t,e)}function oq(t,e){let n,i=0,r=0,s=0;return n=as(t),i=127&n,128&n&&(n=as(t),i|=(127&n)<<7,128&n&&(n=as(t),i|=(127&n)<<14,128&n&&(n=as(t),i|=(127&n)<<21,128&n&&(n=as(t),r=127&n,128&n&&(n=as(t),r|=(127&n)<<7,128&n&&(n=as(t),r|=(127&n)<<14,128&n&&(n=as(t),r|=(127&n)<<21,128&n&&(n=as(t),s=127&n,128&n&&(n=as(t),s|=(127&n)<<7))))))))),{low:i|r<<28,high:r>>>4|s<<24,unsigned:e}}function Ea(t,e){let n=e.low>>>0,i=(e.low>>>28|e.high<<4)>>>0,r=e.high>>>24,s=r===0?i===0?n<16384?n<128?1:2:n<1<<21?3:4:i<16384?i<128?5:6:i<1<<21?7:8:r<128?9:10,o=H_(t,s),a=t.bytes;switch(s){case 10:a[o+9]=r>>>7&1;case 9:a[o+8]=s!==9?128|r:127&r;case 8:a[o+7]=s!==8?i>>>21|128:i>>>21&127;case 7:a[o+6]=s!==7?i>>>14|128:i>>>14&127;case 6:a[o+5]=s!==6?i>>>7|128:i>>>7&127;case 5:a[o+4]=s!==5?128|i:127&i;case 4:a[o+3]=s!==4?n>>>21|128:n>>>21&127;case 3:a[o+2]=s!==3?n>>>14|128:n>>>14&127;case 2:a[o+1]=s!==2?n>>>7|128:n>>>7&127;case 1:a[o]=s!==1?128|n:127&n}}const oL={},aL={},K_=4294967296,aq=K_*K_,cL=aq/2;lL(0,!0);const dL=lL(0),cq=bu(0,-2147483648,!1),dq=bu(-1,2147483647,!1);function lL(t,e){let n,i,r;return e?(r=0<=(t>>>=0)&&t<256)&&(i=aL[t],i)?i:(n=bu(t,0,!0),r&&(aL[t]=n),n):(r=-128<=(t|=0)&&t<128)&&(i=oL[t],i)?i:(n=bu(t,t<0?-1:0,!1),r&&(oL[t]=n),n)}function bu(t,e,n){return{low:0|t,high:0|e,unsigned:!!n}}function uL(t,e){if(isNaN(t))return dL;{if(t<=-cL)return cq;if(t+1>=cL)return dq}return t<0?dL:bu(t%K_|0,t/K_|0,e)}function hL(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable}))),n.push.apply(n,i)}return n}class UT extends qe{get connectionState(){return this._connectionState}set connectionState(e){if(this._connectionState===e)return;const n=this._connectionState;this._connectionState=e,this.emit(Is.CONNECTION_STATE_CHANGE,e,n)}get quality(){return this._quality}set quality(e){this._quality=e>1?1:e<.1?.1:e,this._qualityTimer&&(window.clearTimeout(this._qualityTimer),this._qualityTimer=null),this._quality>=1||(this._qualityTimer=window.setTimeout((()=>{this.quality=this._quality/this._qualityRatio}),6e4))}constructor(e){var n;super(),R(this,"name","AgoraRTCImageModeration"),R(this,"_connectionState",Pr.CONNECTING),R(this,"_sequence",0),R(this,"_moderationStartTime",void 0),R(this,"_workerConnection",void 0),R(this,"_workerMessageLengthLimit",void 0),R(this,"_qualityRatio",void 0),R(this,"_connectInfo",void 0),R(this,"_cancelTokenSource",yi.CancelToken.source()),R(this,"_retryConfig",void 0),R(this,"_moderationInterval",void 0),R(this,"_moderationTimer",null),R(this,"_moderationMode",1),R(this,"_quality",1),R(this,"_qualityTimer",null),R(this,"_ticket",void 0),R(this,"_moderationIntervalMinimum",void 0),R(this,"_uploadFailedNum",0),R(this,"_uploadNum",0),R(this,"_uploadTimer",null),R(this,"_extraInfo",void 0),R(this,"_vendor",""),R(this,"_encoder",new TextEncoder),R(this,"_moderationId",void 0),R(this,"inspectImage",(()=>{if(this.connectionState!==Pr.CONNECTED)throw new B(A.OPERATION_ABORTED,"image moderation service connection status is ".concat(this.connectionState));this._moderationTimer&&(window.clearInterval(this._moderationTimer),this._moderationTimer=null),this._moderationTimer=window.setInterval((()=>{this.connectionState===Pr.CONNECTED?this.requestToInspectImage():m.debug("[".concat(this._moderationId,"] Moderation State is not connected , "),this.connectionState)}),this._moderationInterval<this._moderationIntervalMinimum?this._moderationIntervalMinimum:this._moderationInterval),this.requestToInspectImage()})),this._moderationId=Se(5,"image-moderation-"),this._workerMessageLengthLimit=I("IMAGE_MODERATION_WORKER_MESSAGE_LENGTH_LIMIT"),this._moderationIntervalMinimum=I("IMAGE_MODERATION_INTERVAL_MINIMUM"),this._moderationInterval=(n=e.interval)!==null&&n!==void 0?n:1e3,e.extraInfo&&(this._extraInfo=this._encoder.encode(e.extraInfo)),e.vendor&&(this._vendor=e.vendor),this._qualityRatio=I("IMAGE_MODERATION_QUALITY_RATIO"),this._moderationStartTime=Number(Date.now()),this._workerConnection=new pu("worker-"+this._moderationId,fn),this.on(Is.STATE_CHANGE,((i,r)=>{m.debug("[".concat(this._moderationId,"] Moderation operation :").concat(Vd[i]," ").concat(r||""))})),this.handleWorkerEvents()}async init(e,n){this.emit(Is.STATE_CHANGE,Vd.CONNECT_AP),this._connectInfo=e;const i=this._cancelTokenSource.token;return this._retryConfig=n,new st(((r,s)=>{this.on(Is.CONNECTION_STATE_CHANGE,((o,a)=>{o===Pr.CONNECTED&&r()})),this.requestAP(e,i,n).then((o=>{this.connectWorker(o)})).catch((o=>{s(o)}))}))}updateConfig(e){var n;this._moderationInterval=(n=e.interval)!==null&&n!==void 0?n:1e3,e.extraInfo&&(this._extraInfo=this._encoder.encode(e.extraInfo)),e.vendor&&(this._vendor=e.vendor),m.debug("[".concat(this._moderationId,"] updateConfig: ").concat(JSON.stringify(e))),this.connectionState===Pr.CONNECTED&&this.inspectImage()}async requestAP(e,n,i){const r=I("WEBCS_DOMAIN").map((c=>"https://".concat(c,"/api/v1"))),s=await(function(c,d,l,h){let{appId:p,areaCode:f,cname:v,sid:S,token:T,uid:b}=d;Wd++;const w="moderation_plugin",D={service_name:w,json_body:JSON.stringify({appId:p,areaCode:f,cname:v,command:"allocateEdge",requestId:Wd,seq:Wd,sid:S,appToken:T,ts:Date.now(),uid:b+""})};let k,U,P=c[0];return Rs((async()=>{k=Date.now();const x=await As(P,{data:D,cancelToken:l,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"},params:{action:"wrtc_gateway"}});if(U=Date.now()-k,x.code!==0){const Ot=new B(A.UNEXPECTED_RESPONSE,"moderation plugin ap error, code"+x.code,{retry:!0,responseTime:U});throw m.error(Ot.toString()),Ot}const q=JSON.parse(x.json_body);if(q.code!==200){const Ot=new B(A.UNEXPECTED_RESPONSE,"moderation plugin ap error, code: ".concat(q.code,", reason: ").concat(q.reason),{code:q.code,responseTime:U});throw m.error(Ot.toString()),Ot}if(!q.servers||!Array.isArray(q.servers)||q.servers.length===0){const Ot=new B(A.UNEXPECTED_RESPONSE,"moderation plugin ap empty server",{code:q.code,responseTime:U});throw m.error(Ot.toString()),Ot}if(!q.servers.some((Ot=>!!Ot.wss))){const Ot=new B(A.UNEXPECTED_RESPONSE,"moderation plugin ap empty port",{code:q.code,responseTime:U});throw m.error(Ot.toString()),Ot}const Q=I("IMAGE_MODERATION_WORKER_WSS");if(Q)return{addressList:[Q],workerToken:q.workerToken,vid:q.vid,responseTime:U};const dt=I("IMAGE_MODERATION_WORKER_HOST");return{addressList:q.servers.map((Ot=>{let{address:Wt,wss:Vt}=Ot;if(Wt&&Vt)return"wss://".concat(Wt.replace(/\./g,"-"),".").concat(dt,":").concat(Vt,"/moderation")})).filter((Ot=>!!Ot)),workerToken:q.workerToken,vid:q.vid,ticket:q.appTicket,responseTime:U}}),((x,q)=>(pt.apworkerEvent(S,{success:!0,sc:200,serviceName:w,responseDetail:JSON.stringify(x.addressList),firstSuccess:q===0,responseTime:U,serverIp:c[q%c.length]}),!1)),((x,q)=>(pt.apworkerEvent(S,{success:!1,sc:x.data&&x.data.code||200,serviceName:w,responseTime:U,serverIp:c[q%c.length]}),!!(x.code!==A.OPERATION_ABORTED&&x.code!==A.UNEXPECTED_RESPONSE||x.data&&x.data.retry)&&(P=c[(q+1)%c.length],!0))),h)})(r,e,n,i);this.emit(Is.STATE_CHANGE,Vd.AP_CONNECTED);const{addressList:o,ticket:a}=s;return this._ticket=a,o}async connectWorker(e){this.emit(Is.STATE_CHANGE,Vd.CONNECT_WORKER),await this._workerConnection.init(e,1e4)}handleWorkerEvents(){this._workerConnection.on(Bt.CONNECTED,(async()=>{this.emit(Is.STATE_CHANGE,Vd.WORKER_CONNECTED,this._workerConnection.url),this.connectionState=Pr.CONNECTED})),this._workerConnection.on(Bt.CLOSED,(()=>{this.connectionState=Pr.CLOSED})),this._workerConnection.on(Bt.FAILED,(()=>{this.connectionState=Pr.CLOSED})),this._workerConnection.on(Bt.RECONNECTING,(()=>{this.connectionState=this.connectionState===Pr.CONNECTED?Pr.RECONNECTING:Pr.CONNECTING})),this._workerConnection.on(Bt.ON_MESSAGE,(async e=>{if(e.data instanceof ArrayBuffer){const n=nq(new Uint8Array(e.data));I("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")&&m.debug("[".concat(this._moderationId,"] Response message for worker of image moderation "),JSON.stringify(n)),this._uploadNum++,n.code===void 0||n.code===0||(this._uploadFailedNum++,m.error("[".concat(this._moderationId,"] Error response from worke, code is ").concat(n.code,", msg is ").concat(n.msg)),this._uploadTimer||(this._uploadTimer=window.setTimeout((()=>{pt.reportApiInvoke(this._connectInfo.sid||null,{name:Ge.IMAGE_MODERATION_UPLOAD,options:[this._uploadFailedNum,this._uploadNum,n.code],tag:Ne.TRACER}).onError(new B(A.IMAGE_MODERATION_UPLOAD_FAILED,n.msg)),this._uploadTimer=null}),I("IMAGE_MODERATION_UPLOAD_REPORT_INTERVAL"))))}else m.error("[".concat(this._moderationId,"] Unexpected message type from worker"))})),this._workerConnection.on(Bt.WILL_RECONNECT,((e,n,i)=>{e==="recover"&&i(e),i("tryNext")})),this._workerConnection.on(Bt.REQUEST_NEW_URLS,((e,n)=>{this.requestAP(this._connectInfo,this._cancelTokenSource.token,this._retryConfig).then(e).catch(n)}))}static intToLong(e){return{low:e|=0,high:e>>31,unsigned:e>=0}}async requestToInspectImage(){const e=Ji(this,Is.CLIENT_LOCAL_VIDEO_TRACK),n={appId:this._connectInfo.appId,cname:this._connectInfo.cname,cid:this._connectInfo.cid,sid:this._connectInfo.sid,uid:this._connectInfo.uid,vid:this._connectInfo.vid};if(e){if(!e.isPlaying)return void(I("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")&&m.debug("Only the track being played can be inspected"));this._sequence++;const i=await this.generateRequestData(e,n);this._workerConnection.sendMessage(i,!0,!0)}else I("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")&&m.debug("Only the track being published can be inspected")}async generateRequestData(e,n){let{appId:i,cname:r,cid:s,vid:o,sid:a,uid:c}=n;const d=Date.now(),l=await e.getCurrentFrameImage("image/jpeg",this.quality),h=await U0(l,i,r),p=this._sequence+"-"+s+"-"+c+"-"+d+"-"+Se(12,""),f={appId:i,cid:s,cname:r,deviceId:"",elapse:UT.intToLong(Number(d-this._moderationStartTime)),fileSize:l.buffer.byteLength,height:l.height,width:l.width,jpg:h,networkType:6,osType:7,requestId:p,sdkVersion:"4.24.1",sequence:this._sequence,sid:a,timestamp:uL(d),uid:c,vid:o,service:this._moderationMode,ticket:this._ticket,callbackData:this._extraInfo,vendorConfigs:this._vendor};this._extraInfo===void 0&&delete f.callbackData;const v=eq(f);if(v.byteLength<this._workerMessageLengthLimit){if(I("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")){const S=(function(T){for(var b=1;b<arguments.length;b++){var w=arguments[b]!=null?arguments[b]:{};b%2?hL(Object(w),!0).forEach((function(D){R(T,D,w[D])})):Object.getOwnPropertyDescriptors?Object.defineProperties(T,Object.getOwnPropertyDescriptors(w)):hL(Object(w)).forEach((function(D){Object.defineProperty(T,D,Object.getOwnPropertyDescriptor(w,D))}))}return T})({},f);delete S.jpg,m.debug("[".concat(this._moderationId,"] Request message for worker of image moderation service: "),JSON.stringify(S))}return v}{const S=this.quality*this._qualityRatio;return this.quality=S,await this.generateRequestData(e,{appId:i,cname:r,cid:s,vid:o,sid:a,uid:c})}}close(){this._cancelTokenSource.cancel(),this._cancelTokenSource=yi.CancelToken.source(),this._workerConnection&&this._workerConnection.close(),this._moderationTimer&&window.clearInterval(this._moderationTimer),this._moderationTimer=null,this._uploadTimer&&window.clearTimeout(this._uploadTimer),this._uploadTimer=null,this.connectionState=Pr.CLOSED,this.emit(Is.STATE_CHANGE,Vd.CLOSED)}}function pL(t){if(Oe(t.interval,"interval",1e3,1/0),t&&t.extraInfo&&t.extraInfo.length>1024)throw new B(A.INVALID_PARAMS,"config.extraInfo length cannot exceed 1024 bytes");if(t&&t.vendor&&t.vendor.length>1024)throw new B(A.INVALID_PARAMS,"config.vendor length cannot exceed 1024 bytes")}const lq={name:"ImageModeration",create:function(t){let{config:e}=t;return pL(e),new UT(e)}};var _L,fL,mL,EL,gL,SL,TL,RL,vL,CL,yL,IL,bL,AL,wL,OL,NL,DL,PL,LL,kL,ML,UL,xL,VL,FL,BL,jL,GL,WL,HL,KL,YL,qL,zL,XL,JL,QL,ZL,$L,tk,ek,lt;function nk(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable}))),n.push.apply(n,i)}return n}function cs(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?nk(Object(n),!0).forEach((function(i){R(t,i,n[i])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):nk(Object(n)).forEach((function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i))}))}return t}Un.setLogger(m);let uq=(_L=At(),fL=At({argsMap:(t,e)=>{if(!Array.isArray(e)){if(!(e instanceof Nd))return[e];e=[e]}return e.map((n=>n?Object(n).toString():"null"))}}),mL=At({argsMap:(t,e)=>(e||(e=[]),Array.isArray(e)||e.trackMediaType!==Od.DATA?(Array.isArray(e)||(e=[e]),e.map((n=>n.getTrackId()))):[e.getChannelId()])}),EL=At({argsMap:(t,e,n,i)=>[typeof e=="object"?e.uid:e,n,i]}),gL=At({argsMap:(t,e,n)=>[e,n]}),SL=At({argsMap:(t,e)=>e.map((n=>{let{user:i,mediaType:r}=n;return[i?.uid,r]}))}),TL=At({argsMap:(t,e,n,i)=>[typeof e=="object"?e.uid:e,n,i]}),RL=At({argsMap:(t,e)=>e.map((n=>{let{user:i,mediaType:r}=n;return{uid:i?.uid,mediaType:r}}))}),vL=At(),CL=At(),yL=At(),IL=At(),bL=At(),AL=At(),wL=At(),OL=At(),NL=At(),DL=At(),PL=At(),LL=At(),kL=At(),ML=At(),UL=At(),xL=At(),VL=At({argsMap:(t,e)=>[e]}),FL=At(),BL=At(),jL=At(),GL=At(),WL=At(),HL=At(),KL=At(),YL=At(),qL=At({argsMap:(t,e)=>(Array.isArray(e)||(e=[e]),[JSON.stringify(e)])}),zL=At(),XL=At(),JL=At(),QL=At(),ZL=At(),$L=At(),tk=At({reportResult:!0}),ek=At(),lt=class extends qe{get connectionState(){return this._gateway.state}get remoteUsers(){return this._users}get localTracks(){return this._p2pChannel.getAllTracks(!0)}get uid(){return this._uid}get channelName(){return this._channelName}get localDataChannels(){return this._p2pChannel.getAllDataChannels()}get mode(){return this._config.mode}get role(){var t;return((t=this._config)===null||t===void 0?void 0:t.role)||"audience"}get codec(){return this._config.codec}get audioCodec(){return this._config.audioCodec||"opus"}get isStringUID(){return!!this._joinInfo&&!!this._joinInfo.stringUid}get __className__(){return"Client"}constructor(t,e){let n;if(super(),R(this,"store",void 0),R(this,"_uid",void 0),R(this,"_channelName",void 0),R(this,"_uintUid",void 0),R(this,"_users",[]),R(this,"_config",void 0),R(this,"_clientId",void 0),R(this,"_appId",void 0),R(this,"_sessionId",null),R(this,"_key",void 0),R(this,"_rtmConfig",{}),R(this,"_joinInfo",void 0),R(this,"_gateway",void 0),R(this,"_statsCollector",void 0),R(this,"_configDistribute",void 0),R(this,"_leaveMutex",void 0),R(this,"_publishMutex",void 0),R(this,"_renewTokenMutex",void 0),R(this,"_subscribeMutex",void 0),R(this,"_encryptionMode","none"),R(this,"_encryptionSecret",null),R(this,"_encryptionSalt",null),R(this,"_encryptDataStream",!1),R(this,"_encryptDataStreamKey",null),R(this,"_encryptDataStreamIv",null),R(this,"_proxyServer",void 0),R(this,"_turnServer",{servers:[],mode:"auto"}),R(this,"_cloudProxyServerMode","disabled"),R(this,"_isDualStreamEnabled",!1),R(this,"_defaultStreamFallbackType",void 0),R(this,"_lowStreamParameter",void 0),R(this,"_streamFallbackTypeCacheMap",new Map),R(this,"_remoteStreamTypeCacheMap",new Map),R(this,"_axiosCancelSource",yi.CancelToken.source()),R(this,"_audioVolumeIndicationInterval",void 0),R(this,"_networkQualityInterval",void 0),R(this,"_userOfflineTimeout",void 0),R(this,"_streamRemovedTimeout",void 0),R(this,"_rteDetailInterval",void 0),R(this,"_liveTranscodeStreamingClient",void 0),R(this,"_liveRawStreamingClient",void 0),R(this,"_channelMediaRelayClient",void 0),R(this,"_networkQualitySensitivity","normal"),R(this,"_p2pChannel",void 0),R(this,"_useLocalAccessPoint",!1),R(this,"_setLocalAPVersion",void 0),R(this,"_joinAndNotLeaveYet",!1),R(this,"_numberOfJoinCount",0),R(this,"_joinResponse",null),R(this,"_remoteDefaultVideoStreamType",void 0),R(this,"_inspect",void 0),R(this,"_moderation",void 0),R(this,"_license",void 0),R(this,"_pendingPublishedUsers",[]),R(this,"ntpAlignErrorCount",0),R(this,"remoteInboundOffset",0),R(this,"_peerConnectionState",void 0),R(this,"_pendingRtpCapabilityChange",void 0),R(this,"_fallbackServerInfo",void 0),R(this,"_dualStreamMode",void 0),R(this,"_handleLocalTrackEnable",((r,s,o)=>{this.publish(r,!1).then(s).catch(o)})),R(this,"_handleLocalTrackDisable",((r,s,o)=>{this.unpublish(r).then(s).catch(o)})),R(this,"_handleUserOnline",(r=>{if(I("BLOCK_LOCAL_CLIENT")&&uc(r.uid,this.channelName))return void m.debug("[".concat(r.uid,"] will be ignored in local"));this.isStringUID&&typeof r.uid!="string"&&m.error("[".concat(this._clientId,"] StringUID is Mixed with UintUID"));const s=this._users.find((o=>o.uid===r.uid));if(s)s._trust_in_room_=!0,s._is_pre_created&&(s._is_pre_created=!1,this.safeEmit(qt.USER_JOINED,s));else{const o=new _a(r.uid,r.uint_id||r.uid);this._users.push(o),m.debug("[".concat(this._clientId,"] user online"),r.uid),this.store.firstVideoFrameDecoded(o.uid,{userJoinNotify:Date.now()}),this.safeEmit(qt.USER_JOINED,o)}})),R(this,"_handleUserOffline",(r=>{if(I("BLOCK_LOCAL_CLIENT")&&uc(r.uid,this.channelName))return;const s=this._users.find((o=>o.uid===r.uid));s&&(this._handleRemoveStream(r),this._handleRemoveDataChannels(r),s._audio_pre_subscribed||s._video_pre_subscribed?s._is_pre_created=!0:Wp(this._users,s),this._remoteStreamTypeCacheMap.delete(s.uid),this._streamFallbackTypeCacheMap.delete(s.uid),m.debug("[".concat(this._clientId,"] user offline"),r.uid,"reason:",r.reason),this.safeEmit(qt.USER_LEAVED,s,r.reason))})),R(this,"_handleAddAudioOrVideoStream",((r,s,o,a,c,d,l,h)=>{if(I("BLOCK_LOCAL_CLIENT")&&uc(s,this.channelName))return;const p=this._users.find((S=>S.uid===s));if(!p)return void m.error("[".concat(this._clientId,"] can not find target user!(on_add_stream)"));m.debug("[".concat(this._clientId,"] stream added with uid ").concat(s,", type ").concat(r)),this.store.subscribe(p.uid,r,void 0,void 0,void 0,Date.now()),r==="video"&&this.store.firstVideoFrameDecoded(p.uid,{videoAddNotify:Date.now()});const f=r==="audio"?p.hasAudio:p.hasVideo;p._uintid||(p._uintid=d||s),r==="audio"?p._trust_audio_stream_added_state_=!0:p._trust_video_stream_added_state_=!0,r==="audio"?(p._audio_added_=!0,o!==void 0&&(p._audioSSRC=o),a!==void 0&&(p._cname=a),l&&(p._audioOrtc=l)):(p._video_added_=!0,o!==void 0&&(p._videoSSRC=o),a!==void 0&&(p._cname=a),h!==void 0&&(p._rtxSsrcId=h),l&&(p._videoOrtc=l)),(r==="audio"?p.hasAudio:p.hasVideo)&&!f&&(m.info("[".concat(this._clientId,"] remote user ").concat(p.uid," published ").concat(r)),this.safeEmit(qt.USER_PUBLISHED,p,r)),r==="video"?pt.onGatewayStream(this._sessionId,vn.ON_ADD_VIDEO_STREAM,We.ON_ADD_VIDEO_STREAM,{peer:d||s,ssrc:p._videoSSRC}):pt.onGatewayStream(this._sessionId,vn.ON_ADD_AUDIO_STREAM,We.ON_ADD_AUDIO_STREAM,{peer:d||s,ssrc:p._audioSSRC}),this._p2pChannel.remoteMediaSsrcChanged(p,r,o).then((S=>{if(S&&(m.debug("[".concat(this._clientId,"] resubscribe ").concat(r," for user ").concat(p.uid," after rejoin because SSRC id changed.")),this._p2pChannel instanceof Ec))return this._p2pChannel.unsubscribe(p,r,!0).then((()=>this._subscribe(p,r,!0).catch((T=>{m.error("[".concat(this._clientId,"] resubscribe error"),T.toString())}))))})),this._p2pChannel.hasPendingRemoteMedia(p,r)&&(m.debug("[".concat(this._clientId,"] resubscribe ").concat(r," for user ").concat(p.uid," after reconnect.")),this._subscribe(p,r,!0).catch((S=>{m.error("[".concat(this._clientId,"] resubscribe error"),S.toString())})));const v=this._getEncodingName(c);r==="video"&&(v==="unknown"?this.safeEmit(qt.AV1_DECODABLE_RESULT,!1):Mn()||si()||v?.toLocaleLowerCase()!==ic.av1||kY().then((S=>{I("FLS_ENABLE_AV1_DECODE_DETECT")&&this.safeEmit(qt.AV1_DECODABLE_RESULT,S),S||this._gateway.downgradeCodec(v)})))})),R(this,"_handleRemoveStream",(r=>{if(I("BLOCK_LOCAL_CLIENT")&&uc(r.uid,this.channelName))return;const s=this._users.find((a=>a.uid===r.uid));if(!s)return void m.warning("[".concat(this._clientId,"] can not find target user!(on_remove_stream)"));m.debug("[".concat(this._clientId,"] stream removed with uid ").concat(r.uid));let o=()=>{};s.hasAudio&&s.hasVideo?o=()=>{m.info("[".concat(this._clientId,"] remote user ").concat(s.uid," unpublished audio track")),this.safeEmit(qt.USER_UNPUBLISHED,s,"audio"),m.info("[".concat(this._clientId,"] remote user ").concat(s.uid," unpublished video track")),this.safeEmit(qt.USER_UNPUBLISHED,s,"video")}:s.hasVideo?o=()=>{m.info("[".concat(this._clientId,"] remote user ").concat(s.uid," unpublished video track")),this.safeEmit(qt.USER_UNPUBLISHED,s,"video")}:s.hasAudio&&(o=()=>{m.info("[".concat(this._clientId,"] remote user ").concat(s.uid," unpublished audio track")),this.safeEmit(qt.USER_UNPUBLISHED,s,"audio")}),s._video_pre_subscribed||s._audio_pre_subscribed||(s._trust_audio_stream_added_state_=!0,s._trust_video_stream_added_state_=!0,s._audio_added_=!1,s._video_added_=!1,this._p2pChannel instanceof Ec&&this._p2pChannel.unsubscribe(s).then((a=>{if(a)return this._gateway.unsubscribe(a,s.uid)})),s._audioSSRC=void 0,s._videoSSRC=void 0,s._audioOrtc=void 0,s._videoOrtc=void 0,s._rtxSsrcId=void 0),pt.onGatewayStream(this._sessionId,vn.ON_REMOVE_STREAM,We.ON_REMOVE_STREAM,{peer:r.uint_id||r.uid}),o()})),R(this,"_handleSetStreamLocalEnable",((r,s,o)=>{if(I("BLOCK_LOCAL_CLIENT")&&uc(s,this.channelName))return;const a=this._users.find((l=>l.uid===s));if(!a)return void m.error("[".concat(this._clientId,"] can not find target user!(disable_local)"));m.debug("[".concat(this._clientId,"] local ").concat(r," ").concat(o?"enabled":"disabled"," with uid ").concat(s));const c=r==="audio"?a.hasAudio:a.hasVideo;if(r==="audio"){a._trust_audio_enabled_state_=!0;const l=a._audio_enabled_;if(a._audio_enabled_=o,a._audio_enabled_===l)return;{const h=a._audio_enabled_?"enable-local-audio":"disable-local-audio";m.debug("[".concat(this._clientId,"] user-info-updated, uid: ").concat(s,", msg: ").concat(h)),this.safeEmit(qt.USER_INFO_UPDATED,s,h)}}else{a._trust_video_enabled_state_=!0;const l=a._video_enabled_;if(a._video_enabled_=o,a._video_enabled_===l)return;{const h=a._video_enabled_?"enable-local-video":"disable-local-video";m.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(s,", msg: ").concat(h)),this.safeEmit(qt.USER_INFO_UPDATED,s,h)}}const d=r==="audio"?a.hasAudio:a.hasVideo;return c!==d?!c&&d?(m.info("[".concat(this._clientId,"] remote user ").concat(s," published ").concat(r)),void this.safeEmit(qt.USER_PUBLISHED,a,r)):(r==="video"&&a._videoTrack&&a._videoTrack._destroy(),r==="audio"&&a._audioTrack,this._p2pChannel.muteRemote(a,r),m.info("[".concat(this._clientId,"] remote user ").concat(s," unpublished ").concat(r)),void this.safeEmit(qt.USER_UNPUBLISHED,a,r)):void 0})),R(this,"_handleMuteStream",((r,s,o)=>{if(I("BLOCK_LOCAL_CLIENT")&&uc(r,this.channelName))return;m.debug("[".concat(this._clientId,"] receive mute message"),r,s,o);const a=this._users.find((l=>l.uid===r));if(!a)return void m.warning("[".concat(this._clientId,"] can not find remote user, ignore mute event, uid: ").concat(r));const c=s==="audio"?a.hasAudio:a.hasVideo;if(s==="audio"){a._trust_audio_mute_state_=!0;const l=a._audio_muted_;if(a._audio_muted_=o,a._audio_muted_===l)return;{const h=a._audio_muted_?"mute-audio":"unmute-audio";m.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(r,", msg: ").concat(h)),this.safeEmit(qt.USER_INFO_UPDATED,r,h)}}else{a._trust_video_mute_state_=!0;const l=a._video_muted_;if(a._video_muted_=o,a._video_muted_===l)return;{const h=a._video_muted_?"mute-video":"unmute-video";m.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(r,", msg: ").concat(h)),this.safeEmit(qt.USER_INFO_UPDATED,r,h)}}const d=s==="audio"?a.hasAudio:a.hasVideo;if(c!==d){if(!c&&d)return(s==="audio"?a._audioSSRC:a._videoSSRC)?(m.info("[".concat(this._clientId,"] remote user ").concat(r," published ").concat(s)),void this.safeEmit(qt.USER_PUBLISHED,a,s)):void m.warning("[".concat(this._clientId,"] remote user ").concat(r," receive ").concat(s," unmute message  before add stream message, ").concat(s," SSRC doesn't exist yet."));s==="video"&&a._videoTrack&&!a._video_pre_subscribed&&a._videoTrack._destroy(),s==="audio"&&a._audioTrack,this._p2pChannel.muteRemote(a,s),m.info("[".concat(this._clientId,"] remote user ").concat(r," unpublished ").concat(s)),this.safeEmit(qt.USER_UNPUBLISHED,a,s)}})),R(this,"_handleP2PLost",(async r=>{m.debug("[".concat(this._clientId,"] receive p2p lost"),r),parseInt(r.p2pid,10)===this.store.p2pId?await this._p2pChannel.requestReconnect():m.warning("[".concat(this._clientId,"] P2PLost stream not found"),r)})),R(this,"_handleTokenWillExpire",(()=>{m.debug("[".concat(this._clientId,"] received message onTokenPrivilegeWillExpire")),this.safeEmit(qt.ON_TOKEN_PRIVILEGE_WILL_EXPIRE)})),R(this,"_handleBeforeUnload",(r=>{r.type==="beforeunload"&&r.returnValue!==void 0&&r.returnValue!==""||(this.leave(),m.info("[".concat(this._clientId,"] auto leave onbeforeunload or pagehide")))})),R(this,"_handleUpdateNetworkQuality",(()=>{if(this._networkQualitySensitivity==="normal")return;if(navigator&&navigator.onLine!==void 0&&!navigator.onLine)return void this.safeEmit(qt.NETWORK_QUALITY,{downlinkNetworkQuality:6,uplinkNetworkQuality:6});const r={downlinkNetworkQuality:0,uplinkNetworkQuality:0};r.uplinkNetworkQuality=this._p2pChannel.getUplinkNetworkQuality(),r.downlinkNetworkQuality=this._p2pChannel.getDownlinkNetworkQuality(),this.safeEmit(qt.NETWORK_QUALITY,r)})),R(this,"_handleP2PAddAudioOrVideoStream",((r,s,o,a)=>{const c=this._users.find((l=>l.uid===s));if(!c)return void m.error("[".concat(this._clientId,"] can not find target user!(on_add_stream)"));m.debug("[".concat(this._clientId,"] stream added with uid ").concat(s,", type ").concat(r)),this.store.subscribe(c.uid,r,void 0,void 0,void 0,Date.now());const d=r==="audio"?c.hasAudio:c.hasVideo;r==="audio"?c._trust_audio_stream_added_state_=!0:c._trust_video_stream_added_state_=!0,r==="audio"?(c._audio_added_=!0,o!==void 0&&(c._audioSSRC=o),a!==void 0&&(c._audioMid=a)):(c._video_added_=!0,o!==void 0&&(c._videoSSRC=o),a!==void 0&&(c._videoMid=a)),(r==="audio"?c.hasAudio:c.hasVideo)&&!d&&(m.info("[".concat(this._clientId,"] remote user ").concat(c.uid," published ").concat(r)),this.safeEmit(qt.USER_PUBLISHED,c,r)),this._p2pChannel.hasPendingRemoteMedia(c,r)&&(m.debug("[".concat(this._clientId,"] resubscribe ").concat(r," for user ").concat(c.uid," after reconnect.")),this._subscribe(c,r,!0).catch((l=>{m.error("[".concat(this._clientId,"] resubscribe error"),l.toString())})))})),this._config=t,this._clientId=e||Se(5,"client-"),this.store=new class{constructor(r,s,o,a,c){Ut(this,"state",void 0),this.state={codec:r,audioCodec:s,mode:o,clientId:a,sessionId:null,p2pId:0,dcId:0,pubId:0,subId:0,keyMetrics:{publish:[],subscribe:[],firstVideoFrameDecoded:[]},joinChannelServiceRecords:[],cloudProxyServerMode:"disabled",useP2P:!1,p2pTransport:nc.Default,hasStartJoinChannel:!1,isABTestSuccess:!1,rteUrl:void 0,rteSid:void 0,autoSubscribe:!1,enableInstantMuteRestore:!1,networkQualityProbe:!1,useDcSignal:!!c}}dispatch(r){this.state=(function(s,o){switch(o.type){case Pt.SET_SESSION_ID:return nt(nt({},s),{},{sessionId:o.sessionId});case Pt.SET_P2P_ID:return nt(nt({},s),{},{p2pId:o.p2pId});case Pt.SET_UID:return nt(nt({},s),{},{uid:o.uid});case Pt.SET_INT_UID:return nt(nt({},s),{},{intUid:o.intUid});case Pt.SET_PUB_ID:return nt(nt({},s),{},{pubId:o.pubId});case Pt.KEY_METRIC_CLIENT_CREATED:return nt(nt({},s),{},{keyMetrics:nt(nt({},s.keyMetrics),{},{clientCreated:o.metric})});case Pt.KEY_METRIC_JOIN_START:return nt(nt({},s),{},{keyMetrics:nt(nt({},s.keyMetrics),{},{joinStart:o.metric})});case Pt.KEY_METRIC_PRELOAD_START:return nt(nt({},s),{},{keyMetrics:nt(nt({},s.keyMetrics),{},{preloadStart:o.metric})});case Pt.KEY_METRIC_PRELOAD_END:return nt(nt({},s),{},{keyMetrics:nt(nt({},s.keyMetrics),{},{preloadEnd:o.metric})});case Pt.KEY_METRIC_JOIN_END:return nt(nt({},s),{},{keyMetrics:nt(nt({},s.keyMetrics),{},{joinEnd:o.metric})});case Pt.KEY_METRIC_REQUEST_AP_START:return nt(nt({},s),{},{keyMetrics:nt(nt({},s.keyMetrics),{},{requestAPStart:o.metric})});case Pt.KEY_METRIC_REQUEST_AP_END:return nt(nt({},s),{},{keyMetrics:nt(nt({},s.keyMetrics),{},{requestAPEnd:o.metric})});case Pt.KEY_METRIC_REQUEST_SUA_END:return nt(nt({},s),{},{keyMetrics:nt(nt({},s.keyMetrics),{},{requestSUAEnd:o.metric})});case Pt.KEY_METRIC_BEFORE_CONNECT:return nt(nt({},s),{},{keyMetrics:nt(nt({},s.keyMetrics),{},{beforeConnect:o.metric})});case Pt.KEY_METRIC_PEER_RECEIVER:return nt(nt({},s),{},{keyMetrics:nt(nt({},s.keyMetrics),{},{peerReceiver:o.metric})});case Pt.KEY_METRIC_SIGNAL_CONNECTED:return nt(nt({},s),{},{keyMetrics:nt(nt({},s.keyMetrics),{},{signalConnected:o.metric})});case Pt.KEY_METRIC_JOIN_REQ:return nt(nt({},s),{},{keyMetrics:nt(nt({},s.keyMetrics),{},{joinReq:o.metric})});case Pt.KEY_METRIC_JOIN_REP:return nt(nt({},s),{},{keyMetrics:nt(nt({},s.keyMetrics),{},{joinRep:o.metric})});case Pt.KEY_METRIC_JOIN_GATEWAY_START:return nt(nt({},s),{},{keyMetrics:nt(nt({},s.keyMetrics),{},{joinGatewayStart:o.metric})});case Pt.KEY_METRIC_JOIN_GATEWAY_END:return nt(nt({},s),{},{keyMetrics:nt(nt({},s.keyMetrics),{},{joinGatewayEnd:o.metric})});case Pt.KEY_METRIC_PEER_CONNECTION_START:return nt(nt({},s),{},{keyMetrics:nt(nt({},s.keyMetrics),{},{peerConnectionStart:o.metric})});case Pt.KEY_METRIC_PEER_CONNECTION_END:return nt(nt({},s),{},{keyMetrics:nt(nt({},s.keyMetrics),{},{peerConnectionEnd:o.metric})});case Pt.KEY_METRIC_DESCRIPTION_START:return nt(nt({},s),{},{keyMetrics:nt(nt({},s.keyMetrics),{},{descriptionStart:o.metric})});case Pt.KEY_METRIC_SIGNAL_CHANNEL_OPEN:return nt(nt({},s),{},{keyMetrics:nt(nt({},s.keyMetrics),{},{signalChannelOpen:o.metric})});case Pt.KEY_METRIC_ICE_CONNECTION_END:return nt(nt({},s),{},{keyMetrics:nt(nt({},s.keyMetrics),{},{iceConnectionEnd:o.metric})});case Pt.KEY_METRIC_PUBLISH:{const a=s.keyMetrics.publish,c=a.findIndex((d=>d.trackId===o.metric.trackId));return c!==-1?(a[c]=nt(nt({},a[c]),o.metric),nt(nt({},s),{},{keyMetrics:nt(nt({},s.keyMetrics),{},{publish:[...a]})})):nt(nt({},s),{},{keyMetrics:nt(nt({},s.keyMetrics),{},{publish:[...s.keyMetrics.publish,o.metric]})})}case Pt.KEY_METRIC_SUBSCRIBE:{const a=s.keyMetrics.subscribe,c=a.findIndex((d=>d.userId===o.metric.userId&&d.type===o.metric.type));return c!==-1?(a[c]=nt(nt({},a[c]),o.metric),nt(nt({},s),{},{keyMetrics:nt(nt({},s.keyMetrics),{},{subscribe:[...a]})})):nt(nt({},s),{},{keyMetrics:nt(nt({},s.keyMetrics),{},{subscribe:[...s.keyMetrics.subscribe,o.metric]})})}case Pt.KEY_METRIC_FIRST_VIDEO_FRAME_DECODED:{const a=s.keyMetrics.firstVideoFrameDecoded,c=a.findIndex((d=>d.userId===o.metric.userId));return c!==-1?(a[c]=nt(nt({},a[c]),o.metric),nt(nt({},s),{},{keyMetrics:nt(nt({},s.keyMetrics),{},{firstVideoFrameDecoded:[...a]})})):nt(nt({},s),{},{keyMetrics:nt(nt({},s.keyMetrics),{},{firstVideoFrameDecoded:[...s.keyMetrics.firstVideoFrameDecoded,o.metric]})})}case Pt.RESET_FIRST_VIDEO_FRAME_DECODED:return s.keyMetrics.firstVideoFrameDecoded=[],s;case Pt.SET_CLOUD_PROXY_SERVER_MODE:return s.cloudProxyServerMode=o.mode,s;case Pt.RECORD_JOIN_CHANNEL_SERVICE:return typeof o.index!="number"?s.joinChannelServiceRecords=[...s.joinChannelServiceRecords,o.record]:(s.joinChannelServiceRecords[o.index]=nt(nt({},s.joinChannelServiceRecords[o.index]),o.record),s.joinChannelServiceRecords=[...s.joinChannelServiceRecords]),s;case Pt.RESET_JOIN_CHANNEL_SERVICE_RECORDS:return s.joinChannelServiceRecords=[],s;case Pt.RESET_KEY_METRICS:return s.keyMetrics={publish:[],subscribe:[],firstVideoFrameDecoded:[]},s;case Pt.SET_USE_P2P:return nt(nt({},s),{},{useP2P:o.val});case Pt.SET_TRANSPORT_TYPE:return nt(nt({},s),{},{p2pTransport:o.val});case Pt.SET_RTE_URL:return nt(nt({},s),{},{rteUrl:o.rteUrl});case Pt.SET_RTE_SID:return nt(nt({},s),{},{rteSid:o.rteSid});default:return s}})(this.state,r)}get useDcSignal(){return this.state.useDcSignal}set useDcSignal(r){this.state.useDcSignal=r}set autoSubscribe(r){this.state.autoSubscribe=r}get autoSubscribe(){return this.state.autoSubscribe}set enableInstantMuteRestore(r){this.state.enableInstantMuteRestore=r}get enableInstantMuteRestore(){return this.state.enableInstantMuteRestore}set networkQualityProbe(r){this.state.networkQualityProbe=r}get networkQualityProbe(){return this.state.networkQualityProbe}set sessionId(r){this.dispatch({type:Pt.SET_SESSION_ID,sessionId:r})}get sessionId(){return this.state.sessionId}set rteUrl(r){this.dispatch({type:Pt.SET_RTE_URL,rteUrl:r})}get rteUrl(){return this.state.rteUrl}set rteSid(r){this.dispatch({type:Pt.SET_RTE_SID,rteSid:r})}get rteSid(){return this.state.rteSid}set cid(r){this.state.cid=r}get cid(){return this.state.cid}set codec(r){this.state.codec=r}get codec(){return this.state.codec}get mode(){return this.state.mode}get audioCodec(){return this.state.audioCodec}get clientId(){return this.state.clientId}set p2pId(r){this.dispatch({type:Pt.SET_P2P_ID,p2pId:r})}get p2pId(){return this.state.p2pId}set dcId(r){this.dispatch({type:Pt.SET_DC_ID,dcId:r})}get dcId(){return this.state.dcId}set uid(r){this.dispatch({type:Pt.SET_UID,uid:r})}get uid(){return this.state.uid}set intUid(r){this.dispatch({type:Pt.SET_INT_UID,intUid:r})}get intUid(){return this.state.intUid}set pubId(r){this.dispatch({type:Pt.SET_PUB_ID,pubId:r})}get pubId(){return this.state.pubId}set cloudProxyServerMode(r){this.dispatch({type:Pt.SET_CLOUD_PROXY_SERVER_MODE,mode:r})}get cloudProxyServerMode(){return this.state.cloudProxyServerMode}set useP2P(r){this.dispatch({type:Pt.SET_USE_P2P,val:r})}get useP2P(){return this.state.useP2P}set p2pTransport(r){this.dispatch({type:Pt.SET_TRANSPORT_TYPE,val:r})}get p2pTransport(){return this.state.p2pTransport}set hasStartJoinChannel(r){this.state.hasStartJoinChannel=r}get hasStartJoinChannel(){return this.state.hasStartJoinChannel}set isABTestSuccess(r){this.state.isABTestSuccess=r}get isABTestSuccess(){return this.state.isABTestSuccess}clientCreated(){this.dispatch({type:Pt.KEY_METRIC_CLIENT_CREATED,metric:Date.now()})}joinStart(){this.dispatch({type:Pt.KEY_METRIC_JOIN_START,metric:Date.now()})}preloadStart(){this.dispatch({type:Pt.KEY_METRIC_PRELOAD_START,metric:Date.now()})}preloadEnd(){this.dispatch({type:Pt.KEY_METRIC_PRELOAD_END,metric:Date.now()})}joinEnd(){this.dispatch({type:Pt.KEY_METRIC_JOIN_END,metric:Date.now()})}requestAPStart(){this.dispatch({type:Pt.KEY_METRIC_REQUEST_AP_START,metric:Date.now()})}requestAPEnd(){this.dispatch({type:Pt.KEY_METRIC_REQUEST_AP_END,metric:Date.now()})}requestSUAEnd(){this.dispatch({type:Pt.KEY_METRIC_REQUEST_SUA_END,metric:Date.now()})}beforeConnect(){this.dispatch({type:Pt.KEY_METRIC_BEFORE_CONNECT,metric:Date.now()})}peerReceiver(){this.dispatch({type:Pt.KEY_METRIC_PEER_RECEIVER,metric:Date.now()})}signalConnected(){this.dispatch({type:Pt.KEY_METRIC_SIGNAL_CONNECTED,metric:Date.now()})}joinReq(){this.dispatch({type:Pt.KEY_METRIC_JOIN_REQ,metric:Date.now()})}joinRep(){this.dispatch({type:Pt.KEY_METRIC_JOIN_REP,metric:Date.now()})}joinGatewayStart(){this.dispatch({type:Pt.KEY_METRIC_JOIN_GATEWAY_START,metric:Date.now()})}joinGatewayEnd(){this.dispatch({type:Pt.KEY_METRIC_JOIN_GATEWAY_END,metric:Date.now()})}peerConnectionStart(){this.dispatch({type:Pt.KEY_METRIC_PEER_CONNECTION_START,metric:Date.now()})}peerConnectionEnd(){this.dispatch({type:Pt.KEY_METRIC_PEER_CONNECTION_END,metric:Date.now()})}firstVideoFrameDecoded(r,s){this.dispatch({type:Pt.KEY_METRIC_FIRST_VIDEO_FRAME_DECODED,metric:nt({userId:r},s)})}descriptionStart(){this.dispatch({type:Pt.KEY_METRIC_DESCRIPTION_START,metric:Date.now()})}signalChannelOpen(){this.dispatch({type:Pt.KEY_METRIC_SIGNAL_CHANNEL_OPEN,metric:Date.now()})}iceConnectionEnd(){this.dispatch({type:Pt.KEY_METRIC_ICE_CONNECTION_END,metric:Date.now()})}publish(r,s,o,a){this.dispatch({type:Pt.KEY_METRIC_PUBLISH,metric:nt(nt({trackId:r,type:s},o&&{publishStart:o}),a&&{publishEnd:a})})}subscribe(r,s,o,a,c,d,l){this.dispatch({type:Pt.KEY_METRIC_SUBSCRIBE,metric:nt(nt(nt(nt(nt({userId:r,type:s},o&&{subscribeStart:o}),a&&{subscribeEnd:a}),c&&{firstFrame:c}),d&&{streamAdded:d}),l&&{firstDecoded:l})})}massSubscribe(r,s,o,a){r.forEach((c=>{this.dispatch({type:Pt.KEY_METRIC_SUBSCRIBE,metric:nt(nt(nt({userId:c.userId,type:c.type},s&&{subscribeStart:s}),o&&{subscribeEnd:o}),a&&{firstFrame:a})})}))}get keyMetrics(){return this.state.keyMetrics}recordJoinChannelService(r,s){r.service==="gateway"&&Array.isArray(r.urls)&&(r.urls=r.urls.map((o=>o.replace(/(\d+)-\d+-\d+-(\d+)/,"$1-*-*-$2"))));try{return typeof s!="number"?(this.dispatch({type:Pt.RECORD_JOIN_CHANNEL_SERVICE,record:nt(nt({},r),{},{sessionId:this.sessionId,cloudProxyMode:this.cloudProxyServerMode,uid:this.uid})}),this.state.joinChannelServiceRecords.length-1):(s<0||s>=this.state.joinChannelServiceRecords.length||this.dispatch({type:Pt.RECORD_JOIN_CHANNEL_SERVICE,record:r,index:s}),s)}catch{return 0}}resetJoinChannelServiceRecords(){this.dispatch({type:Pt.RESET_JOIN_CHANNEL_SERVICE_RECORDS})}resetKeyMetrics(){this.dispatch({type:Pt.RESET_KEY_METRICS})}resetFirstVideoFrameDecoded(){this.dispatch({type:Pt.RESET_FIRST_VIDEO_FRAME_DECODED})}get joinChannelServiceRecords(){try{return this.state.joinChannelServiceRecords}catch{return[]}}}(t.codec,t.audioCodec,t.mode,this._clientId,I("SIGNAL_CHANNEL")===1),this._leaveMutex=new Un("client-leave",this._clientId),this._publishMutex=new Un("client-publish",this._clientId),this._renewTokenMutex=new Un("client-renewtoken",this._clientId),this._subscribeMutex=new Un("client-subscribe",this._clientId),this.store.clientCreated(),t.proxyServer&&this.setProxyServer(t.proxyServer,!0),t.turnServer&&this.setTurnServer(t.turnServer,!0),m.info("[".concat(this._clientId,"] Initializing AgoraRTC client v").concat(Ar," build: ").concat(uS,", mode: ").concat(this.mode,", codec: ").concat(this.codec)),t.clientRoleOptions)try{Jg(t.clientRoleOptions),n=Object.assign({},t.clientRoleOptions)}catch(r){m.warning("[".concat(this._clientId,"] ").concat(r.toString()))}var i;this._statsCollector=new vu(this.store),this._statsCollector.onStatsException=(r,s,o)=>{m.warn("[".concat(this._clientId,"] receive exception msg, code: ").concat(r,", msg: ").concat(s,", uid: ").concat(o)),r===fT.VIDEO_ENCODE_FAILED&&this.localTracks.forEach((a=>{a instanceof o_&&I("ENABLE_ENCODE_EXCEPTION")&&a.findClosestProfile()})),this.safeEmit(qt.EXCEPTION,{code:r,msg:s,uid:o})},this._statsCollector.onUploadPublishDuration=(r,s,o,a)=>{const c=this._users.find((d=>d.uid===r));c&&(this.store.keyMetrics&&(this.store.firstVideoFrameDecoded(c.uid,{peerPublishDuration:o,peerPubStatusMs:Date.now()}),this._p2pChannel.reportVideoFirstFrameRender(c)),pt.peerPublishStatus(this._sessionId,{subscribeElapse:a,audioPublishDuration:s,videoPublishDuration:o,peer:c._uintid}))},this._statsCollector.onVideoCodecChanged=r=>{if(I("VIDEO_STANDARD_BITRATE_VERSION")&&(r==="av1"||r==="h265"||r==="h264")){const s=this.localTracks.find((o=>o instanceof De));s&&s._saveEncodeBitrateRatio!==1&&s.setSaveEncodeBitrateRatio(r==="h264"?I("BASELINE_MORE_H264_BITRATE_RATIO"):void 0)}},this.store.useP2P=t.mode==="p2p",this._gateway=new wY(this.store,{clientId:this._clientId,mode:this.mode,codec:this.codec,websocketRetryConfig:t.websocketRetryConfig||fn,httpRetryConfig:t.httpRetryConfig||fn,forceWaitGatewayResponse:t.forceWaitGatewayResponse===void 0||t.forceWaitGatewayResponse,statsCollector:this._statsCollector,role:t.role,clientRoleOptions:n}),this._configDistribute=new FY(this._clientId,this.store),this.store.useP2P?(this._p2pChannel=(i={store:this.store,statsCollector:this._statsCollector},bs("P2PChannel").create(i)),this._handleP2PEvents()):this._p2pChannel=new Ec(this.store,this._statsCollector),this._handleP2PChannelEvents(),this._handleGatewayEvents(),this._handleGatewaySignalEvents()}async joinMeta(t,e,n,i,r){let s=!(arguments.length>5&&arguments[5]!==void 0)||arguments[5],o=arguments.length>6&&arguments[6]!==void 0&&arguments[6];ye("JOIN_GATEWAY_USE_443PORT_ONLY",s),ye("JOIN_GATEWAY_USE_DUAL_DOMAIN",o);const a=this._gateway.signal.websocket;return a instanceof JS&&(a.use443PortOnly=s,a.tryDoubleDomain=o),(async function(c,d,l){Fp.get(c)||Fp.set(c,[]),Bp.get(c)||Bp.set(c,d),zs.get(c)||zs.set(c,0);const h=Fp.get(c),p=Bp.get(c);if(!h||!p)throw new Error("concurrent: deferQueue or maxConcurrency is null");if(zs.get(c)===p){const b=tu();h.push(b),await b.promise}zs.set(c,zs.get(c)+1);for(var f=arguments.length,v=new Array(f>3?f-3:0),S=3;S<f;S++)v[S-3]=arguments[S];const T=await l(...v);return zs.set(c,zs.get(c)-1),zs.get(c)===p-1&&h.length>0&&(h[0].resolve(),h.shift()),zs.get(c)===0&&(Fp.set(c,[]),Bp.set(c,0),zs.set(c,0)),T})("client.join",I("JOIN_MAX_CONCURRENCY"),this.join.bind(this),t,e,n,i,r)}async join(t,e,n,i,r){const s=++this._numberOfJoinCount;this.store.joinStart(),i&&(this.store.uid=i);const o=(Yp||Yp||(Yp=(window.location.protocol.split(":")[0]||"").toUpperCase(),Yp))==="HTTPS",a=qO()?window.isSecureContext:"Browser Not Support";(!qO()&&!o||!window.isSecureContext)&&m.warning("The website must be running in a secure context (About secure context: https://developer.mozilla.org/en-US/docs/Web/Security/Secure_Contexts ), otherwise the media collection will be restricted by the browser");let c;pt.setAppId(t);try{if(!n&&n!==null)throw new B(A.INVALID_PARAMS,"Invalid token: ".concat(n,". If you don not use token, set it to null"));if(n&&Kn(n,"token",1,2047),Kn(t,"appid",1,2047),E_(e),i&&g_(i),r)if(typeof r=="string")Kn(r,"optionalInfo",1,256),c=r;else{if(typeof r!="object")throw new B(A.INVALID_PARAMS,"Invalid options: options is not a string or object");{const{autoSubscribe:T,enableInstantMuteRestore:b,networkQualityProbe:w}=r;T&&(Zr(T,"autoSubscribe"),m.info("[".concat(this._clientId,"] join: autoSubscribe: ").concat(T)),this.store.autoSubscribe=T),b&&(Zr(b,"enableInstantMuteRestore"),m.info("[".concat(this._clientId,"] join: enableInstantMuteRestore: ").concat(b)),this.store.enableInstantMuteRestore=b),w&&(Zr(w,"networkQualityProbe"),m.info("[".concat(this._clientId,"] join: networkQualityProbe: ").concat(w)),this.store.networkQualityProbe=w)}}}catch(T){throw pt.reportApiInvoke(ec(),{name:Ge.JOIN,options:[t,e,n,i],states:{isHttps:o,isSecureContext:a},tag:Ne.TRACER}).onError(T),T}if(this._leaveMutex.isLocked&&(m.debug("[".concat(this._clientId,"] join: waiting leave operation")),(await this._leaveMutex.lock())(),m.debug("[".concat(this._clientId,"] join: continue"))),this._joinAndNotLeaveYet=!0,this.connectionState!=="DISCONNECTED"){const T=new B(A.INVALID_OPERATION,"[".concat(this._clientId,"] Client already in connecting/connected state"));throw pt.reportApiInvoke(ec(),{name:Ge.JOIN,options:[t,e,n,i],states:{isHttps:o,isSecureContext:a},tag:Ne.TRACER}).onError(T),T}this._gateway.state="CONNECTING",this.store.preloadStart();const d=await PT({appId:t,cname:e,uid:i,stringUid:typeof i=="string"?i:void 0,token:n||t,cloudProxyServer:this._cloudProxyServerMode});if(this.store.preloadEnd(),!this._joinAndNotLeaveYet)throw new B(A.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"));const l=d?.sid||ec();m.info("[".concat(this._clientId,"] start join channel ").concat(e,", join number: ").concat(s)),this._sessionId||(this._sessionId=l,this.store.sessionId=this._sessionId);const h=pt.reportApiInvoke(this._sessionId,{id:this._clientId,name:Ge.JOIN,options:[t,e,n,i],states:{isHttps:o,isSecureContext:a},tag:Ne.TRACER}),p=cs(cs(cs({},this._rtmConfig),{},{role:this.role,clientId:this._clientId,appId:t,sid:this._sessionId,cname:e,uid:typeof i!="string"?i:null,turnServer:this._turnServer,proxyServer:this._proxyServer,token:n||t,cloudProxyServer:this._cloudProxyServerMode,optionalInfo:c,license:this._license,useLocalAccessPoint:this._useLocalAccessPoint,preload:!!d},this._remoteDefaultVideoStreamType!==void 0&&{defaultVideoStream:this._remoteDefaultVideoStreamType}),{},{apRequestDetail:I("AP_REQUEST_DETAIL")||void 0});if(this._useLocalAccessPoint&&(p.setLocalAPVersion=this._setLocalAPVersion),typeof i=="string"&&(p.stringUid=i,this._uintUid?(p.uid=this._uintUid,this._uintUid=void 0):p.uid=0),this._encryptionMode!=="none"&&this._encryptionSecret){if(p.aesmode=this._encryptionMode,p.aespassword=await(async T=>{const b=(function(U){const P=window.atob(`MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDCMnXAHkKIGAM+x4N22gCI+Wyu
STM9ztkT3uYslTT2PuKmZfPzhH6kVdO7PTjGCOZnAsyb3oTtWat0KcxQ4jxvqQV+
HvYl3iI1Yd4vl2c3qRMJPLtRDfNxa2Mcxgq7e9aEUibzdd0st+OJAy3tOj/Y0aVy
xQiYDz3vqa6bP29adwIDAQAB`),x=new Uint8Array(new ArrayBuffer(P.length));for(let q=0;q<P.length;q+=1)x[q]=P.charCodeAt(q);return x})(),w=await window.crypto.subtle.importKey("spki",b,{name:"RSA-OAEP",hash:"SHA-256"},!0,["encrypt"]),D=zg(T),k=await window.crypto.subtle.encrypt({name:"RSA-OAEP"},w,D);return(function(U){let P="";for(let x=0;x<U.length;x+=1)P+=String.fromCharCode(U[x]);return window.btoa(P)})(new Uint8Array(k))})(this._encryptionSecret),!this._joinAndNotLeaveYet)throw new B(A.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"));this._encryptionSalt&&(p.aessalt=this._encryptionSalt)}if(this._encryptDataStream&&(this._encryptionMode==="aes-128-gcm2"||this._encryptionMode==="aes-256-gcm2"))if(this._encryptionSalt&&this._encryptionSecret)if(window.crypto.subtle){const T=new TextEncoder,b=I("USE_PURE_ENCRYPTION_MASTER_KEY")?T.encode(p.appId+this._encryptionSecret+this._encryptionSecret):T.encode(p.appId+p.cname+this._encryptionSecret);this._encryptDataStreamIv=await(async function(w,D,k){const U=await window.crypto.subtle.importKey("raw",D,"PBKDF2",!1,["deriveBits","deriveKey"]),P=w==="aes-128-gcm2"?128:256,x=await window.crypto.subtle.deriveBits({name:"PBKDF2",iterations:i0,hash:"SHA-256",salt:k},U,P+o8);return new Uint8Array(x).subarray(P/8)})(this._encryptionMode,b,tc(this._encryptionSalt)),this._encryptDataStreamKey=await(async function(w,D,k){const U=await window.crypto.subtle.importKey("raw",D,"PBKDF2",!1,["deriveBits","deriveKey"]),P=w==="aes-128-gcm2"?128:256;return await window.crypto.subtle.deriveKey({name:"PBKDF2",iterations:i0,hash:"SHA-256",salt:k},U,{name:"AES-GCM",length:P},!0,["encrypt","decrypt"])})(this._encryptionMode,b,tc(this._encryptionSalt))}else a?m.warning("[".concat(this._clientId,"] encrypt datastream must be running in a secure context, fallback to plain data stream")):m.warning("[".concat(this._clientId,"] current browser do not support WebCrypto ,fallback to plain data stream")),this._encryptDataStream=!1;else this._encryptDataStream=!1,m.debug("[".concat(this._clientId,"] no salt / secret, cannot support encrypt data stream, fallback to plain data stream"));this._startSession(this._sessionId,{channel:e,appId:t,stringUid:p.stringUid});const f=this._sessionId;setTimeout((()=>{this.connectionState==="CONNECTING"&&f===this._sessionId&&pt.joinChannelTimeout(this._sessionId,5)}),5e3);try{var v;let T;const b=p.cloudProxyServer;if($(v=["proxy3","proxy4","proxy5"]).call(v,b)){const P=I("PROXY_SERVER_TYPE3");Array.isArray(P)?p.proxyServer=P[0]:p.proxyServer=P}if(pt.setProxyServer(p.proxyServer),m.setProxyServer(p.proxyServer),this.store.requestAPStart(),d){if(m.debug("[".concat(this._clientId,"] get serverInfo Success from Preload Cache ").concat(p.stringUid?", ".concat(p.stringUid," => ").concat(d.intUid):""," ")),p.stringUid&&!p.uid&&(p.uid=d.intUid),T={gatewayInfo:d.ap.gatewayInfo},I("JOIN_WITH_FALLBACK_MEDIA_PROXY")&&p.turnServer.mode==="auto")if(d.ap.proxyInfo.addresses.length===0)m.warning("no edge services in ap response of proxy fallback, will not set proxy in iceServers");else{const P=(await KD(d.ap.proxyInfo,d.ap.gatewayInfo.uid)).map((x=>({turnServerURL:x.address,tcpport:x.tcpport||Jn.tcpport,udpport:x.udpport||Jn.udpport,username:x.username||Jn.username,password:x.password||Jn.password,forceturn:!1,security:!0})));p.turnServer={mode:"manual",servers:P}}$P(d,p.stringUid)}else{if(p.stringUid&&!p.uid){let P;[P,T]=await st.all([SP(p.stringUid,p,this._axiosCancelSource.token,this._config.httpRetryConfig||fn,this.store).finally((()=>{this.store.requestSUAEnd()})),gP(p,this._axiosCancelSource.token,this._config.httpRetryConfig||fn,!0,this.store).finally((()=>{this.store.requestAPEnd()}))]),m.debug("[".concat(this._clientId,"] getUserAccount Success ").concat(p.stringUid," => ").concat(P)),p.uid=P,T.gatewayInfo.uid=P,T.gatewayInfo.res.uid=P}else T=await gP(p,this._axiosCancelSource.token,this._config.httpRetryConfig||fn,!0,this.store);if(!this._joinAndNotLeaveYet)throw new B(A.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"))}this.store.requestAPEnd(),setTimeout((()=>{this._configDistribute.startGetConfigDistribute(p,this._axiosCancelSource.token),this._configDistribute.on(ys.UPDATE_BITRATE_LIMIT,(P=>{this._p2pChannel.updateBitrateLimit(P)})),this._configDistribute.on(ys.UPDATE_CLIENT_ROLE_OPTIONS,(P=>{this._setClientRoleOptions(P)})),this._configDistribute.on(ys.UPDATE_REMOTE_VIDEO_STREAM_TYPE,(P=>{var x;$(x=[0,1,4,5,6,7,8,9]).call(x,P)&&(this.remoteUsers.forEach((q=>{this._remoteStreamTypeCacheMap.get(q.uid)!==P&&this.setRemoteVideoStreamType(q.uid,P)})),this.setRemoteDefaultVideoStreamType(P))})),this._configDistribute.on(ys.FALLBACK_TO_HLS,(P=>{P&&this.safeEmit(qt.FALLBACK_TO_HLS,Qg.CONFIG)})),this._configDistribute.on(ys.UPDATE_VOS_CONFIGURE,(P=>{this._gateway.setConfigure(P).catch((x=>{m.debug("[".concat(this._clientId,"] auto set vos config failed"),x)}))}))}),0),this._key=n||t;const w=T.gatewayInfo,D=p.uid?p.uid:w.uid;this._joinInfo=cs(cs({},p),{},{cid:w.cid,uid:D,vid:w.vid,apResponse:w.res,apGatewayAddress:w.apGatewayAddress,uni_lbs_ip:w.uni_lbs_ip,gatewayAddrs:w.gatewayAddrs}),this.store.intUid=D,this.store.cid=w.cid;const k=await this._joinGateway();if(!this._joinAndNotLeaveYet)throw new B(A.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"));h.onSuccess(k),this._appId=t,this._channelName=p.cname,this._uid=k,this.store.uid=k,setTimeout((()=>{this._networkQualityInterval&&window.clearInterval(this._networkQualityInterval),this._networkQualityInterval=window.setInterval(this._handleUpdateNetworkQuality,2e3),!Mn()&&this.store.useDcSignal?(window.addEventListener("beforeunload",this._handleBeforeUnload),window.addEventListener("pagehide",this._handleBeforeUnload)):window.addEventListener(Mn()?"beforeunload":"pagehide",this._handleBeforeUnload),this._statsCollector.startUpdateStats()}),0);const U=p.stringUid?"string uid: ".concat(p.stringUid,",uid: ").concat(p.uid):"uid: ".concat(this._uid);return m.info("[".concat(this._clientId,"] Joining channel success: channel: ").concat(e,",").concat(U)),setTimeout((()=>{m.startUpload()}),5e3),this.store.joinEnd(),S=this,$(lc).call(lc,S)||lc.push(S),this._cloudProxyServerMode==="disabled"&&Jt().supportWebCrypto&&I("ENABLE_PRELOAD")&&kT(this._joinInfo),this._rteDetailInterval&&(window.clearInterval(this._rteDetailInterval),this._rteDetailInterval=void 0),this._sessionId&&pt.reportRteDetail(this._sessionId),this._rteDetailInterval=window.setInterval((()=>{this._sessionId&&pt.reportRteDetail(this._sessionId)}),I("RTE_DETAIL_REPORT_INTERVAL")||6e4),k}catch(T){const b=Array.isArray(T)?T[0]:T;throw b&&b.code===A.OPERATION_ABORTED?m.warning("[".concat(this._clientId,"] join number: ").concat(s,", Joining channel failed, rollback"),b):m.error("[".concat(this._clientId,"] join number: ").concat(s,", Joining channel failed, rollback"),b),b.code!==A.OPERATION_ABORTED&&this._numberOfJoinCount===s&&(this._gateway.state="DISCONNECTED",this._reset()),h.onError(b),b}var S}async _joinGateway(){if(!this._joinInfo||!this._key)throw new B(A.INVALID_OPERATION);try{return await this._gateway.join(this._joinInfo,this._key,!(this._joinInfo.cloudProxyServer!=="disabled"||this._joinInfo.proxyServer||!I("JOIN_WITH_FALLBACK_SIGNAL_PROXY")))}catch(t){if(t.code===A.INIT_DATACHANNEL_TIMEOUT){if(this._gateway.leave(!0,te.FALLBACK),m.debug("[".concat(this._clientId,"] join by datachannel timeout, fallback to websocket")),!this._joinInfo||!this._key)throw new B(A.INVALID_OPERATION);return pt.reportApiInvoke(this._sessionId,{name:Ge.DATACHANNEL_FAILBACK,options:[this.store.clientId],tag:Ne.TRACER}).onSuccess(),await this._joinGateway()}throw t}}async leave(){m.info("[".concat(this._clientId,"] Leaving channel"));const t=()=>{!Mn()&&this.store.useDcSignal?(window.addEventListener("beforeunload",this._handleBeforeUnload),window.addEventListener("pagehide",this._handleBeforeUnload)):window.addEventListener(Mn()?"beforeunload":"pagehide",this._handleBeforeUnload),this._reset(),(function(n){const i=lc.indexOf(n);i!==-1&&lc.splice(i,1)})(this),this._statsCollector.stopUpdateStats()};this.store.useDcSignal||t();const e=await this._leaveMutex.lock();if(this.connectionState==="DISCONNECTED")return m.info("[".concat(this._clientId,"] Leaving channel repeated, success")),void e();await this._gateway.leave(this.connectionState!=="CONNECTED",te.LEAVE),m.info("[".concat(this._clientId,"] Leaving channel success")),this._joinAndNotLeaveYet=!1,this.store.resetJoinChannelServiceRecords(),e(),this.store.useDcSignal&&t()}async publish(t){let e=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];if(!Array.isArray(t)){if(!(t instanceof Nd))return this._publishDataChannel(t);t=[t]}if(t.length===0)throw new B(A.INVALID_PARAMS,"param list is empty");const n=t;if(this._gateway.role==="audience")throw new B(A.INVALID_OPERATION,"audience can not publish stream");for(const r of n){if(!(r instanceof Nd))throw new B(A.INVALID_PARAMS,"parameter is not local track");if(!r._enabled&&e)throw new B(A.TRACK_IS_DISABLED,"can not publish a disabled track: ".concat(r.getTrackId()))}m.info("[".concat(this._clientId,"] Publishing tracks, id ").concat(n.map((r=>"".concat(r.getTrackId()," ")))));const i=await this._publishMutex.lock();await this._configDistribute.awaitConfigDistributeComplete(),e&&n.forEach((r=>{const s=this._configDistribute.getBitrateLimit();r instanceof De&&s&&r.setBitrateLimit(s.uplink)}));try{await this._publishHighStream(n),m.info("[".concat(this._clientId,"] Publish success, id ").concat(n.map((r=>"".concat(r.getTrackId()," ")))))}catch(r){throw m.error("[".concat(this._clientId,"] publish error"),r.toString()),r}finally{i()}}async _publishDataChannel(t){if(t==null)throw new B(A.INVALID_PARAMS,"parameter is not local track or datachannel config, config is ".concat(JSON.stringify(t)));Oe(t.id,"id",0,65535,!0),Zr(t.ordered,"ordered"),Kn(t.metadata,"metadata",0,512),m.info("[".concat(this._clientId,"] Publishing datachannels, id ").concat(t.id));const e=await this._publishMutex.lock();try{if(this._p2pChannel.getAllDataChannels().findIndex((r=>r.id===t.id))!==-1)throw new B(A.INVALID_PARAMS,"Invalid id: ".concat(t.id,". If you want to republish the datachannel, unpublish first"));if(!this._joinInfo||this._uid===void 0)throw new B(A.INVALID_OPERATION,"Can't publish datachannel, haven't joined yet!");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new B(A.INVALID_OPERATION,"can not publish datachannel in ".concat(this.connectionState," state"));if(this._turnServer.mode==="auto"&&I("FORCE_TURN")&&!I("TURN_ENABLE_TCP")&&!I("TURN_ENABLE_UDP"))throw new B(A.UNEXPECTED_ERROR,"force TURN With No TURN Configuration");const n=(function(r){return dP(r,!1)})(t),i=await this._p2pChannel.publishDataChannel([n]);if(i.length>0){if(typeof n._originDataChannelId!="number")throw m.error("[".concat(this._clientId,"] can not publish with mediaType datachannel, cannot get RTCDatachannel id")),new B(A.CREATE_DATACHANNEL_ERROR);try{await st.all(i.map((r=>this._uid&&this._gateway.publishDataChannel(this._uid,r,!0)))),await n._waitTillOpen()}catch(r){if(r.code!==A.DISCONNECT_P2P)throw r}}return m.info("[".concat(this._clientId,"] Publish dataChannels success, id ").concat(n.id)),n}catch(n){throw m.error("[".concat(this._clientId,"] publish datachannels error"),n.toString()),n}finally{e()}}async unpublish(t){if(!this._joinInfo||this._uid===void 0)throw new B(A.INVALID_OPERATION,"Can't unpublish stream, haven't joined yet!");let e=[];if(t)if(Array.isArray(t))e=t;else{if(!(t instanceof Nd))return this._unpublishDataChannel([t]);e=[t]}else this.store.useP2P||await this._unpublishDataChannel(),e=this._p2pChannel.getAllTracks(!0);m.info("[".concat(this._clientId,"] Unpublish tracks, tracks ").concat(e.map((i=>"".concat(i.getTrackId()," ")))," "));const n=await this._publishMutex.lock();try{if(this.store.useP2P){const i=await this._p2pChannel.unpublish(e);i&&await this._gateway.sendExtensionMessage(cn.UNPUBLISH,{unpubMsg:i},!0)}else{const i=await this._p2pChannel.unpublish(e);i&&await this._gateway.unpublish(i,this._uid),m.info("[".concat(this._clientId,"] Unpublish success,tracks ").concat(e.map((r=>"".concat(r.getTrackId())))))}}catch(i){throw m.error("[".concat(this._clientId,"] unpublish error"),i.toString()),i}finally{n&&n()}}async _unpublishDataChannel(t){t!==void 0&&t.length!==0||(t=this._p2pChannel.getAllDataChannels()),m.info("[".concat(this._clientId,"] Unpublish datachannels, datachannels ").concat(t.map((n=>"".concat(n.id," ")))," "));const e=await this._publishMutex.lock();try{const n=await this._p2pChannel.unpublishDataChannel(t);n&&await this._gateway.unpublishDataChannel(n),m.info("[".concat(this._clientId,"] Unpublish dataChannel success,dataChannel ").concat(t.map((i=>"".concat(i.id)))))}catch(n){throw m.error("[".concat(this._clientId,"] unpublish dataChannel error"),n.toString()),n}finally{e&&e()}}async subscribe(t,e,n){if(!(t instanceof _a)){const i=this.remoteUsers.find((r=>r.uid===t));if(!i)throw new B(A.INVALID_REMOTE_USER,"user is not in the channel");t=i}return e==="datachannel"?this._subscribeDataChannel(t,n):this._subscribe(t,e)}async presubscribe(t,e){if(_n(e,"mediaType",["audio","video"]),this.store.useP2P)throw new B(A.INVALID_OPERATION,"can't presub at p2p mode");if(!this._joinInfo)throw new B(A.INVALID_OPERATION,"can't presub when not join");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new B(A.INVALID_OPERATION,"can't presub in ".concat(this.connectionState," state"));const n=e===ut.AUDIO,i=e===ut.VIDEO,r=await this._subscribeMutex.lock();try{const{ssrcId:s,ortc:o,rtxSsrcId:a,cname:c,uint_id:d}=await this._gateway.presubscribe(t,e,!0);if(s==null)throw new B(A.UNEXPECTED_RESPONSE,"no ssrc id");let l=this._users.find((p=>p.uid===t));l||(l=new _a(t,d||t),l._is_pre_created=!0,this._users.push(l)),c&&(l._cname=c),l._uintid||(l._uintid=d||t),n&&(l._audioSSRC=s,l._audio_pre_subscribed=!0,o&&(l._audioOrtc=o)),i&&(l._videoSSRC=s,l._video_pre_subscribed=!0,o&&(l._videoOrtc=o),a!=null&&(l._rtxSsrcId=a)),m.info("[".concat(this._clientId,"] presub succeed ssrc: ").concat(s)),await this._p2pChannel.subscribe(l,e,s,a,o);const h=n?l._audioTrack:l._videoTrack;if(!h)throw new B(A.UNEXPECTED_ERROR,"can not find remote track in user");return n&&(l._trust_audio_stream_added_state_=!0,l._audio_added_=!0),i&&(l._trust_video_stream_added_state_=!0,l._video_added_=!0),h}catch(s){throw m.error("[".concat(this._clientId,"] presub user ").concat(t," error"),s),s}finally{r()}}async _subscribeDataChannel(t,e){var n;if(Oe(e,"channelId",0,65535,!0),!this._joinInfo)throw new B(A.INVALID_OPERATION,"Can't subscribe datachannel, not joined");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new B(A.INVALID_OPERATION,"Can't subscribe datachannel in ".concat(this.connectionState," state"));if(!this._users.find((a=>a===t)))throw m.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid,", this user is not in the channel")),new B(A.INVALID_REMOTE_USER,"user is not in the channel");if(!t.hasAudio&&!t.hasVideo&&t._dataChannels.length===0)throw m.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid,", user is not published")),new B(A.INVALID_REMOTE_USER,"user is not published");const r=(n=t._dataChannels)===null||n===void 0?void 0:n.find((a=>a.id===e));if(!r)throw m.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid," with mediaType datachannel, remote datachannel is not published")),new B(A.REMOTE_USER_IS_NOT_PUBLISHED);const s=await this._subscribeMutex.lock();m.info("[".concat(this._clientId,"] subscribe user ").concat(t.uid,", mediaType: datachannel"));try{const a=await this._p2pChannel.subscribeDataChannel(t,[r]);if(a&&$(a).call(a,r.id))try{var o;if(typeof r._originDataChannelId!="number")throw m.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid," with mediaType datachannel, cannot get RTCDatachannel")),new B(A.CREATE_DATACHANNEL_ERROR);const c={id:r.id,datachannelId:r._originDataChannelId,ordered:r.ordered,maxRetransmits:r.maxRetransmits,metadata:(o=r.metadata)!==null&&o!==void 0?o:""};await this._gateway.subscribeDataChannel(t.uid,c,!0),await r._waitTillOpen()}catch(c){if(c?.code!==A.WS_ABORT)throw await this._p2pChannel.unsubscribeDataChannel(t,[r]),c;await this._p2pChannel.unsubscribeDataChannel(t,[r]),this._p2pChannel.setPendingRemoteDataChannel(t,r.id)}return m.info("[".concat(this._clientId,"] subscribe success user ").concat(t.uid,", mediaType: datachannel")),r}finally{s()}}async _p2pSubscribe(t,e,n){if(_n(e,"mediaType",["audio","video"]),!this._joinInfo)throw new B(A.INVALID_OPERATION,"Can't subscribe stream, not joined");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new B(A.INVALID_OPERATION,"Can't subscribe stream in ".concat(this.connectionState," state"));if(!this._users.find((s=>s===t))){const s=new B(A.INVALID_REMOTE_USER,"user is not in the channel");throw m.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid,", this user is not in the channel")),s}if(!t.hasAudio&&!t.hasVideo){const s=new B(A.INVALID_REMOTE_USER,"user is not published");throw m.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid,", user is not published")),s}if(!n&&(e==="audio"&&!t.hasAudio||e==="video"&&!t.hasVideo)){const s=new B(A.REMOTE_USER_IS_NOT_PUBLISHED);throw m.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid," with mediaType ").concat(e,", remote track is not published")),s}const r=await this._subscribeMutex.lock();m.info("[".concat(this._clientId,"] subscribe user ").concat(t.uid,", mediaType: ").concat(e));try{if(await this._p2pChannel.hasRemoteMediaWithLock(t,e))await this._p2pChannel.unmuteRemote(t,e);else try{const o=e==="audio"?t._audioSSRC:t._videoSSRC,a=e==="audio"?t._audioMid:t._videoMid;this.store.subscribe(t.uid,e,Date.now()),this.store.useP2P&&await this._p2pChannel.subscribe(t,e,o,a)}catch(o){throw o}m.info("[".concat(this._clientId,"] subscribe success user ").concat(t.uid,", mediaType: ").concat(e)),this._defaultStreamFallbackType!==void 0&&this.setStreamFallbackOption(t.uid,this._defaultStreamFallbackType).catch((o=>{m.warning("[".concat(this._clientId,"] auto set fallback failed"),o)}));const s=e==="audio"?t._audioTrack:t._videoTrack;if(!s)throw new B(A.UNEXPECTED_ERROR,"can not find remote track in user object");return s}catch(s){throw m.error("[".concat(this._clientId,"] subscribe user ").concat(t.uid," error"),s),s}finally{r()}}async _subscribe(t,e,n){if(this.store.useP2P)return this._p2pSubscribe(t,e);if(_n(e,"mediaType",["audio","video"]),!this._joinInfo)throw new B(A.INVALID_OPERATION,"Can't subscribe stream, not joined");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new B(A.INVALID_OPERATION,"Can't subscribe stream in ".concat(this.connectionState," state"));if(!this._users.find((d=>d===t))){const d=new B(A.INVALID_REMOTE_USER,"user is not in the channel");throw m.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid,", this user is not in the channel")),d}if(!t.hasAudio&&!t.hasVideo){const d=new B(A.INVALID_REMOTE_USER,"user is not published");throw m.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid,", user is not published")),d}if(!(n||(e!=="audio"||t.hasAudio&&t._audioSSRC!==void 0)&&(e!=="video"||t.hasVideo&&t._videoSSRC!==void 0))){const d=new B(A.REMOTE_USER_IS_NOT_PUBLISHED);throw m.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid," with mediaType ").concat(e,", remote track is not published")),d}let r=e==="audio"?t._audioSSRC:t._videoSSRC,s=e==="audio"?t._audioOrtc:t._videoOrtc,o=e==="video"?t._rtxSsrcId:void 0,a={stream_type:e==="audio"?ut.AUDIO:ut.VIDEO,ssrcId:r};e==="video"&&this.store.firstVideoFrameDecoded(t.uid,{subscribeStart:Date.now()});const c=await this._subscribeMutex.lock();m.info("[".concat(this._clientId,"] subscribe user ").concat(t.uid,", mediaType: ").concat(e));try{if(await this._p2pChannel.hasRemoteMediaWithLock(t,e))await this._p2pChannel.unmuteRemote(t,e);else try{const l=e==="audio"?t._audioSSRC:t._videoSSRC;l!==void 0&&l!==r&&(r=l,s=e==="audio"?t._audioOrtc:t._videoOrtc,o=e==="video"?t._rtxSsrcId:void 0,a={stream_type:e==="audio"?ut.AUDIO:ut.VIDEO,ssrcId:r}),ni.markSubscribeStart(this.store.clientId,r),this.store.subscribe(t.uid,e,Date.now()),await this._p2pChannel.subscribe(t,e,r,o,s);try{this._p2pChannel.isPreSubScribe(r)||await this._gateway.subscribe(t.uid,a,!0)}catch(h){if(h?.code!==A.WS_ABORT)throw await this._p2pChannel.unsubscribe(t,e),h;await this._p2pChannel.unsubscribe(t,e,!0),this._p2pChannel.setPendingRemoteMedia(t,e)}this.store.subscribe(t.uid,e,void 0,Date.now()),this._p2pChannel.reportSubscribeEvent(!0,null,t,e)}catch(l){throw this._p2pChannel.reportSubscribeEvent(!1,l?.code,t,e),l}m.info("[".concat(this._clientId,"] subscribe success user ").concat(t.uid,", mediaType: ").concat(e)),this._defaultStreamFallbackType!==void 0&&this.setStreamFallbackOption(t.uid,this._defaultStreamFallbackType).catch((l=>{m.warning("[".concat(this._clientId,"] auto set fallback failed"),l)}));const d=e==="audio"?t._audioTrack:t._videoTrack;if(!d)throw new B(A.UNEXPECTED_ERROR,"can not find remote track in user object");return e==="video"&&(this.store.firstVideoFrameDecoded(t.uid,{subscribeEnd:Date.now()}),this._p2pChannel.reportVideoFirstFrameRender(t)),d}catch(d){throw m.error("[".concat(this._clientId,"] subscribe user ").concat(t.uid," error"),d),d}finally{c()}}async massSubscribe(t){if(wo(t,"subscribeList"),!this._joinInfo)throw new B(A.INVALID_OPERATION,"Can't subscribe stream, not joined");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new B(A.INVALID_OPERATION,"Can't subscribe stream in ".concat(this.connectionState," state"));const e=Date.now(),n=new Map,i=await this._subscribeMutex.lock();m.info("[".concat(this._clientId,"]start massSubscribe user ").concat(t.map((a=>{let{user:c,mediaType:d}=a;return"user: ".concat(c?.uid,", mediaType: ").concat(d)})).join("; ")));const r=(t=[...t]).map((a=>{let{user:c,mediaType:d}=a;return{user:c,mediaType:d}})),s=await this._p2pChannel.globalLock();try{var o;for(let c=t.length-1;c>=0;c--){const d=t[c],{user:l,mediaType:h}=d;if(_n(h,"mediaType",["audio","video"]),!l){const S=new B(A.INVALID_PARAMS,"user property does not exist in subscribeList item");throw m.error("[".concat(this._clientId,"] user property does not exist in subscribeList item")),S}if(!this._users.find((S=>S===l))){const S=new B(A.INVALID_REMOTE_USER,"user is not in the channel");m.error("[".concat(this._clientId,"] can not massSubscribe ").concat(l.uid,", this user is not in the channel")),r[c].error=S,t.splice(c,1);continue}if(h==="audio"&&(!l.hasAudio||l._audioSSRC===void 0)||h==="video"&&(!l.hasVideo||l._videoSSRC===void 0)){const S=new B(A.REMOTE_USER_IS_NOT_PUBLISHED);m.error("[".concat(this._clientId,"] can not subscribe ").concat(l.uid," with mediaType ").concat(h,", remote user is not published")),r[c].error=S,t.splice(c,1);continue}const f=Pn.Video|Pn.LwoVideo,v=n.get(l);if(v){if(h==="video"?v&f:v&Pn.Audio){t.splice(c,1),m.warning("[".concat(this._clientId,"] repeat massSubscribe user:").concat(l.uid,", mediaType:").concat(h," twice"));continue}n.set(l,v|(h==="video"?f:Pn.Audio))}else n.set(l,h==="video"?f:Pn.Audio)}for(let c=t.length-1;c>=0;c--){const d=t[c],{user:l,mediaType:h}=d,p=Pn.Video|Pn.LwoVideo;if(this._p2pChannel.hasRemoteMedia(l,h)){await this._p2pChannel.unmuteRemoteNoLock(l,h);const f=n.get(l);n.set(l,h==="video"?f^p:f^Pn.Audio),t.splice(c,1)}}this.store.massSubscribe(t.map((c=>({userId:c.user.uid,type:c.mediaType}))),e);let a=Ir(o=Array.from(n.entries())).call(o,((c,d)=>{let[l,h]=d;if(h===0)return c;const p={stream_id:l.uid,stream_type:h};return h&Pn.Audio&&(p.audio_ssrc=l._audioSSRC),h&Pn.Video&&(p.video_ssrc=l._videoSSRC),c.push(p),c}),[]);try{t.length>0&&await this._p2pChannel.massSubscribeNoLock(t.map((d=>{let{user:l,mediaType:h}=d;return{user:l,mediaType:h,ssrcId:h===ut.VIDEO?l._videoSSRC:l._audioSSRC,rtxSsrcId:h===ut.VIDEO?l._rtxSsrcId:void 0}})));const c=new Map;if(a=a.filter((d=>d.video_ssrc&&!this._p2pChannel.isPreSubScribe(d.video_ssrc)||d.audio_ssrc&&!this._p2pChannel.isPreSubScribe(d.audio_ssrc)||!d.video_ssrc&&!d.audio_ssrc)),a.length>0){const d=await this._gateway.subscribeAll(a,!0);(d?.users||[]).forEach((l=>{let{stream_id:h,video_error_code:p,audio_error_code:f,error_code:v}=l;(p||f||v)&&c.set(h,{video_error_code:p,audio_error_code:f,error_code:v})}))}if(Array.from(c.entries()).length>0){const d=[];Array.from(c.entries()).forEach((l=>{let[h,p]=l;const f=this.remoteUsers.find((v=>v.uid===h));if(f){let v;p.error_code||p.video_error_code&&p.audio_error_code?v=void 0:p.video_error_code?v=ut.VIDEO:p.audio_error_code&&(v=ut.AUDIO),d.push({user:f,mediaType:v})}})),d.length>0&&await this._p2pChannel.massUnsubscribeNoLock(d)}for(const d of r){const l=c.get(d.user.uid);if(l){const h=l.error_code||d.mediaType==="audio"&&l.audio_error_code||d.mediaType==="video"&&l.video_error_code;if(h){const p=pc(h);m.error("user:".concat(d.user.uid," mediaType:").concat(d.mediaType," has massSubscribe error ").concat(p.desc)),d.error=new B(A.SUBSCRIBE_FAILED,"code ".concat(h,": ").concat(p.desc))}}d.error||(d.mediaType==="video"?d.track=d.user.videoTrack:d.track=d.user.audioTrack)}return this.store.massSubscribe(r.filter((d=>!d.error)).map((d=>({userId:d.user.uid,type:d.mediaType}))),void 0,Date.now()),r.forEach((d=>{var l;pt.subscribe(this.store.sessionId,{succ:!!d.error,ec:((l=d.error)===null||l===void 0?void 0:l.code)||null,video:d.mediaType===ut.VIDEO,audio:d.mediaType===ut.AUDIO,peerid:d.user.uid,subscribeRequestid:d.mediaType===ut.VIDEO?d.user._videoSSRC:d.user._audioSSRC,p2pid:this.store.p2pId,eventElapse:Math.floor(performance.now()-e),preSsrc:this._p2pChannel.isPreSubScribe(d.user._videoSSRC)},!0)})),m.info("[".concat(this._clientId,"] massSubscribe success ").concat(t.map((d=>{let{user:l,mediaType:h}=d;return"user: ".concat(l?.uid,", mediaType: ").concat(h)})).join("; "))),r}catch(c){throw await this._p2pChannel.massUnsubscribeNoLock(t),c}}finally{s(),i()}}async unsubscribe(t,e,n){if(!(t instanceof _a)){const s=this.remoteUsers.find((o=>o.uid===t));if(!s)throw new B(A.INVALID_REMOTE_USER,"user is not in the channel");t=s}if(e||this.store.useP2P){if(e==="datachannel")return this._unsubscribeDataChannel(t,n)}else await this._unsubscribeDataChannel(t,n);if(e&&_n(e,"mediaType",["audio","video"]),!this._joinInfo)throw new B(A.INVALID_OPERATION,"Can't unsubscribe stream, haven't joined yet!");if(!this._users.find((s=>s===t))){const s=new B(A.INVALID_REMOTE_USER,"user is not in the channel");throw m.error("[".concat(this._clientId,"] can not unsubscribe ").concat(t.uid,", user is not in the channel")),s}m.info("[".concat(this._clientId,"] unsubscribe uid: ").concat(t.uid,", mediaType: ").concat(e));const r=await this._subscribeMutex.lock();try{if(this.store.useP2P)await this._p2pChannel.unsubscribe(t,e);else{const s=await this._p2pChannel.unsubscribe(t,e);s&&await this._gateway.unsubscribe(s,t.uid),e&&e!=="audio"||(t._audio_pre_subscribed=!1),e&&e!=="video"||(t._video_pre_subscribed=!1),t._is_pre_created&&Wp(this._users,t),m.info("[".concat(this._clientId,"] unsubscribe success uid: ").concat(t.uid,", mediaType: ").concat(e))}}catch(s){if(s.code===A.DISCONNECT_P2P)return void m.warning("disconnecting p2p, abort unsubscribe request.");throw m.error("[".concat(this._clientId,"] unsubscribe user ").concat(t.uid," error"),s.toString()),s}finally{r()}}async _unsubscribeDataChannel(t,e){if(e&&Oe(e,"id",0,65535,!0),!this._joinInfo)throw new B(A.INVALID_OPERATION,"Can't unsubscribe datachannel, haven't joined yet!");if(!this._users.find((r=>r===t))){const r=new B(A.INVALID_REMOTE_USER,"user is not in the channel");throw m.error("[".concat(this._clientId,"] can not unsubscribe ").concat(t.uid,", user is not in the channel")),r}let i;if(typeof e=="number"){const r=t._dataChannels.find((s=>s.id===e));r&&(i=[r])}else i=t._dataChannels;if(i===void 0){const r=new B(A.REMOTE_USER_IS_NOT_PUBLISHED);throw m.error("[".concat(this._clientId,"] can not unsubscribe ").concat(t.uid," with channelId ").concat(e,", remote datachannel is not published")),r}m.info("[".concat(this._clientId,"] unsubscribe uid: ").concat(t.uid,", mediaType: datachannel, ids: ").concat(i.map((r=>r.id))));try{const r=await this._p2pChannel.unsubscribeDataChannel(t,i);r&&await this._gateway.unsubscribeDataChannel(r,t.uid),m.info("[".concat(this._clientId,"] unsubscribe datachannel success uid: ").concat(t.uid,", mediaType: datachannel, ids: ").concat(r))}catch(r){if(r.code===A.DISCONNECT_P2P)return void m.warning("disconnecting p2p, abort unsubscribe request.");throw m.error("[".concat(this._clientId,"] unsubscribe user ").concat(t.uid," error"),r.toString()),r}}async massUnsubscribe(t){if(wo(t,"unsubscribeList"),!this._joinInfo)throw new B(A.INVALID_OPERATION,"Can't unsubscribeAll stream, haven't joined yet!");m.info("[".concat(this._clientId,"] start massUnsubscribe ").concat(t.map((n=>{let{user:i,mediaType:r}=n;return"user: ".concat(i?.uid,", mediaType: ").concat(r,";")})).join())),t=[...t];const e=new Map;for(let n=t.length-1;n>=0;n--){const{user:i,mediaType:r}=t[n];if(!i){const a=new B(A.INVALID_PARAMS,"user property does not exist in unsubscribeList item");throw m.error("[".concat(this._clientId,"] user property does not exist in unsubscribeList item")),a}if(_n(r,"mediaType",["video","audio",void 0]),!this._users.find((a=>a===i))){m.warning("[".concat(this._clientId,"] can not unsubscribe ").concat(i.uid,", user is not in the channel")),t.splice(n,1);continue}const o=Pn.Video|Pn.LwoVideo;if(e.has(i)){const a=e.get(i);let c;switch(r){case"video":c=a&o;break;case"audio":c=a&Pn.Audio;break;default:c=a&(Pn.Audio|o)}if(c){m.warning("[".concat(this._clientId,"] repeat massUnsubscribe user:").concat(i.uid,",mediaType:").concat(r," twice.")),t.splice(n,1);continue}r?r==="audio"?e.set(i,a|Pn.Audio):r==="video"&&e.set(i,a|o):e.set(i,a|Pn.Audio|o)}else r?r==="audio"?e.set(i,Pn.Audio):r==="video"&&e.set(i,o):e.set(i,Pn.Audio|o)}try{const n=await this._p2pChannel.massUnsubscribe(t);n&&await this._gateway.massUnsubscribe(n),m.info("[".concat(this._clientId,"] massUnsubscribe success ").concat(t.map((i=>{let{user:r,mediaType:s}=i;return"user: ".concat(r?.uid,", mediaType: ").concat(s,";")})).join()))}catch(n){if(n.code===A.DISCONNECT_P2P)return void m.warning("[".concat(this._clientId,"] disconnecting p2p, abort unsubscribe request."));throw m.error("[".concat(this._clientId,"] massUnsubscribe error"),n.toString()),n}}async setLowStreamParameter(t){(function(n){if(!n)throw new H(A.INVALID_PARAMS);Ze(n.width)||Yg(n.width,"streamParameter.width"),Ze(n.height)||Yg(n.height,"streamParameter.height"),Ze(n.framerate)||Yg(n.framerate,"streamParameter.framerate"),Ze(n.bitrate)||Oe(n.bitrate,"streamParameter.bitrate")})(t),(!t.width&&t.height||t.width&&!t.height)&&m.warning("[".concat(this._clientId,"] The width and height parameters take effect only when both are set")),m.info("[".concat(this._clientId,"] set low stream parameter to"),JSON.stringify(t));const e=this._configDistribute.getLowStreamConfigDistribute();if(e&&e.bitrate&&t.bitrate&&e.bitrate<t.bitrate&&(t.bitrate=e.bitrate),this._lowStreamParameter=t,this._isDualStreamEnabled)return this._p2pChannel.updateVideoStreamParameter(t,tt.LocalVideoLowTrack)}async setDualStreamMode(t,e){_n(t,"mode",[0,1,-1]);try{switch(e&&await this.setLowStreamParameter(e),this._dualStreamMode=t,this._joinInfo?this._gateway.setDualStreamMode(t).catch((n=>{m.warning("[".concat(this._clientId,"] set dual stream mode failed"),n.toString())})):m.debug("[".concat(this._clientId,"] haven't joined yet, cache dual stream mode ").concat(t)),t){case Sd.AUTO_SIMULCAST_STREAM:m.info("[".concat(this._clientId,"] set dual stream mode to ").concat(t));break;case Sd.DISABLE_SIMULCAST_STREM:return this.disableDualStream();case Sd.ENABLE_SIMULCAST_STREAM:return this.enableDualStream()}}catch(n){throw m.error("[".concat(this._clientId,"] set dual stream mode error"),n.toString()),n}}async enableDualStream(){if(!Jt().supportDualStream)throw pt.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!1}),new B(A.NOT_SUPPORTED,"Your browser is not support dual stream");if(this._isDualStreamEnabled)throw new B(A.INVALID_OPERATION,"Dual stream is already enabled");if(this._p2pChannel.canPublishLowStream())try{await this._publishLowStream()}catch(t){throw pt.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!1}),t}this._isDualStreamEnabled=!0,this._dualStreamMode=Sd.ENABLE_SIMULCAST_STREAM,this._joinInfo&&this._gateway.setDualStreamMode(this._dualStreamMode,!0,!0).catch((t=>{m.debug("[".concat(this._clientId,"] try to inform gateway to set dual stream mode to ").concat(this._dualStreamMode," ,but failed"),t.toString())})),pt.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!0}),m.info("[".concat(this._clientId,"] enable dual stream"))}async disableDualStream(){if(this._isDualStreamEnabled){if(!this._joinInfo)return this._isDualStreamEnabled=!1,void m.info("[".concat(this._clientId,"] disable dual stream before join"));if(this._p2pChannel.getLocalMedia(tt.LocalVideoLowTrack))try{const t=await this._p2pChannel.unpublishLowStream();t&&await this._gateway.unpublish(t,this._joinInfo.stringUid||this._joinInfo.uid)}catch(t){throw pt.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!1,succ:!1}),t}this._isDualStreamEnabled=!1,this._dualStreamMode=Sd.DISABLE_SIMULCAST_STREM,this._joinInfo&&this._gateway.setDualStreamMode(this._dualStreamMode,!0,!0).catch((t=>{m.debug("[".concat(this._clientId,"] try to inform gateway to set dual stream mode to ").concat(this._dualStreamMode," ,but failed"),t.toString())})),pt.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!1,succ:!0}),m.info("[".concat(this._clientId,"] disable dual stream"))}}async setClientRole(t,e){if((function(i){_n(i,"role",["audience","host"])})(t),e&&Jg(e),this.mode==="rtc"||this.mode==="p2p")throw m.warning("[".concat(this._clientId,"]").concat(this.mode," mode can not use setClientRole")),new B(A.INVALID_OPERATION,"".concat(this.mode," mode can not use setClientRole"));if(e&&e.level&&t==="host")throw new B(A.INVALID_OPERATION,"host mode can not set audience latency level");if(t==="audience"&&this._p2pChannel.hasLocalMedia())throw new B(A.INVALID_OPERATION,"can not set client role to audience when publishing stream");const n=this._config.role;if(this._joinInfo&&(this._joinInfo.role=t),t!==n&&I("ENABLE_ROLE_SELECT_EDGE")?(this._gateway.updateClientRole(t,e),this._config.role=t,this._gateway.reconnect("recover",Xn.REGIONAL_DISTRIBUTION)):(await this._gateway.setClientRole(t,e),this._config.role=t),m.info("[".concat(this._clientId,"] set client role to ").concat(t,", level: ").concat(e&&e.level)),n==="audience"&&t!=="audience"&&this._pendingRtpCapabilityChange&&this._p2pChannel instanceof Ec){const{video_codec:i}=this._pendingRtpCapabilityChange;this._p2pChannel.updateRemoteRTPCapabilities(i.map((r=>r.toLowerCase())).filter((r=>{var s;return $(s=Object.keys(ic)).call(s,r)})))}}async _setClientRoleOptions(t){if(this.mode==="rtc"||this.mode==="p2p"||this._config.role!=="audience"||this._p2pChannel.hasLocalMedia())return;let e=!1;try{t&&Jg(t),await this._gateway.setClientRole(this._config.role,t),e=!0}catch{}finally{m.info("[".concat(this._clientId,"] set client role options ").concat(e?"succeed":"failed",", options is ").concat(t))}}getRemoteInboundOffset(){var t;const e=(t=this._p2pChannel.getStats())===null||t===void 0?void 0:t.audioSend[0];if(!e||!e.timestamp)return 0;const n=e.timestamp-Date.now();return Math.abs(n)>1e3+e.rttMs+100?this.ntpAlignErrorCount+=1:this.ntpAlignErrorCount=0,this.ntpAlignErrorCount>=3?n:0}getNtpWallTimeInMs(){return document.visibilityState==="visible"&&(this.remoteInboundOffset=this.getRemoteInboundOffset()),this.remoteInboundOffset+Date.now()+this._gateway.ntpOffset}setProxyServer(t,e){if(Kn(t,"proxyServer"),!e){if(this.connectionState!=="DISCONNECTED")throw new B(A.INVALID_OPERATION,"Set proxy server before join channel");if(this._cloudProxyServerMode!=="disabled"||this._useLocalAccessPoint)throw new B(A.INVALID_OPERATION,"You have already set the proxy")}this._proxyServer=t,pt.setProxyServer(this._proxyServer),m.setProxyServer(this._proxyServer),m.info("[".concat(this._clientId,"] Set proxy server ").concat(e?"by initialize call":""," success."))}setTurnServer(t,e){if(Array.isArray(t)||(t=[t]),!e){if(this.connectionState!=="DISCONNECTED")throw new B(A.INVALID_OPERATION,"Set turn server before join channel");if(this._cloudProxyServerMode!=="disabled"||this._useLocalAccessPoint)throw new B(A.INVALID_OPERATION,"You have already set the proxy")}if(Ja(t))return this._turnServer={servers:t,mode:"original-manual"},void m.info("[".concat(this._clientId,"] Set original turnserver ").concat(e?"by initialize call":""," success: ").concat(t.map((n=>n.urls)).join(","),"."));t.forEach((n=>MO(n))),this._turnServer={servers:t,mode:"manual"},m.info("[".concat(this._clientId,"] Set turnserver ").concat(e?"by initialize call":""," success."))}setLicense(t){if(this.connectionState!=="DISCONNECTED")throw new B(A.INVALID_OPERATION,"you should set license before join channel");if(Kn(t,"license",32,32),!/^[A-Za-z\d]+$/.test(t))throw new B(A.INVALID_PARAMS,"license should only contains characters from A-Z a-z 0-9");this._license=t,m.info("[".concat(this._clientId,"] set license success"),t)}startProxyServer(t){if(this.connectionState!=="DISCONNECTED")throw new B(A.INVALID_OPERATION,"Start proxy server before join channel");if(this._proxyServer||this._turnServer.mode==="manual"||this._useLocalAccessPoint)throw new B(A.INVALID_OPERATION,"You have already set the proxy");const e=[3,4,5];let n;switch(t===void 0&&(t=3),t){case 1:case 2:throw new B(A.NOT_SUPPORTED,"proxy mode 1/2 has been deprecated and not supported.");case 3:n="proxy3";break;case 4:n="proxy4";break;case 5:n="proxy5";break;default:throw new B(A.INVALID_PARAMS,"proxy server mode must be ".concat(e.join("|")))}this._cloudProxyServerMode=n,this.store.cloudProxyServerMode=n,m.info("[".concat(this._clientId,"] set cloud proxy server mode to"),this._cloudProxyServerMode)}stopProxyServer(){if(this.connectionState!=="DISCONNECTED")throw new B(A.INVALID_OPERATION,"Stop proxy server after leave channel");pt.setProxyServer(),m.setProxyServer(),this._cloudProxyServerMode="disabled",this.store.cloudProxyServerMode="disabled",m.info("[".concat(this._clientId,"] set cloud proxy server mode to"),this._cloudProxyServerMode),this._proxyServer=void 0,this._turnServer={mode:"auto",servers:[]}}setLocalAccessPointsV2(t){if(!t.accessPoints)throw new B(A.INVALID_PARAMS,"accessPoints is required.");wo(t.accessPoints.serverList,"accessPoints.serverList"),Kn(t.accessPoints.domain,"accessPoints.domain");const e=(p,f)=>{Oe(p,f,0,65535,!0)};let n=443;if(t.accessPoints.port&&(e(t.accessPoints.port,"accessPoints.port"),n=t.accessPoints.port),this._proxyServer||this._cloudProxyServerMode!=="disabled")throw new B(A.INVALID_OPERATION,"set local access point failed, You have already set the cloud proxy");I("CLOSE_AFB_FOR_LOCAL_AP")&&(ye("JOIN_WITH_FALLBACK_SIGNAL_PROXY",!1),ye("JOIN_WITH_FALLBACK_MEDIA_PROXY",!1));const i=/^((\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.){3}(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$/,r=t.accessPoints.domain,s=t.accessPoints.serverList.map((p=>i.test(p)?"".concat(p.replace(/\./g,"-"),".").concat(r):p)),o=s.map((p=>"".concat(p,":").concat(n)));this._useLocalAccessPoint=!0,this._setLocalAPVersion=2,ye("WEBCS_DOMAIN",o),ye("WEBCS_DOMAIN_BACKUP_LIST",o),ye("GATEWAY_DOMAINS",[r]),t.report&&t.report.hostname&&Array.isArray(t.report.hostname)&&t.report.hostname.length?(wo(t.report.hostname,"report.hostname"),ye("EVENT_REPORT_DOMAIN",t.report.hostname[0]),ye("EVENT_REPORT_BACKUP_DOMAIN",t.report.hostname[1]||t.report.hostname[0])):(ye("EVENT_REPORT_DOMAIN",s[0]),ye("EVENT_REPORT_BACKUP_DOMAIN",s[1]||s[0]));let a=6443;t.report&&t.report.port&&(e(t.report.port,"report.port"),a=t.report.port),ye("STATS_COLLECTOR_PORT",a),t.report?ye("ENABLE_EVENT_REPORT",!0):ye("ENABLE_EVENT_REPORT",!1);let c="";t.log&&t.log.hostname&&Array.isArray(t.log.hostname)&&t.log.hostname.length?(wo(t.log.hostname,"log.hostname"),c=t.log.hostname[0]):c=s[0];let d=6444;t.log&&t.log.port&&(e(t.log.port,"log.port"),d=t.log.port),ye("LOG_UPLOAD_SERVER","".concat(c,":").concat(d));let l=[];t.cds&&t.cds.hostname&&Array.isArray(t.cds.hostname)&&t.cds.hostname.length?(wo(t.cds.hostname,"cds.hostname"),l=t.cds.hostname):l=s;let h=443;t.cds&&t.cds.port&&(e(t.cds.port,"cds.port"),h=t.cds.port),ye("CDS_AP",l.map((p=>"".concat(p,":").concat(h)))),t.cds?ye("ENABLE_CONFIG_DISTRIBUTE",!0):ye("ENABLE_CONFIG_DISTRIBUTE",!1),m.info("set local access point v2 success")}setLocalAccessPoints(t,e){if(wo(t,"serverList"),Kn(e,"domain"),this._proxyServer||this._cloudProxyServerMode!=="disabled")throw new B(A.INVALID_OPERATION,"set local access point failed, You have already set the cloud proxy");const n=/^(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$/;t=t.map((i=>n.test(i)?"".concat(i.replace(/\./g,"-"),".").concat(e):i)),this._useLocalAccessPoint=!0,this._setLocalAPVersion=1,ye("WEBCS_DOMAIN",t),ye("WEBCS_DOMAIN_BACKUP_LIST",t),ye("GATEWAY_DOMAINS",[e]),ye("EVENT_REPORT_DOMAIN",t[0]),ye("EVENT_REPORT_BACKUP_DOMAIN",t[1]||t[0]),ye("LOG_UPLOAD_SERVER","".concat(t[0],":6444")),m.info("[".concat(this._clientId,"] set local access point success"))}async setRemoteDefaultVideoStreamType(t){if(_n(t,"streamType",[0,1,4,5,6,7,8,9]),this._remoteDefaultVideoStreamType=t,this._joinInfo)try{await this._gateway.setDefaultRemoteVideoStreamType(t),this._joinInfo.defaultVideoStream=this._remoteDefaultVideoStreamType}catch(e){throw m.error("[".concat(this._clientId,"] set default remote video stream type error"),e.toString()),e}else m.debug("[".concat(this._clientId,"] haven't joined yet, cache remoteDefaultVideoStreamType ").concat(t))}async setRemoteVideoStreamType(t,e){_n(e,"streamType",[0,1,4,5,6,7,8,9]);try{await this._gateway.setRemoteVideoStreamType(t,e),setTimeout((()=>{const n=this._users.find((i=>i.uid===t));n&&n.videoTrack&&n.videoTrack.updateMediaStreamTrackResolution()}),2e3)}catch(n){throw m.error("[".concat(this._clientId,"] set remote video stream type error"),n.toString()),n}m.info("[".concat(this._clientId,"] set remote ").concat(t," video stream type to ").concat(e)),this._remoteStreamTypeCacheMap.set(t,e)}async setStreamFallbackOption(t,e){_n(e,"fallbackType",[0,1,2,3,4,5,6,7,8]);try{await this._gateway.setStreamFallbackOption(t,e)}catch(n){throw m.error("[".concat(this._clientId,"] set stream fallback option"),n.toString()),n}m.info("[".concat(this._clientId,"] set remote ").concat(t," stream fallback type to ").concat(e)),this._streamFallbackTypeCacheMap.set(t,e)}setEncryptionConfig(t,e,n,i){(function(s){_n(s,"encryptionMode",["aes-128-xts","aes-256-xts","aes-128-ecb","sm4-128-ecb","aes-128-gcm","aes-256-gcm","aes-128-gcm2","aes-256-gcm2","none"])})(t),Kn(e,"secret");const r=["aes-128-gcm2","aes-256-gcm2"];if($(r).call(r,t)){if(!n||!(n instanceof Uint8Array&&n.length===32))throw new B(A.INVALID_PARAMS,"salt must be an Uint8Array and exactly equal to 32 bytes")}else if(n)throw new B(A.INVALID_PARAMS,"current encrypt mode does not need salt");if(i){if(Zr(i,"encryptDataStream"),!$(r).call(r,t))throw new B(A.INVALID_PARAMS,"current encrypt mode does not support data stream");this._encryptDataStream=!0}new RegExp(`^(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])(?=.*[!@#$%^&*,.<>?/:;'"|{}\\[\\]])(?=.{8,})`).test(e)||m.warning(`The secret is not strong:
      The secret must contain at least 1 lowercase alphabetical character,
      The secret must contain at least 1 uppercase alphabetical character,
      The secret must contain at least 1 numeric character,
      The secret must contain at least one special character,
      The secret must be eight characters or longer.
      `),this._encryptionMode=t,this._encryptionSecret=e,n&&(this._encryptionSalt=aa(n))}async renewToken(t){if(Kn(t,"token",1,2047),!this._key||!this._joinInfo)throw new B(A.INVALID_OPERATION,"renewToken should not be called before user join");const e=this._key;this._key=t,this._joinInfo&&(this._joinInfo.token=t);const n=await this._renewTokenMutex.lock();try{if(I("USE_NEW_TOKEN")){m.debug("[".concat(this._clientId,"] start renew token with ticket from unilbs"));const i=await VY(this._joinInfo,this._axiosCancelSource.token,this._config.httpRetryConfig||fn);m.debug("[".concat(this._clientId,"] get ticket from unilbs success")),await this._gateway.renewToken({token:t,ticket:i})}else m.debug("[".concat(this._clientId,"] start renew token without ticket")),await this._gateway.renewToken({token:t});m.debug("[".concat(this._clientId,"] renewToken success"))}catch(i){throw this._key=e,this._joinInfo.token=e,m.error("[".concat(this._clientId,"] renewToken failed"),i.toString()),i}finally{n()}}enableAudioVolumeIndicator(){this._audioVolumeIndicationInterval?m.warning("you have already enabled audio volume indicator!"):this._audioVolumeIndicationInterval=window.setInterval((()=>{const t=this._p2pChannel.getAudioLevels();this.safeEmit(qt.VOLUME_INDICATOR,t)}),I("AUDIO_VOLUME_INDICATION_INTERVAL")||2e3)}getRTCStats(){const t=this._statsCollector.getRTCStats(),e=this._gateway.getInChannelInfo();return t.Duration=Math.round(e.duration/1e3),t}async startLiveStreaming(t,e){if(!e){if(this.codec!=="h264")throw new B(A.LIVE_STREAMING_INVALID_RAW_STREAM,"raw streaming is only support h264");if(!this._p2pChannel.hasLocalMedia())throw new B(A.LIVE_STREAMING_INVALID_RAW_STREAM,"can not find stream to raw streaming")}if(this._liveRawStreamingClient&&this._liveRawStreamingClient.hasUrl(t)||this._liveTranscodeStreamingClient&&this._liveTranscodeStreamingClient.hasUrl(t))throw new B(A.LIVE_STREAMING_TASK_CONFLICT);const n=e?No.TRANSCODE:No.RAW;return this._createLiveStreamingClient(n).startLiveStreamingTask(t,n)}setLiveTranscoding(t){return this._createLiveStreamingClient(No.TRANSCODE).setTranscodingConfig(t)}async stopLiveStreaming(t){const e=[this._liveRawStreamingClient,this._liveTranscodeStreamingClient].filter((n=>n&&n.hasUrl(t)));if(!e.length)throw new B(A.INVALID_PARAMS,"can not find live streaming url to stop");await st.all(e.map((n=>n&&n.stopLiveStreamingTask(t))))}async startChannelMediaRelay(t){IP(t),await this._createChannelMediaRelayClient().startChannelMediaRelay(t)}async updateChannelMediaRelay(t){IP(t),await this._createChannelMediaRelayClient().updateChannelMediaRelay(t)}async stopChannelMediaRelay(){await this._createChannelMediaRelayClient().stopChannelMediaRelay(),this._statsCollector.onStatsChanged&&(this._statsCollector.onStatsChanged=void 0)}sendAudioMetadata(t){this._p2pChannel instanceof Ec&&this._p2pChannel.addAudioMetadata(t)}async sendStreamMessage(t){var e;let n=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];if(!this._joinInfo)throw new B(A.INVALID_OPERATION,"can not send data stream, not joined");if((typeof t=="string"||t instanceof Uint8Array)&&(t={payload:t}),typeof t.payload=="string"){const r=new TextEncoder;t.payload=r.encode(t.payload)}let i=!1;if(this._encryptDataStream&&this._encryptDataStreamIv&&this._encryptDataStreamKey&&window.crypto.subtle&&$(e=["aes-128-gcm2","aes-256-gcm2"]).call(e,this._encryptionMode)&&(i=!0,t.payload=await(async function(r,s,o){var a;const c=Ir(a=Array.from(o)).call(a,((S,T)=>S+T),0),d={serverTs:0,seq:a8++,length:o.length,checkSum:c},l=new Uint8Array(HO(c,2)),h=new ArrayBuffer(Id),p=new DataView(h);p.setUint32(0,d.serverTs),p.setUint16(4,d.seq),p.setUint16(6,d.length),p.setUint16(8,d.checkSum);const f=16-o.length%16;o=FO(o,new Uint8Array(f));const v=await window.crypto.subtle.encrypt({name:"AES-GCM",iv:r,tagLength:n0,additionalData:l},s,o);return FO(new Uint8Array(h),new Uint8Array(v))})(this._encryptDataStreamIv,this._encryptDataStreamKey,t.payload)),new Blob([t.payload]).size>1024)throw new B(A.INVALID_PARAMS,i?"encrypted stream message out of range.":"stream message out of range.");return this._gateway.signal.request(Tt.DATA_STREAM,{payload:aa(t.payload),syncWithAudio:t.syncWithAudio,sendTs:Date.now()-qY},!n)}sendMetadata(t){if(!this._joinInfo)throw new B(A.INVALID_OPERATION,"can not send metadata, not joined");if(new Blob([t]).size>1024)throw new B(A.METADATA_OUT_OF_RANGE);return this._gateway.signal.request(Tt.SEND_METADATA,{session_id:this._joinInfo.sid,metadata:aa(t)})}async sendCustomReportMessage(t){if(Array.isArray(t)||(t=[t]),t.forEach(m8),!this._joinInfo)throw new B(A.INVALID_OPERATION,"can not send custom report, not joined");await pt.sendCustomReportMessage(this._joinInfo.sid,t)}getLocalAudioStats(){return this._statsCollector.getLocalAudioTrackStats()}getRemoteAudioStats(){return this._statsCollector.getRemoteAudioTrackStats()}getLocalVideoStats(){return this._statsCollector.getLocalVideoTrackStats()}getRemoteVideoStats(){return this._statsCollector.getRemoteVideoTrackStats()}getRemoteNetworkQuality(){const t=this._statsCollector.getRemoteNetworkQualityStats();if(I("DELETE_NEQ_AFTER_USER_LEAVE")){const e=this._users.map((n=>n.uid+""));Object.keys(t).forEach((n=>{$(e).call(e,n)||delete t[n]}))}return t}getNetworkQuality(){return this._statsCollector.getNetworkQuality()}async pickSVCLayer(t,e){_n(e.spatialLayer,"spatialLayer",[0,1,2,3]),_n(e.temporalLayer,"temporalLayer",[0,1,2,3]);try{await this._gateway.pickSVCLayer(t,e)}catch(n){throw m.error("[".concat(this._clientId,"] pick SVC layer failed"),n.toString()),n}}async setRTMConfig(t){const{apRTM:e=!1,rtmFlag:n}=t;if(Zr(e,"apRTM"),Oe(n,"rtmFlag",0),this._rtmConfig.apRTM=e,this._rtmConfig.rtmFlag=n,m.debug("[".concat(this._clientId,"] setRTMconfig ").concat(JSON.stringify(t)," in ").concat(this.connectionState," state")),(this.connectionState==="CONNECTED"||this.connectionState==="RECONNECTING")&&this._joinInfo)return this._joinInfo.apRTM=e,this._joinInfo.rtmFlag=n,this._gateway.setRTM2Flag(n)}_reset(){if(m.debug("[".concat(this._clientId,"] reset client")),(function(t){const e=Ud.indexOf(t);e!==-1&&Ud.splice(e,1)})(this._clientId),this.store.hasStartJoinChannel=!1,this.store.isABTestSuccess=!1,this.store.autoSubscribe=!1,this._pendingRtpCapabilityChange=void 0,this._axiosCancelSource.cancel(),this._axiosCancelSource=yi.CancelToken.source(),this._streamFallbackTypeCacheMap=new Map,this._remoteStreamTypeCacheMap=new Map,this._configDistribute.stopGetConfigDistribute(),this._joinInfo&&ZP(this._joinInfo),this._rteDetailInterval&&(window.clearInterval(this._rteDetailInterval),this._rteDetailInterval=void 0,this._sessionId&&pt.reportRteDetail(this._sessionId)),this._fallbackServerInfo=void 0,this._joinInfo=void 0,this._proxyServer=void 0,this._defaultStreamFallbackType=void 0,this._sessionId&&pt.removeSid(this._sessionId),this._sessionId=null,this.store.sessionId=null,this.store.resetFirstVideoFrameDecoded(),this._statsCollector.reset(),this._key=void 0,this._appId=void 0,this._uid=void 0,this.store.uid=void 0,this._channelName=void 0,this._encryptionMode="none",this._encryptionSecret=null,this._encryptionSalt=null,this._encryptDataStreamKey=null,this._encryptDataStreamIv=null,this._pendingPublishedUsers=[],this._users.forEach((t=>{t._audioTrack&&t._audioTrack._destroy(),t._videoTrack&&t._videoTrack._destroy(),t._dataChannels&&(t._dataChannels.forEach((e=>e._close())),t._dataChannels.length=0)})),this._users=[],this._audioVolumeIndicationInterval&&(window.clearInterval(this._audioVolumeIndicationInterval),this._audioVolumeIndicationInterval=void 0),this._cloudProxyServerMode==="fallback"&&(this._cloudProxyServerMode="disabled",this.store.cloudProxyServerMode="disabled"),this._p2pChannel.reset(),this._publishMutex=new Un("client-publish",this._clientId),this._subscribeMutex=new Un("client-subscribe",this._clientId),this._networkQualityInterval&&(window.clearInterval(this._networkQualityInterval),this._networkQualityInterval=void 0),this._liveRawStreamingClient&&(this._liveRawStreamingClient.terminate(),this._liveRawStreamingClient.removeAllListeners(),this._liveRawStreamingClient=void 0),this._liveTranscodeStreamingClient&&(this._liveTranscodeStreamingClient.terminate(),this._liveTranscodeStreamingClient.removeAllListeners(),this._liveTranscodeStreamingClient=void 0),this._channelMediaRelayClient&&(this._channelMediaRelayClient.dispose(),this._channelMediaRelayClient=void 0),this._inspect)try{this._inspect.close(),this._inspect=void 0}catch{}if(this._moderation)try{this.setImageModeration(!1)}catch{}}_startSession(t,e){var n;const i=t||ec();t?m.debug("[".concat(this._clientId,"] new Session ").concat(i)):m.debug("[".concat(this._clientId,"] renewSession ").concat(this._sessionId," => ").concat(i));const r=t?"":this._sessionId||"";this._sessionId=i,this.store.sessionId=i,pt.addSid(i);const s={lts:new Date().getTime(),mode:this.mode,buildFormat:1,stringUid:e?.stringUid||((n=this._joinInfo)===null||n===void 0?void 0:n.stringUid),channelProfile:this.mode==="live"?1:0,channelMode:0,isABTestSuccess:Number(this._configDistribute.isSuccess),lsid:r,clientRole:this.role==="audience"?2:1,rteUrl:this.store.rteUrl,rteSid:this.store.rteSid};pt.sessionInit(this._sessionId,cs({cname:e.channel,appid:e.appId},s)),this._joinInfo&&(this._joinInfo.sid=i),this._gateway.joinInfo&&(this._gateway.joinInfo.sid=i)}async _publishHighStream(t){if(!this._joinInfo||this._uid===void 0)throw new B(A.INVALID_OPERATION,"Can't publish stream, haven't joined yet!");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new B(A.INVALID_OPERATION,"can not publish stream in ".concat(this.connectionState," state"));if(this._turnServer.mode==="auto"&&I("FORCE_TURN")&&!I("TURN_ENABLE_TCP")&&!I("TURN_ENABLE_UDP"))throw new B(A.UNEXPECTED_ERROR,"force TURN With No TURN Configuration");m.debug("[".concat(this._clientId,"] publish high stream"));try{const n=await this._p2pChannel.publish(t,this._isDualStreamEnabled,this._lowStreamParameter);if(this.store.useP2P){const i=(await n.next()).value;if(i){try{await this._gateway.sendExtensionMessage(cn.PUBLISH,i,!0)}catch(r){throw n.throw(r),r}await n.next()}this._p2pChannel.reportPublishEvent(!0,null)}else{const i=(await n.next()).value;if(i){var e;let r;try{r=await this._gateway.publish(this._uid,i,!0)}catch(s){if(s.code!==A.DISCONNECT_P2P)throw n.throw(s),s}await n.next(((e=r)===null||e===void 0?void 0:e.ortc)||[])}this._p2pChannel.reportPublishEvent(!0,null);for(const r of t)r instanceof De&&r._encoderConfig&&this._gateway.setVideoProfile(r._encoderConfig).catch((s=>{m.debug("[".concat(this._clientId,"] stop setVideoProfile, because websocket is closed"))})),!r.muted&&r.enabled||await this._p2pChannel.muteLocalTrack(r)}}catch(n){if(this._p2pChannel.reportPublishEvent(!1,n?.code,t),n?.code===A.WS_ABORT)return;throw n}}async _publishLowStream(){if(!this._joinInfo||this._uid===void 0)throw new B(A.INVALID_OPERATION,"Can't publish stream, haven't joined yet!");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new B(A.INVALID_OPERATION,"can not publish stream in ".concat(this.connectionState," state"));m.debug("[".concat(this._clientId,"] publish low stream"));const t=this._configDistribute.getLowStreamConfigDistribute();t&&t.bitrate&&(this._lowStreamParameter||(this._lowStreamParameter={width:160,height:120,framerate:15,bitrate:50}),this._lowStreamParameter&&this._lowStreamParameter.bitrate&&t.bitrate<this._lowStreamParameter.bitrate&&(this._lowStreamParameter.bitrate=t.bitrate));try{const n=await this._p2pChannel.publishLowStream(this._lowStreamParameter),i=(await n.next()).value;if(i){var e;let r;try{r=await this._gateway.publish(this._uid,i,!0)}catch(s){if(s.code!==A.DISCONNECT_P2P)throw n.throw(s),s}n.next(((e=r)===null||e===void 0?void 0:e.ortc)||[]),this._p2pChannel.reportPublishEvent(!0,null,void 0,!0)}}catch(n){if(this._p2pChannel.reportPublishEvent(!1,n?.code,void 0,!0),n?.code===A.WS_ABORT)return;throw n}}_createLiveStreamingClient(t){const e=()=>{if(!this._joinInfo||!this._appId)return new B(A.INVALID_OPERATION,"can not create live streaming client, please join channel first").throw();const n=(i={joinInfo:this._joinInfo,appId:this._appId,websocketRetryConfig:this._config.websocketRetryConfig,httpRetryConfig:this._config.httpRetryConfig},bs("LiveStreaming").create(i));var i;return n.onLiveStreamError=(r,s)=>{pt.reportApiInvoke(this._sessionId,{name:Ge.ON_LIVE_STREAM_ERROR,options:[r,s],tag:Ne.TRACER}).onSuccess(),this.safeEmit(qt.LIVE_STREAMING_ERROR,r,s)},n.onLiveStreamWarning=(r,s)=>{pt.reportApiInvoke(this._sessionId,{name:Ge.ON_LIVE_STREAM_WARNING,options:[r,s],tag:Ne.TRACER}).onSuccess(),this.safeEmit(qt.LIVE_STREAMING_WARNING,r,s)},n.on(qS.REQUEST_WORKER_MANAGER_LIST,((r,s,o)=>{if(!this._joinInfo)return o(new B(A.INVALID_OPERATION,"can not find join info to get worker manager"));(async function(a,c,d,l){const h=I("UAP_AP").slice(0,I("AJAX_REQUEST_CONCURRENT")).map((p=>c.proxyServer?"https://".concat(c.proxyServer,"/ap/?url=").concat(p+"/api/v1?action=uap"):"https://".concat(p,"/api/v1?action=uap")));return await DY(h,a,c,d,l)})(r,this._joinInfo,this._axiosCancelSource.token,fn).then(s).catch(o)})),n};return t===No.RAW?(this._liveRawStreamingClient=this._liveRawStreamingClient||e(),this._liveRawStreamingClient):(this._liveTranscodeStreamingClient=this._liveTranscodeStreamingClient||e(),this._liveTranscodeStreamingClient)}_createChannelMediaRelayClient(){if(!this._joinInfo)return new B(A.INVALID_OPERATION,"can not create channel media relay client, please join channel first").throw();if(!this._channelMediaRelayClient){const{sendResolutionWidth:e,sendResolutionHeight:n}=this.getLocalVideoStats(),i=(t={joinInfo:this._joinInfo,clientId:this._clientId,websocketRetryConfig:this._config.websocketRetryConfig,httpRetryConfig:this._config.httpRetryConfig,resolution:{width:e,height:n}},bs("ChannelMediaRelay").create(t));i.on("state",(r=>{r===Mi.RELAY_STATE_FAILURE&&i&&i.dispose(),this.safeEmit(qt.CHANNEL_MEDIA_RELAY_STATE,r)})),i.on("event",(r=>{this.safeEmit(qt.CHANNEL_MEDIA_RELAY_EVENT,r)})),this._channelMediaRelayClient=i,this._statsCollector.onStatsChanged=(r,s)=>{var o;r==="resolution"&&((o=this._channelMediaRelayClient)===null||o===void 0||o.setVideoProfile(s))}}var t;return this._channelMediaRelayClient}_handleUpdateDataChannel(t,e){const{added:n,deleted:i}=t,r=[];if(e){const s=[];this._users.forEach((o=>{o._dataChannels.forEach((a=>{n.every((c=>c.uid!==o._uintid||c.stream_id!==a.id))&&s.push({uid:o._uintid,stream_id:a.id,ordered:a.ordered,max_retrans_times:a.maxRetransmits,metadata:a.metadata})}))})),s.length>0&&this._handleUpdateDataChannel({added:[],deleted:s})}Array.isArray(n)&&n.length>0&&n.forEach((s=>{const{uid:o,stream_id:a,ordered:c,max_retrans_times:d,metadata:l}=s,h=this._users.find((p=>p._uintid===o));if(!h)return void m.error("[".concat(this._clientId,"] can not find target user!(on_add_data_channel)"));if(m.debug("[".concat(this._clientId,"] data_channel added with uid ").concat(o)),$(r).call(r,h)||r.push(h),h._uintid||(h._uintid=o),h._dataChannels.findIndex((p=>p.id===s.stream_id))===-1){const p={id:a,ordered:!!c,maxRetransmits:d,metadata:l},f=(function(v){return dP(v,!0)})(p);h._dataChannels.push(f),m.info("[".concat(this._clientId,"] remote user ").concat(h.uid," published datachannel")),e||this.safeEmit(qt.USER_PUBLISHED,h,"datachannel",p)}this._p2pChannel.hasPendingRemoteDataChannel(h,s.stream_id)&&(m.debug("[".concat(this._clientId,"] resubscribe datachannel for user ").concat(h.uid," after reconnect.")),this._subscribeDataChannel(h,s.stream_id).catch((p=>{m.error("[".concat(this._clientId,"] resubscribe datachannel error"),p.toString())})))})),e&&(this.safeEmit(qt.PUBLISHED_USER_LIST,this._pendingPublishedUsers),this._pendingPublishedUsers=[]),Array.isArray(i)&&i.length>0&&i.forEach((s=>{const{uid:o,stream_id:a}=s,c=this._users.find((l=>l._uintid===o));if(!c)return void m.error("[".concat(this._clientId,"] can not find target user!(on_delete_data_channel)"));const d=c._dataChannels.find((l=>l.id===s.stream_id));d&&(m.debug("[".concat(this._clientId,"] data_stream delete with uid ").concat(o)),this._p2pChannel.unsubscribeDataChannel(c,[d]).then((l=>{if(c._dataChannels=c._dataChannels.filter((h=>h!==d)),l)return this._gateway.unsubscribeDataChannel(l,c.uid)})),m.info("[".concat(this._clientId,"] remote user ").concat(o," unpublished datachannel ,id:").concat(d.id)),this.safeEmit(qt.USER_UNPUBLISHED,c,"datachannel",d._config))}))}_getEncodingName(t){var e,n;if(!this._joinResponse)return;const i=(e=this._joinResponse.ortc.rtpCapabilities.sendrecv)===null||e===void 0?void 0:e.videoCodecs;if(!i)return;for(const a of i){var r;if(a.payloadType===t)return a==null||(r=a.rtpMap)===null||r===void 0?void 0:r.encodingName}const s=(n=this._joinResponse.ortc.rtpCapabilities.recv)===null||n===void 0?void 0:n.videoCodecs;if(s)for(const a of s){var o;if(a.payloadType===t)return a==null||(o=a.rtpMap)===null||o===void 0?void 0:o.encodingName}return t===0?"unknown":void 0}_handleRemoveDataChannels(t){const e=this._users.find((n=>n.uid===t.uid));if(e){if(e._dataChannels!==void 0&&e._dataChannels.length>0){m.debug("[".concat(this._clientId,"] datachannel removed with uid ").concat(t.uid));const n=()=>{m.info("[".concat(this._clientId,"] remote user ").concat(e.uid," unpublished datachannel")),e._dataChannels.forEach((i=>{this.safeEmit(qt.USER_UNPUBLISHED,e,"datachannel",i._config)}))};this._p2pChannel.unsubscribeDataChannel(e,e._dataChannels).then((i=>{if(i)return this._gateway.unsubscribeDataChannel(i,e.uid)})),n()}}else m.warning("[".concat(this._clientId,"] can not find target user!(on_remove_datachannel)"))}_handleGatewayEvents(){this._gateway.on(an.UPDATE_GATEWAY_CONFIG,(()=>{(function(){let t;try{t=window.localStorage.getItem("websdk_ng_global_parameter")}catch(e){return void m.error("Error loading sdk config",e.message)}if(t)try{const e=JSON.parse(window.atob(t)),n=Date.now();Object.keys(e).forEach((i=>{const{value:r,type:s,expires:o}=e[i];o&&o<=n||s||BS()||!Object.prototype.hasOwnProperty.call(Jp,i)||(ur[i]=r,Te[i]=r,m.debug("Update gateway parameters from config distribute",i,r))}))}catch(e){m.error("Error update config from local cache",e.message)}})()})),this._gateway.on(an.DISCONNECT_P2P,(async()=>{await this._p2pChannel.disconnectForReconnect()})),this._gateway.on(an.CONNECTION_STATE_CHANGE,((t,e,n)=>{var i;if(n===te.FALLBACK)return;const r=()=>{this.safeEmit(qt.CONNECTION_STATE_CHANGE,t,e,n)};if(pt.reportApiInvoke(this._sessionId||((i=this._gateway.joinInfo)===null||i===void 0?void 0:i.sid)||null,{name:Ge.CONNECTION_STATE_CHANGE,options:[t,e,n],tag:Ne.TRACER}).onSuccess(JSON.stringify({cur:t,prev:e,reason:n})),m.info("[".concat(this._clientId,"] signal connection state change: ").concat(e," -> ").concat(t)),t==="DISCONNECTED")return this._reset(),void r();if(t==="RECONNECTING")this._users.forEach((o=>{o._trust_in_room_=!1,o._trust_audio_enabled_state_=!1,o._trust_video_enabled_state_=!1,o._trust_audio_mute_state_=!1,o._trust_video_mute_state_=!1,o._trust_audio_stream_added_state_=!1,o._trust_video_stream_added_state_=!1,o._is_pre_created||(o._audio_pre_subscribed||(o._audioSSRC=void 0,o._audioOrtc=void 0),o._video_pre_subscribed||(o._videoSSRC=void 0,o._videoOrtc=void 0,o._rtxSsrcId=void 0),o._cname=void 0)})),this._userOfflineTimeout&&window.clearTimeout(this._userOfflineTimeout),this._streamRemovedTimeout&&window.clearTimeout(this._streamRemovedTimeout),this._userOfflineTimeout=void 0,this._streamRemovedTimeout=void 0;else if(t==="CONNECTED"){var s;this._streamFallbackTypeCacheMap.forEach(((o,a)=>{this._gateway.setStreamFallbackOption(a,o).catch((c=>{m.warning("[".concat(this._clientId,"] auto set stream fallback option failed"),c)}))})),this._remoteStreamTypeCacheMap.forEach(((o,a)=>{this._gateway.setRemoteVideoStreamType(a,o).catch((c=>{m.warning("[".concat(this._clientId,"] auto set remote stream type failed"),c)}))})),I("VOS_CONFIGURE")&&Array.isArray(I("VOS_CONFIGURE"))&&I("VOS_CONFIGURE").length>0&&(this._gateway.setConfigure(I("VOS_CONFIGURE")).catch((o=>{m.debug("[".concat(this._clientId,"] auto set vos config failed"),o)})),m.debug("[".concat(this._clientId,"] ws connected auto set vos config"))),this._remoteDefaultVideoStreamType!==void 0&&((s=this._joinInfo)===null||s===void 0?void 0:s.defaultVideoStream)===void 0&&this.setRemoteDefaultVideoStreamType(this._remoteDefaultVideoStreamType).then((()=>{m.debug("[".concat(this._clientId,"] setRemoteDefaultVideoStreamType after gateway connected"))})).catch((o=>{m.error("[".concat(this._clientId,"] setRemoteDefaultVideoStreamType after gateway failed, ").concat(o))})),this._dualStreamMode&&this._gateway.setDualStreamMode(this._dualStreamMode).catch((o=>{m.warning("[".concat(this._clientId,"] auto set dual stream mode failed"),o)})),this.store.useP2P||(this._p2pChannel.republish(),this._userOfflineTimeout=window.setTimeout((()=>{this.connectionState==="CONNECTED"&&(this._userOfflineTimeout=void 0,this._users.filter((o=>!o._trust_in_room_)).forEach((o=>{m.debug("[".concat(this._clientId,"] user offline timeout, emit user offline ").concat(o.uid)),this._handleUserOffline({uid:o.uid})})))}),3e3),this._streamRemovedTimeout=window.setTimeout((()=>{this.connectionState==="CONNECTED"&&(this._streamRemovedTimeout=void 0,this._users.forEach((o=>{o._trust_audio_mute_state_||(m.debug("[".concat(this._clientId,"] auto dispatch audio unmute event ").concat(o.uid)),this._handleMuteStream(o.uid,ut.AUDIO,!1)),o._trust_video_mute_state_||(m.debug("[".concat(this._clientId,"] auto dispatch video unmute event ").concat(o.uid)),this._handleMuteStream(o.uid,ut.VIDEO,!1)),o._trust_audio_enabled_state_||(m.debug("[".concat(this._clientId,"] auto dispatch enable local audio ").concat(o.uid)),this._handleSetStreamLocalEnable("audio",o.uid,!0)),o._trust_video_enabled_state_||(m.debug("[".concat(this._clientId,"] auto dispatch enable local video ").concat(o.uid)),this._handleSetStreamLocalEnable("video",o.uid,!0)),o._trust_video_stream_added_state_||(m.debug("[".concat(this._clientId,"] auto dispatch reset video stream added ").concat(o.uid)),this._handleResetAddStream(o,"video")),o._trust_audio_stream_added_state_||(m.debug("[".concat(this._clientId,"] auto dispatch reset audio stream added ").concat(o.uid)),this._handleResetAddStream(o,"audio")),o._video_added_||o._audio_added_||(m.debug("[".concat(this._clientId,"] auto dispatch stream remove ").concat(o.uid)),this._handleRemoveStream({uid:o.uid,uint_id:o._uintid}))})))}),1e3))}r()})),this._gateway.on(an.REQUEST_NEW_GATEWAY_LIST,(async(t,e)=>{if(!this._joinInfo)return e(new B(A.UNEXPECTED_ERROR,"can not recover, no join info"));try{let n;if(this._fallbackServerInfo)n=this._fallbackServerInfo,this._fallbackServerInfo=void 0,this._joinInfo.preload=!1,pt.reportApiInvoke(this._sessionId,{name:Ge.VOS_FALLBACK_CN,options:{cur:n.gatewayInfo.gatewayAddrs,prev:this._joinInfo.gatewayAddrs,is_done:!0},tag:Ne.TRACER}).onSuccess(),m.info("[".concat(this._clientId,"] use fallback cn server info"));else{const r=await PT(cs(cs({},this._joinInfo),{},{uid:this._joinInfo.uid,stringUid:void 0}));r?(n=r.ap,$P(r),this._joinInfo.preload=!0):(n=await L_(this._joinInfo,this._axiosCancelSource.token,this._config.httpRetryConfig||fn,this.store),this._joinInfo.preload=!1)}this._joinInfo&&(this._joinInfo.apResponse=n.gatewayInfo.res,this._joinInfo.gatewayAddrs=n.gatewayInfo.gatewayAddrs,this._joinInfo.uni_lbs_ip=n.gatewayInfo.uni_lbs_ip);const i=[];n.gatewayInfo.gatewayAddrs.forEach((r=>{let{address:s}=r;const[o,a]=s.split(":");this._joinInfo&&this._joinInfo.proxyServer?i.push({proxy:this._joinInfo.proxyServer,host:o,port:a}):i.push({host:o,port:a})})),t(i)}catch(n){e(n)}})),this._gateway.on(an.NETWORK_QUALITY,(t=>{this._networkQualitySensitivity==="normal"&&this.safeEmit(qt.NETWORK_QUALITY,t)})),this._gateway.on(an.STREAM_TYPE_CHANGE,((t,e)=>{this.safeEmit(qt.STREAM_TYPE_CHANGED,t,e),pt.reportApiInvoke(this._sessionId,{name:Ge.STREAM_TYPE_CHANGE,options:[t,e],tag:Ne.TRACER}).onSuccess(JSON.stringify({uid:t,streamType:e}))})),this._gateway.isPreSub=()=>"isPreSub"in this._p2pChannel&&this._p2pChannel.isPreSub(),this._gateway.isPreallocation=()=>"isPreallocation"in this._p2pChannel&&this._p2pChannel.isPreallocation(),this._gateway.on(an.IS_P2P_DISCONNECTED,(t=>{this._p2pChannel.isP2PDisconnected()?t(!0):this._p2pChannel.hasLocalMedia()||this._p2pChannel.hasRemoteMedia()?t(!1):t(!0)})),this._gateway.on(an.REQUEST_P2P_CONNECTION_PARAMS,(async(t,e,n)=>{try{let i=await this._p2pChannel.getEstablishParams();i&&"isPreallocation"in this._p2pChannel&&this._p2pChannel.isPreallocation()||(i=await this._p2pChannel.startP2PConnection(t)),e(i)}catch(i){n(i)}})),this._gateway.on(an.JOIN_RESPONSE,((t,e)=>{if(this.store.useP2P)return;let n;this._joinResponse=t,t.attributes?n=t.attributes.userAttributes.preSubSsrcs:m.debug("no attributes in joinResponse");const i=$D(t.ortc,e,n);this._p2pChannel.connect(i)})),this._gateway.on(an.PRE_CONNECT_PC,(async(t,e,n)=>{const{candidates:i,fingerprint:r,turnServer:s}=t;if(this._joinInfo&&i.length>0&&!this._p2pChannel.isPlanB){const{cert:a,cid:c}=this._joinInfo.apResponse,d="".concat(c,"_").concat(a);if(d.length<4||d.length>256)return void m.debug("[".concat(this._clientId,"] ufrag length is not valid, length: ").concat(d.length));await this._p2pChannel.startP2PConnection({turnServer:s,cloudProxyServer:this._joinInfo.cloudProxyServer,isPreallocation:!0});try{var o;e(await this._p2pChannel.connect({iceParameters:{iceUfrag:"".concat(c,"_").concat(a),icePwd:"".concat(c,"_").concat(a)},dtlsParameters:{fingerprints:[{hashFunction:"sha-256",fingerprint:(o=I("FINGERPRINT"))!==null&&o!==void 0?o:r}]},candidates:i,rtpCapabilities:{send:{audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]},recv:{audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]}},setup:"active",cname:"o/i14u9pJrxRKAsu",preallocation:!0}))}catch(l){l.code&&l.code===A.EXCHANGE_SDP_FAILED&&await this._p2pChannel.startP2PConnection({turnServer:s,cloudProxyServer:this._joinInfo.cloudProxyServer},!0),n(l)}}})),this._gateway.on(an.VOS_FALLBACK,(t=>{t==="fallback_hls"&&this.safeEmit(qt.FALLBACK_TO_HLS,Qg.VOSERROR)})),this._gateway.on(an.RESET_SIGNAL,(()=>{this._p2pChannel instanceof Ec&&this._p2pChannel.fallbackConnection(),this._handleGatewaySignalEvents()})),this._gateway.on(an.DATACHANNEL_FAILBACK,(()=>{pt.reportApiInvoke(this._sessionId,{name:Ge.DATACHANNEL_FAILBACK,options:{},tag:Ne.TRACER}).onSuccess(),this._joinGateway()}))}_handleGatewaySignalEvents(){this._gateway.signal.on(Lt.ON_USER_ONLINE,this._handleUserOnline),this._gateway.signal.on(Lt.ON_USER_OFFLINE,this._handleUserOffline),this._gateway.signal.on(Lt.ON_ADD_AUDIO_STREAM,(t=>this._handleAddAudioOrVideoStream("audio",t.uid,t.ssrcId,t.cname,t.pt,t.uint_id,t.ortc))),this._gateway.signal.on(Lt.ON_ADD_VIDEO_STREAM,(t=>this._handleAddAudioOrVideoStream("video",t.uid,t.ssrcId,t.cname,t.pt,t.uint_id,t.ortc,t.rtxSsrcId))),this._gateway.signal.on(Lt.ON_REMOTE_DATASTREAM_UPDATE,(t=>{this._handleUpdateDataChannel(t)})),this._gateway.signal.on(Lt.ON_REMOTE_FULL_DATASTREAM_INFO,(t=>{this._handleUpdateDataChannel({added:t.datastreams||[],deleted:[]},!0)})),this._gateway.signal.on(Lt.ON_REMOVE_STREAM,this._handleRemoveStream),this._gateway.signal.on(Lt.ON_P2P_LOST,this._handleP2PLost),this._gateway.signal.on(Lt.MUTE_AUDIO,(t=>this._handleMuteStream(t.uid,ut.AUDIO,!0))),this._gateway.signal.on(Lt.UNMUTE_AUDIO,(t=>this._handleMuteStream(t.uid,ut.AUDIO,!1))),this._gateway.signal.on(Lt.MUTE_VIDEO,(t=>this._handleMuteStream(t.uid,ut.VIDEO,!0))),this._gateway.signal.on(Lt.UNMUTE_VIDEO,(t=>this._handleMuteStream(t.uid,ut.VIDEO,!1))),this._gateway.signal.on(Lt.RECEIVE_METADATA,(t=>{const e=tc(t.metadata);this.safeEmit(qt.RECEIVE_METADATA,t.uid,e)})),this._gateway.signal.on(Lt.ON_DATA_STREAM,(async t=>{var e;if(!t)return;let n=tc(t.payload);if(this._encryptDataStream&&this._encryptDataStreamIv&&this._encryptDataStreamKey&&window.crypto.subtle&&$(e=["aes-128-gcm2","aes-256-gcm2"]).call(e,this._encryptionMode)){if(t.payload.length<Id)throw new B(A.UNEXPECTED_RESPONSE,"payload length ".concat(t.payload.length," is less than header length ").concat(Id));n=await(async function(s,o,a){const c=a.subarray(0,Id),d=c.slice(8,Id),l=(d[0]<<8)+d[1],h=(c[6]<<8)+c[7],p=await window.crypto.subtle.decrypt({name:"AES-GCM",iv:s,tagLength:n0,additionalData:new Uint8Array(HO(l,2))},o,a.subarray(Id));return new Uint8Array(p).subarray(0,h)})(this._encryptDataStreamIv,this._encryptDataStreamKey,n)}let i=0;if(t.ordered||t.syncWithAudio){const r=this._p2pChannel.getStats(),s=this.remoteUsers.find((a=>a.uid===t.uid)),o=r?.audioRecv.find((a=>a.ssrc===s?._audioSSRC));i=o?.jitterBufferMs}(i==null||Number.isNaN(i))&&(i=0),XY(cs(cs({},t),{},{payload:n}),i,{id:this._clientId,onStreamMessage:typeof this.onStreamMessage=="function"?this.onStreamMessage.bind(this):void 0,safeEmit:this.safeEmit.bind(this)})})),this._gateway.signal.on(Lt.ON_CRYPT_ERROR,(()=>{oa((()=>{m.warning("[".concat(this._clientId,"] on crypt error")),this.safeEmit(qt.CRYPT_ERROR)}),this._sessionId)})),this._gateway.signal.on(Lt.ON_TOKEN_PRIVILEGE_WILL_EXPIRE,this._handleTokenWillExpire),this._gateway.signal.on(Lt.ON_TOKEN_PRIVILEGE_DID_EXPIRE,(()=>{m.warning("[".concat(this._clientId,"] received message onTokenPrivilegeDidExpire, please get new token and join again")),this._gateway.leave(!0,te.TOKEN_EXPIRE),this.safeEmit(qt.ON_TOKEN_PRIVILEGE_DID_EXPIRE),this._reset()})),this._gateway.signal.on(Lt.ON_STREAM_FALLBACK_UPDATE,(t=>{m.debug("[".concat(this._clientId,"] stream fallback peerId: ").concat(t.stream_id,", attr: ").concat(t.stream_type)),this.safeEmit(qt.STREAM_FALLBACK,t.stream_id,t.stream_type===1?"fallback":"recover")})),this._gateway.signal.on(Lt.ENABLE_MULTI_STREAM,(t=>{this._dualStreamMode===Sd.AUTO_SIMULCAST_STREAM&&this.enableDualStream().catch((e=>{m.debug("[".concat(this._clientId,"] set dual stream mode error"),e.toString())}))})),this._gateway.signal.on(Lt.ON_PUBLISH_STREAM,(t=>{this.uid===this._uid&&(this._p2pChannel.reportPublishEvent(!0,null,void 0,!1,JSON.stringify({proxy:t.proxy})),m.info("[".concat(this._clientId,"] on publish stream, ").concat(JSON.stringify(t))))})),this._gateway.signal.on(Lt.ENABLE_LOCAL_VIDEO,(t=>{this._handleSetStreamLocalEnable("video",t.uid,!0)})),this._gateway.signal.on(Lt.DISABLE_LOCAL_VIDEO,(t=>{this._handleSetStreamLocalEnable("video",t.uid,!1)})),this._gateway.signal.on(ft.REQUEST_TIMEOUT,((t,e)=>{if(this._joinInfo)switch(t){case Tt.PUBLISH:{if(!e)return;const r=e.ortc;if(r){var n,i;const s=r.some((c=>{let{stream_type:d}=c;return d===Re.Audio})),o=r.some((c=>{let{stream_type:d}=c;return d!==Re.Audio})),a=r.some((c=>{let{stream_type:d}=c;return d===Re.Screen||d===Re.ScreenLow}));e.state==="offer"&&pt.publish(this._joinInfo.sid,{eventElapse:ni.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:!1,ec:A.TIMEOUT,audio:s,video:o,p2pid:e.p2p_id,publishRequestid:this.store.pubId,screenshare:a,audioName:s?(n=r.find((c=>{let{stream_type:d}=c;return d===Re.Audio})))===null||n===void 0||(n=n.ssrcs[0])===null||n===void 0?void 0:n.ssrcId.toString():void 0,videoName:o?(i=r.find((c=>{let{stream_type:d}=c;return d!==Re.Audio})))===null||i===void 0||(i=i.ssrcs[0])===null||i===void 0?void 0:i.ssrcId.toString():void 0})}break}case Tt.SUBSCRIBE:e&&pt.subscribe(this._joinInfo.sid,{succ:!1,ec:A.TIMEOUT,audio:e.stream_type===ut.AUDIO,video:e.stream_type===ut.VIDEO,peerid:e.stream_id,subscribeRequestid:e.ssrcId,p2pid:this.store.p2pId,eventElapse:ni.measureFromSubscribeStart(this.store.clientId,e.ssrcId),preSsrc:this._p2pChannel.isPreSubScribe(e.ssrcId)})}})),this._gateway.signal.on(Lt.ON_P2P_OK,(t=>{this.uid,this._uid})),this._gateway.signal.on(Lt.ON_PUBLISHED_USER_LIST,(t=>{if(t==null||!t.users)return;I("BLOCK_LOCAL_CLIENT")&&(t.users=t.users.filter((i=>!uc(i.string_id||i.stream_id,this.channelName))));const e=[],n=[];for(const i of t.users){let r=this._users.find((l=>l._uintid===i.stream_id));r?r._trust_in_room_=!0:(r=new _a(i.string_id||i.stream_id,i.stream_id),this._users.push(r),this.store.firstVideoFrameDecoded(r.uid,{userJoinNotify:Date.now()}),this.getListeners(qt.PUBLISHED_USER_LIST).length===0&&(m.debug("[".concat(this._clientId,"] user online"),i.stream_id),this.safeEmit(qt.USER_JOINED,r)));const s=Pn.Audio&i.stream_type,o=(Pn.Video|Pn.LwoVideo)&i.stream_type,a=(65280&i.stream_type)!=0,c=s&&r.hasAudio,d=o&&r.hasVideo;o&&(r._trust_video_stream_added_state_=!0,r._video_added_=!0,r._videoSSRC=i.video_ssrc,r._rtxSsrcId=i.video_rtx),s&&(r._trust_audio_stream_added_state_=!0,r._audio_added_=!0,r._audioSSRC=i.audio_ssrc),s&&!c&&this.getListeners(qt.PUBLISHED_USER_LIST).length===0&&(m.info("[".concat(this._clientId,"] remote user ").concat(r.uid," published audio")),this.safeEmit(qt.USER_PUBLISHED,r,"audio")),o&&!d&&this.getListeners(qt.PUBLISHED_USER_LIST).length===0&&(m.info("[".concat(this._clientId,"] remote user ").concat(r.uid," published video")),this.safeEmit(qt.USER_PUBLISHED,r,"video")),(s&&!c||o&&!d||a)&&e.push(r),o&&this._p2pChannel.hasPendingRemoteMedia(r,"video")&&n.push({user:r,mediaType:"video"}),s&&this._p2pChannel.hasPendingRemoteMedia(r,"audio")&&n.push({user:r,mediaType:"audio"})}n.length>0&&(m.debug("[".concat(this._clientId,"] RE massSubscribe after reconnect ").concat(n.map((i=>"user: ".concat(i.user.uid,", mediaType: ").concat(i.mediaType))).join("; ")," ")),this.massSubscribe(n).catch((i=>{m.error("[".concat(this._clientId,"] mass resubscribe error"),i.toString())}))),this.getListeners(qt.PUBLISHED_USER_LIST).length>0?I("ENABLE_DATASTREAM_2")?this._pendingPublishedUsers=e:(m.info("[".concat(this._clientId,"] client emit user-list event, users: ").concat(e.map((i=>i.uid)).join(", "))),this.safeEmit(qt.PUBLISHED_USER_LIST,e)):m.info("[".concat(this._clientId,"] client not emit user-list event case there is no user-list listener, users: ").concat(e.map((i=>i.uid)).join(", ")))})),this._gateway.signal.on(Lt.ON_RTP_CAPABILITY_CHANGE,(t=>{const{video_codec:e}=t;if(this._p2pChannel instanceof Ec){if(this.role==="audience"&&I("UPDATE_RTP_CAP_IN_HOST"))return this._pendingRtpCapabilityChange=t,void m.debug("[".concat(this._clientId,"] no need to change rtp capability because of audience, params: ").concat(JSON.stringify(t)));this._p2pChannel.updateRemoteRTPCapabilities(e.map((n=>n.toLowerCase())).filter((n=>{var i;return $(i=Object.keys(ic)).call(i,n)})))}})),this._gateway.signal.on(ft.VOS_FALLBACK_PROMISE,(async(t,e,n)=>{if(t==="FALLBACKCN"&&I("ENABLE_QUALITY_FALLBACK")){if(!this._joinInfo)return n(new B(A.UNEXPECTED_ERROR,"can not recover, no join info"));m.info("[".concat(this._clientId,"] try fallback to cn, start request new server info"));const r=this._joinInfo.apRequestDetail;try{this._joinInfo.apRequestDetail=t;const s=await L_(this._joinInfo,this._axiosCancelSource.token,this._config.httpRetryConfig||fn,this.store);if(I("QUALITY_FALLBACK_REHEARSAL"))return pt.reportApiInvoke(this._sessionId,{name:Ge.VOS_FALLBACK_CN,options:{cur:s.gatewayInfo.gatewayAddrs,prev:this._joinInfo.gatewayAddrs,is_done:!1},tag:Ne.TRACER}).onSuccess(),this._joinInfo.apRequestDetail=r,void n();this._fallbackServerInfo=s,e()}catch(s){var i;const o=s==null||(i=s.data)===null||i===void 0?void 0:i.desc;I("QUALITY_FALLBACK_REHEARSAL")?(pt.reportApiInvoke(this._sessionId,{name:Ge.VOS_FALLBACK_CN,options:{cur:"failed, errorReason: "+o||"unknown",prev:this._joinInfo.gatewayAddrs,is_done:!1},tag:Ne.TRACER}).onSuccess(),this._joinInfo.apRequestDetail=r):Array.isArray(o)&&$(o).call(o,"request downgrade fallback")&&this.safeEmit(qt.FALLBACK_TO_HLS,Qg.AP_ERROR),n(s)}}else n()}))}_handleP2PEvents(){this._gateway.signal.on(Lt.ON_USER_OFFLINE,(()=>{this._p2pChannel.disconnectForReconnect()})),this._gateway.signal.on(cn.PUBLISH,((t,e,n)=>{const{uid:i}=t;t.forEach((r=>{const{kind:s,ssrcs:o,mid:a,isMuted:c}=r;this._handleP2PAddAudioOrVideoStream(s,i,o[0].ssrcId,a);const d=this._users.find((l=>l.uid===i));return d&&this.store.useP2P?this._p2pChannel.mockSubscribe(d,s,o[0].ssrcId,a).then((()=>{e()})).catch(n):e(),this._handleMuteStream(i,s,!!c)}))})),this._gateway.signal.on(cn.CALL,(async(t,e,n)=>{if(this.store.useP2P)try{var i;e(await this._p2pChannel.startP2P({turnServer:(i=this._joinInfo)===null||i===void 0?void 0:i.turnServer},t))}catch(r){n(r)}})),this._gateway.signal.on(ft.P2P_CONNECTION,(async t=>{this.store.useP2P&&(await this._p2pChannel).p2pConnect(t)})),this._gateway.signal.on(cn.UNPUBLISH,(async(t,e,n)=>{if(this.store.useP2P){const{unpubMsg:i,uid:r}=t,s=this._users.find((o=>o.uid===r));if(!s)return m.warning("[".concat(this._clientId,"] can not find remote user, ignore mute event, uid: ").concat(r)),void e();try{i.forEach((async o=>{let{stream_type:a}=o;const c=a===Re.Audio?ut.AUDIO:ut.VIDEO;await this._p2pChannel.unsubscribe(s,c),this._handleMuteStream(r,c,!0)})),e()}catch(o){n(o)}}})),this._gateway.signal.on(cn.CONTROL,(async(t,e)=>{const{action:n}=t;switch(n){case ua.MUTE_LOCAL_VIDEO:this._handleMuteStream(e,ut.VIDEO,!0);break;case ua.MUTE_LOCAL_AUDIO:this._handleMuteStream(e,ut.AUDIO,!0);break;case ua.UNMUTE_LOCAL_VIDEO:this._handleP2PAddAudioOrVideoStream("video",e),this._handleMuteStream(e,ut.VIDEO,!1);break;case ua.UNMUTE_LOCAL_AUDIO:this._handleP2PAddAudioOrVideoStream("audio",e),this._handleMuteStream(e,ut.AUDIO,!1)}})),this._gateway.signal.on(cn.RESTART_ICE,(async(t,e,n)=>{if(this.store.useP2P)try{const{direction:i,iceParameter:r}=t;i!==Ti.SEND_ONLY||r?e(await this._p2pChannel.restartICE(i,r)):(this._p2pChannel.handleDisconnect(i),e())}catch(i){n(i)}})),this._gateway.signal.on(cn.CANDIDATE,(t=>{if(this.store.useP2P){const{candidate:e,direction:n}=t;this._p2pChannel.addRemoteCandidate(e,n)}})),this._p2pChannel.on(Rt.RequestP2PRestartICE,(async(t,e,n)=>{try{const{direction:i}=t;e(await this._gateway.sendExtensionMessage(cn.RESTART_ICE,t,i===Ti.SEND_ONLY))}catch(i){n(i)}})),this._p2pChannel.on(Rt.LocalCandidate,(t=>{this._gateway.sendExtensionMessage(cn.CANDIDATE,JSON.stringify(t),!0)})),this._p2pChannel.on(Rt.RequestP2PMuteLocal,(async(t,e,n)=>{try{await this._gateway.sendExtensionMessage(cn.CONTROL,t,!0),e()}catch(i){n(i)}})),this._p2pChannel.on(Rt.RequestP2PUnmuteRemote,(async(t,e,n)=>{if(this._joinInfo)try{await this._gateway.unmuteRemote(t,this._joinInfo.stringUid||this._joinInfo.uid),e()}catch(i){i.code===A.DISCONNECT_P2P?e():n(i)}else e()})),this._p2pChannel.on(Rt.RequestP2PMuteRemote,(async(t,e,n)=>{if(this._joinInfo)try{await this._gateway.muteRemote(t,this._joinInfo.stringUid||this._joinInfo.uid),e()}catch(i){i.code===A.DISCONNECT_P2P?e():n(i)}else e()})),this._p2pChannel.on(Rt.StateChange,((t,e)=>{e===me.Connected&&this._p2pChannel.republish()}))}_handleP2PChannelEvents(){this._p2pChannel.on(Rt.PeerConnectionStateChange,(t=>{const e=this._peerConnectionState;t!==e&&(this.safeEmit(qt.PEERCONNECTION_STATE_CHANGE,t,e),this._peerConnectionState=t)})),this._p2pChannel.on(Rt.RequestMuteLocal,(async(t,e,n)=>{if(this._joinInfo)try{await this._gateway.muteLocal(t,this._joinInfo.stringUid||this._joinInfo.uid),e()}catch(i){i.code===A.DISCONNECT_P2P?e():n(i)}else e()})),this._p2pChannel.on(Rt.RequestUnmuteLocal,(async(t,e,n)=>{if(this._joinInfo)try{await this._gateway.unmuteLocal(t,this._joinInfo.stringUid||this._joinInfo.uid),e()}catch(i){i.code===A.DISCONNECT_P2P?e():n(i)}else e()})),this._p2pChannel.on(Rt.RequestRePublish,((t,e,n)=>{this.publish(t,!1).then(e).catch(n)})),this._p2pChannel.on(Rt.RequestRePublishDataChannel,((t,e,n)=>{st.all(t.map((async i=>{const r=await this._p2pChannel.publishDataChannel([i]);try{r.forEach((s=>{this._uid&&this._gateway.publishDataChannel(this._uid,s,!0)}))}catch(s){if(s.code!==A.DISCONNECT_P2P)throw s}}))).then(e).catch(n)})),this._p2pChannel.on(Rt.RequestReSubscribe,(async(t,e,n)=>{try{for(const{user:i,kind:r}of t)r===ut.VIDEO?await this.subscribe(i,"video"):await this.subscribe(i,"audio");e()}catch(i){n(i)}})),this._p2pChannel.on(Rt.RequestUpload,((t,e)=>{this._gateway.upload(t,e)})),this._p2pChannel.on(Rt.RequestUploadStats,(t=>{this._gateway.uploadWRTCStats(t)})),this._p2pChannel.on(Rt.MediaReconnectStart,(t=>{this.safeEmit(qt.MEDIA_RECONNECT_START,t)})),this._p2pChannel.on(Rt.MediaReconnectEnd,(t=>{this.safeEmit(qt.MEDIA_RECONNECT_END,t)})),this._p2pChannel.on(Rt.NeedSignalRTT,(t=>{t(this._gateway.getSignalRTT())})),this._p2pChannel.on(Rt.RequestRestartICE,(async t=>{if(this.store.useP2P)return;const e=await this._p2pChannel.restartICE(t),n=await e.next();if(n.done)return;const i=n.value;let r;try{r=await this._gateway.restartICE({iceParameters:i})}catch(o){return void e.throw(o)}const{iceParameters:s}=(function(o){const a=o.iceParameters;return{iceParameters:{iceUfrag:a.iceUfrag,icePwd:a.icePwd}}})(r);await e.next({remoteIceParameters:s})})),this._p2pChannel.on(Rt.RequestReconnect,(async()=>{this._gateway.reconnect()})),this._p2pChannel.on(Rt.RequestReconnectPC,(async()=>{var t;const{iceParameters:e,dtlsParameters:n,rtpCapabilities:i}=await this._p2pChannel.startP2PConnection({turnServer:(t=this._joinInfo)===null||t===void 0?void 0:t.turnServer}),{gatewayEstablishParams:r,gatewayAddress:s}=await this._gateway.reconnectPC({iceParameters:e,dtlsParameters:n,rtpCapabilities:i}),o=$D(r,s);await this._p2pChannel.connect(o),await this._p2pChannel.republish(),await this._p2pChannel.reSubscribe()})),this._p2pChannel.on(Rt.RequestUnpublishForReconnectPC,(async(t,e,n)=>{this._joinInfo&&this._uid!==void 0?(await this._gateway.unpublish(t,this._uid),e()):n()})),this._p2pChannel.on(Rt.P2PLost,(()=>{this.safeEmit(qt.P2P_LOST,this.store.uid)})),this._p2pChannel.on(Rt.UpdateVideoEncoder,(t=>{t._encoderConfig&&this._gateway.setVideoProfile(t._encoderConfig)})),this._p2pChannel.on(Rt.ConnectionTypeChange,(t=>{this.safeEmit(qt.IS_USING_CLOUD_PROXY,t),this._gateway.setUsingProxy(t)})),this._p2pChannel.on(Rt.FirstVideoBufferReady,((t,e)=>{this.safeEmit(qt.FIRST_VIDEO_BUFFER_READY,t,e)})),this._p2pChannel.on(Rt.FirstVideoPreRender,((t,e)=>{this.safeEmit(qt.FIRST_VIDEO_PRE_RENDER,t,e)})),this._p2pChannel.on(Rt.RequestLowStreamParameter,(t=>{t(this._lowStreamParameter||{width:160,height:120,framerate:15,bitrate:50})})),this._p2pChannel.on(Rt.QueryClientConnectionState,(t=>{t(this.connectionState)})),this._p2pChannel.on(Rt.AudioMetadata,(t=>{this.safeEmit(qt.AUDIO_METADATA,t)})),this._p2pChannel.on(Rt.AudioPts,(t=>{this.safeEmit(qt.AUDIO_PTS,Number(t))}))}getKeyMetrics(){return this.store.keyMetrics}async enableContentInspect(t){if(!this._joinInfo||this.connectionState!=="CONNECTED")throw new B(A.INVALID_OPERATION,"[".concat(this._clientId,"] can not create content inspect, please join channel first"));if(this._inspect)throw new B(A.INVALID_OPERATION,"[".concat(this._clientId,"] Inspect content service already in connecting/connected state"));try{const n=(e={config:t},bs("ContentInspect").create(e));this._inspect=n,this.handleVideoInspectEvents(n);const{appId:i,cname:r,sid:s,token:o,uid:a,cid:c,vid:d}=this._joinInfo;await n.init({appId:i,areaCode:"",cname:r,sid:s,token:o,uid:a,cid:c,vid:d?Number(d):0},fn)}catch(n){throw Array.isArray(n)?n[0]:n}var e}handleVideoInspectEvents(t){t.on(Vn.CONNECTION_STATE_CHANGE,((e,n)=>{if(this.safeEmit(qt.CONTENT_INSPECT_CONNECTION_STATE_CHANGE,e,n),n===is.CONNECTED){if(this.connectionState!=="CONNECTED")return void this.safeEmit(qt.CONTENT_INSPECT_ERROR,new B(A.OPERATION_ABORTED,"Content inspect was cancelled because it left the channel"));t.inspectImage()}})),t.on(Vn.INSPECT_RESULT,((e,n)=>{var i;if(n?.code===A.INVALID_OPERATION&&this.connectionState==="DISCONNECTED")return m.debug("Stop inspect content because that has left channel"),this==null||(i=this._inspect)===null||i===void 0||i.close(),void(this._inspect=void 0);this.safeEmit(qt.CONTENT_INSPECT_RESULT,e,n)})),t.on(Vn.CLIENT_LOCAL_VIDEO_TRACK,(e=>{e(this.localTracks.filter((n=>n.trackMediaType==="video"))[0])}))}async disableContentInspect(){if(!this._inspect)throw new B(A.INVALID_OPERATION,"[".concat(this._clientId,"] inspectVideoContent not started"));try{this._inspect.close(),this._inspect=void 0}catch(t){throw Array.isArray(t)?t[0]:t}}async setImageModeration(t,e){if(Zr(t,"enabled"),t){if(!e)throw new B(A.INVALID_PARAMS,"config is required");if(pL(e),!this._joinInfo)throw new B(A.INVALID_OPERATION,"can not create image moderation, please join channel first");try{if(this._moderation)this._moderation.updateConfig(e);else{const i=(n={config:e},bs("ImageModeration").create(n));this._moderation=i,this.handleImageModerationEvents(i);const{appId:r,cname:s,sid:o,token:a,uid:c,cid:d,vid:l}=this._joinInfo;await i.init({appId:r,areaCode:"",cname:s,sid:o,token:a,uid:c,cid:d,vid:l?Number(l):0},fn)}}catch(i){throw Array.isArray(i)?i[0]:i}}else{var n;if(!this._moderation)throw new B(A.INVALID_OPERATION,"[".concat(this._clientId,"] image moderation not started"));try{this._moderation.close(),this._moderation.removeAllListeners(),this._moderation=void 0}catch(i){throw Array.isArray(i)?i[0]:i}}}handleImageModerationEvents(t){t.on(Is.CONNECTION_STATE_CHANGE,((e,n)=>{if(this.safeEmit(qt.IMAGE_MODERATION_CONNECTION_STATE_CHANGE,e,n),e===Pr.CONNECTED){if(this.connectionState!=="CONNECTED")throw this.setImageModeration(!1),new B(A.OPERATION_ABORTED,"Image moderation was cancelled because it left the channel");t.inspectImage()}})),t.on(Is.CLIENT_LOCAL_VIDEO_TRACK,(e=>{e(this.localTracks.filter((n=>n.trackMediaType==="video"))[0])}))}setP2PTransport(t){if((function(e){_n(e,"transport",["default","auto","relay","sd-rtn"])})(t),this.mode!=="p2p")throw new B(A.INVALID_OPERATION,"only p2p mode can set p2pTransport");this.store.p2pTransport=t,m.info("[".concat(this._clientId,"] set client p2pTransport to ").concat(t))}getJoinChannelServiceRecords(){return m.debug("getJoinChannelServiceRecords"),this.store.joinChannelServiceRecords}async setPublishAudioFilterEnabled(t){Zr(t,"enabled"),ye("ENABLE_PUBLISH_AUDIO_FILTER",t),this._joinInfo&&await this._gateway.setPublishAudioFilterEnabled(t)}_setRteInfo(t,e){this.store.rteUrl=t,this.store.rteSid=e}_isPreRender(){return"isPreRender"in this._p2pChannel&&this._p2pChannel.isPreRender()}_handleResetAddStream(t,e){switch(e){case"audio":t._audio_added_=!1,t._trust_audio_stream_added_state_=!0;break;case"video":t._video_added_=!1,t._trust_video_stream_added_state_=!0}}},ot(lt.prototype,"leave",[_L],Object.getOwnPropertyDescriptor(lt.prototype,"leave"),lt.prototype),ot(lt.prototype,"publish",[fL],Object.getOwnPropertyDescriptor(lt.prototype,"publish"),lt.prototype),ot(lt.prototype,"unpublish",[mL],Object.getOwnPropertyDescriptor(lt.prototype,"unpublish"),lt.prototype),ot(lt.prototype,"subscribe",[EL],Object.getOwnPropertyDescriptor(lt.prototype,"subscribe"),lt.prototype),ot(lt.prototype,"presubscribe",[gL],Object.getOwnPropertyDescriptor(lt.prototype,"presubscribe"),lt.prototype),ot(lt.prototype,"massSubscribe",[SL],Object.getOwnPropertyDescriptor(lt.prototype,"massSubscribe"),lt.prototype),ot(lt.prototype,"unsubscribe",[TL],Object.getOwnPropertyDescriptor(lt.prototype,"unsubscribe"),lt.prototype),ot(lt.prototype,"massUnsubscribe",[RL],Object.getOwnPropertyDescriptor(lt.prototype,"massUnsubscribe"),lt.prototype),ot(lt.prototype,"setLowStreamParameter",[vL],Object.getOwnPropertyDescriptor(lt.prototype,"setLowStreamParameter"),lt.prototype),ot(lt.prototype,"setDualStreamMode",[CL],Object.getOwnPropertyDescriptor(lt.prototype,"setDualStreamMode"),lt.prototype),ot(lt.prototype,"enableDualStream",[yL],Object.getOwnPropertyDescriptor(lt.prototype,"enableDualStream"),lt.prototype),ot(lt.prototype,"disableDualStream",[IL],Object.getOwnPropertyDescriptor(lt.prototype,"disableDualStream"),lt.prototype),ot(lt.prototype,"setClientRole",[bL],Object.getOwnPropertyDescriptor(lt.prototype,"setClientRole"),lt.prototype),ot(lt.prototype,"_setClientRoleOptions",[AL],Object.getOwnPropertyDescriptor(lt.prototype,"_setClientRoleOptions"),lt.prototype),ot(lt.prototype,"setProxyServer",[wL],Object.getOwnPropertyDescriptor(lt.prototype,"setProxyServer"),lt.prototype),ot(lt.prototype,"setTurnServer",[OL],Object.getOwnPropertyDescriptor(lt.prototype,"setTurnServer"),lt.prototype),ot(lt.prototype,"setLicense",[NL],Object.getOwnPropertyDescriptor(lt.prototype,"setLicense"),lt.prototype),ot(lt.prototype,"startProxyServer",[DL],Object.getOwnPropertyDescriptor(lt.prototype,"startProxyServer"),lt.prototype),ot(lt.prototype,"stopProxyServer",[PL],Object.getOwnPropertyDescriptor(lt.prototype,"stopProxyServer"),lt.prototype),ot(lt.prototype,"setLocalAccessPointsV2",[LL],Object.getOwnPropertyDescriptor(lt.prototype,"setLocalAccessPointsV2"),lt.prototype),ot(lt.prototype,"setLocalAccessPoints",[kL],Object.getOwnPropertyDescriptor(lt.prototype,"setLocalAccessPoints"),lt.prototype),ot(lt.prototype,"setRemoteDefaultVideoStreamType",[ML],Object.getOwnPropertyDescriptor(lt.prototype,"setRemoteDefaultVideoStreamType"),lt.prototype),ot(lt.prototype,"setRemoteVideoStreamType",[UL],Object.getOwnPropertyDescriptor(lt.prototype,"setRemoteVideoStreamType"),lt.prototype),ot(lt.prototype,"setStreamFallbackOption",[xL],Object.getOwnPropertyDescriptor(lt.prototype,"setStreamFallbackOption"),lt.prototype),ot(lt.prototype,"setEncryptionConfig",[VL],Object.getOwnPropertyDescriptor(lt.prototype,"setEncryptionConfig"),lt.prototype),ot(lt.prototype,"renewToken",[FL],Object.getOwnPropertyDescriptor(lt.prototype,"renewToken"),lt.prototype),ot(lt.prototype,"enableAudioVolumeIndicator",[BL],Object.getOwnPropertyDescriptor(lt.prototype,"enableAudioVolumeIndicator"),lt.prototype),ot(lt.prototype,"startLiveStreaming",[jL],Object.getOwnPropertyDescriptor(lt.prototype,"startLiveStreaming"),lt.prototype),ot(lt.prototype,"setLiveTranscoding",[GL],Object.getOwnPropertyDescriptor(lt.prototype,"setLiveTranscoding"),lt.prototype),ot(lt.prototype,"stopLiveStreaming",[WL],Object.getOwnPropertyDescriptor(lt.prototype,"stopLiveStreaming"),lt.prototype),ot(lt.prototype,"startChannelMediaRelay",[HL],Object.getOwnPropertyDescriptor(lt.prototype,"startChannelMediaRelay"),lt.prototype),ot(lt.prototype,"updateChannelMediaRelay",[KL],Object.getOwnPropertyDescriptor(lt.prototype,"updateChannelMediaRelay"),lt.prototype),ot(lt.prototype,"stopChannelMediaRelay",[YL],Object.getOwnPropertyDescriptor(lt.prototype,"stopChannelMediaRelay"),lt.prototype),ot(lt.prototype,"sendCustomReportMessage",[qL],Object.getOwnPropertyDescriptor(lt.prototype,"sendCustomReportMessage"),lt.prototype),ot(lt.prototype,"pickSVCLayer",[zL],Object.getOwnPropertyDescriptor(lt.prototype,"pickSVCLayer"),lt.prototype),ot(lt.prototype,"setRTMConfig",[XL],Object.getOwnPropertyDescriptor(lt.prototype,"setRTMConfig"),lt.prototype),ot(lt.prototype,"enableContentInspect",[JL],Object.getOwnPropertyDescriptor(lt.prototype,"enableContentInspect"),lt.prototype),ot(lt.prototype,"disableContentInspect",[QL],Object.getOwnPropertyDescriptor(lt.prototype,"disableContentInspect"),lt.prototype),ot(lt.prototype,"setImageModeration",[ZL],Object.getOwnPropertyDescriptor(lt.prototype,"setImageModeration"),lt.prototype),ot(lt.prototype,"setP2PTransport",[$L],Object.getOwnPropertyDescriptor(lt.prototype,"setP2PTransport"),lt.prototype),ot(lt.prototype,"getJoinChannelServiceRecords",[tk],Object.getOwnPropertyDescriptor(lt.prototype,"getJoinChannelServiceRecords"),lt.prototype),ot(lt.prototype,"setPublishAudioFilterEnabled",[ek],Object.getOwnPropertyDescriptor(lt.prototype,"setPublishAudioFilterEnabled"),lt.prototype),lt);function ik(){var t;let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{codec:"vp8",audioCodec:"opus",mode:"rtc"};const n=Se(5,"client-"),i=pt.reportApiInvoke(null,{id:n,name:Ge.CREATE_CLIENT,options:[e],tag:Ne.TRACER});try{(function(r){_n(r.codec,"config.codec",["vp8","vp9","av1","h264","h265"]),_n(r.mode,"config.mode",["rtc","live","p2p"]),r.audioCodec!==void 0&&_n(r.audioCodec,"config.audioCodec",["opus","pcmu","pcma","g722"]),r.proxyServer!==void 0&&Kn(r.proxyServer,"config.proxyServer",1,1e4),r.turnServer!==void 0&&MO(r.turnServer),r.httpRetryConfig!==void 0&&kO(r.httpRetryConfig),r.websocketRetryConfig!==void 0&&kO(r.websocketRetryConfig)})(e)}catch(r){throw i.onError(r),r}return(RO(16,0,!0)||Hg(16,0,!0))&&(e.codec==="vp9"&&(e.codec="vp8",m.debug("browser not support vp9, force use vp8")),ye("UNSUPPORTED_VIDEO_CODEC",["vp9"])),e.audioCodec===void 0&&(e.audioCodec="opus"),i.onSuccess(),new uq(cs(cs({forceWaitGatewayResponse:!0},e),{},{role:$(t=["rtc","p2p"]).call(t,e.mode)?"host":e.role||"audience"}),n)}function hq(){let t=!1;const e=de();return(e.name===he.CHROME&&Number(e.version)>=58&&(Ts.engine.name!=="WebKit"||(function(){const n=de();if(Gp()){if(n.os===On.MAC_OS)return!0;if(n.os===On.IOS){const i=Ts.os.version&&Ts.os.version.split(".");if(i&&Number(i[0])===14&&i[1]&&Number(i[1])>=3||i&&Number(i[0])>14)return!0}}return!1})())||e.name===he.FIREFOX&&Number(e.version)>=56||e.name===he.OPERA&&Number(e.version)>=45||e.name===he.SAFARI&&Number(e.version)>=11||e.name==="WebKit"&&(si()||Qr())&&e.osVersion&&Number(e.osVersion.split(".")[0])>=11||yO()||de().name===he.QQ)&&(t=!0),t}class Au{constructor(e,n){R(this,"id",0),R(this,"element",void 0),R(this,"peerPair",void 0),R(this,"context",void 0),R(this,"audioPlayerElement",void 0),R(this,"audioTrack",void 0),Au.count+=1,this.id=Au.count,this.element=e,this.context=n}initPeers(){this.peerPair=[new RTCPeerConnection,new RTCPeerConnection],this.peerPair[1].ontrack=e=>{const n=document.createElement("audio");n.srcObject=new MediaStream([e.track]),n.play(),this.audioPlayerElement=n}}async switchSdp(){if(!this.peerPair)return;const e=async(i,r)=>{const s=r==="offer"?await i.createOffer():await i.createAnswer();return await i.setLocalDescription(s),i.iceGatheringState==="complete"?i.localDescription:new st((o=>{i.onicegatheringstatechange=()=>{i.iceGatheringState==="complete"&&o(i.localDescription)}}))},n=async(i,r)=>await i.setRemoteDescription(r);try{const i=await e(this.peerPair[0],"offer");await n(this.peerPair[1],i);const r=await e(this.peerPair[1],"answer");await n(this.peerPair[0],r)}catch(i){throw new B(A.LOCAL_AEC_ERROR,i.toString()).print()}}async getTracksFromMediaElement(e){if(this.audioTrack)return this.audioTrack;let n;try{e instanceof HTMLVideoElement&&(e.captureStream?e.captureStream():e.mozCaptureStream()),n=this.context.createMediaStreamDestination(),this.context.createMediaElementSource(e).connect(n)}catch(r){throw new B(A.LOCAL_AEC_ERROR,r.toString()).print()}if(!n)throw new B(A.LOCAL_AEC_ERROR,"no dest node when local aec").print();const i=n.stream.getAudioTracks()[0];return this.audioTrack=i,i}getElement(){return this.element}async startEchoCancellation(){this.context.resume(),this.peerPair&&this.close(),this.initPeers();const e=this.element,n=await this.getTracksFromMediaElement(e);this.peerPair&&this.peerPair[0].addTrack(n),await this.switchSdp()}close(){m.debug("close echo cancellation unit, id is",this.id),this.audioPlayerElement&&this.audioPlayerElement.pause(),this.peerPair&&this.peerPair.forEach((e=>{e.close()})),this.peerPair=void 0,this.audioPlayerElement=void 0}}var rk,Y_;R(Au,"count",0);const pq=window.AudioContext||window.webkitAudioContext,_q=new(rk=At({report:pt}),ot((Y_=class{constructor(){R(this,"units",[]),R(this,"context",void 0)}processExternalMediaAEC(t){if(!this._doesEnvironmentNeedAEC())return m.debug("the system does not need to process local aec"),-1;this.context||(this.context=new pq);let e=this.units.find((n=>n&&n.getElement()===t));return e||(e=new Au(t,this.context),this.units.push(e)),e.startEchoCancellation(),m.debug("start processing local audio echo cancellation, id is",e.id),e.id}_doesEnvironmentNeedAEC(){return de().name!==he.SAFARI}}).prototype,"processExternalMediaAEC",[rk],Object.getOwnPropertyDescriptor(Y_.prototype,"processExternalMediaAEC"),Y_.prototype),Y_);function sk(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable}))),n.push.apply(n,i)}return n}function ok(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?sk(Object(n),!0).forEach((function(i){R(t,i,n[i])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):sk(Object(n)).forEach((function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i))}))}return t}const xT=window||document;function ak(t){let e=arguments.length>1&&arguments[1]!==void 0&&arguments[1];if(!xT)return;const n=Tn._cspEventHandlerPointer;if(n&&e)return void console.error(n,e);const i=r=>{if(!(r&&r.blockedURI&&(Tn.onSecurityPolicyViolation||Tn.getListeners(to.SECURITY_POLICY_VIOLATION).length>0)))return;const s=r.blockedURI;I("CSP_DETECTED_HOSTNAME_LIST").some((o=>$(s).call(s,o)))&&(Tn.onSecurityPolicyViolation&&typeof Tn.onSecurityPolicyViolation=="function"&&Tn.onSecurityPolicyViolation(r),Tn.getListeners(to.SECURITY_POLICY_VIOLATION).length>0&&Tn.safeEmit(to.SECURITY_POLICY_VIOLATION,r))};n&&xT.removeEventListener("securitypolicyviolation",n),(e||t&&typeof t=="function"||Tn.getListeners(to.SECURITY_POLICY_VIOLATION).length>0)&&xT.addEventListener("securitypolicyviolation",i),Tn._cspEventHandlerPointer=i}var fq=Z,mq=JE,ck=RegExp.prototype,Eq=function(t){return t===ck||fq(ck,t)?mq(t):t.flags},li=y(Eq);function Qd(t){let e=t.length;for(;--e>=0;)t[e]=0}const VT=256,dk=286,wu=30,Ou=15,FT=new Uint8Array([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0]),q_=new Uint8Array([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13]),gq=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7]),lk=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),ko=new Array(576);Qd(ko);const Nu=new Array(60);Qd(Nu);const Du=new Array(512);Qd(Du);const Pu=new Array(256);Qd(Pu);const BT=new Array(29);Qd(BT);const z_=new Array(wu);function jT(t,e,n,i,r){this.static_tree=t,this.extra_bits=e,this.extra_base=n,this.elems=i,this.max_length=r,this.has_stree=t&&t.length}let uk,hk,pk;function GT(t,e){this.dyn_tree=t,this.max_code=0,this.stat_desc=e}Qd(z_);const _k=t=>t<256?Du[t]:Du[256+(t>>>7)],Lu=(t,e)=>{t.pending_buf[t.pending++]=255&e,t.pending_buf[t.pending++]=e>>>8&255},Sr=(t,e,n)=>{t.bi_valid>16-n?(t.bi_buf|=e<<t.bi_valid&65535,Lu(t,t.bi_buf),t.bi_buf=e>>16-t.bi_valid,t.bi_valid+=n-16):(t.bi_buf|=e<<t.bi_valid&65535,t.bi_valid+=n)},oo=(t,e,n)=>{Sr(t,n[2*e],n[2*e+1])},fk=(t,e)=>{let n=0;do n|=1&t,t>>>=1,n<<=1;while(--e>0);return n>>>1},mk=(t,e,n)=>{const i=new Array(16);let r,s,o=0;for(r=1;r<=Ou;r++)o=o+n[r-1]<<1,i[r]=o;for(s=0;s<=e;s++){let a=t[2*s+1];a!==0&&(t[2*s]=fk(i[a]++,a))}},Ek=t=>{let e;for(e=0;e<dk;e++)t.dyn_ltree[2*e]=0;for(e=0;e<wu;e++)t.dyn_dtree[2*e]=0;for(e=0;e<19;e++)t.bl_tree[2*e]=0;t.dyn_ltree[512]=1,t.opt_len=t.static_len=0,t.sym_next=t.matches=0},gk=t=>{t.bi_valid>8?Lu(t,t.bi_buf):t.bi_valid>0&&(t.pending_buf[t.pending++]=t.bi_buf),t.bi_buf=0,t.bi_valid=0},Sk=(t,e,n,i)=>{const r=2*e,s=2*n;return t[r]<t[s]||t[r]===t[s]&&i[e]<=i[n]},WT=(t,e,n)=>{const i=t.heap[n];let r=n<<1;for(;r<=t.heap_len&&(r<t.heap_len&&Sk(e,t.heap[r+1],t.heap[r],t.depth)&&r++,!Sk(e,i,t.heap[r],t.depth));)t.heap[n]=t.heap[r],n=r,r<<=1;t.heap[n]=i},Tk=(t,e,n)=>{let i,r,s,o,a=0;if(t.sym_next!==0)do i=255&t.pending_buf[t.sym_buf+a++],i+=(255&t.pending_buf[t.sym_buf+a++])<<8,r=t.pending_buf[t.sym_buf+a++],i===0?oo(t,r,e):(s=Pu[r],oo(t,s+VT+1,e),o=FT[s],o!==0&&(r-=BT[s],Sr(t,r,o)),i--,s=_k(i),oo(t,s,n),o=q_[s],o!==0&&(i-=z_[s],Sr(t,i,o)));while(a<t.sym_next);oo(t,256,e)},HT=(t,e)=>{const n=e.dyn_tree,i=e.stat_desc.static_tree,r=e.stat_desc.has_stree,s=e.stat_desc.elems;let o,a,c,d=-1;for(t.heap_len=0,t.heap_max=573,o=0;o<s;o++)n[2*o]!==0?(t.heap[++t.heap_len]=d=o,t.depth[o]=0):n[2*o+1]=0;for(;t.heap_len<2;)c=t.heap[++t.heap_len]=d<2?++d:0,n[2*c]=1,t.depth[c]=0,t.opt_len--,r&&(t.static_len-=i[2*c+1]);for(e.max_code=d,o=t.heap_len>>1;o>=1;o--)WT(t,n,o);c=s;do o=t.heap[1],t.heap[1]=t.heap[t.heap_len--],WT(t,n,1),a=t.heap[1],t.heap[--t.heap_max]=o,t.heap[--t.heap_max]=a,n[2*c]=n[2*o]+n[2*a],t.depth[c]=(t.depth[o]>=t.depth[a]?t.depth[o]:t.depth[a])+1,n[2*o+1]=n[2*a+1]=c,t.heap[1]=c++,WT(t,n,1);while(t.heap_len>=2);t.heap[--t.heap_max]=t.heap[1],((l,h)=>{const p=h.dyn_tree,f=h.max_code,v=h.stat_desc.static_tree,S=h.stat_desc.has_stree,T=h.stat_desc.extra_bits,b=h.stat_desc.extra_base,w=h.stat_desc.max_length;let D,k,U,P,x,q,Q=0;for(P=0;P<=Ou;P++)l.bl_count[P]=0;for(p[2*l.heap[l.heap_max]+1]=0,D=l.heap_max+1;D<573;D++)k=l.heap[D],P=p[2*p[2*k+1]+1]+1,P>w&&(P=w,Q++),p[2*k+1]=P,k>f||(l.bl_count[P]++,x=0,k>=b&&(x=T[k-b]),q=p[2*k],l.opt_len+=q*(P+x),S&&(l.static_len+=q*(v[2*k+1]+x)));if(Q!==0){do{for(P=w-1;l.bl_count[P]===0;)P--;l.bl_count[P]--,l.bl_count[P+1]+=2,l.bl_count[w]--,Q-=2}while(Q>0);for(P=w;P!==0;P--)for(k=l.bl_count[P];k!==0;)U=l.heap[--D],U>f||(p[2*U+1]!==P&&(l.opt_len+=(P-p[2*U+1])*p[2*U],p[2*U+1]=P),k--)}})(t,e),mk(n,d,t.bl_count)},Rk=(t,e,n)=>{let i,r,s=-1,o=e[1],a=0,c=7,d=4;for(o===0&&(c=138,d=3),e[2*(n+1)+1]=65535,i=0;i<=n;i++)r=o,o=e[2*(i+1)+1],++a<c&&r===o||(a<d?t.bl_tree[2*r]+=a:r!==0?(r!==s&&t.bl_tree[2*r]++,t.bl_tree[32]++):a<=10?t.bl_tree[34]++:t.bl_tree[36]++,a=0,s=r,o===0?(c=138,d=3):r===o?(c=6,d=3):(c=7,d=4))},vk=(t,e,n)=>{let i,r,s=-1,o=e[1],a=0,c=7,d=4;for(o===0&&(c=138,d=3),i=0;i<=n;i++)if(r=o,o=e[2*(i+1)+1],!(++a<c&&r===o)){if(a<d)do oo(t,r,t.bl_tree);while(--a!=0);else r!==0?(r!==s&&(oo(t,r,t.bl_tree),a--),oo(t,16,t.bl_tree),Sr(t,a-3,2)):a<=10?(oo(t,17,t.bl_tree),Sr(t,a-3,3)):(oo(t,18,t.bl_tree),Sr(t,a-11,7));a=0,s=r,o===0?(c=138,d=3):r===o?(c=6,d=3):(c=7,d=4)}};let Ck=!1;const yk=(t,e,n,i)=>{Sr(t,0+(i?1:0),3),gk(t),Lu(t,n),Lu(t,~n),n&&t.pending_buf.set(t.window.subarray(e,e+n),t.pending),t.pending+=n};var Sq=t=>{Ck||((()=>{let e,n,i,r,s;const o=new Array(16);for(i=0,r=0;r<28;r++)for(BT[r]=i,e=0;e<1<<FT[r];e++)Pu[i++]=r;for(Pu[i-1]=r,s=0,r=0;r<16;r++)for(z_[r]=s,e=0;e<1<<q_[r];e++)Du[s++]=r;for(s>>=7;r<wu;r++)for(z_[r]=s<<7,e=0;e<1<<q_[r]-7;e++)Du[256+s++]=r;for(n=0;n<=Ou;n++)o[n]=0;for(e=0;e<=143;)ko[2*e+1]=8,e++,o[8]++;for(;e<=255;)ko[2*e+1]=9,e++,o[9]++;for(;e<=279;)ko[2*e+1]=7,e++,o[7]++;for(;e<=287;)ko[2*e+1]=8,e++,o[8]++;for(mk(ko,287,o),e=0;e<wu;e++)Nu[2*e+1]=5,Nu[2*e]=fk(e,5);uk=new jT(ko,FT,257,dk,Ou),hk=new jT(Nu,q_,0,wu,Ou),pk=new jT(new Array(0),gq,0,19,7)})(),Ck=!0),t.l_desc=new GT(t.dyn_ltree,uk),t.d_desc=new GT(t.dyn_dtree,hk),t.bl_desc=new GT(t.bl_tree,pk),t.bi_buf=0,t.bi_valid=0,Ek(t)},Tq=(t,e,n,i)=>{let r,s,o=0;t.level>0?(t.strm.data_type===2&&(t.strm.data_type=(a=>{let c,d=4093624447;for(c=0;c<=31;c++,d>>>=1)if(1&d&&a.dyn_ltree[2*c]!==0)return 0;if(a.dyn_ltree[18]!==0||a.dyn_ltree[20]!==0||a.dyn_ltree[26]!==0)return 1;for(c=32;c<VT;c++)if(a.dyn_ltree[2*c]!==0)return 1;return 0})(t)),HT(t,t.l_desc),HT(t,t.d_desc),o=(a=>{let c;for(Rk(a,a.dyn_ltree,a.l_desc.max_code),Rk(a,a.dyn_dtree,a.d_desc.max_code),HT(a,a.bl_desc),c=18;c>=3&&a.bl_tree[2*lk[c]+1]===0;c--);return a.opt_len+=3*(c+1)+5+5+4,c})(t),r=t.opt_len+3+7>>>3,s=t.static_len+3+7>>>3,s<=r&&(r=s)):r=s=n+5,n+4<=r&&e!==-1?yk(t,e,n,i):t.strategy===4||s===r?(Sr(t,2+(i?1:0),3),Tk(t,ko,Nu)):(Sr(t,4+(i?1:0),3),((a,c,d,l)=>{let h;for(Sr(a,c-257,5),Sr(a,d-1,5),Sr(a,l-4,4),h=0;h<l;h++)Sr(a,a.bl_tree[2*lk[h]+1],3);vk(a,a.dyn_ltree,c-1),vk(a,a.dyn_dtree,d-1)})(t,t.l_desc.max_code+1,t.d_desc.max_code+1,o+1),Tk(t,t.dyn_ltree,t.dyn_dtree)),Ek(t),i&&gk(t)},Rq=(t,e,n)=>(t.pending_buf[t.sym_buf+t.sym_next++]=e,t.pending_buf[t.sym_buf+t.sym_next++]=e>>8,t.pending_buf[t.sym_buf+t.sym_next++]=n,e===0?t.dyn_ltree[2*n]++:(t.matches++,e--,t.dyn_ltree[2*(Pu[n]+VT+1)]++,t.dyn_dtree[2*_k(e)]++),t.sym_next===t.sym_end),vq=t=>{Sr(t,2,3),oo(t,256,ko),(e=>{e.bi_valid===16?(Lu(e,e.bi_buf),e.bi_buf=0,e.bi_valid=0):e.bi_valid>=8&&(e.pending_buf[e.pending++]=255&e.bi_buf,e.bi_buf>>=8,e.bi_valid-=8)})(t)},Cq={_tr_init:Sq,_tr_stored_block:yk,_tr_flush_block:Tq,_tr_tally:Rq,_tr_align:vq},ku=(t,e,n,i)=>{let r=65535&t|0,s=t>>>16&65535|0,o=0;for(;n!==0;){o=n>2e3?2e3:n,n-=o;do r=r+e[i++]|0,s=s+r|0;while(--o);r%=65521,s%=65521}return r|s<<16|0};const yq=new Uint32Array((()=>{let t,e=[];for(var n=0;n<256;n++){t=n;for(var i=0;i<8;i++)t=1&t?3988292384^t>>>1:t>>>1;e[n]=t}return e})());var Ri=(t,e,n,i)=>{const r=yq,s=i+n;t^=-1;for(let o=i;o<s;o++)t=t>>>8^r[255&(t^e[o])];return-1^t},Tc={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"},X_={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_MEM_ERROR:-4,Z_BUF_ERROR:-5,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_UNKNOWN:2,Z_DEFLATED:8};const{_tr_init:Iq,_tr_stored_block:KT,_tr_flush_block:bq,_tr_tally:ga,_tr_align:Aq}=Cq,{Z_NO_FLUSH:Sa,Z_PARTIAL_FLUSH:wq,Z_FULL_FLUSH:Oq,Z_FINISH:ds,Z_BLOCK:Ik,Z_OK:Ni,Z_STREAM_END:bk,Z_STREAM_ERROR:ao,Z_DATA_ERROR:Nq,Z_BUF_ERROR:YT,Z_DEFAULT_COMPRESSION:Dq,Z_FILTERED:Pq,Z_HUFFMAN_ONLY:J_,Z_RLE:Lq,Z_FIXED:kq,Z_DEFAULT_STRATEGY:Mq,Z_UNKNOWN:Uq,Z_DEFLATED:Q_}=X_,qT=286,xq=30,Vq=19,Fq=2*qT+1,Bq=15,Rc=258,co=262,Zd=42,vc=113,Mu=666,Cc=(t,e)=>(t.msg=Tc[e],e),Ak=t=>2*t-(t>4?9:0),Ta=t=>{let e=t.length;for(;--e>=0;)t[e]=0},jq=t=>{let e,n,i,r=t.w_size;e=t.hash_size,i=e;do n=t.head[--i],t.head[i]=n>=r?n-r:0;while(--e);e=r,i=e;do n=t.prev[--i],t.prev[i]=n>=r?n-r:0;while(--e)};let Ra=(t,e,n)=>(e<<t.hash_shift^n)&t.hash_mask;const Lr=t=>{const e=t.state;let n=e.pending;n>t.avail_out&&(n=t.avail_out),n!==0&&(t.output.set(e.pending_buf.subarray(e.pending_out,e.pending_out+n),t.next_out),t.next_out+=n,e.pending_out+=n,t.total_out+=n,t.avail_out-=n,e.pending-=n,e.pending===0&&(e.pending_out=0))},kr=(t,e)=>{bq(t,t.block_start>=0?t.block_start:-1,t.strstart-t.block_start,e),t.block_start=t.strstart,Lr(t.strm)},on=(t,e)=>{t.pending_buf[t.pending++]=e},Uu=(t,e)=>{t.pending_buf[t.pending++]=e>>>8&255,t.pending_buf[t.pending++]=255&e},zT=(t,e,n,i)=>{let r=t.avail_in;return r>i&&(r=i),r===0?0:(t.avail_in-=r,e.set(t.input.subarray(t.next_in,t.next_in+r),n),t.state.wrap===1?t.adler=ku(t.adler,e,r,n):t.state.wrap===2&&(t.adler=Ri(t.adler,e,r,n)),t.next_in+=r,t.total_in+=r,r)},wk=(t,e)=>{let n,i,r=t.max_chain_length,s=t.strstart,o=t.prev_length,a=t.nice_match;const c=t.strstart>t.w_size-co?t.strstart-(t.w_size-co):0,d=t.window,l=t.w_mask,h=t.prev,p=t.strstart+Rc;let f=d[s+o-1],v=d[s+o];t.prev_length>=t.good_match&&(r>>=2),a>t.lookahead&&(a=t.lookahead);do if(n=e,d[n+o]===v&&d[n+o-1]===f&&d[n]===d[s]&&d[++n]===d[s+1]){s+=2,n++;do;while(d[++s]===d[++n]&&d[++s]===d[++n]&&d[++s]===d[++n]&&d[++s]===d[++n]&&d[++s]===d[++n]&&d[++s]===d[++n]&&d[++s]===d[++n]&&d[++s]===d[++n]&&s<p);if(i=Rc-(p-s),s=p-Rc,i>o){if(t.match_start=e,o=i,i>=a)break;f=d[s+o-1],v=d[s+o]}}while((e=h[e&l])>c&&--r!=0);return o<=t.lookahead?o:t.lookahead},$d=t=>{const e=t.w_size;let n,i,r;do{if(i=t.window_size-t.lookahead-t.strstart,t.strstart>=e+(e-co)&&(t.window.set(t.window.subarray(e,e+e-i),0),t.match_start-=e,t.strstart-=e,t.block_start-=e,t.insert>t.strstart&&(t.insert=t.strstart),jq(t),i+=e),t.strm.avail_in===0)break;if(n=zT(t.strm,t.window,t.strstart+t.lookahead,i),t.lookahead+=n,t.lookahead+t.insert>=3)for(r=t.strstart-t.insert,t.ins_h=t.window[r],t.ins_h=Ra(t,t.ins_h,t.window[r+1]);t.insert&&(t.ins_h=Ra(t,t.ins_h,t.window[r+3-1]),t.prev[r&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=r,r++,t.insert--,!(t.lookahead+t.insert<3)););}while(t.lookahead<co&&t.strm.avail_in!==0)},Ok=(t,e)=>{let n,i,r,s=t.pending_buf_size-5>t.w_size?t.w_size:t.pending_buf_size-5,o=0,a=t.strm.avail_in;do{if(n=65535,r=t.bi_valid+42>>3,t.strm.avail_out<r||(r=t.strm.avail_out-r,i=t.strstart-t.block_start,n>i+t.strm.avail_in&&(n=i+t.strm.avail_in),n>r&&(n=r),n<s&&(n===0&&e!==ds||e===Sa||n!==i+t.strm.avail_in)))break;o=e===ds&&n===i+t.strm.avail_in?1:0,KT(t,0,0,o),t.pending_buf[t.pending-4]=n,t.pending_buf[t.pending-3]=n>>8,t.pending_buf[t.pending-2]=~n,t.pending_buf[t.pending-1]=~n>>8,Lr(t.strm),i&&(i>n&&(i=n),t.strm.output.set(t.window.subarray(t.block_start,t.block_start+i),t.strm.next_out),t.strm.next_out+=i,t.strm.avail_out-=i,t.strm.total_out+=i,t.block_start+=i,n-=i),n&&(zT(t.strm,t.strm.output,t.strm.next_out,n),t.strm.next_out+=n,t.strm.avail_out-=n,t.strm.total_out+=n)}while(o===0);return a-=t.strm.avail_in,a&&(a>=t.w_size?(t.matches=2,t.window.set(t.strm.input.subarray(t.strm.next_in-t.w_size,t.strm.next_in),0),t.strstart=t.w_size,t.insert=t.strstart):(t.window_size-t.strstart<=a&&(t.strstart-=t.w_size,t.window.set(t.window.subarray(t.w_size,t.w_size+t.strstart),0),t.matches<2&&t.matches++,t.insert>t.strstart&&(t.insert=t.strstart)),t.window.set(t.strm.input.subarray(t.strm.next_in-a,t.strm.next_in),t.strstart),t.strstart+=a,t.insert+=a>t.w_size-t.insert?t.w_size-t.insert:a),t.block_start=t.strstart),t.high_water<t.strstart&&(t.high_water=t.strstart),o?4:e!==Sa&&e!==ds&&t.strm.avail_in===0&&t.strstart===t.block_start?2:(r=t.window_size-t.strstart,t.strm.avail_in>r&&t.block_start>=t.w_size&&(t.block_start-=t.w_size,t.strstart-=t.w_size,t.window.set(t.window.subarray(t.w_size,t.w_size+t.strstart),0),t.matches<2&&t.matches++,r+=t.w_size,t.insert>t.strstart&&(t.insert=t.strstart)),r>t.strm.avail_in&&(r=t.strm.avail_in),r&&(zT(t.strm,t.window,t.strstart,r),t.strstart+=r,t.insert+=r>t.w_size-t.insert?t.w_size-t.insert:r),t.high_water<t.strstart&&(t.high_water=t.strstart),r=t.bi_valid+42>>3,r=t.pending_buf_size-r>65535?65535:t.pending_buf_size-r,s=r>t.w_size?t.w_size:r,i=t.strstart-t.block_start,(i>=s||(i||e===ds)&&e!==Sa&&t.strm.avail_in===0&&i<=r)&&(n=i>r?r:i,o=e===ds&&t.strm.avail_in===0&&n===i?1:0,KT(t,t.block_start,n,o),t.block_start+=n,Lr(t.strm)),o?3:1)},XT=(t,e)=>{let n,i;for(;;){if(t.lookahead<co){if($d(t),t.lookahead<co&&e===Sa)return 1;if(t.lookahead===0)break}if(n=0,t.lookahead>=3&&(t.ins_h=Ra(t,t.ins_h,t.window[t.strstart+3-1]),n=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart),n!==0&&t.strstart-n<=t.w_size-co&&(t.match_length=wk(t,n)),t.match_length>=3)if(i=ga(t,t.strstart-t.match_start,t.match_length-3),t.lookahead-=t.match_length,t.match_length<=t.max_lazy_match&&t.lookahead>=3){t.match_length--;do t.strstart++,t.ins_h=Ra(t,t.ins_h,t.window[t.strstart+3-1]),n=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart;while(--t.match_length!=0);t.strstart++}else t.strstart+=t.match_length,t.match_length=0,t.ins_h=t.window[t.strstart],t.ins_h=Ra(t,t.ins_h,t.window[t.strstart+1]);else i=ga(t,0,t.window[t.strstart]),t.lookahead--,t.strstart++;if(i&&(kr(t,!1),t.strm.avail_out===0))return 1}return t.insert=t.strstart<2?t.strstart:2,e===ds?(kr(t,!0),t.strm.avail_out===0?3:4):t.sym_next&&(kr(t,!1),t.strm.avail_out===0)?1:2},tl=(t,e)=>{let n,i,r;for(;;){if(t.lookahead<co){if($d(t),t.lookahead<co&&e===Sa)return 1;if(t.lookahead===0)break}if(n=0,t.lookahead>=3&&(t.ins_h=Ra(t,t.ins_h,t.window[t.strstart+3-1]),n=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart),t.prev_length=t.match_length,t.prev_match=t.match_start,t.match_length=2,n!==0&&t.prev_length<t.max_lazy_match&&t.strstart-n<=t.w_size-co&&(t.match_length=wk(t,n),t.match_length<=5&&(t.strategy===Pq||t.match_length===3&&t.strstart-t.match_start>4096)&&(t.match_length=2)),t.prev_length>=3&&t.match_length<=t.prev_length){r=t.strstart+t.lookahead-3,i=ga(t,t.strstart-1-t.prev_match,t.prev_length-3),t.lookahead-=t.prev_length-1,t.prev_length-=2;do++t.strstart<=r&&(t.ins_h=Ra(t,t.ins_h,t.window[t.strstart+3-1]),n=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart);while(--t.prev_length!=0);if(t.match_available=0,t.match_length=2,t.strstart++,i&&(kr(t,!1),t.strm.avail_out===0))return 1}else if(t.match_available){if(i=ga(t,0,t.window[t.strstart-1]),i&&kr(t,!1),t.strstart++,t.lookahead--,t.strm.avail_out===0)return 1}else t.match_available=1,t.strstart++,t.lookahead--}return t.match_available&&(i=ga(t,0,t.window[t.strstart-1]),t.match_available=0),t.insert=t.strstart<2?t.strstart:2,e===ds?(kr(t,!0),t.strm.avail_out===0?3:4):t.sym_next&&(kr(t,!1),t.strm.avail_out===0)?1:2};function lo(t,e,n,i,r){this.good_length=t,this.max_lazy=e,this.nice_length=n,this.max_chain=i,this.func=r}const xu=[new lo(0,0,0,0,Ok),new lo(4,4,8,4,XT),new lo(4,5,16,8,XT),new lo(4,6,32,32,XT),new lo(4,4,16,16,tl),new lo(8,16,32,32,tl),new lo(8,16,128,128,tl),new lo(8,32,128,256,tl),new lo(32,128,258,1024,tl),new lo(32,258,258,4096,tl)];function Gq(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=Q_,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new Uint16Array(2*Fq),this.dyn_dtree=new Uint16Array(2*(2*xq+1)),this.bl_tree=new Uint16Array(2*(2*Vq+1)),Ta(this.dyn_ltree),Ta(this.dyn_dtree),Ta(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new Uint16Array(Bq+1),this.heap=new Uint16Array(2*qT+1),Ta(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new Uint16Array(2*qT+1),Ta(this.depth),this.sym_buf=0,this.lit_bufsize=0,this.sym_next=0,this.sym_end=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}const Vu=t=>{if(!t)return 1;const e=t.state;return!e||e.strm!==t||e.status!==Zd&&e.status!==57&&e.status!==69&&e.status!==73&&e.status!==91&&e.status!==103&&e.status!==vc&&e.status!==Mu?1:0},Nk=t=>{if(Vu(t))return Cc(t,ao);t.total_in=t.total_out=0,t.data_type=Uq;const e=t.state;return e.pending=0,e.pending_out=0,e.wrap<0&&(e.wrap=-e.wrap),e.status=e.wrap===2?57:e.wrap?Zd:vc,t.adler=e.wrap===2?0:1,e.last_flush=-2,Iq(e),Ni},Dk=t=>{const e=Nk(t);return e===Ni&&(n=>{n.window_size=2*n.w_size,Ta(n.head),n.max_lazy_match=xu[n.level].max_lazy,n.good_match=xu[n.level].good_length,n.nice_match=xu[n.level].nice_length,n.max_chain_length=xu[n.level].max_chain,n.strstart=0,n.block_start=0,n.lookahead=0,n.insert=0,n.match_length=n.prev_length=2,n.match_available=0,n.ins_h=0})(t.state),e},Pk=(t,e,n,i,r,s)=>{if(!t)return ao;let o=1;if(e===Dq&&(e=6),i<0?(o=0,i=-i):i>15&&(o=2,i-=16),r<1||r>9||n!==Q_||i<8||i>15||e<0||e>9||s<0||s>kq||i===8&&o!==1)return Cc(t,ao);i===8&&(i=9);const a=new Gq;return t.state=a,a.strm=t,a.status=Zd,a.wrap=o,a.gzhead=null,a.w_bits=i,a.w_size=1<<a.w_bits,a.w_mask=a.w_size-1,a.hash_bits=r+7,a.hash_size=1<<a.hash_bits,a.hash_mask=a.hash_size-1,a.hash_shift=~~((a.hash_bits+3-1)/3),a.window=new Uint8Array(2*a.w_size),a.head=new Uint16Array(a.hash_size),a.prev=new Uint16Array(a.w_size),a.lit_bufsize=1<<r+6,a.pending_buf_size=4*a.lit_bufsize,a.pending_buf=new Uint8Array(a.pending_buf_size),a.sym_buf=a.lit_bufsize,a.sym_end=3*(a.lit_bufsize-1),a.level=e,a.strategy=s,a.method=n,Dk(t)};var Wq=(t,e)=>{if(Vu(t)||e>Ik||e<0)return t?Cc(t,ao):ao;const n=t.state;if(!t.output||t.avail_in!==0&&!t.input||n.status===Mu&&e!==ds)return Cc(t,t.avail_out===0?YT:ao);const i=n.last_flush;if(n.last_flush=e,n.pending!==0){if(Lr(t),t.avail_out===0)return n.last_flush=-1,Ni}else if(t.avail_in===0&&Ak(e)<=Ak(i)&&e!==ds)return Cc(t,YT);if(n.status===Mu&&t.avail_in!==0)return Cc(t,YT);if(n.status===Zd&&n.wrap===0&&(n.status=vc),n.status===Zd){let r=Q_+(n.w_bits-8<<4)<<8,s=-1;if(s=n.strategy>=J_||n.level<2?0:n.level<6?1:n.level===6?2:3,r|=s<<6,n.strstart!==0&&(r|=32),r+=31-r%31,Uu(n,r),n.strstart!==0&&(Uu(n,t.adler>>>16),Uu(n,65535&t.adler)),t.adler=1,n.status=vc,Lr(t),n.pending!==0)return n.last_flush=-1,Ni}if(n.status===57){if(t.adler=0,on(n,31),on(n,139),on(n,8),n.gzhead)on(n,(n.gzhead.text?1:0)+(n.gzhead.hcrc?2:0)+(n.gzhead.extra?4:0)+(n.gzhead.name?8:0)+(n.gzhead.comment?16:0)),on(n,255&n.gzhead.time),on(n,n.gzhead.time>>8&255),on(n,n.gzhead.time>>16&255),on(n,n.gzhead.time>>24&255),on(n,n.level===9?2:n.strategy>=J_||n.level<2?4:0),on(n,255&n.gzhead.os),n.gzhead.extra&&n.gzhead.extra.length&&(on(n,255&n.gzhead.extra.length),on(n,n.gzhead.extra.length>>8&255)),n.gzhead.hcrc&&(t.adler=Ri(t.adler,n.pending_buf,n.pending,0)),n.gzindex=0,n.status=69;else if(on(n,0),on(n,0),on(n,0),on(n,0),on(n,0),on(n,n.level===9?2:n.strategy>=J_||n.level<2?4:0),on(n,3),n.status=vc,Lr(t),n.pending!==0)return n.last_flush=-1,Ni}if(n.status===69){if(n.gzhead.extra){let r=n.pending,s=(65535&n.gzhead.extra.length)-n.gzindex;for(;n.pending+s>n.pending_buf_size;){let a=n.pending_buf_size-n.pending;if(n.pending_buf.set(n.gzhead.extra.subarray(n.gzindex,n.gzindex+a),n.pending),n.pending=n.pending_buf_size,n.gzhead.hcrc&&n.pending>r&&(t.adler=Ri(t.adler,n.pending_buf,n.pending-r,r)),n.gzindex+=a,Lr(t),n.pending!==0)return n.last_flush=-1,Ni;r=0,s-=a}let o=new Uint8Array(n.gzhead.extra);n.pending_buf.set(o.subarray(n.gzindex,n.gzindex+s),n.pending),n.pending+=s,n.gzhead.hcrc&&n.pending>r&&(t.adler=Ri(t.adler,n.pending_buf,n.pending-r,r)),n.gzindex=0}n.status=73}if(n.status===73){if(n.gzhead.name){let r,s=n.pending;do{if(n.pending===n.pending_buf_size){if(n.gzhead.hcrc&&n.pending>s&&(t.adler=Ri(t.adler,n.pending_buf,n.pending-s,s)),Lr(t),n.pending!==0)return n.last_flush=-1,Ni;s=0}r=n.gzindex<n.gzhead.name.length?255&n.gzhead.name.charCodeAt(n.gzindex++):0,on(n,r)}while(r!==0);n.gzhead.hcrc&&n.pending>s&&(t.adler=Ri(t.adler,n.pending_buf,n.pending-s,s)),n.gzindex=0}n.status=91}if(n.status===91){if(n.gzhead.comment){let r,s=n.pending;do{if(n.pending===n.pending_buf_size){if(n.gzhead.hcrc&&n.pending>s&&(t.adler=Ri(t.adler,n.pending_buf,n.pending-s,s)),Lr(t),n.pending!==0)return n.last_flush=-1,Ni;s=0}r=n.gzindex<n.gzhead.comment.length?255&n.gzhead.comment.charCodeAt(n.gzindex++):0,on(n,r)}while(r!==0);n.gzhead.hcrc&&n.pending>s&&(t.adler=Ri(t.adler,n.pending_buf,n.pending-s,s))}n.status=103}if(n.status===103){if(n.gzhead.hcrc){if(n.pending+2>n.pending_buf_size&&(Lr(t),n.pending!==0))return n.last_flush=-1,Ni;on(n,255&t.adler),on(n,t.adler>>8&255),t.adler=0}if(n.status=vc,Lr(t),n.pending!==0)return n.last_flush=-1,Ni}if(t.avail_in!==0||n.lookahead!==0||e!==Sa&&n.status!==Mu){let r=n.level===0?Ok(n,e):n.strategy===J_?((s,o)=>{let a;for(;;){if(s.lookahead===0&&($d(s),s.lookahead===0)){if(o===Sa)return 1;break}if(s.match_length=0,a=ga(s,0,s.window[s.strstart]),s.lookahead--,s.strstart++,a&&(kr(s,!1),s.strm.avail_out===0))return 1}return s.insert=0,o===ds?(kr(s,!0),s.strm.avail_out===0?3:4):s.sym_next&&(kr(s,!1),s.strm.avail_out===0)?1:2})(n,e):n.strategy===Lq?((s,o)=>{let a,c,d,l;const h=s.window;for(;;){if(s.lookahead<=Rc){if($d(s),s.lookahead<=Rc&&o===Sa)return 1;if(s.lookahead===0)break}if(s.match_length=0,s.lookahead>=3&&s.strstart>0&&(d=s.strstart-1,c=h[d],c===h[++d]&&c===h[++d]&&c===h[++d])){l=s.strstart+Rc;do;while(c===h[++d]&&c===h[++d]&&c===h[++d]&&c===h[++d]&&c===h[++d]&&c===h[++d]&&c===h[++d]&&c===h[++d]&&d<l);s.match_length=Rc-(l-d),s.match_length>s.lookahead&&(s.match_length=s.lookahead)}if(s.match_length>=3?(a=ga(s,1,s.match_length-3),s.lookahead-=s.match_length,s.strstart+=s.match_length,s.match_length=0):(a=ga(s,0,s.window[s.strstart]),s.lookahead--,s.strstart++),a&&(kr(s,!1),s.strm.avail_out===0))return 1}return s.insert=0,o===ds?(kr(s,!0),s.strm.avail_out===0?3:4):s.sym_next&&(kr(s,!1),s.strm.avail_out===0)?1:2})(n,e):xu[n.level].func(n,e);if(r!==3&&r!==4||(n.status=Mu),r===1||r===3)return t.avail_out===0&&(n.last_flush=-1),Ni;if(r===2&&(e===wq?Aq(n):e!==Ik&&(KT(n,0,0,!1),e===Oq&&(Ta(n.head),n.lookahead===0&&(n.strstart=0,n.block_start=0,n.insert=0))),Lr(t),t.avail_out===0))return n.last_flush=-1,Ni}return e!==ds?Ni:n.wrap<=0?bk:(n.wrap===2?(on(n,255&t.adler),on(n,t.adler>>8&255),on(n,t.adler>>16&255),on(n,t.adler>>24&255),on(n,255&t.total_in),on(n,t.total_in>>8&255),on(n,t.total_in>>16&255),on(n,t.total_in>>24&255)):(Uu(n,t.adler>>>16),Uu(n,65535&t.adler)),Lr(t),n.wrap>0&&(n.wrap=-n.wrap),n.pending!==0?Ni:bk)},Hq=(t,e)=>{let n=e.length;if(Vu(t))return ao;const i=t.state,r=i.wrap;if(r===2||r===1&&i.status!==Zd||i.lookahead)return ao;if(r===1&&(t.adler=ku(t.adler,e,n,0)),i.wrap=0,n>=i.w_size){r===0&&(Ta(i.head),i.strstart=0,i.block_start=0,i.insert=0);let c=new Uint8Array(i.w_size);c.set(e.subarray(n-i.w_size,n),0),e=c,n=i.w_size}const s=t.avail_in,o=t.next_in,a=t.input;for(t.avail_in=n,t.next_in=0,t.input=e,$d(i);i.lookahead>=3;){let c=i.strstart,d=i.lookahead-2;do i.ins_h=Ra(i,i.ins_h,i.window[c+3-1]),i.prev[c&i.w_mask]=i.head[i.ins_h],i.head[i.ins_h]=c,c++;while(--d);i.strstart=c,i.lookahead=2,$d(i)}return i.strstart+=i.lookahead,i.block_start=i.strstart,i.insert=i.lookahead,i.lookahead=0,i.match_length=i.prev_length=2,i.match_available=0,t.next_in=o,t.input=a,t.avail_in=s,i.wrap=r,Ni},Fu={deflateInit:(t,e)=>Pk(t,e,Q_,15,8,Mq),deflateInit2:Pk,deflateReset:Dk,deflateResetKeep:Nk,deflateSetHeader:(t,e)=>Vu(t)||t.state.wrap!==2?ao:(t.state.gzhead=e,Ni),deflate:Wq,deflateEnd:t=>{if(Vu(t))return ao;const e=t.state.status;return t.state=null,e===vc?Cc(t,Nq):Ni},deflateSetDictionary:Hq,deflateInfo:"pako deflate (from Nodeca project)"};const Kq=(t,e)=>Object.prototype.hasOwnProperty.call(t,e);var Z_={assign:function(t){const e=Array.prototype.slice.call(arguments,1);for(;e.length;){const n=e.shift();if(n){if(typeof n!="object")throw new TypeError(n+"must be non-object");for(const i in n)Kq(n,i)&&(t[i]=n[i])}}return t},flattenChunks:t=>{let e=0;for(let i=0,r=t.length;i<r;i++)e+=t[i].length;const n=new Uint8Array(e);for(let i=0,r=0,s=t.length;i<s;i++){let o=t[i];n.set(o,r),r+=o.length}return n}};let Lk=!0;try{String.fromCharCode.apply(null,new Uint8Array(1))}catch{Lk=!1}const Bu=new Uint8Array(256);for(let t=0;t<256;t++)Bu[t]=t>=252?6:t>=248?5:t>=240?4:t>=224?3:t>=192?2:1;Bu[254]=Bu[254]=1;var ju={string2buf:t=>{if(typeof TextEncoder=="function"&&TextEncoder.prototype.encode)return new TextEncoder().encode(t);let e,n,i,r,s,o=t.length,a=0;for(r=0;r<o;r++)n=t.charCodeAt(r),(64512&n)==55296&&r+1<o&&(i=t.charCodeAt(r+1),(64512&i)==56320&&(n=65536+(n-55296<<10)+(i-56320),r++)),a+=n<128?1:n<2048?2:n<65536?3:4;for(e=new Uint8Array(a),s=0,r=0;s<a;r++)n=t.charCodeAt(r),(64512&n)==55296&&r+1<o&&(i=t.charCodeAt(r+1),(64512&i)==56320&&(n=65536+(n-55296<<10)+(i-56320),r++)),n<128?e[s++]=n:n<2048?(e[s++]=192|n>>>6,e[s++]=128|63&n):n<65536?(e[s++]=224|n>>>12,e[s++]=128|n>>>6&63,e[s++]=128|63&n):(e[s++]=240|n>>>18,e[s++]=128|n>>>12&63,e[s++]=128|n>>>6&63,e[s++]=128|63&n);return e},buf2string:(t,e)=>{const n=e||t.length;if(typeof TextDecoder=="function"&&TextDecoder.prototype.decode)return new TextDecoder().decode(t.subarray(0,e));let i,r;const s=new Array(2*n);for(r=0,i=0;i<n;){let o=t[i++];if(o<128){s[r++]=o;continue}let a=Bu[o];if(a>4)s[r++]=65533,i+=a-1;else{for(o&=a===2?31:a===3?15:7;a>1&&i<n;)o=o<<6|63&t[i++],a--;a>1?s[r++]=65533:o<65536?s[r++]=o:(o-=65536,s[r++]=55296|o>>10&1023,s[r++]=56320|1023&o)}}return((o,a)=>{if(a<65534&&o.subarray&&Lk)return String.fromCharCode.apply(null,o.length===a?o:o.subarray(0,a));let c="";for(let d=0;d<a;d++)c+=String.fromCharCode(o[d]);return c})(s,r)},utf8border:(t,e)=>{(e=e||t.length)>t.length&&(e=t.length);let n=e-1;for(;n>=0&&(192&t[n])==128;)n--;return n<0||n===0?e:n+Bu[t[n]]>e?n:e}},kk=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0};const Mk=Object.prototype.toString,{Z_NO_FLUSH:Yq,Z_SYNC_FLUSH:qq,Z_FULL_FLUSH:zq,Z_FINISH:Xq,Z_OK:$_,Z_STREAM_END:Jq,Z_DEFAULT_COMPRESSION:Qq,Z_DEFAULT_STRATEGY:Zq,Z_DEFLATED:$q}=X_;function tf(t){this.options=Z_.assign({level:Qq,method:$q,chunkSize:16384,windowBits:15,memLevel:8,strategy:Zq},t||{});let e=this.options;e.raw&&e.windowBits>0?e.windowBits=-e.windowBits:e.gzip&&e.windowBits>0&&e.windowBits<16&&(e.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new kk,this.strm.avail_out=0;let n=Fu.deflateInit2(this.strm,e.level,e.method,e.windowBits,e.memLevel,e.strategy);if(n!==$_)throw new Error(Tc[n]);if(e.header&&Fu.deflateSetHeader(this.strm,e.header),e.dictionary){let i;if(i=typeof e.dictionary=="string"?ju.string2buf(e.dictionary):Mk.call(e.dictionary)==="[object ArrayBuffer]"?new Uint8Array(e.dictionary):e.dictionary,n=Fu.deflateSetDictionary(this.strm,i),n!==$_)throw new Error(Tc[n]);this._dict_set=!0}}function Uk(t,e){const n=new tf(e);if(n.push(t,!0),n.err)throw n.msg||Tc[n.err];return n.result}tf.prototype.push=function(t,e){const n=this.strm,i=this.options.chunkSize;let r,s;if(this.ended)return!1;for(s=e===~~e?e:e===!0?Xq:Yq,typeof t=="string"?n.input=ju.string2buf(t):Mk.call(t)==="[object ArrayBuffer]"?n.input=new Uint8Array(t):n.input=t,n.next_in=0,n.avail_in=n.input.length;;)if(n.avail_out===0&&(n.output=new Uint8Array(i),n.next_out=0,n.avail_out=i),(s===qq||s===zq)&&n.avail_out<=6)this.onData(n.output.subarray(0,n.next_out)),n.avail_out=0;else{if(r=Fu.deflate(n,s),r===Jq)return n.next_out>0&&this.onData(n.output.subarray(0,n.next_out)),r=Fu.deflateEnd(this.strm),this.onEnd(r),this.ended=!0,r===$_;if(n.avail_out!==0){if(s>0&&n.next_out>0)this.onData(n.output.subarray(0,n.next_out)),n.avail_out=0;else if(n.avail_in===0)break}else this.onData(n.output)}return!0},tf.prototype.onData=function(t){this.chunks.push(t)},tf.prototype.onEnd=function(t){t===$_&&(this.result=Z_.flattenChunks(this.chunks)),this.chunks=[],this.err=t,this.msg=this.strm.msg};var tz={deflate:Uk,deflateRaw:function(t,e){return(e=e||{}).raw=!0,Uk(t,e)}};const ef=16209;var ez=function(t,e){let n,i,r,s,o,a,c,d,l,h,p,f,v,S,T,b,w,D,k,U,P,x,q,Q;const dt=t.state;n=t.next_in,q=t.input,i=n+(t.avail_in-5),r=t.next_out,Q=t.output,s=r-(e-t.avail_out),o=r+(t.avail_out-257),a=dt.dmax,c=dt.wsize,d=dt.whave,l=dt.wnext,h=dt.window,p=dt.hold,f=dt.bits,v=dt.lencode,S=dt.distcode,T=(1<<dt.lenbits)-1,b=(1<<dt.distbits)-1;t:do{f<15&&(p+=q[n++]<<f,f+=8,p+=q[n++]<<f,f+=8),w=v[p&T];e:for(;;){if(D=w>>>24,p>>>=D,f-=D,D=w>>>16&255,D===0)Q[r++]=65535&w;else{if(!(16&D)){if((64&D)==0){w=v[(65535&w)+(p&(1<<D)-1)];continue e}if(32&D){dt.mode=16191;break t}t.msg="invalid literal/length code",dt.mode=ef;break t}k=65535&w,D&=15,D&&(f<D&&(p+=q[n++]<<f,f+=8),k+=p&(1<<D)-1,p>>>=D,f-=D),f<15&&(p+=q[n++]<<f,f+=8,p+=q[n++]<<f,f+=8),w=S[p&b];n:for(;;){if(D=w>>>24,p>>>=D,f-=D,D=w>>>16&255,!(16&D)){if((64&D)==0){w=S[(65535&w)+(p&(1<<D)-1)];continue n}t.msg="invalid distance code",dt.mode=ef;break t}if(U=65535&w,D&=15,f<D&&(p+=q[n++]<<f,f+=8,f<D&&(p+=q[n++]<<f,f+=8)),U+=p&(1<<D)-1,U>a){t.msg="invalid distance too far back",dt.mode=ef;break t}if(p>>>=D,f-=D,D=r-s,U>D){if(D=U-D,D>d&&dt.sane){t.msg="invalid distance too far back",dt.mode=ef;break t}if(P=0,x=h,l===0){if(P+=c-D,D<k){k-=D;do Q[r++]=h[P++];while(--D);P=r-U,x=Q}}else if(l<D){if(P+=c+l-D,D-=l,D<k){k-=D;do Q[r++]=h[P++];while(--D);if(P=0,l<k){D=l,k-=D;do Q[r++]=h[P++];while(--D);P=r-U,x=Q}}}else if(P+=l-D,D<k){k-=D;do Q[r++]=h[P++];while(--D);P=r-U,x=Q}for(;k>2;)Q[r++]=x[P++],Q[r++]=x[P++],Q[r++]=x[P++],k-=3;k&&(Q[r++]=x[P++],k>1&&(Q[r++]=x[P++]))}else{P=r-U;do Q[r++]=Q[P++],Q[r++]=Q[P++],Q[r++]=Q[P++],k-=3;while(k>2);k&&(Q[r++]=Q[P++],k>1&&(Q[r++]=Q[P++]))}break}}break}}while(n<i&&r<o);k=f>>3,n-=k,f-=k<<3,p&=(1<<f)-1,t.next_in=n,t.next_out=r,t.avail_in=n<i?i-n+5:5-(n-i),t.avail_out=r<o?o-r+257:257-(r-o),dt.hold=p,dt.bits=f};const nf=15,nz=new Uint16Array([3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0]),iz=new Uint8Array([16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78]),rz=new Uint16Array([1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0]),sz=new Uint8Array([16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64]);var Gu=(t,e,n,i,r,s,o,a)=>{const c=a.bits;let d,l,h,p,f,v,S=0,T=0,b=0,w=0,D=0,k=0,U=0,P=0,x=0,q=0,Q=null;const dt=new Uint16Array(16),Dt=new Uint16Array(16);let Ot,Wt,Vt,pe=null;for(S=0;S<=nf;S++)dt[S]=0;for(T=0;T<i;T++)dt[e[n+T]]++;for(D=c,w=nf;w>=1&&dt[w]===0;w--);if(D>w&&(D=w),w===0)return r[s++]=20971520,r[s++]=20971520,a.bits=1,0;for(b=1;b<w&&dt[b]===0;b++);for(D<b&&(D=b),P=1,S=1;S<=nf;S++)if(P<<=1,P-=dt[S],P<0)return-1;if(P>0&&(t===0||w!==1))return-1;for(Dt[1]=0,S=1;S<nf;S++)Dt[S+1]=Dt[S]+dt[S];for(T=0;T<i;T++)e[n+T]!==0&&(o[Dt[e[n+T]]++]=T);if(t===0?(Q=pe=o,v=20):t===1?(Q=nz,pe=iz,v=257):(Q=rz,pe=sz,v=0),q=0,T=0,S=b,f=s,k=D,U=0,h=-1,x=1<<D,p=x-1,t===1&&x>852||t===2&&x>592)return 1;for(;;){Ot=S-U,o[T]+1<v?(Wt=0,Vt=o[T]):o[T]>=v?(Wt=pe[o[T]-v],Vt=Q[o[T]-v]):(Wt=96,Vt=0),d=1<<S-U,l=1<<k,b=l;do l-=d,r[f+(q>>U)+l]=Ot<<24|Wt<<16|Vt|0;while(l!==0);for(d=1<<S-1;q&d;)d>>=1;if(d!==0?(q&=d-1,q+=d):q=0,T++,--dt[S]==0){if(S===w)break;S=e[n+o[T]]}if(S>D&&(q&p)!==h){for(U===0&&(U=D),f+=b,k=S-U,P=1<<k;k+U<w&&(P-=dt[k+U],!(P<=0));)k++,P<<=1;if(x+=1<<k,t===1&&x>852||t===2&&x>592)return 1;h=q&p,r[h]=D<<24|k<<16|f-s|0}}return q!==0&&(r[f+q]=S-U<<24|64<<16|0),a.bits=D,0};const{Z_FINISH:xk,Z_BLOCK:oz,Z_TREES:rf,Z_OK:yc,Z_STREAM_END:az,Z_NEED_DICT:cz,Z_STREAM_ERROR:ls,Z_DATA_ERROR:Vk,Z_MEM_ERROR:Fk,Z_BUF_ERROR:dz,Z_DEFLATED:Bk}=X_,sf=16180,of=16190,Mo=16191,JT=16192,QT=16194,af=16199,cf=16200,ZT=16206,Bn=16209,jk=t=>(t>>>24&255)+(t>>>8&65280)+((65280&t)<<8)+((255&t)<<24);function lz(){this.strm=null,this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new Uint16Array(320),this.work=new Uint16Array(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}const Ic=t=>{if(!t)return 1;const e=t.state;return!e||e.strm!==t||e.mode<sf||e.mode>16211?1:0},Gk=t=>{if(Ic(t))return ls;const e=t.state;return t.total_in=t.total_out=e.total=0,t.msg="",e.wrap&&(t.adler=1&e.wrap),e.mode=sf,e.last=0,e.havedict=0,e.flags=-1,e.dmax=32768,e.head=null,e.hold=0,e.bits=0,e.lencode=e.lendyn=new Int32Array(852),e.distcode=e.distdyn=new Int32Array(592),e.sane=1,e.back=-1,yc},Wk=t=>{if(Ic(t))return ls;const e=t.state;return e.wsize=0,e.whave=0,e.wnext=0,Gk(t)},Hk=(t,e)=>{let n;if(Ic(t))return ls;const i=t.state;return e<0?(n=0,e=-e):(n=5+(e>>4),e<48&&(e&=15)),e&&(e<8||e>15)?ls:(i.window!==null&&i.wbits!==e&&(i.window=null),i.wrap=n,i.wbits=e,Wk(t))},Kk=(t,e)=>{if(!t)return ls;const n=new lz;t.state=n,n.strm=t,n.window=null,n.mode=sf;const i=Hk(t,e);return i!==yc&&(t.state=null),i};let $T,tR,Yk=!0;const uz=t=>{if(Yk){$T=new Int32Array(512),tR=new Int32Array(32);let e=0;for(;e<144;)t.lens[e++]=8;for(;e<256;)t.lens[e++]=9;for(;e<280;)t.lens[e++]=7;for(;e<288;)t.lens[e++]=8;for(Gu(1,t.lens,0,288,$T,0,t.work,{bits:9}),e=0;e<32;)t.lens[e++]=5;Gu(2,t.lens,0,32,tR,0,t.work,{bits:5}),Yk=!1}t.lencode=$T,t.lenbits=9,t.distcode=tR,t.distbits=5},qk=(t,e,n,i)=>{let r;const s=t.state;return s.window===null&&(s.wsize=1<<s.wbits,s.wnext=0,s.whave=0,s.window=new Uint8Array(s.wsize)),i>=s.wsize?(s.window.set(e.subarray(n-s.wsize,n),0),s.wnext=0,s.whave=s.wsize):(r=s.wsize-s.wnext,r>i&&(r=i),s.window.set(e.subarray(n-i,n-i+r),s.wnext),(i-=r)?(s.window.set(e.subarray(n-i,n),0),s.wnext=i,s.whave=s.wsize):(s.wnext+=r,s.wnext===s.wsize&&(s.wnext=0),s.whave<s.wsize&&(s.whave+=r))),0};var hz=(t,e)=>{let n,i,r,s,o,a,c,d,l,h,p,f,v,S,T,b,w,D,k,U,P,x,q=0;const Q=new Uint8Array(4);let dt,Dt;const Ot=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]);if(Ic(t)||!t.output||!t.input&&t.avail_in!==0)return ls;n=t.state,n.mode===Mo&&(n.mode=JT),o=t.next_out,r=t.output,c=t.avail_out,s=t.next_in,i=t.input,a=t.avail_in,d=n.hold,l=n.bits,h=a,p=c,x=yc;t:for(;;)switch(n.mode){case sf:if(n.wrap===0){n.mode=JT;break}for(;l<16;){if(a===0)break t;a--,d+=i[s++]<<l,l+=8}if(2&n.wrap&&d===35615){n.wbits===0&&(n.wbits=15),n.check=0,Q[0]=255&d,Q[1]=d>>>8&255,n.check=Ri(n.check,Q,2,0),d=0,l=0,n.mode=16181;break}if(n.head&&(n.head.done=!1),!(1&n.wrap)||(((255&d)<<8)+(d>>8))%31){t.msg="incorrect header check",n.mode=Bn;break}if((15&d)!==Bk){t.msg="unknown compression method",n.mode=Bn;break}if(d>>>=4,l-=4,P=8+(15&d),n.wbits===0&&(n.wbits=P),P>15||P>n.wbits){t.msg="invalid window size",n.mode=Bn;break}n.dmax=1<<n.wbits,n.flags=0,t.adler=n.check=1,n.mode=512&d?16189:Mo,d=0,l=0;break;case 16181:for(;l<16;){if(a===0)break t;a--,d+=i[s++]<<l,l+=8}if(n.flags=d,(255&li(n))!==Bk){t.msg="unknown compression method",n.mode=Bn;break}if(57344&li(n)){t.msg="unknown header flags set",n.mode=Bn;break}n.head&&(n.head.text=d>>8&1),512&li(n)&&4&n.wrap&&(Q[0]=255&d,Q[1]=d>>>8&255,n.check=Ri(n.check,Q,2,0)),d=0,l=0,n.mode=16182;case 16182:for(;l<32;){if(a===0)break t;a--,d+=i[s++]<<l,l+=8}n.head&&(n.head.time=d),512&li(n)&&4&n.wrap&&(Q[0]=255&d,Q[1]=d>>>8&255,Q[2]=d>>>16&255,Q[3]=d>>>24&255,n.check=Ri(n.check,Q,4,0)),d=0,l=0,n.mode=16183;case 16183:for(;l<16;){if(a===0)break t;a--,d+=i[s++]<<l,l+=8}n.head&&(n.head.xflags=255&d,n.head.os=d>>8),512&li(n)&&4&n.wrap&&(Q[0]=255&d,Q[1]=d>>>8&255,n.check=Ri(n.check,Q,2,0)),d=0,l=0,n.mode=16184;case 16184:if(1024&li(n)){for(;l<16;){if(a===0)break t;a--,d+=i[s++]<<l,l+=8}n.length=d,n.head&&(n.head.extra_len=d),512&li(n)&&4&n.wrap&&(Q[0]=255&d,Q[1]=d>>>8&255,n.check=Ri(n.check,Q,2,0)),d=0,l=0}else n.head&&(n.head.extra=null);n.mode=16185;case 16185:if(1024&li(n)&&(f=n.length,f>a&&(f=a),f&&(n.head&&(P=n.head.extra_len-n.length,n.head.extra||(n.head.extra=new Uint8Array(n.head.extra_len)),n.head.extra.set(i.subarray(s,s+f),P)),512&li(n)&&4&n.wrap&&(n.check=Ri(n.check,i,f,s)),a-=f,s+=f,n.length-=f),n.length))break t;n.length=0,n.mode=16186;case 16186:if(2048&li(n)){if(a===0)break t;f=0;do P=i[s+f++],n.head&&P&&n.length<65536&&(n.head.name+=String.fromCharCode(P));while(P&&f<a);if(512&li(n)&&4&n.wrap&&(n.check=Ri(n.check,i,f,s)),a-=f,s+=f,P)break t}else n.head&&(n.head.name=null);n.length=0,n.mode=16187;case 16187:if(4096&li(n)){if(a===0)break t;f=0;do P=i[s+f++],n.head&&P&&n.length<65536&&(n.head.comment+=String.fromCharCode(P));while(P&&f<a);if(512&li(n)&&4&n.wrap&&(n.check=Ri(n.check,i,f,s)),a-=f,s+=f,P)break t}else n.head&&(n.head.comment=null);n.mode=16188;case 16188:if(512&li(n)){for(;l<16;){if(a===0)break t;a--,d+=i[s++]<<l,l+=8}if(4&n.wrap&&d!==(65535&n.check)){t.msg="header crc mismatch",n.mode=Bn;break}d=0,l=0}n.head&&(n.head.hcrc=li(n)>>9&1,n.head.done=!0),t.adler=n.check=0,n.mode=Mo;break;case 16189:for(;l<32;){if(a===0)break t;a--,d+=i[s++]<<l,l+=8}t.adler=n.check=jk(d),d=0,l=0,n.mode=of;case of:if(n.havedict===0)return t.next_out=o,t.avail_out=c,t.next_in=s,t.avail_in=a,n.hold=d,n.bits=l,cz;t.adler=n.check=1,n.mode=Mo;case Mo:if(e===oz||e===rf)break t;case JT:if(n.last){d>>>=7&l,l-=7&l,n.mode=ZT;break}for(;l<3;){if(a===0)break t;a--,d+=i[s++]<<l,l+=8}switch(n.last=1&d,d>>>=1,l-=1,3&d){case 0:n.mode=16193;break;case 1:if(uz(n),n.mode=af,e===rf){d>>>=2,l-=2;break t}break;case 2:n.mode=16196;break;case 3:t.msg="invalid block type",n.mode=Bn}d>>>=2,l-=2;break;case 16193:for(d>>>=7&l,l-=7&l;l<32;){if(a===0)break t;a--,d+=i[s++]<<l,l+=8}if((65535&d)!=(d>>>16^65535)){t.msg="invalid stored block lengths",n.mode=Bn;break}if(n.length=65535&d,d=0,l=0,n.mode=QT,e===rf)break t;case QT:n.mode=16195;case 16195:if(f=n.length,f){if(f>a&&(f=a),f>c&&(f=c),f===0)break t;r.set(i.subarray(s,s+f),o),a-=f,s+=f,c-=f,o+=f,n.length-=f;break}n.mode=Mo;break;case 16196:for(;l<14;){if(a===0)break t;a--,d+=i[s++]<<l,l+=8}if(n.nlen=257+(31&d),d>>>=5,l-=5,n.ndist=1+(31&d),d>>>=5,l-=5,n.ncode=4+(15&d),d>>>=4,l-=4,n.nlen>286||n.ndist>30){t.msg="too many length or distance symbols",n.mode=Bn;break}n.have=0,n.mode=16197;case 16197:for(;n.have<n.ncode;){for(;l<3;){if(a===0)break t;a--,d+=i[s++]<<l,l+=8}n.lens[Ot[n.have++]]=7&d,d>>>=3,l-=3}for(;n.have<19;)n.lens[Ot[n.have++]]=0;if(n.lencode=n.lendyn,n.lenbits=7,dt={bits:n.lenbits},x=Gu(0,n.lens,0,19,n.lencode,0,n.work,dt),n.lenbits=dt.bits,x){t.msg="invalid code lengths set",n.mode=Bn;break}n.have=0,n.mode=16198;case 16198:for(;n.have<n.nlen+n.ndist;){for(;q=n.lencode[d&(1<<n.lenbits)-1],T=q>>>24,b=q>>>16&255,w=65535&q,!(T<=l);){if(a===0)break t;a--,d+=i[s++]<<l,l+=8}if(w<16)d>>>=T,l-=T,n.lens[n.have++]=w;else{if(w===16){for(Dt=T+2;l<Dt;){if(a===0)break t;a--,d+=i[s++]<<l,l+=8}if(d>>>=T,l-=T,n.have===0){t.msg="invalid bit length repeat",n.mode=Bn;break}P=n.lens[n.have-1],f=3+(3&d),d>>>=2,l-=2}else if(w===17){for(Dt=T+3;l<Dt;){if(a===0)break t;a--,d+=i[s++]<<l,l+=8}d>>>=T,l-=T,P=0,f=3+(7&d),d>>>=3,l-=3}else{for(Dt=T+7;l<Dt;){if(a===0)break t;a--,d+=i[s++]<<l,l+=8}d>>>=T,l-=T,P=0,f=11+(127&d),d>>>=7,l-=7}if(n.have+f>n.nlen+n.ndist){t.msg="invalid bit length repeat",n.mode=Bn;break}for(;f--;)n.lens[n.have++]=P}}if(n.mode===Bn)break;if(n.lens[256]===0){t.msg="invalid code -- missing end-of-block",n.mode=Bn;break}if(n.lenbits=9,dt={bits:n.lenbits},x=Gu(1,n.lens,0,n.nlen,n.lencode,0,n.work,dt),n.lenbits=dt.bits,x){t.msg="invalid literal/lengths set",n.mode=Bn;break}if(n.distbits=6,n.distcode=n.distdyn,dt={bits:n.distbits},x=Gu(2,n.lens,n.nlen,n.ndist,n.distcode,0,n.work,dt),n.distbits=dt.bits,x){t.msg="invalid distances set",n.mode=Bn;break}if(n.mode=af,e===rf)break t;case af:n.mode=cf;case cf:if(a>=6&&c>=258){t.next_out=o,t.avail_out=c,t.next_in=s,t.avail_in=a,n.hold=d,n.bits=l,ez(t,p),o=t.next_out,r=t.output,c=t.avail_out,s=t.next_in,i=t.input,a=t.avail_in,d=n.hold,l=n.bits,n.mode===Mo&&(n.back=-1);break}for(n.back=0;q=n.lencode[d&(1<<n.lenbits)-1],T=q>>>24,b=q>>>16&255,w=65535&q,!(T<=l);){if(a===0)break t;a--,d+=i[s++]<<l,l+=8}if(b&&(240&b)==0){for(D=T,k=b,U=w;q=n.lencode[U+((d&(1<<D+k)-1)>>D)],T=q>>>24,b=q>>>16&255,w=65535&q,!(D+T<=l);){if(a===0)break t;a--,d+=i[s++]<<l,l+=8}d>>>=D,l-=D,n.back+=D}if(d>>>=T,l-=T,n.back+=T,n.length=w,b===0){n.mode=16205;break}if(32&b){n.back=-1,n.mode=Mo;break}if(64&b){t.msg="invalid literal/length code",n.mode=Bn;break}n.extra=15&b,n.mode=16201;case 16201:if(n.extra){for(Dt=n.extra;l<Dt;){if(a===0)break t;a--,d+=i[s++]<<l,l+=8}n.length+=d&(1<<n.extra)-1,d>>>=n.extra,l-=n.extra,n.back+=n.extra}n.was=n.length,n.mode=16202;case 16202:for(;q=n.distcode[d&(1<<n.distbits)-1],T=q>>>24,b=q>>>16&255,w=65535&q,!(T<=l);){if(a===0)break t;a--,d+=i[s++]<<l,l+=8}if((240&b)==0){for(D=T,k=b,U=w;q=n.distcode[U+((d&(1<<D+k)-1)>>D)],T=q>>>24,b=q>>>16&255,w=65535&q,!(D+T<=l);){if(a===0)break t;a--,d+=i[s++]<<l,l+=8}d>>>=D,l-=D,n.back+=D}if(d>>>=T,l-=T,n.back+=T,64&b){t.msg="invalid distance code",n.mode=Bn;break}n.offset=w,n.extra=15&b,n.mode=16203;case 16203:if(n.extra){for(Dt=n.extra;l<Dt;){if(a===0)break t;a--,d+=i[s++]<<l,l+=8}n.offset+=d&(1<<n.extra)-1,d>>>=n.extra,l-=n.extra,n.back+=n.extra}if(n.offset>n.dmax){t.msg="invalid distance too far back",n.mode=Bn;break}n.mode=16204;case 16204:if(c===0)break t;if(f=p-c,n.offset>f){if(f=n.offset-f,f>n.whave&&n.sane){t.msg="invalid distance too far back",n.mode=Bn;break}f>n.wnext?(f-=n.wnext,v=n.wsize-f):v=n.wnext-f,f>n.length&&(f=n.length),S=n.window}else S=r,v=o-n.offset,f=n.length;f>c&&(f=c),c-=f,n.length-=f;do r[o++]=S[v++];while(--f);n.length===0&&(n.mode=cf);break;case 16205:if(c===0)break t;r[o++]=n.length,c--,n.mode=cf;break;case ZT:if(n.wrap){for(;l<32;){if(a===0)break t;a--,d|=i[s++]<<l,l+=8}if(p-=c,t.total_out+=p,n.total+=p,4&n.wrap&&p&&(t.adler=n.check=li(n)?Ri(n.check,r,p,o-p):ku(n.check,r,p,o-p)),p=c,4&n.wrap&&(li(n)?d:jk(d))!==n.check){t.msg="incorrect data check",n.mode=Bn;break}d=0,l=0}n.mode=16207;case 16207:if(n.wrap&&li(n)){for(;l<32;){if(a===0)break t;a--,d+=i[s++]<<l,l+=8}if(4&n.wrap&&d!==(4294967295&n.total)){t.msg="incorrect length check",n.mode=Bn;break}d=0,l=0}n.mode=16208;case 16208:x=az;break t;case Bn:x=Vk;break t;case 16210:return Fk;default:return ls}return t.next_out=o,t.avail_out=c,t.next_in=s,t.avail_in=a,n.hold=d,n.bits=l,(n.wsize||p!==t.avail_out&&n.mode<Bn&&(n.mode<ZT||e!==xk))&&qk(t,t.output,t.next_out,p-t.avail_out),h-=t.avail_in,p-=t.avail_out,t.total_in+=h,t.total_out+=p,n.total+=p,4&n.wrap&&p&&(t.adler=n.check=li(n)?Ri(n.check,r,p,t.next_out-p):ku(n.check,r,p,t.next_out-p)),t.data_type=n.bits+(n.last?64:0)+(n.mode===Mo?128:0)+(n.mode===af||n.mode===QT?256:0),(h===0&&p===0||e===xk)&&x===yc&&(x=dz),x},Uo={inflateReset:Wk,inflateReset2:Hk,inflateResetKeep:Gk,inflateInit:t=>Kk(t,15),inflateInit2:Kk,inflate:hz,inflateEnd:t=>{if(Ic(t))return ls;let e=t.state;return e.window&&(e.window=null),t.state=null,yc},inflateGetHeader:(t,e)=>{if(Ic(t))return ls;const n=t.state;return(2&n.wrap)==0?ls:(n.head=e,e.done=!1,yc)},inflateSetDictionary:(t,e)=>{const n=e.length;let i,r,s;return Ic(t)?ls:(i=t.state,i.wrap!==0&&i.mode!==of?ls:i.mode===of&&(r=1,r=ku(r,e,n,0),r!==i.check)?Vk:(s=qk(t,e,n,n),s?(i.mode=16210,Fk):(i.havedict=1,yc)))},inflateInfo:"pako inflate (from Nodeca project)"},pz=function(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1};const zk=Object.prototype.toString,{Z_NO_FLUSH:_z,Z_FINISH:fz,Z_OK:Wu,Z_STREAM_END:eR,Z_NEED_DICT:nR,Z_STREAM_ERROR:mz,Z_DATA_ERROR:Xk,Z_MEM_ERROR:Ez}=X_;function df(t){this.options=Z_.assign({chunkSize:65536,windowBits:15,to:""},t||{});const e=this.options;e.raw&&e.windowBits>=0&&e.windowBits<16&&(e.windowBits=-e.windowBits,e.windowBits===0&&(e.windowBits=-15)),!(e.windowBits>=0&&e.windowBits<16)||t&&t.windowBits||(e.windowBits+=32),e.windowBits>15&&e.windowBits<48&&(15&e.windowBits)==0&&(e.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new kk,this.strm.avail_out=0;let n=Uo.inflateInit2(this.strm,e.windowBits);if(n!==Wu)throw new Error(Tc[n]);if(this.header=new pz,Uo.inflateGetHeader(this.strm,this.header),e.dictionary&&(typeof e.dictionary=="string"?e.dictionary=ju.string2buf(e.dictionary):zk.call(e.dictionary)==="[object ArrayBuffer]"&&(e.dictionary=new Uint8Array(e.dictionary)),e.raw&&(n=Uo.inflateSetDictionary(this.strm,e.dictionary),n!==Wu)))throw new Error(Tc[n])}function Jk(t,e){const n=new df(e);if(n.push(t),n.err)throw n.msg||Tc[n.err];return n.result}df.prototype.push=function(t,e){const n=this.strm,i=this.options.chunkSize,r=this.options.dictionary;let s,o,a;if(this.ended)return!1;for(o=e===~~e?e:e===!0?fz:_z,zk.call(t)==="[object ArrayBuffer]"?n.input=new Uint8Array(t):n.input=t,n.next_in=0,n.avail_in=n.input.length;;){for(n.avail_out===0&&(n.output=new Uint8Array(i),n.next_out=0,n.avail_out=i),s=Uo.inflate(n,o),s===nR&&r&&(s=Uo.inflateSetDictionary(n,r),s===Wu?s=Uo.inflate(n,o):s===Xk&&(s=nR));n.avail_in>0&&s===eR&&n.state.wrap>0&&t[n.next_in]!==0;)Uo.inflateReset(n),s=Uo.inflate(n,o);switch(s){case mz:case Xk:case nR:case Ez:return this.onEnd(s),this.ended=!0,!1}if(a=n.avail_out,n.next_out&&(n.avail_out===0||s===eR))if(this.options.to==="string"){let c=ju.utf8border(n.output,n.next_out),d=n.next_out-c,l=ju.buf2string(n.output,c);n.next_out=d,n.avail_out=i-d,d&&n.output.set(n.output.subarray(c,c+d),0),this.onData(l)}else this.onData(n.output.length===n.next_out?n.output:n.output.subarray(0,n.next_out));if(s!==Wu||a!==0){if(s===eR)return s=Uo.inflateEnd(this.strm),this.onEnd(s),this.ended=!0,!0;if(n.avail_in===0)break}}return!0},df.prototype.onData=function(t){this.chunks.push(t)},df.prototype.onEnd=function(t){t===Wu&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=Z_.flattenChunks(this.chunks)),this.chunks=[],this.err=t,this.msg=this.strm.msg};var gz={inflate:Jk,inflateRaw:function(t,e){return(e=e||{}).raw=!0,Jk(t,e)}};const{deflate:Sz,deflateRaw:Tz}=tz,{inflate:Rz,inflateRaw:vz}=gz;var Cz=Sz,yz=Tz,Iz=Rz,bz=vz,Qk=(function(t){return t[t.ONE_BYTE=0]="ONE_BYTE",t[t.TWO_BYTE=1]="TWO_BYTE",t})(Qk||{});class Az{constructor(){R(this,"_sequence",0),R(this,"_startTime",Date.now()),R(this,"isUseOneByte",!0)}get startTime(){const e=Date.now()-this._startTime;return e<Math.pow(2,16)?e:(this._startTime+=Math.pow(2,16),this.startTime)}get sequence(){return this._sequence<Math.pow(2,32)?this._sequence++:(this._sequence-=Math.pow(2,32),this.sequence)}serialize(e){const n={commonPacketHeader:{length:0,reserved:0,extension:0,sequence:this.sequence},commonStreamHeader:this.startTime,extension:void 0,payload:e};if(e.byteLength>128){const a=new Uint8Array(4);a.set([1,0,0,0]);const c={id:0,length:4,data:a.buffer},d={profile:this.isUseOneByte?0:1,length:this.isUseOneByte?5:6,datas:[c]};n.commonPacketHeader.extension=1,n.extension=d,n.payload=this.compress(e),n.commonPacketHeader.length=8+(n.extension.length+2)+n.payload.byteLength}else n.commonPacketHeader.length=8+n.payload.byteLength;I("SHOW_DATASTREAM2_LOG")&&m.debug("send data header: ".concat(JSON.stringify(n.commonPacketHeader)));const i=new ArrayBuffer(n.commonPacketHeader.length),r=new Uint8Array(i),s=new DataView(i);let o=0;if(s.setUint16(o,n.commonPacketHeader.extension<<15|n.commonPacketHeader.reserved<<14|n.commonPacketHeader.length,!0),o+=2,s.setUint32(o,n.commonPacketHeader.sequence,!0),o+=4,s.setUint16(o,n.commonStreamHeader,!0),o+=2,n.extension){const a=this.serializeExtension(n.extension);r.set(new Uint8Array(a),o),o+=a.byteLength}if(r.set(new Uint8Array(n.payload),o),o+=n.payload.byteLength,o!==n.commonPacketHeader.length)throw Error("serialize error!");return i}deserialize(e){if(e.byteLength<4)return new ArrayBuffer(0);const n=new DataView(e);let i=0;const r=n.getUint16(i,!0);i+=2;const s={length:16383&r,reserved:(16384&r)>>14,extension:(32768&r)>>15,sequence:n.getUint16(i+2,!0)<<16|n.getUint16(i,!0)};let o,a;if(i+=4,I("SHOW_DATASTREAM2_LOG")&&m.debug("receive data header: ".concat(JSON.stringify(s))),n.getUint16(i,!0),i+=2,s.extension){a=this.deserializeExtension(e.slice(i)),i+=2+a.length,o=e.slice(i);let c=!1;if(a.datas.length>0){const d=a.datas.find((l=>l.id===0));d&&(c=(1&new DataView(d.data).getUint32(0,!0))==1)}o=c?this.decompress(o):o}else o=e.slice(8);return o}serializeExtension(e){const{profile:n,length:i,datas:r}=e,s=new ArrayBuffer(i+2),o=new Uint8Array(s),a=new DataView(s);let c=0;if(a.setUint8(c++,n),a.setUint8(c++,i),r.forEach((d=>{n?(a.setUint8(c++,d.id),a.setUint8(c++,d.length),o.set(new Uint8Array(d.data),c),c+=d.data.byteLength):(a.setUint8(c++,d.id|d.length<<4),o.set(new Uint8Array(d.data),c),c+=d.data.byteLength)})),c!==i+2)throw Error("serialize extension error, is ".concat(c,"!==").concat(i+2));return s}deserializeExtension(e){const n=new DataView(e);let i=0;const r=n.getUint8(i);i++;const s=n.getUint8(i);i++;const o=r===Qk.TWO_BYTE,a=[],c=new DataView(e,2);let d=0;for(;d<s;){let l=0,h=0,p=new ArrayBuffer(0);o?(l=c.getUint8(d),d++,h=c.getUint8(d),d++):(l=15&c.getUint8(d),h=c.getUint8(d)>>4,d++),h>0&&(p=c.buffer.slice(d+2,d+2+h),d+=p.byteLength),a.push({id:l,length:h,data:p})}if(d!==s)throw Error("parse error");return{profile:r,length:s,datas:a}}decompress(e){return Iz(new Uint8Array(e))}compress(e){return Cz(new Uint8Array(e))}}const wz={name:"DataStream",create:(t,e)=>{const n=e?new P8(t):new L8(t);return n.useDataStream(new Az),n}};class Oz extends qe{constructor(e,n,i){super(),R(this,"ws",void 0),R(this,"requestId",1),R(this,"heartBeatTimer",void 0),R(this,"joinInfo",void 0),R(this,"clientId",void 0),R(this,"onOpen",(()=>{this.emit("open"),this.startHeartBeatCheck()})),R(this,"onClose",(r=>{this.emit("close"),this.dispose()})),R(this,"onMessage",(r=>{const s=JSON.parse(r.data);if(!s||s.command!=="serverResponse"||!s.requestId)return s&&s.command==="serverStatus"&&s.serverStatus&&s.serverStatus.command?(this.emit("status",s.serverStatus),void this.emit(s.serverStatus.command,s.serverStatus)):void 0;this.emit("req_".concat(s.requestId),s)})),this.joinInfo=e,this.clientId=n,this.ws=new pu("cross-channel-".concat(this.clientId),i),this.ws.on(Bt.RECONNECTING,(()=>{this.ws.reconnectMode="retry",this.emit("reconnecting")})),this.ws.on(Bt.CONNECTED,this.onOpen),this.ws.on(Bt.ON_MESSAGE,this.onMessage),this.ws.on(Bt.CLOSED,this.onClose)}isConnect(){return this.ws.state==="connected"}sendMessage(e){const n=this.requestId++;return e.requestId=n,e.seq=n,this.ws.sendMessage(e),n}waitStatus(e){return new st(((n,i)=>{const r=window.setTimeout((()=>{i(new B(A.TIMEOUT,"wait status timeout, status: ".concat(e)))}),5e3);this.once(e,(s=>{window.clearTimeout(r),s.state&&s.state!==0?i(new B(A.CROSS_CHANNEL_WAIT_STATUS_ERROR,"wait status error, status: ".concat(e))):n(void 0)})),this.once("dispose",(()=>{window.clearTimeout(r),i(new B(A.WS_ABORT))}))}))}async request(e){if(this.ws.state==="closed")throw new B(A.WS_DISCONNECT);const n=()=>new st(((o,a)=>{this.ws.once(Bt.CLOSED,(()=>a(new B(A.WS_ABORT)))),this.ws.once(Bt.CONNECTED,o)}));this.ws.state!=="connected"&&await n();const i=this.sendMessage(e),r=new st(((o,a)=>{const c=()=>{a(new B(A.WS_ABORT))};this.ws.once(Bt.RECONNECTING,c),this.ws.once(Bt.CLOSED,c),this.once("req_".concat(i),o),Nn(3e3).then((()=>{this.removeAllListeners("req_".concat(i)),this.ws.off(Bt.RECONNECTING,c),this.ws.off(Bt.CLOSED,c),a(new B(A.TIMEOUT,"cross channel ws request timeout"))}))})),s=await r;if(!s||s.code!==200)throw new B(A.CROSS_CHANNEL_SERVER_ERROR_RESPONSE,"response: ".concat(JSON.stringify(s)));return s}async connect(e){this.ws.removeAllListeners(Bt.REQUEST_NEW_URLS),this.ws.on(Bt.REQUEST_NEW_URLS,(n=>{n(e)})),await this.ws.init(e)}dispose(){this.clearHeartBeatCheck(),this.emit("dispose"),this.removeAllListeners(),this.ws.close()}sendPing(e){const n=this.requestId++;return e.requestId=n,this.ws.sendMessage(e),n}startHeartBeatCheck(){this.heartBeatTimer&&window.clearInterval(this.heartBeatTimer),this.heartBeatTimer=window.setInterval((()=>{this.sendPing({command:"ping",appId:this.joinInfo.appId,cname:this.joinInfo.cname,uid:this.joinInfo.uid.toString(),sid:this.joinInfo.sid,ts:+new Date,requestId:0})}),3e3)}clearHeartBeatCheck(){window.clearInterval(this.heartBeatTimer),this.heartBeatTimer=void 0}}class Nz extends qe{set state(e){e!==this._state&&(e!==Mi.RELAY_STATE_FAILURE&&(this.errorCode=xd.RELAY_OK),this.emit("state",e,this.errorCode),this._state=e)}get state(){return this._state}constructor(e,n,i,r,s){super(),R(this,"joinInfo",void 0),R(this,"sid",void 0),R(this,"clientId",void 0),R(this,"cancelToken",yi.CancelToken.source()),R(this,"workerToken",void 0),R(this,"requestId",0),R(this,"signal",void 0),R(this,"prevChannelMediaConfig",void 0),R(this,"httpRetryConfig",void 0),R(this,"_resolution",void 0),R(this,"_state",Mi.RELAY_STATE_IDLE),R(this,"errorCode",xd.RELAY_OK),R(this,"onStatus",(o=>{m.debug("[".concat(this.clientId,"] ChannelMediaStatus: ").concat(JSON.stringify(o))),o&&o.command&&(o.command==="onAudioPacketReceived"&&this.emit("event",Do.PACKET_RECEIVED_AUDIO_FROM_SRC),o.command==="onVideoPacketReceived"&&this.emit("event",Do.PACKET_RECEIVED_VIDEO_FROM_SRC),o.command==="onSrcTokenPrivilegeDidExpire"&&(this.errorCode=xd.SRC_TOKEN_EXPIRED,this.state=Mi.RELAY_STATE_FAILURE),o.command==="onDestTokenPrivilegeDidExpire"&&(this.errorCode=xd.DEST_TOKEN_EXPIRED,this.state=Mi.RELAY_STATE_FAILURE))})),R(this,"onReconnect",(async()=>{m.debug("[".concat(this.clientId,"] ChannelMediaSocket disconnect, reconnecting")),this.emit("event",Do.NETWORK_DISCONNECTED),this.state=Mi.RELAY_STATE_IDLE,this.prevChannelMediaConfig&&this.sendStartRelayMessage(this.prevChannelMediaConfig).catch((o=>{this.state!==Mi.RELAY_STATE_IDLE&&(m.error("auto restart channel media relay failed",o.toString()),this.errorCode=xd.SERVER_CONNECTION_LOST,this.state=Mi.RELAY_STATE_FAILURE)}))})),this.joinInfo=e,this.clientId=n,this.sid=ec(),this.signal=new Oz(this.joinInfo,this.clientId,i),this.httpRetryConfig=r,this._resolution=s}async startChannelMediaRelay(e){if(this.state!==Mi.RELAY_STATE_IDLE)throw new B(A.INVALID_OPERATION);this.state=Mi.RELAY_STATE_CONNECTING,await this.connect(),m.debug("[".concat(this.clientId,"] startChannelMediaRelay: connect success"));try{await this.sendStartRelayMessage(e)}catch(n){throw n.data&&n.data.serverResponse&&n.data.serverResponse.command==="SetSourceChannel"?new B(A.CROSS_CHANNEL_FAILED_JOIN_SRC):n.data&&n.data.serverResponse&&n.serverResponse.command==="SetDestChannelStatus"?new B(A.CROSS_CHANNEL_FAILED_JOIN_DEST):n.data&&n.data.serverResponse&&n.serverResponse.command==="StartPacketTransfer"?new B(A.CROSS_CHANNEL_FAILED_PACKET_SENT_TO_DEST):n}this.prevChannelMediaConfig=e}async updateChannelMediaRelay(e){if(this.state!==Mi.RELAY_STATE_RUNNING)throw new B(A.INVALID_OPERATION);await this.sendUpdateMessage(e),this.prevChannelMediaConfig=e}async setVideoProfile(e){if(this._resolution=e,this.state!==Mi.RELAY_STATE_RUNNING)throw new B(A.INVALID_OPERATION);const n=this.genMessage(Ai.SetVideoProfile);await this.signal.request(n),m.debug("[".concat(this.clientId,"] startChannelMediaRelay: setVideoProfile success"))}async stopChannelMediaRelay(){await this.sendStopRelayMessage(),m.debug("[".concat(this.clientId,"] stopChannelMediaRelay: send stop message success")),this.state=Mi.RELAY_STATE_IDLE,this.dispose()}dispose(){m.debug("[".concat(this.clientId,"] disposeChannelMediaRelay")),this.cancelToken.cancel(),this.cancelToken=yi.CancelToken.source(),this.state=Mi.RELAY_STATE_IDLE,this.emit("dispose"),this.signal.dispose(),this.prevChannelMediaConfig=void 0}async connect(){const e=await xY(this.joinInfo,this.cancelToken.token,this.httpRetryConfig);this.workerToken=e.workerToken,await this.signal.connect(e.addressList),this.emit("event",Do.NETWORK_CONNECTED),this.signal.on("status",this.onStatus),this.signal.on("reconnecting",this.onReconnect)}async sendStartRelayMessage(e){const n=this.genMessage(Ai.SetSdkProfile,e);await this.signal.request(n),m.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSdkProfile success"));const i=this.genMessage(Ai.SetSourceChannel,e);await this.signal.request(i),await this.signal.waitStatus("SetSourceChannelStatus"),this.emit("event",Do.PACKET_JOINED_SRC_CHANNEL),m.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSourceChannel success"));const r=this.genMessage(Ai.SetSourceUserId,e);await this.signal.request(r),m.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSourceUserId success"));const s=this.genMessage(Ai.SetDestChannel,e);await this.signal.request(s),await this.signal.waitStatus("SetDestChannelStatus"),this.emit("event",Do.PACKET_JOINED_DEST_CHANNEL),m.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetDestChannel success"));const o=this.genMessage(Ai.StartPacketTransfer,e);await this.signal.request(o),this.emit("event",Do.PACKET_SENT_TO_DEST_CHANNEL),this.state=Mi.RELAY_STATE_RUNNING,m.debug("[".concat(this.clientId,"] startChannelMediaRelay: StartPacketTransfer success")),this.setVideoProfile(this._resolution)}async sendUpdateMessage(e){const n=this.genMessage(Ai.UpdateDestChannel,e);await this.signal.request(n),this.emit("event",Do.PACKET_UPDATE_DEST_CHANNEL),m.debug("[".concat(this.clientId,"] sendUpdateMessage: UpdateDestChannel success"))}async sendStopRelayMessage(){const e=this.genMessage(Ai.StopPacketTransfer);await this.signal.request(e),m.debug("[".concat(this.clientId,"] sendStopRelayMessage: StopPacketTransfer success"))}genMessage(e,n){const i=[],r=[],s=[];this.requestId+=1;const o={appId:this.joinInfo.appId,cname:this.joinInfo.cname,uid:this.joinInfo.uid.toString(),sdkVersion:Ar,sid:this.sid,ts:Date.now(),requestId:this.requestId,seq:this.requestId,allocate:!0,clientRequest:{}};o.sdkVersion==="4.24.1"&&(o.sdkVersion="0.0.1");let a=null,c=null;switch(e){case Ai.SetSdkProfile:return o.clientRequest={command:"SetSdkProfile",type:"multi_channel"},o;case Ai.SetSourceChannel:if(c=n&&n.getSrcChannelMediaInfo(),!c)throw new B(A.UNEXPECTED_ERROR,"can not find source config");return o.clientRequest={command:"SetSourceChannel",uid:"0",channelName:c.channelName,token:c.token||this.joinInfo.appId},o;case Ai.SetSourceUserId:if(c=n&&n.getSrcChannelMediaInfo(),!c)throw new B(A.UNEXPECTED_ERROR,"can not find source config");return o.clientRequest={command:"SetSourceUserId",uid:c.uid+""},o;case Ai.SetDestChannel:if(a=n&&n.getDestChannelMediaInfo(),!a)throw new B(A.UNEXPECTED_ERROR,"can not find dest config");return a.forEach((d=>{i.push(d.channelName),r.push(d.uid+""),s.push(d.token||this.joinInfo.appId)})),o.clientRequest={command:"SetDestChannel",channelName:i,uid:r,token:s},o;case Ai.StartPacketTransfer:return o.clientRequest={command:"StartPacketTransfer"},o;case Ai.Reconnect:return o.clientRequest={command:"Reconnect"},o;case Ai.StopPacketTransfer:return o.clientRequest={command:"StopPacketTransfer"},o;case Ai.UpdateDestChannel:if(a=n&&n.getDestChannelMediaInfo(),!a)throw new B(A.UNEXPECTED_ERROR,"can not find dest config");return a.forEach((d=>{i.push(d.channelName),r.push(d.uid+""),s.push(d.token||this.joinInfo.appId)})),o.clientRequest={command:"UpdateDestChannel",channelName:i,uid:r,token:s},o;case Ai.SetVideoProfile:o.clientRequest={command:"SetVideoProfile",width:this._resolution.width,height:this._resolution.height}}return o}}const Dz={name:"ChannelMediaRelay",create:function(t){return new Nz(t.joinInfo,t.clientId,t.websocketRetryConfig||fn,t.httpRetryConfig||fn,t.resolution)}};function Zk(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable}))),n.push.apply(n,i)}return n}function Hu(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?Zk(Object(n),!0).forEach((function(i){R(t,i,n[i])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):Zk(Object(n)).forEach((function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i))}))}return t}class Pz extends qe{constructor(e,n,i,r){super(),R(this,"spec",void 0),R(this,"token",void 0),R(this,"websocket",void 0),R(this,"pingpongTimer",void 0),R(this,"reconnectMode","retry"),R(this,"serviceMode",void 0),R(this,"reqId",0),R(this,"commandReqId",0),R(this,"handleWebSocketOpen",(()=>{this.reconnectMode="retry",this.startPingPong()})),R(this,"handleWebSocketMessage",(s=>{if(!s.data)return;const o=JSON.parse(s.data);o.requestId?this.emit("@".concat(o.requestId,"-").concat(o.sid),o):(pt.workerEvent(this.spec.sid,{actionType:"status",serverCode:o.code,workerType:this.serviceMode===No.TRANSCODE?1:2}),this.emit(da.PUBLISH_STREAM_STATUS,o))})),this.spec=n,this.token=e,this.serviceMode=r,this.websocket=new pu("live-streaming",i),this.websocket.on(Bt.CONNECTED,this.handleWebSocketOpen),this.websocket.on(Bt.ON_MESSAGE,this.handleWebSocketMessage),this.websocket.on(Bt.REQUEST_NEW_URLS,((s,o)=>{Sn(this,da.REQUEST_NEW_ADDRESS).then(s).catch(o)})),this.websocket.on(Bt.RECONNECTING,(()=>{this.websocket.reconnectMode=this.reconnectMode}))}init(e){return this.websocket.init(e)}async request(e,n,i,r){this.reqId+=1,e==="request"&&(this.commandReqId+=1);const s=this.commandReqId,o=this.reqId;if(!o||!this.websocket)throw new B(A.UNEXPECTED_ERROR);const a=Hu({command:e,sdkVersion:Ar==="4.24.1"?"0.0.1":Ar,seq:o,requestId:o,allocate:i,cname:this.spec.cname,appId:this.spec.appId,sid:this.spec.sid,uid:this.spec.uid.toString(),ts:Math.floor(Date.now()/1e3)},n);if(this.websocket.state==="closed")throw new B(A.WS_DISCONNECT);const c=()=>new st(((p,f)=>{this.websocket.once(Bt.CLOSED,(()=>f(new B(A.WS_ABORT)))),this.websocket.once(Bt.CONNECTED,p)}));this.websocket.state!=="connected"&&await c(),a.clientRequest&&(a.clientRequest.workerToken=this.token);const d=new st(((p,f)=>{const v=()=>{f(new B(A.WS_ABORT))};this.websocket.once(Bt.RECONNECTING,v),this.websocket.once(Bt.CLOSED,v),this.once("@".concat(o,"-").concat(this.spec.sid),(S=>{p(S)}))}));r&&pt.workerEvent(this.spec.sid,Hu(Hu({},r),{},{requestId:s,actionType:"request",payload:JSON.stringify(n.clientRequest),serverCode:0,code:0}));const l=Date.now();this.websocket.sendMessage(a);let h=null;try{h=await d}catch(p){if(this.websocket.state==="closed")throw p;return await c(),await this.request(e,n,i)}return r&&pt.workerEvent(this.spec.sid,Hu(Hu({},r),{},{requestId:s,actionType:"response",payload:JSON.stringify(h.serverResponse),serverCode:h.code,success:h.code===200,responseTime:Date.now()-l})),h.code!==200&&this.handleResponseError(h),h}tryNextAddress(){this.reconnectMode="tryNext",this.websocket.reconnect("tryNext")}close(){const e=Ar==="4.24.1"?"0.0.1":Ar;this.reqId+=1,this.websocket.state==="connected"?(this.websocket.sendMessage({command:"request",appId:this.spec.appId,cname:this.spec.cname,uid:this.spec.uid.toString(),sdkVersion:e,sid:this.spec.sid,seq:this.reqId,ts:Math.floor(Date.now()/1e3),requestId:this.reqId,clientRequest:{command:"DestroyWorker"}}),this.websocket.close(!1,!0)):this.websocket.close(!1),this.pingpongTimer&&(window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0)}handleResponseError(e){switch(e.code){case yn.LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM:return void m.warning("live stream response already exists stream");case yn.LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR:case yn.LIVE_STREAM_RESPONSE_BAD_STREAM:case yn.LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR:return new B(A.LIVE_STREAMING_INVALID_ARGUMENT,"",{code:e.code}).throw();case yn.LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST:if(e.serverResponse.command==="UnpublishStream")return;throw new B(A.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream response wm worker not exist",{retry:!0});case yn.LIVE_STREAM_RESPONSE_NOT_AUTHORIZED:return new B(A.LIVE_STREAMING_PUBLISH_STREAM_NOT_AUTHORIZED,"",{code:e.code}).throw();case yn.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE:{const n=new B(A.LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE);return this.emit(da.WARNING,n,e.serverResponse.url)}case yn.LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN:{const n=new B(A.LIVE_STREAMING_WARN_FREQUENT_REQUEST);return this.emit(da.WARNING,n,e.serverResponse.url)}case yn.LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH:throw new B(A.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream response wm worker not exist",{retry:!0});case yn.LIVE_STREAM_RESPONSE_NOT_SUPPORTED:return new B(A.LIVE_STREAMING_TRANSCODING_NOT_SUPPORTED,"",{code:e.code}).throw();case yn.LIVE_STREAM_RESPONSE_MAX_STREAM_NUM:{const n=new B(A.LIVE_STREAMING_WARN_STREAM_NUM_REACH_LIMIT);return this.emit(da.WARNING,n,e.serverResponse.url)}case yn.LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR:return new B(A.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"",{code:e.code}).throw();case yn.LIVE_STREAM_RESPONSE_RESOURCE_LIMIT:throw new B(A.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream resource limit",{retry:!0,changeAddress:!0});case yn.LIVE_STREAM_RESPONSE_WORKER_LOST:case yn.LIVE_STREAM_RESPONSE_WORKER_QUIT:if(e.serverResponse.command==="UnpublishStream")return;throw new B(A.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{retry:!0,changeAddress:!0});case yn.ERROR_FAIL_SEND_MESSAGE:if(e.serverResponse.command==="UnpublishStream")return;if(e.serverResponse.command==="UpdateTranscoding"||e.serverResponse.command==="ControlStream")return new B(A.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{code:e.code}).throw();throw new B(A.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{retry:!0,changeAddress:!0});case yn.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN:case yn.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT:case yn.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE:case yn.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH:return new B(A.LIVE_STREAMING_CDN_ERROR,"",{code:e.code}).throw()}}startPingPong(){this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval((()=>{this.websocket.state==="connected"&&this.request("ping",{}).catch(su)}),6e3)}}function $k(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable}))),n.push.apply(n,i)}return n}function xi(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?$k(Object(n),!0).forEach((function(i){R(t,i,n[i])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):$k(Object(n)).forEach((function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i))}))}return t}class Lz extends qe{constructor(e){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:fn,i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:fn;super(),R(this,"onLiveStreamWarning",void 0),R(this,"onLiveStreamError",void 0),R(this,"spec",void 0),R(this,"retryTimeout",1e4),R(this,"connection",void 0),R(this,"httpRetryConfig",void 0),R(this,"wsRetryConfig",void 0),R(this,"streamingTasks",new Map),R(this,"isStartingStreamingTask",!1),R(this,"taskMutex",new Un("live-streaming")),R(this,"cancelToken",yi.CancelToken.source()),R(this,"transcodingConfig",void 0),R(this,"uapResponse",void 0),R(this,"lastTaskId",1),R(this,"statusError",new Map),this.spec=e,this.httpRetryConfig=i,this.wsRetryConfig=n}async setTranscodingConfig(e){const n=xi(xi({},mY),e);n.videoCodecProfile!==66&&n.videoCodecProfile!==77&&n.videoCodecProfile!==100&&(m.debug("[".concat(this.spec.clientId,"] set transcoding config, fix video codec profile: ").concat(n.videoCodecProfile," -> 100")),n.videoCodecProfile=100),n.transcodingUsers||(n.transcodingUsers=n.userConfigs),n.transcodingUsers&&(n.transcodingUsers=n.transcodingUsers.map((o=>xi(xi(xi({},fY),o),{},{zOrder:o.zOrder?o.zOrder+1:1})))),(function(o){Ze(o.width)||Oe(o.width,"config.width",0,1e4),Ze(o.height)||Oe(o.height,"config.height",0,1e4),Ze(o.videoBitrate)||Oe(o.videoBitrate,"config.videoBitrate",1,1e6),Ze(o.videoFrameRate)||Oe(o.videoFrameRate,"config.videoFrameRate"),Ze(o.lowLatency)||Zr(o.lowLatency,"config.lowLatency"),Ze(o.audioSampleRate)||_n(o.audioSampleRate,"config.audioSampleRate",[32e3,44100,48e3]),Ze(o.audioBitrate)||Oe(o.audioBitrate,"config.audioBitrate",1,128),Ze(o.audioChannels)||_n(o.audioChannels,"config.audioChannels",[1,2,3,4,5]),Ze(o.videoGop)||Oe(o.videoGop,"config.videoGop"),Ze(o.videoCodecProfile)||_n(o.videoCodecProfile,"config.videoCodecProfile",[66,77,100]),Ze(o.userCount)||Oe(o.userCount,"config.userCount",0,17),Ze(o.backgroundColor)||Oe(o.backgroundColor,"config.backgroundColor",0,16777215),Ze(o.userConfigExtraInfo)||Kn(o.userConfigExtraInfo,"config.userConfigExtraInfo",0,4096,!1),o.transcodingUsers&&!Ze(o.transcodingUsers)&&(wo(o.transcodingUsers,"config.transcodingUsers"),o.transcodingUsers.forEach(((a,c)=>{g_(a.uid),Ze(a.x)||Oe(a.x,"transcodingUser[".concat(c,"].x"),0,1e4),Ze(a.y)||Oe(a.y,"transcodingUser[".concat(c,"].y"),0,1e4),Ze(a.width)||Oe(a.width,"transcodingUser[".concat(c,"].width"),0,1e4),Ze(a.height)||Oe(a.height,"transcodingUser[".concat(c,"].height"),0,1e4),Ze(a.zOrder)||Oe(a.zOrder-1,"transcodingUser[".concat(c,"].zOrder"),0,100),Ze(a.alpha)||Oe(a.alpha,"transcodingUser[".concat(c,"].alpha"),0,1,!1)}))),Ze(o.watermark)||YS(o.watermark,"watermark"),Ze(o.backgroundImage)||YS(o.backgroundImage,"backgroundImage"),o.images&&!Ze(o.images)&&(wo(o.images,"config.images"),o.images.forEach(((a,c)=>{YS(a,"images[".concat(c,"]"))})))})(n);const i=[];n.images&&i.push(...n.images.map((o=>xi(xi(xi({},KS),o),{},{zOrder:255})))),n.backgroundImage&&(i.push(xi(xi(xi({},KS),n.backgroundImage),{},{zOrder:0})),delete n.backgroundImage),n.watermark&&(i.push(xi(xi(xi({},KS),n.watermark),{},{zOrder:255})),delete n.watermark),n.images=i,n.transcodingUsers&&(n.userConfigs=n.transcodingUsers.map((o=>xi({},o))),n.userCount=n.transcodingUsers.length,delete n.transcodingUsers);const r=(n.userConfigs||[]).map((o=>typeof o.uid=="number"?st.resolve(o.uid):SP(o.uid,this.spec,this.cancelToken.token,this.httpRetryConfig)));if((await st.all(r)).forEach(((o,a)=>{n.userConfigs&&n.userConfigs[a]&&(n.userConfigs[a].uid=o)})),this.transcodingConfig=n,this.connection)try{var s;const o=await this.connection.request("request",{clientRequest:{command:"UpdateTranscoding",transcodingConfig:this.transcodingConfig}},!1,{command:"UpdateTranscoding",workerType:1,requestByUser:!0,tid:Array.from(qi(s=this.streamingTasks).call(s)).map((a=>a.taskId)).join("#")});m.debug("[".concat(this.spec.clientId,"] update live transcoding config success, code: ").concat(o.code,", config:"),JSON.stringify(this.transcodingConfig))}catch(o){if(!o.data||!o.data.retry)throw o;o.data.changeAddress&&this.connection.tryNextAddress(),this.streamingTasks.forEach((a=>{m.warning("[".concat(this.spec.clientId,"] live streaming receive error"),o.toString(),"try to republish",a.url),this.startLiveStreamingTask(a.url,a.mode,o).then((()=>{m.debug("[".concat(this.spec.clientId,"] live streaming republish ").concat(a.url," success"))})).catch((c=>{m.error("[".concat(this.spec.clientId,"] live streaming republish failed"),a.url,c.toString()),this.onLiveStreamError&&this.onLiveStreamError(a.url,c)}))}))}}async startLiveStreamingTask(e,n,i){if(!this.transcodingConfig&&n===No.TRANSCODE)throw new B(A.INVALID_OPERATION,"[LiveStreaming] no transcoding config found, can not start transcoding streaming task");const r={command:"PublishStream",ts:Date.now(),url:e,uid:this.spec.uid.toString(),autoDestroyTime:100,acceptImageTimeout:!0};m.debug("[".concat(this.spec.clientId,"] start live streaming ").concat(e,", mode: ").concat(n));const s=await this.taskMutex.lock();if(!this.connection&&i)return void s();if(this.streamingTasks.get(e)&&!i)return s(),new B(A.LIVE_STREAMING_TASK_CONFLICT).throw();try{this.connection||(this.connection=await this.connect(n))}catch(a){throw s(),a}switch(n){case No.TRANSCODE:r.transcodingConfig=xi({},this.transcodingConfig)}this.uapResponse&&this.uapResponse.vid&&(r.vid=this.uapResponse.vid),this.isStartingStreamingTask=!0;const o=this.lastTaskId++;try{const a=new st(((d,l)=>{Nn(this.retryTimeout).then((()=>{if(i)return l(i);const h=this.statusError.get(e);return h?(this.statusError.delete(e),l(h)):void 0}))})),c=await st.race([this.connection.request("request",{clientRequest:r},!0,{url:e,command:"PublishStream",workerType:n===No.TRANSCODE?1:2,requestByUser:!i,tid:o.toString()}),a]);this.isStartingStreamingTask=!1,m.debug("[".concat(this.spec.clientId,"] live streaming started, code: ").concat(c.code)),this.streamingTasks.set(e,{clientRequest:r,mode:n,url:e,taskId:o}),s()}catch(a){if(s(),this.isStartingStreamingTask=!1,!a.data||!a.data.retry||i)throw a;return a.data.changeAddress?(this.connection.tryNextAddress(),await this.startLiveStreamingTask(e,n,a)):await this.startLiveStreamingTask(e,n,a)}}stopLiveStreamingTask(e){return new st(((n,i)=>{const r=this.streamingTasks.get(e);if(!r||!this.connection)return new B(A.UNEXPECTED_ERROR,"can not find streaming task to stop").throw();const s=r.mode;r.abortTask=()=>{m.debug("[".concat(this.spec.clientId,"] stop live streaming success(worker exception)")),this.streamingTasks.delete(e),n()},this.connection.request("request",{clientRequest:{command:"UnpublishStream",url:r.url}},!1,{url:e,command:"UnPublishStream",workerType:s===No.TRANSCODE?1:2,requestByUser:!0,tid:(this.lastTaskId++).toString()}).then((o=>{m.debug("[".concat(this.spec.clientId,"] stop live streaming success, code: ").concat(o.code)),this.streamingTasks.delete(e),this.streamingTasks.size===0&&(this.connection&&this.connection.close(),this.connection=void 0),n()})).catch(i)}))}resetAllTask(){var e;const n=Array.from(qi(e=this.streamingTasks).call(e));this.terminate();for(const i of n)this.startLiveStreamingTask(i.url,i.mode).catch((r=>{this.onLiveStreamError&&this.onLiveStreamError(i.url,r)}))}terminate(){this.cancelToken&&this.cancelToken.cancel(),this.streamingTasks=new Map,this.isStartingStreamingTask=!1,this.statusError=new Map,this.cancelToken=yi.CancelToken.source(),this.uapResponse=void 0,this.connection&&this.connection.close(),this.connection=void 0}async connect(e){if(this.connection)throw new B(A.UNEXPECTED_ERROR,"live streaming connection has already connected");const n=await Sn(this,qS.REQUEST_WORKER_MANAGER_LIST,e);return this.uapResponse=n,this.connection=new Pz(n.workerToken,this.spec,this.wsRetryConfig,e),this.connection.on(da.WARNING,((i,r)=>this.onLiveStreamWarning&&this.onLiveStreamWarning(r,i))),this.connection.on(da.PUBLISH_STREAM_STATUS,(i=>this.handlePublishStreamServer(i))),this.connection.on(da.REQUEST_NEW_ADDRESS,((i,r)=>{if(!this.connection)return r(new B(A.UNEXPECTED_ERROR,"can not get new live streaming address list"));Sn(this,qS.REQUEST_WORKER_MANAGER_LIST,e).then((s=>{this.uapResponse=s,i(s.addressList)})).catch(r)})),await this.connection.init(n.addressList),this.connection}handlePublishStreamServer(e){const n=e.serverStatus&&e.serverStatus.url||"empty_url",i=this.streamingTasks.get(n),r=e.reason;switch(e.code){case yn.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN:case yn.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT:case yn.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE:case yn.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH:{const o=new B(A.LIVE_STREAMING_CDN_ERROR,"",{code:e.code});if(i)return m.error(o.toString()),this.onLiveStreamError&&this.onLiveStreamError(n,o);if(!this.isStartingStreamingTask)return;this.statusError.set(n,o)}case yn.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE:{const o=new B(A.LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE,r);return this.onLiveStreamWarning&&this.onLiveStreamWarning(n,o)}case yn.LIVE_STREAM_RESPONSE_WORKER_LOST:case yn.LIVE_STREAM_RESPONSE_WORKER_QUIT:{var s;if(!this.connection)return;this.connection.tryNextAddress();const o=Array.from(qi(s=this.streamingTasks).call(s));for(const a of o)a.abortTask?a.abortTask():(m.warning("[".concat(this.spec.clientId,"] publish stream status code"),e.code,"try to republish",a.url),this.startLiveStreamingTask(a.url,a.mode,new B(A.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"",{code:e.code})).then((()=>{m.debug("[".concat(this.spec.clientId,"] republish live stream success"),a.url)})).catch((c=>{m.error(c.toString()),this.onLiveStreamError&&this.onLiveStreamError(a.url,c)})));return}}}hasUrl(e){return this.streamingTasks.has(e)}}const kz={name:"LiveStreaming",create:function(t){return new Lz(t.joinInfo,t.websocketRetryConfig||fn,t.httpRetryConfig||fn)}};function Mz(t){let e=nM();return(function(n,i){let r=n.appId;r!==void 0&&(ve(i,10),uo(i,r));let s=n.cid;s!==void 0&&(ve(i,16),ve(i,s));let o=n.cname;o!==void 0&&(ve(i,26),uo(i,o));let a=n.deviceId;a!==void 0&&(ve(i,34),uo(i,a));let c=n.elapse;c!==void 0&&(ve(i,40),va(i,c));let d=n.fileSize;d!==void 0&&(ve(i,48),va(i,el(d)));let l=n.height;l!==void 0&&(ve(i,56),va(i,el(l)));let h=n.jpg;h!==void 0&&(ve(i,66),ve(i,h.length),(function(He,X){let rt=nl(He,X.length);He.bytes.set(X,rt)})(i,h));let p=n.networkType;p!==void 0&&(ve(i,72),va(i,el(p)));let f=n.osType;f!==void 0&&(ve(i,80),va(i,el(f)));let v=n.requestId;v!==void 0&&(ve(i,90),uo(i,v));let S=n.sdkVersion;S!==void 0&&(ve(i,98),uo(i,S));let T=n.sequence;T!==void 0&&(ve(i,104),va(i,el(T)));let b=n.sid;b!==void 0&&(ve(i,114),uo(i,b));let w=n.timestamp;w!==void 0&&(ve(i,120),va(i,w));let D=n.uid;D!==void 0&&(ve(i,128),ve(i,D));let k=n.vid;k!==void 0&&(ve(i,136),ve(i,k));let U=n.width;U!==void 0&&(ve(i,144),va(i,el(U)));let P=n.service;P!==void 0&&(ve(i,152),ve(i,P));let x=n.callbackData;x!==void 0&&(ve(i,162),uo(i,x));let q=n.jpgEncryption;q!==void 0&&(ve(i,168),ve(i,q));let Q=n.requestType;Q!==void 0&&(ve(i,176),ve(i,Q));let dt=n.scorePorn;dt!==void 0&&(ve(i,185),aR(i,dt));let Dt=n.scoreSexy;Dt!==void 0&&(ve(i,193),aR(i,Dt));let Ot=n.scoreNeutral;Ot!==void 0&&(ve(i,201),aR(i,Ot));let Wt=n.scene;Wt!==void 0&&(ve(i,208),ve(i,Wt));let Vt=n.ossFilePrefix;Vt!==void 0&&(ve(i,218),uo(i,Vt));let pe=n.serviceVendor;if(pe!==void 0)for(let He of pe){ve(i,226);let X=nM();Vz(He,X),ve(i,X.limit),Gz(i,X),jz(X)}})(t,e),(function(n){let i=n.bytes,r=n.limit;return i.length===r?i:i.subarray(0,r)})(e)}function Uz(t){return(function(n){let i={};t:for(;!iM(n);){let r=ho(n);switch(r>>>3){case 0:break t;case 1:i.code=ho(n);break;case 2:i.msg=rM(n,ho(n));break;case 3:{let s=Fz(n);i.data=xz(n),n.limit=s;break}default:tM(n,7&r)}}return i})({bytes:e=t,offset:0,limit:e.length});var e}function xz(t){let e={};t:for(;!iM(t);){let n=ho(t);switch(n>>>3){case 0:break t;case 1:e.requestId=rM(t,ho(t));break;case 2:e.requestType=ho(t)>>>0;break;case 3:e.scorePorn=oR(t);break;case 4:e.scoreSexy=oR(t);break;case 5:e.scoreNeutral=oR(t);break;case 6:e.requestScene=ho(t)>>>0;break;case 7:e.scene=ho(t)>>>0;break;default:tM(t,7&n)}}return e}function Vz(t,e){let n=t.service;n!==void 0&&(ve(e,8),ve(e,n));let i=t.vendor;i!==void 0&&(ve(e,16),ve(e,i));let r=t.token;r!==void 0&&(ve(e,26),uo(e,r));let s=t.callbackUrl;s!==void 0&&(ve(e,34),uo(e,s))}function Fz(t){let e=ho(t),n=t.limit;return t.limit=t.offset+e,n}function tM(t,e){switch(e){case 0:for(;128&sM(t););break;case 2:rR(t,ho(t));break;case 5:rR(t,4);break;case 1:rR(t,8);break;default:throw new Error("Unimplemented type: "+e)}}let Bz=new Float32Array(1);new Uint8Array(Bz.buffer);let iR=new Float64Array(1),Vi=new Uint8Array(iR.buffer);function el(t){return{low:t|=0,high:t>>31,unsigned:t>=0}}let eM=[];function nM(){const t=eM.pop();return t?(t.offset=t.limit=0,t):{bytes:new Uint8Array(64),offset:0,limit:0}}function jz(t){eM.push(t)}function rR(t,e){if(t.offset+e>t.limit)throw new Error("Skip past limit");t.offset+=e}function iM(t){return t.offset>=t.limit}function nl(t,e){let n=t.bytes,i=t.offset,r=t.limit,s=i+e;if(s>n.length){let o=new Uint8Array(2*s);o.set(n),t.bytes=o}return t.offset=s,s>r&&(t.limit=s),i}function sR(t,e){let n=t.offset;if(n+e>t.limit)throw new Error("Read past limit");return t.offset+=e,n}function rM(t,e){let n=sR(t,e),i=String.fromCharCode,r=t.bytes,s="",o="";for(let a=0;a<e;a++){let c,d,l,h,p=r[a+n];(128&p)==0?o+=i(p):(224&p)==192?a+1>=e?o+=s:(c=r[a+n+1],(192&c)!=128?o+=s:(h=(31&p)<<6|63&c,h<128?o+=s:(o+=i(h),a++))):(240&p)==224?a+2>=e?o+=s:(c=r[a+n+1],d=r[a+n+2],(49344&(c|d<<8))!=32896?o+=s:(h=(15&p)<<12|(63&c)<<6|63&d,h<2048||h>=55296&&h<=57343?o+=s:(o+=i(h),a+=2))):(248&p)==240?a+3>=e?o+=s:(c=r[a+n+1],d=r[a+n+2],l=r[a+n+3],(12632256&(c|d<<8|l<<16))!=8421504?o+=s:(h=(7&p)<<18|(63&c)<<12|(63&d)<<6|63&l,h<65536||h>1114111?o+=s:(h-=65536,o+=i(55296+(h>>10),56320+(1023&h)),a+=3))):o+=s}return o}function uo(t,e){let n=e.length,i=0;for(let o=0;o<n;o++){let a=e.charCodeAt(o);a>=55296&&a<=56319&&o+1<n&&(a=(a<<10)+e.charCodeAt(++o)-56613888),i+=a<128?1:a<2048?2:a<65536?3:4}ve(t,i);let r=nl(t,i),s=t.bytes;for(let o=0;o<n;o++){let a=e.charCodeAt(o);a>=55296&&a<=56319&&o+1<n&&(a=(a<<10)+e.charCodeAt(++o)-56613888),a<128?s[r++]=a:(a<2048?s[r++]=a>>6&31|192:(a<65536?s[r++]=a>>12&15|224:(s[r++]=a>>18&7|240,s[r++]=a>>12&63|128),s[r++]=a>>6&63|128),s[r++]=63&a|128)}}function Gz(t,e){let n=nl(t,e.limit),i=t.bytes,r=e.bytes;for(let s=0,o=e.limit;s<o;s++)i[s+n]=r[s]}function sM(t){return t.bytes[sR(t,1)]}function oM(t,e){let n=nl(t,1);t.bytes[n]=e}function oR(t){let e=sR(t,8),n=t.bytes;return Vi[0]=n[e++],Vi[1]=n[e++],Vi[2]=n[e++],Vi[3]=n[e++],Vi[4]=n[e++],Vi[5]=n[e++],Vi[6]=n[e++],Vi[7]=n[e++],iR[0]}function aR(t,e){let n=nl(t,8),i=t.bytes;iR[0]=e,i[n++]=Vi[0],i[n++]=Vi[1],i[n++]=Vi[2],i[n++]=Vi[3],i[n++]=Vi[4],i[n++]=Vi[5],i[n++]=Vi[6],i[n++]=Vi[7]}function ho(t){let e,n=0,i=0;do e=sM(t),n<32&&(i|=(127&e)<<n),n+=7;while(128&e);return i}function ve(t,e){for(e>>>=0;e>=128;)oM(t,127&e|128),e>>>=7;oM(t,e)}function va(t,e){let n=e.low>>>0,i=(e.low>>>28|e.high<<4)>>>0,r=e.high>>>24,s=r===0?i===0?n<16384?n<128?1:2:n<1<<21?3:4:i<16384?i<128?5:6:i<1<<21?7:8:r<128?9:10,o=nl(t,s),a=t.bytes;switch(s){case 10:a[o+9]=r>>>7&1;case 9:a[o+8]=s!==9?128|r:127&r;case 8:a[o+7]=s!==8?i>>>21|128:i>>>21&127;case 7:a[o+6]=s!==7?i>>>14|128:i>>>14&127;case 6:a[o+5]=s!==6?i>>>7|128:i>>>7&127;case 5:a[o+4]=s!==5?128|i:127&i;case 4:a[o+3]=s!==4?n>>>21|128:n>>>21&127;case 3:a[o+2]=s!==3?n>>>14|128:n>>>14&127;case 2:a[o+1]=s!==2?n>>>7|128:n>>>7&127;case 1:a[o]=s!==1?128|n:127&n}}function aM(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable}))),n.push.apply(n,i)}return n}const Wz=new Map([["moderation",1],["supervise",2]]);class Hz extends qe{get connectionState(){return this._connectionState}set connectionState(e){if(this._connectionState===e)return;const n=this._connectionState;this._connectionState=e,this.emit(Vn.CONNECTION_STATE_CHANGE,n,e)}get inspectType(){return this._inspectType}set inspectType(e){var n;this._inspectMode=Ir(n=e.map((i=>Wz.get(i)||0))).call(n,((i,r)=>i+r)),this._inspectType=e}get quality(){return this._quality}set quality(e){this._quality=e>1?1:e<.1?.1:e,this.qualityTimer&&(window.clearTimeout(this.qualityTimer),this.qualityTimer=null),this._quality>=1||(this.qualityTimer=window.setTimeout((()=>{this.quality=this._quality/this.qualityRatio}),6e4))}constructor(e){super(),R(this,"name","AgoraRTCVideoContentInspect"),R(this,"_connectionState",is.CONNECTING),R(this,"_innerConnectionState",void 0),R(this,"sequence",0),R(this,"inspectStartTime",void 0),R(this,"workerManagerConnection",void 0),R(this,"workerConnection",void 0),R(this,"workerMessageLengthLimit",void 0),R(this,"inspectIntervalMinimum",void 0),R(this,"qualityRatio",void 0),R(this,"_connectInfo",void 0),R(this,"_cancelTokenSource",yi.CancelToken.source()),R(this,"_retryConfig",void 0),R(this,"wmSequence",0),R(this,"inspectInterval",void 0),R(this,"inspectTimer",null),R(this,"ossFilePrefix",void 0),R(this,"extraInfo",void 0),R(this,"_inspectType",void 0),R(this,"_inspectMode",void 0),R(this,"_quality",1),R(this,"qualityTimer",null),R(this,"_inspectId",void 0),R(this,"_needWorkUrlOnly",!1),R(this,"inspectImage",(()=>{if(this.connectionState!==is.CONNECTED)throw new B(A.OPERATION_ABORTED,"content inspect service connection status is ".concat(this.connectionState));this.inspectTimer&&(window.clearInterval(this.inspectTimer),this.inspectTimer=null),this.inspectTimer=window.setInterval((()=>{this.connectionState===is.CONNECTED?this.requestToInspectImage():m.debug("[".concat(this._inspectId,"] Inspect State is not connected , "),this.connectionState)}),this.inspectInterval<this.inspectIntervalMinimum?this.inspectIntervalMinimum:this.inspectInterval),this.requestToInspectImage()})),this._inspectId=Se(5,"inspect-"),this.workerMessageLengthLimit=I("VIDEO_INSPECT_WORKER_MESSAGE_LENGTH_LIMIT"),this.inspectIntervalMinimum=I("VIDEO_INSPECT_INTERVAL_MINIMUM"),this.qualityRatio=I("VIDEO_INSPECT_QUALITY_RATIO"),this.inspectInterval=e.interval,this.ossFilePrefix=e.ossFilePrefix,this.extraInfo=e.extraInfo,this.inspectType=e.inspectType,this.inspectStartTime=Number(Date.now()),this.workerManagerConnection=new pu("worker-manager-"+this._inspectId,fn),this.on(Vn.STATE_CHANGE,((n,i)=>{this._innerConnectionState=n,m.debug("[".concat(this._inspectId,"] Inspect operation :").concat(rs[n]," ").concat(i||""))})),this.handleWorkerManagerEvents(),this.workerConnection=new pu("worker-"+this._inspectId,fn),this.handleWorkerEvents()}async init(e,n){this.emit(Vn.STATE_CHANGE,rs.CONNECT_AP),this._connectInfo=e;const i=this._cancelTokenSource.token;return this._retryConfig=n,new st(((r,s)=>{this.on(Vn.CONNECTION_STATE_CHANGE,((o,a)=>{a===is.CONNECTED&&r()})),this.requestAP(e,i,n).then((o=>{this.connectWorkerManager(o)})).catch((o=>{s(o)}))}))}async requestAP(e,n,i){const r=I("WEBCS_DOMAIN").map((a=>"https://".concat(a,"/api/v1"))),s=await(function(a,c,d,l){let{appId:h,areaCode:p,cname:f,sid:v,token:S,uid:T}=c;Wd++;const b="image_moderation_api",w={service_name:b,json_body:JSON.stringify({appId:h,areaCode:p,cname:f,command:"allocateEdge",requestId:Wd,seq:Wd,sid:v,token:S,ts:Date.now(),uid:T+""})};let D,k,U=a[0];return Rs((async()=>{D=Date.now();const P=await As(U,{data:w,cancelToken:d,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"},params:{action:"wrtc_gateway"}});if(k=Date.now()-D,P.code!==0){const Ot=new B(A.UNEXPECTED_RESPONSE,"image inspect ap error, code"+P.code,{retry:!0,responseTime:k});throw m.error(Ot.toString()),Ot}const x=JSON.parse(P.json_body);if(x.code!==200){const Ot=new B(A.UNEXPECTED_RESPONSE,"image inspect ap error, code: ".concat(x.code,", reason: ").concat(x.reason),{code:x.code,responseTime:k});throw m.error(Ot.toString()),Ot}if(!x.servers||!Array.isArray(x.servers)||x.servers.length===0){const Ot=new B(A.UNEXPECTED_RESPONSE,"image inspect ap empty server",{code:x.code,responseTime:k});throw m.error(Ot.toString()),Ot}const q=I("VIDEO_INSPECT_WORKER_MANAGER_WSS");if(q)return{addressList:[q],workerToken:x.workerToken,vid:x.vid,responseTime:k};const Q=I("VIDEO_INSPECT_WORKER_MANAGER_HOST"),dt=I("VIDEO_INSPECT_WORKER_MANAGER_PORT");return{addressList:x.servers.map((Ot=>{let{address:Wt,wss:Vt}=Ot;if(Wt&&Vt)return"wss://".concat(Wt.replace(/\./g,"-"),".").concat(Q,":").concat(dt||Vt)})).filter((Ot=>!!Ot)),workerToken:x.workerToken,vid:x.vid,responseTime:k}}),((P,x)=>(pt.apworkerEvent(v,{success:!0,sc:200,serviceName:b,responseDetail:JSON.stringify(P.addressList),firstSuccess:x===0,responseTime:k,serverIp:a[x%a.length]}),!1)),((P,x)=>(pt.apworkerEvent(v,{success:!1,sc:P.data&&P.data.code||200,serviceName:b,responseTime:k,serverIp:a[x%a.length]}),!!(P.code!==A.OPERATION_ABORTED&&P.code!==A.UNEXPECTED_RESPONSE||P.data&&P.data.retry)&&(U=a[(x+1)%a.length],!0))),l)})(r,e,n,i);this.emit(Vn.STATE_CHANGE,rs.AP_CONNECTED);const{addressList:o}=s;return this.wmSequence++,o}async connectWorkerManager(e){let n=arguments.length>1&&arguments[1]!==void 0&&arguments[1];this._needWorkUrlOnly=n,this.emit(Vn.STATE_CHANGE,rs.CONNECT_WORKER_MANAGER),await this.workerManagerConnection.init(e,1e4)}async connectWorker(e){await this.workerConnection.init([e])}handleWorkerManagerEvents(){this.workerManagerConnection.on(Bt.CONNECTED,(async()=>{this.emit(Vn.STATE_CHANGE,rs.WORKER_MANAGER_CONNECTED,this.workerManagerConnection.url),this.workerManagerConnection.sendMessage({appId:this._connectInfo.appId,cname:this._connectInfo.cname,uid:this._connectInfo.uid+"",sdkVersion:"4.24.1",sid:this._connectInfo.sid,seq:this.wmSequence,ts:Number(Date.now()),requestId:Math.floor(1e12*Math.random()),allocate:!0,clientRequest:{command:"join"}},!0)})),this.workerManagerConnection.on(Bt.CLOSED,(()=>{this._innerConnectionState<rs.GET_WORKER_MANAGER_RESPONSE&&m.debug("[".concat(this._inspectId,"] Inspect worker manager is closed before connecting worker"))})),this.workerManagerConnection.on(Bt.FAILED,(()=>{this._innerConnectionState<rs.GET_WORKER_MANAGER_RESPONSE&&m.debug("[".concat(this._inspectId,"] Connecting inspect worker manager is failed before connecting worker"))})),this.workerManagerConnection.on(Bt.RECONNECTING,(()=>{this._innerConnectionState<rs.GET_WORKER_MANAGER_RESPONSE&&m.debug("[".concat(this._inspectId,"] Inspect worker manager is reconnecting before connecting worker"))})),this.workerManagerConnection.on(Bt.ON_MESSAGE,(async e=>{this.emit(Vn.STATE_CHANGE,rs.GET_WORKER_MANAGER_RESPONSE);const n=this.workerManagerConnection.url;this.workerManagerConnection.close();const i=JSON.parse(e.data);if(i.code!==200)throw m.error("[".concat(this._inspectId,"] Unexpected code ").concat(i.code," from worker manager")),new B(A.UNEXPECTED_RESPONSE,"response code of worker is unexpected",i);if(!(i.serverResponse&&i.serverResponse.portWss&&n))throw m.error("[".concat(this._inspectId,"] Unexpected content from worker manager : ").concat(JSON.stringify(i))),new B(A.UNEXPECTED_RESPONSE,"response content of worker is unexpected",i);{const r=I("VIDEO_INSPECT_WORKER_PORT")||i.serverResponse.portWss,s=n.replace(/:\d+\/?$/,":".concat(r));this.emit(Vn.STATE_CHANGE,rs.CONNECT_WORKER,s),this._needWorkUrlOnly?this.emit(Vn.REQUEST_NEW_WORKER_URL,s):await this.connectWorker(s)}})),this.workerManagerConnection.on(Bt.WILL_RECONNECT,((e,n,i)=>{i(e)})),this.workerManagerConnection.on(Bt.REQUEST_NEW_URLS,((e,n)=>{this.requestAP(this._connectInfo,this._cancelTokenSource.token,this._retryConfig).then(e).catch(n)}))}handleWorkerEvents(){this.workerConnection.on(Bt.CONNECTED,(async()=>{this.emit(Vn.STATE_CHANGE,rs.WORKER_CONNECTED,this.workerConnection.url),this.connectionState=is.CONNECTED})),this.workerConnection.on(Bt.ON_MESSAGE,(async e=>{if(e.data instanceof ArrayBuffer){const i=Uz(new Uint8Array(e.data));if(I("SHOW_VIDEO_INSPECT_WORKER_MESSAGE")&&m.debug("[".concat(this._inspectId,"] Response message for worker of inspect content "),JSON.stringify(i)),i.code===200){if(Array.isArray(this.inspectType)&&this.inspectType.length===1&&this.inspectType[0]==="supervise")return void this.emit(Vn.INSPECT_RESULT,void 0,void 0);if(i.data&&i.data.scorePorn&&i.data.scoreSexy&&i.data.scoreNeutral){var n;const r={porn:i.data.scorePorn,sexy:i.data.scoreSexy,neutral:i.data.scoreNeutral},s=Ir(n=Object.keys(r)).call(n,((a,c)=>r[a]>r[c]?a:c),"porn"),o=Object.keys(r).find((a=>a===s));this.emit(Vn.INSPECT_RESULT,o)}else this.emit(Vn.INSPECT_RESULT,void 0,new B(A.UNEXPECTED_RESPONSE,i.code+"","There is an unexpected data on message"))}else this.emit(Vn.INSPECT_RESULT,void 0,new B(A.UNEXPECTED_RESPONSE,i.code+"",i.msg))}else m.error("[".concat(this._inspectId,"] Unexpected message type from worker")),this.emit(Vn.INSPECT_RESULT,void 0,new B(A.UNEXPECTED_RESPONSE,"invalid worker message type"))})),this.workerConnection.on(Bt.CLOSED,(()=>{this.connectionState=is.CLOSED})),this.workerConnection.on(Bt.FAILED,(()=>{this.connectionState=is.CLOSED})),this.workerConnection.on(Bt.RECONNECTING,(()=>{this.connectionState=this.connectionState===is.CONNECTED?is.RECONNECTING:is.CONNECTING})),this.workerConnection.on(Bt.WILL_RECONNECT,((e,n,i)=>{e==="recover"&&i(e),i("tryNext")})),this.workerConnection.on(Bt.REQUEST_NEW_URLS,((e,n)=>{this.workerManagerConnection.close(),this.once(Vn.REQUEST_NEW_WORKER_URL,(i=>{e([i])})),this.requestAP(this._connectInfo,this._cancelTokenSource.token,this._retryConfig).then((i=>{this.connectWorkerManager(i,!0)})).catch((i=>{n(i)}))}))}async requestToInspectImage(){this.sequence++;const e=Ji(this,Vn.CLIENT_LOCAL_VIDEO_TRACK),n={appId:this._connectInfo.appId,cname:this._connectInfo.cname,cid:this._connectInfo.cid,sid:this._connectInfo.sid,uid:this._connectInfo.uid,vid:this._connectInfo.vid};if(e){if(!e.isPlaying)return void this.emit(Vn.INSPECT_RESULT,void 0,new B(A.INVALID_OPERATION,"Only the track being played can be inspected"));const i=await this.generateRequestData(e,n);this.workerConnection.sendMessage(i,!0,!0)}else this.emit(Vn.INSPECT_RESULT,void 0,new B(A.INVALID_OPERATION,"Only the track being published can be inspected"))}async generateRequestData(e,n){let{appId:i,cname:r,cid:s,vid:o,sid:a,uid:c}=n;const d=Date.now(),l=await e.getCurrentFrameImage("image/jpeg",this.quality),h=await U0(l,i,r),p=this.sequence+"-"+s+"-"+c+"-"+d+"-"+Se(12,""),f={appId:i,cid:s,cname:r,deviceId:"",elapse:(v=Number(d-this.inspectStartTime),{low:v|=0,high:v>>31,unsigned:v>=0}),fileSize:h.byteLength,jpgEncryption:2,height:l.height,width:l.width,jpg:h,networkType:6,osType:7,requestId:p,sdkVersion:"4.24.1",sequence:this.sequence,sid:a,timestamp:uL(d),uid:c,vid:o,service:this._inspectMode,callbackData:this.extraInfo,ossFilePrefix:this.ossFilePrefix};var v;this.extraInfo===void 0&&delete f.callbackData,this.ossFilePrefix===void 0&&delete f.ossFilePrefix;const S=Mz(f);if(S.byteLength<this.workerMessageLengthLimit){if(I("SHOW_VIDEO_INSPECT_WORKER_MESSAGE")){const T=(function(b){for(var w=1;w<arguments.length;w++){var D=arguments[w]!=null?arguments[w]:{};w%2?aM(Object(D),!0).forEach((function(k){R(b,k,D[k])})):Object.getOwnPropertyDescriptors?Object.defineProperties(b,Object.getOwnPropertyDescriptors(D)):aM(Object(D)).forEach((function(k){Object.defineProperty(b,k,Object.getOwnPropertyDescriptor(D,k))}))}return b})({},f);delete T.jpg,m.debug("[".concat(this._inspectId,"] Request message for worker of inspect content "),JSON.stringify(T))}return S}{const T=this.quality*this.qualityRatio;return this.quality=T,await this.generateRequestData(e,{appId:i,cname:r,cid:s,vid:o,sid:a,uid:c})}}close(){this._cancelTokenSource.cancel(),this._cancelTokenSource=yi.CancelToken.source(),this.workerManagerConnection&&this.workerManagerConnection.close(),this.workerConnection&&this.workerConnection.close(),this.inspectTimer&&window.clearInterval(this.inspectTimer),this.inspectTimer=null,this.connectionState=is.CLOSED,this.emit(Vn.STATE_CHANGE,rs.CLOSED)}}const Kz={name:"ContentInspect",create:function(t){let{config:e}=t;return(function(n){if(!n)throw new B(A.INVALID_PARAMS,"inspectConfig is necessary.");if(!n.inspectType||!Array.isArray(n.inspectType))throw new B(A.INVALID_PARAMS,"inspectConfig.inspectType is necessary and is an instance of Array.");{const i=[...new Set(n.inspectType)];i.forEach((r=>{var s;if(!$(s=["supervise","moderation"]).call(s,r))throw new B(A.INVALID_PARAMS,"".concat(r," is not a valid inspect type."))})),n.inspectType=i}if(n&&n.extraInfo&&n.extraInfo.length>1024)throw new B(A.INVALID_PARAMS,"inspectConfig.extraInfo length cannot exceed 1024 bytes")})(e),new Hz(e)}};var cM=y(It.Object.getOwnPropertySymbols),Yz=ge,qz=em.indexOf,zz=gh,cR=Pi([].indexOf),dM=!!cR&&1/cR([1],1,-0)<0;Yz({target:"Array",proto:!0,forced:dM||!zz("indexOf")},{indexOf:function(t){var e=arguments.length>1?arguments[1]:void 0;return dM?cR(this,t,e)||0:qz(this,t,e)}});var Xz=yr("Array","indexOf"),Jz=Z,Qz=Xz,dR=Array.prototype,Zz=function(t){var e=t.indexOf;return t===dR||Jz(dR,t)&&e===dR.indexOf?Qz:e},lM=y(Zz);function $z(t,e){if(t==null)return{};var n,i,r=(function(o,a){if(o==null)return{};var c={};for(var d in o)if({}.hasOwnProperty.call(o,d)){if(lM(a).call(a,d)!==-1)continue;c[d]=o[d]}return c})(t,e);if(cM){var s=cM(t);for(i=0;i<s.length;i++)n=s[i],lM(e).call(e,n)===-1&&{}.propertyIsEnumerable.call(t,n)&&(r[n]=t[n])}return r}let uM=class{get localCapabilities(){return Ve(this._localCapabilities)}get rtpCapabilities(){return Ve(this._rtpCapabilities)}get candidates(){return Ve(this._candidates)}get iceParameters(){return Ve(this._iceParameters)}get dtlsParameters(){return Ve(this._dtlsParameters)}constructor(t){R(this,"sessionDesc",void 0),R(this,"_localCapabilities",void 0),R(this,"_rtpCapabilities",void 0),R(this,"_candidates",void 0),R(this,"_iceParameters",void 0),R(this,"_dtlsParameters",void 0),R(this,"setup",void 0),R(this,"currentMidIndex",void 0),R(this,"cname","o/i14u9pJrxRKAsu"),R(this,"firefoxSsrcMidMap",new Map),t=Ve(t);const{remoteIceParameters:e,remoteDtlsParameters:n,candidates:i,remoteRTPCapabilities:r,localCapabilities:s,direction:o,setup:a,videoCodec:c,audioCodec:d}=t;let l;this.setup=a,l=o===Ti.RECEIVE_ONLY?Ei(`v=0
o=- 0 0 IN IP4 127.0.0.1
s=AgoraGateway
t=0 0
a=group:BUNDLE 0 1
a=msid-semantic: WMS
a=extmap-allow-mixed
m=video 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendonly
a=rtcp-mux
a=rtcp-rsize
a=mid:0
m=audio 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendonly
a=rtcp-mux
a=rtcp-rsize
a=mid:1
`):Ei(`v=0
o=- 0 0 IN IP4 127.0.0.1
s=AgoraGateway
t=0 0
a=group:BUNDLE 0 1
a=msid-semantic: WMS
a=extmap-allow-mixed
m=video 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=recvonly
a=rtcp-mux
a=rtcp-rsize
a=mid:0
m=audio 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=recvonly
a=rtcp-mux
a=rtcp-rsize
a=mid:1
`),this._rtpCapabilities=r,this._candidates=i,this._iceParameters=e,this._dtlsParameters=n,this._localCapabilities=s;const h=o===Ti.RECEIVE_ONLY?this.rtpCapabilities.send:this.rtpCapabilities.recv,p=o===Ti.RECEIVE_ONLY?this._localCapabilities.recv:this._localCapabilities.send,f=o===Ti.RECEIVE_ONLY?r.send.videoCodecs:Su(ut.VIDEO,h,p,c),v=o===Ti.RECEIVE_ONLY?r.send.audioCodecs:Su(ut.AUDIO,h,p,d);for(const S of l.mediaDescriptions)S.attributes.iceUfrag=e.iceUfrag,S.attributes.icePwd=e.icePwd,S.attributes.fingerprints=n.fingerprints,S.attributes.candidates=i,S.attributes.setup=this.setup,S.media.mediaType==="application"&&(S.attributes.sctpPort="5000"),S.media.mediaType==="video"&&(S.media.fmts=f.map((T=>T.payloadType.toString(10))),S.attributes.payloads=f,S.attributes.extmaps=h.videoExtensions),S.media.mediaType==="audio"&&(S.media.fmts=v.map((T=>T.payloadType.toString(10))),S.attributes.payloads=v,S.attributes.extmaps=h.audioExtensions,Gd(S));this.sessionDesc=l,this.currentMidIndex=l.mediaDescriptions.length-1}toString(){return Oo(this.sessionDesc)}hasMid(t){return Array.isArray(t)?t.every((e=>this.hasMid(e))):this.sessionDesc.mediaDescriptions.some((e=>e.attributes.mid===t))}send(t,e,n,i,r){n=n.replace(/ /g,"-");const{ssrcs:s,ssrcGroups:o}=Eu(e,this.cname,I("SYNC_GROUP")?n:void 0),a=this.findPreloadMediaDesc(s);if(a){if(xe()&&this.firefoxSsrcMidMap.set(s[0].ssrcId,a.attributes.mid),r&&(r.twcc||r.remb)){const c=this.sessionDesc.mediaDescriptions.indexOf(a);return this.sessionDesc.mediaDescriptions[c]=this.mungSendMediaDesc(a,r),{mid:a.attributes.mid,needExchangeSDP:!0}}return{mid:a.attributes.mid,needExchangeSDP:!1}}{const c=this.findAvailableMediaIndex(t,s,i);let d;return c===-1?(d=this.createOrRecycleSendMedia(t,s,o,"sendonly",i,r),this.updateBundleMids()):(d=Ve(this.sessionDesc.mediaDescriptions[c]),d.attributes.direction="sendonly",d.attributes.ssrcs=s,d.attributes.ssrcGroups=o,this.sessionDesc.mediaDescriptions[c]=this.mungSendMediaDesc(d,r)),xe()&&this.firefoxSsrcMidMap.set(s[0].ssrcId,d.attributes.mid),{needExchangeSDP:!0,mid:d.attributes.mid}}}stopSending(t){const e=this.sessionDesc.mediaDescriptions.filter((n=>n.attributes.mid&&t.indexOf(n.attributes.mid)!==-1));if(e.length!==t.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.stopSending.");e.forEach((n=>{n.attributes.ssrcs=[]})),this.updateBundleMids()}receive(t,e,n){const i=[];return t.forEach((r=>{const s=r._mediaStreamTrack.kind,o=this.findAvailableRecvMediaIndex(s);let a,c=!1;o===-1?(c=!0,a=this.createOrRecycleRecvMedia(r,[],"recvonly",e,n),this.updateBundleMids()):(a=Ve(this.sessionDesc.mediaDescriptions[o]),a.attributes.direction="recvonly"),i.push({mid:a.attributes.mid,needCreateTransceiver:c})})),i}stopReceiving(t){const e=this.sessionDesc.mediaDescriptions.filter((n=>t.indexOf(n.attributes.mid)!==-1));if(e.length!==t.length)throw new Error("MediaDescriptions' length doesn't match mids's length when calling RemoteSDP.receive.");e.forEach((n=>{n.media.port="0",n.attributes.direction="inactive"})),this.updateBundleMids()}addRemoteCandidate(t){const{foundation:e,protocol:n,address:i,port:r,type:s,relatedAddress:o,relatedPort:a,priority:c}=new RTCIceCandidate(t),d={foundation:e??"",componentId:"1",transport:n??"",priority:c?c+"":"",connectionAddress:i??"",port:r?r+"":"",type:s?s+"":"",relAddr:o??"",relPort:a?a+"":"",extension:{}};this.candidates.some((l=>l.priority===d.priority&&l.connectionAddress===d.connectionAddress&&l.port===d.port))||(this._candidates.push(d),this.sessionDesc.mediaDescriptions.forEach((l=>{l.attributes.candidates=this.candidates})))}clearRemoteCandidate(){this._candidates=[],this.sessionDesc.mediaDescriptions[0].attributes.candidates=this._candidates}createOrRecycleRecvMedia(t,e,n,i,r){const s=t._mediaStreamTrack.kind,o=this.rtpCapabilities.recv,a=Su(s,o,this.localCapabilities.send,s===ut.AUDIO?r:i),c=s===ut.VIDEO?o.videoExtensions:o.audioExtensions,d="".concat(++this.currentMidIndex);let l={media:{mediaType:s,port:"9",protos:["UDP","TLS","RTP","SAVPF"],fmts:a.map((p=>p.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:[],extmaps:c,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:e,ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:a,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:n,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(d)}};l=this.mungRecvMediaDsec(l,t);const h=this.findFirstClosedMedia(s);if(h){const p=this.sessionDesc.mediaDescriptions.indexOf(h);this.sessionDesc.mediaDescriptions[p]=l}else this.sessionDesc.mediaDescriptions.push(l);return l}muteRemote(t){const e=this.sessionDesc.mediaDescriptions.filter((n=>$(t).call(t,n.attributes.mid||"")));if(e.length!==t.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");e.forEach((n=>{n.attributes.direction="inactive"}))}unmuteRemote(t){const e=this.sessionDesc.mediaDescriptions.filter((n=>$(t).call(t,n.attributes.mid||"")));if(e.length!==t.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");e.forEach((n=>{n.attributes.direction="recvonly"}))}findAvailableMediaIndex(t,e,n){return this.sessionDesc.mediaDescriptions.findIndex((i=>{const r=i.media.mediaType===t&&i.media.port!=="0"&&(i.attributes.direction==="sendonly"||i.attributes.direction==="sendrecv")&&i.attributes.ssrcs.length===0;if(xe()){if(r){const s=this.firefoxSsrcMidMap.get(e[0].ssrcId);return!(s||i.attributes.mid!=="0"&&i.attributes.mid!=="1")||!(!s||s!==i.attributes.mid)}return!1}return r&&i.attributes.mid===n}))}findAvailableRecvMediaIndex(t){return this.sessionDesc.mediaDescriptions.findIndex((e=>{const n=e.media.mediaType===t&&e.media.port!=="0"&&(e.attributes.direction==="recvonly"||e.attributes.direction==="sendrecv");return e.attributes.mid!=="0"&&e.attributes.mid!=="1"&&n}))}predictReceivingMids(t){const e=[];for(let n=0;n<t;n++)e.push((this.currentMidIndex+n+1).toString(10));return e}restartICE(t){t=Ve(t),this._iceParameters=t,this.sessionDesc.mediaDescriptions.forEach((e=>{e.attributes.iceUfrag=t.iceUfrag,e.attributes.icePwd=t.icePwd}))}createOrRecycleSendMedia(t,e,n,i,r,s){const o=this.rtpCapabilities.send,a=t===ut.VIDEO?o.videoCodecs:o.audioCodecs,c=t===ut.VIDEO?o.videoExtensions:o.audioExtensions;xe()&&(r="".concat(++this.currentMidIndex));let d={media:{mediaType:t,port:"9",protos:["UDP","TLS","RTP","SAVPF"],fmts:a.map((h=>h.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:[],extmaps:c,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:e,ssrcGroups:n,rtcpFeedbackWildcards:[],payloads:a,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:i,rtcpMux:!0,rtcpRsize:!0,mid:r}};d=this.mungSendMediaDesc(d,s);const l=this.findFirstClosedMedia(t);if(l){const h=this.sessionDesc.mediaDescriptions.indexOf(l);this.sessionDesc.mediaDescriptions[h]=d}else this.sessionDesc.mediaDescriptions.push(d);return d}mungRecvMediaDsec(t,e,n){const i=Ve(t);return eT(i),_c(i,e),nT(i,e),eP(i),A_(i,n,this.localCapabilities.send),i}mungSendMediaDesc(t,e){const n=Ve(t);return A_(n,e,this.localCapabilities.recv),Gd(n),n}updateRecvMedia(t,e){const n=this.sessionDesc.mediaDescriptions.findIndex((i=>i.attributes.mid===t));if(n!==-1){const i=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[n],e);this.sessionDesc.mediaDescriptions[n]=i}}updateBundleMids(){this.sessionDesc.attributes.groups[0].identificationTag=this.sessionDesc.mediaDescriptions.filter((t=>t.media.port!=="0")).map((t=>t.attributes.mid))}findPreloadMediaDesc(t){return this.sessionDesc.mediaDescriptions.find((e=>{var n;return((n=e.attributes)===null||n===void 0||(n=n.ssrcs[0])===null||n===void 0?void 0:n.ssrcId)===t[0].ssrcId}))}findFirstClosedMedia(t){return this.sessionDesc.mediaDescriptions.find((e=>xe()?e.media.port==="0"&&e.media.mediaType===t:e.media.port==="0"))}};const tX=["sdp"];var Fe;function hM(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable}))),n.push.apply(n,i)}return n}function Ca(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?hM(Object(n),!0).forEach((function(i){R(t,i,n[i])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):hM(Object(n)).forEach((function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i))}))}return t}let pM=(Fe=class cl extends xD{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get dtlsTransportState(){var e,n;return(e=(n=this.peerConnection.getReceivers()[0])===null||n===void 0||(n=n.transport)===null||n===void 0?void 0:n.state)!==null&&e!==void 0?e:null}get localCodecs(){return[]}set isInRestartIce(e){this._isInRestartIce=e}get isInRestartIce(){return this._isInRestartIce}constructor(e,n,i){super(e,n),R(this,"direction",void 0),R(this,"name",void 0),R(this,"store",void 0),R(this,"spec",void 0),R(this,"peerConnection",void 0),R(this,"initialOffer",void 0),R(this,"transport",void 0),R(this,"statsFilter",void 0),R(this,"localCandidateCount",0),R(this,"_isInRestartIce",!1),R(this,"mutex",void 0),R(this,"onLocalCandidate",void 0),R(this,"remoteSDP",void 0),R(this,"pendingCandidates",[]),R(this,"localCapabilities",void 0),R(this,"isReady",!1),R(this,"restartCnt",0),R(this,"curTurnServerIndex",0),this.store=n,this.spec=e,this.mutex=new Un("P2PConnection-mutex",n.clientId),this.peerConnection=new RTCPeerConnection(cl.resolvePCConfiguration(e,n.p2pTransport),{optional:[{googDscp:!0}]}),this.direction=i??Ti.SEND_ONLY,this.name=this.direction===Ti.SEND_ONLY?"sendP2PConnection":"recvP2PConnection",this.statsFilter=Xp(this.peerConnection,I("STATS_UPDATE_INTERVAL"),void 0,xe()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1}async establish(e){try{const n=await rT();if(this.localCapabilities=gu(n),e){const{sdp:i}=e,r=$z(e,tX),s=(function(){const l={audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]},h=mu(arguments.length>2?arguments[2]:void 0,arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},"sendonly"),p={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},f={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},v={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]};if(os(h,l,"videoExtensions",p,f,v),os(h,l,"videoCodecs",p,f,v),os(h,l,"audioExtensions",p,f,v),os(h,l,"audioCodecs",p,f,v),I("RAISE_H264_BASELINE_PRIORITY")){const S=v.videoCodecs.findIndex((T=>T.rtpMap&&T.rtpMap.encodingName.toLocaleLowerCase()==="h264"&&T.fmtp&&T.fmtp.parameters["profile-level-id"]==="42001f"));if(S!==-1){const T=v.videoCodecs.findIndex((b=>b.rtpMap&&b.rtpMap.encodingName.toLocaleLowerCase()==="h264"));if(T<S){m.debug("raising H264 baseline profile priority");const b=v.videoCodecs[S];v.videoCodecs.splice(S,1),v.videoCodecs.splice(T,0,b)}T!==-1&&I("FILTER_SEND_H264_BASELINE")&&(p.videoCodecs=p.videoCodecs.filter((b=>!(b.rtpMap&&b.rtpMap.encodingName.toLocaleLowerCase()==="h264"&&b.fmtp&&b.fmtp.parameters["profile-level-id"]!=="42001f"))))}}return{send:p,recv:f,sendrecv:v}})({},{},i);this.remoteSDP=new uM({remoteIceParameters:r.iceParameters,remoteDtlsParameters:r.dtlsParameters,candidates:[],remoteRTPCapabilities:s,localCapabilities:this.localCapabilities,direction:this.direction,setup:"actpass",videoCodec:this.store.codec,audioCodec:this.store.audioCodec}),await this.setRemoteDescription({type:"offer",sdp:this.remoteSDP.toString()}),this.isReady=!0;const o=await this.peerConnection.createAnswer();if(!o.sdp)throw new Error("Cannot get answer sdp when trying to establish PeerConnection.");const a=no(o.sdp);await this.peerConnection.setLocalDescription(o);const c=await iP({},{},o.sdp);this.localCapabilities=gu(c);const d=this.peerConnection.getTransceivers()[0];return d!=null&&d.receiver&&d.receiver.transport&&this.tryBindTransportEvents(d.receiver.transport),Ca(Ca({},a),{},{sdp:o.sdp})}{this.peerConnection.addTransceiver("video",{direction:"sendonly"}),this.peerConnection.addTransceiver("audio",{direction:"sendonly"});const i=await this.peerConnection.createOffer();if(!i.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const r=no(i.sdp);return this.initialOffer=i,Ca(Ca({},r),{},{sdp:i.sdp})}}catch(n){throw new H(A.GET_LOCAL_CONNECTION_PARAMS_FAILED,n.toString())}}async connect(e){try{if(!this.initialOffer)throw new Error("Cannot establish P2PConnection without initial offer.");await this.peerConnection.setLocalDescription(this.initialOffer);const{sdp:n,iceParameters:i,dtlsParameters:r}=e,s=await iP({},{},n);this.remoteSDP=new uM({remoteIceParameters:i,remoteDtlsParameters:r,candidates:[],remoteRTPCapabilities:s,localCapabilities:this.localCapabilities,direction:this.direction,setup:"active",videoCodec:this.store.codec,audioCodec:this.store.audioCodec}),await this.setRemoteDescription({type:"answer",sdp:this.remoteSDP.toString()});const o=this.peerConnection.getTransceivers()[0];o!=null&&o.sender&&o.sender.transport&&this.tryBindTransportEvents(o.sender.transport)}catch(n){throw new H(A.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(n.toString()))}}async addRemoteCandidate(e){try{e&&this.pendingCandidates.push(e),this.peerConnection.remoteDescription&&this.isReady&&(this.pendingCandidates.forEach((n=>{this.peerConnection.addIceCandidate(n)})),this.pendingCandidates=[])}catch(n){throw new H(A.ADD_CANDIDATE_FAILED,"P2PConnection.addRemoteCandidate failed; ".concat(n.toString()))}}send(e,n,i){var r=this;return Ci((function*(){const s=yield Ht(r.mutex.lock("From P2PConnection.send"));try{if(!r.remoteSDP)throw new Error("Cannot call P2PConnection.send before remote SDP created");const o=[],a=r.remoteSDP.receive(e,n,i);e.forEach(((T,b)=>{if(a[b].needCreateTransceiver){const w=r.peerConnection.addTransceiver(T._mediaStreamTrack,{direction:"sendonly"});o.push(w),T._updateRtpTransceiver(w)}else{const w=r.peerConnection.getTransceivers().find((D=>D.mid===a[b].mid));if(!w)throw new Error("cannot find transceiver when sendPeerconnection send, mid is ".concat(a[b].mid));o.push(w),T._updateRtpTransceiver(w)}})),xe()&&I("SIMULCAST")===!0&&(yield Ht(r.applySimulcastForFirefox(o,e)));const c=a.map((T=>T.mid)),d=yield Ht(r.peerConnection.createOffer()),l=r.mungSendOfferSDP(d.sdp,e,c),h=Ei(l),p=c.map((T=>{const b=h.mediaDescriptions.find((w=>w.attributes.mid===T));if(!b)throw new Error("Cannot extract ssrc from mediaDescription.");return tT(b,I("USE_PUB_RTX"))})),f=o.map(((T,b)=>{const w=c[b];return{localSSRC:p[b],id:w}}));yield Ht(r.peerConnection.setLocalDescription({type:"offer",sdp:l}));try{yield f}catch(T){const b=r.remoteSDP.toString();throw yield Ht(r.peerConnection.setLocalDescription({type:"offer",sdp:l})),yield Ht(r.peerConnection.setRemoteDescription({type:"answer",sdp:b})),yield Ht(r.stopSending(c,!0)),T}yield Ht(r.applySimulcastEncodings(o,e)),yield Ht(r.applySendEncodings(o,e));const v=r.remoteSDP.toString(),S=r.logSDPExchange(l,"offer","local","send");return S?.(v),yield Ht(r.setRemoteDescription({type:"answer",sdp:v})),o.map(((T,b)=>{const w=c[b];return{localSSRC:p[b],id:w}}))}catch(o){throw o instanceof H?o:new H(A.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(o.toString()))}finally{s()}}))()}async stopSending(e,n){const i=n?void 0:await this.mutex.lock("From P2PConnection.stopSending");try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopSending before remote SDP created");const r=this.peerConnection.getTransceivers().filter((c=>e.indexOf(c.mid)!==-1));if(r.length!==e.length)throw new Error("Transceivers' length (".concat(r.length,") doesn't match mids' length (").concat(e.length,") when trying to call P2PConnection.stopSending."));r.map((c=>{var d;c.direction="inactive",(d=c.stop)===null||d===void 0||d.call(c)}));const s=await this.peerConnection.createOffer(),o=this.logSDPExchange(s.sdp||"","offer","local","stopSending");await this.peerConnection.setLocalDescription(s),this.remoteSDP.stopReceiving(e);const a=this.remoteSDP.toString();o?.(a),await this.setRemoteDescription({type:"answer",sdp:a})}catch(r){throw new H(A.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(r.toString()))}finally{i&&i()}}async receive(e,n,i,r){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(e," before remoteSDP created."));const{mid:s,needExchangeSDP:o}=this.remoteSDP.send(e,n,i,r);if(o){const c=this.remoteSDP.toString(),d=this.logSDPExchange(c,"offer","remote","receive");await this.setRemoteDescription({type:"offer",sdp:c});const l=await this.peerConnection.createAnswer(),h=this.mungReceiveAnswerSDP(l.sdp,s,e);d?.(h||""),await this.peerConnection.setLocalDescription({type:"answer",sdp:h}),m.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(e," by exchanging SDP."))}else m.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(e," no need to exchange SDP."));const a=this.peerConnection.getTransceivers().find((c=>c.mid===s));if(!a||a.mid===null)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:a.receiver.track,mid:a.mid,transceiver:a}}catch(s){throw new H(A.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(s.toString()))}}async mockReceive(e,n,i,r){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(e," before remoteSDP created."));const{mid:s,needExchangeSDP:o}=this.remoteSDP.send(e,n,i,r);if(o){const a=this.remoteSDP.toString(),c=this.logSDPExchange(a,"offer","remote","receive");await this.setRemoteDescription({type:"offer",sdp:a});const d=await this.peerConnection.createAnswer(),l=this.mungReceiveAnswerSDP(d.sdp,s,e);c?.(l||""),await this.peerConnection.setLocalDescription({type:"answer",sdp:l}),m.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(e," by exchanging SDP."))}else m.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(e," no need to exchange SDP."))}catch(s){throw new H(A.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(s.toString()))}}async stopReceiving(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(e);const n=this.remoteSDP.toString(),i=this.logSDPExchange(n,"offer","remote","stopReceiving");await this.setRemoteDescription({type:"offer",sdp:n});const r=await this.peerConnection.createAnswer();i?.(r.sdp||""),await this.peerConnection.setLocalDescription(r)}catch(n){throw new H(A.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(n.toString()))}}async restartICE(e){try{if(this.store.p2pTransport===nc.Auto&&(this.store.p2pTransport=nc.SdRtn,Jt().supportPCSetConfiguration&&this.peerConnection.setConfiguration(cl.resolvePCConfiguration(this.spec,this.store.p2pTransport))),this.restartCnt>3&&(this.restartCnt=0,Jt().supportPCSetConfiguration&&this.peerConnection.setConfiguration(cl.resolvePCConfiguration(this.spec,this.store.p2pTransport,++this.curTurnServerIndex))),!e){this.restartCnt++,this.isReady=!1;const n=await this.peerConnection.createOffer({iceRestart:!0});if(!n.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const{iceParameters:i}=no(n.sdp);return this.store.descriptionStart(),this.direction===Ti.SEND_ONLY&&await this.peerConnection.setLocalDescription(n),i}if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");if(this.remoteSDP.restartICE(e),this.store.descriptionStart(),this.direction===Ti.RECEIVE_ONLY){this.restartCnt++,await this.setRemoteDescription({type:"offer",sdp:this.remoteSDP.toString()});const n=await this.peerConnection.createAnswer();if(!n.sdp)throw new Error("Cannot get answer sdp when trying to iceRestart.");const{iceParameters:i}=no(n.sdp);return await this.peerConnection.setLocalDescription(n),i}await this.setRemoteDescription({type:"answer",sdp:this.remoteSDP.toString()}),this.isReady=!0}catch(n){throw new H(A.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(n.toString()))}}close(){var e;this.peerConnection.close(),this.peerConnection.onicecandidate=null,(e=this.onConnectionStateChange)===null||e===void 0||e.call(this,"closed"),this.tryUnbindTransportEvents(),this.unbindPCEvents(),this.unbindStatsEvents(),this.transport=void 0,this.statsFilter.destroy()}getStats(){return this.statsFilter.getStats()}getRemoteVideoIsReady(e){return this.statsFilter.getVideoIsReady(e)}async updateEncoderConfig(e,n){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateEncoderConfig before remote SDP created.");const i=await this.peerConnection.createOffer(),r=this.mungSendOfferSDP(i.sdp,[n],[e]);this.remoteSDP.updateRecvMedia(e,n);const s=this.remoteSDP.toString(),o=this.logSDPExchange(r,"offer","local","updateEncoderConfig");await this.peerConnection.setLocalDescription({type:"offer",sdp:r}),o?.(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(i){throw new H(A.EXCHANGE_SDP_FAILED,i.toString())}}async updateSendParameters(e,n){const i=this.peerConnection.getTransceivers().filter((r=>r.mid===e));i.length===1&&(this.isVP8Simulcast(n)?xe()||await this.applySimulcastEncodings(i,[n]):await this.applySendEncodings(i,[n]))}setStatsRemoteVideoIsReady(e,n){this.statsFilter.setVideoIsReady2(e,n)}async replaceTrack(e,n){const i=this.peerConnection.getTransceivers().find((r=>r.mid===n));i&&await i.sender.replaceTrack(e._mediaStreamTrack)}async getSelectedCandidatePair(){const e=this.peerConnection.getReceivers();if(e.length>0&&e[0].transport&&e[0].transport.iceTransport&&e[0].transport.iceTransport.getSelectedCandidatePair&&e[0].transport.iceTransport.getSelectedCandidatePair()){const n=e[0].transport.iceTransport,{local:i,remote:r}=n.getSelectedCandidatePair();return{local:Ca(Ca({},ts),{},{candidateType:i.type,protocol:i.protocol,address:i.address,port:i.port}),remote:Ca(Ca({},ts),{},{candidateType:r.type,protocol:r.protocol,address:r.address,port:r.port})}}return this.statsFilter.getSelectedCandidatePair()}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var e,n;$(e=["connected","completed"]).call(e,this.peerConnection.iceConnectionState)&&(this.isReady=!1),(n=this.onICEConnectionStateChange)===null||n===void 0||n.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var e;this.peerConnection.connectionState==="connected"&&(this.restartCnt=0),(e=this.onConnectionStateChange)===null||e===void 0||e.call(this,this.peerConnection.connectionState)},this.startICECandidate()}startICECandidate(){this.peerConnection.onicecandidate||(this.localCandidateCount=0,this.peerConnection.onicecandidate=e=>{if(e.candidate){var n;e.candidate.candidate&&((n=this.onLocalCandidate)===null||n===void 0||n.call(this,e.candidate.toJSON())),this.localCandidateCount+=1}else m.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount)})}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(e,n){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:0;const r={iceServers:[]};var s;return e.iceServers?r.iceServers=e.iceServers:e.turnServer&&e.turnServer.mode!=="off"&&(Ja(e.turnServer.servers)?r.iceServers=e.turnServer.servers:(r.iceServers&&r.iceServers.push(...cl.turnServerConfigToIceServers(e.turnServer.servers,n,i)),I("USE_TURN_SERVER_OF_GATEWAY")&&r.iceServers&&e.turnServer.serversFromGateway&&r.iceServers.push(...cl.turnServerConfigToIceServers(e.turnServer.serversFromGateway,n,i)),$(s=[nc.Relay,nc.SdRtn]).call(s,n)&&(r.iceTransportPolicy="relay"),I("FORCE_TURN_TCP")?r.iceTransportPolicy="relay":e.turnServer.servers.concat(e.turnServer.serversFromGateway||[]).forEach((o=>{o.forceturn&&(r.iceTransportPolicy="relay")})))),I("ENABLE_ENCODED_TRANSFORM")&&Jt().supportWebRTCEncodedTransform&&(r.encodedInsertableStreams=!0),m.debug("P2PConnection p2pTransport is ".concat(n)),r}static turnServerConfigToIceServers(e,n){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:0;const r=[],s=e.filter((a=>a.tcpport));m.debug("P2PConnection turnServers is ".concat(s,", current index is ").concat(i));const o=s.length>i?s[i]:s[0];switch(n){case nc.SdRtn:const a=e.filter((d=>{var l;return $(l=d.username).call(l,"glb:")&&d.turnServerURL==d.turnServerURL})),c=a.length>i?a[i]:a[0];c&&(r.push({username:c.username,credential:c.password,credentialType:"password",urls:"turn:".concat(ss(c.turnServerURL),":").concat(c.tcpport,"?transport=udp")}),r.push({username:c.username,credential:c.password,credentialType:"password",urls:"turns:".concat(ss(c.turnServerURL),":").concat(c.tcpport,"?transport=tcp")}));break;case nc.Relay:o&&(r.push({username:o.username,credential:o.password,credentialType:"password",urls:"turn:".concat(o.turnServerURL,":").concat(o.tcpport,"?transport=udp")}),r.push({username:o.username,credential:o.password,credentialType:"password",urls:"turns:".concat(ss(o.turnServerURL),":").concat(o.tcpport,"?transport=tcp")}));break;default:o&&(r.push({username:o.username,credential:o.password,credentialType:"password",urls:"turn:".concat(o.turnServerURL,":").concat(o.tcpport,"?transport=udp")}),r.push({username:o.username,credential:o.password,credentialType:"password",urls:"turns:".concat(ss(o.turnServerURL),":").concat(o.tcpport,"?transport=tcp")}),r.push({username:o.username,credential:o.password,credentialType:"password",urls:"stun:".concat(o.turnServerURL,":").concat(o.tcpport)}))}return r}tryBindTransportEvents(e){if(e){this.transport=e,e.onstatechange=()=>{var i;e!=null&&e.state&&((i=this.onDTLSTransportStateChange)===null||i===void 0||i.call(this,e.state))},e.onerror=i=>{var r;(r=this.onDTLSTransportError)===null||r===void 0||r.call(this,"error"in i?i.error:i)};const n=e.iceTransport;n&&(n.onstatechange=()=>{const i=e?.iceTransport.state;var r;i&&((r=this.onICETransportStateChange)===null||r===void 0||r.call(this,i))},n.getSelectedCandidatePair&&(n.onselectedcandidatepairchange=()=>{if(n.getSelectedCandidatePair()){const{local:i,remote:r}=n.getSelectedCandidatePair()||{};if(i&&r){const s=i.address+":"+i.port,o=r.address+":"+r.port;m.info("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] selectedcandidatepairchange: local ").concat(JSON.stringify(eo(s)),", remote ").concat(JSON.stringify(eo(o))))}}}))}}tryUnbindTransportEvents(){this.transport&&(this.transport.onstatechange=null,this.transport.onerror=null,this.transport.iceTransport&&(this.transport.iceTransport.onstatechange=null))}async updateRtpSenderEncodings(e,n){var i;if(n||(n=this.peerConnection.getSenders().find((l=>l.track===e._mediaStreamTrack))),!n)return m.warn("[".concat(e.getTrackId(),"] no rtpSender found}"));if(this.isVP8Simulcast(e))return m.warn("[updateRtpSenderEncodings] Track is VP8 simulcast, please apply simulcast encodings");if(!Jt().supportSetRtpSenderParameters)return m.warn("[updateRtpSenderEncodings] Browser not support set rtp-sender parameters");const r={},s={};switch(e._optimizationMode){case"motion":r.degradationPreference="maintain-framerate";break;case"detail":r.degradationPreference="maintain-resolution";break;default:r.degradationPreference="balanced"}if(e._encoderConfig){var o;const{bitrateMax:l,frameRate:h,scaleResolutionDownBy:p}=e._encoderConfig;l&&(s.maxBitrate=1e3*l),$(o=e._hints).call(o,Ee.LOW_STREAM)&&(h&&(s.maxFramerate=wi(h)),p&&p>=1&&(s.scaleResolutionDownBy=p))}if(I("DSCP_TYPE")&&Js()){var a;const l=I("DSCP_TYPE");$(a=["very-low","low","medium","high"]).call(a,l)&&(s.networkPriority=l)}const c=n.getParameters(),d=(i=c.encodings)===null||i===void 0?void 0:i[0];xe()&&!d&&(r.encodings=[s]),d&&Object.assign(d,s),Object.assign(c,r),m.debug("[".concat(e.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(c.encodings))),await n.setParameters(c)}async applySendEncodings(e,n){try{if(!Jt().supportSetRtpSenderParameters||e.length!==n.length)return;for(let i=0;i<e.length;i++){const r=e[i],s=n[i];s instanceof De&&!this.isVP8Simulcast(s)&&await this.updateRtpSenderEncodings(s,r.sender)}}catch{m.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}}mungSendOfferSDP(e,n,i){const r=Ei(e);return n.forEach(((s,o)=>{const a=i[o],c=r.mediaDescriptions.find((d=>d.attributes.mid===a));c&&(_c(c,s),iT(c,s,this.store.codec))})),Oo(r)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=e=>{var n;(n=this.onFirstAudioReceived)===null||n===void 0||n.call(this,e)},this.statsFilter.onFirstVideoReceived=e=>{var n;(n=this.onFirstVideoReceived)===null||n===void 0||n.call(this,e)},this.statsFilter.onFirstAudioDecoded=e=>{var n;(n=this.onFirstAudioDecoded)===null||n===void 0||n.call(this,e)},this.statsFilter.onFirstVideoDecoded=(e,n,i)=>{var r;(r=this.onFirstVideoDecoded)===null||r===void 0||r.call(this,e,n,i)},this.statsFilter.onSelectedLocalCandidateChanged=(e,n)=>{var i;(i=this.onSelectedLocalCandidateChanged)===null||i===void 0||i.call(this,e,n)},this.statsFilter.onSelectedRemoteCandidateChanged=(e,n)=>{var i;(i=this.onSelectedRemoteCandidateChanged)===null||i===void 0||i.call(this,e,n)},this.statsFilter.onFirstVideoDecodedTimeout=e=>{var n;(n=this.onFirstVideoDecodedTimeout)===null||n===void 0||n.call(this,e)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0,this.statsFilter.onFirstVideoDecodedTimeout=void 0}async applySimulcastForFirefox(e,n){if(e.length===n.length)for(let c=0;c<e.length;c++){var i,r,s,o,a;const d=e[c],l=n[c];if(l instanceof De&&!$(i=l._hints).call(i,Ee.LOW_STREAM)&&(r=l._encoderConfig)!==null&&r!==void 0&&r.bitrateMax&&((s=l._encoderConfig)===null||s===void 0?void 0:s.bitrateMax)>200&&(o=l._scalabilityMode)!==null&&o!==void 0&&o.numSpatialLayers&&((a=l._scalabilityMode)===null||a===void 0?void 0:a.numSpatialLayers)>1&&this.store.codec==="vp8"){const h={},p={high:1e3*(l._encoderConfig.bitrateMax-50),medium:5e4};h.encodings=[{rid:"m",active:!0,maxBitrate:p.medium,scaleResolutionDownBy:4},{rid:"h",active:!0,maxBitrate:p.high}];const f=d.sender.getParameters();await d.sender.setParameters(Object.assign(f,h))}}}async applySimulcastEncodings(e,n){if(!xe()&&e.length===n.length)for(let i=0;i<e.length;i++){const r=n[i];if(r instanceof De&&this.isVP8Simulcast(r)){const s=e[i],o={},a={high:1e3*(r._encoderConfig.bitrateMax-50),medium:5e4};o.encodings=[{active:!0,adaptivePtime:!1,networkPriority:"high",priority:"high",maxBitrate:a.high},{active:!0,adaptivePtime:!1,networkPriority:"low",priority:"low",maxBitrate:a.medium,scaleResolutionDownBy:4}];const c=s.sender.getParameters();await s.sender.setParameters(Object.assign(c,o))}}}isVP8Simulcast(e){var n,i,r,s,o;return!!(e instanceof De&&I("SIMULCAST")&&this.store.codec==="vp8"&&!$(n=e._hints).call(n,Ee.LOW_STREAM)&&(i=e._encoderConfig)!==null&&i!==void 0&&i.bitrateMax&&((r=e._encoderConfig)===null||r===void 0?void 0:r.bitrateMax)>200&&(s=e._scalabilityMode)!==null&&s!==void 0&&s.numSpatialLayers&&((o=e._scalabilityMode)===null||o===void 0?void 0:o.numSpatialLayers)>1)}logSDPExchange(e,n,i,r){if(I("SDP_LOGGING"))return m.upload("[".concat(this.store.clientId,"] exchanging ").concat(i," ").concat(n," SDP during P2PConnection.").concat(r,`
`),e),n==="offer"?s=>{this.logSDPExchange(s,"answer",i==="local"?"remote":"local",r)}:void 0}async muteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteLocal before remote SDP created.");const n=this.peerConnection.getTransceivers().filter((o=>o.mid&&e.indexOf(o.mid)!==-1));if(n.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");n.map((o=>{o.direction="inactive"}));const i=await this.peerConnection.createOffer(),r=this.logSDPExchange(i.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(i),this.remoteSDP.muteRemote(e);const s=this.remoteSDP.toString();r?.(s),await this.setRemoteDescription({type:"answer",sdp:s})}catch(n){throw new H(A.EXCHANGE_SDP_FAILED,"P2PConnection.muteLocal failed; ".concat(n.toString()))}}async unmuteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteLocal before remote SDP created.");const n=this.peerConnection.getTransceivers().filter((o=>o.mid&&e.indexOf(o.mid)!==-1));if(n.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");n.map((async o=>{o.direction="sendonly"}));const i=await this.peerConnection.createOffer(),r=this.logSDPExchange(i.sdp||"","offer","local","unmuteLocal");await this.peerConnection.setLocalDescription(i),this.remoteSDP.unmuteRemote(e);const s=this.remoteSDP.toString();r?.(s),await this.setRemoteDescription({type:"answer",sdp:s})}catch(n){throw new H(A.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteLocal failed; ".concat(n.toString()))}}async getRemoteSSRC(e,n){var i;if(n=n??((i=this.currentRemoteDescription)===null||i===void 0?void 0:i.sdp)){var r;const s=(r=Ei(n).mediaDescriptions.find((o=>o.attributes.mid===e)))===null||r===void 0?void 0:r.attributes.ssrcs;return s?.[0].ssrcId}}async setRemoteDescription(e){var n;await this.peerConnection.setRemoteDescription(e),$(n=["connected","completed"]).call(n,this.peerConnection.iceConnectionState)||(this.isReady=!0,this.addRemoteCandidate())}mungReceiveAnswerSDP(e,n,i){const r=Ei(e),s=r.mediaDescriptions.find((o=>o.attributes.mid===n));return s&&i===ut.AUDIO&&s.media.mediaType==="audio"&&Gd(s),Oo(r)}},ot(Fe.prototype,"establish",[us],Object.getOwnPropertyDescriptor(Fe.prototype,"establish"),Fe.prototype),ot(Fe.prototype,"connect",[us],Object.getOwnPropertyDescriptor(Fe.prototype,"connect"),Fe.prototype),ot(Fe.prototype,"receive",[us],Object.getOwnPropertyDescriptor(Fe.prototype,"receive"),Fe.prototype),ot(Fe.prototype,"mockReceive",[us],Object.getOwnPropertyDescriptor(Fe.prototype,"mockReceive"),Fe.prototype),ot(Fe.prototype,"stopReceiving",[us],Object.getOwnPropertyDescriptor(Fe.prototype,"stopReceiving"),Fe.prototype),ot(Fe.prototype,"restartICE",[us],Object.getOwnPropertyDescriptor(Fe.prototype,"restartICE"),Fe.prototype),ot(Fe.prototype,"close",[us],Object.getOwnPropertyDescriptor(Fe.prototype,"close"),Fe.prototype),ot(Fe.prototype,"updateEncoderConfig",[us],Object.getOwnPropertyDescriptor(Fe.prototype,"updateEncoderConfig"),Fe.prototype),ot(Fe.prototype,"updateSendParameters",[us],Object.getOwnPropertyDescriptor(Fe.prototype,"updateSendParameters"),Fe.prototype),ot(Fe.prototype,"replaceTrack",[us],Object.getOwnPropertyDescriptor(Fe.prototype,"replaceTrack"),Fe.prototype),ot(Fe.prototype,"muteLocal",[us],Object.getOwnPropertyDescriptor(Fe.prototype,"muteLocal"),Fe.prototype),ot(Fe.prototype,"unmuteLocal",[us],Object.getOwnPropertyDescriptor(Fe.prototype,"unmuteLocal"),Fe.prototype),Fe);function us(t,e,n){const i=t[e];if(typeof i!="function")throw new Error("Cannot use mutex on object property.");return n.value=async function(){const r=this.mutex,s=await r.lock("From P2PConnection.".concat(e));try{for(var o=arguments.length,a=new Array(o),c=0;c<o;c++)a[c]=arguments[c];return await i.apply(this,a)}finally{s()}},n}let Ns=(function(t){return t.SEND_ONLY="SEND_ONLY",t.RECEIVE_ONLY="RECEIVE_ONLY",t})({});var _M,fM,mM,EM,gM,SM,TM,RM,vM,CM,yM,Xe;function IM(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable}))),n.push.apply(n,i)}return n}function lf(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?IM(Object(n),!0).forEach((function(i){R(t,i,n[i])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):IM(Object(n)).forEach((function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i))}))}return t}let eX=(_M=Ds(Ns.SEND_ONLY),fM=Ds(Ns.SEND_ONLY),mM=Ds(),EM=Ds(Ns.RECEIVE_ONLY),gM=Ds(Ns.RECEIVE_ONLY),SM=Ds(Ns.RECEIVE_ONLY),TM=Ds(Ns.RECEIVE_ONLY),RM=Ds(Ns.RECEIVE_ONLY),vM=Ds(Ns.RECEIVE_ONLY),CM=Ds(),yM=Ds(Ns.RECEIVE_ONLY),Xe=class extends qe{get state(){return this._state}set state(t){const e=this._state;this._state=t,this.emit(Rt.StateChange,e,this._state)}constructor(t,e){super(),R(this,"isPlanB",!1),R(this,"store",void 0),R(this,"statsUploader",void 0),R(this,"sendConnection",void 0),R(this,"recvConnection",void 0),R(this,"localTrackMap",new Map),R(this,"remoteUserMap",new Map),R(this,"localDataChannels",[]),R(this,"pendingLocalTracks",[]),R(this,"pendingRemoteTracks",[]),R(this,"statsCollector",void 0),R(this,"dtlsFailedCount",0),R(this,"sendMutex",void 0),R(this,"recvMutex",void 0),R(this,"_state",me.Disconnected),R(this,"_restartStates",["disconnected","failed"]),R(this,"reconnectInterval",void 0),R(this,"uploadUnplinkStarted",!1),R(this,"uploadDownlinkStarted",!1),R(this,"uplinkStateUploadInterval",void 0),R(this,"downlinkStatsUploadInterval",void 0),R(this,"handleMuteLocalTrack",(async(n,i,r)=>{const s=await this.sendMutex.lock("Locking from P2PChannel2.handleMuteLocalTrack");try{if(!this.sendConnection||this.state!==me.Connected)return void r(new H(A.INVALID_OPERATION,"Cannot call P2PChannel2.handleMuteLocalTrack before sendConnection established."));const c=this.filterTobeMutedTracks(n);if(c.length===0)return void i();const d=c.find((f=>f[0]==="videoLowTrack"));d&&d[1].track._originMediaStreamTrack.stop(),await this.sendConnection.muteLocal(c.map((f=>{let[,{id:v}]=f;return v})));let l=!1;var o,a;n.trackMediaType==="video"?l=!((o=this.localTrackMap.get(tt.LocalAudioTrack))===null||o===void 0||!o.track._muted):l=((a=this.localTrackMap.get(tt.LocalVideoTrack))===null||a===void 0?void 0:a.id)===void 0;const h=this.createMuteMessage(c);await Pe(this,Rt.RequestMuteLocal,h);const p=n.trackMediaType==="video"?ua.MUTE_LOCAL_VIDEO:ua.MUTE_LOCAL_AUDIO;await Pe(this,Rt.RequestP2PMuteLocal,{action:p,message:h,isMuteAll:l}),i()}catch(c){r(c)}finally{s()}})),R(this,"handleUnmuteLocalTrack",(async(n,i,r)=>{const s=await this.sendMutex.lock("Locking from P2PChannel2.handleUnmuteLocalTrack");try{if(!this.sendConnection||this.state!==me.Connected)return void r(new H(A.INVALID_OPERATION,"Cannot call P2PChannel2.handleUnmuteLocalTrack before sendConnection established."));const o=this.filterTobeUnmutedTracks(n);if(o.length===0)return void i();await this.sendConnection.unmuteLocal(o.map((d=>{let[,{id:l}]=d;return l})));const a=this.createUnmuteMessage(o),c=n.trackMediaType==="video"?ua.UNMUTE_LOCAL_VIDEO:ua.UNMUTE_LOCAL_AUDIO;await Pe(this,Rt.RequestP2PMuteLocal,{action:c,message:a}),i()}catch(o){r(o)}finally{s()}})),R(this,"handleUpdateVideoEncoder",(async(n,i,r,s)=>{let o;typeof s=="boolean"&&s||(o=await this.sendMutex.lock("Locking from P2PChannel2.handleUpdateVideoEncoder"));try{const c=this.localTrackMap.get(tt.LocalVideoTrack);if(!this.sendConnection||!c||c.track!==n||this.state!==me.Connected)return void i();const{id:d,track:l}=c;d&&(await this.sendConnection.updateSendParameters(d,l),await this.sendConnection.updateEncoderConfig(d,l),this.emit(Rt.UpdateVideoEncoder,l)),i()}catch(c){r(c)}finally{var a;(a=o)===null||a===void 0||a()}})),R(this,"handleUpdateVideoSendParameters",(async(n,i,r)=>{const s=await this.sendMutex.lock("Locking from P2PChannel2.handleUpdateVideoSendParameters");try{const o=this.localTrackMap.get(tt.LocalVideoTrack);if(!this.sendConnection||!o||o.track!==n||this.state!==me.Connected)return void i();const{id:a,track:c}=o;a&&await this.sendConnection.updateSendParameters(a,c),i()}catch(o){r(o)}finally{s()}})),R(this,"handleReplaceTrack",(async(n,i,r,s)=>{let o;m.debug("[".concat(this.store.clientId,"] P2PChannel2 handleReplaceTrack for [track-id-").concat(n.getTrackId(),"]")),typeof s=="boolean"&&s||(o=await this.sendMutex.lock("From P2PChannel2.handleReplaceTrack"));try{var a;const d=Array.from(this.localTrackMap.entries()).find((l=>{let[,{track:h}]=l;return n===h}));if(!this.sendConnection||!d||d[1].id===void 0||this.state!==me.Connected)return void i();if(await((a=this.sendConnection)===null||a===void 0?void 0:a.replaceTrack(n,d[1].id)),d[0]===tt.LocalVideoTrack&&Jt().supportDualStreamEncoding){const l=this.localTrackMap.get(tt.LocalVideoLowTrack);if(l){const h=n._mediaStreamTrack.clone();l.track._originMediaStreamTrack.stop(),l.track._mediaStreamTrack=h,l.track._originMediaStreamTrack=h,await new st(((p,f)=>{this.handleReplaceTrack(l.track,p,f,!0)}))}}i()}catch(d){r(d)}finally{var c;(c=o)===null||c===void 0||c()}})),R(this,"handleGetLocalVideoStats",(n=>{n(this.statsCollector.getLocalVideoTrackStats())})),R(this,"handleGetLocalAudioStats",(n=>{n(this.statsCollector.getLocalAudioTrackStats())})),R(this,"handleGetRemoteVideoStats",(n=>this.statsCollector.getRemoteVideoTrackStats(n.uid)[n.uid])),R(this,"handleGetRemoteAudioStats",(n=>this.statsCollector.getRemoteAudioTrackStats(n.uid)[n.uid])),this.store=t,this.statsCollector=e,this.statsCollector.addP2PChannel(this),this.statsUploader=new FP(t),this.bindStatsUploaderEvents(),this.sendMutex=new Un("P2PChannel2-send-mutex",t.clientId),this.recvMutex=new Un("P2PChannel2-recv-mutex",t.clientId),this.reconnectInterval=window.setInterval((()=>{[this.sendConnection,this.recvConnection].forEach((n=>{n&&(n.iceConnectionState!=="disconnected"&&n.iceConnectionState!=="failed"||this.handleDisconnect(n.direction))}))}),I("ICE_RESTART_INTERVAL"))}async startP2PConnection(t,e){throw new H(A.NOT_SUPPORTED,"p2p mode does not support startP2PConnection.")}async connect(t){throw new H(A.NOT_SUPPORTED,"p2p mode does not support connect.")}async startP2P(t,e){let n;try{if(e){this.recvConnection&&(m.warning("[".concat(this.store.clientId,"] P2PChannel.startP2P reset recvConnection.")),this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection)),n=await this.recvMutex.lock("From P2PChannel.startP2P"),this.recvConnection=new pM(t,this.store,Ti.RECEIVE_ONLY),this.bindConnectionEvents(this.recvConnection);const i=await this.recvConnection.establish(e);return{iceParameters:i.iceParameters,dtlsParameters:i.dtlsParameters,sdp:i.sdp}}{this.state=me.New,this.sendConnection&&(m.warning("[".concat(this.store.clientId,"] P2PChannel.startP2P reset sendConnection.")),this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection)),n=await this.sendMutex.lock("From P2PChannel.startP2P"),this.sendConnection=new pM(t,this.store),this.store.peerConnectionStart(),this.bindConnectionEvents(this.sendConnection);const i=await this.sendConnection.establish();return{iceParameters:i.iceParameters,dtlsParameters:i.dtlsParameters,sdp:i.sdp}}}finally{n&&n()}}async p2pConnect(t){if(!this.sendConnection)throw new H(A.UNEXPECTED_ERROR,"Cannot P2PChannel2.p2pConnect before P2PChannel2.startP2PConnection .");this.store.peerConnectionStart(),await this.sendConnection.connect(t),this.statsUploader.startUploadTransportStats(),this.statsUploader.startUploadExtensionUsageStats(),this.state=me.Connected}async addRemoteCandidate(t,e){if(e===Ti.RECEIVE_ONLY){if(!this.sendConnection)throw new H(A.UNEXPECTED_ERROR,"Cannot P2PChannel2.connect before P2PChannel2.addRemoteCandidate .");await this.sendConnection.addRemoteCandidate(t)}else{if(!this.recvConnection)throw new H(A.UNEXPECTED_ERROR,"Cannot P2PChannel2.connect before P2PChannel2.addRemoteCandidate .");await this.recvConnection.addRemoteCandidate(t)}}publish(t,e,n){var i=this;return Ci((function*(){const r=yield Ht(i.sendMutex.lock("From P2PChannel.publish"));try{if(!i.sendConnection||i.state!==me.Connected){i.throwIfTrackTypeNotMatch(t);const d=t.filter((l=>i.pendingLocalTracks.indexOf(l)===-1));return void(i.pendingLocalTracks=i.pendingLocalTracks.concat(d))}i.store.pubId=i.store.pubId+1,ni.markPublishStart(i.store.clientId,i.store.pubId);const s=i.filterTobePublishedTracks(t,e,n);if(s.length===0)return void(yield Ht(i.tryToUnmuteAudio(t)));s.forEach((d=>{let{track:l,type:h}=d;const p=Date.now();i.store.publish(l.getTrackId(),h===tt.LocalAudioTrack?"audio":"video",p)})),i.bindLocalTrackEvents(s);const o=yield Ht(i.sendConnection.send(s.map((d=>{let{track:l}=d;return l})),i.store.codec,i.store.audioCodec)),a=(yield Ht(o.next())).value,c=i.createGatewayPublishMessage(s,a);try{yield c}catch(d){throw o.throw(d),d?.code===A.WS_ABORT&&s.forEach((l=>{let{track:h}=l;i.pendingLocalTracks.indexOf(h)===-1&&i.pendingLocalTracks.push(h)})),i.unbindLocalTrackEvents(s),d}yield Ht(o.next()),s.forEach((d=>{let{type:l}=d;i.statsCollector.addLocalStats(l)})),i.statsUploader.startUploadOutboundStats(),i.assignLocalTracks(s,a),s.forEach((d=>{let{track:l,type:h}=d;const p=Date.now();i.store.publish(l.getTrackId(),h===tt.LocalAudioTrack?"audio":"video",void 0,p)})),i.startUploadUplinkState()}finally{r()}}))()}async unpublish(t){if(!this.sendConnection||this.state!==me.Connected)return void(t.length===0?this.pendingLocalTracks.length=0:this.pendingLocalTracks=this.pendingLocalTracks.filter((r=>!$(t).call(t,r))));const e=this.filterTobeUnpublishedTracks(t);if(e.length===0)return;const n=e.find((r=>r[0]==="videoLowTrack"));n&&n[1].track.close();const i=this.createGatewayUnpublishMessage(e);if(await this.sendConnection.stopSending(e.map((r=>{let[,{id:s}]=r;return s}))),this.withdrawLocalTracks(e),this.unbindLocalTrackEvents(e.map((r=>{let[s,{track:o}]=r;return{type:s,track:o}}))),e.forEach((r=>{let[s]=r;this.statsCollector.removeLocalStats(s)})),this.localTrackMap.size===0&&(this.statsUploader.stopUploadOutboundStats(),this.stopUploadUplinkState()),this.sendConnection&&this.state===me.Connected)return n&&n[1].track.close(),i;t.forEach((r=>{const s=this.pendingLocalTracks.indexOf(r);s!==-1&&this.pendingLocalTracks.splice(s,1)}))}startUploadUplinkState(){if(this.uploadUnplinkStarted)return;this.uploadUnplinkStarted=!0,this.uplinkStateUploadInterval&&window.clearInterval(this.uplinkStateUploadInterval);const t=()=>{const e=[],n=[];Array.from(this.localTrackMap.entries()).forEach((i=>{let[r,{track:s,ssrcs:o}]=i;const a={stream_type:WY(s,r),ssrcs:o};s._muted||!s._enabled?e.push(a):n.push(a)})),e.length>0&&e.forEach((i=>{Pe(this,Rt.RequestMuteLocal,[i])})),n.length>0&&n.forEach((i=>{Pe(this,Rt.RequestUnmuteLocal,[i])}))};t(),this.uplinkStateUploadInterval=window.setInterval((()=>{t()}),3e3)}stopUploadUplinkState(){this.uploadUnplinkStarted&&(this.uploadUnplinkStarted=!1,this.uplinkStateUploadInterval&&window.clearInterval(this.uplinkStateUploadInterval))}publishLowStream(t){return Ci((function*(){throw new H(A.NOT_SUPPORTED,"p2p mode does not support publishLowStream.")}))()}async republish(){this.pendingLocalTracks.length>0&&(m.debug("[".concat(this.store.clientId,"] Emit P2PChannelEvents.RequestRePublish to republish tracks.")),await Sn(this,Rt.RequestRePublish,this.pendingLocalTracks),this.emit(Rt.MediaReconnectEnd,this.store.uid),this.pendingLocalTracks=[])}async unpublishLowStream(){throw new H(A.NOT_SUPPORTED,"p2p mode does not support unpublishLowStream.")}async subscribe(t,e,n,i){var r;if(!this.recvConnection)throw new H(A.INVALID_OPERATION,"Cannot subscribe remote user when recvConnection disconnected.");if((r=this.remoteUserMap.get(t))!==null&&r!==void 0&&r.has(e))return;const{track:s,mid:o,transceiver:a}=await this.recvConnection.receive(e,[{ssrcId:n}],String(t.uid),i);e===ut.AUDIO?(t._audioTrack?t._audioTrack._updateOriginMediaStreamTrack(s):(t._audioTrack=new kd(s,t.uid,t._uintid,this.store),m.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote audio track: ").concat(t._audioTrack.getTrackId()))),a&&t._audioTrack._updateRtpTransceiver(a),this.bindRemoteTrackEvents(t,t._audioTrack)):(t._videoSSRC=n,t._videoTrack?t._videoTrack._updateOriginMediaStreamTrack(s):(t._videoTrack=new Ld(s,t.uid,t._uintid,this.store),m.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote video track: ").concat(t._videoTrack.getTrackId()))),a&&t._videoTrack._updateRtpTransceiver(a),this.bindRemoteTrackEvents(t,t._videoTrack));const c=this.remoteUserMap.get(t);c?c.set(e,o):this.remoteUserMap.set(t,new Map([[e,o]])),this.statsCollector.addRemoteStats(t.uid),this.statsUploader.startUploadInboundStats(),this.startUploadDownlinkState();const d=this.pendingRemoteTracks.findIndex((l=>{let{user:h,kind:p}=l;return h.uid===t.uid&&e===p}));d!==-1&&(this.pendingRemoteTracks.splice(d,1),this.emit(Rt.MediaReconnectEnd,t.uid))}async mockSubscribe(t,e,n,i){if(!this.recvConnection)throw new H(A.INVALID_OPERATION,"Cannot subscribe remote user when recvConnection disconnected.");await this.recvConnection.mockReceive(e,[{ssrcId:n}],String(t.uid),i)}async unsubscribe(t,e,n){const i=this.pendingRemoteTracks.filter((s=>{let{user:o,kind:a}=s;return e!==void 0?o.uid===t.uid&&e===a:o.uid===t.uid}));if(i.forEach((s=>{const o=this.pendingRemoteTracks.indexOf(s);this.pendingRemoteTracks.splice(o,1)})),this.recvConnection||n||i.forEach((s=>{let{kind:o}=s;var a;if(o===ut.AUDIO)(a=t._audioTrack)===null||a===void 0||a._destroy(),t._audioTrack=void 0;else if(o===ut.VIDEO){var c;(c=t._videoTrack)===null||c===void 0||c._destroy(),t._videoTrack=void 0}})),!this.recvConnection)return;const r=this.filterTobeUnSubscribedTracks(t,e);r.length!==0&&(await this.recvConnection.stopReceiving(r.map((s=>{let[,{id:o}]=s;return o}))),this.withdrawRemoteTracks(r),this.remoteUserMap.size===0&&(this.statsUploader.stopUploadInboundStats(),this.stopUploadDownlinkState()),r.forEach((s=>{let[o,{kind:a}]=s;var c,d;if(a===ut.VIDEO&&o._videoSSRC&&((c=this.recvConnection)===null||c===void 0||c.setStatsRemoteVideoIsReady(o._videoSSRC,!1)),a===ut.VIDEO)this.unbindRemoteTrackEvents(o._videoTrack),n||((d=o._videoTrack)===null||d===void 0||d._destroy(),o._videoTrack=void 0);else if(a===ut.AUDIO){var l;this.unbindRemoteTrackEvents(o._audioTrack),!n&&((l=o._audioTrack)===null||l===void 0||l._destroy(),o._audioTrack=void 0)}})),r.forEach((s=>{let[,{kind:o}]=s;Pe(this,Rt.RequestP2PMuteRemote,o)})))}startUploadDownlinkState(){if(this.uploadDownlinkStarted)return;this.uploadDownlinkStarted=!0,this.downlinkStatsUploadInterval&&window.clearInterval(this.downlinkStatsUploadInterval);const t=()=>Array.from(this.remoteUserMap.entries()).forEach((e=>{let[,n]=e;[ut.VIDEO,ut.AUDIO].forEach((i=>{n.has(i)?Pe(this,Rt.RequestP2PUnmuteRemote,i):Pe(this,Rt.RequestP2PMuteRemote,i)}))}));t(),this.downlinkStatsUploadInterval=window.setInterval((()=>{t()}),3e3)}stopUploadDownlinkState(){this.uploadDownlinkStarted&&(this.uploadDownlinkStarted=!1,this.downlinkStatsUploadInterval&&window.clearInterval(this.downlinkStatsUploadInterval))}getAllDataChannels(){return this.localDataChannels}async massSubscribe(t){throw new H(A.NOT_SUPPORTED,"p2p mode does not support massSubscribe.")}async massSubscribeNoLock(t){throw new H(A.NOT_SUPPORTED,"p2p mode does not support massSubscribeNoLock.")}async massUnsubscribe(t){throw new H(A.NOT_SUPPORTED,"p2p mode does not support massUnsubscribe.")}async massUnsubscribeNoLock(t){throw new H(A.NOT_SUPPORTED,"p2p mode does not support massUnsubscribeNoLock.")}async muteRemote(t,e){if(!this.recvConnection)return;const n=this.remoteUserMap.get(t);if(!n)return void m.warning("[".concat(this.store.clientId,"] P2PChannel2.muteRemote has no remote user ").concat(t.uid,"."));if(!n.get(e))return void m.warning("[".concat(this.store.clientId,"] P2PChannel2.muteRemote has no remote user ").concat(t.uid," media type ").concat(e,"."));const i=e===ut.VIDEO?t._videoSSRC:t._audioSSRC;i!==void 0&&this.recvConnection.setStatsRemoteVideoIsReady(i,!1)}async unmuteRemote(t,e){return this.unmuteRemoteNoLock(t,e)}async unmuteRemoteNoLock(t,e){if(!this.recvConnection)return;const n=this.remoteUserMap.get(t);if(!n)return void m.warning("[".concat(this.store.clientId,"] P2PChannel2.unmuteRemote has no remote user ").concat(t.uid,"."));n.get(e)||m.warning("[".concat(this.store.clientId,"] P2PChannel2.unmuteRemote has no remote user ").concat(t.uid," media type ").concat(e,"."))}getAllTracks(t){const e=this.localTrackMap.get(tt.LocalAudioTrack);if(e?.track instanceof Cn){const n=e.track;return Array.from(this.localTrackMap.entries()).filter((i=>{let[r]=i;return r!==tt.LocalAudioTrack})).filter((i=>{let[r]=i;return!(t&&r===tt.LocalVideoLowTrack)})).map((i=>{let[,{track:r}]=i;return r})).concat(n.trackList)}return Array.from(this.localTrackMap.entries()).filter((n=>{let[i]=n;return!(t&&i===tt.LocalVideoLowTrack)})).map((n=>{let[,{track:i}]=n;return i}))}reportPublishEvent(t,e,n,i,r){if(t){const o=this.localTrackMap.get(tt.LocalAudioTrack),a=i?this.localTrackMap.get(tt.LocalVideoLowTrack):this.localTrackMap.get(tt.LocalVideoTrack);pt.publish(this.store.sessionId,{eventElapse:ni.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:t,ec:e,audioName:o?.track.getTrackLabel(),videoName:a?.track.getTrackLabel(),screenshare:a?.track._hints.indexOf(Ee.SCREEN_TRACK)!==-1,audio:!!o,video:!!a,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:r})}else{var s;n||(n=[]);const o=n.find((c=>c instanceof rn)),a=i?(s=this.localTrackMap.get(tt.LocalVideoTrack))===null||s===void 0?void 0:s.track:n.find((c=>c instanceof De));pt.publish(this.store.sessionId,{eventElapse:ni.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:t,ec:e,audioName:o?.getTrackLabel(),videoName:a?.getTrackLabel(),screenshare:a?._hints.indexOf(Ee.SCREEN_TRACK)!==-1,audio:!!o,video:!!a,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:r})}}reportSubscribeEvent(t,e,n,i){const r=i===ut.VIDEO?n._videoSSRC:n._audioSSRC;r&&pt.subscribe(this.store.sessionId,{succ:t,ec:e,video:i===ut.VIDEO,audio:i===ut.AUDIO,peerid:n.uid,subscribeRequestid:i===ut.VIDEO?n._videoSSRC:n._audioSSRC,p2pid:this.store.p2pId,eventElapse:ni.measureFromSubscribeStart(this.store.clientId,r)})}reset(){m.debug("[".concat(this.store.clientId,"] P2PChannel2.reset")),this.sendMutex=new Un("P2PChannel2-send-mutex",this.store.clientId),this.sendMutex=new Un("P2PChannel2-recv-mutex",this.store.clientId),this.sendConnection&&(this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection),this.sendConnection=void 0),this.recvConnection&&(this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection),this.recvConnection=void 0),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),this.statsUploader.stopUploadExtensionUsageStats(),this.stopUploadUplinkState(),this.stopUploadDownlinkState(),this.unbindLocalTrackEvents(),this.unbindAllRemoteTrackEvents(),this.unbindRtpTransceiver();const t=this.localTrackMap.get(tt.LocalAudioTrack);if(t?.track instanceof Cn){if(t.track.trackList.length>0){const e=t.track;t.track.trackList.forEach((n=>{e.removeAudioTrack(n)}))}t.track.close()}this.localTrackMap.clear(),this.remoteUserMap.clear(),this.statsCollector.removeRemoteStats(),this.statsCollector.removeLocalStats(),this.dtlsFailedCount=0,this.pendingLocalTracks=[],this.pendingRemoteTracks=[],this.reconnectInterval&&(window.clearInterval(this.reconnectInterval),this.reconnectInterval=void 0),this.state=me.Disconnected}getStats(t){var e,n;return t?(n=this.recvConnection)===null||n===void 0?void 0:n.getStats():(e=this.sendConnection)===null||e===void 0?void 0:e.getStats()}getRemoteVideoIsReady(t){var e;return((e=this.recvConnection)===null||e===void 0?void 0:e.getRemoteVideoIsReady(t))||!1}getLocalAudioVolume(){const t=this.localTrackMap.get(tt.LocalAudioTrack);if(t)return t.track.getVolumeLevel()}getLocalVideoSize(){const t=this.localTrackMap.get(tt.LocalVideoTrack);if(t)return{width:t.track.videoWidth||0,height:t.track.videoHeight||0}}getEncoderConfig(t){const e=this.localTrackMap.get(t);return e&&e.track instanceof De||e&&e.track instanceof rn?e.track._encoderConfig:void 0}getLocalMedia(t){return this.localTrackMap.get(t)}hasLocalMedia(){return this.localTrackMap.size>0}hasRemoteMedia(t,e){if(!t)return this.remoteUserMap.size>0;const n=this.remoteUserMap.get(t);return!!n&&(!e||n.has(e))}async hasRemoteMediaWithLock(t,e){if(!t)return this.remoteUserMap.size>0;const n=this.remoteUserMap.get(t);return!!n&&(!e||n.has(e))}getRemoteMedia(t){var e;const n=Array.from(oi(e=this.remoteUserMap).call(e)).find((i=>i.uid===t));return n?{audioTrack:n.audioTrack,audioSSRC:n._audioSSRC,videoTrack:n.videoTrack,videoSSRC:n._videoSSRC}:{}}getAudioLevels(){let t=Array.from(this.remoteUserMap.entries()).map((n=>{let[i]=n;return{uid:i.uid,level:i.audioTrack?100*i.audioTrack._source.getAccurateVolumeLevel():0}}));const e=this.localTrackMap.get(tt.LocalAudioTrack);return e&&t.push({level:100*e.track._source.getAccurateVolumeLevel(),uid:this.store.uid}),t=Fa(t).call(t,((n,i)=>n.level-i.level)),t}async disconnectForReconnect(){this.sendConnection&&this.recvConnection&&(m.debug("[".concat(this.store.clientId,"] P2PChannel2.disconnectForReconnect closing P2PConnection")),this.state=me.Reconnecting,I("KEEP_LAST_FRAME")&&this.remoteUserMap.size!==0&&Array.from(this.remoteUserMap.entries()).forEach((t=>{let[e]=t;var n;e._videoTrack&&e._videoTrack._player&&((n=e._videoTrack._player.getVideoElement())===null||n===void 0||n.pause(),e._videoTrack._player.isKeepLastFrame=!0,e._videoTrack._originMediaStreamTrack.stop())})),this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection),this.sendConnection=void 0,this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection),this.recvConnection=void 0,this.localTrackMap.size!==0&&(Array.from(this.localTrackMap.entries()).forEach((t=>{var e;let[n,{track:i}]=t;switch(n){case tt.LocalVideoTrack:$(e=i._hints).call(e,Ee.LOW_STREAM)?i.close():this.pendingLocalTracks.push(i);break;case tt.LocalAudioTrack:i instanceof Cn?this.pendingLocalTracks=this.pendingLocalTracks.concat(i.trackList):this.pendingLocalTracks.push(i);case tt.LocalVideoLowTrack:}})),this.emit(Rt.MediaReconnectStart,this.store.uid)),this.unbindLocalTrackEvents(),this.localTrackMap.clear(),this.remoteUserMap.size!==0&&Array.from(this.remoteUserMap.entries()).forEach((t=>{let[e,n]=t;Array.from(oi(n).call(n)).forEach((i=>{this.setPendingRemoteMedia(e,i)})),this.emit(Rt.MediaReconnectStart,e.uid)})),this.unbindAllRemoteTrackEvents(),this.remoteUserMap.clear(),this.stopUploadUplinkState(),this.stopUploadDownlinkState(),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),m.debug("[".concat(this.store.clientId,"] P2PChannel2 disconnected, waiting to reconnect.")))}hasPendingRemoteMedia(t,e){for(const n of this.pendingRemoteTracks){const{user:i,kind:r}=n;if((t instanceof _a?t.uid:t)===i.uid&&e===r)return!0}return!1}setPendingRemoteMedia(t,e){this.hasPendingRemoteMedia(t,e)||this.pendingRemoteTracks.push({user:t,kind:e})}async restartICE(t,e){let n,i;if(t===Ti.SEND_ONLY){if(!this.sendConnection)throw new H(A.INVALID_OPERATION,"Cannot call P2PChannel2.handleMuteLocalTrack before sendConnection established.");n=await this.sendMutex.lock("From P2PChannel.restartICE"),i=this.sendConnection}else{if(!this.recvConnection)throw new H(A.INVALID_OPERATION,"Cannot call P2PChannel2.handleMuteLocalTrack before recvConnection established.");n=await this.recvMutex.lock("From P2PChannel.restartICE"),i=this.recvConnection}try{if(e){const r=await i.restartICE(e);return i.isInRestartIce=!1,r}{const r=await i.restartICE();if(r){const s=await Sn(this,Rt.RequestP2PRestartICE,{direction:Ti.RECEIVE_ONLY,iceParameter:r});await i.restartICE(s),i.isInRestartIce=!1}}}finally{n()}}getUplinkNetworkQuality(){if(!this.sendConnection)return 0;const t=this.sendConnection.getStats(),e=this.localTrackMap.get(tt.LocalVideoTrack),n=this.localTrackMap.get(tt.LocalAudioTrack),i=t.videoSend.find((f=>{var v;return f.ssrc===(e==null||(v=e.ssrcs)===null||v===void 0?void 0:v[0].ssrcId)})),r=t.audioSend.find((f=>{var v;return f.ssrc===(n==null||(v=n.ssrcs)===null||v===void 0?void 0:v[0].ssrcId)}));if(!i||!r)return 1;const s=Ji(this,Rt.NeedSignalRTT),o=i?i.rttMs:void 0,a=r?r.rttMs:void 0,c=o&&a?(o+a)/2:o||a,d=(c&&s?(c+s)/2:c||s)||0,l=100*t.sendPacketLossRate*.7/50+.3*d/1500,h=l<.17?1:l<.36?2:l<.59?3:l<.1?4:5,p=e?.track;if(p&&p._encoderConfig&&p._hints.indexOf(Ee.SCREEN_TRACK)===-1){const f=p._encoderConfig.bitrateMax,v=t.bitrate.actualEncoded;if(f&&v){const S=(1e3*f-v)/(1e3*f);return OD[S<.15?0:S<.3?1:S<.45?2:S<.6?3:4][h]}}return h}getDownlinkNetworkQuality(){if(!this.recvConnection)return 0;const t=this.recvConnection.getStats();let e=0;return Array.from(this.remoteUserMap.entries()).forEach((n=>{let[i]=n;const r=i._audioSSRC,s=i._videoSSRC,o=t.audioRecv.find((v=>v.ssrc===r)),a=t.videoRecv.find((v=>v.ssrc===s));if(!o&&!a)return void(e+=1);const c=Ji(this,Rt.NeedSignalRTT),d=t.rtt,l=(d&&c?(d+c)/2:d||c)||0,h=o?o.jitterMs:void 0,p=t.recvPacketLossRate;let f=.7*p*100/50+.3*l/1500;h&&(f=.6*p*100/50+.2*l/1500+.2*h/400),e+=f<.1?1:f<.17?2:f<.36?3:f<.59?4:5})),this.remoteUserMap.size>0?Math.round(e/this.remoteUserMap.size):e}async muteLocalTrack(t){return new st(((e,n)=>{this.handleMuteLocalTrack(t,e,n)}))}filterTobePublishedTracks(t,e,n){const i=[],r=Jt(),s=this.getAllTracks();t=Td(t=t.filter((c=>s.indexOf(c)===-1)));let o=!1,a=!1;for(const c of t){if(c instanceof De&&(this.localTrackMap.has(tt.LocalVideoTrack)||o?new H(A.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS).throw():(i.push({track:c,type:tt.LocalVideoTrack}),o=!0),e)){const d=this.getLowVideoTrack(c,n);i.push({track:d,type:tt.LocalVideoLowTrack})}if(c instanceof rn){const d=this.localTrackMap.get(tt.LocalAudioTrack);if(d){if(!(d.track instanceof Cn))throw new H(A.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser does not support audio mixing");if(c._bypassWebAudio)throw new H(A.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");d.track.addAudioTrack(c),this.bindLocalAudioTrackEvents(c,!0)}else if(a){const l=i.find((h=>{let{type:p}=h;return p===tt.LocalAudioTrack}));if(!(l.track instanceof Cn))throw new H(A.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser does not support audio mixing");if(c._bypassWebAudio)throw new H(A.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");l.track.addAudioTrack(c)}else{if(!r.webAudioMediaStreamDest||c instanceof Cn||c._bypassWebAudio)i.push({track:c,type:tt.LocalAudioTrack});else{const l=new Cn;l.addAudioTrack(c),i.push({track:l,type:tt.LocalAudioTrack})}a=!0}}}return i}filterTobeUnpublishedTracks(t){const e=[],n=this.getAllTracks();t=Td(t=t.filter((i=>n.indexOf(i)!==-1)));for(const i of t){if(i instanceof rn){const r=this.localTrackMap.get(tt.LocalAudioTrack);if(!r)continue;r.track instanceof Cn?(r.track.removeAudioTrack(i),this.unbindLocalAudioTrackEvents(i),r.track.trackList.length===0&&(e.push([tt.LocalAudioTrack,r]),r.track.close())):e.push([tt.LocalAudioTrack,r])}if(i instanceof De){const r=this.localTrackMap.get(tt.LocalVideoTrack);if(!r)continue;e.push([tt.LocalVideoTrack,r]);const s=this.localTrackMap.get(tt.LocalVideoLowTrack);s&&e.push([tt.LocalVideoLowTrack,s])}}return e}bindLocalTrackEvents(t){t.forEach((e=>{let{track:n,type:i}=e;switch(i){case tt.LocalVideoTrack:n.addListener(_t.GET_STATS,this.handleGetLocalVideoStats),n.addListener(_t.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),n.addListener(_t.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),n.addListener(_t.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),n.addListener(_t.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this.handleUpdateVideoSendParameters),n.addListener(_t.NEED_REPLACE_TRACK,this.handleReplaceTrack),n.addListener(_t.NEED_MUTE_TRACK,this.handleMuteLocalTrack),n.addListener(_t.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case tt.LocalAudioTrack:this.bindLocalAudioTrackEvents(n);case tt.LocalVideoLowTrack:}}))}bindLocalAudioTrackEvents(t,e){t instanceof Cn?t.trackList.forEach((n=>{n.addListener(_t.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),n.addListener(_t.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),n.addListener(_t.GET_STATS,this.handleGetLocalAudioStats),n.addListener(_t.NEED_MUTE_TRACK,this.handleMuteLocalTrack),n.addListener(_t.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)})):(t.addListener(_t.GET_STATS,this.handleGetLocalAudioStats),t.addListener(_t.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.addListener(_t.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.addListener(_t.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.addListener(_t.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack),e||t.addListener(_t.NEED_REPLACE_TRACK,this.handleReplaceTrack))}unbindLocalTrackEvents(t){t||(t=Array.from(this.localTrackMap.entries()).map((e=>{let[n,{track:i}]=e;return{track:i,type:n}}))),t.forEach((e=>{let{track:n,type:i}=e;switch(i){case tt.LocalVideoTrack:n.off(_t.GET_STATS,this.handleGetLocalVideoStats),n.off(_t.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),n.off(_t.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),n.off(_t.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),n.off(_t.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this.handleUpdateVideoSendParameters),n.off(_t.NEED_REPLACE_TRACK,this.handleReplaceTrack),n.off(_t.NEED_MUTE_TRACK,this.handleMuteLocalTrack),n.off(_t.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case tt.LocalAudioTrack:this.unbindLocalAudioTrackEvents(n);case tt.LocalVideoLowTrack:}}))}unbindLocalAudioTrackEvents(t){t instanceof Cn?t.trackList.forEach((e=>{e.off(_t.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.off(_t.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.off(_t.GET_STATS,this.handleGetLocalAudioStats),e.off(_t.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.off(_t.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)})):(t.off(_t.GET_STATS,this.handleGetLocalAudioStats),t.off(_t.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.off(_t.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.off(_t.NEED_REPLACE_TRACK,this.handleReplaceTrack),t.off(_t.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.off(_t.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack))}bindRemoteTrackEvents(t,e){e instanceof Ld&&e.addListener(_t.GET_STATS,(n=>{n(this.handleGetRemoteVideoStats(t))})),e instanceof kd&&e.addListener(_t.GET_STATS,(n=>{n(this.handleGetRemoteAudioStats(t))}))}unbindRemoteTrackEvents(t){t&&t.removeAllListeners(_t.GET_STATS)}unbindAllRemoteTrackEvents(){Array.from(this.remoteUserMap.entries()).forEach((t=>{let[e,n]=t;n.has(ut.AUDIO)&&this.unbindRemoteTrackEvents(e._audioTrack),n.has(ut.VIDEO)&&this.unbindRemoteTrackEvents(e._videoTrack)}))}createGatewayPublishMessage(t,e){return t.map(((n,i)=>{var r;let s,{track:o,type:a}=n;switch(a){case tt.LocalAudioTrack:s=Re.Audio;break;case tt.LocalVideoTrack:s=$(r=o._hints).call(r,Ee.SCREEN_TRACK)?Re.Screen:Re.High;break;case tt.LocalVideoLowTrack:s=Re.Low}return{kind:a===tt.LocalAudioTrack?ut.AUDIO:ut.VIDEO,stream_type:s,mid:e[i].id,ssrcs:e[i].localSSRC,isMuted:o.muted||!o.enabled}}))}createGatewayUnpublishMessage(t){return t.map((e=>{var n;let i,[r,{track:s,ssrcs:o,id:a}]=e;switch(r){case tt.LocalVideoTrack:i=$(n=s._hints).call(n,Ee.SCREEN_TRACK)?Re.Screen:Re.High;break;case tt.LocalAudioTrack:i=Re.Audio;break;case tt.LocalVideoLowTrack:i=Re.Low}return{stream_type:i,ssrcs:o,mid:a}}))}assignLocalTracks(t,e){t.forEach(((n,i)=>{let{track:r,type:s}=n;this.localTrackMap.set(s,{track:r,id:e[i].id,ssrcs:e[i].localSSRC})}))}withdrawLocalTracks(t){t.forEach((e=>{let[n]=e;this.localTrackMap.delete(n)}))}bindConnectionEvents(t){t.onConnectionStateChange=async e=>{var n;m.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: ").concat(t.name,".onConnectionStateChange(").concat(e,")")),this.emit(Rt.PeerConnectionStateChange,e),e!=="connected"||this.store.keyMetrics.peerConnectionEnd||this.store.peerConnectionEnd(),e==="connected"&&(t.isInRestartIce=!1),$(n=this._restartStates).call(n,e)&&!t.isInRestartIce&&(e==="disconnected"&&await Nn(800),t.iceConnectionState!=="disconnected"&&t.iceConnectionState!=="failed"||this.handleDisconnect(t.direction))},t.onICEConnectionStateChange=e=>{e!=="connected"||this.store.keyMetrics.iceConnectionEnd||this.store.iceConnectionEnd(),m.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICEConnectionStateChange(").concat(e,")")),pt.reportApiInvoke(this.store.sessionId,{name:"ICEConnectionStateChange",options:e,tag:Ne.TRACER}).onSuccess(),this.emit(Rt.IceConnectionStateChange,e)},t.onICETransportStateChange=e=>{m.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICETransportStateChange(").concat(e,")"))},t.onDTLSTransportStateChange=e=>{m.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportStateChange(").concat(e,")"))},t.onDTLSTransportError=e=>{m.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportError(").concat(e,")"))},t.onFirstAudioDecoded=e=>{var n;const i=Array.from(oi(n=this.remoteUserMap).call(n)).find((s=>s._audioSSRC===e));var r;i&&(this.store.subscribe(i.uid,"audio",void 0,void 0,void 0,Date.now()),(r=i.audioTrack)===null||r===void 0||r.emit(Or.FIRST_FRAME_DECODED),pt.firstRemoteFrame(this.store.sessionId,vn.FIRST_AUDIO_DECODE,We.FIRST_AUDIO_DECODE,{peer:i._uintid,subscribeElapse:ni.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId}))},t.onFirstAudioReceived=e=>{var n;const i=Array.from(oi(n=this.remoteUserMap).call(n)).find((r=>r._audioSSRC===e));i&&pt.firstRemoteFrame(this.store.sessionId,vn.FIRST_AUDIO_RECEIVED,We.FIRST_AUDIO_RECEIVED,{peer:i._uintid,subscribeElapse:ni.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId})},t.onFirstVideoDecoded=(e,n,i)=>{this.reportVideoFirstFrameDecoded(e,n,i)},t.onFirstVideoReceived=e=>{var n;const i=Array.from(oi(n=this.remoteUserMap).call(n)).find((r=>r._videoSSRC===e));i&&pt.firstRemoteFrame(this.store.sessionId,vn.FIRST_VIDEO_RECEIVED,We.FIRST_VIDEO_RECEIVED,{peer:i._uintid,subscribeElapse:ni.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId})},t.onSelectedLocalCandidateChanged=(e,n)=>{const i=e.candidateType==="relay",r=n.candidateType==="relay";n.candidateType!=="unknown"&&i===r||this.emit(Rt.ConnectionTypeChange,i),m.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedLocalCandidateChanged(").concat(JSON.stringify(ha(n))," -> ").concat(JSON.stringify(ha(e)),")"))},t.onSelectedRemoteCandidateChanged=(e,n)=>{m.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedRemoteCandidateChanged(").concat(JSON.stringify(ha(n))," -> ").concat(JSON.stringify(ha(e)),")"))},t.onFirstVideoDecodedTimeout=e=>{this.reportVideoFirstFrameDecoded(e,void 0,void 0,!0)},t.onLocalCandidate=e=>{this.emit(Rt.LocalCandidate,{candidate:e,direction:t.direction})}}unbindConnectionEvents(t){t.onConnectionStateChange=void 0,t.onICEConnectionStateChange=void 0,t.onICETransportStateChange=void 0,t.onDTLSTransportStateChange=void 0,t.onDTLSTransportError=void 0,t.onFirstAudioDecoded=void 0,t.onFirstAudioReceived=void 0,t.onFirstVideoDecoded=void 0,t.onFirstVideoReceived=void 0,t.onSelectedLocalCandidateChanged=void 0,t.onSelectedRemoteCandidateChanged=void 0,t.onFirstVideoDecodedTimeout=void 0,t.onLocalCandidate=void 0}async handleDisconnect(t){const e=t===Ti.SEND_ONLY?this.sendConnection:this.recvConnection;e&&!e.isInRestartIce&&(e.isInRestartIce=!0,m.debug("[".concat(this.store.clientId,"] [P2PChannel-").concat(e.name,"] start use restartICE")),t===Ti.SEND_ONLY?this.restartICE(t):Sn(this,Rt.RequestP2PRestartICE,{direction:Ti.SEND_ONLY}))}filterTobeMutedTracks(t){const e=[];if(this.getAllTracks().indexOf(t)===-1)return e;const n=this.localTrackMap.get(tt.LocalAudioTrack);if(t instanceof rn&&n?.track instanceof Cn)return n.track.isActive||e.push([tt.LocalAudioTrack,n]),e;const i=Array.from(this.localTrackMap.entries()).find((r=>{let[,{track:s}]=r;return t===s}));if(i&&(e.push(i),i[0]===tt.LocalVideoTrack)){const r=this.localTrackMap.get(tt.LocalVideoLowTrack);r&&e.push([tt.LocalVideoLowTrack,r])}return e}filterTobeUnmutedTracks(t){const e=[],n=this.localTrackMap.get(tt.LocalAudioTrack);if(t instanceof rn&&n?.track instanceof Cn)return n.track.isActive&&e.push([tt.LocalAudioTrack,n]),e;const i=Array.from(this.localTrackMap.entries()).find((r=>{let[,{track:s}]=r;return t===s}));if(i)if(i[0]===tt.LocalVideoTrack){e.push(i);const r=this.localTrackMap.get(tt.LocalVideoLowTrack);r&&e.push([tt.LocalVideoLowTrack,r])}else e.push(i);return e}createMuteMessage(t){return t.map((e=>{var n;let i,[r,{track:s,ssrcs:o,id:a}]=e;switch(r){case tt.LocalAudioTrack:i=Re.Audio;break;case tt.LocalVideoTrack:i=$(n=s._hints).call(n,Ee.SCREEN_TRACK)?Re.Screen:Re.High;break;case tt.LocalVideoLowTrack:i=Re.Low}return{stream_type:i,ssrcs:o,mid:a}}))}createUnmuteMessage(t){return t.map((e=>{var n;let i,[r,{track:s,ssrcs:o,id:a}]=e;switch(r){case tt.LocalAudioTrack:i=Re.Audio;break;case tt.LocalVideoTrack:i=$(n=s._hints).call(n,Ee.SCREEN_TRACK)?Re.Screen:Re.High;break;case tt.LocalVideoLowTrack:i=Re.Low}return{stream_type:i,ssrcs:o,mid:a}}))}filterTobeUnSubscribedTracks(t,e){const n=[],i=this.remoteUserMap.get(t);if(!i)return n;if(e){const r=i.get(e);if(!r)return n;n.push([t,{kind:e,id:r}])}else Array.from(i.entries()).forEach((r=>{let[s,o]=r;n.push([t,{kind:s,id:o}])}));return n}createUnsubscribeMessage(t){const e=[];return t.forEach((n=>{let[i,{kind:r,id:s}]=n;switch(r){case ut.VIDEO:return void(i._videoSSRC&&e.push({stream_type:ut.VIDEO,ssrcId:i._videoSSRC}));case ut.AUDIO:return void(i._audioSSRC&&e.push({stream_type:ut.AUDIO,ssrcId:i._audioSSRC}))}})),e}withdrawRemoteTracks(t){t.forEach((e=>{let[n,{kind:i}]=e;const r=this.remoteUserMap.get(n);r&&(r.delete(i),Array.from(r.entries()).length===0&&this.remoteUserMap.delete(n))}))}async updateBitrateLimit(t){const e=this.localTrackMap.get(tt.LocalVideoTrack),n=this.localTrackMap.get(tt.LocalVideoLowTrack);e&&(await e.track.setBitrateLimit(t.uplink),await new st(((i,r)=>{this.handleUpdateVideoEncoder(e.track,i,r,!0)}))),n&&t.low_stream_uplink&&(await n.track.setBitrateLimit({max_bitrate:t.low_stream_uplink.bitrate,min_bitrate:t.low_stream_uplink.bitrate||0}),await new st(((i,r)=>{this.handleUpdateVideoEncoder(n.track,i,r,!0)})))}isP2PDisconnected(){if(this.sendConnection&&this.recvConnection){const t=this.sendConnection.peerConnectionState,e=this.recvConnection.peerConnectionState;return t!=="connected"&&e!=="connected"}return!0}async tryToUnmuteAudio(t){for(let e=0;e<t.length;e++)if(t[e]instanceof rn){const n=this.filterTobeUnmutedTracks(t[e]);if(n.length===0)continue;const i=this.createUnmuteMessage(n);return void await Pe(this,Rt.RequestUnmuteLocal,i)}}bindStatsUploaderEvents(){this.statsUploader.requestStats=t=>this.getStats(t),this.statsUploader.requestLocalMedia=()=>Array.from(this.localTrackMap.entries()).filter((t=>{let[,{ssrcs:e}]=t;return!!e})),this.statsUploader.requestRemoteMedia=()=>Array.from(this.remoteUserMap.entries()),this.statsUploader.requestVideoIsReady=t=>{var e;return!((e=this.recvConnection)===null||e===void 0||!e.getRemoteVideoIsReady(t))},this.statsUploader.requestUpload=(t,e)=>this.emit(Rt.RequestUpload,t,e),this.statsUploader.requestUploadStats=t=>this.emit(Rt.RequestUploadStats,t),this.statsUploader.requestAllTracks=()=>this.getAllTracks()}unbindStatsUploaderEvents(){this.statsUploader.requestStats=void 0,this.statsUploader.requestLocalMedia=void 0,this.statsUploader.requestRemoteMedia=void 0,this.statsUploader.requestVideoIsReady=void 0}async requestReconnect(){this.dtlsFailedCount+=1,await Nn(Kp(this.dtlsFailedCount,fn)),this.emit(Rt.RequestReconnect)}async reconnectP2P(){}canPublishLowStream(){return this.localTrackMap.has(tt.LocalVideoTrack)||this.pendingLocalTracks.some((t=>t instanceof De))}throwIfTrackTypeNotMatch(t){if(t.filter((e=>e instanceof De)).length>1)throw new H(A.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(t.filter((e=>e instanceof rn)).length>1&&(t.some((e=>e instanceof rn&&e._bypassWebAudio))||!Jt().webAudioMediaStreamDest))throw new H(A.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode");for(const e of t){if(e instanceof De&&this.pendingLocalTracks.some((n=>n instanceof De)))throw new H(A.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(e instanceof rn&&this.pendingLocalTracks.some((n=>n instanceof rn))&&(!Jt().webAudioMediaStreamDest||e._bypassWebAudio||this.pendingLocalTracks.some((n=>n instanceof rn&&n._bypassWebAudio))))throw new H(A.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode")}}getLowVideoTrack(t,e){const n=!I("DISABLE_DUAL_STREAM_USE_ENCODING")&&Jt().supportDualStreamEncoding,i=lf(lf({},{width:160,height:120,framerate:15,bitrate:50}),e);let r;r=n?t._mediaStreamTrack.clone():CT(t,i);const s=Se(8,"track-low-"),o=new De(r,lf(lf({},n&&{scaleResolutionDownBy:$S(i,t)}),{},{frameRate:i.framerate,bitrateMax:i.bitrate,bitrateMin:i.bitrate}),void 0,void 0,s);return o.on(sc.TRANSCEIVER_UPDATED,(a=>{t._updateRtpTransceiver(a,Ad.LOW_STREAM)})),o._hints.push(Ee.LOW_STREAM),t.addListener(_t.NEED_CLOSE,(()=>{o.close()})),o}async globalLock(){return this.recvMutex.lock("From P2PChannel2.globalLock")}reportVideoFirstFrameDecoded(t,e,n,i){var r;const s=Array.from(oi(r=this.remoteUserMap).call(r)).find((o=>o._videoSSRC===t));if(s){i||this.store.subscribe(s.uid,"video",void 0,void 0,void 0,void 0,Date.now());const o=this.store.keyMetrics,a=o.subscribe.find((c=>c.userId===s.uid&&c.type==="video"));pt.firstRemoteVideoDecode(this.store.sessionId,vn.FIRST_VIDEO_DECODE,We.FIRST_VIDEO_DECODE,{peer:s._uintid,videowidth:e,videoheight:n,subscribeElapse:ni.measureFromSubscribeStart(this.store.clientId,t),subscribeRequestid:t,p2pid:this.store.p2pId,apEnd:o.requestAPEnd||0,apStart:o.requestAPStart||0,joinGwEnd:o.joinGatewayEnd||0,joinGwStart:o.joinGatewayStart||0,pcEnd:o.peerConnectionEnd||0,pcStart:o.peerConnectionStart||0,subscriberEnd:a?.subscribeEnd||0,subscriberStart:a?.subscribeStart||0,videoAddNotify:a?.streamAdded||0,state:i?1:0})}}async remoteMediaSsrcChanged(t,e,n){if(!this.recvConnection)return!1;const i=this.remoteUserMap.get(t);if(!i)return!1;const r=i.get(e);if(!r)return!1;const s=await this.recvConnection.getRemoteSSRC(r);return s!==void 0&&s!==n}isPreSubScribe(t){return!1}async publishDataChannel(t){throw new H(A.NOT_SUPPORTED)}async unpublishDataChannel(t){throw new H(A.NOT_SUPPORTED)}async subscribeDataChannel(t,e){throw new H(A.NOT_SUPPORTED)}async unsubscribeDataChannel(t,e){throw new H(A.NOT_SUPPORTED)}hasPendingRemoteDataChannel(t,e){throw new H(A.NOT_SUPPORTED)}setPendingRemoteDataChannel(t,e){throw new H(A.NOT_SUPPORTED)}async preConnect(t){throw new H(A.NOT_SUPPORTED)}getEstablishParams(){throw new H(A.NOT_SUPPORTED)}async reSubscribe(t){throw new H(A.NOT_SUPPORTED)}reportVideoFirstFrameRender(t){}async updateVideoStreamParameter(t,e){throw new H(A.NOT_SUPPORTED)}unbindRtpTransceiver(){this.localTrackMap.size!==0&&Array.from(this.localTrackMap.entries()).forEach((t=>{let[e,{track:n}]=t;e===tt.LocalVideoLowTrack?n._updateRtpTransceiver(void 0,Ad.LOW_STREAM):n._updateRtpTransceiver(void 0)}))}},ot(Xe.prototype,"p2pConnect",[_M],Object.getOwnPropertyDescriptor(Xe.prototype,"p2pConnect"),Xe.prototype),ot(Xe.prototype,"unpublish",[fM],Object.getOwnPropertyDescriptor(Xe.prototype,"unpublish"),Xe.prototype),ot(Xe.prototype,"unpublishLowStream",[mM],Object.getOwnPropertyDescriptor(Xe.prototype,"unpublishLowStream"),Xe.prototype),ot(Xe.prototype,"subscribe",[EM],Object.getOwnPropertyDescriptor(Xe.prototype,"subscribe"),Xe.prototype),ot(Xe.prototype,"mockSubscribe",[gM],Object.getOwnPropertyDescriptor(Xe.prototype,"mockSubscribe"),Xe.prototype),ot(Xe.prototype,"unsubscribe",[SM],Object.getOwnPropertyDescriptor(Xe.prototype,"unsubscribe"),Xe.prototype),ot(Xe.prototype,"muteRemote",[TM],Object.getOwnPropertyDescriptor(Xe.prototype,"muteRemote"),Xe.prototype),ot(Xe.prototype,"unmuteRemote",[RM],Object.getOwnPropertyDescriptor(Xe.prototype,"unmuteRemote"),Xe.prototype),ot(Xe.prototype,"hasRemoteMediaWithLock",[vM],Object.getOwnPropertyDescriptor(Xe.prototype,"hasRemoteMediaWithLock"),Xe.prototype),ot(Xe.prototype,"disconnectForReconnect",[CM],Object.getOwnPropertyDescriptor(Xe.prototype,"disconnectForReconnect"),Xe.prototype),ot(Xe.prototype,"remoteMediaSsrcChanged",[yM],Object.getOwnPropertyDescriptor(Xe.prototype,"remoteMediaSsrcChanged"),Xe.prototype),Xe);function Ds(t){return function(e,n,i){const r=e[n];if(typeof r!="function")throw new Error("Cannot use mutex on object property.");return i.value=async function(){for(var s=arguments.length,o=new Array(s),a=0;a<s;a++)o[a]=arguments[a];switch(t){case Ns.SEND_ONLY:{const c=await this.sendMutex.lock("From P2PChannel2.".concat(n));try{return await r.apply(this,o)}finally{c()}}case Ns.RECEIVE_ONLY:{const c=await this.recvMutex.lock("From P2PChannel2.".concat(n));try{return await r.apply(this,o)}finally{c()}}default:{const c=await this.sendMutex.lock("From P2PChannel2.".concat(n)),d=await this.recvMutex.lock("From P2PChannel2.".concat(n));try{return await r.apply(this,o)}finally{c(),d()}}}},i}}class bc extends qe{constructor(e,n){super(),R(this,"signal",void 0),R(this,"token",void 0),R(this,"tokenTimeout",void 0),R(this,"tokenInterval",void 0),R(this,"_sequence",0),R(this,"userMap",new Map),R(this,"encoder",new TextEncoder),this.signal=e,this.token=n;const i=()=>{this.signal.connectionState===ee.CONNECTED&&this.check(),this.userMap.size===0?this.tokenInterval=window.setTimeout(i,1e3):this.tokenInterval=window.setTimeout(i,3*I("P2P_TOKEN_INTERVAL"))};i()}async send(e,n,i,r,s){var o;if(this.userMap.size===0)return;const a=Array.from(qi(o=this.userMap).call(o))[0].token;typeof n!="string"&&(n=JSON.stringify(n)),r=r??Se(6,""),s=s??this._sequence++;const c={_id:r,_type:e,_seq:s,_message:n,token:"".concat(this.token,"_").concat(a)};I("SHOW_P2P_LOG")&&m.debug("send message",c,"noNeedResponse : ".concat(i)),this.splitMessage(JSON.stringify(c)).forEach((l=>{this.signal.request(Tt.DATA_STREAM,{payload:aa(this.encoder.encode(l))})}));const d=new st(((l,h)=>{const p=window.setTimeout((()=>{this.off("res-@".concat(r,"_ack"),f),this.off("res-@".concat(r),S),this.off(Fd.ABORT,v),m.debug("[external-signal] request timeout, type: ".concat(e,", requestId: ").concat(r)),this.userMap.size===0?h(new H(A.INVALID_REMOTE_USER)):h(new H(A.TIMEOUT))}),I("EXTERNAL_SIGNAL_REQUEST_TIMEOUT")),f=()=>{p&&window.clearTimeout(p),this.off(Fd.ABORT,v),i&&l()},v=()=>{p&&window.clearTimeout(p),this.off("res-@".concat(r,"_ack"),f),this.off("res-@".concat(r),S),h(new H(A.EXTERNAL_SIGNAL_ABORT,"type: ".concat(e,", requestId: ").concat(r)))};this.once(Fd.ABORT,v),this.once("res-@".concat(r,"_ack"),f);const S=(b,w)=>{T=!0,p&&window.clearTimeout(p),this.off("res-@".concat(r,"_ack"),f),this.off(Fd.ABORT,v),b==="success"?l(w):h(new H(A.P2P_MESSAGE_FAILED,"request ".concat(e," failed, requestId: ").concat(r)))};let T=!1;i||(this.once("res-@".concat(r),S),Nn(I("SIGNAL_REQUEST_TIMEOUT")).then((()=>{T||m.warning("external_signal request timeout, type: ".concat(e,", requestId: ").concat(r,", ").concat(c))})))}));try{return await d}catch(l){if(l.code===A.TIMEOUT)return await this.send(e,n,i,r,s);throw l}}onMessage(e){var n;const{_uid:i}=e;let r,s=this.userMap.get(i);if(s)r=s.splitMessageMap;else{if(this.userMap.size>0||!("_type"in e)||e._type!==cn.CHECK)return;const{token:d}=e;r=new Map,s={uid:i,isStart:!0,token:d,splitMessageMap:r,nextExpectedSequenceNumber:0,receivedMessagesMap:new Map},this.userMap.set(i,s),this.signal.emit(Lt.ON_USER_ONLINE,{uid:i}),this.handleUserOnline()}if("id"in e&&"total"in e){var o;const{id:d,total:l}=e,h=(o=r.get(d))!==null&&o!==void 0?o:[];if(h.push(e),r.has(d)||r.set(d,h),h.length!==l)return;{const p=Fa(h).call(h,((f,v)=>f.index-v.index)).map((f=>f.payload)).join("");r.delete(d),(e=JSON.parse(p))._uid=i}}const{_type:a,token:c}=e;if($(n=[cn.ACK,cn.CHECK]).call(n,a))return a===cn.CHECK&&this.handleCheckToken(s,c),void this.receiveMessage(e);c==="".concat(s.token,"_").concat(this.token)?this.handleReceivedMessage(e):m.debug('Receive unexpected message", '.concat(c,", cur_token: ").concat(s.token,"_").concat(this.token),e)}check(){const e={_id:Se(6,""),token:this.token,_type:cn.CHECK};I("SHOW_P2P_LOG")&&m.debug("send message",e),this.signal.request(Tt.DATA_STREAM,{payload:aa(this.encoder.encode(JSON.stringify(e)))})}ack(e){const n={_id:e,_type:cn.ACK,token:this.token};I("SHOW_P2P_LOG")&&m.debug("send message",n),this.signal.request(Tt.DATA_STREAM,{payload:aa(this.encoder.encode(JSON.stringify(n)))})}response(e,n,i){this.send(cn.RESPONSE,JSON.stringify({success:!i,message:n}),!0,e)}handleReceivedMessage(e){const n=()=>{this.userMap.forEach((d=>{const{receivedMessagesMap:l,nextExpectedSequenceNumber:h}=d;for(;l.has(h);){const p=l.get(h);l.delete(h),this.receiveMessage(p),d.nextExpectedSequenceNumber++}}))};if(!e)return void n();const{_uid:i,_seq:r}=e,s=this.userMap.get(i),{receivedMessagesMap:o,isStart:a,nextExpectedSequenceNumber:c}=s;if(r<c)return this.ack(e._id),void m.debug("[external-signal] receive old message, seq: ".concat(r,", ").concat(e._message));o.set(r,e),a&&r===c&&(this.receiveMessage(e),o.delete(c),s.nextExpectedSequenceNumber++,n())}receiveMessage(e){const{_id:n,_type:i,_message:r,_uid:s}=e;if(I("SHOW_P2P_LOG")&&m.debug("receive message",e),n){let o;switch(e._type!==cn.ACK&&(r&&(o=JSON.parse(r)),this.ack(e._id)),e._type){case cn.CANDIDATE:case cn.CONTROL:this.signal.emit(i,o,s);break;case cn.PUBLISH:case cn.UNPUBLISH:case cn.RESTART_ICE:case cn.CALL:o.uid=s,Sn(this.signal,i,o).then((a=>{this.response(e._id,a)})).catch((()=>{this.response(e._id,void 0,!0)}));break;case cn.ACK:this.getListeners("res-@".concat(n,"_ack")).length>0&&this.emit("res-@".concat(n,"_ack"));break;case cn.RESPONSE:{const{success:a,message:c}=o;this.emit("res-@".concat(n),a?"success":"failed",c);break}}}}splitMessage(e){if(e.length<bc.MAX_MESSAGE_SIZE)return[e];const n=[],{remoteToken:i}=JSON.parse(e),r=Se(6,"");let s=0,o=800;const a=Math.ceil(e.length/o);for(;e.length>0;){s++;const c={id:r,index:s,total:a,payload:e.slice(0,o),token:"".concat(this.token,"_").concat(i)};JSON.stringify(c).length>bc.MAX_MESSAGE_SIZE?o-=50:(n.push(c),e=e.slice(o))}return n.map((c=>JSON.stringify(c)))}handleCheckToken(e,n){return e.token!==n?(m.debug("token changed, from ".concat(e.token," to ").concat(n)),this.reset(e.uid,n),!1):(this.tokenTimeout&&(window.clearTimeout(this.tokenTimeout),this.tokenTimeout=void 0),this.tokenTimeout=window.setTimeout((()=>{m.debug("token timeout, ".concat(n)),this.reset(e.uid)}),I("MAX_P2P_TIMEOUT")),!0)}async handleUserOnline(){const e=await Sn(this.signal,cn.CALL,void 0),n=await this.send(cn.CALL,e);this.signal.emit(ft.P2P_CONNECTION,n,!0)}async reset(e,n){const i=this.userMap.get(e);i&&(this.emit(Fd.ABORT),this.signal.emit(Lt.ON_USER_OFFLINE,{uid:i.uid,reason:EY.P2P_TOKEN_CHANGED}),this._sequence=0,this.userMap.clear(),n||(m.debug("change local token from ".concat(n," to ").concat(n)),this.token=Se(6,"")))}clear(){this._sequence=0,this.userMap.clear(),this.tokenInterval&&window.clearTimeout(this.tokenInterval),this.tokenInterval=void 0,this.tokenTimeout&&window.clearTimeout(this.tokenTimeout),this.tokenTimeout=void 0,this.emit(Fd.ABORT)}}R(bc,"MAX_SIZE",1),R(bc,"MAX_MESSAGE_SIZE",1024);class nX extends qe{get connectionState(){return this._connectionState}set connectionState(e){e!==this._connectionState&&(this._connectionState=e,e===ee.CONNECTED?this.emit(ft.WS_CONNECTED):e===ee.RECONNECTING?this.emit(ft.WS_RECONNECTING,this._websocketReconnectReason):e===ee.CLOSED&&this.emit(ft.WS_CLOSED,this._disconnectedReason))}get currentURLIndex(){return this.websocket.currentURLIndex}get url(){return this.websocket&&this.websocket.url||null}get rtt(){return this.rttRolling.mean()}constructor(e,n){super(),R(this,"__name__","P2PSignal"),R(this,"_disconnectedReason",void 0),R(this,"_websocketReconnectReason",void 0),R(this,"_connectionState",ee.CLOSED),R(this,"reconnectToken",void 0),R(this,"p2pToken",void 0),R(this,"websocket",void 0),R(this,"openConnectionTime",void 0),R(this,"clientId",void 0),R(this,"lastMsgTime",Date.now()),R(this,"uploadCache",[]),R(this,"uploadCacheInterval",void 0),R(this,"rttRolling",new nS(5)),R(this,"pingpongTimer",void 0),R(this,"pingpongTimeoutCount",0),R(this,"joinResponse",void 0),R(this,"multiIpOption",void 0),R(this,"initError",void 0),R(this,"spec",void 0),R(this,"store",void 0),R(this,"_external_signal",void 0),R(this,"onWebsocketMessage",(i=>{if(i.data instanceof ArrayBuffer)return void this.emit(ft.ON_BINARY_DATA,i.data);const r=JSON.parse(i.data);if(this.lastMsgTime=Date.now(),Object.prototype.hasOwnProperty.call(r,"_id")){const s="res-@".concat(r._id);this.emit(s,r._result,r._message)}else if(Object.prototype.hasOwnProperty.call(r,"_type")){switch(r._type){case Lt.ON_DATA_STREAM:return void this.handleDataStream(r._message);case Lt.MUTE_AUDIO:case Lt.MUTE_VIDEO:case Lt.ON_P2P_LOST:case Lt.ON_USER_ONLINE:return;case Lt.ON_USER_OFFLINE:const{uid:s}=r._message;return m.debug("[".concat(this.clientId,"] user-offline uid: ").concat(s)),void this._external_signal.reset(s)}if(this.emit(r._type,r._message),r._type===Lt.ON_NOTIFICATION&&this.handleNotification(r._message),r._type===Lt.ON_USER_BANNED)switch(r._message.error_code){case 14:this.close(te.UID_BANNED);break;case 15:this.close(te.IP_BANNED);break;case 16:this.close(te.CHANNEL_BANNED)}if(r._type===Lt.ON_USER_LICENSE_BANNED)switch(r._message.error_code){case yt.ERR_LICENSE_MISSING:this.close(te.LICENSE_MISSING);break;case yt.ERR_LICENSE_EXPIRED:this.close(te.LICENSE_EXPIRED);break;case yt.ERR_LICENSE_MINUTES_EXCEEDED:this.close(te.LICENSE_MINUTES_EXCEEDED);break;case yt.ERR_LICENSE_PERIOD_INVALID:this.close(te.LICENSE_PERIOD_INVALID);break;case yt.ERR_LICENSE_MULTIPLE_SDK_SERVICE:this.close(te.LICENSE_MULTIPLE_SDK_SERVICE);break;case yt.ERR_LICENSE_ILLEGAL:this.close(te.LICENSE_ILLEGAL);break;default:this.close()}}})),this.clientId=e.clientId,this.spec=e,this.store=n,this.websocket=new JS("gateway-".concat(this.clientId),this.spec.retryConfig,!0,I("JOIN_GATEWAY_USE_DUAL_DOMAIN"),I("JOIN_GATEWAY_USE_443PORT_ONLY"),n),this.handleWebsocketEvents(),window.addEventListener("offline",(()=>{this.connectionState===ee.CONNECTED&&this.reconnect("retry",Xn.OFFLINE)})),this.p2pToken=Se(6,""),this._external_signal=new bc(this,this.p2pToken)}async request(e,n,i,r){const s=Se(6,""),o={_id:s,_type:e,_message:n},a=this.websocket.connectionID,c=()=>new st(((v,S)=>{if(this.connectionState===ee.CONNECTED)return v();const T=()=>{this.off(ft.WS_CLOSED,b),v()},b=()=>{this.off(ft.WS_CONNECTED,T),S(new H(A.WS_ABORT))};this.once(ft.WS_CONNECTED,T),this.once(ft.WS_CLOSED,b)}));if(this.connectionState!==ee.CONNECTING&&this.connectionState!==ee.RECONNECTING||e===Tt.JOIN||e===Tt.REJOIN||await c(),this.websocket.sendMessage(o,!0),r)return;const d=new st(((v,S)=>{let T=!1;const b=(D,k)=>{T=!0,v({isSuccess:D==="success",message:k||{}}),this.off(ft.WS_CLOSED,w),this.off(ft.WS_RECONNECTING,w),this.emit(ft.REQUEST_SUCCESS,e,n)};this.once("res-@".concat(s),b);const w=()=>{S(new H(A.WS_ABORT,"type: ".concat(e))),this.off(ft.WS_CLOSED,w),this.off(ft.WS_RECONNECTING,w),this.off("res-@".concat(s),b)};this.once(ft.WS_CLOSED,w),this.once(ft.WS_RECONNECTING,w),Nn(I("SIGNAL_REQUEST_TIMEOUT")).then((()=>{this.websocket.connectionID!==a||T||(m.warning("[".concat(this.clientId,"] ws request timeout, type: ").concat(e)),this.emit(ft.REQUEST_TIMEOUT,e,n))}))}));let l=null;try{l=await d}catch(v){if(this.connectionState===ee.CLOSED||e===Tt.LEAVE)throw new H(A.WS_ABORT);return!this.spec.forceWaitGatewayResponse||i?v.throw():e===Tt.JOIN||e===Tt.REJOIN?null:(await c(),await this.request(e,n))}if(l.isSuccess)return l.message;const h=Number(l.message.error_code||l.message.code),p=pc(h),f=new H(A.UNEXPECTED_RESPONSE,"".concat(p.desc,": ").concat(l.message.error_str),{code:h,data:l.message,desc:p.desc});return p.action==="success"?l.message:(m.warning("[".concat(this.clientId,"] [").concat(this.websocket.connectionID,"] unexpected response from type ").concat(e,", error_code: ").concat(h,", message: ").concat(p.desc,", action: ").concat(p.action)),h===yt.ERR_TOO_MANY_BROADCASTERS?((e===Tt.JOIN||e===Tt.REJOIN)&&(this.initError=f,this.close()),f.throw()):p.action==="failed"?f.throw():p.action==="quit"?(this.initError=f,this.close(),f.throw()):(h===yt.ERR_JOIN_BY_MULTI_IP?(this.multiIpOption=l.message.option,m.warning("[".concat(this.clientId,"] detect multi ip, recover")),this.reconnect("recover",Xn.MULTI_IP)):this.reconnect(p.action,Xn.SERVER_ERROR),e===Tt.JOIN||e===Tt.REJOIN?null:await this.request(e,n)))}waitMessage(e,n){return new st((i=>{const r=s=>{(!n||n(s))&&(this.off(e,r),i(s))};this.on(e,r)}))}uploadWRTCStats(e){if(!this.store.sessionId)return void m.warn("[".concat(this.clientId,"] no session id when upload wrtc stats"));const n={lts:Date.now(),sid:this.store.sessionId,uid:this.store.intUid,stats:e};this.upload(hc.WRTC_STATS,n)}upload(e,n){const i={_type:e,_message:n};try{this.websocket.sendMessage(i)}catch{const s=I("MAX_UPLOAD_CACHE")||50;this.uploadCache.push(i),this.uploadCache.length>s&&this.uploadCache.splice(0,1),this.uploadCache.length>0&&!this.uploadCacheInterval&&(this.uploadCacheInterval=window.setInterval((()=>{if(this.connectionState!==ee.CONNECTED)return;const o=this.uploadCache.splice(0,1)[0];this.uploadCache.length===0&&(window.clearInterval(this.uploadCacheInterval),this.uploadCacheInterval=void 0),this.upload(o._type,o._message)}),I("UPLOAD_CACHE_INTERVAL")||2e3))}}send(e,n){const i={_type:e,_message:n};this.websocket.sendMessage(i)}async sendExtensionMessage(e,n,i){return await this._external_signal.send(e,n,i)}init(e){return this.initError=void 0,this.multiIpOption=void 0,this.joinResponse=void 0,this.reconnectToken=void 0,this.openConnectionTime=void 0,new st(((n,i)=>{this.once(ft.WS_CONNECTED,(()=>n(this.joinResponse))),this.once(ft.WS_CLOSED,(()=>i(this.initError||new H(A.WS_ABORT)))),this.connectionState=ee.CONNECTING,this.websocket.init(e).catch(i)}))}close(e){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.reconnectToken=void 0,this.joinResponse=void 0,this._external_signal.clear(),this._disconnectedReason=e||te.LEAVE,this.connectionState=ee.CLOSED,m.debug("[".concat(this.clientId,"] ")+"will close websocket in signal"),this.websocket.close(),this.p2pToken=Se(6,""),this._external_signal.clear(),this._external_signal=new bc(this,this.p2pToken)}async join(){if(!this.joinResponse){this.emit(ft.ABORT_P2P_EXECUTION);const e=await Sn(this,ft.REQUEST_JOIN_INFO),n=await this.request(Tt.JOIN,e);if(!n)return this.emit(ft.REPORT_JOIN_GATEWAY,A.TIMEOUT,this.url||""),!1;this.joinResponse=n,this.emit(ft.JOIN_RESPONSE,this.joinResponse),this.reconnectToken=this.joinResponse.rejoin_token}return this.connectionState=ee.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),!0}reconnect(e,n){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.websocket.reconnect(e,n)}async downgradeCodec(e){return!1}handleDataStream(e){try{var n;const i=tc(e.payload),r=new TextDecoder().decode(i),s=JSON.parse(r);"total"in s&&"id"in s||$(n=Object.values(cn)).call(n,s._type)?(s._uid=e.uid,this._external_signal.onMessage(s)):this.emit(Lt.ON_DATA_STREAM,e)}catch{this.emit(Lt.ON_DATA_STREAM,e)}}handleNotification(e){m.debug("[".concat(this.clientId,"] receive notification: "),e);const n=pc(e.code);if(n.action!=="success"){if(n.action!=="failed")return n.action==="quit"?e.code===yt.ERR_REPEAT_JOIN_CHANNEL&&I("IGNORE_UID_CHECK")?void this.close(te.UID_CONFLICT):(n.desc==="ERR_REPEAT_JOIN_CHANNEL"&&this.close(te.UID_BANNED),void this.close()):void this.reconnect(n.action,Xn.SERVER_ERROR);m.error("[".concat(this.clientId,"] ignore error: "),n.desc)}}handlePingPong(){if(!this.websocket||this.websocket.state!=="connected")return;this.pingpongTimeoutCount>0&&this.rttRolling.add(3e3),this.pingpongTimeoutCount+=1;const e=I("PING_PONG_TIME_OUT"),n=Date.now();this.pingpongTimeoutCount>=e&&(m.warning("[".concat(this.clientId,"] PINGPONG Timeout. Last Socket Message: ").concat(n-this.lastMsgTime,"ms")),n-this.lastMsgTime>I("WEBSOCKET_TIMEOUT_MIN"))?this.reconnect("retry",Xn.TIMEOUT):this.request(Tt.PING,void 0,!0).then((()=>{this.pingpongTimeoutCount=0;const i=Date.now()-n;this.rttRolling.add(i),I("REPORT_STATS")&&this.send(Tt.PING_BACK,{pingpongElapse:i})})).catch((i=>{}))}handleWebsocketEvents(){this.websocket.on(Bt.RECONNECT_CREATE_CONNECTION,(e=>{this.emit(ft.WS_RECONNECT_CREATE_CONNECTION,e)})),this.websocket.on(Bt.ON_MESSAGE,this.onWebsocketMessage),this.websocket.on(Bt.CLOSED,(()=>{this.connectionState=ee.CLOSED})),this.websocket.on(Bt.FAILED,(()=>{this._disconnectedReason=te.NETWORK_ERROR,this.connectionState=ee.CLOSED})),this.websocket.on(Bt.RECONNECTING,(e=>{this._websocketReconnectReason=e,this.joinResponse=void 0,this.connectionState===ee.CONNECTED?this.connectionState=ee.RECONNECTING:this.connectionState=ee.CONNECTING})),this.websocket.on(Bt.WILL_RECONNECT,((e,n,i)=>{e!=="retry"?(m.debug("".concat(this.clientId," websocket will_connect event, renewSession reconnectMode is ").concat(e)),this.reconnectToken=void 0):m.debug("".concat(this.clientId," reconnect mode is retry, no need to renew session")),i(e)})),this.websocket.on(Bt.CONNECTED,(()=>{this.openConnectionTime=Date.now(),this.join().catch((e=>{if(this.emit(ft.REPORT_JOIN_GATEWAY,e,this.url||""),e instanceof H&&e.code===A.UNEXPECTED_RESPONSE&&e.data.code===yt.ERR_NO_AUTHORIZED)return m.warning("[".concat(this.clientId,"] reconnect no authorized, recover")),void this.reconnect("recover",Xn.SERVER_ERROR);m.error("[".concat(this.clientId,"] join gateway request failed"),e.toString()),this.spec.forceWaitGatewayResponse?this.reconnect("tryNext",Xn.SERVER_ERROR):(this.initError=e,this.close())}))})),this.websocket.on(Bt.REQUEST_NEW_URLS,((e,n)=>{Sn(this,ft.REQUEST_RECOVER,this.multiIpOption).then(e).catch(n)})),this.websocket.on(Bt.ON_TOKEN_PRIVILEGE_DID_EXPIRE,(()=>{this.emit(Lt.ON_TOKEN_PRIVILEGE_DID_EXPIRE)}))}}const iX={name:"P2PChannel",create:function(t){let{store:e,statsCollector:n}=t;return new eX(e,n)},createSubmodule:function(t){let{store:e,spec:n}=t;return new nX(n,e)}};function bM(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable}))),n.push.apply(n,i)}return n}function AM(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?bM(Object(n),!0).forEach((function(i){R(t,i,n[i])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):bM(Object(n)).forEach((function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i))}))}return t}class rX{constructor(e){R(this,"sessionDesc",void 0),R(this,"localCapabilities",void 0),R(this,"rtpCapabilities",void 0),R(this,"candidates",void 0),R(this,"_originCandidates",void 0),R(this,"iceParameters",void 0),R(this,"dtlsParameters",void 0),R(this,"setup",void 0),R(this,"currentMidIndex",void 0),R(this,"cname",void 0),e=Ve(e);const{iceParameters:n,dtlsParameters:i,candidates:r,rtpCapabilities:s,setup:o,localCapabilities:a,sdkCodec:c,cname:d}=e,l=Ei(`v=0
o=- 0 0 IN IP4 127.0.0.1
s=AgoraGateway
t=0 0
a=group:BUNDLE audio video
a=msid-semantic: WMS
a=ice-lite
m=audio 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendrecv
a=rtcp-mux
a=rtcp-rsize
a=mid:audio
m=video 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendrecv
a=rtcp-mux
a=rtcp-rsize
a=mid:video
`);this.rtpCapabilities=s,this.candidates=r,this._originCandidates=Ve(r),this.iceParameters=n,this.dtlsParameters=i,this.setup=o,this.localCapabilities=a,this.cname=d;for(let h=0;h<l.mediaDescriptions.length;h++){const p=l.mediaDescriptions[h];if(p.attributes.iceUfrag=n.iceUfrag,p.attributes.icePwd=n.icePwd,p.attributes.fingerprints=i.fingerprints,p.attributes.candidates=r,p.attributes.setup=o,p.media.mediaType==="video"){p.media.fmts=s.videoCodecs.map((S=>S.payloadType.toString(10)));const f=s.videoCodecs.filter((S=>{var T,b;return(T=S.rtpMap)===null||T===void 0?void 0:$(b=T.encodingName.toLowerCase()).call(b,c)})),v=s.videoCodecs.filter((S=>!$(f).call(f,S)));p.attributes.payloads=[...f,...v],p.attributes.extmaps=s.videoExtensions}p.media.mediaType==="audio"&&(p.media.fmts=s.audioCodecs.map((f=>f.payloadType.toString(10))),p.attributes.payloads=s.audioCodecs,p.attributes.extmaps=s.audioExtensions),l.mediaDescriptions[h]=this.mungMediaDesc(p)}this.sessionDesc=l,this.currentMidIndex=l.mediaDescriptions.length-1}toString(){return Oo(this.sessionDesc)}send(e,n,i){const{ssrcs:r,ssrcGroups:s}=Eu(n,this.cname),o=this.sessionDesc.mediaDescriptions.find((d=>e===ut.VIDEO?d.media.mediaType==="video":d.media.mediaType==="audio")),a=r[0].attributes.label,c=r[0].attributes.mslabel;return o.attributes.ssrcs=o.attributes.ssrcs.concat(r),o.attributes.ssrcGroups=o.attributes.ssrcGroups.concat(s),{id:a,mslabel:c}}batchSend(e){return e.map((n=>{let{kind:i,ssrcMsg:r}=n;return this.send(i,r,void 0)}))}stopSending(e){this.sessionDesc.mediaDescriptions.forEach((n=>{const i=[],r=[],s=[];n.attributes.ssrcs.forEach((o=>{$(e).call(e,o.attributes.label||"")?s.push(o):i.push(o)})),n.attributes.ssrcGroups.forEach((o=>{var a;$(a=s.map((c=>c.ssrcId))).call(a,o.ssrcIds[0])||r.push(o)})),n.attributes.ssrcs=i,n.attributes.ssrcGroups=r}))}mute(e){const n=this.sessionDesc.mediaDescriptions.find((i=>i.attributes.mid===e));if(!n)throw new Error("mediaDescription not found with ".concat(e," in remote SDP when calling RemoteSDP.mute."));n.attributes.direction="inactive"}unmute(e){const n=this.sessionDesc.mediaDescriptions.find((i=>i.attributes.mid===e));if(!n)throw new Error("mediaDescription not found with ".concat(e," in remote SDP when calling RemoteSDP.unmute."));n.attributes.direction="sendonly"}receive(e,n,i){e.forEach(((r,s)=>{const o=r._mediaStreamTrack,a=this.sessionDesc.mediaDescriptions.findIndex((d=>d.attributes.mid===o.kind)),c=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[a],r);this.sessionDesc.mediaDescriptions[a]=c}))}stopReceiving(e){}updateCandidates(e){const n=this._originCandidates.filter((r=>r.transport==="udp")),i=[];if(n.forEach((r=>{i.push(AM(AM({},r),{},{foundation:"tcpcandidate",priority:Number(r.priority)-1+"",transport:"tcp",port:Number(r.port)+90+""}))})),n.length!==0){switch(e){case xn.TCP_RELAY:this.candidates=i;break;case xn.UDP_TCP_RELAY:case xn.RELAY:this.candidates=[...n,...i];break;default:this.candidates=n}for(const r of this.sessionDesc.mediaDescriptions)r.attributes.candidates=this.candidates}}restartICE(e){e=Ve(e),this.iceParameters=e,this.sessionDesc.mediaDescriptions.forEach((n=>{n.attributes.iceUfrag=e.iceUfrag,n.attributes.icePwd=e.icePwd}))}predictReceivingMids(e){const n=[];for(let i=0;i<e;i++)n.push((this.currentMidIndex+i+1).toString(10));return n}mungRecvMediaDsec(e,n){const i=Ve(e);return _c(i,n),nT(i,n),i}updateRecvMedia(e,n){const i=this.sessionDesc.mediaDescriptions.findIndex((r=>r.attributes.mid===e));if(i!==-1){const r=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[i],n);this.sessionDesc.mediaDescriptions[i]=r}}bumpMid(e){this.currentMidIndex+=e}updateTrackLabel(e,n,i){const r=this.sessionDesc.mediaDescriptions.find((o=>e===ut.VIDEO?o.attributes.mid==="video":o.attributes.mid==="audio"));if(r){const o=r.attributes.ssrcs.find((a=>a.attributes.label===n));var s;o&&(o.attributes.label=i,(s=o.attributes.msid)===null||s===void 0||s.replace(n,i))}}mungMediaDesc(e){const n=Ve(e);return eT(n),(function(i){const r=i.attributes.extmaps.find((s=>b_(s.extensionName)));r&&i.attributes.extmaps.splice(i.attributes.extmaps.indexOf(r),1),i.attributes.payloads.forEach((s=>{const o=s.rtcpFeedbacks.findIndex((a=>a.type==="transport-cc"));o!==-1&&s.rtcpFeedbacks.splice(o,1)}))})(n),n}getSSRC(e){for(const n of this.sessionDesc.mediaDescriptions)for(const i of n.attributes.ssrcs)if(i.attributes.label===e)return[i]}}var Le;function wM(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable}))),n.push.apply(n,i)}return n}function uf(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?wM(Object(n),!0).forEach((function(i){R(t,i,n[i])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):wM(Object(n)).forEach((function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i))}))}return t}let sX=(Le=class Ju extends R_{get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get localCodecs(){return[...new Set(this.localCapabilities&&this.localCapabilities.videoCodecs.map((e=>e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"")).filter((e=>{var n;return $(n=Object.keys(ic)).call(n,e)})))]}constructor(e,n){super(e,n),R(this,"store",void 0),R(this,"peerConnection",void 0),R(this,"remoteSDP",void 0),R(this,"initialOffer",void 0),R(this,"statsFilter",void 0),R(this,"useRTX",!1),R(this,"localCapabilities",void 0),R(this,"localCandidateCount",0),R(this,"allCandidatesReceived",!1),R(this,"establishPromise",void 0),R(this,"mutex",void 0),this.store=n,this.mutex=new Un("P2PConnection-mutex",n.clientId),this.peerConnection=new RTCPeerConnection(Ju.resolvePCConfiguration(e),{optional:[{googDscp:!0}]}),this.statsFilter=Xp(this.peerConnection,I("STATS_UPDATE_INTERVAL"),void 0,xe()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1,this.establishPromise=this.establish()}async establish(){try{const e=await this.peerConnection.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0});if(!e.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const n=no(e.sdp),i=mu(e.sdp,{filterRTX:!this.useRTX,filterVideoFec:I("FILTER_VIDEO_FEC"),filterAudioFec:I("FILTER_AUDIO_FEC"),filterAudioCodec:["opus"]});return this.localCapabilities=i,this.initialOffer=e,uf(uf({},n),{},{rtpCapabilities:{send:{audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},recv:{audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},sendrecv:i},offerSDP:e.sdp})}catch(e){throw new H(A.GET_LOCAL_CONNECTION_PARAMS_FAILED,e.toString())}}async updateRemoteConnect(){}async connect(e){try{if(!this.initialOffer)throw new Error("Cannot establish P2PConnection without initial offer.");this.remoteSDP=new rX(uf(uf({},e),{},{rtpCapabilities:e.rtpCapabilities.send,localCapabilities:this.localCapabilities,sdkCodec:this.store.codec}));const n=this.remoteSDP.toString();await this.peerConnection.setLocalDescription(this.initialOffer),await this.peerConnection.setRemoteDescription({type:"answer",sdp:n})}catch(n){throw new H(A.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(n.toString()))}}async updateRemoteRTPCapabilities(e,n){throw new H(A.NOT_SUPPORTED,"Planb mode does not support createDataChannels.")}getPreMedia(e){}send(e,n){var i=this;return Ci((function*(){const r=yield Ht(i.mutex.lock());try{if(!i.remoteSDP)throw new Error("Cannot call P2PConnection.send before remote SDP created");const s=e.map((p=>i.peerConnection.addTrack(p._mediaStreamTrack))),o=yield Ht(i.peerConnection.createOffer()),a=Ei(o.sdp),c=e.map((p=>{const f=p._mediaStreamTrack,v=a.mediaDescriptions.find((S=>S.attributes.mid===f.kind));if(!v)throw new Error("Cannot extract ssrc from mediaDescription.");return(function(S,T,b){const w=S.attributes.ssrcs.filter((k=>k.attributes.label===T)),D=S.attributes.ssrcGroups;if(w.length===0)throw new Error("Cannot extract ssrc from plan-b SDP.");if(D&&w.length>1){const k=D.find((U=>U.ssrcIds.indexOf(w[0].ssrcId)!==-1));return k?[{ssrcId:k.ssrcIds[0],rtx:b?k.ssrcIds[1]:void 0}]:[{ssrcId:w[0].ssrcId}]}return[{ssrcId:w[0].ssrcId}]})(v,f.id,i.useRTX)}));let d;try{d=yield c}catch(p){throw s.forEach((f=>{Mn()&&f.replaceTrack(null),i.peerConnection.removeTrack(f)})),p}const l=i.mungSendOfferSDP(o.sdp,e);i.remoteSDP.receive(e,n,d);const h=i.remoteSDP.toString();return yield Ht(i.peerConnection.setLocalDescription({type:"offer",sdp:l})),yield Ht(i.applySendEncodings(s,e)),yield Ht(i.peerConnection.setRemoteDescription({type:"answer",sdp:h})),e.map(((p,f)=>{const v=p._mediaStreamTrack.id;return{localSSRC:c[f],id:v}}))}catch(s){throw new H(A.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(s.toString()))}finally{r()}}))()}async stopSending(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopSending before remote SDP created");const n=this.peerConnection.getSenders().filter((s=>{var o;return e.indexOf(((o=s.track)===null||o===void 0?void 0:o.id)||"")!==-1}));if(n.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length when trying to call P2PConnection.stopSending.");n.map((s=>{Mn()&&s.replaceTrack(null),this.peerConnection.removeTrack(s)}));const i=await this.peerConnection.createOffer();await this.peerConnection.setLocalDescription(i),this.remoteSDP.stopReceiving(e);const r=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"answer",sdp:r})}catch(n){throw new H(A.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(n.toString()))}}async receive(e,n,i,r){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(e," before remoteSDP created."));const{id:s,mslabel:o}=this.remoteSDP.send(e,n,r),a=new st(((l,h)=>{const p=setTimeout((()=>{h(new Error("Cannot receive track, id: ".concat(s)))}),1e4),f=v=>{const S=de();if((S.name==="Safari"&&Number(S.version)===11||si())&&v.track.id!==s&&v.streams[0].id===o){var T;const b=v.streams[0].getTracks()[0];return(T=this.remoteSDP)===null||T===void 0||T.updateTrackLabel(e,s,v.track.id),this.peerConnection.removeEventListener("track",f),clearTimeout(p),void l(b)}if(v.track.id===s)return this.peerConnection.removeEventListener("track",f),clearTimeout(p),void l(v.track)};this.peerConnection.addEventListener("track",f)})),c=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:c});const d=await this.peerConnection.createAnswer();return await this.peerConnection.setLocalDescription(d),{track:await a,id:s}}catch(s){throw new H(A.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(s.toString()))}}async stopReceiving(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(e);const n=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:n});const i=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(i)}catch(n){throw new H(A.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(n.toString()))}}async muteRemote(e){}async unmuteRemote(e){}async muteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteLocal before remote SDP created.");const n=this.peerConnection.getSenders().filter((i=>{var r;return e.indexOf(((r=i.track)===null||r===void 0?void 0:r.id)||"")!==-1}));if(n.length!==e.length)throw new Error("sender' length doesn't match mids' length.");n.map((i=>{if(Mn()&&i.track)i.track.enabled=!1;else{const r=i.getParameters();r.encodings.forEach((s=>s.active=!1)),i.setParameters(r)}}))}catch(n){throw new H(A.EXCHANGE_SDP_FAILED,"P2PConnection.muteLocal failed; ".concat(n.toString()))}}async unmuteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteLocal before remote SDP created.");const n=this.peerConnection.getSenders().filter((s=>{var o;return e.indexOf(((o=s.track)===null||o===void 0?void 0:o.id)||"")!==-1}));if(n.length!==e.length)throw new Error("Senders' length doesn't match mids' length.");n.map((async s=>{if(Mn()&&s.track)s.track.enabled=!0;else{const o=s.getParameters();o.encodings.forEach((a=>a.active=!0)),await s.setParameters(o)}}));const i=await this.peerConnection.createOffer();await this.peerConnection.setLocalDescription(i);const r=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"answer",sdp:r})}catch(n){throw new H(A.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteLocal failed; ".concat(n.toString()))}}restartICE(e){var n=this;return Ci((function*(){const i=yield Ht(n.mutex.lock("From P2PConnection.restartICE"));try{if(!n.remoteSDP)throw new Error("Cannot restartICE before remoteSDP created.");const r=Jt().supportPCSetConfiguration;if(e===xn.RELAY&&!r)return;if(r){const d=n.peerConnection.getConfiguration(),l=e===xn.RELAY?"relay":"all";d.iceTransportPolicy!==l&&(m.debug("[".concat(n.store.clientId,"] restartICE change iceTransportPolicy from [").concat(d.iceTransportPolicy,"] to [").concat(l,"]")),d.iceTransportPolicy=l,n.peerConnection.setConfiguration(d))}e!==xn.RELAY&&n.remoteSDP.updateCandidates(e);const s=yield Ht(n.peerConnection.createOffer({iceRestart:!0}));if(!s.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const o=no(s.sdp),{remoteIceParameters:a}=yield o.iceParameters;n.remoteSDP.restartICE(a);const c=n.remoteSDP.toString();yield Ht(n.peerConnection.setLocalDescription(s)),yield Ht(n.peerConnection.setRemoteDescription({type:"answer",sdp:c}))}catch(r){m.warning("[".concat(n.store.clientId,"] restart ICE failed, abort operation"),r)}finally{i()}}))()}close(){var e;this.peerConnection.close(),(e=this.onConnectionStateChange)===null||e===void 0||e.call(this,"closed"),this.unbindPCEvents(),this.unbindStatsEvents(),this.removeAllListeners(),this.statsFilter.destroy()}getStats(){return this.statsFilter.getStats()}getRemoteVideoIsReady(e){return this.statsFilter.getVideoIsReady(e)}async updateEncoderConfig(e,n){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateEncoderConfig before remote SDP created.");const i=await this.peerConnection.createOffer(),r=this.mungSendOfferSDP(i.sdp,[n]);this.remoteSDP.updateRecvMedia(n._mediaStreamTrack.kind,n);const s=this.remoteSDP.toString();await this.peerConnection.setLocalDescription({type:"offer",sdp:r}),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(i){throw new H(A.EXCHANGE_SDP_FAILED,i.toString())}}async updateSendParameters(e,n){const i=this.peerConnection.getSenders().filter((r=>{var s;return((s=r.track)===null||s===void 0?void 0:s.id)===e}));i.length===1&&await this.applySendEncodings(i,[n])}setStatsRemoteVideoIsReady(e,n){this.statsFilter.setVideoIsReady2(e,n)}async replaceTrack(e,n){const i=this.peerConnection.getSenders().find((r=>{var s;return((s=r.track)===null||s===void 0?void 0:s.id)===n}));i&&await i.replaceTrack(e._mediaStreamTrack)}createDataChannels(e,n){throw new H(A.NOT_SUPPORTED,"Planb mode does not support createDataChannels.")}stopDataChannels(e){throw new H(A.NOT_SUPPORTED,"Planb mode does not support stopDataChannels.")}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var e;(e=this.onICEConnectionStateChange)===null||e===void 0||e.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var e;(e=this.onConnectionStateChange)===null||e===void 0||e.call(this,this.peerConnection.connectionState)},this.peerConnection.onicecandidate=e=>{e.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,m.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))},setTimeout((()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,m.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount))}),I("CANDIDATE_TIMEOUT"))}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(e){const n={iceServers:[],sdpSemantics:"plan-b"};return e.iceServers?n.iceServers=e.iceServers:e.turnServer&&e.turnServer.mode!=="off"&&(Ja(e.turnServer.servers)?n.iceServers=e.turnServer.servers:(n.iceServers&&n.iceServers.push(...Ju.turnServerConfigToIceServers(e.turnServer.servers)),I("USE_TURN_SERVER_OF_GATEWAY")&&n.iceServers&&e.turnServer.serversFromGateway&&n.iceServers.push(...Ju.turnServerConfigToIceServers(e.turnServer.serversFromGateway)),e.turnServer.servers.concat(e.turnServer.serversFromGateway||[]).forEach((i=>{i.forceturn&&(n.iceTransportPolicy="relay")})))),n}static turnServerConfigToIceServers(e){const n=[];return e.forEach((i=>{i.security?i.tcpport&&n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turns:".concat(i.turnServerURL,":").concat(i.tcpport,"?transport=tcp")}):(i.udpport&&n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":").concat(i.udpport,"?transport=udp")}),i.tcpport&&n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":").concat(i.tcpport,"?transport=tcp")}))})),n}async updateRtpSenderEncodings(e,n){var i;if(n||(n=this.peerConnection.getSenders().find((d=>{var l;return((l=d.track)===null||l===void 0?void 0:l.id)===e._mediaStreamTrack.id}))),!n)return m.warn("[".concat(e.getTrackId(),"] no rtpSender found}"));if(!Jt().supportSetRtpSenderParameters)return m.warn("Browser not support set rtp-sender parameters");const r={},s={};if(e instanceof De)switch(e._optimizationMode){case"motion":r.degradationPreference="maintain-framerate";break;case"detail":r.degradationPreference="maintain-resolution";break;default:r.degradationPreference="balanced"}if(I("DSCP_TYPE")&&Js()){var o;const d=I("DSCP_TYPE");$(o=["very-low","low","medium","high"]).call(o,d)&&(s.networkPriority=d)}const a=n.getParameters(),c=(i=a.encodings)===null||i===void 0?void 0:i[0];c&&Object.assign(c,s),Object.assign(a,r),m.debug("[".concat(e.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(a.encodings))),await n.setParameters(a)}async applySendEncodings(e,n){try{if(!Jt().supportSetRtpSenderParameters||e.length!==n.length)return;for(let i=0;i<e.length;i++){const r=e[i],s=n[i];r&&s&&await this.updateRtpSenderEncodings(s,r)}}catch{m.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}}mungSendOfferSDP(e,n){const i=Ei(e);return n.forEach(((r,s)=>{const o=r._mediaStreamTrack,a=i.mediaDescriptions.find((c=>c.attributes.mid===o.kind));a&&_c(a,r)})),Oo(i)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=e=>{var n;(n=this.onFirstAudioReceived)===null||n===void 0||n.call(this,e)},this.statsFilter.onFirstVideoReceived=e=>{var n;(n=this.onFirstVideoReceived)===null||n===void 0||n.call(this,e)},this.statsFilter.onFirstAudioDecoded=e=>{var n;(n=this.onFirstAudioDecoded)===null||n===void 0||n.call(this,e)},this.statsFilter.onFirstVideoDecoded=(e,n,i)=>{var r;(r=this.onFirstVideoDecoded)===null||r===void 0||r.call(this,e,n,i)},this.statsFilter.onSelectedLocalCandidateChanged=(e,n)=>{var i;(i=this.onSelectedLocalCandidateChanged)===null||i===void 0||i.call(this,e,n)},this.statsFilter.onSelectedRemoteCandidateChanged=(e,n)=>{var i;(i=this.onSelectedRemoteCandidateChanged)===null||i===void 0||i.call(this,e,n)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0}async batchReceive(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.batchReceive before remoteSDP created.");const n=this.remoteSDP.batchSend(e).map(((s,o)=>{let{id:a,mslabel:c}=s;const{kind:d}=e[o];return new st(((l,h)=>{const p=setTimeout((()=>{h(new Error("Cannot receive track, id: ".concat(a)))}),1e4),f=v=>{const S=de();if(S.name==="Safari"&&Number(S.version)===11&&v.track.id!==a&&v.streams[0].id===c){var T;const b=v.streams[0].getTracks()[0];return(T=this.remoteSDP)===null||T===void 0||T.updateTrackLabel(d,a,v.track.id),this.peerConnection.removeEventListener("track",f),clearTimeout(p),void l({track:b,id:a})}if(v.track.id===a)return this.peerConnection.removeEventListener("track",f),clearTimeout(p),void l({track:v.track,id:a})};this.peerConnection.addEventListener("track",f)}))})),i=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:i});const r=await this.peerConnection.createAnswer();return await this.peerConnection.setLocalDescription(r),await st.all(n)}catch(n){throw new H(A.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(n.toString()))}}async getRemoteSSRC(e){if(!this.remoteSDP)return;const n=this.remoteSDP.getSSRC(e);return n?.[0].ssrcId}setConfiguration(e){if(Jt().supportPCSetConfiguration){const n=Ju.resolvePCConfiguration(e);this.peerConnection.setConfiguration(n)}}},ot(Le.prototype,"connect",[Mr],Object.getOwnPropertyDescriptor(Le.prototype,"connect"),Le.prototype),ot(Le.prototype,"stopSending",[Mr],Object.getOwnPropertyDescriptor(Le.prototype,"stopSending"),Le.prototype),ot(Le.prototype,"receive",[Mr],Object.getOwnPropertyDescriptor(Le.prototype,"receive"),Le.prototype),ot(Le.prototype,"stopReceiving",[Mr],Object.getOwnPropertyDescriptor(Le.prototype,"stopReceiving"),Le.prototype),ot(Le.prototype,"muteRemote",[Mr],Object.getOwnPropertyDescriptor(Le.prototype,"muteRemote"),Le.prototype),ot(Le.prototype,"unmuteRemote",[Mr],Object.getOwnPropertyDescriptor(Le.prototype,"unmuteRemote"),Le.prototype),ot(Le.prototype,"muteLocal",[Mr],Object.getOwnPropertyDescriptor(Le.prototype,"muteLocal"),Le.prototype),ot(Le.prototype,"unmuteLocal",[Mr],Object.getOwnPropertyDescriptor(Le.prototype,"unmuteLocal"),Le.prototype),ot(Le.prototype,"close",[Mr],Object.getOwnPropertyDescriptor(Le.prototype,"close"),Le.prototype),ot(Le.prototype,"updateEncoderConfig",[Mr],Object.getOwnPropertyDescriptor(Le.prototype,"updateEncoderConfig"),Le.prototype),ot(Le.prototype,"updateSendParameters",[Mr],Object.getOwnPropertyDescriptor(Le.prototype,"updateSendParameters"),Le.prototype),ot(Le.prototype,"replaceTrack",[Mr],Object.getOwnPropertyDescriptor(Le.prototype,"replaceTrack"),Le.prototype),ot(Le.prototype,"getRemoteSSRC",[Mr],Object.getOwnPropertyDescriptor(Le.prototype,"getRemoteSSRC"),Le.prototype),Le);function Mr(t,e,n){const i=t[e];if(typeof i!="function")throw new Error("Cannot use mutex on object property.");return n.value=async function(){const r=this.mutex,s=await r.lock("Locking from P2PConnection.".concat(e));try{for(var o=arguments.length,a=new Array(o),c=0;c<o;c++)a[c]=arguments[c];return await i.apply(this,a)}finally{s()}},n}const oX={name:"PlanBConnection",create:function(t){let{store:e,spec:n}=t;return new sX(n,e)}},aX={interceptLocalAudioFrame:async function(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(!Jt().supportWebRTCEncodedTransform)return void m.warning("browser not support audio encoded transform");if(c_.has(t)||!t.track)return;const n={track:t.track};if(Ao()){if(!t.createEncodedStreams)return void m.warning("browser not support createEncodedStreams() API");let r=null;try{r=t.createEncodedStreams()}catch(o){return void m.error("create audio-encoded-streams error",o&&o.message)}const s=new TransformStream({transform(o,a){n.controller||(n.controller=a),t.track&&t.track.id!==n.track.id&&(m.debug("audio track changed: ".concat(n.track.id," => ").concat(t.track.id)),n.track.removeEventListener("ended",i),n.track=t.track,n.track.addEventListener("ended",i));const c=e.metadata&&e.metadata();c?(function(d,l){const{chunk:h,controller:p}=l,f=ca.METADATA;h.data=(function(v,S,T){const b=T.byteLength,w=b+LS+RD,D=DS+PS+w,k=new ArrayBuffer(v.byteLength+D),U=new DataView(k);U.setUint8(0,TD),U.setUint16(1,w),U.setUint8(3,S),U.setUint16(4,b);for(let x=0;x<b;x++)U.setUint8(6+x,T[x]);const P=new Uint8Array(U.buffer);return P.set(new Uint8Array(v),D),P.buffer})(h.data,f,d),p.enqueue(h)})(c,{chunk:o,controller:a}):a.enqueue(o)}});r.readable.pipeThrough(s).pipeTo(r.writable)}else if(Mn()){if(typeof RTCRtpScriptTransform>"u")return void m.warning("browser not support RTCRtpScriptTransform");const r=a_(),s=new MessageChannel;await new st((a=>r.onmessage=c=>{c.data==="registered"&&a(void 0)}));const o=new RTCRtpScriptTransform(r,{name:"audio-metadata-tx",port:s.port2},[s.port2]);t.transform=o,await new st((a=>r.onmessage=c=>{c.data==="started"&&a(void 0)})),s.port1.onmessage=a=>{var c;if(a.data.transformed&&t.track&&((c=t.track)===null||c===void 0?void 0:c.id)!==n.track.id)m.debug("audio track changed: ".concat(n.track.id," => ").concat(t.track.id)),n.track.removeEventListener("ended",i),n.track=t.track,n.track.addEventListener("ended",i);else if(a.data.getMetadata){const d=e.metadata&&e.metadata();d&&s.port1.postMessage({metadata:d})}},n.worker=r}function i(){if(t.track){if(this.id!==t.track.id)return;t.track.removeEventListener("ended",i)}const r=c_.get(t);if(r){c_.delete(t);try{var s,o;(s=r.controller)===null||s===void 0||s.terminate(),(o=r.worker)===null||o===void 0||o.terminate()}catch(a){m.warning(a&&a.message)}}}c_.set(t,n),t.track.addEventListener("ended",i)},interceptRemoteAudioFrame:async function(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(!Jt().supportWebRTCEncodedTransform)return void m.warning("browser not support audio encoded transform");if(__.has(t))return;const n={track:t.track,onMetadata:e.onMetadata,onPts:e.onPts};if(Ao()&&!si()){if(!t.createEncodedStreams)return void m.warning("browser not support createEncodedStreams() API");Gg(he.CHROME,87,116)||(e.enableTopn=!1);let r=null;try{r=t.createEncodedStreams()}catch(o){return void m.error("create audio-encoded-streams error",o&&o.message)}const s=new TransformStream({transform(o,a){n.controller||(n.controller=a),t.track&&t.track.id!==n.track.id&&(m.debug("audio track changed: ".concat(n.track.id," => ").concat(t.track.id)),n.track.removeEventListener("ended",i),n.track=t.track,n.track.addEventListener("ended",i)),e.enableTopn?(function(c,d,l){var h;const p=kS(new DataView(d.data));if(!p)return l.enqueue(d);const f=c.track.id;V8.set(f,c.track);const v=(h=p.tlv.find((k=>k.tag===ca.AUDIO_LEVEL)))===null||h===void 0?void 0:h.value;let S=0;typeof v=="number"&&(S=127-v);const T=Math.round(Math.pow(10,S/60)-1),{selected:b,speaker:w}=(function(k,U){let P=Md.get(k);if(P||(P=(function(x){const q=new CD;return Md.set(x,q),vs||(vs=new U8(I("TOPN_SILENCE_THRESHOLD")||500),vs.on("ActiveSpeakerChanged",(Q=>{Q!=null&&(u_=Q)}))),vs.addSpeakers([q]),q})(k)),Md.size<=yD)return{selected:!0,speaker:P};if(!vs)throw new Error("no active speaker detector");return vs.levelChanged(P.id,U),dc=vs.loudest.map((x=>x.id)),u_&&!$(dc).call(dc,u_)&&dc.length>=yD&&dc.pop(),{selected:$(dc).call(dc,P.id)||P.id===u_,speaker:P}})(c,T),D=(function(k,U,P){const x=Cs.get(k)||new x8(k,U);return x.score=P,Cs.set(k,x),(function(q){if(h_.set(q,!0),!p_)return void(p_=Date.now());const Q=Date.now();Q-p_>1e3&&(h_.get(q)?h_.set(q,!1):(ID(q),h_.delete(q)),p_=Q)})(k),x})(f,c.track,w.energyScore);D.addSample(b),D.active&&(d.data=p.frame.buffer,l.enqueue(d))})(t,o,a):e.enableMetadata||e.enablePts?(function(c,d,l,h){const p=new DataView(c.data),f=p.getUint8(0);let v;if((128&f)!=0&&f!==71){const b=(function(w){if(w.byteLength<=0)return[];const D=[];let k=0;for(;k<w.byteLength;){const P=(128&w.getUint8(k))>>7,x=127&w.getUint8(k);if(!(P&&k+4<=w.byteLength)){k++;break}{const q=w.getUint32(k,!1),Q=(16776192&q)>>10,dt=1023&q;D.push({pt:x,ts_offset:Q,length:dt,data:new Uint8Array}),k+=4}}let U=w.byteLength-k;for(const P of D){if(P.length>U)return console.warn("Broken red payload"),[];P.length>0&&(P.data=new Uint8Array(w.buffer,w.byteOffset+k,P.length),k+=P.length,U-=P.length)}if(U>0){const P={pt:D.length>0?D[D.length-1].pt:0,ts_offset:0,length:U,data:new Uint8Array(w.buffer,w.byteOffset+k,U)};D.push(P)}return D})(p);if(b.length>0){const w=(function(D){let k=0;for(let x=0;x<D.length;x++)k+=x<D.length-1?4:1,k+=D[x].length;const U=new Uint8Array(k);let P=0;for(let x=0;x<D.length;x++)if(x<D.length-1){const q=(2147483648|(127&D[x].pt)<<24|(262143&D[x].ts_offset)<<10|1023&D[x].length)>>>0;U[P++]=q>>24&255,U[P++]=q>>16&255,U[P++]=q>>8&255,U[P++]=255&q}else U[P++]=127&D[x].pt;for(const x of D)U.set(x.data,P),P+=x.length;return U})(b.map((D=>{const k=new Uint8Array(D.length);k.set(D.data);const U=kS(new DataView(k.buffer));return U!=null&&U.frame&&(D.data=U?.frame),v=U,D})));c.data=w.buffer}}else v=kS(p),v&&(c.data=v.frame.buffer);if(d.enqueue(c),!v)return;const S=v.tlv.find((b=>b.tag===ca.METADATA));S&&l&&S.value instanceof Uint8Array&&l(S.value);const T=v.tlv.find((b=>b.tag===ca.AUDIO_64_BIT_PTS));T&&h&&T.value instanceof Uint8Array&&T.value.length==8&&h(new DataView(T.value.buffer).getBigUint64(0,!0))})(o,a,e.onMetadata,e.onPts):a.enqueue(o)}});r.readable.pipeThrough(s).pipeTo(r.writable)}else{if(typeof RTCRtpScriptTransform>"u")return void m.warning("browser not support RTCRtpScriptTransform");const r=a_(),s=new MessageChannel;await new st((a=>r.onmessage=c=>{c.data==="registered"&&a(void 0)}));const o=new RTCRtpScriptTransform(r,{name:"audio-metadata-rx",port:s.port2},[s.port2]);t.transform=o,await new st((a=>r.onmessage=c=>{c.data==="started"&&a(void 0)})),s.port1.onmessage=a=>{var c;a.data.transformed&&t.track&&((c=t.track)===null||c===void 0?void 0:c.id)!==n.track.id?(m.debug("audio track changed: ".concat(n.track.id," => ").concat(t.track.id)),n.track.removeEventListener("ended",i),n.track=t.track,n.track.addEventListener("ended",i)):a.data.metadata&&n.onMetadata?n.onMetadata(a.data.metadata):a.data.pts&&n.onPts&&n.onPts(a.data.pts)},n.worker=r}function i(){t.track.removeEventListener("ended",i),(function(r){const s=__.get(r);if(s){(function(c){const d=Md.get(c);d&&(Md.delete(c),vs&&(vs.removeSpeakers([d]),Md.size===0&&(vs.destroy(),vs=null)))})(r),ID(r.track.id),__.delete(r);try{var o,a;(o=s.controller)===null||o===void 0||o.terminate(),(a=s.worker)===null||a===void 0||a.terminate()}catch(c){m.warning(c&&c.message)}}})(t)}__.set(t,n),t.track.addEventListener("ended",i)},interceptLocalVideoFrame:async function(t,e){if(!Jt().supportWebRTCEncodedTransform)return void m.warning("browser not support video encoded transform");if(f_.has(t)||!t.track)return;const n={track:t.track};if(Ao()){if(!t.createEncodedStreams)return void m.warning("browser not support createEncodedStreams() API");let r=null;try{r=t.createEncodedStreams()}catch(a){return void m.error("create video-encoded-streams error",a&&a.message)}const s=[];e.on("sei-to-send",(a=>{s.push(a)}));const o=new TransformStream({transform(a,c){n.controller||(n.controller=c),t.track&&t.track.id!==n.track.id&&(m.debug("video track changed: ".concat(n.track.id," => ").concat(t.track.id)),n.track.removeEventListener("ended",i),n.track=t.track,n.track.addEventListener("ended",i));const d=wD(new Uint8Array(a.data)),l=s.shift();if(l){const h=(function(p,f,v){switch(v){case VS:return(function(S,T){const b=AD(T),w=b.length,D=Math.floor(w/255),k=w%255,U=new Uint8Array(6+D+1+w+S.byteLength);U[0]=0,U[1]=0,U[2]=0,U[3]=1,U[4]=6,U[5]=101;let P=0;for(;P<D;)U[6+P]=255,P++;return U[6+P]=k,P++,U.set(b,6+P),U.set(new Uint8Array(S),6+P+w),U.buffer})(p,f);case FS:return(function(S,T){const b=AD(T),w=b.length,D=Math.floor(w/255),k=w%255,U=new Uint8Array(7+D+1+w+1+S.byteLength);U[0]=0,U[1]=0,U[2]=0,U[3]=1,U[4]=78,U[5]=1,U[6]=101;let P=0;for(;P<D;)U[7+P]=255,P++;return U[7+P]=k,P++,U.set(b,7+P),P+=w,U[7+P]=128,P++,U.set(new Uint8Array(S),7+P),U.buffer})(p,f);default:return null}})(a.data,l,d);h&&(a.data=h)}c.enqueue(a)}});r.readable.pipeThrough(o).pipeTo(r.writable)}else{if(!Mn())return;{if(typeof RTCRtpScriptTransform>"u")return void m.warning("browser not support RTCRtpScriptTransform");const r=a_(),s=new MessageChannel;await new st((a=>r.onmessage=c=>{c.data==="registered"&&a(void 0)}));const o=new RTCRtpScriptTransform(r,{name:"sei-tx",port:s.port2},[s.port2]);t.transform=o,await new st((a=>r.onmessage=c=>{c.data==="started"&&a(void 0)})),e.on("sei-to-send",(a=>{s.port1.postMessage({sei:a})})),s.port1.onmessage=a=>{var c;a.data.transformed&&t.track&&((c=t.track)===null||c===void 0?void 0:c.id)!==n.track.id&&(m.debug("video track changed: ".concat(n.track.id," => ").concat(t.track.id)),n.track.removeEventListener("ended",i),n.track=t.track,n.track.addEventListener("ended",i))},n.worker=r}}function i(){if(t.track){if(this.id!==t.track.id)return;t.track.removeEventListener("ended",i)}const r=f_.get(t);if(r){f_.delete(t);try{var s,o;(s=r.controller)===null||s===void 0||s.terminate(),(o=r.worker)===null||o===void 0||o.terminate()}catch(a){m.warning(a&&a.message)}}}f_.set(t,n),t.track.addEventListener("ended",i)},interceptRemoteVideoFrame:async function(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(!Jt().supportWebRTCEncodedTransform)return void m.warning("browser not support video encoded transform");if(!t.track)return;if(hu.has(t)){const r=hu.get(t);return void(r&&(r.onSei=e.onSei))}const n={track:t.track,onSei:e.onSei};if(Ao()){if(!t.createEncodedStreams)return void m.warning("browser not support createEncodedStreams() API");let r=null;try{r=t.createEncodedStreams()}catch(o){return void m.error("create video-encoded-streams error",o&&o.message)}const s=new TransformStream({transform(o,a){if(n.controller||(n.controller=a),!n.firstFrameInfo){var c;const l=o.getMetadata()||{};n.firstFrameInfo=Ue({type:o.type,rtpTimestamp:o.timestamp,payloadType:l.payloadType||0,ssrc:l.synchronizationSource||0,length:o.data.byteLength},"mimeType"in l?{mimeType:l.mimeType}:{}),(c=e.onFirstFrame)===null||c===void 0||c.call(e,n.firstFrameInfo)}t.track&&t.track.id!==n.track.id&&(m.debug("video track changed: ".concat(n.track.id," => ").concat(t.track.id)),n.track.removeEventListener("ended",i),n.track=t.track,n.track.addEventListener("ended",i));const d=(function(l,h){switch(h){case VS:return(function(p){const f=new DataView(p.data);let v=0;for(;v+4<p.data.byteLength;){if(f.getUint8(v+0)===0&&f.getUint8(v+1)===0&&f.getUint8(v+2)===0&&f.getUint8(v+3)===1&&f.getUint8(v+4)===6){let S=v+6,T=0,b=0;for(;(b=f.getUint8(S++))===255;)T+=255;T+=b;const w=bD(p.data,S,T);return new Uint8Array(w)}v++}return null})(l);case FS:return(function(p){const f=new DataView(p.data);let v=0;for(;v+5<p.data.byteLength;){if(f.getUint8(v+0)===0&&f.getUint8(v+1)===0&&f.getUint8(v+2)===0&&f.getUint8(v+3)===1&&f.getUint8(v+4)===78&&f.getUint8(v+5)===1&&f.getUint8(v+6)===101){let S=v+7,T=0,b=0;for(;(b=f.getUint8(S++))===255;)T+=255;T+=b;const w=bD(p.data,S,T);return new Uint8Array(w)}v++}return null})(l);default:return null}})(o,wD(new Uint8Array(o.data)));d&&n.onSei&&n.onSei(d),a.enqueue(o)}});r.readable.pipeThrough(s).pipeTo(r.writable)}else if(Mn()){if(typeof RTCRtpScriptTransform>"u")return void m.warning("browser not support RTCRtpScriptTransform");const r=a_(),s=new MessageChannel;await new st((a=>r.onmessage=c=>{c.data==="registered"&&a(void 0)}));const o=new RTCRtpScriptTransform(r,{name:"sei-rx",port:s.port2},[s.port2]);t.transform=o,await new st((a=>r.onmessage=c=>{c.data==="started"&&a(void 0)})),s.port1.onmessage=a=>{var c;if(a.data.transformed&&t.track&&((c=t.track)===null||c===void 0?void 0:c.id)!==n.track.id)m.debug("video track changed: ".concat(n.track.id," => ").concat(t.track.id)),n.track.removeEventListener("ended",i),n.track=t.track,n.track.addEventListener("ended",i);else if(a.data.sei&&n.onSei)n.onSei(a.data.sei);else if(a.data.firstFrameInfo&&e.onFirstFrame){var d;(d=e.onFirstFrame)===null||d===void 0||d.call(e,a.data.firstFrameInfo)}},n.worker=r}function i(){if(t.track){if(this.id!==t.track.id)return;t.track.removeEventListener("ended",i)}(function(r){const s=hu.get(r);if(s){hu.delete(r);try{var o,a;(o=s.controller)===null||o===void 0||o.terminate(),(a=s.worker)===null||a===void 0||a.terminate()}catch(c){m.warning(c&&c.message)}}})(t)}hu.set(t,n),t.track.addEventListener("ended",i)}},cX={name:"InterceptFrame",create:()=>aX};var oe;function OM(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable}))),n.push.apply(n,i)}return n}function Ps(t){for(var e=1;e<arguments.length;e++){var n=arguments[e]!=null?arguments[e]:{};e%2?OM(Object(n),!0).forEach((function(i){R(t,i,n[i])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):OM(Object(n)).forEach((function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(n,i))}))}return t}let dX=(oe=class dl extends R_{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get dtlsTransportState(){var e,n;return(e=(n=this.peerConnection.getReceivers()[0])===null||n===void 0||(n=n.transport)===null||n===void 0?void 0:n.state)!==null&&e!==void 0?e:null}get localCodecs(){return[...new Set(this.localCapabilities&&this.localCapabilities.send.videoCodecs.map((e=>e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"")).filter((e=>{var n;return $(n=Object.keys(ic)).call(n,e)})))]}constructor(e,n,i){super(e,n),R(this,"id",Se(5,"connection-")),R(this,"store",void 0),R(this,"peerConnection",void 0),R(this,"forceTurn",!1),R(this,"remoteSDP",void 0),R(this,"initialOffer",void 0),R(this,"transportEventReceiver",void 0),R(this,"statsFilter",void 0),R(this,"extension",{useXR:I("USE_XR")}),R(this,"localCapabilities",void 0),R(this,"remoteCodecs",void 0),R(this,"localCandidateCount",0),R(this,"allCandidatesReceived",!1),R(this,"isPreallocation",!1),R(this,"preMediaMap",new Map),R(this,"dataStreamChannelMap",new Map),R(this,"establishPromise",void 0),R(this,"recoveredDataChannelIds",[]),R(this,"currentDataChannelId",1),R(this,"supportAV1RtpSpec",!1),R(this,"mutex",void 0),R(this,"qualityLimitationReason",Cd.NONE),R(this,"isFirstConnected",!1),this.store=n,this.forceTurn=vT(e),this.mutex=new Un("NVConnectionExtension-mutex",n.clientId),this.peerConnection=i,this.isFirstConnected=!1,this.statsFilter=Xp(this.peerConnection,I("STATS_UPDATE_INTERVAL"),void 0,xe()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1,e.isPreallocation&&(this.isPreallocation=!0),this.establishPromise=this.establish()}getPreMedia(e){return this.preMediaMap.get(e)}isPreSub(){return this.preMediaMap.size>0}async updateRemoteRTPCapabilities(e,n){if(this.remoteCodecs=n,!this.remoteSDP)return void m.debug("[NVConnectionExtension] cannot updateRemoteRTPCapabilities before remote SDP created, local codecs: ".concat(this.localCodecs,", codecs: ").concat(n));if(this.remoteSDP.updateRemoteCodec(e,n,this.store.codec)){const i=await this.peerConnection.createOffer(),r=this.logSDPExchange(i.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(i);const s=this.remoteSDP.toString();r?.(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}else m.debug("[NVConnectionExtension] updateRemoteRTPCapabilities no need to exchange SDP.")}async establish(){try{this.peerConnection.addTransceiver("video",{direction:"recvonly"}),this.peerConnection.addTransceiver("audio",{direction:"recvonly"});const n=await this.peerConnection.createOffer();if(!n.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const i=no(n.sdp),r=await rT({filterRTX:!I("USE_PUB_RTX")&&!I("USE_SUB_RTX"),filterVideoFec:I("FILTER_VIDEO_FEC"),filterAudioFec:I("FILTER_AUDIO_FEC"),filterVideoCodec:I("FILTER_VIDEO_CODEC"),unsupportedVideoUplinkCodec:I("UNSUPPORTED_VIDEO_UPLINK_CODEC"),unsupportedVideoDownlinkCodec:I("UNSUPPORTED_VIDEO_DOWNLINK_CODEC")},this.extension);if(this.localCapabilities=gu(r),this.initialOffer=n,I("ENABLE_SVC")&&this.store.codec=="av1"){const o=await nP();var e;o&&(this.supportAV1RtpSpec=!0,(e=r.send)===null||e===void 0||e.videoExtensions.push(o))}let s;return n.sdp&&w_(n.sdp)&&(s=Ve(r),zD(s)),Ps(Ps({},i),{},{rtpCapabilities:s||r,offerSDP:n.sdp})}catch(n){throw new H(A.GET_LOCAL_CONNECTION_PARAMS_FAILED,n.toString())}}async connect(e){try{if(!this.initialOffer)throw new Error("Cannot establish NVConnectionExtension without initial offer.");this.initialOffer.sdp&&w_(this.initialOffer.sdp)&&XD(e.rtpCapabilities,this.localCapabilities),this.remoteSDP=new AP(Ps(Ps({},e),{},{localCapabilities:this.localCapabilities}),this.supportAV1RtpSpec,!(!I("ENABLE_PRE_SUB_WITH_PRE_PC")||!I("PRE_USE_LOCAL_CODECS"))&&du(this.store),!0),e.preallocation&&(this.isPreallocation=!0),Array.isArray(this.remoteCodecs)&&this.remoteCodecs.length>0&&this.remoteSDP.updateRemoteCodec([],this.remoteCodecs,this.store.codec);const n=this.remoteSDP.toString(),i=sT(this.initialOffer.sdp,this.extension),r=this.logSDPExchange(i||"","offer","local","connect");this.store.descriptionStart(),await this.peerConnection.setLocalDescription({type:"offer",sdp:i}),r?.(n),await this.peerConnection.setRemoteDescription({type:"answer",sdp:n});const s=this.peerConnection.getTransceivers()[0];if(s!=null&&s.receiver&&this.tryBindTransportEvents(s.receiver),du(this.store))if(e.preallocation&&I("ENABLE_PRE_SUB_WITH_PRE_PC")){const o=I("PRE_SUB_NUM"),{mids:a,preSSRCs:c}=this.remoteSDP.preloadRemoteMedia(o);await Ui(this.peerConnection,this.remoteSDP,this.extension),m.debug("[".concat(this.store.clientId,"] [NVConnectionExtension] preload media, in pre pc,add preload ssrcs ").concat(c)),this.presetMedia(a,c)}else{const{preSSRCs:o=[]}=e,a=o.map((d=>d.ssrcMsg[0].ssrcId));if(o.length===0)return;const{mids:c}=this.remoteSDP.batchSend(o.map((d=>Object.assign({},d))));await Ui(this.peerConnection,this.remoteSDP,this.extension),m.debug("[NVConnectionExtension.connect] preload media, after join, add preload ssrcs ".concat(a)),this.presetMedia(c,a)}}catch(n){throw new H(A.EXCHANGE_SDP_FAILED,"NVConnectionExtension.connect failed; ".concat(n.toString()))}}presetMedia(e,n){e.forEach(((i,r)=>{this.peerConnection.getTransceivers().forEach((s=>{if(s.mid!=null&&i===s.mid&&s.receiver.track){const o=s.receiver.track;let a;o.kind==="video"&&I("ENABLE_PRE_RENDER")&&(a=new s_({trackId:"track-".concat(o.kind,"-unknown-").concat(this.store.clientId,"_").concat(Se(5,""))},!0),a.updateVideoTrack(o),a.onFirstVideoFrameRender=()=>{var c;const d=this.preMediaMap.get(n[r]);d&&(d.firstVideoRender=Date.now()),(c=this.onFirstVideoRender)===null||c===void 0||c.call(this,n[r])},a.onVideoBufferReady=()=>{var c;(c=this.onFirstVideoBufferReady)===null||c===void 0||c.call(this,n[r])},a.play(this.store.sessionId||void 0)),this.preMediaMap.set(n[r],{mid:i,track:o,player:a,transceiver:s})}})),this.store.peerReceiver()}))}checkDtlsParameters(e){return!!this.remoteSDP&&e.length>0&&this.remoteSDP.updateRemoteDtlsParameters(e)}async updateRemoteConnect(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVConnectionExtension.updateRemoteConnect before remote SDP created");let n=!1;const{rtpCapabilities:i}=e;if([,n]=this.remoteSDP.updateRemoteRTPCapabilities(i),Array.isArray(this.remoteCodecs)&&this.remoteCodecs.length>0){const o=this.remoteSDP.updateRemoteCodec([],this.remoteCodecs,this.store.codec);n=n||o}const{preSSRCs:r=[]}=e,s=r.map((o=>o.ssrcMsg[0].ssrcId));if(!this.remoteSDP.checkPreloadSsrcs(s)){const o=[],a=[];if(Array.from(this.preMediaMap.entries()).every((c=>{let[d,{mid:l,player:h,track:p}]=c;return o.push(l),a.push(d),this.preMediaMap.delete(d),h&&h.destroy(),!0})),o.length>0&&(this.remoteSDP.stopSending(o),await Ui(this.peerConnection,this.remoteSDP,this.extension),m.warn("[NVConnectionExtension.updateRemoteConnect] preload media, failed, del preload ssrcs ".concat(a)),pt.reportApiInvoke(this.store.sessionId,{name:Ge.PRELOAD_MEDIA_FAILED,options:[r,a],tag:Ne.TRACER}).onSuccess()),r.length>0){const{mids:c}=this.remoteSDP.batchSend(r.map((d=>Object.assign({},d))));await Ui(this.peerConnection,this.remoteSDP,this.extension),m.debug("[NVConnectionExtension.updateRemoteConnect] preload media, after join, add preload ssrcs ".concat(s)),this.presetMedia(c,s)}}n?(await Ui(this.peerConnection,this.remoteSDP,this.extension),m.debug("[NVConnectionExtension] updateRemoteConnect by exchanging SDP.")):m.debug("[NVConnectionExtension] updateRemoteConnect no need to exchange SDP, because no need to update remote codecs (use local codecs)")}catch(n){throw new H(A.EXCHANGE_SDP_FAILED,"NVConnectionExtension.updateRemoteConnect failed; ".concat(n.toString()))}}send(e,n,i){var r=this;return Ci((function*(){const s=yield Ht(r.mutex.lock("From NVConnectionExtension.send"));try{if(!r.remoteSDP)throw new Error("Cannot call NVConnectionExtension.send before remote SDP created");const o=[],a=fu();e.forEach((T=>{const b=r.peerConnection.addTransceiver(T._mediaStreamTrack,Ps({direction:"sendonly"},T.trackMediaType==="video"&&r.supportAV1RtpSpec&&a?{sendEncodings:[{scalabilityMode:a}]}:{}));o.push(b),T._updateRtpTransceiver(b)})),xe()&&I("SIMULCAST")===!0&&(yield Ht(r.applySimulcastForFirefox(o,e)));const c=yield Ht(r.peerConnection.createOffer()),d=r.remoteSDP.predictReceivingMids(e.length),l=r.mungSendOfferSDP(c.sdp,e,d),h=Ei(l),p=d.map((T=>{const b=h.mediaDescriptions.find((w=>w.attributes.mid===T));if(!b)throw new Error("Cannot extract ssrc from mediaDescription.");return tT(b,I("USE_PUB_RTX"))}));let f;try{f=yield p}catch(T){f=[],r.remoteSDP.receive(e,n,i,f);const b=r.remoteSDP.toString();throw yield Ht(r.peerConnection.setLocalDescription({type:"offer",sdp:l})),yield Ht(r.peerConnection.setRemoteDescription({type:"answer",sdp:b})),yield Ht(r.stopSending(d,!0)),T}r.remoteSDP.receive(e,n,i,f);const v=r.remoteSDP.toString(),S=r.logSDPExchange(l,"offer","local","send");return yield Ht(r.peerConnection.setLocalDescription({type:"offer",sdp:l})),yield Ht(r.applySimulcastEncodings(o,e)),yield Ht(r.applySendEncodings(o,e)),S?.(v),yield Ht(r.peerConnection.setRemoteDescription({type:"answer",sdp:v})),o.map(((T,b)=>{const w=d[b];return{localSSRC:p[b],id:w,transceiver:T}}))}catch(o){throw o instanceof H?o:new H(A.EXCHANGE_SDP_FAILED,"NVConnectionExtension.send failed; ".concat(o.toString()))}finally{s()}}))()}async createDataChannels(e,n){try{if(!this.remoteSDP)throw new Error("Cannot call NVConnectionExtension.createDataChannels before remote SDP created");let i=this.dataStreamChannelMap.get(e);if(i&&i.readyState==="open")m.debug("[NVConnectionExtension] Channels are already available and can be reused directly.");else{const s=this.currentDataChannelId<1023?this.currentDataChannelId++:this.recoveredDataChannelIds.shift();if(typeof s!="number")throw new Error("create DataChannel error, because cannot get dc id");i=this.peerConnection.createDataChannel("datastream-channel",{id:s,negotiated:!0,ordered:!1,maxRetransmits:I("DATASTREAM_MAX_RETRANSMITS")}),i.binaryType="arraybuffer",this.dataStreamChannelMap.set(e,i)}n.forEach((s=>{s._updateOriginDataChannel(i)}));const{needExchangeSDP:r}=this.remoteSDP.sendDataChannel();if(r){const s=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:s});const o=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(o),m.debug("[NVConnectionExtension] createDataChannels by exchanging SDP.")}else m.debug("[NVConnectionExtension] createDataChannels no need to exchange SDP.");return}catch(i){throw i instanceof H?i:new H(A.EXCHANGE_SDP_FAILED,"NVConnectionExtension.createDataChannels failed; ".concat(i.toString()))}}async stopDataChannels(e){try{const n=this.dataStreamChannelMap.get(e);return n&&(n.id&&this.recoveredDataChannelIds.push(n.id),n.close()),void this.dataStreamChannelMap.delete(e)}catch(n){throw n instanceof H?n:new H(A.DATACHANNEL_FAILED,"NVConnectionExtension.stopDataChannels failed; ".concat(n.toString()))}}async stopSending(e,n){const i=n?void 0:await this.mutex.lock("From NVConnectionExtension.stopSending");try{if(!this.remoteSDP)throw new Error("Cannot call NVConnectionExtension.stopSending before remote SDP created");const r=this.peerConnection.getTransceivers().filter((c=>e.indexOf(c.mid)!==-1));if(r.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length when trying to call NVConnectionExtension.stopSending.");r.map((c=>{var d;Yd(this.id+c.mid,this),c.direction="inactive",(d=c.stop)===null||d===void 0||d.call(c)}));const s=await this.peerConnection.createOffer(),o=this.logSDPExchange(s.sdp||"","offer","local","stopSending");await this.peerConnection.setLocalDescription(s),this.remoteSDP.stopReceiving(e);const a=this.remoteSDP.toString();o?.(a),await this.peerConnection.setRemoteDescription({type:"answer",sdp:a})}catch(r){throw new H(A.EXCHANGE_SDP_FAILED,"NVConnectionExtension.stopSending failed; ".concat(r.toString()))}finally{i&&i()}}async receive(e,n,i,r){try{if(!this.remoteSDP)throw new Error("Cannot call NVConnectionExtension.receive ".concat(e," before remoteSDP created."));const{mid:s,needExchangeSDP:o}=this.remoteSDP.send(e,n,i,r);o&&(await Ui(this.peerConnection,this.remoteSDP,this.extension),m.debug("[".concat(this.store.clientId,"] [NVConnectionExtension] receive ").concat(e," by exchanging SDP.")));const a=this.peerConnection.getTransceivers().find((c=>c.mid===s));if(!a)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:a.receiver.track,id:s,transceiver:a}}catch(s){throw new H(A.EXCHANGE_SDP_FAILED,"NVConnectionExtension.receive failed; ".concat(s.toString()))}}async batchReceive(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVConnectionExtension.batchReceive before remoteSDP created.");const{mids:n,needExchangeSDP:i}=this.remoteSDP.batchSend(e);return i&&(await Ui(this.peerConnection,this.remoteSDP,this.extension),m.debug("[".concat(this.store.clientId,"] [NVConnectionExtension] batchReceive by exchanging SDP."))),n.map((r=>{const s=this.peerConnection.getTransceivers().find((o=>o.mid===r));if(!s)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:s.receiver.track,id:r,transceiver:s}}))}catch(n){throw new H(A.EXCHANGE_SDP_FAILED,"NVConnectionExtension.receive failed; ".concat(n.toString()))}}async stopReceiving(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVConnectionExtension.stopReceiving before remote SDP created.");e.forEach((s=>{Array.from(this.preMediaMap.entries()).some((o=>{let[a,{mid:c,player:d}]=o;if(c===s)return this.preMediaMap.delete(a),d&&d.destroy(),!0}))})),this.remoteSDP.stopSending(e);const n=this.remoteSDP.toString(),i=this.logSDPExchange(n,"offer","remote","stopReceiving");await this.peerConnection.setRemoteDescription({type:"offer",sdp:n});const r=await this.peerConnection.createAnswer();i?.(r.sdp||""),await this.peerConnection.setLocalDescription(r)}catch(n){throw new H(A.EXCHANGE_SDP_FAILED,"NVConnectionExtension stopReceiving failed; ".concat(n.toString()))}}async muteRemote(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVConnectionExtension.muteRemote mid=".concat(e," before remote SDP created."));this.remoteSDP.mute(e);const n=this.remoteSDP.toString(),i=this.logSDPExchange(n,"offer","remote","muteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:n});const r=await this.peerConnection.createAnswer();i?.(r.sdp||""),await this.peerConnection.setLocalDescription(r)}catch(n){throw new H(A.EXCHANGE_SDP_FAILED,"NVConnectionExtension.muteRemote failed; ".concat(n.toString()))}}async unmuteRemote(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVConnectionExtension.unmuteRemote mid=".concat(e," before remote SDP created."));this.remoteSDP.unmute(e);const n=this.remoteSDP.toString(),i=this.logSDPExchange(n,"offer","remote","unmuteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:n});const r=await this.peerConnection.createAnswer();i?.(r.sdp||""),await this.peerConnection.setLocalDescription(r)}catch(n){throw new H(A.EXCHANGE_SDP_FAILED,"NVConnectionExtension.unmuteRemote failed; ".concat(n.toString()))}}async muteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVConnectionExtension.muteLocal before remote SDP created.");const n=this.peerConnection.getTransceivers().filter((o=>o.mid&&e.indexOf(o.mid)!==-1));if(n.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");n.map((o=>{o.direction="inactive"}));const i=await this.peerConnection.createOffer(),r=this.logSDPExchange(i.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(i),this.remoteSDP.muteRemote(e);const s=this.remoteSDP.toString();r?.(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(n){throw new H(A.EXCHANGE_SDP_FAILED,"NVConnectionExtension.muteLocal failed; ".concat(n.toString()))}}async unmuteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVConnectionExtension.unmuteLocal before remote SDP created.");const n=this.peerConnection.getTransceivers().filter((o=>o.mid&&e.indexOf(o.mid)!==-1));if(n.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");n.map((async(o,a)=>{o.direction="sendonly"}));const i=await this.peerConnection.createOffer(),r=this.logSDPExchange(i.sdp||"","offer","local","unmuteLocal");await this.peerConnection.setLocalDescription(i),this.remoteSDP.unmuteRemote(e),Array.isArray(this.remoteCodecs)&&this.remoteCodecs.length>0&&this.remoteSDP.updateRemoteCodec(e,this.remoteCodecs,this.store.codec);const s=this.remoteSDP.toString();r?.(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(n){throw new H(A.EXCHANGE_SDP_FAILED,"NVConnectionExtension.unmuteLocal failed; ".concat(n.toString()))}}restartICE(e){var n=this;return Ci((function*(){const i=yield Ht(n.mutex.lock("From NVConnectionExtension.restartICE"));try{if(!n.remoteSDP)throw new Error("Cannot restartICE before remoteSDP created.");const r=Jt().supportPCSetConfiguration,s=I("FORCE_TURN_TCP")||n.forceTurn;if(e===xn.RELAY&&!r)return;if(r&&!s){const h=e===xn.RELAY?"relay":"all",p=n.peerConnection.getConfiguration();p.iceTransportPolicy!==h&&(m.debug("[".concat(n.store.clientId,"] restartICE change iceTransportPolicy from [").concat(p.iceTransportPolicy,"] to [").concat(h,"]")),p.iceTransportPolicy=h,n.peerConnection.setConfiguration(p))}n.remoteSDP.updateCandidates(e);const o=yield Ht(n.peerConnection.createOffer({iceRestart:!0}));if(!o.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const a=no(o.sdp),{remoteIceParameters:c}=yield a.iceParameters;n.remoteSDP.restartICE(c);const d=n.remoteSDP.toString(),l=n.logSDPExchange(o.sdp||"","offer","local","restartICE");n.store.descriptionStart(),yield Ht(n.peerConnection.setLocalDescription(o)),l?.(d),yield Ht(n.peerConnection.setRemoteDescription({type:"answer",sdp:d}))}catch(r){m.warning("[".concat(n.store.clientId,"] restart ICE failed, abort operation"),r)}finally{i()}}))()}async extendCandidate(){if(!this.remoteSDP||this.isFirstConnected)return;const e=await this.mutex.lock("From NVConnectionExtension.extendCandidate");try{this.remoteSDP.updateCandidates(xn.TCP_RELAY),await Ui(this.peerConnection,this.remoteSDP,this.extension)}catch(n){m.warning("[".concat(this.store.clientId,"] extend candidate failed, abort operation"),n)}finally{e()}}close(){var e;this.peerConnection.getTransceivers().forEach((n=>{Yd(this.id+n.mid,this)})),this.preMediaMap.forEach((n=>{let{player:i}=n;i&&i.destroy()})),this.preMediaMap.clear(),this.peerConnection.close(),(e=this.onConnectionStateChange)===null||e===void 0||e.call(this,"closed"),this.tryUnbindTransportEvents(),this.unbindPCEvents(),this.unbindStatsEvents(),this.removeAllListeners(),this.transportEventReceiver=void 0,this.statsFilter.destroy(),this.dataStreamChannelMap.clear(),this.recoveredDataChannelIds=[],this.currentDataChannelId=1}getStats(){return Ps(Ps({},this.statsFilter.getStats()),{},{qualityLimitationReason:this.qualityLimitationReason})}getRemoteVideoIsReady(e){return this.statsFilter.getVideoIsReady(e)}async updateEncoderConfig(e,n){try{if(!this.remoteSDP)throw new Error("Cannot call NVConnectionExtension.updateEncoderConfig before remote SDP created.");const i=await this.peerConnection.createOffer(),r=this.mungSendOfferSDP(i.sdp,[n],[e]);this.remoteSDP.updateRecvMedia(e,n);const s=this.remoteSDP.toString(),o=this.logSDPExchange(r,"offer","local","updateEncoderConfig");await this.peerConnection.setLocalDescription({type:"offer",sdp:r}),o?.(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(i){throw new H(A.EXCHANGE_SDP_FAILED,i.toString())}}async updateSendParameters(e,n){const i=this.peerConnection.getTransceivers().filter((r=>r.mid===e));i.length===1&&(this.isVP8Simulcast(n)?xe()||await this.applySimulcastEncodings(i,[n]):await this.applySendEncodings(i,[n]))}setStatsRemoteVideoIsReady(e,n){this.statsFilter.setVideoIsReady2(e,n)}async replaceTrack(e,n){const i=this.peerConnection.getTransceivers().find((r=>r.mid===n));i&&await i.sender.replaceTrack(e._mediaStreamTrack)}async getSelectedCandidatePair(){const e=this.peerConnection.getReceivers();if(e.length>0&&e[0].transport&&e[0].transport.iceTransport&&e[0].transport.iceTransport.getSelectedCandidatePair&&e[0].transport.iceTransport.getSelectedCandidatePair()){const n=e[0].transport.iceTransport,{local:i,remote:r}=n.getSelectedCandidatePair();return{local:Ps(Ps({},ts),{},{candidateType:i.type,protocol:i.protocol,address:i.address,port:i.port}),remote:Ps(Ps({},ts),{},{candidateType:r.type,protocol:r.protocol,address:r.address,port:r.port})}}return this.statsFilter.getSelectedCandidatePair()}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var e;(e=this.onICEConnectionStateChange)===null||e===void 0||e.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var e;this.peerConnection.connectionState==="connected"&&(this.isFirstConnected=!0),(e=this.onConnectionStateChange)===null||e===void 0||e.call(this,this.peerConnection.connectionState)},this.peerConnection.onicecandidateerror=e=>{if(e&&(e.errorCode||e.errorText)){var n;const i="code: ".concat(e.errorCode,", message: ").concat(e.errorText),r=e.port?"local: ".concat(e.port):"",s=eo(e.url||"");m.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: NVConnectionExtension.onICECandidateError(").concat(i,"), url: ").concat(s||"",", host_candidate:").concat(r)),(n=this.onICECandidateError)===null||n===void 0||n.call(this,i)}},this.peerConnection.onicegatheringstatechange=e=>{e&&e.target&&"iceGatheringState"in e.target&&m.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] RTCPeerConnection.onicegatheringstatechange(").concat(e.target.iceGatheringState,")"))},this.peerConnection.onicecandidate=e=>{e.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,m.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))},setTimeout((()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,m.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount))}),I("CANDIDATE_TIMEOUT"))}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(e){const n={iceServers:[]},i=e.cloudProxyServer||"disabled";return e.iceServers?n.iceServers=e.iceServers:e.turnServer&&(Ja(e.turnServer.servers)?n.iceServers=e.turnServer.servers:I("NEW_TURN_MODE")&&n.iceServers&&i==="disabled"?(I("USE_TURN_SERVER_OF_GATEWAY")?e.turnServer.serversFromGateway&&n.iceServers.push(...dl.newTurnServerConfigToIceServers(e.turnServer.serversFromGateway)):n.iceServers.push(...dl.newTurnServerConfigToIceServers(e.turnServer.servers)),I("NEW_FORCE_TURN")&&(n.iceTransportPolicy="relay")):e.turnServer.mode!=="off"&&(n.iceServers&&n.iceServers.push(...dl.turnServerConfigToIceServers(e.turnServer.servers)),I("USE_TURN_SERVER_OF_GATEWAY")&&n.iceServers&&e.turnServer.serversFromGateway&&n.iceServers.push(...dl.turnServerConfigToIceServers(e.turnServer.serversFromGateway)),I("FORCE_TURN_TCP")?n.iceTransportPolicy="relay":e.turnServer.servers.concat(e.turnServer.serversFromGateway||[]).forEach((r=>{r.forceturn&&(n.iceTransportPolicy="relay")})))),I("ENABLE_ENCODED_TRANSFORM")&&Jt().supportWebRTCEncodedTransform&&(n.encodedInsertableStreams=!0),n}static turnServerConfigToIceServers(e){const n=[];return e.forEach((i=>{i.security?i.tcpport&&n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turns:".concat(ss(i.turnServerURL),":").concat(i.tcpport,"?transport=tcp")}):(i.udpport&&!I("FORCE_TURN_TCP")&&n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":").concat(i.udpport,"?transport=udp")}),i.tcpport&&n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":").concat(i.tcpport,"?transport=tcp")}))})),n}static newTurnServerConfigToIceServers(e){const n=[];return e.forEach((i=>{const r=I("NEW_TURN_MODE");r===1?n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":3478?transport=udp")}):r===2?n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":3478?transport=tcp")}):r===3?n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turns:".concat(ss(i.turnServerURL),":443?transport=tcp")}):r===4&&(n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":3478?transport=udp")}),n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":3478?transport=tcp")}),n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turns:".concat(ss(i.turnServerURL),":443?transport=tcp")}))})),n}tryBindTransportEvents(e){const n=e.transport;if(n){this.transportEventReceiver=e,n.onstatechange=()=>{var r;n!=null&&n.state&&((r=this.onDTLSTransportStateChange)===null||r===void 0||r.call(this,n.state))},n.onerror=r=>{var s;(s=this.onDTLSTransportError)===null||s===void 0||s.call(this,"error"in r?r.error:r)};const i=n.iceTransport;i&&(i.onstatechange=()=>{const r=n?.iceTransport.state;var s;r&&((s=this.onICETransportStateChange)===null||s===void 0||s.call(this,r))},i.getSelectedCandidatePair&&(i.onselectedcandidatepairchange=()=>{if(i.getSelectedCandidatePair()){const{local:r,remote:s}=i.getSelectedCandidatePair()||{};if(r&&s){const o=r.address+":"+r.port,a=s.address+":"+s.port;m.info("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] selectedcandidatepairchange: local ").concat(JSON.stringify(eo(o)),", remote ").concat(JSON.stringify(eo(a))))}}}))}}tryUnbindTransportEvents(){this.transportEventReceiver&&this.transportEventReceiver.transport&&(this.transportEventReceiver.transport.onstatechange=null,this.transportEventReceiver.transport.onerror=null,this.transportEventReceiver.transport.iceTransport&&(this.transportEventReceiver.transport.iceTransport.onstatechange=null))}async updateRtpSenderEncodings(e,n){var i,r;if(n||(n=this.peerConnection.getSenders().find((T=>T.track===e._mediaStreamTrack))),!n)return m.warn("[".concat(e.getTrackId(),"] no rtpSender found}"));if(this.isVP8Simulcast(e))return m.warn("[updateRtpSenderEncodings] Track is VP8 simulcast, please apply simulcast encodings");if(!Jt().supportSetRtpSenderParameters)return m.warn("[updateRtpSenderEncodings] Browser not support set rtp-sender parameters");const s={},o={};switch(e._optimizationMode){case"motion":s.degradationPreference="maintain-framerate";break;case"detail":s.degradationPreference="maintain-resolution";break;case"balanced":s.degradationPreference="balanced"}const a=YD(this.peerConnection,e._mediaStreamTrack),c=M0(e);if(LP(e)&&a&&n&&c&&this.getLocalVideoStats&&$(i=["vp8","vp9"]).call(i,this.store.codec)){var d;const S=s.degradationPreference||($(d=e._hints).call(d,Ee.CUSTOM_TRACK)?I("CUSTOM_ADAPTATION_DEFAULT_MODE"):"maintain-framerate");kP(this.id+a.mid,c,this,S,(T=>{n&&this.updateAdaptation(n,T)}),this.getLocalVideoStats.bind(this))}if(e._encoderConfig){var l;const{bitrateMax:S,frameRate:T,scaleResolutionDownBy:b}=e._encoderConfig;S&&(o.maxBitrate=1e3*S),($(l=e._hints).call(l,Ee.LOW_STREAM)||e.isUseScaleResolutionDownBy)&&(T&&(o.maxFramerate=wi(T)),b&&b>=1&&(o.scaleResolutionDownBy=b))}const{maxFramerate:h}=I("ENCODER_CONFIG_LIMIT");if(h&&typeof h=="number"&&(o.maxFramerate=o.maxFramerate?Math.min(o.maxFramerate,h):h),I("DSCP_TYPE")&&Js()){var p;const S=I("DSCP_TYPE");$(p=["very-low","low","medium","high"]).call(p,S)&&(o.networkPriority=S)}const f=n.getParameters(),v=(r=f.encodings)===null||r===void 0?void 0:r[0];xe()&&!v&&(s.encodings=[o]),v&&Object.assign(v,o),Object.assign(f,s),m.debug("[".concat(e.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(f.encodings))),await n.setParameters(f),await sP(this.store.codec,n,I("SVC_MODE"))}async updateAdaptation(e,n){var i,r;if(!e)return m.debug("[updateAdaptation] no rtpSender found");if(!Jt().supportSetRtpSenderParameters)return m.debug("[updateAdaptation] Browser not support set rtp-sender parameters");const s={},{bitrateMax:o,frameRate:a,scaleResolutionDownBy:c}=n;o&&(s.maxBitrate=1e3*o),a&&(s.maxFramerate=wi(a)),c&&c>=1&&$(i=["vp8","vp9"]).call(i,this.store.codec)&&(s.scaleResolutionDownBy=c);const d=e.getParameters(),l=(r=d.encodings)===null||r===void 0?void 0:r[0];l&&Object.assign(l,s),Object.assign(d,{});try{await e.setParameters(d),m.debug("[updateAdaptation] updateRtpSenderEncodings: ".concat(JSON.stringify(d.encodings)))}catch(h){!("transport"in e)||e.transport&&e.transport.state==="connected"?this.peerConnectionState!=="connected"?m.debug("[updateAdaptation] peerConnection not connected}"):m.debug("[updateAdaptation] updateRtpSenderEncodings failed",h):m.debug("[updateAdaptation] rtpSender transport not connected}")}}async applySendEncodings(e,n){try{if(!Jt().supportSetRtpSenderParameters||e.length!==n.length)return;for(let i=0;i<e.length;i++){const r=e[i],s=n[i];s instanceof De&&!this.isVP8Simulcast(s)&&await this.updateRtpSenderEncodings(s,r.sender)}}catch{m.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}}mungSendOfferSDP(e,n,i){const r=Ei(e);return n.forEach(((s,o)=>{const a=i[o],c=r.mediaDescriptions.find((d=>d.attributes.mid===a));c&&(_c(c,s),iT(c,s,this.store.codec))})),Oo(r)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=e=>{var n;(n=this.onFirstAudioReceived)===null||n===void 0||n.call(this,e)},this.statsFilter.onFirstVideoReceived=e=>{var n;(n=this.onFirstVideoReceived)===null||n===void 0||n.call(this,e)},this.statsFilter.onFirstAudioDecoded=e=>{var n;(n=this.onFirstAudioDecoded)===null||n===void 0||n.call(this,e)},this.statsFilter.onFirstVideoDecoded=(e,n,i)=>{var r;(r=this.onFirstVideoDecoded)===null||r===void 0||r.call(this,e,n,i)},this.statsFilter.onSelectedLocalCandidateChanged=(e,n)=>{var i;(i=this.onSelectedLocalCandidateChanged)===null||i===void 0||i.call(this,e,n)},this.statsFilter.onSelectedRemoteCandidateChanged=(e,n)=>{var i;(i=this.onSelectedRemoteCandidateChanged)===null||i===void 0||i.call(this,e,n)},this.statsFilter.onFirstVideoDecodedTimeout=e=>{var n;(n=this.onFirstVideoDecodedTimeout)===null||n===void 0||n.call(this,e)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0,this.statsFilter.onFirstVideoDecodedTimeout=void 0}async applySimulcastForFirefox(e,n){if(e.length===n.length)for(let c=0;c<e.length;c++){var i,r,s,o,a;const d=e[c],l=n[c];if(l instanceof De&&!$(i=l._hints).call(i,Ee.LOW_STREAM)&&(r=l._encoderConfig)!==null&&r!==void 0&&r.bitrateMax&&((s=l._encoderConfig)===null||s===void 0?void 0:s.bitrateMax)>200&&(o=l._scalabilityMode)!==null&&o!==void 0&&o.numSpatialLayers&&((a=l._scalabilityMode)===null||a===void 0?void 0:a.numSpatialLayers)>1&&this.store.codec==="vp8"){const h={},p={high:1e3*(l._encoderConfig.bitrateMax-50),medium:5e4};h.encodings=[{rid:"m",active:!0,maxBitrate:p.medium,scaleResolutionDownBy:4},{rid:"h",active:!0,maxBitrate:p.high}];const f=d.sender.getParameters();await d.sender.setParameters(Object.assign(f,h))}}}async applySimulcastEncodings(e,n){if(!xe()&&e.length===n.length)for(let i=0;i<e.length;i++){const r=n[i];if(r instanceof De&&this.isVP8Simulcast(r)){const s=e[i],o={},a={high:1e3*(r._encoderConfig.bitrateMax-50),medium:5e4};o.encodings=[{active:!0,adaptivePtime:!1,networkPriority:"high",priority:"high",maxBitrate:a.high},{active:!0,adaptivePtime:!1,networkPriority:"low",priority:"low",maxBitrate:a.medium,scaleResolutionDownBy:4}];const c=s.sender.getParameters();await s.sender.setParameters(Object.assign(c,o))}}}isVP8Simulcast(e){var n,i,r,s,o;return!!(e instanceof De&&I("SIMULCAST")&&this.store.codec==="vp8"&&!$(n=e._hints).call(n,Ee.LOW_STREAM)&&(i=e._encoderConfig)!==null&&i!==void 0&&i.bitrateMax&&((r=e._encoderConfig)===null||r===void 0?void 0:r.bitrateMax)>200&&(s=e._scalabilityMode)!==null&&s!==void 0&&s.numSpatialLayers&&((o=e._scalabilityMode)===null||o===void 0?void 0:o.numSpatialLayers)>1)}logSDPExchange(e,n,i,r){if(I("SDP_LOGGING"))return m.upload("[".concat(this.store.clientId,"] exchanging ").concat(i," ").concat(n," SDP during NVConnectionExtension.").concat(r,`
`),e),n==="offer"?s=>{this.logSDPExchange(s,"answer",i==="local"?"remote":"local",r)}:void 0}async getRemoteSSRC(e){if(!this.remoteSDP)return;const n=this.remoteSDP.getSSRC(e);return n&&n.length!==0?n[0].ssrcId:void 0}setConfiguration(e){if(Jt().supportPCSetConfiguration){const n=dl.resolvePCConfiguration(e);this.peerConnection.setConfiguration(n)}e.isPreallocation&&(this.isPreallocation=!0)}},ot(oe.prototype,"updateRemoteRTPCapabilities",[Di],Object.getOwnPropertyDescriptor(oe.prototype,"updateRemoteRTPCapabilities"),oe.prototype),ot(oe.prototype,"connect",[Di],Object.getOwnPropertyDescriptor(oe.prototype,"connect"),oe.prototype),ot(oe.prototype,"updateRemoteConnect",[Di],Object.getOwnPropertyDescriptor(oe.prototype,"updateRemoteConnect"),oe.prototype),ot(oe.prototype,"createDataChannels",[Di],Object.getOwnPropertyDescriptor(oe.prototype,"createDataChannels"),oe.prototype),ot(oe.prototype,"receive",[Di],Object.getOwnPropertyDescriptor(oe.prototype,"receive"),oe.prototype),ot(oe.prototype,"batchReceive",[Di],Object.getOwnPropertyDescriptor(oe.prototype,"batchReceive"),oe.prototype),ot(oe.prototype,"stopReceiving",[Di],Object.getOwnPropertyDescriptor(oe.prototype,"stopReceiving"),oe.prototype),ot(oe.prototype,"muteRemote",[Di],Object.getOwnPropertyDescriptor(oe.prototype,"muteRemote"),oe.prototype),ot(oe.prototype,"unmuteRemote",[Di],Object.getOwnPropertyDescriptor(oe.prototype,"unmuteRemote"),oe.prototype),ot(oe.prototype,"muteLocal",[Di],Object.getOwnPropertyDescriptor(oe.prototype,"muteLocal"),oe.prototype),ot(oe.prototype,"unmuteLocal",[Di],Object.getOwnPropertyDescriptor(oe.prototype,"unmuteLocal"),oe.prototype),ot(oe.prototype,"close",[Di],Object.getOwnPropertyDescriptor(oe.prototype,"close"),oe.prototype),ot(oe.prototype,"updateEncoderConfig",[Di],Object.getOwnPropertyDescriptor(oe.prototype,"updateEncoderConfig"),oe.prototype),ot(oe.prototype,"updateSendParameters",[Di],Object.getOwnPropertyDescriptor(oe.prototype,"updateSendParameters"),oe.prototype),ot(oe.prototype,"replaceTrack",[Di],Object.getOwnPropertyDescriptor(oe.prototype,"replaceTrack"),oe.prototype),ot(oe.prototype,"updateAdaptation",[Di],Object.getOwnPropertyDescriptor(oe.prototype,"updateAdaptation"),oe.prototype),ot(oe.prototype,"getRemoteSSRC",[Di],Object.getOwnPropertyDescriptor(oe.prototype,"getRemoteSSRC"),oe.prototype),oe);function Di(t,e,n){const i=t[e];if(typeof i!="function")throw new Error("Cannot use mutex on object property.");return n.value=async function(){const r=this.mutex,s=await r.lock("From NVConnectionExtension.".concat(e));try{for(var o=arguments.length,a=new Array(o),c=0;c<o;c++)a[c]=arguments[c];return await i.apply(this,a)}finally{s()}},n}var Ce;function NM(t){var e,n,i,r=2;for(typeof Symbol<"u"&&(n=Pp,i=Symbol.iterator);r--;){if(n&&(e=t[n])!=null)return e.call(t);if(i&&(e=t[i])!=null)return new hf(e.call(t));n="@@asyncIterator",i="@@iterator"}throw new TypeError("Object is not async iterable")}function hf(t){function e(n){if(Object(n)!==n)return st.reject(new TypeError(n+" is not an object."));var i=n.done;return st.resolve(n.value).then((function(r){return{value:r,done:i}}))}return hf=function(n){this.s=n,this.n=n.next},hf.prototype={s:null,n:null,next:function(){return e(this.n.apply(this.s,arguments))},return:function(n){var i=this.s.return;return i===void 0?st.resolve({value:n,done:!0}):e(i.apply(this.s,arguments))},throw:function(n){var i=this.s.return;return i===void 0?st.reject(n):e(i.apply(this.s,arguments))}},new hf(t)}let lX=(Ce=class yf extends R_{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get localCodecs(){return this._p2pConnection.localCodecs}constructor(e,n){super(e,n),R(this,"name","DataChannelConnection"),R(this,"store",void 0),R(this,"peerConnection",void 0),R(this,"cname",void 0),R(this,"mutex",new Un("DataChannelConnection-mutex")),R(this,"dataChannel",void 0),R(this,"_p2pConnection",void 0),R(this,"establishPromise",void 0),R(this,"_nvMedia",void 0),this.store=n,this.store.dcId=this.store.dcId+1,this.peerConnection=new RTCPeerConnection(yf.resolvePCConfiguration(e),{optional:[{googDscp:!0}]}),this.dataChannel=this.peerConnection.createDataChannel("agora-signal",{ordered:!1,maxPacketLifeTime:50}),this.dataChannel.binaryType="arraybuffer",this._p2pConnection=new dX(e,n,this.peerConnection),this.bindPCEvents(),this.establishPromise=this._p2pConnection.establishPromise}getPreMedia(e){var n;return(n=this._p2pConnection)===null||n===void 0?void 0:n.getPreMedia(e)}isPreSub(){var e,n;return(e=(n=this._p2pConnection)===null||n===void 0?void 0:n.isPreSub())!==null&&e!==void 0&&e}async establish(){return await this._p2pConnection.establish()}getP2PConnectionParams(){return this._p2pConnection.establishPromise}updateRtpSenderEncodings(e){return this._p2pConnection.updateRtpSenderEncodings(e)}async connect(e){return this.cname=e.cname,await this._p2pConnection.connect(e),await new st(((n,i)=>{const r=setTimeout((()=>{this.closeSignal(),i(new B(A.DATACHANNEL_CONNECTION_TIMEOUT,"Datachannel connection timed out, candidates: ".concat(JSON.stringify(e.candidates))))}),I("DC_CONNECTION_TIMEOUT"));this.dataChannel.onopen=()=>{if(this.dataChannel.readyState==="open")return clearTimeout(r),void n()},this.dataChannel.onerror=s=>{this.closeSignal(),i(s)},this.dataChannel.addEventListener("close",(()=>{i(new B(A.DATACHANNEL_CONNECTION_TIMEOUT))}))})),{transmitter:this.dataChannel,close:this.closeSignal.bind(this)}}async updateRemoteRTPCapabilities(e,n){return this._p2pConnection.updateRemoteRTPCapabilities(e,n)}send(e,n,i){var r=this;return Ci((function*(){const s=yield Ht(r.mutex.lock("From DataChannelConnection.send"));try{return yield*Ed(NM(r._p2pConnection.send(e,n,i)))}finally{s()}}))()}async stopSending(e,n){return this._p2pConnection.stopSending(e,n)}async createDataChannels(e,n){return this._p2pConnection.createDataChannels(e,n)}async stopDataChannels(e){return this._p2pConnection.stopDataChannels(e)}async receive(e,n,i,r){return this._nvMedia?(m.debug("[DataChannelConnection] receive ".concat(e," by DataChannel.")),await this._nvMedia.reveiveByRTCMedia(e,n,this.cname)):(m.debug("[DataChannelConnection] receive ".concat(e," by WebRTC.")),await this._p2pConnection.receive(e,n,i,r))}async batchReceive(e){return[...await this._p2pConnection.batchReceive(e)]}async stopReceiving(e){return await this._p2pConnection.stopReceiving(e)}async muteRemote(e){return await this._p2pConnection.muteRemote(e)}async unmuteRemote(e){return await this._p2pConnection.unmuteRemote(e)}async muteLocal(e){return await this._p2pConnection.muteLocal(e)}async unmuteLocal(e){return await this._p2pConnection.unmuteLocal(e)}restartICE(e){var n=this;return Ci((function*(){return yield*Ed(NM(n._p2pConnection.restartICE(e)))}))()}close(){var e;(e=this._nvMedia)===null||e===void 0||e.close(),this._p2pConnection.close(),this.unbindConnectionEvents(this._p2pConnection)}getStats(){return this._p2pConnection.getStats()}getRemoteVideoIsReady(e){return this._p2pConnection.getRemoteVideoIsReady(e)}updateRemoteConnect(e){var n;return(n=this._nvMedia)===null||n===void 0||n.setRemoteRtpCapabilities(e),this._p2pConnection.updateRemoteConnect(e)}async updateEncoderConfig(e,n){return await this._p2pConnection.updateEncoderConfig(e,n)}async updateSendParameters(e,n){return await this._p2pConnection.updateSendParameters(e,n)}setStatsRemoteVideoIsReady(e,n){this._p2pConnection.setStatsRemoteVideoIsReady(e,n)}async replaceTrack(e,n){return await this._p2pConnection.replaceTrack(e,n)}async getRemoteSSRC(e){return this._p2pConnection.getRemoteSSRC(e)}logSDPExchange(e,n,i,r){if(I("SDP_LOGGING"))return m.upload("exchanging ".concat(i," ").concat(n," SDP during DataChannelConnection.").concat(r,`
`),e),n==="offer"?s=>{this.logSDPExchange(s,"answer",i==="local"?"remote":"local",r)}:void 0}static resolvePCConfiguration(e){const n={iceServers:[]};return e.iceServers?n.iceServers=e.iceServers:e.turnServer&&e.turnServer.mode!=="off"&&(Ja(e.turnServer.servers)?n.iceServers=e.turnServer.servers:(n.iceServers&&n.iceServers.push(...yf.turnServerConfigToIceServers(e.turnServer.servers)),I("USE_TURN_SERVER_OF_GATEWAY")&&n.iceServers&&e.turnServer.serversFromGateway&&n.iceServers.push(...yf.turnServerConfigToIceServers(e.turnServer.serversFromGateway)),I("FORCE_TURN_TCP")?n.iceTransportPolicy="relay":e.turnServer.servers.concat(e.turnServer.serversFromGateway||[]).forEach((i=>{i.forceturn&&(n.iceTransportPolicy="relay")})))),I("ENABLE_ENCODED_TRANSFORM")&&Jt().supportWebRTCEncodedTransform&&(n.encodedInsertableStreams=!0),n}static turnServerConfigToIceServers(e){const n=[];return e.forEach((i=>{i.security?i.tcpport&&n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turns:".concat(ss(i.turnServerURL),":").concat(i.tcpport,"?transport=tcp")}):(i.udpport&&!I("FORCE_TURN_TCP")&&n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":").concat(i.udpport,"?transport=udp")}),i.tcpport&&n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":").concat(i.tcpport,"?transport=tcp")}))})),n}bindPCEvents(){this._p2pConnection.onICEConnectionStateChange=e=>{var n;return(n=this.onICEConnectionStateChange)===null||n===void 0?void 0:n.call(this,e)},this._p2pConnection.onConnectionStateChange=e=>{var n;return(n=this.onConnectionStateChange)===null||n===void 0?void 0:n.call(this,e)},this._p2pConnection.onDTLSTransportStateChange=e=>{var n;return(n=this.onDTLSTransportStateChange)===null||n===void 0?void 0:n.call(this,e)},this._p2pConnection.onDTLSTransportError=e=>{var n;return(n=this.onDTLSTransportError)===null||n===void 0?void 0:n.call(this,e)},this._p2pConnection.onICETransportStateChange=e=>{var n;return(n=this.onICETransportStateChange)===null||n===void 0?void 0:n.call(this,e)},this._p2pConnection.onFirstAudioReceived=e=>{var n;return(n=this.onFirstAudioReceived)===null||n===void 0?void 0:n.call(this,e)},this._p2pConnection.onFirstVideoReceived=e=>{var n;return(n=this.onFirstVideoReceived)===null||n===void 0?void 0:n.call(this,e)},this._p2pConnection.onFirstAudioDecoded=e=>{var n;return(n=this.onFirstAudioDecoded)===null||n===void 0?void 0:n.call(this,e)},this._p2pConnection.onFirstVideoRender=e=>{var n;return(n=this.onFirstVideoRender)===null||n===void 0?void 0:n.call(this,e)},this._p2pConnection.onFirstVideoBufferReady=e=>{var n;return(n=this.onFirstVideoBufferReady)===null||n===void 0?void 0:n.call(this,e)},this._p2pConnection.onFirstVideoDecoded=(e,n,i)=>{var r;return(r=this.onFirstVideoDecoded)===null||r===void 0?void 0:r.call(this,e,n,i)},this._p2pConnection.onFirstVideoDecodedTimeout=e=>{var n;return(n=this.onFirstVideoDecodedTimeout)===null||n===void 0?void 0:n.call(this,e)},this._p2pConnection.onSelectedLocalCandidateChanged=(e,n)=>{var i;return(i=this.onSelectedLocalCandidateChanged)===null||i===void 0?void 0:i.call(this,e,n)},this._p2pConnection.onSelectedRemoteCandidateChanged=(e,n)=>{var i;return(i=this.onSelectedRemoteCandidateChanged)===null||i===void 0?void 0:i.call(this,e,n)}}closeSignal(){this.dataChannel.close(),this.peerConnection.close()}unbindConnectionEvents(e){e.onConnectionStateChange=void 0,e.onICEConnectionStateChange=void 0,e.onICETransportStateChange=void 0,e.onDTLSTransportStateChange=void 0,e.onDTLSTransportError=void 0,e.onFirstAudioDecoded=void 0,e.onFirstAudioReceived=void 0,e.onFirstVideoDecoded=void 0,e.onFirstVideoReceived=void 0,e.onSelectedLocalCandidateChanged=void 0,e.onSelectedRemoteCandidateChanged=void 0,e.onFirstVideoDecodedTimeout=void 0}setConfiguration(e){this._p2pConnection.setConfiguration(e)}},ot(Ce.prototype,"connect",[Tr],Object.getOwnPropertyDescriptor(Ce.prototype,"connect"),Ce.prototype),ot(Ce.prototype,"updateRemoteRTPCapabilities",[Tr],Object.getOwnPropertyDescriptor(Ce.prototype,"updateRemoteRTPCapabilities"),Ce.prototype),ot(Ce.prototype,"createDataChannels",[Tr],Object.getOwnPropertyDescriptor(Ce.prototype,"createDataChannels"),Ce.prototype),ot(Ce.prototype,"receive",[Tr],Object.getOwnPropertyDescriptor(Ce.prototype,"receive"),Ce.prototype),ot(Ce.prototype,"stopReceiving",[Tr],Object.getOwnPropertyDescriptor(Ce.prototype,"stopReceiving"),Ce.prototype),ot(Ce.prototype,"muteRemote",[Tr],Object.getOwnPropertyDescriptor(Ce.prototype,"muteRemote"),Ce.prototype),ot(Ce.prototype,"unmuteRemote",[Tr],Object.getOwnPropertyDescriptor(Ce.prototype,"unmuteRemote"),Ce.prototype),ot(Ce.prototype,"muteLocal",[Tr],Object.getOwnPropertyDescriptor(Ce.prototype,"muteLocal"),Ce.prototype),ot(Ce.prototype,"unmuteLocal",[Tr],Object.getOwnPropertyDescriptor(Ce.prototype,"unmuteLocal"),Ce.prototype),ot(Ce.prototype,"close",[Tr],Object.getOwnPropertyDescriptor(Ce.prototype,"close"),Ce.prototype),ot(Ce.prototype,"updateEncoderConfig",[Tr],Object.getOwnPropertyDescriptor(Ce.prototype,"updateEncoderConfig"),Ce.prototype),ot(Ce.prototype,"updateSendParameters",[Tr],Object.getOwnPropertyDescriptor(Ce.prototype,"updateSendParameters"),Ce.prototype),ot(Ce.prototype,"replaceTrack",[Tr],Object.getOwnPropertyDescriptor(Ce.prototype,"replaceTrack"),Ce.prototype),ot(Ce.prototype,"getRemoteSSRC",[Tr],Object.getOwnPropertyDescriptor(Ce.prototype,"getRemoteSSRC"),Ce.prototype),Ce);function Tr(t,e,n){const i=t[e];if(typeof i!="function")throw new Error("Cannot use mutex on object property.");return n.value=async function(){const r=this.mutex,s=await r.lock("From DataChannelConnection.".concat(e));try{for(var o=arguments.length,a=new Array(o),c=0;c<o;c++)a[c]=arguments[c];return await i.apply(this,a)}finally{s()}},n}function DM(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable}))),n.push.apply(n,i)}return n}class uX extends qe{get url(){return this._url?this._url:null}get reconnectMode(){return this._reconnectMode}set reconnectMode(e){var n;$(n=["tryNext","recover"]).call(n,e)&&this.resetReconnectCount(e),this._reconnectMode=e}get state(){return this._state}set state(e){e!==this._state&&(this._state=e,this._state==="reconnecting"?this.emit(In.RECONNECTING,this.reconnectReason):this._state==="connected"?this.emit(In.CONNECTED):this._state==="closed"?this.emit(In.CLOSED):this._state==="failed"&&this.emit(In.FAILED))}constructor(e,n,i,r){super(),R(this,"connectionID",0),R(this,"currentURLIndex",0),R(this,"reconnectReason",void 0),R(this,"_reconnectMode","tryNext"),R(this,"_initMutex",void 0),R(this,"_name",void 0),R(this,"_state","closed"),R(this,"_reconnectInterrupter",void 0),R(this,"_url",void 0),R(this,"_retryConfig",void 0),R(this,"_reconnectCount",0),R(this,"_forceCloseTimeout",5e3),R(this,"_onlineReconnectListener",void 0),R(this,"_closeEstablishingTransmitter",(()=>{})),R(this,"_store",void 0),R(this,"_joinChannelServiceRecordIndex",void 0),R(this,"_transmitter",void 0),R(this,"_useCompress",void 0),R(this,"_inflateLength",0),R(this,"_deflateLength",0),this._store=r,this._name=e,this._retryConfig=(function(s){for(var o=1;o<arguments.length;o++){var a=arguments[o]!=null?arguments[o]:{};o%2?DM(Object(a),!0).forEach((function(c){R(s,c,a[c])})):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(a)):DM(Object(a)).forEach((function(c){Object.defineProperty(s,c,Object.getOwnPropertyDescriptor(a,c))}))}return s})({},n),this._useCompress=i}resetReconnectCount(e){m.debug("".concat(this._name," reset reconnect count, reason: ").concat(e)),this._reconnectCount=0}close(e,n){if(this.currentURLIndex=0,this.resetReconnectCount("close"),this._reconnectInterrupter&&this._reconnectInterrupter(),this._transmitter){this._transmitter.onclose=null,this._transmitter.onopen=null,this._transmitter.onmessage=null;const i=this._transmitter;n?setTimeout((()=>i.close()),500):i.close(),this._transmitter=void 0}this.state=e?"failed":"closed",this._closeEstablishingTransmitter&&this._closeEstablishingTransmitter()}reconnect(e,n){if(!this._transmitter)return void m.warning("[".concat(this._name,"] can not reconnect, no websocket"));var i;e!==void 0&&(this.reconnectMode=e),m.debug("[".concat(this._name,"] reconnect is triggered initiative")),typeof this._joinChannelServiceRecordIndex=="number"&&((i=this._store)===null||i===void 0||i.recordJoinChannelService({status:"error",errors:[new Error(n)]},this._joinChannelServiceRecordIndex));const r=this._transmitter.onclose;this._transmitter.onclose=null,this._transmitter.close(),r&&r.bind(this._transmitter)({code:9999,reason:n})}getInflateData(){const e=this._inflateLength,n=this._deflateLength;return this.clearInflateData(),{inflateLength:e,deflateLength:n}}setInflateData(e){this._deflateLength=this._deflateLength+e.originLength,this._inflateLength=this._inflateLength+e.compressedLength}clearInflateData(){this._inflateLength=0,this._deflateLength=0}}let Ls=(function(t){return t[t.Default=0]="Default",t[t.Ack=1]="Ack",t})({});class hX{constructor(e,n,i){R(this,"version",1),R(this,"initialRTO",void 0),R(this,"maxBatchAckCount",void 0),R(this,"maxRTO",void 0),R(this,"initialRTT",void 0),R(this,"ID",void 0),R(this,"rtt",void 0),R(this,"packetNumber",1),R(this,"rtoRatioMap",new Map),R(this,"timeoutMap",new Map),R(this,"unorderedPacketQueue",[]),R(this,"batchAckPacketQueue",[]),R(this,"lastOrderedPacketNumber",0),R(this,"batchAckTimer",void 0),R(this,"sendImpl",void 0),R(this,"receiveImpl",void 0),this.sendImpl=e,this.receiveImpl=n,this.ID=Se(7,"transmitter-"),this.initialRTO=i?.initialRTO!==void 0?i.initialRTO:I("TRANSMITTER_INITIAL_RTO"),this.initialRTT=i?.initialRTT!==void 0?i.initialRTT:I("TRANSMITTER_INITIAL_RTT"),this.rtt=i?.initialRTT!==void 0?i.initialRTT:I("TRANSMITTER_INITIAL_RTT"),this.maxBatchAckCount=i?.maxBatchAckCount!==void 0?i.maxBatchAckCount:I("TRANSMITTER_MAX_BATCH_ACK_COUNT"),this.maxRTO=i?.maxRTO!==void 0?i.maxRTO:I("TRANSMITTER_MAX_RTO")}packetize(e,n){return{type:Ls.Default,version:this.version,packetNumber:n,payload:e}}serialize(e){switch(e.type){case Ls.Default:{let n;typeof e.payload=="string"?n=new TextEncoder().encode(e.payload):n=e.payload;const i=new ArrayBuffer(n.length+15),r=new DataView(i);return r.setUint16(0,e.version),r.setUint8(2,e.type),r.setUint32(3,e.packetNumber),NO(r,7,BigInt(e.sendTs)),new Uint8Array(r.buffer).set(n,15),i}case Ls.Ack:{const n=new ArrayBuffer(16),i=new DataView(n);return i.setUint16(0,e.version),i.setUint8(2,e.type),i.setUint32(3,e.maxAckPacketNumber),i.setUint8(7,e.shift),NO(i,8,BigInt(e.ackSendTs)),n}}}deserialize(e){const n=new DataView(e),i=n.getUint16(0),r=n.getUint8(2);switch(r){case Ls.Default:{const s=n.getUint32(3),o=OO(n,7),a=e.slice(15),c=new Uint8Array(a);return{version:i,type:r,packetNumber:s,sendTs:Number(o),payload:c}}case Ls.Ack:{const s=n.getUint32(3),o=n.getUint8(7),a=OO(n,8);return{version:i,type:r,maxAckPacketNumber:s,shift:o,ackSendTs:Number(a)}}default:throw m.error("[".concat(this.ID,"] Unrecognized packet type ").concat(r)),new Error("Unrecognized packet type ".concat(r))}}sendMessage(e){I("DC_DEBUG_LOG")&&typeof e=="string"&&m.debug("[".concat(this.ID,"] sending message packet"),JSON.parse(e));const n=this.packetize(e,this.packetNumber);this.packetNumber=this.packetNumber===4294967295?1:this.packetNumber+1;const i=this.calculateRTO(n),r=window.setTimeout((()=>{this.resendMessage(n)}),i);this.timeoutMap.set(n.packetNumber,r),this.sendPacket(n)}onData(e){const n=this.deserialize(e);n.type===Ls.Default?this.ack(n):n.type===Ls.Ack&&(this.updateRTT(n,Math.round(performance.now())),this.clearRTO(n))}close(){this.rtt=this.initialRTT,this.packetNumber=1,Array.from(this.timeoutMap.entries()).forEach((e=>{let[n,i]=e;window.clearTimeout(i)})),this.timeoutMap=new Map,this.rtoRatioMap=new Map,this.unorderedPacketQueue=[],this.batchAckPacketQueue=[],this.lastOrderedPacketNumber=0,this.batchAckTimer!==void 0&&window.clearTimeout(this.batchAckTimer)}resendMessage(e){const n=this.calculateRTO(e),i=window.setTimeout((()=>{I("DC_DEBUG_LOG")&&typeof e.payload=="string"&&m.debug("[".concat(this.ID,"] resending message packet"),JSON.parse(e.payload),"timeout: ".concat(n)),this.resendMessage(e)}),n);this.timeoutMap.set(e.packetNumber,i),this.sendPacket(e)}calculateRTO(e){const n=this.rtoRatioMap.get(e.packetNumber);if(n===void 0)return this.rtoRatioMap.set(e.packetNumber,1),this.initialRTO;{const i=9*this.rtt/8*n;return this.rtoRatioMap.set(e.packetNumber,n+1),i>this.maxRTO?this.maxRTO:i}}updateRTT(e,n){const i=e.ackSendTs;this.rtt=this.rtt*(7/8)+(n-i-this.rtt)/8}ack(e){if(e.packetNumber===this.lastOrderedPacketNumber+1)for(this.batchAckPacketQueue.length>=this.maxBatchAckCount&&this.batchAck(),this.batchAckTimer?this.batchAckPacketQueue.push(e):(this.batchAckPacketQueue.push(e),this.batchAckTimer=window.setTimeout((()=>{this.batchAck()}),this.rtt/8)),this.lastOrderedPacketNumber+=1,this.receiveImpl(e.payload);;){const n=this.unorderedPacketQueue[0];if(!n){this.unorderedPacketQueue.shift();break}this.batchAckTimer&&this.batchAck(),this.receiveImpl(n.payload),this.unorderedPacketQueue.shift(),this.lastOrderedPacketNumber+=1}else if(e.packetNumber<=this.lastOrderedPacketNumber){const n={ackSendTs:e.sendTs,maxAckPacketNumber:e.packetNumber,shift:0,type:Ls.Ack,version:this.version};I("DC_DEBUG_LOG")&&m.debug("[".concat(this.ID,"] sending ack packet"),n,"packetNumber: ".concat(e.packetNumber)),this.sendPacket(n)}else if(e.packetNumber>this.lastOrderedPacketNumber){this.unorderedPacketQueue[e.packetNumber-this.lastOrderedPacketNumber-2]=e;const n={ackSendTs:e.sendTs,maxAckPacketNumber:e.packetNumber,shift:0,type:Ls.Ack,version:this.version};I("DC_DEBUG_LOG")&&m.debug("[".concat(this.ID,"] sending ack packet"),n,"packetNumber: ".concat(e.packetNumber)),this.sendPacket(n)}}batchAck(){window.clearTimeout(this.batchAckTimer),this.batchAckTimer=void 0;const e={ackSendTs:this.batchAckPacketQueue[this.batchAckPacketQueue.length-1].sendTs,maxAckPacketNumber:this.batchAckPacketQueue[this.batchAckPacketQueue.length-1].packetNumber,shift:this.batchAckPacketQueue.length-1,type:Ls.Ack,version:this.version};I("DC_DEBUG_LOG")&&m.debug("[".concat(this.ID,"] sending batch ack packet"),e,"shift: ".concat(this.batchAckPacketQueue.length-1)),this.sendPacket(e),this.batchAckPacketQueue=[]}sendPacket(e){e.type===Ls.Default&&(e.sendTs=Math.round(performance.now()));const n=this.serialize(e);this.sendImpl(n)}clearRTO(e){for(let n=e.maxAckPacketNumber-e.shift;n<=e.maxAckPacketNumber;n++){const i=this.timeoutMap.get(n);i!==void 0&&window.clearTimeout(i),this.timeoutMap.delete(n),this.rtoRatioMap.delete(n)}}}class PM extends uX{constructor(e,n){super(e,n,arguments.length>2&&arguments[2]!==void 0&&arguments[2],arguments.length>3?arguments[3]:void 0),R(this,"_initMutex",void 0),R(this,"_reconnectInterrupter",void 0),R(this,"_url",void 0),R(this,"_transmitter",void 0),R(this,"_addresses",void 0),R(this,"_reliableTransmission",void 0),R(this,"_textEncoder",void 0),R(this,"_textDecoder",void 0),this._textEncoder=new TextEncoder,this._textDecoder=new TextDecoder,this._initMutex=new Un("datachannel");const{timeout:i,timeoutFactor:r}=n,s=Math.max(300,Math.floor(3*i/5)),o=Math.max(1.2,Math.floor(8*r)/10);mi.ONLINE&&(this._retryConfig.timeout=s,this._retryConfig.timeoutFactor=o),$e.on(Qa.NETWORK_STATE_CHANGE,((a,c)=>{a!==c&&(this.resetReconnectCount("network state change: ".concat(c," -> ").concat(a)),a===mi.ONLINE?(this._retryConfig.timeout=s,this._retryConfig.timeoutFactor=o):(this._retryConfig.timeout=i,this._retryConfig.timeoutFactor=r))}))}getConnection(){if(this._reliableTransmission)return this._reliableTransmission}async init(e){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:5e3;this._forceCloseTimeout=n;const i=(r,s)=>{this._addresses=e,this.currentURLIndex=this._addresses.findIndex((a=>a.fingerprint||I("FINGERPRINT")));const o=this._addresses[this.currentURLIndex];this.state="connecting",this.createTransmitterConnection(o).then(r).catch(s),this.once(In.CLOSED,(()=>s(new B(A.WS_DISCONNECT)))),this.once(In.CONNECTED,(()=>r()))};return this._initMutex.lock().then((r=>new st(((s,o)=>{i(s,o)})).then((()=>{r()})).catch((()=>{r()}))))}async sendMessage(e){let n=arguments.length>2&&arguments[2]!==void 0&&arguments[2];if(!this._transmitter||!this._reliableTransmission)throw new B(A.WS_ABORT,"datachannel is not ready");try{n||(e=JSON.stringify(e));const i=this._textEncoder.encode(e),r=yz(i,{raw:!0});this._reliableTransmission.sendMessage(r)}catch(i){throw new B(A.WS_ERR,"send datachannel signal message error"+i.toString())}}unbindDcCloseEventListener(){this._transmitter&&(this._transmitter.onclose=null)}sendMessageWithJSON(e){const n=JSON.stringify(e);return{compressed:n,compressedLength:n.length,origin:e}}sendMessageWithUint8Array(e){return{compressed:e,compressedLength:e.byteLength,origin:e}}createTransmitterConnection(e){return this.connectionID+=1,this._joinChannelServiceRecordIndex=void 0,this._url="dc://".concat(e.ip,":").concat(e.port),new st(((n,i)=>{var r;const s=()=>{m.debug("[".concat(this._name,"] datachannel opened:"),this._url),this.reconnectMode="recover",this.state="connected",this.resetReconnectCount("opened"),n()},o=async l=>{var h;if((h=this._closeEstablishingTransmitter)===null||h===void 0||h.call(this),m.debug("[".concat(this._name,"] datachannel close ").concat(this._url,", code: ").concat(l.code,", reason: ").concat(l.reason,", current mode: ").concat(this.reconnectMode)),this._reconnectCount<this._retryConfig.maxRetryCount){this.state==="connected"&&(this.reconnectReason=l.reason,this.state="reconnecting");const p=Ji(this,In.WILL_RECONNECT,this.reconnectMode)||this.reconnectMode,f=await this.reconnectWithAction(p);if(this.state==="closed")return void m.debug("[".concat(this.connectionID,"] dc is closed, no need to reconnect"));if(!f)return i(new B(A.WS_DISCONNECT,"datachannel reconnect failed: ".concat(l.code))),void this.close(!0);n()}else i(new B(A.WS_DISCONNECT,"datachannel close: ".concat(l.code))),this.close()},a=async l=>{try{var h;(h=this._reliableTransmission)===null||h===void 0||h.onData(l.data)}catch(p){console.log(p)}};this._transmitter&&(this._transmitter.onclose=null,this._transmitter.close()),this._reliableTransmission&&(this._reliableTransmission.close(),this._reliableTransmission=void 0),m.debug("[".concat(this._name,"] start connect, address: ").concat(JSON.stringify(e)));const c=(r=this._store)===null||r===void 0?void 0:r.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"gateway"}),d=Date.now();Sn(this,In.TO_CONNECT_DATACHANNEL).then((l=>{var h,p;if(!l)throw new Error("transmissonInfo not exist yet");const{transmitter:f,close:v}=l;this._transmitter=f,(h=this._store)===null||h===void 0||h.signalChannelOpen();const S=Date.now()-d;m.debug("[choose dc] dc open cost ".concat(S,"ms")),this._reliableTransmission=new hX((T=>{var b;this._transmitter&&this._transmitter.readyState==="open"&&((b=this._transmitter)===null||b===void 0||b.send(T))}),(T=>{if(typeof T=="string")this.emit(In.ON_MESSAGE,T);else{const b=bz(T,{raw:!0}).buffer,w=this._textDecoder.decode(b);this.emit(In.ON_MESSAGE,w)}})),this._closeEstablishingTransmitter=()=>{var T;(T=this._reliableTransmission)===null||T===void 0||T.close(),this._reliableTransmission=void 0,v()},s&&s(),f.onclose=o,f.onmessage=a,(p=this._store)===null||p===void 0||p.recordJoinChannelService({endTs:Date.now(),status:"success"},c),this._joinChannelServiceRecordIndex=c})).catch((l=>{var h;if((h=this._store)===null||h===void 0||h.recordJoinChannelService({endTs:Date.now(),status:l instanceof B&&l.code===A.WS_ABORT?"aborted":"error",errors:[l]},c),this.state!=="closed"){if(l instanceof B&&l.code===A.WS_ERR){const p=new B(A.WS_ERR,"init datachannel failed! Error: ".concat(l.toString()));return m.error("[".concat(this._name,"]").concat(p)),void i(p)}o&&o(l)}else i(new B(A.WS_DISCONNECT,"datachannel is closed: ".concat(l.toString())))}))}))}async reconnectWithAction(e){let n=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];if(this._reconnectCount>=this._retryConfig.maxRetryCount||!this._addresses||this.state==="closed")return!1;this._onlineReconnectListener||$e.networkState!==mi.OFFLINE||(this._onlineReconnectListener=$e.onlineWaiter&&$e.onlineWaiter.then((()=>{this._onlineReconnectListener=void 0})));let i=!0;if(this._reconnectInterrupter=()=>{i=!1},n){const a=Kp(this._reconnectCount,this._retryConfig);m.debug("[".concat(this._name,"] wait ").concat(a,"ms to reconnect datachannel, mode: ").concat(e)),await st.race([Nn(a),this._onlineReconnectListener||new st((()=>{}))])}if(this.state==="closed"||!i)return!1;this._reconnectCount+=1;const r=async(a,c)=>{this.emit(In.RECONNECT_CREATE_CONNECTION,c),await this.createTransmitterConnection(a)};try{if(e==="retry"){const a=this._addresses[this.currentURLIndex];await r(a,e)}else if(e==="tryNext"){this.currentURLIndex+=1;for(let c=this.currentURLIndex;c<this._addresses.length;c++){if(this._addresses[c].fingerprint||I("FINGERPRINT")){this.currentURLIndex=c;break}this.currentURLIndex+=1}if(this.currentURLIndex>=this._addresses.length)return m.debug("[".concat(this._name,"] the available addresses are exhausted, change to recover")),await this.reconnectWithAction("recover",!1);m.debug("[".concat(this._name,"] datachannel url length: ").concat(this._addresses.length," current index: ").concat(this.currentURLIndex));const a=this._addresses[this.currentURLIndex];await r(a,e)}else e==="recover"&&(m.debug("[".concat(this._name,"] start to failback to websocket")),this.resetReconnectCount("recover mode"),this.emit(In.FAILBACK));return!0}catch(a){var s,o;return m.error("[".concat(this._name,"] reconnect failed"),a.toString()),a!=null&&(s=a.data)!==null&&s!==void 0&&s.desc&&Array.isArray(a.data.desc)&&a.data.desc.length&&$(o=a.data.desc).call(o,"dynamic key expired")?(this.emit(In.ON_TOKEN_PRIVILEGE_DID_EXPIRE),!1):await this.reconnectWithAction(e,n)}}}class pX extends qe{get connectionState(){return this._connectionState}set connectionState(e){e!==this._connectionState&&(this._connectionState=e,e===ee.CONNECTED?this.emit(ft.WS_CONNECTED):e===ee.RECONNECTING?this.emit(ft.WS_RECONNECTING,this._websocketReconnectReason):e===ee.CLOSED&&this.emit(ft.WS_CLOSED,this._disconnectedReason))}get currentURLIndex(){return this.websocket.currentURLIndex}get url(){return this.websocket?this.websocket.url:null}get rtt(){return this.rttRolling.mean()}processPendingNotifications(){this.pendingNotifications.length!==0&&(m.debug("[".concat(this.clientId,"] processing ").concat(this.pendingNotifications.length," pending notifications")),this.pendingNotifications.forEach((e=>{let{type:n,message:i}=e;this.emit(n,i),n===Lt.ON_NOTIFICATION&&this.handleNotification(i),n===Lt.ON_USER_BANNED&&this.handleUserBanned(i)})),this.pendingNotifications=[])}handleUserBanned(e){switch(e.error_code){case 14:this.close(te.UID_BANNED);break;case 15:this.close(te.IP_BANNED);break;case 16:this.close(te.CHANNEL_BANNED)}}constructor(e,n){super(),R(this,"__name__","DataChannelSignal"),R(this,"_disconnectedReason",void 0),R(this,"_websocketReconnectReason",void 0),R(this,"_connectionState",ee.CLOSED),R(this,"reconnectToken",void 0),R(this,"websocket",void 0),R(this,"openConnectionTime",void 0),R(this,"clientId",void 0),R(this,"lastMsgTime",Date.now()),R(this,"uploadCache",[]),R(this,"uploadCacheInterval",void 0),R(this,"rttRolling",new nS(5)),R(this,"pingpongTimer",void 0),R(this,"inflateDataTimer",void 0),R(this,"pingpongTimeoutCount",0),R(this,"ortc",void 0),R(this,"joinResponse",void 0),R(this,"multiIpOption",void 0),R(this,"initError",void 0),R(this,"spec",void 0),R(this,"store",void 0),R(this,"isJoining",!1),R(this,"pendingNotifications",[]),R(this,"onWebsocketMessage",(i=>{if(i instanceof ArrayBuffer)return void this.emit(ft.ON_BINARY_DATA,i);const r=JSON.parse(i);if(I("DC_DEBUG_LOG")&&m.debug("[datachannel-signal] received packet",r),this.lastMsgTime=Date.now(),Object.prototype.hasOwnProperty.call(r,"_id")){const s="res-@".concat(r._id);this.emit(s,r._result,r._message)}else Object.prototype.hasOwnProperty.call(r,"_type")&&(this.isJoining?r._type===Lt.ON_NOTIFICATION||r._type===Lt.ON_USER_BANNED?(this.emit(r._type,r._message),r._type===Lt.ON_NOTIFICATION&&this.handleNotification(r._message),r._type===Lt.ON_USER_BANNED&&this.handleUserBanned(r._message)):(this.pendingNotifications.push({type:r._type,message:r._message}),m.debug("[".concat(this.clientId,"] cached notification during join: ").concat(r._type))):(this.emit(r._type,r._message),r._type===Lt.ON_NOTIFICATION&&this.handleNotification(r._message),r._type===Lt.ON_USER_BANNED&&this.handleUserBanned(r._message)))})),this.clientId=e.clientId,this.spec=e,this.store=n,this.websocket=new PM("gateway-".concat(this.clientId),this.spec.retryConfig,!0,n),this.handleWebsocketEvents(),window.addEventListener("offline",(()=>{this.connectionState===ee.CONNECTED&&this.reconnect("retry",la.OFFLINE)}))}async request(e,n,i,r){const s=Se(6,""),o={_id:s,_type:e,_message:n},a=this.websocket.connectionID,c=()=>new st(((v,S)=>{if(this.connectionState===ee.CONNECTED)return v();const T=()=>{this.off(ft.WS_CLOSED,b),v()},b=()=>{this.off(ft.WS_CONNECTED,T),S(new B(A.WS_ABORT))};this.once(ft.WS_CONNECTED,T),this.once(ft.WS_CLOSED,b),e!==Tt.PUBLISH&&e!==Tt.SUBSCRIBE&&e!==Tt.UNSUBSCRIBE&&e!==Tt.UNPUBLISH&&e!==Tt.CONTROL&&e!==Tt.RESTART_ICE||this.once(ft.DISCONNECT_P2P,(()=>{S(new B(A.DISCONNECT_P2P))})),e!==Tt.PUBLISH&&e!==Tt.RESTART_ICE||this.once(ft.ABORT_P2P_EXECUTION,(()=>{S(new B(A.DISCONNECT_P2P))}))}));if(this.connectionState!==ee.CONNECTING&&this.connectionState!==ee.RECONNECTING||e===Tt.JOIN||e===Tt.REJOIN||await c(),e===Tt.LEAVE&&(this.websocket.unbindDcCloseEventListener(),r=!0),I("DC_DEBUG_LOG")&&m.debug("[datachannel-signal] sendMessage",o),await this.websocket.sendMessage(o,!0,!1),r)return;const d=new st(((v,S)=>{let T=!1;const b=(D,k)=>{T=!0,v({isSuccess:D==="success",message:k||{}}),this.off(ft.WS_CLOSED,w),this.off(ft.WS_RECONNECTING,w),this.emit(ft.REQUEST_SUCCESS,e,n)};this.once("res-@".concat(s),b);const w=()=>{S(new B(A.WS_ABORT,"type: ".concat(e))),this.off(ft.WS_CLOSED,w),this.off(ft.WS_RECONNECTING,w),this.off("res-@".concat(s),b)};this.once(ft.WS_CLOSED,w),this.once(ft.WS_RECONNECTING,w),Nn(I("SIGNAL_REQUEST_TIMEOUT")).then((()=>{this.websocket.connectionID!==a||T||(m.warning("dc request timeout, type: ".concat(e)),this.emit(ft.REQUEST_TIMEOUT,e,n))}))}));let l=null;try{l=await d}catch(v){if(this.connectionState===ee.CLOSED||e===Tt.LEAVE)throw new B(A.WS_ABORT);return!this.spec.forceWaitGatewayResponse||i?v.throw():e===Tt.JOIN||e===Tt.REJOIN?null:(await c(),await this.request(e,n))}if(l.isSuccess)return l.message;const h=Number(l.message.error_code||l.message.code),p=pc(h),f=new B(A.UNEXPECTED_RESPONSE,"".concat(p.desc,": ").concat(l.message.error_str),{code:h,data:l.message});return p.action==="success"?l.message:(m.warning("[".concat(this.websocket.connectionID,"] unexpected response from type ").concat(e,", error_code: ").concat(h,", message: ").concat(p.desc,", action: ").concat(p.action)),h===yt.ERR_TOO_MANY_BROADCASTERS?((e===Tt.JOIN||e===Tt.REJOIN)&&(this.initError=f,this.close()),f.throw()):p.action==="failed"?f.throw():p.action==="quit"?(this.initError=f,this.close(),f.throw()):(h===yt.ERR_JOIN_BY_MULTI_IP?(this.multiIpOption=l.message.option,m.warning("[".concat(this.clientId,"] detect multi ip, recover")),this.reconnect("recover",la.MULTI_IP)):this.reconnect(p.action,la.SERVER_ERROR),e===Tt.JOIN||e===Tt.REJOIN?null:await this.request(e,n)))}waitMessage(e,n){return new st((i=>{const r=s=>{(!n||n(s))&&(this.off(e,r),i(s))};this.on(e,r)}))}uploadWRTCStats(e){if(!this.store.sessionId)return void m.warn("[".concat(this.clientId,"] no session id when upload wrtc stats"));const n={lts:Date.now(),sid:this.store.sessionId,uid:this.store.intUid,stats:e};this.upload(hc.WRTC_STATS,n)}upload(e,n){const i={_type:e,_message:n};try{this.websocket.sendMessage(i)}catch{const s=I("MAX_UPLOAD_CACHE")||50;this.uploadCache.push(i),this.uploadCache.length>s&&this.uploadCache.splice(0,1),this.uploadCache.length>0&&!this.uploadCacheInterval&&(this.uploadCacheInterval=window.setInterval((()=>{if(this.connectionState!==ee.CONNECTED)return;const o=this.uploadCache.splice(0,1)[0];this.uploadCache.length===0&&(window.clearInterval(this.uploadCacheInterval),this.uploadCacheInterval=void 0),this.upload(o._type,o._message)}),I("UPLOAD_CACHE_INTERVAL")||2e3))}}async send(e,n){const i={_type:e,_message:n};await this.websocket.sendMessage(i)}init(e){return this.initError=void 0,this.multiIpOption=void 0,this.joinResponse=void 0,this.reconnectToken=void 0,this.openConnectionTime=void 0,new st(((n,i)=>{this.once(ft.WS_CONNECTED,(()=>n(this.joinResponse))),this.once(ft.WS_CLOSED,(()=>i(this.initError||new B(A.WS_ABORT)))),this.connectionState=ee.CONNECTING,this.websocket.init(e).catch(i),this.websocket.once(In.FAILBACK,(()=>{i(new B(A.INIT_DATACHANNEL_TIMEOUT))})),this.inflateDataTimer&&window.clearInterval(this.inflateDataTimer),this.inflateDataTimer=window.setInterval((()=>{this.handleInflateData()}),2e4),setTimeout((()=>{this.openConnectionTime===void 0&&(m.debug("[".concat(this.clientId,"] init datachannel timeout while join with failback to websocket")),i(new B(A.INIT_DATACHANNEL_TIMEOUT)))}),I("DC_JOIN_WITH_FAILBACK"))}))}close(e){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.inflateDataTimer&&(this.handleInflateData(),window.clearInterval(this.inflateDataTimer),this.inflateDataTimer=void 0),this.reconnectToken=void 0,this.joinResponse=void 0,this.isJoining=!1,this.pendingNotifications=[],this._disconnectedReason=e||te.LEAVE,this.connectionState=ee.CLOSED,m.debug("[".concat(this.clientId,"] ")+"will close datachannel in signal"),this.websocket.close(),e===te.FALLBACK&&(this.websocket.removeAllListeners(),this.websocket=new PM("gateway-".concat(this.clientId),this.spec.retryConfig,!0,this.store),this.handleWebsocketEvents())}async join(){if(this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),I("DC_PINGPONG_INTERVAL")),!this.joinResponse){this.emit(ft.ABORT_P2P_EXECUTION),this.store.signalConnected();const e=await Sn(this,ft.REQUEST_JOIN_INFO);this.store.joinReq(),this.isJoining=!0,this.pendingNotifications=[];const n=await this.request(Tt.JOIN,e);if(this.store.joinRep(),this.ortc=e?.ortc,!n)return this.emit(ft.REPORT_JOIN_GATEWAY,A.TIMEOUT,this.url||""),!1;this.joinResponse=n,this.emit(ft.JOIN_RESPONSE,this.joinResponse),this.reconnectToken=this.joinResponse.rejoin_token}return this.connectionState=ee.CONNECTED,this.isJoining=!1,this.processPendingNotifications(),!0}async rejoin(){if(!this.reconnectToken)throw new B(A.UNEXPECTED_ERROR,"can not rejoin, no rejoin token");const e=Za(this,ft.REQUEST_REJOIN_INFO);e.token=this.reconnectToken;const n=await this.request(Tt.REJOIN,e);return!!n&&(this.connectionState=ee.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),I("DC_PINGPONG_INTERVAL")),n.peers&&n.peers.forEach((i=>{this.emit(Lt.ON_USER_ONLINE,{uid:i.uid}),i.audio&&this.emit(Lt.ON_ADD_AUDIO_STREAM,{uid:i.uid,uint_id:i.uint_id,audio:!0,ssrcId:i.audio_ssrc}),i.video&&this.emit(Lt.ON_ADD_VIDEO_STREAM,{uid:i.uid,uint_id:i.uint_id,video:!0,ssrcId:i.video_ssrc}),i.audio_mute?this.emit(Lt.MUTE_AUDIO,{uid:i.uid}):this.emit(Lt.UNMUTE_AUDIO,{uid:i.uid}),i.video_mute?this.emit(Lt.MUTE_VIDEO,{uid:i.uid}):this.emit(Lt.UNMUTE_VIDEO,{uid:i.uid}),i.audio_enable_local?this.emit(Lt.ENABLE_LOCAL_AUDIO,{uid:i.uid}):this.emit(Lt.DISABLE_LOCAL_AUDIO,{uid:i.uid}),i.video_enable_local?this.emit(Lt.ENABLE_LOCAL_VIDEO,{uid:i.uid}):this.emit(Lt.DISABLE_LOCAL_VIDEO,{uid:i.uid}),i.audio||i.video||this.emit(Lt.ON_REMOVE_STREAM,{uid:i.uid,uint_id:i.uint_id})})),!0)}reconnect(e,n){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.websocket.reconnect(e,n)}async downgradeCodec(e){if(!this.ortc)return!1;const n={downgrade_codec:e,ortc:this.ortc};return!!await this.request(Tt.DOWNGRADE_CODEC,n)}handleNotification(e){m.debug("[".concat(this.clientId,"] receive notification: "),e);const n=pc(e.code);if(n.action!=="success"){if(n.action!=="failed")return n.action==="quit"?(n.desc==="ERR_REPEAT_JOIN_CHANNEL"&&this.close(te.UID_BANNED),void this.close()):void this.reconnect(n.action,la.SERVER_ERROR);m.error("[".concat(this.clientId,"] ignore error: "),n.desc)}}handlePingPong(){if(!this.websocket||this.websocket.state!=="connected")return;this.pingpongTimeoutCount>0&&this.rttRolling.add(3e3),this.pingpongTimeoutCount+=1,I("DC_DEBUG_LOG")&&console.debug("[datachannel-signal] pingpongTimeoutCount: ".concat(this.pingpongTimeoutCount));const e=I("PING_PONG_TIME_OUT"),n=Date.now();this.pingpongTimeoutCount>=e&&(m.warning("[datachannel-signal] PINGPONG Timeout. Last Socket Message: ".concat(n-this.lastMsgTime,"ms")),n-this.lastMsgTime>I("WEBSOCKET_TIMEOUT_MIN"))?this.reconnect("recover",la.FALLBACK):this.request(Tt.PING,void 0,!0).then((()=>{this.pingpongTimeoutCount=0;const i=Date.now()-n;this.rttRolling.add(i),I("REPORT_STATS")&&this.send(Tt.PING_BACK,{pingpongElapse:i})})).catch((i=>{}))}handleInflateData(){const{inflateLength:e,deflateLength:n}=this.websocket.getInflateData();e!==0&&n!==0&&this.upload(hc.WS_INFLATE_DATA_LENGTH,{ws_deflate_length:n,ws_inflate_length:e})}handleWebsocketEvents(){this.websocket.on(In.RECONNECT_CREATE_CONNECTION,(e=>{this.emit(ft.WS_RECONNECT_CREATE_CONNECTION,e)})),this.websocket.on(In.ON_MESSAGE,this.onWebsocketMessage),this.websocket.on(In.CLOSED,(()=>{this.connectionState=ee.CLOSED})),this.websocket.on(In.FAILED,(()=>{this._disconnectedReason=te.NETWORK_ERROR,this.connectionState=ee.CLOSED})),this.websocket.on(In.RECONNECTING,(e=>{this._websocketReconnectReason=e,this.joinResponse=void 0,this.connectionState===ee.CONNECTED?this.connectionState=ee.RECONNECTING:this.connectionState=ee.CONNECTING})),this.websocket.on(In.WILL_RECONNECT,((e,n)=>{if(Za(this,ft.IS_P2P_DISCONNECTED)&&e==="retry")return m.debug("".concat(this.clientId," reconnect mode is retry, but p2p lost, change to tryNext")),this.reconnectToken=void 0,this.emit(ft.NEED_RENEW_SESSION),this.emit(ft.DISCONNECT_P2P),n("tryNext");e!=="retry"&&(m.debug("".concat(this.clientId," websockt will_connect event, renewSession reconnectMode is ").concat(e)),this.reconnectToken=void 0,this.emit(ft.NEED_RENEW_SESSION),this.emit(ft.DISCONNECT_P2P)),n(e)})),this.websocket.on(In.CONNECTED,(()=>{this.openConnectionTime=Date.now(),this.reconnectToken?this.rejoin().catch((e=>{m.warning("[".concat(this.clientId,"] rejoin failed ").concat(e)),this.reconnect("tryNext",la.SERVER_ERROR)})):this.join().catch((e=>{if(this.emit(ft.REPORT_JOIN_GATEWAY,e.message||e.code,this.url||""),e instanceof B&&e.code===A.UNEXPECTED_RESPONSE&&e.data.code===yt.ERR_NO_AUTHORIZED)return m.warning("[".concat(this.clientId,"] reconnect no authorized, recover")),void this.reconnect("recover",la.SERVER_ERROR);m.error("[".concat(this.clientId,"] join gateway request failed"),e.toString()),this.spec.forceWaitGatewayResponse?this.reconnect("tryNext",la.SERVER_ERROR):(this.initError=e,this.close())}))})),this.websocket.on(In.REQUEST_NEW_URLS,((e,n)=>{Sn(this,ft.REQUEST_RECOVER,this.multiIpOption).then(e).catch(n)})),this.websocket.on(In.ON_TOKEN_PRIVILEGE_DID_EXPIRE,(()=>{this.emit(Lt.ON_TOKEN_PRIVILEGE_DID_EXPIRE)})),this.websocket.on(In.TO_CONNECT_DATACHANNEL,((e,n)=>{Sn(this,ft.PRE_CONNECT_PC).then(e).catch(n)})),this.websocket.on(In.FAILBACK,(()=>{this.openConnectionTime!==void 0&&this.emit(ft.DATACHANNEL_FAILBACK)}))}}const _X={name:"DataChannelConnection",create:function(t){let{store:e,spec:n}=t;return new lX(n,e)}},fX={name:"DataChannelSignal",create:function(t){let{store:e,spec:n}=t;return new pX(n,e)}};cS(),ye("PROCESS_ID","process-".concat(Se(8,""),"-").concat(Se(4,""),"-").concat(Se(4,""),"-").concat(Se(4,""),"-").concat(Se(12,""))),(function(){let t;try{t=window.localStorage.getItem("websdk_ng_global_parameter")}catch(e){return void m.error("Error loading sdk config",e.message)}if(t)try{const e=JSON.parse(window.atob(t)),n=Date.now();m.debug("Loading global parameters from cache",e),Object.keys(e).forEach((i=>{if(Object.prototype.hasOwnProperty.call(Te,i)){const{value:r,expires:s}=e[i];if(s&&s<=n)return;ur[i]=r,Te[i]=r}}))}catch(e){m.error("Error loading mutableParamsCache: ".concat(t),e.message)}})(),Array.isArray(ur.AREAS)&&ur.AREAS.length>0&&dT(ur.AREAS,!0);const LM=(t,e,n)=>{m.debug("setParameter key:".concat(t,", value:").concat(JSON.stringify(e))),ye(t,e,n)};io(Dz,!1),io(kz,!1),io(lq,!1),io(Kz,!1),io(wz,!1),io(iX,!1),io(oX,!1),io(cX,!1),io(_X,!1),io(fX,!1);const Tn=(function(t){const e=new qe,n=t,i={getListeners:e.getListeners.bind(e),on:(r,s)=>((function(o,a){o===to.SECURITY_POLICY_VIOLATION&&ak(a,!0)})(r,s),e.on.bind(e)(r,s)),addListener:e.addListener.bind(e),once:e.once.bind(e),off:e.off.bind(e),removeAllListeners:e.removeAllListeners.bind(e),emit:e.emit.bind(e),safeEmit:e.safeEmit.bind(e)};return ok(ok({},n),i)})({__TRACK_LIST__:rc,VERSION:Ar,BUILD:uS,ESM_BUNDLER:!1,ESM:!1,UMD:!0,DEV:!1,setParameter:LM,getParameter:I,getSupportedCodec:async function(){let t={audio:[],video:[]};try{let e=new RTCPeerConnection;const n=await(async function(i){let r;return Jt().supportUnifiedPlan?(i.addTransceiver("video",{direction:"recvonly"}),i.addTransceiver("audio",{direction:"recvonly"}),r=(await i.createOffer()).sdp):r=(await i.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0})).sdp,r})(e);if(!n)return t;e.close(),e=null,t=(function(i){const r={video:[],audio:[]};return i.match(/ VP8/i)&&r.video.push("VP8"),i.match(/ VP9/i)&&r.video.push("VP9"),i.match(/ AV1/i)&&r.video.push("AV1"),i.match(/ H264/i)&&r.video.push("H264"),i.match(/ H265/i)&&r.video.push("H265"),i.match(/ opus/i)&&r.audio.push("OPUS"),i.match(/ PCMU/i)&&r.audio.push("PCMU"),i.match(/ PCMA/i)&&r.audio.push("PCMA"),i.match(/ G722/i)&&r.audio.push("G722"),r})(n)}catch(e){throw new B(A.CREATE_OFFER_FAILED,e.toString&&e.toString()).print()}return t},checkSystemRequirements:function(){let t=!(arguments.length>0&&arguments[0]!==void 0)||arguments[0];const e=pt.reportApiInvoke(null,{name:Ge.CHECK_SYSTEM_REQUIREMENTS,options:[],tag:Ne.TRACER}),n=(function(){let s=!(arguments.length>0&&arguments[0]!==void 0)||arguments[0],o=!1;try{const a=window.RTCPeerConnection,c=navigator.mediaDevices&&navigator.mediaDevices.getUserMedia,d=window.WebSocket;o=!(!a||!d),s&&!c&&(o=!1),o&&eu()&&gO(75)&&new a().close()}catch(a){m.error("check system requirement failed: ",a),o=!1}return o})(t),i=hq();m.debug("checkSystemRequirements, api:",n,"browser",i);const r=n&&i;return e.onSuccess(r),I("IGNORE_RTC_DEVICE_CHECK")?n:r},getDevices:function(t){return mr.enumerateDevices(!0,!0,t)},getMicrophones:function(t){return mr.getRecordingDevices(t)},getCameras:function(t){return mr.getCamerasDevices(t)},getElectronScreenSources:C0,getPlaybackDevices:function(t){return mr.getSpeakers(t)},createClient:ik,createCameraVideoTrack:async function(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const e=I("CAMERA_CAPTURE_CONFIG"),n=Se(8,"track-cam-"),i=pt.reportApiInvoke(null,{id:n,tag:Ne.TRACER,name:Ge.CREATE_CAM_VIDEO_TRACK,options:[Ue({},t),e]});e&&(t.encoderConfig=e);const r=r_(t);let s=null;m.info("start create camera video track with config",JSON.stringify(t),"trackId",n);try{s=(await fr({video:r},n)).getVideoTracks()[0]||null}catch(a){throw i.onError(a),a}if(!s){const a=new H(A.UNEXPECTED_ERROR,"can not find track in media stream");return i.onError(a),a.throw(m)}if(t.optimizationMode&&NS(n,s,t,ns(t.encoderConfig)),I("USE_STANDARD_BITRATE_DEFAULT")){const a=ns(t.encoderConfig);t.encoderConfig=a,delete a.bitrateMax,delete a.bitrateMin}const o=new o_(s,t,r,t.scalabiltyMode?t_(t.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},t.optimizationMode,n);return i.onSuccess(o.getTrackId()),m.info("create camera video success, trackId:",n),o},createCustomVideoTrack:function(t){const e=Se(8,"track-cus-"),n=pt.reportApiInvoke(null,{id:e,tag:Ne.TRACER,name:Ge.CREATE_CUSTOM_VIDEO_TRACK,options:[t]});I("USE_STANDARD_BITRATE_DEFAULT")&&(delete t.bitrateMax,delete t.bitrateMin);const i=new De(t.mediaStreamTrack,{width:t.width,height:t.height,frameRate:t.frameRate,bitrateMax:t.bitrateMax,bitrateMin:t.bitrateMin},t.scalabiltyMode?t_(t.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},t.optimizationMode,e,[Ee.CUSTOM_TRACK]);return n.onSuccess(i.getTrackId()),m.info("create custom video track success with config",t,"trackId",i.getTrackId()),i},createScreenVideoTrack:async function(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"disable";const n=typeof e=="object"?(function(p){const f=L0(p);return h0()&&p.suppressLocalAudioPlayback&&(f.suppressLocalAudioPlayback=p.suppressLocalAudioPlayback),p0()&&p.restrictOwnAudio&&(f.restrictOwnAudio=!0),f})(e):void 0;n&&(e="auto");const i=Se(8,"track-scr-v-"),r=pt.reportApiInvoke(null,{id:i,tag:Ne.TRACER,name:Ge.CREATE_SCREEN_VIDEO_TRACK,options:[Ue({},t),e]});t.encoderConfig?typeof t.encoderConfig=="string"||t.encoderConfig.width&&t.encoderConfig.height||(t.encoderConfig.width={max:1920},t.encoderConfig.height={max:1080}):t.encoderConfig="1080p_2";const s=(function(p){const f={};p.screenSourceType&&(f.mediaSource=p.screenSourceType),p.extensionId&&Ao()&&(f.extensionId=p.extensionId);const{displaySurface:v,selfBrowserSurface:S,surfaceSwitching:T,systemAudio:b,preferCurrentTab:w,windowAudio:D,monitorTypeSurfaces:k}=p;(Xs(107)||za(107)||Xa(93))&&(v&&(_n(v,"displaySurface",["browser","window","monitor"]),f.displaySurface=v),S?(_n(S,"selfBrowserSurface",["exclude","include"]),f.selfBrowserSurface=S):f.selfBrowserSurface="include",T&&(_n(T,"surfaceSwitching",["exclude","include"]),f.surfaceSwitching=T)),(Xs(105)||za(105)||Xa(91))&&b&&(_n(b,"systemAudio",["exclude","include"]),f.systemAudio=b),(Xs(94)||za(94)||Xa(80))&&w&&(f.preferCurrentTab=!0),(Xs(141)||za(141)||Xa(125))&&D&&(_n(D,"windowAudio",["exclude","system"]),f.windowAudio=D),(Xs(119)||za(119)||Xa(105))&&k&&(_n(k,"monitorTypeSurfaces",["exclude","include"]),f.monitorTypeSurfaces=k),p.electronScreenSourceId&&(f.sourceId=p.electronScreenSourceId);const U=p.encoderConfig?ES(p.encoderConfig):null;return f.mandatory={chromeMediaSource:"desktop",maxWidth:U?U.width:void 0,maxHeight:U?U.height:void 0},U&&(U.frameRate&&(typeof U.frameRate=="number"?(f.mandatory.maxFrameRate=U.frameRate,f.mandatory.minFrameRate=U.frameRate):(f.mandatory.maxFrameRate=U.frameRate.max||U.frameRate.ideal||U.frameRate.exact||void 0,f.mandatory.minFrameRate=U.frameRate.min||U.frameRate.ideal||U.frameRate.exact||void 0),f.frameRate=U.frameRate),U.width&&(f.width=U.width),U.height&&(f.height=U.height)),f})(t);let o=null,a=null;const c=Jt();if(!c.supportShareAudio&&e==="enable"){const p=new H(A.NOT_SUPPORTED,"your browser or platform is not support share-screen with audio");return r.onError(p),p.throw(m)}m.info("start create screen video track with config",t,"withAudio",e,"trackId",i);const d=c.supportShareAudio&&e!=="disable";try{const p=await fr({screen:s,screenAudio:d?n||!0:void 0},i);o=p.getVideoTracks()[0]||null,a=p.getAudioTracks()[0]||null}catch(p){throw r.onError(p),p}if(!o){const p=new H(A.UNEXPECTED_ERROR,"can not find track in media stream");return r.onError(p),p.throw(m)}if(!a&&e==="enable"){o&&o.stop();const p=new H(A.SHARE_AUDIO_NOT_ALLOWED);return r.onError(p),p.throw(m)}t.optimizationMode||(t.optimizationMode="detail"),t.optimizationMode&&(NS(i,o,t,t.encoderConfig&&ES(t.encoderConfig)||void 0),t.encoderConfig&&typeof t.encoderConfig!="string"&&(t.encoderConfig.bitrateMin=t.encoderConfig.bitrateMax));const l=new De(o,t.encoderConfig?ES(t.encoderConfig):{},t.scalabiltyMode?t_(t.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},t.optimizationMode,i,[Ee.SCREEN_TRACK]);if(!a)return r.onSuccess(l.getTrackId()),m.info("create screen video track success","video:",l.getTrackId()),l;const h=new rn(a,void 0,Se(8,"track-scr-a-"),!1);return r.onSuccess([l.getTrackId(),h.getTrackId()]),m.info("create screen video track success","video:",l.getTrackId(),"audio:",h.getTrackId()),[l,h]},createMicrophoneAndCameraTracks:async function(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};const n=I("CAMERA_CAPTURE_CONFIG"),i=Se(8,"track-mic-"),r=Se(8,"track-cam-"),s=pt.reportApiInvoke(null,{id:"".concat(i,"-").concat(r),tag:Ne.TRACER,name:Ge.CREATE_MIC_AND_CAM_TRACKS,options:[t,e,n]});n&&(e.encoderConfig=n);const o=r_(e),a=k0(t);let c=null,d=null;m.info("start create camera video track(".concat(r,") and microphone audio track(").concat(i,") with config, audio: ").concat(JSON.stringify(t),", video: ").concat(JSON.stringify(e)));try{const p=await fr({audio:a,video:o},"".concat(i,"-").concat(r));c=p.getAudioTracks()[0],d=p.getVideoTracks()[0]}catch(p){throw s.onError(p),p}if(!c||!d){const p=new H(A.UNEXPECTED_ERROR,"can not find tracks in media stream");return s.onError(p),p.throw(m)}if(e.optimizationMode&&NS(r,d,e,ns(e.encoderConfig)),I("USE_STANDARD_BITRATE_DEFAULT")){const p=ns(e.encoderConfig);e.encoderConfig=p,delete p.bitrateMax,delete p.bitrateMin}const l=new uu(c,t,a,i),h=new o_(d,e,o,e.scalabiltyMode?t_(e.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},e.optimizationMode,r);return s.onSuccess([l.getTrackId(),h.getTrackId()]),m.info("create camera video track(".concat(r,") and microphone audio track(").concat(i,") success")),[l,h]},createMicrophoneAudioTrack:async function(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const e=Se(8,"track-mic-"),n=pt.reportApiInvoke(null,{id:e,tag:Ne.TRACER,name:Ge.CREATE_MIC_AUDIO_TRACK,options:[t]}),i=k0(t);let r=null;m.info("start create microphone audio track with config",JSON.stringify(t),"trackId",e);try{r=(await fr({audio:i},e)).getAudioTracks()[0]||null}catch(o){throw n.onError(o),o}if(!r){const o=new H(A.UNEXPECTED_ERROR,"can not find track in media stream");return n.onError(o),o.throw(m)}const s=new uu(r,t,i,e);return n.onSuccess(s.getTrackId()),m.info("create microphone audio track success, trackId:",e),s},createCustomAudioTrack:oD,createBufferSourceAudioTrack:async function(t){var e;const{cacheOnlineFile:n,encoderConfig:i}=t;let{source:r}=t;const s={source:r instanceof AudioBuffer?"AudioBuffer":r instanceof File?(e=File.name)!==null&&e!==void 0?e:"File":r,cacheOnlineFile:n,encoderConfig:i},o=Se(8,"track-buf-"),a=pt.reportApiInvoke(null,{id:o,tag:Ne.TRACER,name:Ge.CREATE_BUFFER_AUDIO_TRACK,options:[s]});if(I("DISABLE_WEBAUDIO"))throw new H(A.NOT_SUPPORTED,"can not create BufferSourceAudioTrack when WebAudio disabled");m.info("start create buffer source audio track with config",JSON.stringify(s),"trackId",o);const c=r;if(!(r instanceof AudioBuffer))try{r=await(async function(h,p){let f=null;if(typeof h=="string"){const S=RN.get(h);if(S)return m.debug("use cached audio resource: ",h),S;try{f=(await Rs((()=>yi.get(h,{responseType:"arraybuffer"})),void 0,void 0,{maxRetryCount:3})).data}catch(T){throw new H(A.FETCH_AUDIO_FILE_FAILED,T.toString())}}else f=await new st(((T,b)=>{const w=new FileReader;w.onload=D=>{D.target?T(D.target.result):b(new H(A.READ_LOCAL_AUDIO_FILE_ERROR))},w.onerror=()=>{b(new H(A.READ_LOCAL_AUDIO_FILE_ERROR))},w.readAsArrayBuffer(h)}));const v=await(function(S){const T=Dd();return new st(((b,w)=>{T.decodeAudioData(S,(D=>{b(D)}),(D=>{w(new H(A.DECODE_AUDIO_FILE_FAILED,D.toString()))}))}))})(f);return typeof h=="string"&&p&&RN.set(h,v),v})(r,n)}catch(h){return a.onError(h),h.throw(m)}const d=new D8(r),l=new N8(c,d,i?e_(i):{},o);return m.info("create buffer source audio track success, trackId:",o),a.onSuccess(l.getTrackId()),l},setAppType:function(t){if(m.debug("setAppType: ".concat(t)),!(Number.isInteger(t)&&t>=0))throw m.debug("Invalid appType"),new B(A.INVALID_PARAMS,"invalid app type",t);ye("APP_TYPE",Math.floor(t))},setLogLevel:function(t){m.setLogLevel(t)},enableLogUpload:function(){I("USE_NEW_LOG")?ye("UPLOAD_LOG",!0):m.enableLogUpload()},disableLogUpload:function(){I("USE_NEW_LOG")?ye("UPLOAD_LOG",!1):m.disableLogUpload()},createChannelMediaRelayConfiguration:function(){return new yP},checkAudioTrackIsActive:async function(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:5e3;const n=pt.reportApiInvoke(null,{tag:Ne.TRACER,name:Ge.CHECK_AUDIO_TRACK_IS_ACTIVE,options:[e]});if(!(t instanceof rn||t instanceof kd)){const c=new B(A.INVALID_TRACK,"the parameter is not a audio track");return n.onError(c),c.throw()}e&&e<1e3&&(e=1e3);const i=t instanceof rn?t.getTrackLabel():"remote_track",r=t.getVolumeLevel();let s=r,o=r;const a=Date.now();return new st((c=>{const d=setInterval((()=>{const l=t.getVolumeLevel();s=l>s?l:s,o=l<o?l:o;const h=s-o>1e-4,p=Date.now()-a;if(h||p>e){clearInterval(d);const f=h,v={duration:p,deviceLabel:i,maxVolumeLevel:s,result:f};m.info("[track-".concat(t.getTrackId(),"] check audio track active completed. ").concat(JSON.stringify(v))),n.onSuccess(v),c(f)}}),200)}))},checkVideoTrackIsActive:async function(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:5e3;const n=pt.reportApiInvoke(null,{tag:Ne.TRACER,name:Ge.CHECK_VIDEO_TRACK_IS_ACTIVE,options:[e]});if(!(t instanceof De||t instanceof Ld)){const h=new B(A.INVALID_TRACK,"the parameter is not a video track");return n.onError(h),h.throw()}e&&e<1e3&&(e=1e3);const i=t instanceof De?t.getTrackLabel():"remote_track",r=t.getMediaStreamTrack(!0),s=document.createElement("video");s.style.width="1px",s.style.height="1px",s.setAttribute("muted",""),s.muted=!0,s.setAttribute("playsinline",""),s.controls=!1,(Mn()||Gp())&&(s.style.opacity="0.01",s.style.position="fixed",s.style.left="0",s.style.top="0",document.body.appendChild(s)),s.srcObject=new MediaStream([r]),s.play();const o=document.createElement("canvas");o.width=160,o.height=120;let a=0,c=0;try{const h=Date.now();a=await(function(p,f,v,S){let T,b=0,w=null;return new st(((D,k)=>{function U(){b>S&&T&&(T(),D(b));const P=v.getContext("2d");if(!P){const Q=new B(A.UNEXPECTED_ERROR,"can not get canvas 2d context.");return m.error(Q.toString()),void k(Q)}P.drawImage(p,0,0,160,120);const x=P.getImageData(0,0,v.width,v.height),q=Math.floor(x.data.length/3);if(w){for(let Q=0;Q<q;Q+=3)if(x.data[Q]!==w[Q])return b+=1,void(w=x.data);w=x.data}else w=x.data}setTimeout((()=>{T&&(T(),D(b))}),f),T=CS((()=>{U()}),30)}))})(s,e,o,4),c=Date.now()-h}catch(h){throw n.onError(h),h}JY===he.SAFARI&&(s.pause(),s.remove()),s.srcObject=null;const d=a>4,l={duration:c,changedPicNum:a,deviceLabel:i,result:d};return m.info("[track-".concat(t.getTrackId(),"] check video track active completed. ").concat(JSON.stringify(l))),n.onSuccess(l),d},setArea:dT,audioElementPlayCenter:ci,resumeAudioContext:function(){return ci.autoResumeAfterInterruption(!0)},processExternalMediaAEC:function(t){_q.processExternalMediaAEC(t)},registerExtensions:function(t){const e=I("PLUGIN_INFO")||[];t.forEach((n=>{"name"in n&&!$(e).call(e,n.name)&&e.push(n.name);const i=n;i.__registered__=!0,i.logger.hookLog=m.extLog,i.reporter.hookApiInvoke=pt.extApiInvoke,i.parameters&&Object.keys(i.parameters).forEach((r=>{i.parameters[r]=I(r)}))})),LM("PLUGIN_INFO",e)},ChannelMediaRelayError:xd,ChannelMediaRelayEvent:Do,ChannelMediaRelayState:Mi,RemoteStreamFallbackType:y8,RemoteStreamType:C8,ConnectionDisconnectedReason:te,AudienceLatencyLevelType:Z6,AREAS:fe,preload:async function(t,e,n,i){return DT(t,e,n,i)},startLastmileProbeTest:async function(t,e,n,i){let r={state:"unavailable"};await DT(t,e,n,i);const s=await PT({appId:t,cname:e,token:n||t,uid:i,cloudProxyServer:"disabled"});if(!s)return r;await LT(s);let o,a=ik({mode:"rtc",codec:"vp8"});try{o=await a.join(t,e,n,i,{networkQualityProbe:!0})}catch{return r}const c=new tq,d=c.createMuteAudioTrack();let l=await oD({mediaStreamTrack:d});await a.publish([l]);let[h,p,f]=await new st(((D,k)=>{const U=setTimeout((()=>{clearTimeout(U),D([!0,null,"audio"])}),5e3);a.on("user-published",(async(P,x)=>{P.uid===o&&(clearTimeout(U),D([!1,P,x]))}))}));if(h||!p)return await a.unpublish([l]),await a.leave(),l.close(),c.close(),r;await a.subscribe(p,f),await new st(((D,k)=>{const U=setTimeout((()=>{clearTimeout(U),D(null)}),5e3)}));let v=a.getRTCStats(),S=a.getLocalAudioStats();const T=v.RTT,b=S.sendJitterMs,w=S.currentPacketLossRate;return r={state:"complete",rtt:T,packetLossRate:w,jitter:b,networkQuality:((D,k,U)=>{let P=1;if(U>0){let Dt=Math.log(100*U)/Math.log(2)+1;Dt=Math.min(5,Math.max(0,Dt)),P=1-Dt/5}let x=1;if(D>0){let Dt=Math.log(D/40)/Math.log(2)+1;Dt=Math.min(5,Math.max(0,Dt)),x=1-Dt/5}let q=1;if(k>0){let Dt=Math.log(k/10)/Math.log(2.5)+1;Dt=Math.min(5,Math.max(0,Dt)),q=1-Dt/5}const Q=.5*P+.3*x+.2*q;let dt=0;return dt=Q>=.8?1:Q>=.6?2:Q>=.4?3:Q>=.2?4:5,dt})(T,b,w)},await a.unsubscribe(p),await a.unpublish([l]),await a.leave(),l.close(),c.close(),await LT(s),r}});return Object.defineProperties(Tn,{onAudioAutoplayFailed:{get:()=>bi.onAudioAutoplayFailed,set:t=>{bi.onAudioAutoplayFailed=t}},onAutoplayFailed:{get:()=>bi.onAutoplayFailed,set:t=>{bi.onAutoplayFailed=t}},_onSecurityPolicyViolation:{value:void 0,writable:!0},_cspEventHandlerPointer:{value:void 0,writable:!0},onSecurityPolicyViolation:{get:()=>Tn._onSecurityPolicyViolation,set(t){Tn._onSecurityPolicyViolation=t,ak(t)}},__CLIENT_LIST__:{get:()=>I("SHOW_GLOBAL_CLIENT_LIST")?lc:[]}}),mr.on(oc.CAMERA_DEVICE_CHANGED,(t=>{m.info("camera device changed",JSON.stringify(t)),Tn.onCameraChanged&&Tn.onCameraChanged(t),Tn.safeEmit(to.CAMERA_CHANGED,t)})),mr.on(oc.RECORDING_DEVICE_CHANGED,(t=>{m.info("microphone device changed",JSON.stringify(t)),Tn.onMicrophoneChanged&&Tn.onMicrophoneChanged(t),Tn.safeEmit(to.MICROPHONE_CHANGED,t)})),mr.on(oc.PLAYOUT_DEVICE_CHANGED,(t=>{m.debug("playout device changed",JSON.stringify(t)),Tn.onPlaybackDeviceChanged&&Tn.onPlaybackDeviceChanged(t),Tn.safeEmit(to.PLAYBACK_DEVICE_CHANGED,t)})),ci.onAutoplayFailed=()=>{m.info("detect audio element autoplay failed"),bi.onAudioAutoplayFailed&&bi.onAudioAutoplayFailed()},Ie.on("autoplay-failed",(()=>{m.info("detect webaudio autoplay failed"),bi.onAudioAutoplayFailed&&bi.onAudioAutoplayFailed(),Tn.safeEmit(to.AUTOPLAY_FAILED)})),Ie.on(Yn.STATE_CHANGE,((t,e)=>{m.info("audio context state changed: ".concat(e," => ").concat(t)),Tn.onAudioContextStateChanged&&Tn.onAudioContextStateChanged(t,e),Tn.safeEmit(to.AUDIO_CONTEXT_STATE_CHANGED,t,e)})),$e.on(Qa.NETWORK_STATE_CHANGE,((t,e)=>{m.info("[network-indicator] network state changed, ".concat(e," => ").concat(t))})),window&&(window.__ARTC__=Tn),Tn}))})(Cf)),Cf.exports}var tQ=$7();const w1=Q7(tQ),eQ="5bb31a5684af47a1aff766e1c00b6de2",nQ="testc",iQ="007eJxTYNjj8uLwusZS4zdLV12f2uYwPffCl+SCum2/pA38Pj7jPH5cgcE0KcnYMNHUzMIkMc3EPNEwMS3N3Mws1TDZwCDJLCXVqDVVJrMhkJFB9+9NJkYGCATxWRlKUotLkhkYAIKFI1k=",rQ=0,sQ=ph({__name:"HomeView",setup(u){let _=null,E=null;function C(){_=w1.createClient({mode:"rtc",codec:"vp8"}),y()}function y(){_.on("user-published",async(W,Z)=>{await _.subscribe(W,Z),console.log("subscribe success"),Z==="audio"&&W.audioTrack.play()}),_.on("user-unpublished",async W=>{})}async function O(){E=await w1.createMicrophoneAudioTrack()}async function M(){await _.join(eQ,nQ,iQ,rQ),await O(),await V(),console.log("Publish success!")}async function V(){await _.publish([E])}async function F(){E.close(),await _.leave(),console.log("Left the channel.")}function z(){document.getElementById("join").onclick=M,document.getElementById("leave").onclick=F}function Y(){C(),window.onload=z}return Y(),(W,Z)=>(cv(),dv("main",null,[...Z[0]||(Z[0]=[ir("h2",{class:"left-align"},"Agora Web SDK Quickstart",-1),ir("div",{class:"row"},[ir("div",null,[ir("button",{type:"button",id:"join"},"Join"),ir("button",{type:"button",id:"leave"},"Leave")])],-1)])]))}}),oQ=B7({history:T7("/"),routes:[{path:"/",name:"home",component:sQ},{path:"/about",name:"about",component:()=>J7(()=>import("./AboutView-C61PFOsG.js"),__vite__mapDeps([0,1]))}]}),_v=DJ(q7);_v.use(MJ());_v.use(oQ);_v.mount("#app");export{ZU as _,ir as a,dv as c,cv as o};
